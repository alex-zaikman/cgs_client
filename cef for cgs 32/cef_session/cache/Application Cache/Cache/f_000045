////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/managers/AppcacheManager.js
////////////////////////////////////////
( function() {
	
	function AppcacheManager() {

		this._ready = false ;
		
		this.callOnReady = false ;
		
		this.appCache = getAppcache() ;
		
	} 
	
	AppcacheManager.prototype = {
	
		init: function() {
			
			var status = getAppcacheStatus() ;
			
			console.log( "[DL][Appcache] --> Status --> " + status ) ;
			
			var thi$ = this ;
			this.bindAppcacheEvents( function( e ){
				thi$.handleCacheEvent( e ) ;
			} ) ;
			
		},
		
		ready: function() {
			this._ready = true ;
			if( this.callOnReady ) {
				this.callOnReady = false ;
				this.cacheReadyCallback() ;
			}
		},
		
		progress: function( e ) {
			var loaded = e.loaded ;
			var total = e.total ;
			
//			var completed = Math.round( ( total > 0 ? loaded/total : 1 ) * 100 ) ;
//			console.log( "[DL][Appcache] --> Progress --> %d%", completed ) ;
			
			if( loaded == total ) {
				console.log( "[DL][Appcache] --> Progress DONE 100%" ) ;
			}
			
			if( this.cacheProgressCallback ) {
				this.cacheProgressCallback( e ) ;
			}
		},
		
		callOnProgress: function( callback ) {
			this.cacheProgressCallback = function( e ){
				callback( e ) ;
			} ;
		},
		
		callOnCacheReady: function( callback ) {
			
			this.cacheReadyCallback = function(){
				if( callback ) {
					console.log( "[DL][Appcache] --> Ready callback called !" ) ;
					callback() ;
				}
			} ;
			
			if( this._ready ) {
				this.cacheReadyCallback() ;
		    } else {
		    	this.callOnReady = true ;
		    }
			
		},
	
		handleCacheEvent: function( e ) {
			
			var type = e.type ;
			
			var thi$ = this ;
			
			if( type != "progress" ) {
				console.log( "[DL][Appcache] --> Event --> " + type ) ;
			}
						
			switch( type ) {
				
				case "updateready" : {
					var statusMatch = window.applicationCache.status === window.applicationCache.UPDATEREADY ;
					if ( statusMatch && this.downloadedNewFiles ) {
						console.log( "[DL][Appcache] --> new version received" ) ;
						window.setTimeout( function() {
							window.applicationCache.swapCache() ;
							
//							window.setTimeout( function() {
//								console.log( "[DL][Appcache] --> reloading to use new version" ) ;
//								window.location.reload() ;
//							}, 250 ) ;
							
							thi$.ready() ;  
							
						}, 250 ) ;
					}
					break ;
				}
								
				case "downloading" : {
					this.downloadedNewFiles = true ;
					break ;
				}
								
				case "progress" : {
					this.progress( e ) ;
					break ;
				}
				
				case "error" : {
					console.log( "[DL][Appcache] --> ERROR --> " + JSON.stringify( e, null, "\t" ) ) ;
				}
				case "noupdate" : 
				case "cached" : { 
					console.log( "[DL][Appcache] --> done with appcache" ) ;
					this.ready() ;
					break ;
				}
				
				default : {
					console.log( "[DL][Appcache] --> Unhandled appcache event --> " + type ) ;
					break ;
				}
			}
			
		},
		
		bindAppcacheEvents: function( statusHandler ) {
			
			// Fired after the first cache of the manifest.
			this.appCache.addEventListener('cached', statusHandler, false);

			// Checking for an update. Always the first event fired in the sequence.
			this.appCache.addEventListener('checking', statusHandler, false);

			// An update was found. The browser is fetching resources.
			this.appCache.addEventListener('downloading', statusHandler, false);

			// The manifest returns 404 or 410, the download failed,
			// or the manifest changed while the download was in progress.
			this.appCache.addEventListener('error', statusHandler, false);

			// Fired after the first download of the manifest.
			this.appCache.addEventListener('noupdate', statusHandler, false);

			// Fired if the manifest file returns a 404 or 410.
			// This results in the application cache being deleted.
			this.appCache.addEventListener('obsolete', statusHandler, false);

			// Fired for each resource listed in the manifest as it is being fetched.
			this.appCache.addEventListener('progress', statusHandler, false);

			// Fired when the manifest resources have been newly redownloaded.
			this.appCache.addEventListener('updateready', statusHandler, false);
			
		}
			
	} ;
	
	
	function getAppcacheStatus() {
		
		var appCache = getAppcache() ;
		
		switch (appCache.status) {
		  case appCache.UNCACHED: // UNCACHED == 0
		    return 'UNCACHED';
		    break;
		    
		  case appCache.IDLE: // IDLE == 1
		    return 'IDLE';
		    break;
		    
		  case appCache.CHECKING: // CHECKING == 2
		    return 'CHECKING';
		    break;
		    
		  case appCache.DOWNLOADING: // DOWNLOADING == 3
		    return 'DOWNLOADING';
		    break;
		    
		  case appCache.UPDATEREADY:  // UPDATEREADY == 4
		    return 'UPDATEREADY';
		    break;
		    
		  case appCache.OBSOLETE: // OBSOLETE == 5
		    return 'OBSOLETE';
		    break;
		    
		  default:
		    return 'UKNOWN CACHE STATUS';
		    break;
		    
		} ;
	}
	
	function getAppcache() {
		var appCache = window.applicationCache;
		return appCache ;
	}
	
	window.AppcacheManager = new AppcacheManager() ;
	
	var onDOMLoaded = function() {
		if (window.applicationCache) {
			window.AppcacheManager.init() ;
		} else {
			window.AppcacheManager.ready();
		}
	};
	
	window.addEventListener('load', onDOMLoaded, false);
	
} )() ;
////////////////////////////////////////
// SRC End --> t2k/util/managers/AppcacheManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/t2k/PostMessageManager.js
////////////////////////////////////////
/*
 * PostMessageManager
 * 
 * class for handling post messages between windows
 * use at each listening side
 * 
 * use with or without require.js
 * 
 * version : 1.0.7
 * written by : Liron Zadkovsky
 * 
 * PLEASE consult before changing!
 * 
 */
( function( window, undefined ) {
	
    /**
     * @author liron.zadkovsky
     * 
     * @constructor PostMessageManager
     * @param listenerWindow listen to receive messages
     * @param targetWindow post messages to
     * @param handlerObject contains handler functions
     * @param context call handler functions in context
     * 
     * @returns {PostMessageManager}
     */
    function PostMessageManager( listenerWindow, targetWindow, handlerObject, context ) {
    	
    	// save args to class members
    	this.listenerWindow = listenerWindow ;
    	this.targetWindow = targetWindow ;
    	this.handlerObject = handlerObject ;
    	this.context = context ;

    	// get window names for logging
    	this.listenerName = this.listenerWindow.name ;
		this.targetName = this.targetWindow.name ;
    	
		this.detectBrowserFeatures() ;
		
		// bind events
		this.bindEvents() ;
		
    }

    PostMessageManager.prototype = {
	    	
	    	////////////////////////////////////////////
	    	// class members
			////////////////////////////////////////////
	    	
	    	// collection for callbacks and  timeouts
	    	callbacks: {},
	    	
	    	// get values on construction
	    	listenerWindow: null,
	    	targetWindow: null,
	    	handlerObject: null,
	    	context: null,
	    	
	    	////////////////////////////////////////////
	    	// class member functions
	    	////////////////////////////////////////////
	    	
	    	bindEvents: function() {
	    		
	    		// save listener callback, keep context = this
	    		var thi$ = this ;
	    		this.listenerCallback = function( message ){
	    			thi$.receive( message ) ;
	    		} ;
	    		
	    		// bind callback to message
	    		this.listenerWindow.addEventListener( "message", this.listenerCallback, false ) ;
	    		
	    	},
	    	
	    	/////////////////////////////////////////////////////////////
	    	// messageData structure:
	    	/////////////////////////////////////////////////////////////
			//	{
			//		method: "String",
			//		config: {} || "any...",
			//		callback: function
			//	}
	    	/////////////////////////////////////////////////////////////
	    	
	    	// handle received messages
	        receive: function( message ) {
	        	
	        	// filter messages to target window
	        	if( message.source == this.targetWindow ) {
	        		
	        		// extract message data
	        		var messageData = this.browserPostJSON ?
		    				message.data : JSON.parse( message.data ) ;
	        		
	        		// get handler function name
	        		var handlerName = messageData.method ;
	        		
	        		// get config
	        		var config = messageData.config ;
	        		
	        		// log message source/target/data
		    		this.logMessage( "Message RECEIVED", "FROM", messageData ) ;
		    		
	        		// try to get callback entry
	        		var callbackObject = this.callbacks[ handlerName ] ;
	        		
	        		// try to get method handler
	        		var methodHandler = this.handlerObject[ handlerName ] ;
	        		
	        		// try to get callback function
	        		var callbackHandler = callbackObject ? callbackObject.callback : null ;
	        		
	        		// decide on handler
	        		var handler = methodHandler || callbackHandler ;
	        		
	        		if( handler ) {
	        			
	        			// when entry exists
	        			if( callbackObject ) {
	        				
	        				this.clearCallbackTimeout( handlerName ) ;
	        				
	        			}
	        			
	        			// decide on context, from constructor or default
	        			var context = this.context || this.handlerObject ;
	        			
	        			// empty default callback function
	        			var callbackWrapper = function(){} ;
	        			
	        			// handle received callback
	        			if( messageData.callback ) {
	        				
	        				var thi$ = this ;
	        				
	        				// wrap API call in real callback function
	        				callbackWrapper = function( data ) {
	        					
	        					// call callback through message API
	        					thi$.send( messageData.callback, data ) ;
	        					
	        				} ;
	        				
	        			}
	        			
	        			// call handler in context with config & callback as arguments
	            		handler.call( context, messageData.config, callbackWrapper ) ;
	        			
	        		} else {
	        			
	        			// warning on missing handler or unknown API call
	        			console.warn( "unknown API method, or to late callback call --> " + handlerName ) ;
	        			
	        		}
	        		
	        	}
	        },
	        
	        // handle sending messages
	        send: function( method, config, callback, options ) {
	        	
	        	if( this.targetWindow && this.targetWindow.postMessage ) {
	        		
		        	// declare vars
		        	var callbackKey = null ;
		        	var timeout = null ;
		        	
		        	if( callback ) {
		        		
		        		var thi$ = this ;
		        		
		        		// generate callback key
		            	callbackKey = method + "_callback_" + ( new Date() ).getTime() * Math.random() ;
		            	
		            	// set and save timeout for callback
		            	var time = ( options && options.timeout ) || 5000 ;
		            	timeout = this.listenerWindow.setTimeout( function(){
		            		
		            		// warn when callback timed out
		            		console.warn( "Timeout for api method callback --> " + callbackKey + "sent by --> " + this.listenerName );
		            		console.warn( "Timeout - will return null to callback." );
		            		
		            		thi$.clearCallbackTimeout( callbackKey ) ;
		            		
		            		callback( null ) ;
		            		
		            	}, time ) ;
		        		
		            	// add callback entry to collection
		        		this.callbacks[ callbackKey ] = {
		        			callback: callback,
		        			timeout: timeout
		        		} ;
		        		
		        	}
		        	
		        	// create message data object
		        	var messageData = {
		        			
		        		method: method,
		        		config: config,
		        		callback: callbackKey
		        		
		        	} ;
		        	
	        		// log message source/target/data
		    		this.logMessage( "Message SENT", "TO", messageData ) ;
		    		
		    		var postData = this.browserPostJSON ?
		    				messageData : JSON.stringify( messageData ) ;
		    		
		    		// post message to target
		        	this.targetWindow.postMessage( postData, "*" ) ;
		        } else {
		        	
		        	console.warn( "[PMM - "+ this.listenerName +" ] --> sending to target: "+ this.targetName +", frame does not exist!" ) ;
		        	
		        }
	        },
	        
	        clearCallbackTimeout: function( callbackKey ) {
	        	
	        	callbackObject = this.callbacks[ callbackKey ]
	        	
	        	if( callbackObject ) {
	        		
	        		// get time out
	        		var timeout = callbackObject.timeout ;
	        		
	        		// clear timeout
	        		this.listenerWindow.clearTimeout( timeout ) ;
	        		
	        		// remove entry from collection
	        		delete this.callbacks[ callbackKey ] ;
	        		
	        	} else {
	        		console.warn( "Trying to clear callback - Callback already called" );
	        	}
	        },
	        
	        logMessage: function( text, rel, data ) {
	    		
	    		console.log( '\n' );
	    		
	    		console.log( text + " by " +  this.listenerName + " " + rel + " " + this.targetName + " --> " + data.method ) ;
	    		
	    		console.log( JSON.stringify( data.config, null, '\t' ) ) ;
	    		
	        },
	        
	        detectBrowserFeatures: function() {
	        	
	        	var appstr = window.navigator.appVersion.toLowerCase() ;
	        	
	        	this.browserPostJSON = appstr.indexOf( 'msie 9' ) == -1 ;
	        	
	        },
	        
	        destroy: function() {
	        	
	        	// remove listener
	        	this.listenerWindow.removeEventListener( "message", this.listenerCallback, false ) ;
	        	
	        	// detach members for garbage 
	        	this.listenerCallback = null ;
	        	
	        	this.listenerWindow = null ;
	        	this.targetWindow = null ;
	        	this.handlerObject = null ;
	        	this.context = null ;
	        	
	    		this.listenerName = null ;
	    		this.targetName = null ;
	        	
	        }
	   
    } ;
    
    // non require.js use support
    window.PostMessageManager = PostMessageManager ;
    
    // require.js use support
	if ( typeof define === "function" ) {
		define( [], function () { return PostMessageManager ; } ) ;
	}
	
} )( window ) ;
////////////////////////////////////////
// SRC End --> libs/t2k/PostMessageManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/jquery/jquery-1.7.1.min.js
////////////////////////////////////////
/*! jQuery v1.7.1 jquery.com | jquery.org/license */
(function(a,b){function cy(a){return f.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}function cv(a){if(!ck[a]){var b=c.body,d=f("<"+a+">").appendTo(b),e=d.css("display");d.remove();if(e==="none"||e===""){cl||(cl=c.createElement("iframe"),cl.frameBorder=cl.width=cl.height=0),b.appendChild(cl);if(!cm||!cl.createElement)cm=(cl.contentWindow||cl.contentDocument).document,cm.write((c.compatMode==="CSS1Compat"?"<!doctype html>":"")+"<html><body>"),cm.close();d=cm.createElement(a),cm.body.appendChild(d),e=f.css(d,"display"),b.removeChild(cl)}ck[a]=e}return ck[a]}function cu(a,b){var c={};f.each(cq.concat.apply([],cq.slice(0,b)),function(){c[this]=a});return c}function ct(){cr=b}function cs(){setTimeout(ct,0);return cr=f.now()}function cj(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function ci(){try{return new a.XMLHttpRequest}catch(b){}}function cc(a,c){a.dataFilter&&(c=a.dataFilter(c,a.dataType));var d=a.dataTypes,e={},g,h,i=d.length,j,k=d[0],l,m,n,o,p;for(g=1;g<i;g++){if(g===1)for(h in a.converters)typeof h=="string"&&(e[h.toLowerCase()]=a.converters[h]);l=k,k=d[g];if(k==="*")k=l;else if(l!=="*"&&l!==k){m=l+" "+k,n=e[m]||e["* "+k];if(!n){p=b;for(o in e){j=o.split(" ");if(j[0]===l||j[0]==="*"){p=e[j[1]+" "+k];if(p){o=e[o],o===!0?n=p:p===!0&&(n=o);break}}}}!n&&!p&&f.error("No conversion from "+m.replace(" "," to ")),n!==!0&&(c=n?n(c):p(o(c)))}}return c}function cb(a,c,d){var e=a.contents,f=a.dataTypes,g=a.responseFields,h,i,j,k;for(i in g)i in d&&(c[g[i]]=d[i]);while(f[0]==="*")f.shift(),h===b&&(h=a.mimeType||c.getResponseHeader("content-type"));if(h)for(i in e)if(e[i]&&e[i].test(h)){f.unshift(i);break}if(f[0]in d)j=f[0];else{for(i in d){if(!f[0]||a.converters[i+" "+f[0]]){j=i;break}k||(k=i)}j=j||k}if(j){j!==f[0]&&f.unshift(j);return d[j]}}function ca(a,b,c,d){if(f.isArray(b))f.each(b,function(b,e){c||bE.test(a)?d(a,e):ca(a+"["+(typeof e=="object"||f.isArray(e)?b:"")+"]",e,c,d)});else if(!c&&b!=null&&typeof b=="object")for(var e in b)ca(a+"["+e+"]",b[e],c,d);else d(a,b)}function b_(a,c){var d,e,g=f.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&((g[d]?a:e||(e={}))[d]=c[d]);e&&f.extend(!0,a,e)}function b$(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h=a[f],i=0,j=h?h.length:0,k=a===bT,l;for(;i<j&&(k||!l);i++)l=h[i](c,d,e),typeof l=="string"&&(!k||g[l]?l=b:(c.dataTypes.unshift(l),l=b$(a,c,d,e,l,g)));(k||!l)&&!g["*"]&&(l=b$(a,c,d,e,"*",g));return l}function bZ(a){return function(b,c){typeof b!="string"&&(c=b,b="*");if(f.isFunction(c)){var d=b.toLowerCase().split(bP),e=0,g=d.length,h,i,j;for(;e<g;e++)h=d[e],j=/^\+/.test(h),j&&(h=h.substr(1)||"*"),i=a[h]=a[h]||[],i[j?"unshift":"push"](c)}}}function bC(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=b==="width"?bx:by,g=0,h=e.length;if(d>0){if(c!=="border")for(;g<h;g++)c||(d-=parseFloat(f.css(a,"padding"+e[g]))||0),c==="margin"?d+=parseFloat(f.css(a,c+e[g]))||0:d-=parseFloat(f.css(a,"border"+e[g]+"Width"))||0;return d+"px"}d=bz(a,b,b);if(d<0||d==null)d=a.style[b]||0;d=parseFloat(d)||0;if(c)for(;g<h;g++)d+=parseFloat(f.css(a,"padding"+e[g]))||0,c!=="padding"&&(d+=parseFloat(f.css(a,"border"+e[g]+"Width"))||0),c==="margin"&&(d+=parseFloat(f.css(a,c+e[g]))||0);return d+"px"}function bp(a,b){b.src?f.ajax({url:b.src,async:!1,dataType:"script"}):f.globalEval((b.text||b.textContent||b.innerHTML||"").replace(bf,"/*$0*/")),b.parentNode&&b.parentNode.removeChild(b)}function bo(a){var b=c.createElement("div");bh.appendChild(b),b.innerHTML=a.outerHTML;return b.firstChild}function bn(a){var b=(a.nodeName||"").toLowerCase();b==="input"?bm(a):b!=="script"&&typeof a.getElementsByTagName!="undefined"&&f.grep(a.getElementsByTagName("input"),bm)}function bm(a){if(a.type==="checkbox"||a.type==="radio")a.defaultChecked=a.checked}function bl(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]}function bk(a,b){var c;if(b.nodeType===1){b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase();if(c==="object")b.outerHTML=a.outerHTML;else if(c!=="input"||a.type!=="checkbox"&&a.type!=="radio"){if(c==="option")b.selected=a.defaultSelected;else if(c==="input"||c==="textarea")b.defaultValue=a.defaultValue}else a.checked&&(b.defaultChecked=b.checked=a.checked),b.value!==a.value&&(b.value=a.value);b.removeAttribute(f.expando)}}function bj(a,b){if(b.nodeType===1&&!!f.hasData(a)){var c,d,e,g=f._data(a),h=f._data(b,g),i=g.events;if(i){delete h.handle,h.events={};for(c in i)for(d=0,e=i[c].length;d<e;d++)f.event.add(b,c+(i[c][d].namespace?".":"")+i[c][d].namespace,i[c][d],i[c][d].data)}h.data&&(h.data=f.extend({},h.data))}}function bi(a,b){return f.nodeName(a,"table")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function U(a){var b=V.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}function T(a,b,c){b=b||0;if(f.isFunction(b))return f.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return f.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=f.grep(a,function(a){return a.nodeType===1});if(O.test(b))return f.filter(b,d,!c);b=f.filter(b,d)}return f.grep(a,function(a,d){return f.inArray(a,b)>=0===c})}function S(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function K(){return!0}function J(){return!1}function n(a,b,c){var d=b+"defer",e=b+"queue",g=b+"mark",h=f._data(a,d);h&&(c==="queue"||!f._data(a,e))&&(c==="mark"||!f._data(a,g))&&setTimeout(function(){!f._data(a,e)&&!f._data(a,g)&&(f.removeData(a,d,!0),h.fire())},0)}function m(a){for(var b in a){if(b==="data"&&f.isEmptyObject(a[b]))continue;if(b!=="toJSON")return!1}return!0}function l(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(k,"-$1").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:f.isNumeric(d)?parseFloat(d):j.test(d)?f.parseJSON(d):d}catch(g){}f.data(a,c,d)}else d=b}return d}function h(a){var b=g[a]={},c,d;a=a.split(/\s+/);for(c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b}var c=a.document,d=a.navigator,e=a.location,f=function(){function J(){if(!e.isReady){try{c.documentElement.doScroll("left")}catch(a){setTimeout(J,1);return}e.ready()}}var e=function(a,b){return new e.fn.init(a,b,h)},f=a.jQuery,g=a.$,h,i=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,j=/\S/,k=/^\s+/,l=/\s+$/,m=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,n=/^[\],:{}\s]*$/,o=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,p=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,q=/(?:^|:|,)(?:\s*\[)+/g,r=/(webkit)[ \/]([\w.]+)/,s=/(opera)(?:.*version)?[ \/]([\w.]+)/,t=/(msie) ([\w.]+)/,u=/(mozilla)(?:.*? rv:([\w.]+))?/,v=/-([a-z]|[0-9])/ig,w=/^-ms-/,x=function(a,b){return(b+"").toUpperCase()},y=d.userAgent,z,A,B,C=Object.prototype.toString,D=Object.prototype.hasOwnProperty,E=Array.prototype.push,F=Array.prototype.slice,G=String.prototype.trim,H=Array.prototype.indexOf,I={};e.fn=e.prototype={constructor:e,init:function(a,d,f){var g,h,j,k;if(!a)return this;if(a.nodeType){this.context=this[0]=a,this.length=1;return this}if(a==="body"&&!d&&c.body){this.context=c,this[0]=c.body,this.selector=a,this.length=1;return this}if(typeof a=="string"){a.charAt(0)!=="<"||a.charAt(a.length-1)!==">"||a.length<3?g=i.exec(a):g=[null,a,null];if(g&&(g[1]||!d)){if(g[1]){d=d instanceof e?d[0]:d,k=d?d.ownerDocument||d:c,j=m.exec(a),j?e.isPlainObject(d)?(a=[c.createElement(j[1])],e.fn.attr.call(a,d,!0)):a=[k.createElement(j[1])]:(j=e.buildFragment([g[1]],[k]),a=(j.cacheable?e.clone(j.fragment):j.fragment).childNodes);return e.merge(this,a)}h=c.getElementById(g[2]);if(h&&h.parentNode){if(h.id!==g[2])return f.find(a);this.length=1,this[0]=h}this.context=c,this.selector=a;return this}return!d||d.jquery?(d||f).find(a):this.constructor(d).find(a)}if(e.isFunction(a))return f.ready(a);a.selector!==b&&(this.selector=a.selector,this.context=a.context);return e.makeArray(a,this)},selector:"",jquery:"1.7.1",length:0,size:function(){return this.length},toArray:function(){return F.call(this,0)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=this.constructor();e.isArray(a)?E.apply(d,a):e.merge(d,a),d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")");return d},each:function(a,b){return e.each(this,a,b)},ready:function(a){e.bindReady(),A.add(a);return this},eq:function(a){a=+a;return a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(F.apply(this,arguments),"slice",F.call(arguments).join(","))},map:function(a){return this.pushStack(e.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:E,sort:[].sort,splice:[].splice},e.fn.init.prototype=e.fn,e.extend=e.fn.extend=function(){var a,c,d,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;typeof i=="boolean"&&(l=i,i=arguments[1]||{},j=2),typeof i!="object"&&!e.isFunction(i)&&(i={}),k===j&&(i=this,--j);for(;j<k;j++)if((a=arguments[j])!=null)for(c in a){d=i[c],f=a[c];if(i===f)continue;l&&f&&(e.isPlainObject(f)||(g=e.isArray(f)))?(g?(g=!1,h=d&&e.isArray(d)?d:[]):h=d&&e.isPlainObject(d)?d:{},i[c]=e.extend(l,h,f)):f!==b&&(i[c]=f)}return i},e.extend({noConflict:function(b){a.$===e&&(a.$=g),b&&a.jQuery===e&&(a.jQuery=f);return e},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){if(a===!0&&!--e.readyWait||a!==!0&&!e.isReady){if(!c.body)return setTimeout(e.ready,1);e.isReady=!0;if(a!==!0&&--e.readyWait>0)return;A.fireWith(c,[e]),e.fn.trigger&&e(c).trigger("ready").off("ready")}},bindReady:function(){if(!A){A=e.Callbacks("once memory");if(c.readyState==="complete")return setTimeout(e.ready,1);if(c.addEventListener)c.addEventListener("DOMContentLoaded",B,!1),a.addEventListener("load",e.ready,!1);else if(c.attachEvent){c.attachEvent("onreadystatechange",B),a.attachEvent("onload",e.ready);var b=!1;try{b=a.frameElement==null}catch(d){}c.documentElement.doScroll&&b&&J()}}},isFunction:function(a){return e.type(a)==="function"},isArray:Array.isArray||function(a){return e.type(a)==="array"},isWindow:function(a){return a&&typeof a=="object"&&"setInterval"in a},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):I[C.call(a)]||"object"},isPlainObject:function(a){if(!a||e.type(a)!=="object"||a.nodeType||e.isWindow(a))return!1;try{if(a.constructor&&!D.call(a,"constructor")&&!D.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var d;for(d in a);return d===b||D.call(a,d)},isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw new Error(a)},parseJSON:function(b){if(typeof b!="string"||!b)return null;b=e.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(n.test(b.replace(o,"@").replace(p,"]").replace(q,"")))return(new Function("return "+b))();e.error("Invalid JSON: "+b)},parseXML:function(c){var d,f;try{a.DOMParser?(f=new DOMParser,d=f.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))}catch(g){d=b}(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&e.error("Invalid XML: "+c);return d},noop:function(){},globalEval:function(b){b&&j.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(w,"ms-").replace(v,x)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var f,g=0,h=a.length,i=h===b||e.isFunction(a);if(d){if(i){for(f in a)if(c.apply(a[f],d)===!1)break}else for(;g<h;)if(c.apply(a[g++],d)===!1)break}else if(i){for(f in a)if(c.call(a[f],f,a[f])===!1)break}else for(;g<h;)if(c.call(a[g],g,a[g++])===!1)break;return a},trim:G?function(a){return a==null?"":G.call(a)}:function(a){return a==null?"":(a+"").replace(k,"").replace(l,"")},makeArray:function(a,b){var c=b||[];if(a!=null){var d=e.type(a);a.length==null||d==="string"||d==="function"||d==="regexp"||e.isWindow(a)?E.call(c,a):e.merge(c,a)}return c},inArray:function(a,b,c){var d;if(b){if(H)return H.call(b,a,c);d=b.length,c=c?c<0?Math.max(0,d+c):c:0;for(;c<d;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,c){var d=a.length,e=0;if(typeof c.length=="number")for(var f=c.length;e<f;e++)a[d++]=c[e];else while(c[e]!==b)a[d++]=c[e++];a.length=d;return a},grep:function(a,b,c){var d=[],e;c=!!c;for(var f=0,g=a.length;f<g;f++)e=!!b(a[f],f),c!==e&&d.push(a[f]);return d},map:function(a,c,d){var f,g,h=[],i=0,j=a.length,k=a instanceof e||j!==b&&typeof j=="number"&&(j>0&&a[0]&&a[j-1]||j===0||e.isArray(a));if(k)for(;i<j;i++)f=c(a[i],i,d),f!=null&&(h[h.length]=f);else for(g in a)f=c(a[g],g,d),f!=null&&(h[h.length]=f);return h.concat.apply([],h)},guid:1,proxy:function(a,c){if(typeof c=="string"){var d=a[c];c=a,a=d}if(!e.isFunction(a))return b;var f=F.call(arguments,2),g=function(){return a.apply(c,f.concat(F.call(arguments)))};g.guid=a.guid=a.guid||g.guid||e.guid++;return g},access:function(a,c,d,f,g,h){var i=a.length;if(typeof c=="object"){for(var j in c)e.access(a,j,c[j],f,g,d);return a}if(d!==b){f=!h&&f&&e.isFunction(d);for(var k=0;k<i;k++)g(a[k],c,f?d.call(a[k],k,g(a[k],c)):d,h);return a}return i?g(a[0],c):b},now:function(){return(new Date).getTime()},uaMatch:function(a){a=a.toLowerCase();var b=r.exec(a)||s.exec(a)||t.exec(a)||a.indexOf("compatible")<0&&u.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},sub:function(){function a(b,c){return new a.fn.init(b,c)}e.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function(d,f){f&&f instanceof e&&!(f instanceof a)&&(f=a(f));return e.fn.init.call(this,d,f,b)},a.fn.init.prototype=a.fn;var b=a(c);return a},browser:{}}),e.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){I["[object "+b+"]"]=b.toLowerCase()}),z=e.uaMatch(y),z.browser&&(e.browser[z.browser]=!0,e.browser.version=z.version),e.browser.webkit&&(e.browser.safari=!0),j.test(" ")&&(k=/^[\s\xA0]+/,l=/[\s\xA0]+$/),h=e(c),c.addEventListener?B=function(){c.removeEventListener("DOMContentLoaded",B,!1),e.ready()}:c.attachEvent&&(B=function(){c.readyState==="complete"&&(c.detachEvent("onreadystatechange",B),e.ready())});return e}(),g={};f.Callbacks=function(a){a=a?g[a]||h(a):{};var c=[],d=[],e,i,j,k,l,m=function(b){var d,e,g,h,i;for(d=0,e=b.length;d<e;d++)g=b[d],h=f.type(g),h==="array"?m(g):h==="function"&&(!a.unique||!o.has(g))&&c.push(g)},n=function(b,f){f=f||[],e=!a.memory||[b,f],i=!0,l=j||0,j=0,k=c.length;for(;c&&l<k;l++)if(c[l].apply(b,f)===!1&&a.stopOnFalse){e=!0;break}i=!1,c&&(a.once?e===!0?o.disable():c=[]:d&&d.length&&(e=d.shift(),o.fireWith(e[0],e[1])))},o={add:function(){if(c){var a=c.length;m(arguments),i?k=c.length:e&&e!==!0&&(j=a,n(e[0],e[1]))}return this},remove:function(){if(c){var b=arguments,d=0,e=b.length;for(;d<e;d++)for(var f=0;f<c.length;f++)if(b[d]===c[f]){i&&f<=k&&(k--,f<=l&&l--),c.splice(f--,1);if(a.unique)break}}return this},has:function(a){if(c){var b=0,d=c.length;for(;b<d;b++)if(a===c[b])return!0}return!1},empty:function(){c=[];return this},disable:function(){c=d=e=b;return this},disabled:function(){return!c},lock:function(){d=b,(!e||e===!0)&&o.disable();return this},locked:function(){return!d},fireWith:function(b,c){d&&(i?a.once||d.push([b,c]):(!a.once||!e)&&n(b,c));return this},fire:function(){o.fireWith(this,arguments);return this},fired:function(){return!!e}};return o};var i=[].slice;f.extend({Deferred:function(a){var b=f.Callbacks("once memory"),c=f.Callbacks("once memory"),d=f.Callbacks("memory"),e="pending",g={resolve:b,reject:c,notify:d},h={done:b.add,fail:c.add,progress:d.add,state:function(){return e},isResolved:b.fired,isRejected:c.fired,then:function(a,b,c){i.done(a).fail(b).progress(c);return this},always:function(){i.done.apply(i,arguments).fail.apply(i,arguments);return this},pipe:function(a,b,c){return f.Deferred(function(d){f.each({done:[a,"resolve"],fail:[b,"reject"],progress:[c,"notify"]},function(a,b){var c=b[0],e=b[1],g;f.isFunction(c)?i[a](function(){g=c.apply(this,arguments),g&&f.isFunction(g.promise)?g.promise().then(d.resolve,d.reject,d.notify):d[e+"With"](this===i?d:this,[g])}):i[a](d[e])})}).promise()},promise:function(a){if(a==null)a=h;else for(var b in h)a[b]=h[b];return a}},i=h.promise({}),j;for(j in g)i[j]=g[j].fire,i[j+"With"]=g[j].fireWith;i.done(function(){e="resolved"},c.disable,d.lock).fail(function(){e="rejected"},b.disable,d.lock),a&&a.call(i,i);return i},when:function(a){function m(a){return function(b){e[a]=arguments.length>1?i.call(arguments,0):b,j.notifyWith(k,e)}}function l(a){return function(c){b[a]=arguments.length>1?i.call(arguments,0):c,--g||j.resolveWith(j,b)}}var b=i.call(arguments,0),c=0,d=b.length,e=Array(d),g=d,h=d,j=d<=1&&a&&f.isFunction(a.promise)?a:f.Deferred(),k=j.promise();if(d>1){for(;c<d;c++)b[c]&&b[c].promise&&f.isFunction(b[c].promise)?b[c].promise().then(l(c),j.reject,m(c)):--g;g||j.resolveWith(j,b)}else j!==a&&j.resolveWith(j,d?[a]:[]);return k}}),f.support=function(){var b,d,e,g,h,i,j,k,l,m,n,o,p,q=c.createElement("div"),r=c.documentElement;q.setAttribute("className","t"),q.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>",d=q.getElementsByTagName("*"),e=q.getElementsByTagName("a")[0];if(!d||!d.length||!e)return{};g=c.createElement("select"),h=g.appendChild(c.createElement("option")),i=q.getElementsByTagName("input")[0],b={leadingWhitespace:q.firstChild.nodeType===3,tbody:!q.getElementsByTagName("tbody").length,htmlSerialize:!!q.getElementsByTagName("link").length,style:/top/.test(e.getAttribute("style")),hrefNormalized:e.getAttribute("href")==="/a",opacity:/^0.55/.test(e.style.opacity),cssFloat:!!e.style.cssFloat,checkOn:i.value==="on",optSelected:h.selected,getSetAttribute:q.className!=="t",enctype:!!c.createElement("form").enctype,html5Clone:c.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0},i.checked=!0,b.noCloneChecked=i.cloneNode(!0).checked,g.disabled=!0,b.optDisabled=!h.disabled;try{delete q.test}catch(s){b.deleteExpando=!1}!q.addEventListener&&q.attachEvent&&q.fireEvent&&(q.attachEvent("onclick",function(){b.noCloneEvent=!1}),q.cloneNode(!0).fireEvent("onclick")),i=c.createElement("input"),i.value="t",i.setAttribute("type","radio"),b.radioValue=i.value==="t",i.setAttribute("checked","checked"),q.appendChild(i),k=c.createDocumentFragment(),k.appendChild(q.lastChild),b.checkClone=k.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=i.checked,k.removeChild(i),k.appendChild(q),q.innerHTML="",a.getComputedStyle&&(j=c.createElement("div"),j.style.width="0",j.style.marginRight="0",q.style.width="2px",q.appendChild(j),b.reliableMarginRight=(parseInt((a.getComputedStyle(j,null)||{marginRight:0}).marginRight,10)||0)===0);if(q.attachEvent)for(o in{submit:1,change:1,focusin:1})n="on"+o,p=n in q,p||(q.setAttribute(n,"return;"),p=typeof q[n]=="function"),b[o+"Bubbles"]=p;k.removeChild(q),k=g=h=j=q=i=null,f(function(){var a,d,e,g,h,i,j,k,m,n,o,r=c.getElementsByTagName("body")[0];!r||(j=1,k="position:absolute;top:0;left:0;width:1px;height:1px;margin:0;",m="visibility:hidden;border:0;",n="style='"+k+"border:5px solid #000;padding:0;'",o="<div "+n+"><div></div></div>"+"<table "+n+" cellpadding='0' cellspacing='0'>"+"<tr><td></td></tr></table>",a=c.createElement("div"),a.style.cssText=m+"width:0;height:0;position:static;top:0;margin-top:"+j+"px",r.insertBefore(a,r.firstChild),q=c.createElement("div"),a.appendChild(q),q.innerHTML="<table><tr><td style='padding:0;border:0;display:none'></td><td>t</td></tr></table>",l=q.getElementsByTagName("td"),p=l[0].offsetHeight===0,l[0].style.display="",l[1].style.display="none",b.reliableHiddenOffsets=p&&l[0].offsetHeight===0,q.innerHTML="",q.style.width=q.style.paddingLeft="1px",f.boxModel=b.boxModel=q.offsetWidth===2,typeof q.style.zoom!="undefined"&&(q.style.display="inline",q.style.zoom=1,b.inlineBlockNeedsLayout=q.offsetWidth===2,q.style.display="",q.innerHTML="<div style='width:4px;'></div>",b.shrinkWrapBlocks=q.offsetWidth!==2),q.style.cssText=k+m,q.innerHTML=o,d=q.firstChild,e=d.firstChild,h=d.nextSibling.firstChild.firstChild,i={doesNotAddBorder:e.offsetTop!==5,doesAddBorderForTableAndCells:h.offsetTop===5},e.style.position="fixed",e.style.top="20px",i.fixedPosition=e.offsetTop===20||e.offsetTop===15,e.style.position=e.style.top="",d.style.overflow="hidden",d.style.position="relative",i.subtractsBorderForOverflowNotVisible=e.offsetTop===-5,i.doesNotIncludeMarginInBodyOffset=r.offsetTop!==j,r.removeChild(a),q=a=null,f.extend(b,i))});return b}();var j=/^(?:\{.*\}|\[.*\])$/,k=/([A-Z])/g;f.extend({cache:{},uuid:0,expando:"jQuery"+(f.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?f.cache[a[f.expando]]:a[f.expando];return!!a&&!m(a)},data:function(a,c,d,e){if(!!f.acceptData(a)){var g,h,i,j=f.expando,k=typeof c=="string",l=a.nodeType,m=l?f.cache:a,n=l?a[j]:a[j]&&j,o=c==="events";if((!n||!m[n]||!o&&!e&&!m[n].data)&&k&&d===b)return;n||(l?a[j]=n=++f.uuid:n=j),m[n]||(m[n]={},l||(m[n].toJSON=f.noop));if(typeof c=="object"||typeof c=="function")e?m[n]=f.extend(m[n],c):m[n].data=f.extend(m[n].data,c);g=h=m[n],e||(h.data||(h.data={}),h=h.data),d!==b&&(h[f.camelCase(c)]=d);if(o&&!h[c])return g.events;k?(i=h[c],i==null&&(i=h[f.camelCase(c)])):i=h;return i}},removeData:function(a,b,c){if(!!f.acceptData(a)){var d,e,g,h=f.expando,i=a.nodeType,j=i?f.cache:a,k=i?a[h]:h;if(!j[k])return;if(b){d=c?j[k]:j[k].data;if(d){f.isArray(b)||(b in d?b=[b]:(b=f.camelCase(b),b in d?b=[b]:b=b.split(" ")));for(e=0,g=b.length;e<g;e++)delete d[b[e]];if(!(c?m:f.isEmptyObject)(d))return}}if(!c){delete j[k].data;if(!m(j[k]))return}f.support.deleteExpando||!j.setInterval?delete j[k]:j[k]=null,i&&(f.support.deleteExpando?delete a[h]:a.removeAttribute?a.removeAttribute(h):a[h]=null)}},_data:function(a,b,c){return f.data(a,b,c,!0)},acceptData:function(a){if(a.nodeName){var b=f.noData[a.nodeName.toLowerCase()];if(b)return b!==!0&&a.getAttribute("classid")===b}return!0}}),f.fn.extend({data:function(a,c){var d,e,g,h=null;if(typeof a=="undefined"){if(this.length){h=f.data(this[0]);if(this[0].nodeType===1&&!f._data(this[0],"parsedAttrs")){e=this[0].attributes;for(var i=0,j=e.length;i<j;i++)g=e[i].name,g.indexOf("data-")===0&&(g=f.camelCase(g.substring(5)),l(this[0],g,h[g]));f._data(this[0],"parsedAttrs",!0)}}return h}if(typeof a=="object")return this.each(function(){f.data(this,a)});d=a.split("."),d[1]=d[1]?"."+d[1]:"";if(c===b){h=this.triggerHandler("getData"+d[1]+"!",[d[0]]),h===b&&this.length&&(h=f.data(this[0],a),h=l(this[0],a,h));return h===b&&d[1]?this.data(d[0]):h}return this.each(function(){var b=f(this),e=[d[0],c];b.triggerHandler("setData"+d[1]+"!",e),f.data(this,a,c),b.triggerHandler("changeData"+d[1]+"!",e)})},removeData:function(a){return this.each(function(){f.removeData(this,a)})}}),f.extend({_mark:function(a,b){a&&(b=(b||"fx")+"mark",f._data(a,b,(f._data(a,b)||0)+1))},_unmark:function(a,b,c){a!==!0&&(c=b,b=a,a=!1);if(b){c=c||"fx";var d=c+"mark",e=a?0:(f._data(b,d)||1)-1;e?f._data(b,d,e):(f.removeData(b,d,!0),n(b,c,"mark"))}},queue:function(a,b,c){var d;if(a){b=(b||"fx")+"queue",d=f._data(a,b),c&&(!d||f.isArray(c)?d=f._data(a,b,f.makeArray(c)):d.push(c));return d||[]}},dequeue:function(a,b){b=b||"fx";var c=f.queue(a,b),d=c.shift(),e={};d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),f._data(a,b+".run",e),d.call(a,function(){f.dequeue(a,b)},e)),c.length||(f.removeData(a,b+"queue "+b+".run",!0),n(a,b,"queue"))}}),f.fn.extend({queue:function(a,c){typeof a!="string"&&(c=a,a="fx");if(c===b)return f.queue(this[0],a);return this.each(function(){var b=f.queue(this,a,c);a==="fx"&&b[0]!=="inprogress"&&f.dequeue(this,a)})},dequeue:function(a){return this.each(function(){f.dequeue(this,a)})},delay:function(a,b){a=f.fx?f.fx.speeds[a]||a:a,b=b||"fx";return this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){function m(){--h||d.resolveWith(e,[e])}typeof a!="string"&&(c=a,a=b),a=a||"fx";var d=f.Deferred(),e=this,g=e.length,h=1,i=a+"defer",j=a+"queue",k=a+"mark",l;while(g--)if(l=f.data(e[g],i,b,!0)||(f.data(e[g],j,b,!0)||f.data(e[g],k,b,!0))&&f.data(e[g],i,f.Callbacks("once memory"),!0))h++,l.add(m);m();return d.promise()}});var o=/[\n\t\r]/g,p=/\s+/,q=/\r/g,r=/^(?:button|input)$/i,s=/^(?:button|input|object|select|textarea)$/i,t=/^a(?:rea)?$/i,u=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,v=f.support.getSetAttribute,w,x,y;f.fn.extend({attr:function(a,b){return f.access(this,a,b,!0,f.attr)},removeAttr:function(a){return this.each(function(){f.removeAttr(this,a)})},prop:function(a,b){return f.access(this,a,b,!0,f.prop)},removeProp:function(a){a=f.propFix[a]||a;return this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,g,h,i;if(f.isFunction(a))return this.each(function(b){f(this).addClass(a.call(this,b,this.className))});if(a&&typeof a=="string"){b=a.split(p);for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1)if(!e.className&&b.length===1)e.className=a;else{g=" "+e.className+" ";for(h=0,i=b.length;h<i;h++)~g.indexOf(" "+b[h]+" ")||(g+=b[h]+" ");e.className=f.trim(g)}}}return this},removeClass:function(a){var c,d,e,g,h,i,j;if(f.isFunction(a))return this.each(function(b){f(this).removeClass(a.call(this,b,this.className))});if(a&&typeof a=="string"||a===b){c=(a||"").split(p);for(d=0,e=this.length;d<e;d++){g=this[d];if(g.nodeType===1&&g.className)if(a){h=(" "+g.className+" ").replace(o," ");for(i=0,j=c.length;i<j;i++)h=h.replace(" "+c[i]+" "," ");g.className=f.trim(h)}else g.className=""}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";if(f.isFunction(a))return this.each(function(c){f(this).toggleClass(a.call(this,c,this.className,b),b)});return this.each(function(){if(c==="string"){var e,g=0,h=f(this),i=b,j=a.split(p);while(e=j[g++])i=d?i:!h.hasClass(e),h[i?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&f._data(this,"__className__",this.className),this.className=this.className||a===!1?"":f._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++)if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(o," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e,g=this[0];{if(!!arguments.length){e=f.isFunction(a);return this.each(function(d){var g=f(this),h;if(this.nodeType===1){e?h=a.call(this,d,g.val()):h=a,h==null?h="":typeof h=="number"?h+="":f.isArray(h)&&(h=f.map(h,function(a){return a==null?"":a+""})),c=f.valHooks[this.nodeName.toLowerCase()]||f.valHooks[this.type];if(!c||!("set"in c)||c.set(this,h,"value")===b)this.value=h}})}if(g){c=f.valHooks[g.nodeName.toLowerCase()]||f.valHooks[g.type];if(c&&"get"in c&&(d=c.get(g,"value"))!==b)return d;d=g.value;return typeof d=="string"?d.replace(q,""):d==null?"":d}}}}),f.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,g=a.selectedIndex,h=[],i=a.options,j=a.type==="select-one";if(g<0)return null;c=j?g:0,d=j?g+1:i.length;for(;c<d;c++){e=i[c];if(e.selected&&(f.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!f.nodeName(e.parentNode,"optgroup"))){b=f(e).val();if(j)return b;h.push(b)}}if(j&&!h.length&&i.length)return f(i[g]).val();return h},set:function(a,b){var c=f.makeArray(b);f(a).find("option").each(function(){this.selected=f.inArray(f(this).val(),c)>=0}),c.length||(a.selectedIndex=-1);return c}}},attrFn:{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0},attr:function(a,c,d,e){var g,h,i,j=a.nodeType;if(!!a&&j!==3&&j!==8&&j!==2){if(e&&c in f.attrFn)return f(a)[c](d);if(typeof a.getAttribute=="undefined")return f.prop(a,c,d);i=j!==1||!f.isXMLDoc(a),i&&(c=c.toLowerCase(),h=f.attrHooks[c]||(u.test(c)?x:w));if(d!==b){if(d===null){f.removeAttr(a,c);return}if(h&&"set"in h&&i&&(g=h.set(a,d,c))!==b)return g;a.setAttribute(c,""+d);return d}if(h&&"get"in h&&i&&(g=h.get(a,c))!==null)return g;g=a.getAttribute(c);return g===null?b:g}},removeAttr:function(a,b){var c,d,e,g,h=0;if(b&&a.nodeType===1){d=b.toLowerCase().split(p),g=d.length;for(;h<g;h++)e=d[h],e&&(c=f.propFix[e]||e,f.attr(a,e,""),a.removeAttribute(v?e:c),u.test(e)&&c in a&&(a[c]=!1))}},attrHooks:{type:{set:function(a,b){if(r.test(a.nodeName)&&a.parentNode)f.error("type property can't be changed");else if(!f.support.radioValue&&b==="radio"&&f.nodeName(a,"input")){var c=a.value;a.setAttribute("type",b),c&&(a.value=c);return b}}},value:{get:function(a,b){if(w&&f.nodeName(a,"button"))return w.get(a,b);return b in a?a.value:null},set:function(a,b,c){if(w&&f.nodeName(a,"button"))return w.set(a,b,c);a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,g,h,i=a.nodeType;if(!!a&&i!==3&&i!==8&&i!==2){h=i!==1||!f.isXMLDoc(a),h&&(c=f.propFix[c]||c,g=f.propHooks[c]);return d!==b?g&&"set"in g&&(e=g.set(a,d,c))!==b?e:a[c]=d:g&&"get"in g&&(e=g.get(a,c))!==null?e:a[c]}},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):s.test(a.nodeName)||t.test(a.nodeName)&&a.href?0:b}}}}),f.attrHooks.tabindex=f.propHooks.tabIndex,x={get:function(a,c){var d,e=f.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b},set:function(a,b,c){var d;b===!1?f.removeAttr(a,c):(d=f.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase()));return c}},v||(y={name:!0,id:!0},w=f.valHooks.button={get:function(a,c){var d;d=a.getAttributeNode(c);return d&&(y[c]?d.nodeValue!=="":d.specified)?d.nodeValue:b},set:function(a,b,d){var e=a.getAttributeNode(d);e||(e=c.createAttribute(d),a.setAttributeNode(e));return e.nodeValue=b+""}},f.attrHooks.tabindex.set=w.set,f.each(["width","height"],function(a,b){f.attrHooks[b]=f.extend(f.attrHooks[b],{set:function(a,c){if(c===""){a.setAttribute(b,"auto");return c}}})}),f.attrHooks.contenteditable={get:w.get,set:function(a,b,c){b===""&&(b="false"),w.set(a,b,c)}}),f.support.hrefNormalized||f.each(["href","src","width","height"],function(a,c){f.attrHooks[c]=f.extend(f.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),f.support.style||(f.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),f.support.optSelected||(f.propHooks.selected=f.extend(f.propHooks.selected,{get:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex);return null}})),f.support.enctype||(f.propFix.enctype="encoding"),f.support.checkOn||f.each(["radio","checkbox"],function(){f.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),f.each(["radio","checkbox"],function(){f.valHooks[this]=f.extend(f.valHooks[this],{set:function(a,b){if(f.isArray(b))return a.checked=f.inArray(f(a).val(),b)>=0}})});var z=/^(?:textarea|input|select)$/i,A=/^([^\.]*)?(?:\.(.+))?$/,B=/\bhover(\.\S+)?\b/,C=/^key/,D=/^(?:mouse|contextmenu)|click/,E=/^(?:focusinfocus|focusoutblur)$/,F=/^(\w*)(?:#([\w\-]+))?(?:\.([\w\-]+))?$/,G=function(a){var b=F.exec(a);b&&(b[1]=(b[1]||"").toLowerCase(),b[3]=b[3]&&new RegExp("(?:^|\\s)"+b[3]+"(?:\\s|$)"));return b},H=function(a,b){var c=a.attributes||{};return(!b[1]||a.nodeName.toLowerCase()===b[1])&&(!b[2]||(c.id||{}).value===b[2])&&(!b[3]||b[3].test((c["class"]||{}).value))},I=function(a){return f.event.special.hover?a:a.replace(B,"mouseenter$1 mouseleave$1")};
f.event={add:function(a,c,d,e,g){var h,i,j,k,l,m,n,o,p,q,r,s;if(!(a.nodeType===3||a.nodeType===8||!c||!d||!(h=f._data(a)))){d.handler&&(p=d,d=p.handler),d.guid||(d.guid=f.guid++),j=h.events,j||(h.events=j={}),i=h.handle,i||(h.handle=i=function(a){return typeof f!="undefined"&&(!a||f.event.triggered!==a.type)?f.event.dispatch.apply(i.elem,arguments):b},i.elem=a),c=f.trim(I(c)).split(" ");for(k=0;k<c.length;k++){l=A.exec(c[k])||[],m=l[1],n=(l[2]||"").split(".").sort(),s=f.event.special[m]||{},m=(g?s.delegateType:s.bindType)||m,s=f.event.special[m]||{},o=f.extend({type:m,origType:l[1],data:e,handler:d,guid:d.guid,selector:g,quick:G(g),namespace:n.join(".")},p),r=j[m];if(!r){r=j[m]=[],r.delegateCount=0;if(!s.setup||s.setup.call(a,e,n,i)===!1)a.addEventListener?a.addEventListener(m,i,!1):a.attachEvent&&a.attachEvent("on"+m,i)}s.add&&(s.add.call(a,o),o.handler.guid||(o.handler.guid=d.guid)),g?r.splice(r.delegateCount++,0,o):r.push(o),f.event.global[m]=!0}a=null}},global:{},remove:function(a,b,c,d,e){var g=f.hasData(a)&&f._data(a),h,i,j,k,l,m,n,o,p,q,r,s;if(!!g&&!!(o=g.events)){b=f.trim(I(b||"")).split(" ");for(h=0;h<b.length;h++){i=A.exec(b[h])||[],j=k=i[1],l=i[2];if(!j){for(j in o)f.event.remove(a,j+b[h],c,d,!0);continue}p=f.event.special[j]||{},j=(d?p.delegateType:p.bindType)||j,r=o[j]||[],m=r.length,l=l?new RegExp("(^|\\.)"+l.split(".").sort().join("\\.(?:.*\\.)?")+"(\\.|$)"):null;for(n=0;n<r.length;n++)s=r[n],(e||k===s.origType)&&(!c||c.guid===s.guid)&&(!l||l.test(s.namespace))&&(!d||d===s.selector||d==="**"&&s.selector)&&(r.splice(n--,1),s.selector&&r.delegateCount--,p.remove&&p.remove.call(a,s));r.length===0&&m!==r.length&&((!p.teardown||p.teardown.call(a,l)===!1)&&f.removeEvent(a,j,g.handle),delete o[j])}f.isEmptyObject(o)&&(q=g.handle,q&&(q.elem=null),f.removeData(a,["events","handle"],!0))}},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,e,g){if(!e||e.nodeType!==3&&e.nodeType!==8){var h=c.type||c,i=[],j,k,l,m,n,o,p,q,r,s;if(E.test(h+f.event.triggered))return;h.indexOf("!")>=0&&(h=h.slice(0,-1),k=!0),h.indexOf(".")>=0&&(i=h.split("."),h=i.shift(),i.sort());if((!e||f.event.customEvent[h])&&!f.event.global[h])return;c=typeof c=="object"?c[f.expando]?c:new f.Event(h,c):new f.Event(h),c.type=h,c.isTrigger=!0,c.exclusive=k,c.namespace=i.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+i.join("\\.(?:.*\\.)?")+"(\\.|$)"):null,o=h.indexOf(":")<0?"on"+h:"";if(!e){j=f.cache;for(l in j)j[l].events&&j[l].events[h]&&f.event.trigger(c,d,j[l].handle.elem,!0);return}c.result=b,c.target||(c.target=e),d=d!=null?f.makeArray(d):[],d.unshift(c),p=f.event.special[h]||{};if(p.trigger&&p.trigger.apply(e,d)===!1)return;r=[[e,p.bindType||h]];if(!g&&!p.noBubble&&!f.isWindow(e)){s=p.delegateType||h,m=E.test(s+h)?e:e.parentNode,n=null;for(;m;m=m.parentNode)r.push([m,s]),n=m;n&&n===e.ownerDocument&&r.push([n.defaultView||n.parentWindow||a,s])}for(l=0;l<r.length&&!c.isPropagationStopped();l++)m=r[l][0],c.type=r[l][1],q=(f._data(m,"events")||{})[c.type]&&f._data(m,"handle"),q&&q.apply(m,d),q=o&&m[o],q&&f.acceptData(m)&&q.apply(m,d)===!1&&c.preventDefault();c.type=h,!g&&!c.isDefaultPrevented()&&(!p._default||p._default.apply(e.ownerDocument,d)===!1)&&(h!=="click"||!f.nodeName(e,"a"))&&f.acceptData(e)&&o&&e[h]&&(h!=="focus"&&h!=="blur"||c.target.offsetWidth!==0)&&!f.isWindow(e)&&(n=e[o],n&&(e[o]=null),f.event.triggered=h,e[h](),f.event.triggered=b,n&&(e[o]=n));return c.result}},dispatch:function(c){c=f.event.fix(c||a.event);var d=(f._data(this,"events")||{})[c.type]||[],e=d.delegateCount,g=[].slice.call(arguments,0),h=!c.exclusive&&!c.namespace,i=[],j,k,l,m,n,o,p,q,r,s,t;g[0]=c,c.delegateTarget=this;if(e&&!c.target.disabled&&(!c.button||c.type!=="click")){m=f(this),m.context=this.ownerDocument||this;for(l=c.target;l!=this;l=l.parentNode||this){o={},q=[],m[0]=l;for(j=0;j<e;j++)r=d[j],s=r.selector,o[s]===b&&(o[s]=r.quick?H(l,r.quick):m.is(s)),o[s]&&q.push(r);q.length&&i.push({elem:l,matches:q})}}d.length>e&&i.push({elem:this,matches:d.slice(e)});for(j=0;j<i.length&&!c.isPropagationStopped();j++){p=i[j],c.currentTarget=p.elem;for(k=0;k<p.matches.length&&!c.isImmediatePropagationStopped();k++){r=p.matches[k];if(h||!c.namespace&&!r.namespace||c.namespace_re&&c.namespace_re.test(r.namespace))c.data=r.data,c.handleObj=r,n=((f.event.special[r.origType]||{}).handle||r.handler).apply(p.elem,g),n!==b&&(c.result=n,n===!1&&(c.preventDefault(),c.stopPropagation()))}}return c.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode);return a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,d){var e,f,g,h=d.button,i=d.fromElement;a.pageX==null&&d.clientX!=null&&(e=a.target.ownerDocument||c,f=e.documentElement,g=e.body,a.pageX=d.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=d.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?d.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0);return a}},fix:function(a){if(a[f.expando])return a;var d,e,g=a,h=f.event.fixHooks[a.type]||{},i=h.props?this.props.concat(h.props):this.props;a=f.Event(g);for(d=i.length;d;)e=i[--d],a[e]=g[e];a.target||(a.target=g.srcElement||c),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey===b&&(a.metaKey=a.ctrlKey);return h.filter?h.filter(a,g):a},special:{ready:{setup:f.bindReady},load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){f.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=f.extend(new f.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?f.event.trigger(e,null,b):f.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},f.event.handle=f.event.dispatch,f.removeEvent=c.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){a.detachEvent&&a.detachEvent("on"+b,c)},f.Event=function(a,b){if(!(this instanceof f.Event))return new f.Event(a,b);a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?K:J):this.type=a,b&&f.extend(this,b),this.timeStamp=a&&a.timeStamp||f.now(),this[f.expando]=!0},f.Event.prototype={preventDefault:function(){this.isDefaultPrevented=K;var a=this.originalEvent;!a||(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){this.isPropagationStopped=K;var a=this.originalEvent;!a||(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=K,this.stopPropagation()},isDefaultPrevented:J,isPropagationStopped:J,isImmediatePropagationStopped:J},f.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){f.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c=this,d=a.relatedTarget,e=a.handleObj,g=e.selector,h;if(!d||d!==c&&!f.contains(c,d))a.type=e.origType,h=e.handler.apply(this,arguments),a.type=b;return h}}}),f.support.submitBubbles||(f.event.special.submit={setup:function(){if(f.nodeName(this,"form"))return!1;f.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=f.nodeName(c,"input")||f.nodeName(c,"button")?c.form:b;d&&!d._submit_attached&&(f.event.add(d,"submit._submit",function(a){this.parentNode&&!a.isTrigger&&f.event.simulate("submit",this.parentNode,a,!0)}),d._submit_attached=!0)})},teardown:function(){if(f.nodeName(this,"form"))return!1;f.event.remove(this,"._submit")}}),f.support.changeBubbles||(f.event.special.change={setup:function(){if(z.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")f.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),f.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1,f.event.simulate("change",this,a,!0))});return!1}f.event.add(this,"beforeactivate._change",function(a){var b=a.target;z.test(b.nodeName)&&!b._change_attached&&(f.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&f.event.simulate("change",this.parentNode,a,!0)}),b._change_attached=!0)})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox")return a.handleObj.handler.apply(this,arguments)},teardown:function(){f.event.remove(this,"._change");return z.test(this.nodeName)}}),f.support.focusinBubbles||f.each({focus:"focusin",blur:"focusout"},function(a,b){var d=0,e=function(a){f.event.simulate(b,a.target,f.event.fix(a),!0)};f.event.special[b]={setup:function(){d++===0&&c.addEventListener(a,e,!0)},teardown:function(){--d===0&&c.removeEventListener(a,e,!0)}}}),f.fn.extend({on:function(a,c,d,e,g){var h,i;if(typeof a=="object"){typeof c!="string"&&(d=c,c=b);for(i in a)this.on(i,c,d,a[i],g);return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));if(e===!1)e=J;else if(!e)return this;g===1&&(h=e,e=function(a){f().off(a);return h.apply(this,arguments)},e.guid=h.guid||(h.guid=f.guid++));return this.each(function(){f.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on.call(this,a,b,c,d,1)},off:function(a,c,d){if(a&&a.preventDefault&&a.handleObj){var e=a.handleObj;f(a.delegateTarget).off(e.namespace?e.type+"."+e.namespace:e.type,e.selector,e.handler);return this}if(typeof a=="object"){for(var g in a)this.off(g,c,a[g]);return this}if(c===!1||typeof c=="function")d=c,c=b;d===!1&&(d=J);return this.each(function(){f.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){f(this.context).on(a,this.selector,b,c);return this},die:function(a,b){f(this.context).off(a,this.selector||"**",b);return this},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a,c)},trigger:function(a,b){return this.each(function(){f.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return f.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||f.guid++,d=0,e=function(c){var e=(f._data(this,"lastToggle"+a.guid)||0)%d;f._data(this,"lastToggle"+a.guid,e+1),c.preventDefault();return b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),f.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){f.fn[b]=function(a,c){c==null&&(c=a,a=null);return arguments.length>0?this.on(b,null,a,c):this.trigger(b)},f.attrFn&&(f.attrFn[b]=!0),C.test(b)&&(f.event.fixHooks[b]=f.event.keyHooks),D.test(b)&&(f.event.fixHooks[b]=f.event.mouseHooks)}),function(){function x(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}if(j.nodeType===1){g||(j[d]=c,j.sizset=h);if(typeof b!="string"){if(j===b){k=!0;break}}else if(m.filter(b,[j]).length>0){k=j;break}}j=j[a]}e[h]=k}}}function w(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}j.nodeType===1&&!g&&(j[d]=c,j.sizset=h);if(j.nodeName.toLowerCase()===b){k=j;break}j=j[a]}e[h]=k}}}var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,d="sizcache"+(Math.random()+"").replace(".",""),e=0,g=Object.prototype.toString,h=!1,i=!0,j=/\\/g,k=/\r\n/g,l=/\W/;[0,0].sort(function(){i=!1;return 0});var m=function(b,d,e,f){e=e||[],d=d||c;var h=d;if(d.nodeType!==1&&d.nodeType!==9)return[];if(!b||typeof b!="string")return e;var i,j,k,l,n,q,r,t,u=!0,v=m.isXML(d),w=[],x=b;do{a.exec(""),i=a.exec(x);if(i){x=i[3],w.push(i[1]);if(i[2]){l=i[3];break}}}while(i);if(w.length>1&&p.exec(b))if(w.length===2&&o.relative[w[0]])j=y(w[0]+w[1],d,f);else{j=o.relative[w[0]]?[d]:m(w.shift(),d);while(w.length)b=w.shift(),o.relative[b]&&(b+=w.shift()),j=y(b,j,f)}else{!f&&w.length>1&&d.nodeType===9&&!v&&o.match.ID.test(w[0])&&!o.match.ID.test(w[w.length-1])&&(n=m.find(w.shift(),d,v),d=n.expr?m.filter(n.expr,n.set)[0]:n.set[0]);if(d){n=f?{expr:w.pop(),set:s(f)}:m.find(w.pop(),w.length===1&&(w[0]==="~"||w[0]==="+")&&d.parentNode?d.parentNode:d,v),j=n.expr?m.filter(n.expr,n.set):n.set,w.length>0?k=s(j):u=!1;while(w.length)q=w.pop(),r=q,o.relative[q]?r=w.pop():q="",r==null&&(r=d),o.relative[q](k,r,v)}else k=w=[]}k||(k=j),k||m.error(q||b);if(g.call(k)==="[object Array]")if(!u)e.push.apply(e,k);else if(d&&d.nodeType===1)for(t=0;k[t]!=null;t++)k[t]&&(k[t]===!0||k[t].nodeType===1&&m.contains(d,k[t]))&&e.push(j[t]);else for(t=0;k[t]!=null;t++)k[t]&&k[t].nodeType===1&&e.push(j[t]);else s(k,e);l&&(m(l,h,e,f),m.uniqueSort(e));return e};m.uniqueSort=function(a){if(u){h=i,a.sort(u);if(h)for(var b=1;b<a.length;b++)a[b]===a[b-1]&&a.splice(b--,1)}return a},m.matches=function(a,b){return m(a,null,null,b)},m.matchesSelector=function(a,b){return m(b,null,null,[a]).length>0},m.find=function(a,b,c){var d,e,f,g,h,i;if(!a)return[];for(e=0,f=o.order.length;e<f;e++){h=o.order[e];if(g=o.leftMatch[h].exec(a)){i=g[1],g.splice(1,1);if(i.substr(i.length-1)!=="\\"){g[1]=(g[1]||"").replace(j,""),d=o.find[h](g,b,c);if(d!=null){a=a.replace(o.match[h],"");break}}}}d||(d=typeof b.getElementsByTagName!="undefined"?b.getElementsByTagName("*"):[]);return{set:d,expr:a}},m.filter=function(a,c,d,e){var f,g,h,i,j,k,l,n,p,q=a,r=[],s=c,t=c&&c[0]&&m.isXML(c[0]);while(a&&c.length){for(h in o.filter)if((f=o.leftMatch[h].exec(a))!=null&&f[2]){k=o.filter[h],l=f[1],g=!1,f.splice(1,1);if(l.substr(l.length-1)==="\\")continue;s===r&&(r=[]);if(o.preFilter[h]){f=o.preFilter[h](f,s,d,r,e,t);if(!f)g=i=!0;else if(f===!0)continue}if(f)for(n=0;(j=s[n])!=null;n++)j&&(i=k(j,f,n,s),p=e^i,d&&i!=null?p?g=!0:s[n]=!1:p&&(r.push(j),g=!0));if(i!==b){d||(s=r),a=a.replace(o.match[h],"");if(!g)return[];break}}if(a===q)if(g==null)m.error(a);else break;q=a}return s},m.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)};var n=m.getText=function(a){var b,c,d=a.nodeType,e="";if(d){if(d===1||d===9){if(typeof a.textContent=="string")return a.textContent;if(typeof a.innerText=="string")return a.innerText.replace(k,"");for(a=a.firstChild;a;a=a.nextSibling)e+=n(a)}else if(d===3||d===4)return a.nodeValue}else for(b=0;c=a[b];b++)c.nodeType!==8&&(e+=n(c));return e},o=m.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b=="string",d=c&&!l.test(b),e=c&&!d;d&&(b=b.toLowerCase());for(var f=0,g=a.length,h;f<g;f++)if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1);a[f]=e||h&&h.nodeName.toLowerCase()===b?h||!1:h===b}e&&m.filter(b,a,!0)},">":function(a,b){var c,d=typeof b=="string",e=0,f=a.length;if(d&&!l.test(b)){b=b.toLowerCase();for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:!1}}}else{for(;e<f;e++)c=a[e],c&&(a[e]=d?c.parentNode:c.parentNode===b);d&&m.filter(b,a,!0)}},"":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("parentNode",b,f,a,d,c)},"~":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("previousSibling",b,f,a,d,c)}},find:{ID:function(a,b,c){if(typeof b.getElementById!="undefined"&&!c){var d=b.getElementById(a[1]);return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!="undefined"){var c=[],d=b.getElementsByName(a[1]);for(var e=0,f=d.length;e<f;e++)d[e].getAttribute("name")===a[1]&&c.push(d[e]);return c.length===0?null:c}},TAG:function(a,b){if(typeof b.getElementsByTagName!="undefined")return b.getElementsByTagName(a[1])}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(j,"")+" ";if(f)return a;for(var g=0,h;(h=b[g])!=null;g++)h&&(e^(h.className&&(" "+h.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)?c||d.push(h):c&&(b[g]=!1));return!1},ID:function(a){return a[1].replace(j,"")},TAG:function(a,b){return a[1].replace(j,"").toLowerCase()},CHILD:function(a){if(a[1]==="nth"){a[2]||m.error(a[0]),a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);a[2]=b[1]+(b[2]||1)-0,a[3]=b[3]-0}else a[2]&&m.error(a[0]);a[0]=e++;return a},ATTR:function(a,b,c,d,e,f){var g=a[1]=a[1].replace(j,"");!f&&o.attrMap[g]&&(a[1]=o.attrMap[g]),a[4]=(a[4]||a[5]||"").replace(j,""),a[2]==="~="&&(a[4]=" "+a[4]+" ");return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not")if((a.exec(b[3])||"").length>1||/^\w/.test(b[3]))b[3]=m(b[3],null,null,c);else{var g=m.filter(b[3],c,d,!0^f);d||e.push.apply(e,g);return!1}else if(o.match.POS.test(b[0])||o.match.CHILD.test(b[0]))return!0;return b},POS:function(a){a.unshift(!0);return a}},filters:{enabled:function(a){return a.disabled===!1&&a.type!=="hidden"},disabled:function(a){return a.disabled===!0},checked:function(a){return a.checked===!0},selected:function(a){a.parentNode&&a.parentNode.selectedIndex;return a.selected===!0},parent:function(a){return!!a.firstChild},empty:function(a){return!a.firstChild},has:function(a,b,c){return!!m(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=o.filters[e];if(f)return f(a,c,b,d);if(e==="contains")return(a.textContent||a.innerText||n([a])||"").indexOf(b[3])>=0;if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++)if(g[h]===a)return!1;return!0}m.error(e)},CHILD:function(a,b){var c,e,f,g,h,i,j,k=b[1],l=a;switch(k){case"only":case"first":while(l=l.previousSibling)if(l.nodeType===1)return!1;if(k==="first")return!0;l=a;case"last":while(l=l.nextSibling)if(l.nodeType===1)return!1;return!0;case"nth":c=b[2],e=b[3];if(c===1&&e===0)return!0;f=b[0],g=a.parentNode;if(g&&(g[d]!==f||!a.nodeIndex)){i=0;for(l=g.firstChild;l;l=l.nextSibling)l.nodeType===1&&(l.nodeIndex=++i);g[d]=f}j=a.nodeIndex-e;return c===0?j===0:j%c===0&&j/c>=0}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||!!a.nodeName&&a.nodeName.toLowerCase()===b},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=m.attr?m.attr(a,c):o.attrHandle[c]?o.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];return d==null?f==="!=":!f&&m.attr?d!=null:f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:g?f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":!1:e&&d!==!1},POS:function(a,b,c,d){var e=b[2],f=o.setFilters[e];if(f)return f(a,c,b,d)}}},p=o.match.POS,q=function(a,b){return"\\"+(b-0+1)};for(var r in o.match)o.match[r]=new RegExp(o.match[r].source+/(?![^\[]*\])(?![^\(]*\))/.source),o.leftMatch[r]=new RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[r].source.replace(/\\(\d+)/g,q));var s=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b}return a};try{Array.prototype.slice.call(c.documentElement.childNodes,0)[0].nodeType}catch(t){s=function(a,b){var c=0,d=b||[];if(g.call(a)==="[object Array]")Array.prototype.push.apply(d,a);else if(typeof a.length=="number")for(var e=a.length;c<e;c++)d.push(a[c]);else for(;a[c];c++)d.push(a[c]);return d}}var u,v;c.documentElement.compareDocumentPosition?u=function(a,b){if(a===b){h=!0;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition)return a.compareDocumentPosition?-1:1;return a.compareDocumentPosition(b)&4?-1:1}:(u=function(a,b){if(a===b){h=!0;return 0}if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],f=[],g=a.parentNode,i=b.parentNode,j=g;if(g===i)return v(a,b);if(!g)return-1;if(!i)return 1;while(j)e.unshift(j),j=j.parentNode;j=i;while(j)f.unshift(j),j=j.parentNode;c=e.length,d=f.length;for(var k=0;k<c&&k<d;k++)if(e[k]!==f[k])return v(e[k],f[k]);return k===c?v(a,f[k],-1):v(e[k],b,1)},v=function(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}),function(){var a=c.createElement("div"),d="script"+(new Date).getTime(),e=c.documentElement;a.innerHTML="<a name='"+d+"'/>",e.insertBefore(a,e.firstChild),c.getElementById(d)&&(o.find.ID=function(a,c,d){if(typeof c.getElementById!="undefined"&&!d){var e=c.getElementById(a[1]);return e?e.id===a[1]||typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id").nodeValue===a[1]?[e]:b:[]}},o.filter.ID=function(a,b){var c=typeof a.getAttributeNode!="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b}),e.removeChild(a),e=a=null}(),function(){var a=c.createElement("div");a.appendChild(c.createComment("")),a.getElementsByTagName("*").length>0&&(o.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);if(a[1]==="*"){var d=[];for(var e=0;c[e];e++)c[e].nodeType===1&&d.push(c[e]);c=d}return c}),a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!="undefined"&&a.firstChild.getAttribute("href")!=="#"&&(o.attrHandle.href=function(a){return a.getAttribute("href",2)}),a=null}(),c.querySelectorAll&&function(){var a=m,b=c.createElement("div"),d="__sizzle__";b.innerHTML="<p class='TEST'></p>";if(!b.querySelectorAll||b.querySelectorAll(".TEST").length!==0){m=function(b,e,f,g){e=e||c;if(!g&&!m.isXML(e)){var h=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);if(h&&(e.nodeType===1||e.nodeType===9)){if(h[1])return s(e.getElementsByTagName(b),f);if(h[2]&&o.find.CLASS&&e.getElementsByClassName)return s(e.getElementsByClassName(h[2]),f)}if(e.nodeType===9){if(b==="body"&&e.body)return s([e.body],f);if(h&&h[3]){var i=e.getElementById(h[3]);if(!i||!i.parentNode)return s([],f);if(i.id===h[3])return s([i],f)}try{return s(e.querySelectorAll(b),f)}catch(j){}}else if(e.nodeType===1&&e.nodeName.toLowerCase()!=="object"){var k=e,l=e.getAttribute("id"),n=l||d,p=e.parentNode,q=/^\s*[+~]/.test(b);l?n=n.replace(/'/g,"\\$&"):e.setAttribute("id",n),q&&p&&(e=e.parentNode);try{if(!q||p)return s(e.querySelectorAll("[id='"+n+"'] "+b),f)}catch(r){}finally{l||k.removeAttribute("id")}}}return a(b,e,f,g)};for(var e in a)m[e]=a[e];b=null}}(),function(){var a=c.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;if(b){var d=!b.call(c.createElement("div"),"div"),e=!1;try{b.call(c.documentElement,"[test!='']:sizzle")}catch(f){e=!0}m.matchesSelector=function(a,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!m.isXML(a))try{if(e||!o.match.PSEUDO.test(c)&&!/!=/.test(c)){var f=b.call(a,c);if(f||!d||a.document&&a.document.nodeType!==11)return f}}catch(g){}return m(c,null,null,[a]).length>0}}}(),function(){var a=c.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";if(!!a.getElementsByClassName&&a.getElementsByClassName("e").length!==0){a.lastChild.className="e";if(a.getElementsByClassName("e").length===1)return;o.order.splice(1,0,"CLASS"),o.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!="undefined"&&!c)return b.getElementsByClassName(a[1])},a=null}}(),c.documentElement.contains?m.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):!0)}:c.documentElement.compareDocumentPosition?m.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)}:m.contains=function(){return!1},m.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1};var y=function(a,b,c){var d,e=[],f="",g=b.nodeType?[b]:b;while(d=o.match.PSEUDO.exec(a))f+=d[0],a=a.replace(o.match.PSEUDO,"");a=o.relative[a]?a+"*":a;for(var h=0,i=g.length;h<i;h++)m(a,g[h],e,c);return m.filter(f,e)};m.attr=f.attr,m.selectors.attrMap={},f.find=m,f.expr=m.selectors,f.expr[":"]=f.expr.filters,f.unique=m.uniqueSort,f.text=m.getText,f.isXMLDoc=m.isXML,f.contains=m.contains}();var L=/Until$/,M=/^(?:parents|prevUntil|prevAll)/,N=/,/,O=/^.[^:#\[\.,]*$/,P=Array.prototype.slice,Q=f.expr.match.POS,R={children:!0,contents:!0,next:!0,prev:!0};f.fn.extend({find:function(a){var b=this,c,d;if(typeof a!="string")return f(a).filter(function(){for(c=0,d=b.length;c<d;c++)if(f.contains(b[c],this))return!0});var e=this.pushStack("","find",a),g,h,i;for(c=0,d=this.length;c<d;c++){g=e.length,f.find(a,this[c],e);if(c>0)for(h=g;h<e.length;h++)for(i=0;i<g;i++)if(e[i]===e[h]){e.splice(h--,1);break}}return e},has:function(a){var b=f(a);return this.filter(function(){for(var a=0,c=b.length;a<c;a++)if(f.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(T(this,a,!1),"not",a)},filter:function(a){return this.pushStack(T(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?Q.test(a)?f(a,this.context).index(this[0])>=0:f.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c=[],d,e,g=this[0];if(f.isArray(a)){var h=1;while(g&&g.ownerDocument&&g!==b){for(d=0;d<a.length;d++)f(g).is(a[d])&&c.push({selector:a[d],elem:g,level:h});g=g.parentNode,h++}return c}var i=Q.test(a)||typeof a!="string"?f(a,b||this.context):0;for(d=0,e=this.length;d<e;d++){g=this[d];while(g){if(i?i.index(g)>-1:f.find.matchesSelector(g,a)){c.push(g);break}g=g.parentNode;if(!g||!g.ownerDocument||g===b||g.nodeType===11)break}}c=c.length>1?f.unique(c):c;return this.pushStack(c,"closest",a)},index:function(a){if(!a)return this[0]&&this[0].parentNode?this.prevAll().length:-1;if(typeof a=="string")return f.inArray(this[0],f(a));return f.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var c=typeof a=="string"?f(a,b):f.makeArray(a&&a.nodeType?[a]:a),d=f.merge(this.get(),c);return this.pushStack(S(c[0])||S(d[0])?d:f.unique(d))},andSelf:function(){return this.add(this.prevObject)}}),f.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return f.dir(a,"parentNode")},parentsUntil:function(a,b,c){return f.dir(a,"parentNode",c)},next:function(a){return f.nth(a,2,"nextSibling")},prev:function(a){return f.nth(a,2,"previousSibling")},nextAll:function(a){return f.dir(a,"nextSibling")},prevAll:function(a){return f.dir(a,"previousSibling")},nextUntil:function(a,b,c){return f.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return f.dir(a,"previousSibling",c)},siblings:function(a){return f.sibling(a.parentNode.firstChild,a)},children:function(a){return f.sibling(a.firstChild)},contents:function(a){return f.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:f.makeArray(a.childNodes)}},function(a,b){f.fn[a]=function(c,d){var e=f.map(this,b,c);L.test(a)||(d=c),d&&typeof d=="string"&&(e=f.filter(d,e)),e=this.length>1&&!R[a]?f.unique(e):e,(this.length>1||N.test(d))&&M.test(a)&&(e=e.reverse());return this.pushStack(e,a,P.call(arguments).join(","))}}),f.extend({filter:function(a,b,c){c&&(a=":not("+a+")");return b.length===1?f.find.matchesSelector(b[0],a)?[b[0]]:[]:f.find.matches(a,b)},dir:function(a,c,d){var e=[],g=a[c];while(g&&g.nodeType!==9&&(d===b||g.nodeType!==1||!f(g).is(d)))g.nodeType===1&&e.push(g),g=g[c];return e},nth:function(a,b,c,d){b=b||1;var e=0;for(;a;a=a[c])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var V="abbr|article|aside|audio|canvas|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",W=/ jQuery\d+="(?:\d+|null)"/g,X=/^\s+/,Y=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,Z=/<([\w:]+)/,$=/<tbody/i,_=/<|&#?\w+;/,ba=/<(?:script|style)/i,bb=/<(?:script|object|embed|option|style)/i,bc=new RegExp("<(?:"+V+")","i"),bd=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/\/(java|ecma)script/i,bf=/^\s*<!(?:\[CDATA\[|\-\-)/,bg={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bh=U(c);bg.optgroup=bg.option,bg.tbody=bg.tfoot=bg.colgroup=bg.caption=bg.thead,bg.th=bg.td,f.support.htmlSerialize||(bg._default=[1,"div<div>","</div>"]),f.fn.extend({text:function(a){if(f.isFunction(a))return this.each(function(b){var c=f(this);c.text(a.call(this,b,c.text()))});if(typeof a!="object"&&a!==b)return this.empty().append((this[0]&&this[0].ownerDocument||c).createTextNode(a));return f.text(this)},wrapAll:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapAll(a.call(this,b))});if(this[0]){var b=f(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapInner(a.call(this,b))});return this.each(function(){var b=f(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=f.isFunction(a);return this.each(function(c){f(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){f.nodeName(this,"body")||f(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=f.clean(arguments);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,f.clean(arguments));return a}},remove:function(a,b){for(var c=0,d;(d=this[c])!=null;c++)if(!a||f.filter(a,[d]).length)!b&&d.nodeType===1&&(f.cleanData(d.getElementsByTagName("*")),f.cleanData([d])),d.parentNode&&d.parentNode.removeChild(d);return this},empty:function()
{for(var a=0,b;(b=this[a])!=null;a++){b.nodeType===1&&f.cleanData(b.getElementsByTagName("*"));while(b.firstChild)b.removeChild(b.firstChild)}return this},clone:function(a,b){a=a==null?!1:a,b=b==null?a:b;return this.map(function(){return f.clone(this,a,b)})},html:function(a){if(a===b)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(W,""):null;if(typeof a=="string"&&!ba.test(a)&&(f.support.leadingWhitespace||!X.test(a))&&!bg[(Z.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Y,"<$1></$2>");try{for(var c=0,d=this.length;c<d;c++)this[c].nodeType===1&&(f.cleanData(this[c].getElementsByTagName("*")),this[c].innerHTML=a)}catch(e){this.empty().append(a)}}else f.isFunction(a)?this.each(function(b){var c=f(this);c.html(a.call(this,b,c.html()))}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(f.isFunction(a))return this.each(function(b){var c=f(this),d=c.html();c.replaceWith(a.call(this,b,d))});typeof a!="string"&&(a=f(a).detach());return this.each(function(){var b=this.nextSibling,c=this.parentNode;f(this).remove(),b?f(b).before(a):f(c).append(a)})}return this.length?this.pushStack(f(f.isFunction(a)?a():a),"replaceWith",a):this},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){var e,g,h,i,j=a[0],k=[];if(!f.support.checkClone&&arguments.length===3&&typeof j=="string"&&bd.test(j))return this.each(function(){f(this).domManip(a,c,d,!0)});if(f.isFunction(j))return this.each(function(e){var g=f(this);a[0]=j.call(this,e,c?g.html():b),g.domManip(a,c,d)});if(this[0]){i=j&&j.parentNode,f.support.parentNode&&i&&i.nodeType===11&&i.childNodes.length===this.length?e={fragment:i}:e=f.buildFragment(a,this,k),h=e.fragment,h.childNodes.length===1?g=h=h.firstChild:g=h.firstChild;if(g){c=c&&f.nodeName(g,"tr");for(var l=0,m=this.length,n=m-1;l<m;l++)d.call(c?bi(this[l],g):this[l],e.cacheable||m>1&&l<n?f.clone(h,!0,!0):h)}k.length&&f.each(k,bp)}return this}}),f.buildFragment=function(a,b,d){var e,g,h,i,j=a[0];b&&b[0]&&(i=b[0].ownerDocument||b[0]),i.createDocumentFragment||(i=c),a.length===1&&typeof j=="string"&&j.length<512&&i===c&&j.charAt(0)==="<"&&!bb.test(j)&&(f.support.checkClone||!bd.test(j))&&(f.support.html5Clone||!bc.test(j))&&(g=!0,h=f.fragments[j],h&&h!==1&&(e=h)),e||(e=i.createDocumentFragment(),f.clean(a,i,e,d)),g&&(f.fragments[j]=h?e:1);return{fragment:e,cacheable:g}},f.fragments={},f.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){f.fn[a]=function(c){var d=[],e=f(c),g=this.length===1&&this[0].parentNode;if(g&&g.nodeType===11&&g.childNodes.length===1&&e.length===1){e[b](this[0]);return this}for(var h=0,i=e.length;h<i;h++){var j=(h>0?this.clone(!0):this).get();f(e[h])[b](j),d=d.concat(j)}return this.pushStack(d,a,e.selector)}}),f.extend({clone:function(a,b,c){var d,e,g,h=f.support.html5Clone||!bc.test("<"+a.nodeName)?a.cloneNode(!0):bo(a);if((!f.support.noCloneEvent||!f.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!f.isXMLDoc(a)){bk(a,h),d=bl(a),e=bl(h);for(g=0;d[g];++g)e[g]&&bk(d[g],e[g])}if(b){bj(a,h);if(c){d=bl(a),e=bl(h);for(g=0;d[g];++g)bj(d[g],e[g])}}d=e=null;return h},clean:function(a,b,d,e){var g;b=b||c,typeof b.createElement=="undefined"&&(b=b.ownerDocument||b[0]&&b[0].ownerDocument||c);var h=[],i;for(var j=0,k;(k=a[j])!=null;j++){typeof k=="number"&&(k+="");if(!k)continue;if(typeof k=="string")if(!_.test(k))k=b.createTextNode(k);else{k=k.replace(Y,"<$1></$2>");var l=(Z.exec(k)||["",""])[1].toLowerCase(),m=bg[l]||bg._default,n=m[0],o=b.createElement("div");b===c?bh.appendChild(o):U(b).appendChild(o),o.innerHTML=m[1]+k+m[2];while(n--)o=o.lastChild;if(!f.support.tbody){var p=$.test(k),q=l==="table"&&!p?o.firstChild&&o.firstChild.childNodes:m[1]==="<table>"&&!p?o.childNodes:[];for(i=q.length-1;i>=0;--i)f.nodeName(q[i],"tbody")&&!q[i].childNodes.length&&q[i].parentNode.removeChild(q[i])}!f.support.leadingWhitespace&&X.test(k)&&o.insertBefore(b.createTextNode(X.exec(k)[0]),o.firstChild),k=o.childNodes}var r;if(!f.support.appendChecked)if(k[0]&&typeof (r=k.length)=="number")for(i=0;i<r;i++)bn(k[i]);else bn(k);k.nodeType?h.push(k):h=f.merge(h,k)}if(d){g=function(a){return!a.type||be.test(a.type)};for(j=0;h[j];j++)if(e&&f.nodeName(h[j],"script")&&(!h[j].type||h[j].type.toLowerCase()==="text/javascript"))e.push(h[j].parentNode?h[j].parentNode.removeChild(h[j]):h[j]);else{if(h[j].nodeType===1){var s=f.grep(h[j].getElementsByTagName("script"),g);h.splice.apply(h,[j+1,0].concat(s))}d.appendChild(h[j])}}return h},cleanData:function(a){var b,c,d=f.cache,e=f.event.special,g=f.support.deleteExpando;for(var h=0,i;(i=a[h])!=null;h++){if(i.nodeName&&f.noData[i.nodeName.toLowerCase()])continue;c=i[f.expando];if(c){b=d[c];if(b&&b.events){for(var j in b.events)e[j]?f.event.remove(i,j):f.removeEvent(i,j,b.handle);b.handle&&(b.handle.elem=null)}g?delete i[f.expando]:i.removeAttribute&&i.removeAttribute(f.expando),delete d[c]}}}});var bq=/alpha\([^)]*\)/i,br=/opacity=([^)]*)/,bs=/([A-Z]|^ms)/g,bt=/^-?\d+(?:px)?$/i,bu=/^-?\d/,bv=/^([\-+])=([\-+.\de]+)/,bw={position:"absolute",visibility:"hidden",display:"block"},bx=["Left","Right"],by=["Top","Bottom"],bz,bA,bB;f.fn.css=function(a,c){if(arguments.length===2&&c===b)return this;return f.access(this,a,c,!0,function(a,c,d){return d!==b?f.style(a,c,d):f.css(a,c)})},f.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=bz(a,"opacity","opacity");return c===""?"1":c}return a.style.opacity}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":f.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!!a&&a.nodeType!==3&&a.nodeType!==8&&!!a.style){var g,h,i=f.camelCase(c),j=a.style,k=f.cssHooks[i];c=f.cssProps[i]||i;if(d===b){if(k&&"get"in k&&(g=k.get(a,!1,e))!==b)return g;return j[c]}h=typeof d,h==="string"&&(g=bv.exec(d))&&(d=+(g[1]+1)*+g[2]+parseFloat(f.css(a,c)),h="number");if(d==null||h==="number"&&isNaN(d))return;h==="number"&&!f.cssNumber[i]&&(d+="px");if(!k||!("set"in k)||(d=k.set(a,d))!==b)try{j[c]=d}catch(l){}}},css:function(a,c,d){var e,g;c=f.camelCase(c),g=f.cssHooks[c],c=f.cssProps[c]||c,c==="cssFloat"&&(c="float");if(g&&"get"in g&&(e=g.get(a,!0,d))!==b)return e;if(bz)return bz(a,c)},swap:function(a,b,c){var d={};for(var e in b)d[e]=a.style[e],a.style[e]=b[e];c.call(a);for(e in b)a.style[e]=d[e]}}),f.curCSS=f.css,f.each(["height","width"],function(a,b){f.cssHooks[b]={get:function(a,c,d){var e;if(c){if(a.offsetWidth!==0)return bC(a,b,d);f.swap(a,bw,function(){e=bC(a,b,d)});return e}},set:function(a,b){if(!bt.test(b))return b;b=parseFloat(b);if(b>=0)return b+"px"}}}),f.support.opacity||(f.cssHooks.opacity={get:function(a,b){return br.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=f.isNumeric(b)?"alpha(opacity="+b*100+")":"",g=d&&d.filter||c.filter||"";c.zoom=1;if(b>=1&&f.trim(g.replace(bq,""))===""){c.removeAttribute("filter");if(d&&!d.filter)return}c.filter=bq.test(g)?g.replace(bq,e):g+" "+e}}),f(function(){f.support.reliableMarginRight||(f.cssHooks.marginRight={get:function(a,b){var c;f.swap(a,{display:"inline-block"},function(){b?c=bz(a,"margin-right","marginRight"):c=a.style.marginRight});return c}})}),c.defaultView&&c.defaultView.getComputedStyle&&(bA=function(a,b){var c,d,e;b=b.replace(bs,"-$1").toLowerCase(),(d=a.ownerDocument.defaultView)&&(e=d.getComputedStyle(a,null))&&(c=e.getPropertyValue(b),c===""&&!f.contains(a.ownerDocument.documentElement,a)&&(c=f.style(a,b)));return c}),c.documentElement.currentStyle&&(bB=function(a,b){var c,d,e,f=a.currentStyle&&a.currentStyle[b],g=a.style;f===null&&g&&(e=g[b])&&(f=e),!bt.test(f)&&bu.test(f)&&(c=g.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),g.left=b==="fontSize"?"1em":f||0,f=g.pixelLeft+"px",g.left=c,d&&(a.runtimeStyle.left=d));return f===""?"auto":f}),bz=bA||bB,f.expr&&f.expr.filters&&(f.expr.filters.hidden=function(a){var b=a.offsetWidth,c=a.offsetHeight;return b===0&&c===0||!f.support.reliableHiddenOffsets&&(a.style&&a.style.display||f.css(a,"display"))==="none"},f.expr.filters.visible=function(a){return!f.expr.filters.hidden(a)});var bD=/%20/g,bE=/\[\]$/,bF=/\r?\n/g,bG=/#.*$/,bH=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,bI=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,bJ=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,bK=/^(?:GET|HEAD)$/,bL=/^\/\//,bM=/\?/,bN=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bO=/^(?:select|textarea)/i,bP=/\s+/,bQ=/([?&])_=[^&]*/,bR=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,bS=f.fn.load,bT={},bU={},bV,bW,bX=["*/"]+["*"];try{bV=e.href}catch(bY){bV=c.createElement("a"),bV.href="",bV=bV.href}bW=bR.exec(bV.toLowerCase())||[],f.fn.extend({load:function(a,c,d){if(typeof a!="string"&&bS)return bS.apply(this,arguments);if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var g=a.slice(e,a.length);a=a.slice(0,e)}var h="GET";c&&(f.isFunction(c)?(d=c,c=b):typeof c=="object"&&(c=f.param(c,f.ajaxSettings.traditional),h="POST"));var i=this;f.ajax({url:a,type:h,dataType:"html",data:c,complete:function(a,b,c){c=a.responseText,a.isResolved()&&(a.done(function(a){c=a}),i.html(g?f("<div>").append(c.replace(bN,"")).find(g):c)),d&&i.each(d,[c,b,a])}});return this},serialize:function(){return f.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?f.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||bO.test(this.nodeName)||bI.test(this.type))}).map(function(a,b){var c=f(this).val();return c==null?null:f.isArray(c)?f.map(c,function(a,c){return{name:b.name,value:a.replace(bF,"\r\n")}}):{name:b.name,value:c.replace(bF,"\r\n")}}).get()}}),f.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){f.fn[b]=function(a){return this.on(b,a)}}),f.each(["get","post"],function(a,c){f[c]=function(a,d,e,g){f.isFunction(d)&&(g=g||e,e=d,d=b);return f.ajax({type:c,url:a,data:d,success:e,dataType:g})}}),f.extend({getScript:function(a,c){return f.get(a,b,c,"script")},getJSON:function(a,b,c){return f.get(a,b,c,"json")},ajaxSetup:function(a,b){b?b_(a,f.ajaxSettings):(b=a,a=f.ajaxSettings),b_(a,b);return a},ajaxSettings:{url:bV,isLocal:bJ.test(bW[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":bX},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":f.parseJSON,"text xml":f.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:bZ(bT),ajaxTransport:bZ(bU),ajax:function(a,c){function w(a,c,l,m){if(s!==2){s=2,q&&clearTimeout(q),p=b,n=m||"",v.readyState=a>0?4:0;var o,r,u,w=c,x=l?cb(d,v,l):b,y,z;if(a>=200&&a<300||a===304){if(d.ifModified){if(y=v.getResponseHeader("Last-Modified"))f.lastModified[k]=y;if(z=v.getResponseHeader("Etag"))f.etag[k]=z}if(a===304)w="notmodified",o=!0;else try{r=cc(d,x),w="success",o=!0}catch(A){w="parsererror",u=A}}else{u=w;if(!w||a)w="error",a<0&&(a=0)}v.status=a,v.statusText=""+(c||w),o?h.resolveWith(e,[r,w,v]):h.rejectWith(e,[v,w,u]),v.statusCode(j),j=b,t&&g.trigger("ajax"+(o?"Success":"Error"),[v,d,o?r:u]),i.fireWith(e,[v,w]),t&&(g.trigger("ajaxComplete",[v,d]),--f.active||f.event.trigger("ajaxStop"))}}typeof a=="object"&&(c=a,a=b),c=c||{};var d=f.ajaxSetup({},c),e=d.context||d,g=e!==d&&(e.nodeType||e instanceof f)?f(e):f.event,h=f.Deferred(),i=f.Callbacks("once memory"),j=d.statusCode||{},k,l={},m={},n,o,p,q,r,s=0,t,u,v={readyState:0,setRequestHeader:function(a,b){if(!s){var c=a.toLowerCase();a=m[c]=m[c]||a,l[a]=b}return this},getAllResponseHeaders:function(){return s===2?n:null},getResponseHeader:function(a){var c;if(s===2){if(!o){o={};while(c=bH.exec(n))o[c[1].toLowerCase()]=c[2]}c=o[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){s||(d.mimeType=a);return this},abort:function(a){a=a||"abort",p&&p.abort(a),w(0,a);return this}};h.promise(v),v.success=v.done,v.error=v.fail,v.complete=i.add,v.statusCode=function(a){if(a){var b;if(s<2)for(b in a)j[b]=[j[b],a[b]];else b=a[v.status],v.then(b,b)}return this},d.url=((a||d.url)+"").replace(bG,"").replace(bL,bW[1]+"//"),d.dataTypes=f.trim(d.dataType||"*").toLowerCase().split(bP),d.crossDomain==null&&(r=bR.exec(d.url.toLowerCase()),d.crossDomain=!(!r||r[1]==bW[1]&&r[2]==bW[2]&&(r[3]||(r[1]==="http:"?80:443))==(bW[3]||(bW[1]==="http:"?80:443)))),d.data&&d.processData&&typeof d.data!="string"&&(d.data=f.param(d.data,d.traditional)),b$(bT,d,c,v);if(s===2)return!1;t=d.global,d.type=d.type.toUpperCase(),d.hasContent=!bK.test(d.type),t&&f.active++===0&&f.event.trigger("ajaxStart");if(!d.hasContent){d.data&&(d.url+=(bM.test(d.url)?"&":"?")+d.data,delete d.data),k=d.url;if(d.cache===!1){var x=f.now(),y=d.url.replace(bQ,"$1_="+x);d.url=y+(y===d.url?(bM.test(d.url)?"&":"?")+"_="+x:"")}}(d.data&&d.hasContent&&d.contentType!==!1||c.contentType)&&v.setRequestHeader("Content-Type",d.contentType),d.ifModified&&(k=k||d.url,f.lastModified[k]&&v.setRequestHeader("If-Modified-Since",f.lastModified[k]),f.etag[k]&&v.setRequestHeader("If-None-Match",f.etag[k])),v.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+(d.dataTypes[0]!=="*"?", "+bX+"; q=0.01":""):d.accepts["*"]);for(u in d.headers)v.setRequestHeader(u,d.headers[u]);if(d.beforeSend&&(d.beforeSend.call(e,v,d)===!1||s===2)){v.abort();return!1}for(u in{success:1,error:1,complete:1})v[u](d[u]);p=b$(bU,d,c,v);if(!p)w(-1,"No Transport");else{v.readyState=1,t&&g.trigger("ajaxSend",[v,d]),d.async&&d.timeout>0&&(q=setTimeout(function(){v.abort("timeout")},d.timeout));try{s=1,p.send(l,w)}catch(z){if(s<2)w(-1,z);else throw z}}return v},param:function(a,c){var d=[],e=function(a,b){b=f.isFunction(b)?b():b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=f.ajaxSettings.traditional);if(f.isArray(a)||a.jquery&&!f.isPlainObject(a))f.each(a,function(){e(this.name,this.value)});else for(var g in a)ca(g,a[g],c,e);return d.join("&").replace(bD,"+")}}),f.extend({active:0,lastModified:{},etag:{}});var cd=f.now(),ce=/(\=)\?(&|$)|\?\?/i;f.ajaxSetup({jsonp:"callback",jsonpCallback:function(){return f.expando+"_"+cd++}}),f.ajaxPrefilter("json jsonp",function(b,c,d){var e=b.contentType==="application/x-www-form-urlencoded"&&typeof b.data=="string";if(b.dataTypes[0]==="jsonp"||b.jsonp!==!1&&(ce.test(b.url)||e&&ce.test(b.data))){var g,h=b.jsonpCallback=f.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,i=a[h],j=b.url,k=b.data,l="$1"+h+"$2";b.jsonp!==!1&&(j=j.replace(ce,l),b.url===j&&(e&&(k=k.replace(ce,l)),b.data===k&&(j+=(/\?/.test(j)?"&":"?")+b.jsonp+"="+h))),b.url=j,b.data=k,a[h]=function(a){g=[a]},d.always(function(){a[h]=i,g&&f.isFunction(i)&&a[h](g[0])}),b.converters["script json"]=function(){g||f.error(h+" was not called");return g[0]},b.dataTypes[0]="json";return"script"}}),f.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){f.globalEval(a);return a}}}),f.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),f.ajaxTransport("script",function(a){if(a.crossDomain){var d,e=c.head||c.getElementsByTagName("head")[0]||c.documentElement;return{send:function(f,g){d=c.createElement("script"),d.async="async",a.scriptCharset&&(d.charset=a.scriptCharset),d.src=a.url,d.onload=d.onreadystatechange=function(a,c){if(c||!d.readyState||/loaded|complete/.test(d.readyState))d.onload=d.onreadystatechange=null,e&&d.parentNode&&e.removeChild(d),d=b,c||g(200,"success")},e.insertBefore(d,e.firstChild)},abort:function(){d&&d.onload(0,1)}}}});var cf=a.ActiveXObject?function(){for(var a in ch)ch[a](0,1)}:!1,cg=0,ch;f.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&ci()||cj()}:ci,function(a){f.extend(f.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(f.ajaxSettings.xhr()),f.support.ajax&&f.ajaxTransport(function(c){if(!c.crossDomain||f.support.cors){var d;return{send:function(e,g){var h=c.xhr(),i,j;c.username?h.open(c.type,c.url,c.async,c.username,c.password):h.open(c.type,c.url,c.async);if(c.xhrFields)for(j in c.xhrFields)h[j]=c.xhrFields[j];c.mimeType&&h.overrideMimeType&&h.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(j in e)h.setRequestHeader(j,e[j])}catch(k){}h.send(c.hasContent&&c.data||null),d=function(a,e){var j,k,l,m,n;try{if(d&&(e||h.readyState===4)){d=b,i&&(h.onreadystatechange=f.noop,cf&&delete ch[i]);if(e)h.readyState!==4&&h.abort();else{j=h.status,l=h.getAllResponseHeaders(),m={},n=h.responseXML,n&&n.documentElement&&(m.xml=n),m.text=h.responseText;try{k=h.statusText}catch(o){k=""}!j&&c.isLocal&&!c.crossDomain?j=m.text?200:404:j===1223&&(j=204)}}}catch(p){e||g(-1,p)}m&&g(j,k,m,l)},!c.async||h.readyState===4?d():(i=++cg,cf&&(ch||(ch={},f(a).unload(cf)),ch[i]=d),h.onreadystatechange=d)},abort:function(){d&&d(0,1)}}}});var ck={},cl,cm,cn=/^(?:toggle|show|hide)$/,co=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,cp,cq=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]],cr;f.fn.extend({show:function(a,b,c){var d,e;if(a||a===0)return this.animate(cu("show",3),a,b,c);for(var g=0,h=this.length;g<h;g++)d=this[g],d.style&&(e=d.style.display,!f._data(d,"olddisplay")&&e==="none"&&(e=d.style.display=""),e===""&&f.css(d,"display")==="none"&&f._data(d,"olddisplay",cv(d.nodeName)));for(g=0;g<h;g++){d=this[g];if(d.style){e=d.style.display;if(e===""||e==="none")d.style.display=f._data(d,"olddisplay")||""}}return this},hide:function(a,b,c){if(a||a===0)return this.animate(cu("hide",3),a,b,c);var d,e,g=0,h=this.length;for(;g<h;g++)d=this[g],d.style&&(e=f.css(d,"display"),e!=="none"&&!f._data(d,"olddisplay")&&f._data(d,"olddisplay",e));for(g=0;g<h;g++)this[g].style&&(this[g].style.display="none");return this},_toggle:f.fn.toggle,toggle:function(a,b,c){var d=typeof a=="boolean";f.isFunction(a)&&f.isFunction(b)?this._toggle.apply(this,arguments):a==null||d?this.each(function(){var b=d?a:f(this).is(":hidden");f(this)[b?"show":"hide"]()}):this.animate(cu("toggle",3),a,b,c);return this},fadeTo:function(a,b,c,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){function g(){e.queue===!1&&f._mark(this);var b=f.extend({},e),c=this.nodeType===1,d=c&&f(this).is(":hidden"),g,h,i,j,k,l,m,n,o;b.animatedProperties={};for(i in a){g=f.camelCase(i),i!==g&&(a[g]=a[i],delete a[i]),h=a[g],f.isArray(h)?(b.animatedProperties[g]=h[1],h=a[g]=h[0]):b.animatedProperties[g]=b.specialEasing&&b.specialEasing[g]||b.easing||"swing";if(h==="hide"&&d||h==="show"&&!d)return b.complete.call(this);c&&(g==="height"||g==="width")&&(b.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY],f.css(this,"display")==="inline"&&f.css(this,"float")==="none"&&(!f.support.inlineBlockNeedsLayout||cv(this.nodeName)==="inline"?this.style.display="inline-block":this.style.zoom=1))}b.overflow!=null&&(this.style.overflow="hidden");for(i in a)j=new f.fx(this,b,i),h=a[i],cn.test(h)?(o=f._data(this,"toggle"+i)||(h==="toggle"?d?"show":"hide":0),o?(f._data(this,"toggle"+i,o==="show"?"hide":"show"),j[o]()):j[h]()):(k=co.exec(h),l=j.cur(),k?(m=parseFloat(k[2]),n=k[3]||(f.cssNumber[i]?"":"px"),n!=="px"&&(f.style(this,i,(m||1)+n),l=(m||1)/j.cur()*l,f.style(this,i,l+n)),k[1]&&(m=(k[1]==="-="?-1:1)*m+l),j.custom(l,m,n)):j.custom(l,h,""));return!0}var e=f.speed(b,c,d);if(f.isEmptyObject(a))return this.each(e.complete,[!1]);a=f.extend({},a);return e.queue===!1?this.each(g):this.queue(e.queue,g)},stop:function(a,c,d){typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]);return this.each(function(){function h(a,b,c){var e=b[c];f.removeData(a,c,!0),e.stop(d)}var b,c=!1,e=f.timers,g=f._data(this);d||f._unmark(!0,this);if(a==null)for(b in g)g[b]&&g[b].stop&&b.indexOf(".run")===b.length-4&&h(this,g,b);else g[b=a+".run"]&&g[b].stop&&h(this,g,b);for(b=e.length;b--;)e[b].elem===this&&(a==null||e[b].queue===a)&&(d?e[b](!0):e[b].saveState(),c=!0,e.splice(b,1));(!d||!c)&&f.dequeue(this,a)})}}),f.each({slideDown:cu("show",1),slideUp:cu("hide",1),slideToggle:cu("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){f.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),f.extend({speed:function(a,b,c){var d=a&&typeof a=="object"?f.extend({},a):{complete:c||!c&&b||f.isFunction(a)&&a,duration:a,easing:c&&b||b&&!f.isFunction(b)&&b};d.duration=f.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in f.fx.speeds?f.fx.speeds[d.duration]:f.fx.speeds._default;if(d.queue==null||d.queue===!0)d.queue="fx";d.old=d.complete,d.complete=function(a){f.isFunction(d.old)&&d.old.call(this),d.queue?f.dequeue(this,d.queue):a!==!1&&f._unmark(this)};return d},easing:{linear:function(a,b,c,d){return c+d*a},swing:function(a,b,c,d){return(-Math.cos(a*Math.PI)/2+.5)*d+c}},timers:[],fx:function(a,b,c){this.options=b,this.elem=a,this.prop=c,b.orig=b.orig||{}}}),f.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this),(f.fx.step[this.prop]||f.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a,b=f.css(this.elem,this.prop);return isNaN(a=parseFloat(b))?!b||b==="auto"?0:b:a},custom:function(a,c,d){function h(a){return e.step(a)}var e=this,g=f.fx;this.startTime=cr||cs(),this.end=c,this.now=this.start=a,this.pos=this.state=0,this.unit=d||this.unit||(f.cssNumber[this.prop]?"":"px"),h.queue=this.options.queue,h.elem=this.elem,h.saveState=function(){e.options.hide&&f._data(e.elem,"fxshow"+e.prop)===b&&f._data(e.elem,"fxshow"+e.prop,e.start)},h()&&f.timers.push(h)&&!cp&&(cp=setInterval(g.tick,g.interval))},show:function(){var a=f._data(this.elem,"fxshow"+this.prop);this.options.orig[this.prop]=a||f.style(this.elem,this.prop),this.options.show=!0,a!==b?this.custom(this.cur(),a):this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur()),f(this.elem).show()},hide:function(){this.options.orig[this.prop]=f._data(this.elem,"fxshow"+this.prop)||f.style(this.elem,this.prop),this.options.hide=!0,this.custom(this.cur(),0)},step:function(a){var b,c,d,e=cr||cs(),g=!0,h=this.elem,i=this.options;if(a||e>=i.duration+this.startTime){this.now=this.end,this.pos=this.state=1,this.update(),i.animatedProperties[this.prop]=!0;for(b in i.animatedProperties)i.animatedProperties[b]!==!0&&(g=!1);if(g){i.overflow!=null&&!f.support.shrinkWrapBlocks&&f.each(["","X","Y"],function(a,b){h.style["overflow"+b]=i.overflow[a]}),i.hide&&f(h).hide();if(i.hide||i.show)for(b in i.animatedProperties)f.style(h,b,i.orig[b]),f.removeData(h,"fxshow"+b,!0),f.removeData(h,"toggle"+b,!0);d=i.complete,d&&(i.complete=!1,d.call(h))}return!1}i.duration==Infinity?this.now=e:(c=e-this.startTime,this.state=c/i.duration,this.pos=f.easing[i.animatedProperties[this.prop]](this.state,c,0,1,i.duration),this.now=this.start+(this.end-this.start)*this.pos),this.update();return!0}},f.extend(f.fx,{tick:function(){var a,b=f.timers,c=0;for(;c<b.length;c++)a=b[c],!a()&&b[c]===a&&b.splice(c--,1);b.length||f.fx.stop()},interval:13,stop:function(){clearInterval(cp),cp=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){f.style(a.elem,"opacity",a.now)},_default:function(a){a.elem.style&&a.elem.style[a.prop]!=null?a.elem.style[a.prop]=a.now+a.unit:a.elem[a.prop]=a.now}}}),f.each(["width","height"],function(a,b){f.fx.step[b]=function(a){f.style(a.elem,b,Math.max(0,a.now)+a.unit)}}),f.expr&&f.expr.filters&&(f.expr.filters.animated=function(a){return f.grep(f.timers,function(b){return a===b.elem}).length});var cw=/^t(?:able|d|h)$/i,cx=/^(?:body|html)$/i;"getBoundingClientRect"in c.documentElement?f.fn.offset=function(a){var b=this[0],c;if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);try{c=b.getBoundingClientRect()}catch(d){}var e=b.ownerDocument,g=e.documentElement;if(!c||!f.contains(g,b))return c?{top:c.top,left:c.left}:{top:0,left:0};var h=e.body,i=cy(e),j=g.clientTop||h.clientTop||0,k=g.clientLeft||h.clientLeft||0,l=i.pageYOffset||f.support.boxModel&&g.scrollTop||h.scrollTop,m=i.pageXOffset||f.support.boxModel&&g.scrollLeft||h.scrollLeft,n=c.top+l-j,o=c.left+m-k;return{top:n,left:o}}:f.fn.offset=function(a){var b=this[0];if(a)return this.each(function(b){f.offset.setOffset(this,a,b)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return f.offset.bodyOffset(b);var c,d=b.offsetParent,e=b,g=b.ownerDocument,h=g.documentElement,i=g.body,j=g.defaultView,k=j?j.getComputedStyle(b,null):b.currentStyle,l=b.offsetTop,m=b.offsetLeft;while((b=b.parentNode)&&b!==i&&b!==h){if(f.support.fixedPosition&&k.position==="fixed")break;c=j?j.getComputedStyle(b,null):b.currentStyle,l-=b.scrollTop,m-=b.scrollLeft,b===d&&(l+=b.offsetTop,m+=b.offsetLeft,f.support.doesNotAddBorder&&(!f.support.doesAddBorderForTableAndCells||!cw.test(b.nodeName))&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),e=d,d=b.offsetParent),f.support.subtractsBorderForOverflowNotVisible&&c.overflow!=="visible"&&(l+=parseFloat(c.borderTopWidth)||0,m+=parseFloat(c.borderLeftWidth)||0),k=c}if(k.position==="relative"||k.position==="static")l+=i.offsetTop,m+=i.offsetLeft;f.support.fixedPosition&&k.position==="fixed"&&(l+=Math.max(h.scrollTop,i.scrollTop),m+=Math.max(h.scrollLeft,i.scrollLeft));return{top:l,left:m}},f.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;f.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(f.css(a,"marginTop"))||0,c+=parseFloat(f.css(a,"marginLeft"))||0);return{top:b,left:c}},setOffset:function(a,b,c){var d=f.css(a,"position");d==="static"&&(a.style.position="relative");var e=f(a),g=e.offset(),h=f.css(a,"top"),i=f.css(a,"left"),j=(d==="absolute"||d==="fixed")&&f.inArray("auto",[h,i])>-1,k={},l={},m,n;j?(l=e.position(),m=l.top,n=l.left):(m=parseFloat(h)||0,n=parseFloat(i)||0),f.isFunction(b)&&(b=b.call(a,c,g)),b.top!=null&&(k.top=b.top-g.top+m),b.left!=null&&(k.left=b.left-g.left+n),"using"in b?b.using.call(a,k):e.css(k)}},f.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),c=this.offset(),d=cx.test(b[0].nodeName)?{top:0,left:0}:b.offset();c.top-=parseFloat(f.css(a,"marginTop"))||0,c.left-=parseFloat(f.css(a,"marginLeft"))||0,d.top+=parseFloat(f.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(f.css(b[0],"borderLeftWidth"))||0;return{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||c.body;while(a&&!cx.test(a.nodeName)&&f.css(a,"position")==="static")a=a.offsetParent;return a})}}),f.each(["Left","Top"],function(a,c){var d="scroll"+c;f.fn[d]=function(c){var e,g;if(c===b){e=this[0];if(!e)return null;g=cy(e);return g?"pageXOffset"in g?g[a?"pageYOffset":"pageXOffset"]:f.support.boxModel&&g.document.documentElement[d]||g.document.body[d]:e[d]}return this.each(function(){g=cy(this),g?g.scrollTo(a?f(g).scrollLeft():c,a?c:f(g).scrollTop()):this[d]=c})}}),f.each(["Height","Width"],function(a,c){var d=c.toLowerCase();f.fn["inner"+c]=function(){var a=this[0];return a?a.style?parseFloat(f.css(a,d,"padding")):this[d]():null},f.fn["outer"+c]=function(a){var b=this[0];return b?b.style?parseFloat(f.css(b,d,a?"margin":"border")):this[d]():null},f.fn[d]=function(a){var e=this[0];if(!e)return a==null?null:this;if(f.isFunction(a))return this.each(function(b){var c=f(this);c[d](a.call(this,b,c[d]()))});if(f.isWindow(e)){var g=e.document.documentElement["client"+c],h=e.document.body;return e.document.compatMode==="CSS1Compat"&&g||h&&h["client"+c]||g}if(e.nodeType===9)return Math.max(e.documentElement["client"+c],e.body["scroll"+c],e.documentElement["scroll"+c],e.body["offset"+c],e.documentElement["offset"+c]);if(a===b){var i=f.css(e,d),j=parseFloat(i);return f.isNumeric(j)?j:i}return this.css(d,typeof a=="string"?a:a+"px")}}),a.jQuery=a.$=f,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return f})})(window);
////////////////////////////////////////
// SRC End --> libs/jquery/jquery-1.7.1.min.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/jquery/jquery-ui-1.8.20.custom.min.js
////////////////////////////////////////
/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.core.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){function c(b,c){var e=b.nodeName.toLowerCase();if("area"===e){var f=b.parentNode,g=f.name,h;return!b.href||!g||f.nodeName.toLowerCase()!=="map"?!1:(h=a("img[usemap=#"+g+"]")[0],!!h&&d(h))}return(/input|select|textarea|button|object/.test(e)?!b.disabled:"a"==e?b.href||c:c)&&d(b)}function d(b){return!a(b).parents().andSelf().filter(function(){return a.curCSS(this,"visibility")==="hidden"||a.expr.filters.hidden(this)}).length}a.ui=a.ui||{};if(a.ui.version)return;a.extend(a.ui,{version:"1.8.20",keyCode:{ALT:18,BACKSPACE:8,CAPS_LOCK:20,COMMA:188,COMMAND:91,COMMAND_LEFT:91,COMMAND_RIGHT:93,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,MENU:93,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,WINDOWS:91}}),a.fn.extend({propAttr:a.fn.prop||a.fn.attr,_focus:a.fn.focus,focus:function(b,c){return typeof b=="number"?this.each(function(){var d=this;setTimeout(function(){a(d).focus(),c&&c.call(d)},b)}):this._focus.apply(this,arguments)},scrollParent:function(){var b;return a.browser.msie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?b=this.parents().filter(function(){return/(relative|absolute|fixed)/.test(a.curCSS(this,"position",1))&&/(auto|scroll)/.test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0):b=this.parents().filter(function(){return/(auto|scroll)/.test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0),/fixed/.test(this.css("position"))||!b.length?a(document):b},zIndex:function(c){if(c!==b)return this.css("zIndex",c);if(this.length){var d=a(this[0]),e,f;while(d.length&&d[0]!==document){e=d.css("position");if(e==="absolute"||e==="relative"||e==="fixed"){f=parseInt(d.css("zIndex"),10);if(!isNaN(f)&&f!==0)return f}d=d.parent()}}return 0},disableSelection:function(){return this.bind((a.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(a){a.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),a.each(["Width","Height"],function(c,d){function h(b,c,d,f){return a.each(e,function(){c-=parseFloat(a.curCSS(b,"padding"+this,!0))||0,d&&(c-=parseFloat(a.curCSS(b,"border"+this+"Width",!0))||0),f&&(c-=parseFloat(a.curCSS(b,"margin"+this,!0))||0)}),c}var e=d==="Width"?["Left","Right"]:["Top","Bottom"],f=d.toLowerCase(),g={innerWidth:a.fn.innerWidth,innerHeight:a.fn.innerHeight,outerWidth:a.fn.outerWidth,outerHeight:a.fn.outerHeight};a.fn["inner"+d]=function(c){return c===b?g["inner"+d].call(this):this.each(function(){a(this).css(f,h(this,c)+"px")})},a.fn["outer"+d]=function(b,c){return typeof b!="number"?g["outer"+d].call(this,b):this.each(function(){a(this).css(f,h(this,b,!0,c)+"px")})}}),a.extend(a.expr[":"],{data:function(b,c,d){return!!a.data(b,d[3])},focusable:function(b){return c(b,!isNaN(a.attr(b,"tabindex")))},tabbable:function(b){var d=a.attr(b,"tabindex"),e=isNaN(d);return(e||d>=0)&&c(b,!e)}}),a(function(){var b=document.body,c=b.appendChild(c=document.createElement("div"));c.offsetHeight,a.extend(c.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),a.support.minHeight=c.offsetHeight===100,a.support.selectstart="onselectstart"in c,b.removeChild(c).style.display="none"}),a.extend(a.ui,{plugin:{add:function(b,c,d){var e=a.ui[b].prototype;for(var f in d)e.plugins[f]=e.plugins[f]||[],e.plugins[f].push([c,d[f]])},call:function(a,b,c){var d=a.plugins[b];if(!d||!a.element[0].parentNode)return;for(var e=0;e<d.length;e++)a.options[d[e][0]]&&d[e][1].apply(a.element,c)}},contains:function(a,b){return document.compareDocumentPosition?a.compareDocumentPosition(b)&16:a!==b&&a.contains(b)},hasScroll:function(b,c){if(a(b).css("overflow")==="hidden")return!1;var d=c&&c==="left"?"scrollLeft":"scrollTop",e=!1;return b[d]>0?!0:(b[d]=1,e=b[d]>0,b[d]=0,e)},isOverAxis:function(a,b,c){return a>b&&a<b+c},isOver:function(b,c,d,e,f,g){return a.ui.isOverAxis(b,d,f)&&a.ui.isOverAxis(c,e,g)}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.widget.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){if(a.cleanData){var c=a.cleanData;a.cleanData=function(b){for(var d=0,e;(e=b[d])!=null;d++)try{a(e).triggerHandler("remove")}catch(f){}c(b)}}else{var d=a.fn.remove;a.fn.remove=function(b,c){return this.each(function(){return c||(!b||a.filter(b,[this]).length)&&a("*",this).add([this]).each(function(){try{a(this).triggerHandler("remove")}catch(b){}}),d.call(a(this),b,c)})}}a.widget=function(b,c,d){var e=b.split(".")[0],f;b=b.split(".")[1],f=e+"-"+b,d||(d=c,c=a.Widget),a.expr[":"][f]=function(c){return!!a.data(c,b)},a[e]=a[e]||{},a[e][b]=function(a,b){arguments.length&&this._createWidget(a,b)};var g=new c;g.options=a.extend(!0,{},g.options),a[e][b].prototype=a.extend(!0,g,{namespace:e,widgetName:b,widgetEventPrefix:a[e][b].prototype.widgetEventPrefix||b,widgetBaseClass:f},d),a.widget.bridge(b,a[e][b])},a.widget.bridge=function(c,d){a.fn[c]=function(e){var f=typeof e=="string",g=Array.prototype.slice.call(arguments,1),h=this;return e=!f&&g.length?a.extend.apply(null,[!0,e].concat(g)):e,f&&e.charAt(0)==="_"?h:(f?this.each(function(){var d=a.data(this,c),f=d&&a.isFunction(d[e])?d[e].apply(d,g):d;if(f!==d&&f!==b)return h=f,!1}):this.each(function(){var b=a.data(this,c);b?b.option(e||{})._init():a.data(this,c,new d(e,this))}),h)}},a.Widget=function(a,b){arguments.length&&this._createWidget(a,b)},a.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",options:{disabled:!1},_createWidget:function(b,c){a.data(c,this.widgetName,this),this.element=a(c),this.options=a.extend(!0,{},this.options,this._getCreateOptions(),b);var d=this;this.element.bind("remove."+this.widgetName,function(){d.destroy()}),this._create(),this._trigger("create"),this._init()},_getCreateOptions:function(){return a.metadata&&a.metadata.get(this.element[0])[this.widgetName]},_create:function(){},_init:function(){},destroy:function(){this.element.unbind("."+this.widgetName).removeData(this.widgetName),this.widget().unbind("."+this.widgetName).removeAttr("aria-disabled").removeClass(this.widgetBaseClass+"-disabled "+"ui-state-disabled")},widget:function(){return this.element},option:function(c,d){var e=c;if(arguments.length===0)return a.extend({},this.options);if(typeof c=="string"){if(d===b)return this.options[c];e={},e[c]=d}return this._setOptions(e),this},_setOptions:function(b){var c=this;return a.each(b,function(a,b){c._setOption(a,b)}),this},_setOption:function(a,b){return this.options[a]=b,a==="disabled"&&this.widget()[b?"addClass":"removeClass"](this.widgetBaseClass+"-disabled"+" "+"ui-state-disabled").attr("aria-disabled",b),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_trigger:function(b,c,d){var e,f,g=this.options[b];d=d||{},c=a.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],f=c.originalEvent;if(f)for(e in f)e in c||(c[e]=f[e]);return this.element.trigger(c,d),!(a.isFunction(g)&&g.call(this.element[0],c,d)===!1||c.isDefaultPrevented())}}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.mouse.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){var c=!1;a(document).mouseup(function(a){c=!1}),a.widget("ui.mouse",{options:{cancel:":input,option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.bind("mousedown."+this.widgetName,function(a){return b._mouseDown(a)}).bind("click."+this.widgetName,function(c){if(!0===a.data(c.target,b.widgetName+".preventClickEvent"))return a.removeData(c.target,b.widgetName+".preventClickEvent"),c.stopImmediatePropagation(),!1}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(b){if(c)return;this._mouseStarted&&this._mouseUp(b),this._mouseDownEvent=b;var d=this,e=b.which==1,f=typeof this.options.cancel=="string"&&b.target.nodeName?a(b.target).closest(this.options.cancel).length:!1;if(!e||f||!this._mouseCapture(b))return!0;this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){d.mouseDelayMet=!0},this.options.delay));if(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)){this._mouseStarted=this._mouseStart(b)!==!1;if(!this._mouseStarted)return b.preventDefault(),!0}return!0===a.data(b.target,this.widgetName+".preventClickEvent")&&a.removeData(b.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(a){return d._mouseMove(a)},this._mouseUpDelegate=function(a){return d._mouseUp(a)},a(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),b.preventDefault(),c=!0,!0},_mouseMove:function(b){return!a.browser.msie||document.documentMode>=9||!!b.button?this._mouseStarted?(this._mouseDrag(b),b.preventDefault()):(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,b)!==!1,this._mouseStarted?this._mouseDrag(b):this._mouseUp(b)),!this._mouseStarted):this._mouseUp(b)},_mouseUp:function(b){return a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,b.target==this._mouseDownEvent.target&&a.data(b.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(b)),!1},_mouseDistanceMet:function(a){return Math.max(Math.abs(this._mouseDownEvent.pageX-a.pageX),Math.abs(this._mouseDownEvent.pageY-a.pageY))>=this.options.distance},_mouseDelayMet:function(a){return this.mouseDelayMet},_mouseStart:function(a){},_mouseDrag:function(a){},_mouseStop:function(a){},_mouseCapture:function(a){return!0}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.position.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.ui=a.ui||{};var c=/left|center|right/,d=/top|center|bottom/,e="center",f={},g=a.fn.position,h=a.fn.offset;a.fn.position=function(b){if(!b||!b.of)return g.apply(this,arguments);b=a.extend({},b);var h=a(b.of),i=h[0],j=(b.collision||"flip").split(" "),k=b.offset?b.offset.split(" "):[0,0],l,m,n;return i.nodeType===9?(l=h.width(),m=h.height(),n={top:0,left:0}):i.setTimeout?(l=h.width(),m=h.height(),n={top:h.scrollTop(),left:h.scrollLeft()}):i.preventDefault?(b.at="left top",l=m=0,n={top:b.of.pageY,left:b.of.pageX}):(l=h.outerWidth(),m=h.outerHeight(),n=h.offset()),a.each(["my","at"],function(){var a=(b[this]||"").split(" ");a.length===1&&(a=c.test(a[0])?a.concat([e]):d.test(a[0])?[e].concat(a):[e,e]),a[0]=c.test(a[0])?a[0]:e,a[1]=d.test(a[1])?a[1]:e,b[this]=a}),j.length===1&&(j[1]=j[0]),k[0]=parseInt(k[0],10)||0,k.length===1&&(k[1]=k[0]),k[1]=parseInt(k[1],10)||0,b.at[0]==="right"?n.left+=l:b.at[0]===e&&(n.left+=l/2),b.at[1]==="bottom"?n.top+=m:b.at[1]===e&&(n.top+=m/2),n.left+=k[0],n.top+=k[1],this.each(function(){var c=a(this),d=c.outerWidth(),g=c.outerHeight(),h=parseInt(a.curCSS(this,"marginLeft",!0))||0,i=parseInt(a.curCSS(this,"marginTop",!0))||0,o=d+h+(parseInt(a.curCSS(this,"marginRight",!0))||0),p=g+i+(parseInt(a.curCSS(this,"marginBottom",!0))||0),q=a.extend({},n),r;b.my[0]==="right"?q.left-=d:b.my[0]===e&&(q.left-=d/2),b.my[1]==="bottom"?q.top-=g:b.my[1]===e&&(q.top-=g/2),f.fractions||(q.left=Math.round(q.left),q.top=Math.round(q.top)),r={left:q.left-h,top:q.top-i},a.each(["left","top"],function(c,e){a.ui.position[j[c]]&&a.ui.position[j[c]][e](q,{targetWidth:l,targetHeight:m,elemWidth:d,elemHeight:g,collisionPosition:r,collisionWidth:o,collisionHeight:p,offset:k,my:b.my,at:b.at})}),a.fn.bgiframe&&c.bgiframe(),c.offset(a.extend(q,{using:b.using}))})},a.ui.position={fit:{left:function(b,c){var d=a(window),e=c.collisionPosition.left+c.collisionWidth-d.width()-d.scrollLeft();b.left=e>0?b.left-e:Math.max(b.left-c.collisionPosition.left,b.left)},top:function(b,c){var d=a(window),e=c.collisionPosition.top+c.collisionHeight-d.height()-d.scrollTop();b.top=e>0?b.top-e:Math.max(b.top-c.collisionPosition.top,b.top)}},flip:{left:function(b,c){if(c.at[0]===e)return;var d=a(window),f=c.collisionPosition.left+c.collisionWidth-d.width()-d.scrollLeft(),g=c.my[0]==="left"?-c.elemWidth:c.my[0]==="right"?c.elemWidth:0,h=c.at[0]==="left"?c.targetWidth:-c.targetWidth,i=-2*c.offset[0];b.left+=c.collisionPosition.left<0?g+h+i:f>0?g+h+i:0},top:function(b,c){if(c.at[1]===e)return;var d=a(window),f=c.collisionPosition.top+c.collisionHeight-d.height()-d.scrollTop(),g=c.my[1]==="top"?-c.elemHeight:c.my[1]==="bottom"?c.elemHeight:0,h=c.at[1]==="top"?c.targetHeight:-c.targetHeight,i=-2*c.offset[1];b.top+=c.collisionPosition.top<0?g+h+i:f>0?g+h+i:0}}},a.offset.setOffset||(a.offset.setOffset=function(b,c){/static/.test(a.curCSS(b,"position"))&&(b.style.position="relative");var d=a(b),e=d.offset(),f=parseInt(a.curCSS(b,"top",!0),10)||0,g=parseInt(a.curCSS(b,"left",!0),10)||0,h={top:c.top-e.top+f,left:c.left-e.left+g};"using"in c?c.using.call(b,h):d.css(h)},a.fn.offset=function(b){var c=this[0];return!c||!c.ownerDocument?null:b?this.each(function(){a.offset.setOffset(this,b)}):h.call(this)}),function(){var b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d,e,g,h,i;d=document.createElement(b?"div":"body"),g={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},b&&a.extend(g,{position:"absolute",left:"-1000px",top:"-1000px"});for(var j in g)d.style[j]=g[j];d.appendChild(c),e=b||document.documentElement,e.insertBefore(d,e.firstChild),c.style.cssText="position: absolute; left: 10.7432222px; top: 10.432325px; height: 30px; width: 201px;",h=a(c).offset(function(a,b){return b}).offset(),d.innerHTML="",e.removeChild(d),i=h.top+h.left+(b?2e3:0),f.fractions=i>21&&i<22}()})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.draggable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.draggable",a.ui.mouse,{widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1},_create:function(){this.options.helper=="original"&&!/^(?:r|a|f)/.test(this.element.css("position"))&&(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},destroy:function(){if(!this.element.data("draggable"))return;return this.element.removeData("draggable").unbind(".draggable").removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy(),this},_mouseCapture:function(b){var c=this.options;return this.helper||c.disabled||a(b.target).is(".ui-resizable-handle")?!1:(this.handle=this._getHandle(b),this.handle?(c.iframeFix&&a(c.iframeFix===!0?"iframe":c.iframeFix).each(function(){a('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(a(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(b){var c=this.options;return this.helper=this._createHelper(b),this._cacheHelperProportions(),a.ui.ddmanager&&(a.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),c.containment&&this._setContainment(),this._trigger("start",b)===!1?(this._clear(),!1):(this._cacheHelperProportions(),a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this.helper.addClass("ui-draggable-dragging"),this._mouseDrag(b,!0),a.ui.ddmanager&&a.ui.ddmanager.dragStart(this,b),!0)},_mouseDrag:function(b,c){this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute");if(!c){var d=this._uiHash();if(this._trigger("drag",b,d)===!1)return this._mouseUp({}),!1;this.position=d.position}if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";return a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),!1},_mouseStop:function(b){var c=!1;a.ui.ddmanager&&!this.options.dropBehaviour&&(c=a.ui.ddmanager.drop(this,b)),this.dropped&&(c=this.dropped,this.dropped=!1);var d=this.element[0],e=!1;while(d&&(d=d.parentNode))d==document&&(e=!0);if(!e&&this.options.helper==="original")return!1;if(this.options.revert=="invalid"&&!c||this.options.revert=="valid"&&c||this.options.revert===!0||a.isFunction(this.options.revert)&&this.options.revert.call(this.element,c)){var f=this;a(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){f._trigger("stop",b)!==!1&&f._clear()})}else this._trigger("stop",b)!==!1&&this._clear();return!1},_mouseUp:function(b){return this.options.iframeFix===!0&&a("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),a.ui.ddmanager&&a.ui.ddmanager.dragStop(this,b),a.ui.mouse.prototype._mouseUp.call(this,b)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(b){var c=!this.options.handle||!a(this.options.handle,this.element).length?!0:!1;return a(this.options.handle,this.element).find("*").andSelf().each(function(){this==b.target&&(c=!0)}),c},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper)?a(c.helper.apply(this.element[0],[b])):c.helper=="clone"?this.element.clone().removeAttr("id"):this.element;return d.parents("body").length||d.appendTo(c.appendTo=="parent"?this.element[0].parentNode:c.appendTo),d[0]!=this.element[0]&&!/(fixed|absolute)/.test(d.css("position"))&&d.css("position","absolute"),d},_adjustOffsetFromHelper:function(b){typeof b=="string"&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop());if(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&a.browser.msie)b={top:0,left:0};return{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var a=this.element.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:a.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b=this.options;b.containment=="parent"&&(b.containment=this.helper[0].parentNode);if(b.containment=="document"||b.containment=="window")this.containment=[b.containment=="document"?0:a(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,b.containment=="document"?0:a(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,(b.containment=="document"?0:a(window).scrollLeft())+a(b.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(b.containment=="document"?0:a(window).scrollTop())+(a(b.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top];if(!/^(document|window|parent)$/.test(b.containment)&&b.containment.constructor!=Array){var c=a(b.containment),d=c[0];if(!d)return;var e=c.offset(),f=a(d).css("overflow")!="hidden";this.containment=[(parseInt(a(d).css("borderLeftWidth"),10)||0)+(parseInt(a(d).css("paddingLeft"),10)||0),(parseInt(a(d).css("borderTopWidth"),10)||0)+(parseInt(a(d).css("paddingTop"),10)||0),(f?Math.max(d.scrollWidth,d.offsetWidth):d.offsetWidth)-(parseInt(a(d).css("borderLeftWidth"),10)||0)-(parseInt(a(d).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(f?Math.max(d.scrollHeight,d.offsetHeight):d.offsetHeight)-(parseInt(a(d).css("borderTopWidth"),10)||0)-(parseInt(a(d).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=c}else b.containment.constructor==Array&&(this.containment=b.containment)},_convertPositionTo:function(b,c){c||(c=this.position);var d=b=="absolute"?1:-1,e=this.options,f=this.cssPosition=="absolute"&&(this.scrollParent[0]==document||!a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,g=/(html|body)/i.test(f[0].tagName);return{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-(a.browser.safari&&a.browser.version<526&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():g?0:f.scrollTop())*d),left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-(a.browser.safari&&a.browser.version<526&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():g?0:f.scrollLeft())*d)}},_generatePosition:function(b){var c=this.options,d=this.cssPosition=="absolute"&&(this.scrollParent[0]==document||!a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,e=/(html|body)/i.test(d[0].tagName),f=b.pageX,g=b.pageY;if(this.originalPosition){var h;if(this.containment){if(this.relative_container){var i=this.relative_container.offset();h=[this.containment[0]+i.left,this.containment[1]+i.top,this.containment[2]+i.left,this.containment[3]+i.top]}else h=this.containment;b.pageX-this.offset.click.left<h[0]&&(f=h[0]+this.offset.click.left),b.pageY-this.offset.click.top<h[1]&&(g=h[1]+this.offset.click.top),b.pageX-this.offset.click.left>h[2]&&(f=h[2]+this.offset.click.left),b.pageY-this.offset.click.top>h[3]&&(g=h[3]+this.offset.click.top)}if(c.grid){var j=c.grid[1]?this.originalPageY+Math.round((g-this.originalPageY)/c.grid[1])*c.grid[1]:this.originalPageY;g=h?j-this.offset.click.top<h[1]||j-this.offset.click.top>h[3]?j-this.offset.click.top<h[1]?j+c.grid[1]:j-c.grid[1]:j:j;var k=c.grid[0]?this.originalPageX+Math.round((f-this.originalPageX)/c.grid[0])*c.grid[0]:this.originalPageX;f=h?k-this.offset.click.left<h[0]||k-this.offset.click.left>h[2]?k-this.offset.click.left<h[0]?k+c.grid[0]:k-c.grid[0]:k:k}}return{top:g-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&a.browser.version<526&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollTop():e?0:d.scrollTop()),left:f-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&a.browser.version<526&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():e?0:d.scrollLeft())}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]!=this.element[0]&&!this.cancelHelperRemoval&&this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(b,c,d){return d=d||this._uiHash(),a.ui.plugin.call(this,b,[c,d]),b=="drag"&&(this.positionAbs=this._convertPositionTo("absolute")),a.Widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(a){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),a.extend(a.ui.draggable,{version:"1.8.20"}),a.ui.plugin.add("draggable","connectToSortable",{start:function(b,c){var d=a(this).data("draggable"),e=d.options,f=a.extend({},c,{item:d.element});d.sortables=[],a(e.connectToSortable).each(function(){var c=a.data(this,"sortable");c&&!c.options.disabled&&(d.sortables.push({instance:c,shouldRevert:c.options.revert}),c.refreshPositions(),c._trigger("activate",b,f))})},stop:function(b,c){var d=a(this).data("draggable"),e=a.extend({},c,{item:d.element});a.each(d.sortables,function(){this.instance.isOver?(this.instance.isOver=0,d.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=!0),this.instance._mouseStop(b),this.instance.options.helper=this.instance.options._helper,d.options.helper=="original"&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",b,e))})},drag:function(b,c){var d=a(this).data("draggable"),e=this,f=function(b){var c=this.offset.click.top,d=this.offset.click.left,e=this.positionAbs.top,f=this.positionAbs.left,g=b.height,h=b.width,i=b.top,j=b.left;return a.ui.isOver(e+c,f+d,i,j,g,h)};a.each(d.sortables,function(f){this.instance.positionAbs=d.positionAbs,this.instance.helperProportions=d.helperProportions,this.instance.offset.click=d.offset.click,this.instance._intersectsWith(this.instance.containerCache)?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=a(e).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return c.helper[0]},b.target=this.instance.currentItem[0],this.instance._mouseCapture(b,!0),this.instance._mouseStart(b,!0,!0),this.instance.offset.click.top=d.offset.click.top,this.instance.offset.click.left=d.offset.click.left,this.instance.offset.parent.left-=d.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=d.offset.parent.top-this.instance.offset.parent.top,d._trigger("toSortable",b),d.dropped=this.instance.element,d.currentItem=d.element,this.instance.fromOutside=d),this.instance.currentItem&&this.instance._mouseDrag(b)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",b,this.instance._uiHash(this.instance)),this.instance._mouseStop(b,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),d._trigger("fromSortable",b),d.dropped=!1)})}}),a.ui.plugin.add("draggable","cursor",{start:function(b,c){var d=a("body"),e=a(this).data("draggable").options;d.css("cursor")&&(e._cursor=d.css("cursor")),d.css("cursor",e.cursor)},stop:function(b,c){var d=a(this).data("draggable").options;d._cursor&&a("body").css("cursor",d._cursor)}}),a.ui.plugin.add("draggable","opacity",{start:function(b,c){var d=a(c.helper),e=a(this).data("draggable").options;d.css("opacity")&&(e._opacity=d.css("opacity")),d.css("opacity",e.opacity)},stop:function(b,c){var d=a(this).data("draggable").options;d._opacity&&a(c.helper).css("opacity",d._opacity)}}),a.ui.plugin.add("draggable","scroll",{start:function(b,c){var d=a(this).data("draggable");d.scrollParent[0]!=document&&d.scrollParent[0].tagName!="HTML"&&(d.overflowOffset=d.scrollParent.offset())},drag:function(b,c){var d=a(this).data("draggable"),e=d.options,f=!1;if(d.scrollParent[0]!=document&&d.scrollParent[0].tagName!="HTML"){if(!e.axis||e.axis!="x")d.overflowOffset.top+d.scrollParent[0].offsetHeight-b.pageY<e.scrollSensitivity?d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop+e.scrollSpeed:b.pageY-d.overflowOffset.top<e.scrollSensitivity&&(d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop-e.scrollSpeed);if(!e.axis||e.axis!="y")d.overflowOffset.left+d.scrollParent[0].offsetWidth-b.pageX<e.scrollSensitivity?d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft+e.scrollSpeed:b.pageX-d.overflowOffset.left<e.scrollSensitivity&&(d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft-e.scrollSpeed)}else{if(!e.axis||e.axis!="x")b.pageY-a(document).scrollTop()<e.scrollSensitivity?f=a(document).scrollTop(a(document).scrollTop()-e.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())<e.scrollSensitivity&&(f=a(document).scrollTop(a(document).scrollTop()+e.scrollSpeed));if(!e.axis||e.axis!="y")b.pageX-a(document).scrollLeft()<e.scrollSensitivity?f=a(document).scrollLeft(a(document).scrollLeft()-e.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())<e.scrollSensitivity&&(f=a(document).scrollLeft(a(document).scrollLeft()+e.scrollSpeed))}f!==!1&&a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(d,b)}}),a.ui.plugin.add("draggable","snap",{start:function(b,c){var d=a(this).data("draggable"),e=d.options;d.snapElements=[],a(e.snap.constructor!=String?e.snap.items||":data(draggable)":e.snap).each(function(){var b=a(this),c=b.offset();this!=d.element[0]&&d.snapElements.push({item:this,width:b.outerWidth(),height:b.outerHeight(),top:c.top,left:c.left})})},drag:function(b,c){var d=a(this).data("draggable"),e=d.options,f=e.snapTolerance,g=c.offset.left,h=g+d.helperProportions.width,i=c.offset.top,j=i+d.helperProportions.height;for(var k=d.snapElements.length-1;k>=0;k--){var l=d.snapElements[k].left,m=l+d.snapElements[k].width,n=d.snapElements[k].top,o=n+d.snapElements[k].height;if(!(l-f<g&&g<m+f&&n-f<i&&i<o+f||l-f<g&&g<m+f&&n-f<j&&j<o+f||l-f<h&&h<m+f&&n-f<i&&i<o+f||l-f<h&&h<m+f&&n-f<j&&j<o+f)){d.snapElements[k].snapping&&d.options.snap.release&&d.options.snap.release.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[k].item})),d.snapElements[k].snapping=!1;continue}if(e.snapMode!="inner"){var p=Math.abs(n-j)<=f,q=Math.abs(o-i)<=f,r=Math.abs(l-h)<=f,s=Math.abs(m-g)<=f;p&&(c.position.top=d._convertPositionTo("relative",{top:n-d.helperProportions.height,left:0}).top-d.margins.top),q&&(c.position.top=d._convertPositionTo("relative",{top:o,left:0}).top-d.margins.top),r&&(c.position.left=d._convertPositionTo("relative",{top:0,left:l-d.helperProportions.width}).left-d.margins.left),s&&(c.position.left=d._convertPositionTo("relative",{top:0,left:m}).left-d.margins.left)}var t=p||q||r||s;if(e.snapMode!="outer"){var p=Math.abs(n-i)<=f,q=Math.abs(o-j)<=f,r=Math.abs(l-g)<=f,s=Math.abs(m-h)<=f;p&&(c.position.top=d._convertPositionTo("relative",{top:n,left:0}).top-d.margins.top),q&&(c.position.top=d._convertPositionTo("relative",{top:o-d.helperProportions.height,left:0}).top-d.margins.top),r&&(c.position.left=d._convertPositionTo("relative",{top:0,left:l}).left-d.margins.left),s&&(c.position.left=d._convertPositionTo("relative",{top:0,left:m-d.helperProportions.width}).left-d.margins.left)}!d.snapElements[k].snapping&&(p||q||r||s||t)&&d.options.snap.snap&&d.options.snap.snap.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[k].item})),d.snapElements[k].snapping=p||q||r||s||t}}}),a.ui.plugin.add("draggable","stack",{start:function(b,c){var d=a(this).data("draggable").options,e=a.makeArray(a(d.stack)).sort(function(b,c){return(parseInt(a(b).css("zIndex"),10)||0)-(parseInt(a(c).css("zIndex"),10)||0)});if(!e.length)return;var f=parseInt(e[0].style.zIndex)||0;a(e).each(function(a){this.style.zIndex=f+a}),this[0].style.zIndex=f+e.length}}),a.ui.plugin.add("draggable","zIndex",{start:function(b,c){var d=a(c.helper),e=a(this).data("draggable").options;d.css("zIndex")&&(e._zIndex=d.css("zIndex")),d.css("zIndex",e.zIndex)},stop:function(b,c){var d=a(this).data("draggable").options;d._zIndex&&a(c.helper).css("zIndex",d._zIndex)}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.droppable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.droppable",{widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect"},_create:function(){var b=this.options,c=b.accept;this.isover=0,this.isout=1,this.accept=a.isFunction(c)?c:function(a){return a.is(c)},this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight},a.ui.ddmanager.droppables[b.scope]=a.ui.ddmanager.droppables[b.scope]||[],a.ui.ddmanager.droppables[b.scope].push(this),b.addClasses&&this.element.addClass("ui-droppable")},destroy:function(){var b=a.ui.ddmanager.droppables[this.options.scope];for(var c=0;c<b.length;c++)b[c]==this&&b.splice(c,1);return this.element.removeClass("ui-droppable ui-droppable-disabled").removeData("droppable").unbind(".droppable"),this},_setOption:function(b,c){b=="accept"&&(this.accept=a.isFunction(c)?c:function(a){return a.is(c)}),a.Widget.prototype._setOption.apply(this,arguments)},_activate:function(b){var c=a.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),c&&this._trigger("activate",b,this.ui(c))},_deactivate:function(b){var c=a.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),c&&this._trigger("deactivate",b,this.ui(c))},_over:function(b){var c=a.ui.ddmanager.current;if(!c||(c.currentItem||c.element)[0]==this.element[0])return;this.accept.call(this.element[0],c.currentItem||c.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",b,this.ui(c)))},_out:function(b){var c=a.ui.ddmanager.current;if(!c||(c.currentItem||c.element)[0]==this.element[0])return;this.accept.call(this.element[0],c.currentItem||c.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",b,this.ui(c)))},_drop:function(b,c){var d=c||a.ui.ddmanager.current;if(!d||(d.currentItem||d.element)[0]==this.element[0])return!1;var e=!1;return this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var b=a.data(this,"droppable");if(b.options.greedy&&!b.options.disabled&&b.options.scope==d.options.scope&&b.accept.call(b.element[0],d.currentItem||d.element)&&a.ui.intersect(d,a.extend(b,{offset:b.element.offset()}),b.options.tolerance))return e=!0,!1}),e?!1:this.accept.call(this.element[0],d.currentItem||d.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",b,this.ui(d)),this.element):!1},ui:function(a){return{draggable:a.currentItem||a.element,helper:a.helper,position:a.position,offset:a.positionAbs}}}),a.extend(a.ui.droppable,{version:"1.8.20"}),a.ui.intersect=function(b,c,d){if(!c.offset)return!1;var e=(b.positionAbs||b.position.absolute).left,f=e+b.helperProportions.width,g=(b.positionAbs||b.position.absolute).top,h=g+b.helperProportions.height,i=c.offset.left,j=i+c.proportions.width,k=c.offset.top,l=k+c.proportions.height;switch(d){case"fit":return i<=e&&f<=j&&k<=g&&h<=l;case"intersect":return i<e+b.helperProportions.width/2&&f-b.helperProportions.width/2<j&&k<g+b.helperProportions.height/2&&h-b.helperProportions.height/2<l;case"pointer":var m=(b.positionAbs||b.position.absolute).left+(b.clickOffset||b.offset.click).left,n=(b.positionAbs||b.position.absolute).top+(b.clickOffset||b.offset.click).top,o=a.ui.isOver(n,m,k,i,c.proportions.height,c.proportions.width);return o;case"touch":return(g>=k&&g<=l||h>=k&&h<=l||g<k&&h>l)&&(e>=i&&e<=j||f>=i&&f<=j||e<i&&f>j);default:return!1}},a.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(b,c){var d=a.ui.ddmanager.droppables[b.options.scope]||[],e=c?c.type:null,f=(b.currentItem||b.element).find(":data(droppable)").andSelf();g:for(var h=0;h<d.length;h++){if(d[h].options.disabled||b&&!d[h].accept.call(d[h].element[0],b.currentItem||b.element))continue;for(var i=0;i<f.length;i++)if(f[i]==d[h].element[0]){d[h].proportions.height=0;continue g}d[h].visible=d[h].element.css("display")!="none";if(!d[h].visible)continue;e=="mousedown"&&d[h]._activate.call(d[h],c),d[h].offset=d[h].element.offset(),d[h].proportions={width:d[h].element[0].offsetWidth,height:d[h].element[0].offsetHeight}}},drop:function(b,c){var d=!1;return a.each(a.ui.ddmanager.droppables[b.options.scope]||[],function(){if(!this.options)return;!this.options.disabled&&this.visible&&a.ui.intersect(b,this,this.options.tolerance)&&(d=this._drop.call(this,c)||d),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],b.currentItem||b.element)&&(this.isout=1,this.isover=0,this._deactivate.call(this,c))}),d},dragStart:function(b,c){b.element.parents(":not(body,html)").bind("scroll.droppable",function(){b.options.refreshPositions||a.ui.ddmanager.prepareOffsets(b,c)})},drag:function(b,c){b.options.refreshPositions&&a.ui.ddmanager.prepareOffsets(b,c),a.each(a.ui.ddmanager.droppables[b.options.scope]||[],function(){if(this.options.disabled||this.greedyChild||!this.visible)return;var d=a.ui.intersect(b,this,this.options.tolerance),e=!d&&this.isover==1?"isout":d&&this.isover==0?"isover":null;if(!e)return;var f;if(this.options.greedy){var g=this.element.parents(":data(droppable):eq(0)");g.length&&(f=a.data(g[0],"droppable"),f.greedyChild=e=="isover"?1:0)}f&&e=="isover"&&(f.isover=0,f.isout=1,f._out.call(f,c)),this[e]=1,this[e=="isout"?"isover":"isout"]=0,this[e=="isover"?"_over":"_out"].call(this,c),f&&e=="isout"&&(f.isout=0,f.isover=1,f._over.call(f,c))})},dragStop:function(b,c){b.element.parents(":not(body,html)").unbind("scroll.droppable"),b.options.refreshPositions||a.ui.ddmanager.prepareOffsets(b,c)}}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.resizable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.resizable",a.ui.mouse,{widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:1e3},_create:function(){var b=this,c=this.options;this.element.addClass("ui-resizable"),a.extend(this,{_aspectRatio:!!c.aspectRatio,aspectRatio:c.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:c.helper||c.ghost||c.animate?c.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)&&(this.element.wrap(a('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("resizable",this.element.data("resizable")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=c.handles||(a(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se");if(this.handles.constructor==String){this.handles=="all"&&(this.handles="n,e,s,w,se,sw,ne,nw");var d=this.handles.split(",");this.handles={};for(var e=0;e<d.length;e++){var f=a.trim(d[e]),g="ui-resizable-"+f,h=a('<div class="ui-resizable-handle '+g+'"></div>');h.css({zIndex:c.zIndex}),"se"==f&&h.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[f]=".ui-resizable-"+f,this.element.append(h)}}this._renderAxis=function(b){b=b||this.element;for(var c in this.handles){this.handles[c].constructor==String&&(this.handles[c]=a(this.handles[c],this.element).show());if(this.elementIsWrapper&&this.originalElement[0].nodeName.match(/textarea|input|select|button/i)){var d=a(this.handles[c],this.element),e=0;e=/sw|ne|nw|se|n|s/.test(c)?d.outerHeight():d.outerWidth();var f=["padding",/ne|nw|n/.test(c)?"Top":/se|sw|s/.test(c)?"Bottom":/^e$/.test(c)?"Right":"Left"].join("");b.css(f,e),this._proportionallyResize()}if(!a(this.handles[c]).length)continue}},this._renderAxis(this.element),this._handles=a(".ui-resizable-handle",this.element).disableSelection(),this._handles.mouseover(function(){if(!b.resizing){if(this.className)var a=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i);b.axis=a&&a[1]?a[1]:"se"}}),c.autoHide&&(this._handles.hide(),a(this.element).addClass("ui-resizable-autohide").hover(function(){if(c.disabled)return;a(this).removeClass("ui-resizable-autohide"),b._handles.show()},function(){if(c.disabled)return;b.resizing||(a(this).addClass("ui-resizable-autohide"),b._handles.hide())})),this._mouseInit()},destroy:function(){this._mouseDestroy();var b=function(b){a(b).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").unbind(".resizable").find(".ui-resizable-handle").remove()};if(this.elementIsWrapper){b(this.element);var c=this.element;c.after(this.originalElement.css({position:c.css("position"),width:c.outerWidth(),height:c.outerHeight(),top:c.css("top"),left:c.css("left")})).remove()}return this.originalElement.css("resize",this.originalResizeStyle),b(this.originalElement),this},_mouseCapture:function(b){var c=!1;for(var d in this.handles)a(this.handles[d])[0]==b.target&&(c=!0);return!this.options.disabled&&c},_mouseStart:function(b){var d=this.options,e=this.element.position(),f=this.element;this.resizing=!0,this.documentScroll={top:a(document).scrollTop(),left:a(document).scrollLeft()},(f.is(".ui-draggable")||/absolute/.test(f.css("position")))&&f.css({position:"absolute",top:e.top,left:e.left}),this._renderProxy();var g=c(this.helper.css("left")),h=c(this.helper.css("top"));d.containment&&(g+=a(d.containment).scrollLeft()||0,h+=a(d.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:g,top:h},this.size=this._helper?{width:f.outerWidth(),height:f.outerHeight()}:{width:f.width(),height:f.height()},this.originalSize=this._helper?{width:f.outerWidth(),height:f.outerHeight()}:{width:f.width(),height:f.height()},this.originalPosition={left:g,top:h},this.sizeDiff={width:f.outerWidth()-f.width(),height:f.outerHeight()-f.height()},this.originalMousePosition={left:b.pageX,top:b.pageY},this.aspectRatio=typeof d.aspectRatio=="number"?d.aspectRatio:this.originalSize.width/this.originalSize.height||1;var i=a(".ui-resizable-"+this.axis).css("cursor");return a("body").css("cursor",i=="auto"?this.axis+"-resize":i),f.addClass("ui-resizable-resizing"),this._propagate("start",b),!0},_mouseDrag:function(b){var c=this.helper,d=this.options,e={},f=this,g=this.originalMousePosition,h=this.axis,i=b.pageX-g.left||0,j=b.pageY-g.top||0,k=this._change[h];if(!k)return!1;var l=k.apply(this,[b,i,j]),m=a.browser.msie&&a.browser.version<7,n=this.sizeDiff;this._updateVirtualBoundaries(b.shiftKey);if(this._aspectRatio||b.shiftKey)l=this._updateRatio(l,b);return l=this._respectSize(l,b),this._propagate("resize",b),c.css({top:this.position.top+"px",left:this.position.left+"px",width:this.size.width+"px",height:this.size.height+"px"}),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),this._updateCache(l),this._trigger("resize",b,this.ui()),!1},_mouseStop:function(b){this.resizing=!1;var c=this.options,d=this;if(this._helper){var e=this._proportionallyResizeElements,f=e.length&&/textarea/i.test(e[0].nodeName),g=f&&a.ui.hasScroll(e[0],"left")?0:d.sizeDiff.height,h=f?0:d.sizeDiff.width,i={width:d.helper.width()-h,height:d.helper.height()-g},j=parseInt(d.element.css("left"),10)+(d.position.left-d.originalPosition.left)||null,k=parseInt(d.element.css("top"),10)+(d.position.top-d.originalPosition.top)||null;c.animate||this.element.css(a.extend(i,{top:k,left:j})),d.helper.height(d.size.height),d.helper.width(d.size.width),this._helper&&!c.animate&&this._proportionallyResize()}return a("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",b),this._helper&&this.helper.remove(),!1},_updateVirtualBoundaries:function(a){var b=this.options,c,e,f,g,h;h={minWidth:d(b.minWidth)?b.minWidth:0,maxWidth:d(b.maxWidth)?b.maxWidth:Infinity,minHeight:d(b.minHeight)?b.minHeight:0,maxHeight:d(b.maxHeight)?b.maxHeight:Infinity};if(this._aspectRatio||a)c=h.minHeight*this.aspectRatio,f=h.minWidth/this.aspectRatio,e=h.maxHeight*this.aspectRatio,g=h.maxWidth/this.aspectRatio,c>h.minWidth&&(h.minWidth=c),f>h.minHeight&&(h.minHeight=f),e<h.maxWidth&&(h.maxWidth=e),g<h.maxHeight&&(h.maxHeight=g);this._vBoundaries=h},_updateCache:function(a){var b=this.options;this.offset=this.helper.offset(),d(a.left)&&(this.position.left=a.left),d(a.top)&&(this.position.top=a.top),d(a.height)&&(this.size.height=a.height),d(a.width)&&(this.size.width=a.width)},_updateRatio:function(a,b){var c=this.options,e=this.position,f=this.size,g=this.axis;return d(a.height)?a.width=a.height*this.aspectRatio:d(a.width)&&(a.height=a.width/this.aspectRatio),g=="sw"&&(a.left=e.left+(f.width-a.width),a.top=null),g=="nw"&&(a.top=e.top+(f.height-a.height),a.left=e.left+(f.width-a.width)),a},_respectSize:function(a,b){var c=this.helper,e=this._vBoundaries,f=this._aspectRatio||b.shiftKey,g=this.axis,h=d(a.width)&&e.maxWidth&&e.maxWidth<a.width,i=d(a.height)&&e.maxHeight&&e.maxHeight<a.height,j=d(a.width)&&e.minWidth&&e.minWidth>a.width,k=d(a.height)&&e.minHeight&&e.minHeight>a.height;j&&(a.width=e.minWidth),k&&(a.height=e.minHeight),h&&(a.width=e.maxWidth),i&&(a.height=e.maxHeight);var l=this.originalPosition.left+this.originalSize.width,m=this.position.top+this.size.height,n=/sw|nw|w/.test(g),o=/nw|ne|n/.test(g);j&&n&&(a.left=l-e.minWidth),h&&n&&(a.left=l-e.maxWidth),k&&o&&(a.top=m-e.minHeight),i&&o&&(a.top=m-e.maxHeight);var p=!a.width&&!a.height;return p&&!a.left&&a.top?a.top=null:p&&!a.top&&a.left&&(a.left=null),a},_proportionallyResize:function(){var b=this.options;if(!this._proportionallyResizeElements.length)return;var c=this.helper||this.element;for(var d=0;d<this._proportionallyResizeElements.length;d++){var e=this._proportionallyResizeElements[d];if(!this.borderDif){var f=[e.css("borderTopWidth"),e.css("borderRightWidth"),e.css("borderBottomWidth"),e.css("borderLeftWidth")],g=[e.css("paddingTop"),e.css("paddingRight"),e.css("paddingBottom"),e.css("paddingLeft")];this.borderDif=a.map(f,function(a,b){var c=parseInt(a,10)||0,d=parseInt(g[b],10)||0;return c+d})}if(!a.browser.msie||!a(c).is(":hidden")&&!a(c).parents(":hidden").length)e.css({height:c.height()-this.borderDif[0]-this.borderDif[2]||0,width:c.width()-this.borderDif[1]-this.borderDif[3]||0});else continue}},_renderProxy:function(){var b=this.element,c=this.options;this.elementOffset=b.offset();if(this._helper){this.helper=this.helper||a('<div style="overflow:hidden;"></div>');var d=a.browser.msie&&a.browser.version<7,e=d?1:0,f=d?2:-1;this.helper.addClass(this._helper).css({width:this.element.outerWidth()+f,height:this.element.outerHeight()+f,position:"absolute",left:this.elementOffset.left-e+"px",top:this.elementOffset.top-e+"px",zIndex:++c.zIndex}),this.helper.appendTo("body").disableSelection()}else this.helper=this.element},_change:{e:function(a,b,c){return{width:this.originalSize.width+b}},w:function(a,b,c){var d=this.options,e=this.originalSize,f=this.originalPosition;return{left:f.left+b,width:e.width-b}},n:function(a,b,c){var d=this.options,e=this.originalSize,f=this.originalPosition;return{top:f.top+c,height:e.height-c}},s:function(a,b,c){return{height:this.originalSize.height+c}},se:function(b,c,d){return a.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[b,c,d]))},sw:function(b,c,d){return a.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[b,c,d]))},ne:function(b,c,d){return a.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[b,c,d]))},nw:function(b,c,d){return a.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[b,c,d]))}},_propagate:function(b,c){a.ui.plugin.call(this,b,[c,this.ui()]),b!="resize"&&this._trigger(b,c,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),a.extend(a.ui.resizable,{version:"1.8.20"}),a.ui.plugin.add("resizable","alsoResize",{start:function(b,c){var d=a(this).data("resizable"),e=d.options,f=function(b){a(b).each(function(){var b=a(this);b.data("resizable-alsoresize",{width:parseInt(b.width(),10),height:parseInt(b.height(),10),left:parseInt(b.css("left"),10),top:parseInt(b.css("top"),10)})})};typeof e.alsoResize=="object"&&!e.alsoResize.parentNode?e.alsoResize.length?(e.alsoResize=e.alsoResize[0],f(e.alsoResize)):a.each(e.alsoResize,function(a){f(a)}):f(e.alsoResize)},resize:function(b,c){var d=a(this).data("resizable"),e=d.options,f=d.originalSize,g=d.originalPosition,h={height:d.size.height-f.height||0,width:d.size.width-f.width||0,top:d.position.top-g.top||0,left:d.position.left-g.left||0},i=function(b,d){a(b).each(function(){var b=a(this),e=a(this).data("resizable-alsoresize"),f={},g=d&&d.length?d:b.parents(c.originalElement[0]).length?["width","height"]:["width","height","top","left"];a.each(g,function(a,b){var c=(e[b]||0)+(h[b]||0);c&&c>=0&&(f[b]=c||null)}),b.css(f)})};typeof e.alsoResize=="object"&&!e.alsoResize.nodeType?a.each(e.alsoResize,function(a,b){i(a,b)}):i(e.alsoResize)},stop:function(b,c){a(this).removeData("resizable-alsoresize")}}),a.ui.plugin.add("resizable","animate",{stop:function(b,c){var d=a(this).data("resizable"),e=d.options,f=d._proportionallyResizeElements,g=f.length&&/textarea/i.test(f[0].nodeName),h=g&&a.ui.hasScroll(f[0],"left")?0:d.sizeDiff.height,i=g?0:d.sizeDiff.width,j={width:d.size.width-i,height:d.size.height-h},k=parseInt(d.element.css("left"),10)+(d.position.left-d.originalPosition.left)||null,l=parseInt(d.element.css("top"),10)+(d.position.top-d.originalPosition.top)||null;d.element.animate(a.extend(j,l&&k?{top:l,left:k}:{}),{duration:e.animateDuration,easing:e.animateEasing,step:function(){var c={width:parseInt(d.element.css("width"),10),height:parseInt(d.element.css("height"),10),top:parseInt(d.element.css("top"),10),left:parseInt(d.element.css("left"),10)};f&&f.length&&a(f[0]).css({width:c.width,height:c.height}),d._updateCache(c),d._propagate("resize",b)}})}}),a.ui.plugin.add("resizable","containment",{start:function(b,d){var e=a(this).data("resizable"),f=e.options,g=e.element,h=f.containment,i=h instanceof a?h.get(0):/parent/.test(h)?g.parent().get(0):h;if(!i)return;e.containerElement=a(i);if(/document/.test(h)||h==document)e.containerOffset={left:0,top:0},e.containerPosition={left:0,top:0},e.parentData={element:a(document),left:0,top:0,width:a(document).width(),height:a(document).height()||document.body.parentNode.scrollHeight};else{var j=a(i),k=[];a(["Top","Right","Left","Bottom"]).each(function(a,b){k[a]=c(j.css("padding"+b))}),e.containerOffset=j.offset(),e.containerPosition=j.position(),e.containerSize={height:j.innerHeight()-k[3],width:j.innerWidth()-k[1]};var l=e.containerOffset,m=e.containerSize.height,n=e.containerSize.width,o=a.ui.hasScroll(i,"left")?i.scrollWidth:n,p=a.ui.hasScroll(i)?i.scrollHeight:m;e.parentData={element:i,left:l.left,top:l.top,width:o,height:p}}},resize:function(b,c){var d=a(this).data("resizable"),e=d.options,f=d.containerSize,g=d.containerOffset,h=d.size,i=d.position,j=d._aspectRatio||b.shiftKey,k={top:0,left:0},l=d.containerElement;l[0]!=document&&/static/.test(l.css("position"))&&(k=g),i.left<(d._helper?g.left:0)&&(d.size.width=d.size.width+(d._helper?d.position.left-g.left:d.position.left-k.left),j&&(d.size.height=d.size.width/d.aspectRatio),d.position.left=e.helper?g.left:0),i.top<(d._helper?g.top:0)&&(d.size.height=d.size.height+(d._helper?d.position.top-g.top:d.position.top),j&&(d.size.width=d.size.height*d.aspectRatio),d.position.top=d._helper?g.top:0),d.offset.left=d.parentData.left+d.position.left,d.offset.top=d.parentData.top+d.position.top;var m=Math.abs((d._helper?d.offset.left-k.left:d.offset.left-k.left)+d.sizeDiff.width),n=Math.abs((d._helper?d.offset.top-k.top:d.offset.top-g.top)+d.sizeDiff.height),o=d.containerElement.get(0)==d.element.parent().get(0),p=/relative|absolute/.test(d.containerElement.css("position"));o&&p&&(m-=d.parentData.left),m+d.size.width>=d.parentData.width&&(d.size.width=d.parentData.width-m,j&&(d.size.height=d.size.width/d.aspectRatio)),n+d.size.height>=d.parentData.height&&(d.size.height=d.parentData.height-n,j&&(d.size.width=d.size.height*d.aspectRatio))},stop:function(b,c){var d=a(this).data("resizable"),e=d.options,f=d.position,g=d.containerOffset,h=d.containerPosition,i=d.containerElement,j=a(d.helper),k=j.offset(),l=j.outerWidth()-d.sizeDiff.width,m=j.outerHeight()-d.sizeDiff.height;d._helper&&!e.animate&&/relative/.test(i.css("position"))&&a(this).css({left:k.left-h.left-g.left,width:l,height:m}),d._helper&&!e.animate&&/static/.test(i.css("position"))&&a(this).css({left:k.left-h.left-g.left,width:l,height:m})}}),a.ui.plugin.add("resizable","ghost",{start:function(b,c){var d=a(this).data("resizable"),e=d.options,f=d.size;d.ghost=d.originalElement.clone(),d.ghost.css({opacity:.25,display:"block",position:"relative",height:f.height,width:f.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass(typeof e.ghost=="string"?e.ghost:""),d.ghost.appendTo(d.helper)},resize:function(b,c){var d=a(this).data("resizable"),e=d.options;d.ghost&&d.ghost.css({position:"relative",height:d.size.height,width:d.size.width})},stop:function(b,c){var d=a(this).data("resizable"),e=d.options;d.ghost&&d.helper&&d.helper.get(0).removeChild(d.ghost.get(0))}}),a.ui.plugin.add("resizable","grid",{resize:function(b,c){var d=a(this).data("resizable"),e=d.options,f=d.size,g=d.originalSize,h=d.originalPosition,i=d.axis,j=e._aspectRatio||b.shiftKey;e.grid=typeof e.grid=="number"?[e.grid,e.grid]:e.grid;var k=Math.round((f.width-g.width)/(e.grid[0]||1))*(e.grid[0]||1),l=Math.round((f.height-g.height)/(e.grid[1]||1))*(e.grid[1]||1);/^(se|s|e)$/.test(i)?(d.size.width=g.width+k,d.size.height=g.height+l):/^(ne)$/.test(i)?(d.size.width=g.width+k,d.size.height=g.height+l,d.position.top=h.top-l):/^(sw)$/.test(i)?(d.size.width=g.width+k,d.size.height=g.height+l,d.position.left=h.left-k):(d.size.width=g.width+k,d.size.height=g.height+l,d.position.top=h.top-l,d.position.left=h.left-k)}});var c=function(a){return parseInt(a,10)||0},d=function(a){return!isNaN(parseInt(a,10))}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.selectable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.selectable",a.ui.mouse,{options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch"},_create:function(){var b=this;this.element.addClass("ui-selectable"),this.dragged=!1;var c;this.refresh=function(){c=a(b.options.filter,b.element[0]),c.addClass("ui-selectee"),c.each(function(){var b=a(this),c=b.offset();a.data(this,"selectable-item",{element:this,$element:b,left:c.left,top:c.top,right:c.left+b.outerWidth(),bottom:c.top+b.outerHeight(),startselected:!1,selected:b.hasClass("ui-selected"),selecting:b.hasClass("ui-selecting"),unselecting:b.hasClass("ui-unselecting")})})},this.refresh(),this.selectees=c.addClass("ui-selectee"),this._mouseInit(),this.helper=a("<div class='ui-selectable-helper'></div>")},destroy:function(){return this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled").removeData("selectable").unbind(".selectable"),this._mouseDestroy(),this},_mouseStart:function(b){var c=this;this.opos=[b.pageX,b.pageY];if(this.options.disabled)return;var d=this.options;this.selectees=a(d.filter,this.element[0]),this._trigger("start",b),a(d.appendTo).append(this.helper),this.helper.css({left:b.clientX,top:b.clientY,width:0,height:0}),d.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var d=a.data(this,"selectable-item");d.startselected=!0,!b.metaKey&&!b.ctrlKey&&(d.$element.removeClass("ui-selected"),d.selected=!1,d.$element.addClass("ui-unselecting"),d.unselecting=!0,c._trigger("unselecting",b,{unselecting:d.element}))}),a(b.target).parents().andSelf().each(function(){var d=a.data(this,"selectable-item");if(d){var e=!b.metaKey&&!b.ctrlKey||!d.$element.hasClass("ui-selected");return d.$element.removeClass(e?"ui-unselecting":"ui-selected").addClass(e?"ui-selecting":"ui-unselecting"),d.unselecting=!e,d.selecting=e,d.selected=e,e?c._trigger("selecting",b,{selecting:d.element}):c._trigger("unselecting",b,{unselecting:d.element}),!1}})},_mouseDrag:function(b){var c=this;this.dragged=!0;if(this.options.disabled)return;var d=this.options,e=this.opos[0],f=this.opos[1],g=b.pageX,h=b.pageY;if(e>g){var i=g;g=e,e=i}if(f>h){var i=h;h=f,f=i}return this.helper.css({left:e,top:f,width:g-e,height:h-f}),this.selectees.each(function(){var i=a.data(this,"selectable-item");if(!i||i.element==c.element[0])return;var j=!1;d.tolerance=="touch"?j=!(i.left>g||i.right<e||i.top>h||i.bottom<f):d.tolerance=="fit"&&(j=i.left>e&&i.right<g&&i.top>f&&i.bottom<h),j?(i.selected&&(i.$element.removeClass("ui-selected"),i.selected=!1),i.unselecting&&(i.$element.removeClass("ui-unselecting"),i.unselecting=!1),i.selecting||(i.$element.addClass("ui-selecting"),i.selecting=!0,c._trigger("selecting",b,{selecting:i.element}))):(i.selecting&&((b.metaKey||b.ctrlKey)&&i.startselected?(i.$element.removeClass("ui-selecting"),i.selecting=!1,i.$element.addClass("ui-selected"),i.selected=!0):(i.$element.removeClass("ui-selecting"),i.selecting=!1,i.startselected&&(i.$element.addClass("ui-unselecting"),i.unselecting=!0),c._trigger("unselecting",b,{unselecting:i.element}))),i.selected&&!b.metaKey&&!b.ctrlKey&&!i.startselected&&(i.$element.removeClass("ui-selected"),i.selected=!1,i.$element.addClass("ui-unselecting"),i.unselecting=!0,c._trigger("unselecting",b,{unselecting:i.element})))}),!1},_mouseStop:function(b){var c=this;this.dragged=!1;var d=this.options;return a(".ui-unselecting",this.element[0]).each(function(){var d=a.data(this,"selectable-item");d.$element.removeClass("ui-unselecting"),d.unselecting=!1,d.startselected=!1,c._trigger("unselected",b,{unselected:d.element})}),a(".ui-selecting",this.element[0]).each(function(){var d=a.data(this,"selectable-item");d.$element.removeClass("ui-selecting").addClass("ui-selected"),d.selecting=!1,d.selected=!0,d.startselected=!0,c._trigger("selected",b,{selected:d.element})}),this._trigger("stop",b),this.helper.remove(),!1}}),a.extend(a.ui.selectable,{version:"1.8.20"})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.sortable.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.sortable",a.ui.mouse,{widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3},_create:function(){var a=this.options;this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?a.axis==="x"||/left|right/.test(this.items[0].item.css("float"))||/inline|table-cell/.test(this.items[0].item.css("display")):!1,this.offset=this.element.offset(),this._mouseInit(),this.ready=!0},destroy:function(){a.Widget.prototype.destroy.call(this),this.element.removeClass("ui-sortable ui-sortable-disabled"),this._mouseDestroy();for(var b=this.items.length-1;b>=0;b--)this.items[b].item.removeData(this.widgetName+"-item");return this},_setOption:function(b,c){b==="disabled"?(this.options[b]=c,this.widget()[c?"addClass":"removeClass"]("ui-sortable-disabled")):a.Widget.prototype._setOption.apply(this,arguments)},_mouseCapture:function(b,c){var d=this;if(this.reverting)return!1;if(this.options.disabled||this.options.type=="static")return!1;this._refreshItems(b);var e=null,f=this,g=a(b.target).parents().each(function(){if(a.data(this,d.widgetName+"-item")==f)return e=a(this),!1});a.data(b.target,d.widgetName+"-item")==f&&(e=a(b.target));if(!e)return!1;if(this.options.handle&&!c){var h=!1;a(this.options.handle,e).find("*").andSelf().each(function(){this==b.target&&(h=!0)});if(!h)return!1}return this.currentItem=e,this._removeCurrentsFromItems(),!0},_mouseStart:function(b,c,d){var e=this.options,f=this;this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(b),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,e.cursorAt&&this._adjustOffsetFromHelper(e.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!=this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),e.containment&&this._setContainment(),e.cursor&&(a("body").css("cursor")&&(this._storedCursor=a("body").css("cursor")),a("body").css("cursor",e.cursor)),e.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",e.opacity)),e.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",e.zIndex)),this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",b,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions();if(!d)for(var g=this.containers.length-1;g>=0;g--)this.containers[g]._trigger("activate",b,f._uiHash(this));return a.ui.ddmanager&&(a.ui.ddmanager.current=this),a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(b),!0},_mouseDrag:function(b){this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);if(this.options.scroll){var c=this.options,d=!1;this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<c.scrollSensitivity?this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+c.scrollSpeed:b.pageY-this.overflowOffset.top<c.scrollSensitivity&&(this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-c.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<c.scrollSensitivity?this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+c.scrollSpeed:b.pageX-this.overflowOffset.left<c.scrollSensitivity&&(this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-c.scrollSpeed)):(b.pageY-a(document).scrollTop()<c.scrollSensitivity?d=a(document).scrollTop(a(document).scrollTop()-c.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())<c.scrollSensitivity&&(d=a(document).scrollTop(a(document).scrollTop()+c.scrollSpeed)),b.pageX-a(document).scrollLeft()<c.scrollSensitivity?d=a(document).scrollLeft(a(document).scrollLeft()-c.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())<c.scrollSensitivity&&(d=a(document).scrollLeft(a(document).scrollLeft()+c.scrollSpeed))),d!==!1&&a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b)}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y")this.helper[0].style.left=this.position.left+"px";if(!this.options.axis||this.options.axis!="x")this.helper[0].style.top=this.position.top+"px";for(var e=this.items.length-1;e>=0;e--){var f=this.items[e],g=f.item[0],h=this._intersectsWithPointer(f);if(!h)continue;if(g!=this.currentItem[0]&&this.placeholder[h==1?"next":"prev"]()[0]!=g&&!a.ui.contains(this.placeholder[0],g)&&(this.options.type=="semi-dynamic"?!a.ui.contains(this.element[0],g):!0)){this.direction=h==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(f))this._rearrange(b,f);else break;this._trigger("change",b,this._uiHash());break}}return this._contactContainers(b),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b,c){if(!b)return;a.ui.ddmanager&&!this.options.dropBehaviour&&a.ui.ddmanager.drop(this,b);if(this.options.revert){var d=this,e=d.placeholder.offset();d.reverting=!0,a(this.helper).animate({left:e.left-this.offset.parent.left-d.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:e.top-this.offset.parent.top-d.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){d._clear(b)})}else this._clear(b,c);return!1},cancel:function(){var b=this;if(this.dragging){this._mouseUp({target:null}),this.options.helper=="original"?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var c=this.containers.length-1;c>=0;c--)this.containers[c]._trigger("deactivate",null,b._uiHash(this)),this.containers[c].containerCache.over&&(this.containers[c]._trigger("out",null,b._uiHash(this)),this.containers[c].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.options.helper!="original"&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),a.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?a(this.domPosition.prev).after(this.currentItem):a(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];return b=b||{},a(c).each(function(){var c=(a(b.item||this).attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/);c&&d.push((b.key||c[1]+"[]")+"="+(b.key&&b.expression?c[1]:c[2]))}),!d.length&&b.key&&d.push(b.key+"="),d.join("&")},toArray:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];return b=b||{},c.each(function(){d.push(a(b.item||this).attr(b.attribute||"id")||"")}),d},_intersectsWith:function(a){var b=this.positionAbs.left,c=b+this.helperProportions.width,d=this.positionAbs.top,e=d+this.helperProportions.height,f=a.left,g=f+a.width,h=a.top,i=h+a.height,j=this.offset.click.top,k=this.offset.click.left,l=d+j>h&&d+j<i&&b+k>f&&b+k<g;return this.options.tolerance=="pointer"||this.options.forcePointerForContainers||this.options.tolerance!="pointer"&&this.helperProportions[this.floating?"width":"height"]>a[this.floating?"width":"height"]?l:f<b+this.helperProportions.width/2&&c-this.helperProportions.width/2<g&&h<d+this.helperProportions.height/2&&e-this.helperProportions.height/2<i},_intersectsWithPointer:function(b){var c=this.options.axis==="x"||a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,b.top,b.height),d=this.options.axis==="y"||a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,b.left,b.width),e=c&&d,f=this._getDragVerticalDirection(),g=this._getDragHorizontalDirection();return e?this.floating?g&&g=="right"||f=="down"?2:1:f&&(f=="down"?2:1):!1},_intersectsWithSides:function(b){var c=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,b.top+b.height/2,b.height),d=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,b.left+b.width/2,b.width),e=this._getDragVerticalDirection(),f=this._getDragHorizontalDirection();return this.floating&&f?f=="right"&&d||f=="left"&&!d:e&&(e=="down"&&c||e=="up"&&!c)},_getDragVerticalDirection:function(){var a=this.positionAbs.top-this.lastPositionAbs.top;return a!=0&&(a>0?"down":"up")},_getDragHorizontalDirection:function(){var a=this.positionAbs.left-this.lastPositionAbs.left;return a!=0&&(a>0?"right":"left")},refresh:function(a){return this._refreshItems(a),this.refreshPositions(),this},_connectWith:function(){var a=this.options;return a.connectWith.constructor==String?[a.connectWith]:a.connectWith},_getItemsAsjQuery:function(b){var c=this,d=[],e=[],f=this._connectWith();if(f&&b)for(var g=f.length-1;g>=0;g--){var h=a(f[g]);for(var i=h.length-1;i>=0;i--){var j=a.data(h[i],this.widgetName);j&&j!=this&&!j.options.disabled&&e.push([a.isFunction(j.options.items)?j.options.items.call(j.element):a(j.options.items,j.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),j])}}e.push([a.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):a(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(var g=e.length-1;g>=0;g--)e[g][0].each(function(){d.push(this)});return a(d)},_removeCurrentsFromItems:function(){var a=this.currentItem.find(":data("+this.widgetName+"-item)");for(var b=0;b<this.items.length;b++)for(var c=0;c<a.length;c++)a[c]==this.items[b].item[0]&&this.items.splice(b,1)},_refreshItems:function(b){this.items=[],this.containers=[this];var c=this.items,d=this,e=[[a.isFunction(this.options.items)?this.options.items.call(this.element[0],b,{item:this.currentItem}):a(this.options.items,this.element),this]],f=this._connectWith();if(f&&this.ready)for(var g=f.length-1;g>=0;g--){var h=a(f[g]);for(var i=h.length-1;i>=0;i--){var j=a.data(h[i],this.widgetName);j&&j!=this&&!j.options.disabled&&(e.push([a.isFunction(j.options.items)?j.options.items.call(j.element[0],b,{item:this.currentItem}):a(j.options.items,j.element),j]),this.containers.push(j))}}for(var g=e.length-1;g>=0;g--){var k=e[g][1],l=e[g][0];for(var i=0,m=l.length;i<m;i++){var n=a(l[i]);n.data(this.widgetName+"-item",k),c.push({item:n,instance:k,width:0,height:0,left:0,top:0})}}},refreshPositions:function(b){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());for(var c=this.items.length-1;c>=0;c--){var d=this.items[c];if(d.instance!=this.currentContainer&&this.currentContainer&&d.item[0]!=this.currentItem[0])continue;var e=this.options.toleranceElement?a(this.options.toleranceElement,d.item):d.item;b||(d.width=e.outerWidth(),d.height=e.outerHeight());var f=e.offset();d.left=f.left,d.top=f.top}if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(var c=this.containers.length-1;c>=0;c--){var f=this.containers[c].element.offset();this.containers[c].containerCache.left=f.left,this.containers[c].containerCache.top=f.top,this.containers[c].containerCache.width=this.containers[c].element.outerWidth(),this.containers[c].containerCache.height=this.containers[c].element.outerHeight()}return this},_createPlaceholder:function(b){var c=b||this,d=c.options;if(!d.placeholder||d.placeholder.constructor==String){var e=d.placeholder;d.placeholder={element:function(){var b=a(document.createElement(c.currentItem[0].nodeName)).addClass(e||c.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];return e||(b.style.visibility="hidden"),b},update:function(a,b){if(e&&!d.forcePlaceholderSize)return;b.height()||b.height(c.currentItem.innerHeight()-parseInt(c.currentItem.css("paddingTop")||0,10)-parseInt(c.currentItem.css("paddingBottom")||0,10)),b.width()||b.width(c.currentItem.innerWidth()-parseInt(c.currentItem.css("paddingLeft")||0,10)-parseInt(c.currentItem.css("paddingRight")||0,10))}}}c.placeholder=a(d.placeholder.element.call(c.element,c.currentItem)),c.currentItem.after(c.placeholder),d.placeholder.update(c,c.placeholder)},_contactContainers:function(b){var c=null,d=null;for(var e=this.containers.length-1;e>=0;e--){if(a.ui.contains(this.currentItem[0],this.containers[e].element[0]))continue;if(this._intersectsWith(this.containers[e].containerCache)){if(c&&a.ui.contains(this.containers[e].element[0],c.element[0]))continue;c=this.containers[e],d=e}else this.containers[e].containerCache.over&&(this.containers[e]._trigger("out",b,this._uiHash(this)),this.containers[e].containerCache.over=0)}if(!c)return;if(this.containers.length===1)this.containers[d]._trigger("over",b,this._uiHash(this)),this.containers[d].containerCache.over=1;else if(this.currentContainer!=this.containers[d]){var f=1e4,g=null,h=this.positionAbs[this.containers[d].floating?"left":"top"];for(var i=this.items.length-1;i>=0;i--){if(!a.ui.contains(this.containers[d].element[0],this.items[i].item[0]))continue;var j=this.items[i][this.containers[d].floating?"left":"top"];Math.abs(j-h)<f&&(f=Math.abs(j-h),g=this.items[i])}if(!g&&!this.options.dropOnEmpty)return;this.currentContainer=this.containers[d],g?this._rearrange(b,g,null,!0):this._rearrange(b,null,this.containers[d].element,!0),this._trigger("change",b,this._uiHash()),this.containers[d]._trigger("change",b,this._uiHash(this)),this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[d]._trigger("over",b,this._uiHash(this)),this.containers[d].containerCache.over=1}},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper)?a(c.helper.apply(this.element[0],[b,this.currentItem])):c.helper=="clone"?this.currentItem.clone():this.currentItem;return d.parents("body").length||a(c.appendTo!="parent"?c.appendTo:this.currentItem[0].parentNode)[0].appendChild(d[0]),d[0]==this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(d[0].style.width==""||c.forceHelperSize)&&d.width(this.currentItem.width()),(d[0].style.height==""||c.forceHelperSize)&&d.height(this.currentItem.height()),d},_adjustOffsetFromHelper:function(b){typeof b=="string"&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop());if(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&a.browser.msie)b={top:0,left:0};return{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var a=this.currentItem.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:a.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b=this.options;b.containment=="parent"&&(b.containment=this.helper[0].parentNode);if(b.containment=="document"||b.containment=="window")this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,a(b.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(a(b.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top];if(!/^(document|window|parent)$/.test(b.containment)){var c=a(b.containment)[0],d=a(b.containment).offset(),e=a(c).css("overflow")!="hidden";this.containment=[d.left+(parseInt(a(c).css("borderLeftWidth"),10)||0)+(parseInt(a(c).css("paddingLeft"),10)||0)-this.margins.left,d.top+(parseInt(a(c).css("borderTopWidth"),10)||0)+(parseInt(a(c).css("paddingTop"),10)||0)-this.margins.top,d.left+(e?Math.max(c.scrollWidth,c.offsetWidth):c.offsetWidth)-(parseInt(a(c).css("borderLeftWidth"),10)||0)-(parseInt(a(c).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,d.top+(e?Math.max(c.scrollHeight,c.offsetHeight):c.offsetHeight)-(parseInt(a(c).css("borderTopWidth"),10)||0)-(parseInt(a(c).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(b,c){c||(c=this.position);var d=b=="absolute"?1:-1,e=this.options,f=this.cssPosition=="absolute"&&(this.scrollParent[0]==document||!a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,g=/(html|body)/i.test(f[0].tagName);return{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():g?0:f.scrollTop())*d),left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():g?0:f.scrollLeft())*d)}},_generatePosition:function(b){var c=this.options,d=this.cssPosition=="absolute"&&(this.scrollParent[0]==document||!a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,e=/(html|body)/i.test(d[0].tagName);this.cssPosition=="relative"&&(this.scrollParent[0]==document||this.scrollParent[0]==this.offsetParent[0])&&(this.offset.relative=this._getRelativeOffset());var f=b.pageX,g=b.pageY;if(this.originalPosition){this.containment&&(b.pageX-this.offset.click.left<this.containment[0]&&(f=this.containment[0]+this.offset.click.left),b.pageY-this.offset.click.top<this.containment[1]&&(g=this.containment[1]+this.offset.click.top),b.pageX-this.offset.click.left>this.containment[2]&&(f=this.containment[2]+this.offset.click.left),b.pageY-this.offset.click.top>this.containment[3]&&(g=this.containment[3]+this.offset.click.top));if(c.grid){var h=this.originalPageY+Math.round((g-this.originalPageY)/c.grid[1])*c.grid[1];g=this.containment?h-this.offset.click.top<this.containment[1]||h-this.offset.click.top>this.containment[3]?h-this.offset.click.top<this.containment[1]?h+c.grid[1]:h-c.grid[1]:h:h;var i=this.originalPageX+Math.round((f-this.originalPageX)/c.grid[0])*c.grid[0];f=this.containment?i-this.offset.click.left<this.containment[0]||i-this.offset.click.left>this.containment[2]?i-this.offset.click.left<this.containment[0]?i+c.grid[0]:i-c.grid[0]:i:i}}return{top:g-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollTop():e?0:d.scrollTop()),left:f-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&this.cssPosition=="fixed"?0:this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():e?0:d.scrollLeft())}},_rearrange:function(a,b,c,d){c?c[0].appendChild(this.placeholder[0]):b.item[0].parentNode.insertBefore(this.placeholder[0],this.direction=="down"?b.item[0]:b.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var e=this,f=this.counter;window.setTimeout(function(){f==e.counter&&e.refreshPositions(!d)},0)},_clear:function(b,c){this.reverting=!1;var d=[],e=this;!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null;if(this.helper[0]==this.currentItem[0]){for(var f in this._storedCSS)if(this._storedCSS[f]=="auto"||this._storedCSS[f]=="static")this._storedCSS[f]="";this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();this.fromOutside&&!c&&d.push(function(a){this._trigger("receive",a,this._uiHash(this.fromOutside))}),(this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!c&&d.push(function(a){this._trigger("update",a,this._uiHash())});if(!a.ui.contains(this.element[0],this.currentItem[0])){c||d.push(function(a){this._trigger("remove",a,this._uiHash())});for(var f=this.containers.length-1;f>=0;f--)a.ui.contains(this.containers[f].element[0],this.currentItem[0])&&!c&&(d.push(function(a){return function(b){a._trigger("receive",b,this._uiHash(this))}}.call(this,this.containers[f])),d.push(function(a){return function(b){a._trigger("update",b,this._uiHash(this))}}.call(this,this.containers[f])))}for(var f=this.containers.length-1;f>=0;f--)c||d.push(function(a){return function(b){a._trigger("deactivate",b,this._uiHash(this))}}.call(this,this.containers[f])),this.containers[f].containerCache.over&&(d.push(function(a){return function(b){a._trigger("out",b,this._uiHash(this))}}.call(this,this.containers[f])),this.containers[f].containerCache.over=0);this._storedCursor&&a("body").css("cursor",this._storedCursor),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex",this._storedZIndex=="auto"?"":this._storedZIndex),this.dragging=!1;if(this.cancelHelperRemoval){if(!c){this._trigger("beforeStop",b,this._uiHash());for(var f=0;f<d.length;f++)d[f].call(this,b);this._trigger("stop",b,this._uiHash())}return!1}c||this._trigger("beforeStop",b,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper[0]!=this.currentItem[0]&&this.helper.remove(),this.helper=null;if(!c){for(var f=0;f<d.length;f++)d[f].call(this,b);this._trigger("stop",b,this._uiHash())}return this.fromOutside=!1,!0},_trigger:function(){a.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(b){var c=b||this;return{helper:c.helper,placeholder:c.placeholder||a([]),position:c.position,originalPosition:c.originalPosition,offset:c.positionAbs,item:c.currentItem,sender:b?b.element:null}}}),a.extend(a.ui.sortable,{version:"1.8.20"})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.accordion.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.accordion",{options:{active:0,animated:"slide",autoHeight:!0,clearStyle:!1,collapsible:!1,event:"click",fillSpace:!1,header:"> li > :first-child,> :not(li):even",icons:{header:"ui-icon-triangle-1-e",headerSelected:"ui-icon-triangle-1-s"},navigation:!1,navigationFilter:function(){return this.href.toLowerCase()===location.href.toLowerCase()}},_create:function(){var b=this,c=b.options;b.running=0,b.element.addClass("ui-accordion ui-widget ui-helper-reset").children("li").addClass("ui-accordion-li-fix"),b.headers=b.element.find(c.header).addClass("ui-accordion-header ui-helper-reset ui-state-default ui-corner-all").bind("mouseenter.accordion",function(){if(c.disabled)return;a(this).addClass("ui-state-hover")}).bind("mouseleave.accordion",function(){if(c.disabled)return;a(this).removeClass("ui-state-hover")}).bind("focus.accordion",function(){if(c.disabled)return;a(this).addClass("ui-state-focus")}).bind("blur.accordion",function(){if(c.disabled)return;a(this).removeClass("ui-state-focus")}),b.headers.next().addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom");if(c.navigation){var d=b.element.find("a").filter(c.navigationFilter).eq(0);if(d.length){var e=d.closest(".ui-accordion-header");e.length?b.active=e:b.active=d.closest(".ui-accordion-content").prev()}}b.active=b._findActive(b.active||c.active).addClass("ui-state-default ui-state-active").toggleClass("ui-corner-all").toggleClass("ui-corner-top"),b.active.next().addClass("ui-accordion-content-active"),b._createIcons(),b.resize(),b.element.attr("role","tablist"),b.headers.attr("role","tab").bind("keydown.accordion",function(a){return b._keydown(a)}).next().attr("role","tabpanel"),b.headers.not(b.active||"").attr({"aria-expanded":"false","aria-selected":"false",tabIndex:-1}).next().hide(),b.active.length?b.active.attr({"aria-expanded":"true","aria-selected":"true",tabIndex:0}):b.headers.eq(0).attr("tabIndex",0),a.browser.safari||b.headers.find("a").attr("tabIndex",-1),c.event&&b.headers.bind(c.event.split(" ").join(".accordion ")+".accordion",function(a){b._clickHandler.call(b,a,this),a.preventDefault()})},_createIcons:function(){var b=this.options;b.icons&&(a("<span></span>").addClass("ui-icon "+b.icons.header).prependTo(this.headers),this.active.children(".ui-icon").toggleClass(b.icons.header).toggleClass(b.icons.headerSelected),this.element.addClass("ui-accordion-icons"))},_destroyIcons:function(){this.headers.children(".ui-icon").remove(),this.element.removeClass("ui-accordion-icons")},destroy:function(){var b=this.options;this.element.removeClass("ui-accordion ui-widget ui-helper-reset").removeAttr("role"),this.headers.unbind(".accordion").removeClass("ui-accordion-header ui-accordion-disabled ui-helper-reset ui-state-default ui-corner-all ui-state-active ui-state-disabled ui-corner-top").removeAttr("role").removeAttr("aria-expanded").removeAttr("aria-selected").removeAttr("tabIndex"),this.headers.find("a").removeAttr("tabIndex"),this._destroyIcons();var c=this.headers.next().css("display","").removeAttr("role").removeClass("ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content ui-accordion-content-active ui-accordion-disabled ui-state-disabled");return(b.autoHeight||b.fillHeight)&&c.css("height",""),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments),b=="active"&&this.activate(c),b=="icons"&&(this._destroyIcons(),c&&this._createIcons()),b=="disabled"&&this.headers.add(this.headers.next())[c?"addClass":"removeClass"]("ui-accordion-disabled ui-state-disabled")},_keydown:function(b){if(this.options.disabled||b.altKey||b.ctrlKey)return;var c=a.ui.keyCode,d=this.headers.length,e=this.headers.index(b.target),f=!1;switch(b.keyCode){case c.RIGHT:case c.DOWN:f=this.headers[(e+1)%d];break;case c.LEFT:case c.UP:f=this.headers[(e-1+d)%d];break;case c.SPACE:case c.ENTER:this._clickHandler({target:b.target},b.target),b.preventDefault()}return f?(a(b.target).attr("tabIndex",-1),a(f).attr("tabIndex",0),f.focus(),!1):!0},resize:function(){var b=this.options,c;if(b.fillSpace){if(a.browser.msie){var d=this.element.parent().css("overflow");this.element.parent().css("overflow","hidden")}c=this.element.parent().height(),a.browser.msie&&this.element.parent().css("overflow",d),this.headers.each(function(){c-=a(this).outerHeight(!0)}),this.headers.next().each(function(){a(this).height(Math.max(0,c-a(this).innerHeight()+a(this).height()))}).css("overflow","auto")}else b.autoHeight&&(c=0,this.headers.next().each(function(){c=Math.max(c,a(this).height("").height())}).height(c));return this},activate:function(a){this.options.active=a;var b=this._findActive(a)[0];return this._clickHandler({target:b},b),this},_findActive:function(b){return b?typeof b=="number"?this.headers.filter(":eq("+b+")"):this.headers.not(this.headers.not(b)):b===!1?a([]):this.headers.filter(":eq(0)")},_clickHandler:function(b,c){var d=this.options;if(d.disabled)return;if(!b.target){if(!d.collapsible)return;this.active.removeClass("ui-state-active ui-corner-top").addClass("ui-state-default ui-corner-all").children(".ui-icon").removeClass(d.icons.headerSelected).addClass(d.icons.header),this.active.next().addClass("ui-accordion-content-active");var e=this.active.next(),f={options:d,newHeader:a([]),oldHeader:d.active,newContent:a([]),oldContent:e},g=this.active=a([]);this._toggle(g,e,f);return}var h=a(b.currentTarget||c),i=h[0]===this.active[0];d.active=d.collapsible&&i?!1:this.headers.index(h);if(this.running||!d.collapsible&&i)return;var j=this.active,g=h.next(),e=this.active.next(),f={options:d,newHeader:i&&d.collapsible?a([]):h,oldHeader:this.active,newContent:i&&d.collapsible?a([]):g,oldContent:e},k=this.headers.index(this.active[0])>this.headers.index(h[0]);this.active=i?a([]):h,this._toggle(g,e,f,i,k),j.removeClass("ui-state-active ui-corner-top").addClass("ui-state-default ui-corner-all").children(".ui-icon").removeClass(d.icons.headerSelected).addClass(d.icons.header),i||(h.removeClass("ui-state-default ui-corner-all").addClass("ui-state-active ui-corner-top").children(".ui-icon").removeClass(d.icons.header).addClass(d.icons.headerSelected),h.next().addClass("ui-accordion-content-active"));return},_toggle:function(b,c,d,e,f){var g=this,h=g.options;g.toShow=b,g.toHide=c,g.data=d;var i=function(){if(!g)return;return g._completed.apply(g,arguments)};g._trigger("changestart",null,g.data),g.running=c.size()===0?b.size():c.size();if(h.animated){var j={};h.collapsible&&e?j={toShow:a([]),toHide:c,complete:i,down:f,autoHeight:h.autoHeight||h.fillSpace}:j={toShow:b,toHide:c,complete:i,down:f,autoHeight:h.autoHeight||h.fillSpace},h.proxied||(h.proxied=h.animated),h.proxiedDuration||(h.proxiedDuration=h.duration),h.animated=a.isFunction(h.proxied)?h.proxied(j):h.proxied,h.duration=a.isFunction(h.proxiedDuration)?h.proxiedDuration(j):h.proxiedDuration;var k=a.ui.accordion.animations,l=h.duration,m=h.animated;m&&!k[m]&&!a.easing[m]&&(m="slide"),k[m]||(k[m]=function(a){this.slide(a,{easing:m,duration:l||700})}),k[m](j)}else h.collapsible&&e?b.toggle():(c.hide(),b.show()),i(!0);c.prev().attr({"aria-expanded":"false","aria-selected":"false",tabIndex:-1}).blur(),b.prev().attr({"aria-expanded":"true","aria-selected":"true",tabIndex:0}).focus()},_completed:function(a){this.running=a?0:--this.running;if(this.running)return;this.options.clearStyle&&this.toShow.add(this.toHide).css({height:"",overflow:""}),this.toHide.removeClass("ui-accordion-content-active"),this.toHide.length&&(this.toHide.parent()[0].className=this.toHide.parent()[0].className),this._trigger("change",null,this.data)}}),a.extend(a.ui.accordion,{version:"1.8.20",animations:{slide:function(b,c){b=a.extend({easing:"swing",duration:300},b,c);if(!b.toHide.size()){b.toShow.animate({height:"show",paddingTop:"show",paddingBottom:"show"},b);return}if(!b.toShow.size()){b.toHide.animate({height:"hide",paddingTop:"hide",paddingBottom:"hide"},b);return}var d=b.toShow.css("overflow"),e=0,f={},g={},h=["height","paddingTop","paddingBottom"],i,j=b.toShow;i=j[0].style.width,j.width(j.parent().width()-parseFloat(j.css("paddingLeft"))-parseFloat(j.css("paddingRight"))-(parseFloat(j.css("borderLeftWidth"))||0)-(parseFloat(j.css("borderRightWidth"))||0)),a.each(h,function(c,d){g[d]="hide";var e=(""+a.css(b.toShow[0],d)).match(/^([\d+-.]+)(.*)$/);f[d]={value:e[1],unit:e[2]||"px"}}),b.toShow.css({height:0,overflow:"hidden"}).show(),b.toHide.filter(":hidden").each(b.complete).end().filter(":visible").animate(g,{step:function(a,c){c.prop=="height"&&(e=c.end-c.start===0?0:(c.now-c.start)/(c.end-c.start)),b.toShow[0].style[c.prop]=e*f[c.prop].value+f[c.prop].unit},duration:b.duration,easing:b.easing,complete:function(){b.autoHeight||b.toShow.css("height",""),b.toShow.css({width:i,overflow:d}),b.complete()}})},bounceslide:function(a){this.slide(a,{easing:a.down?"easeOutBounce":"swing",duration:a.down?1e3:200})}}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.autocomplete.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){var c=0;a.widget("ui.autocomplete",{options:{appendTo:"body",autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null},pending:0,_create:function(){var b=this,c=this.element[0].ownerDocument,d;this.isMultiLine=this.element.is("textarea"),this.element.addClass("ui-autocomplete-input").attr("autocomplete","off").attr({role:"textbox","aria-autocomplete":"list","aria-haspopup":"true"}).bind("keydown.autocomplete",function(c){if(b.options.disabled||b.element.propAttr("readOnly"))return;d=!1;var e=a.ui.keyCode;switch(c.keyCode){case e.PAGE_UP:b._move("previousPage",c);break;case e.PAGE_DOWN:b._move("nextPage",c);break;case e.UP:b._keyEvent("previous",c);break;case e.DOWN:b._keyEvent("next",c);break;case e.ENTER:case e.NUMPAD_ENTER:b.menu.active&&(d=!0,c.preventDefault());case e.TAB:if(!b.menu.active)return;b.menu.select(c);break;case e.ESCAPE:b.element.val(b.term),b.close(c);break;default:clearTimeout(b.searching),b.searching=setTimeout(function(){b.term!=b.element.val()&&(b.selectedItem=null,b.search(null,c))},b.options.delay)}}).bind("keypress.autocomplete",function(a){d&&(d=!1,a.preventDefault())}).bind("focus.autocomplete",function(){if(b.options.disabled)return;b.selectedItem=null,b.previous=b.element.val()}).bind("blur.autocomplete",function(a){if(b.options.disabled)return;clearTimeout(b.searching),b.closing=setTimeout(function(){b.close(a),b._change(a)},150)}),this._initSource(),this.menu=a("<ul></ul>").addClass("ui-autocomplete").appendTo(a(this.options.appendTo||"body",c)[0]).mousedown(function(c){var d=b.menu.element[0];a(c.target).closest(".ui-menu-item").length||setTimeout(function(){a(document).one("mousedown",function(c){c.target!==b.element[0]&&c.target!==d&&!a.ui.contains(d,c.target)&&b.close()})},1),setTimeout(function(){clearTimeout(b.closing)},13)}).menu({focus:function(a,c){var d=c.item.data("item.autocomplete");!1!==b._trigger("focus",a,{item:d})&&/^key/.test(a.originalEvent.type)&&b.element.val(d.value)},selected:function(a,d){var e=d.item.data("item.autocomplete"),f=b.previous;b.element[0]!==c.activeElement&&(b.element.focus(),b.previous=f,setTimeout(function(){b.previous=f,b.selectedItem=e},1)),!1!==b._trigger("select",a,{item:e})&&b.element.val(e.value),b.term=b.element.val(),b.close(a),b.selectedItem=e},blur:function(a,c){b.menu.element.is(":visible")&&b.element.val()!==b.term&&b.element.val(b.term)}}).zIndex(this.element.zIndex()+1).css({top:0,left:0}).hide().data("menu"),a.fn.bgiframe&&this.menu.element.bgiframe(),b.beforeunloadHandler=function(){b.element.removeAttr("autocomplete")},a(window).bind("beforeunload",b.beforeunloadHandler)},destroy:function(){this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete").removeAttr("role").removeAttr("aria-autocomplete").removeAttr("aria-haspopup"),this.menu.element.remove(),a(window).unbind("beforeunload",this.beforeunloadHandler),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments),b==="source"&&this._initSource(),b==="appendTo"&&this.menu.element.appendTo(a(c||"body",this.element[0].ownerDocument)[0]),b==="disabled"&&c&&this.xhr&&this.xhr.abort()},_initSource:function(){var b=this,c,d;a.isArray(this.options.source)?(c=this.options.source,this.source=function(b,d){d(a.ui.autocomplete.filter(c,b.term))}):typeof this.options.source=="string"?(d=this.options.source,this.source=function(c,e){b.xhr&&b.xhr.abort(),b.xhr=a.ajax({url:d,data:c,dataType:"json",success:function(a,b){e(a)},error:function(){e([])}})}):this.source=this.options.source},search:function(a,b){a=a!=null?a:this.element.val(),this.term=this.element.val();if(a.length<this.options.minLength)return this.close(b);clearTimeout(this.closing);if(this._trigger("search",b)===!1)return;return this._search(a)},_search:function(a){this.pending++,this.element.addClass("ui-autocomplete-loading"),this.source({term:a},this._response())},_response:function(){var a=this,b=++c;return function(d){b===c&&a.__response(d),a.pending--,a.pending||a.element.removeClass("ui-autocomplete-loading")}},__response:function(a){!this.options.disabled&&a&&a.length?(a=this._normalize(a),this._suggest(a),this._trigger("open")):this.close()},close:function(a){clearTimeout(this.closing),this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.deactivate(),this._trigger("close",a))},_change:function(a){this.previous!==this.element.val()&&this._trigger("change",a,{item:this.selectedItem})},_normalize:function(b){return b.length&&b[0].label&&b[0].value?b:a.map(b,function(b){return typeof b=="string"?{label:b,value:b}:a.extend({label:b.label||b.value,value:b.value||b.label},b)})},_suggest:function(b){var c=this.menu.element.empty().zIndex(this.element.zIndex()+1);this._renderMenu(c,b),this.menu.deactivate(),this.menu.refresh(),c.show(),this._resizeMenu(),c.position(a.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next(new a.Event("mouseover"))},_resizeMenu:function(){var a=this.menu.element;a.outerWidth(Math.max(a.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(b,c){var d=this;a.each(c,function(a,c){d._renderItem(b,c)})},_renderItem:function(b,c){return a("<li></li>").data("item.autocomplete",c).append(a("<a></a>").text(c.label)).appendTo(b)},_move:function(a,b){if(!this.menu.element.is(":visible")){this.search(null,b);return}if(this.menu.first()&&/^previous/.test(a)||this.menu.last()&&/^next/.test(a)){this.element.val(this.term),this.menu.deactivate();return}this.menu[a](b)},widget:function(){return this.menu.element},_keyEvent:function(a,b){if(!this.isMultiLine||this.menu.element.is(":visible"))this._move(a,b),b.preventDefault()}}),a.extend(a.ui.autocomplete,{escapeRegex:function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},filter:function(b,c){var d=new RegExp(a.ui.autocomplete.escapeRegex(c),"i");return a.grep(b,function(a){return d.test(a.label||a.value||a)})}})})(jQuery),function(a){a.widget("ui.menu",{_create:function(){var b=this;this.element.addClass("ui-menu ui-widget ui-widget-content ui-corner-all").attr({role:"listbox","aria-activedescendant":"ui-active-menuitem"}).click(function(c){if(!a(c.target).closest(".ui-menu-item a").length)return;c.preventDefault(),b.select(c)}),this.refresh()},refresh:function(){var b=this,c=this.element.children("li:not(.ui-menu-item):has(a)").addClass("ui-menu-item").attr("role","menuitem");c.children("a").addClass("ui-corner-all").attr("tabindex",-1).mouseenter(function(c){b.activate(c,a(this).parent())}).mouseleave(function(){b.deactivate()})},activate:function(a,b){this.deactivate();if(this.hasScroll()){var c=b.offset().top-this.element.offset().top,d=this.element.scrollTop(),e=this.element.height();c<0?this.element.scrollTop(d+c):c>=e&&this.element.scrollTop(d+c-e+b.height())}this.active=b.eq(0).children("a").addClass("ui-state-hover").attr("id","ui-active-menuitem").end(),this._trigger("focus",a,{item:b})},deactivate:function(){if(!this.active)return;this.active.children("a").removeClass("ui-state-hover").removeAttr("id"),this._trigger("blur"),this.active=null},next:function(a){this.move("next",".ui-menu-item:first",a)},previous:function(a){this.move("prev",".ui-menu-item:last",a)},first:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},last:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},move:function(a,b,c){if(!this.active){this.activate(c,this.element.children(b));return}var d=this.active[a+"All"](".ui-menu-item").eq(0);d.length?this.activate(c,d):this.activate(c,this.element.children(b))},nextPage:function(b){if(this.hasScroll()){if(!this.active||this.last()){this.activate(b,this.element.children(".ui-menu-item:first"));return}var c=this.active.offset().top,d=this.element.height(),e=this.element.children(".ui-menu-item").filter(function(){var b=a(this).offset().top-c-d+a(this).height();return b<10&&b>-10});e.length||(e=this.element.children(".ui-menu-item:last")),this.activate(b,e)}else this.activate(b,this.element.children(".ui-menu-item").filter(!this.active||this.last()?":first":":last"))},previousPage:function(b){if(this.hasScroll()){if(!this.active||this.first()){this.activate(b,this.element.children(".ui-menu-item:last"));return}var c=this.active.offset().top,d=this.element.height(),e=this.element.children(".ui-menu-item").filter(function(){var b=a(this).offset().top-c+d-a(this).height();return b<10&&b>-10});e.length||(e=this.element.children(".ui-menu-item:first")),this.activate(b,e)}else this.activate(b,this.element.children(".ui-menu-item").filter(!this.active||this.first()?":last":":first"))},hasScroll:function(){return this.element.height()<this.element[a.fn.prop?"prop":"attr"]("scrollHeight")},select:function(a){this._trigger("selected",a,{item:this.active})}})}(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.button.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){var c,d,e,f,g="ui-button ui-widget ui-state-default ui-corner-all",h="ui-state-hover ui-state-active ",i="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",j=function(){var b=a(this).find(":ui-button");setTimeout(function(){b.button("refresh")},1)},k=function(b){var c=b.name,d=b.form,e=a([]);return c&&(d?e=a(d).find("[name='"+c+"']"):e=a("[name='"+c+"']",b.ownerDocument).filter(function(){return!this.form})),e};a.widget("ui.button",{options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset.button").bind("reset.button",j),typeof this.options.disabled!="boolean"?this.options.disabled=!!this.element.propAttr("disabled"):this.element.propAttr("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");var b=this,h=this.options,i=this.type==="checkbox"||this.type==="radio",l="ui-state-hover"+(i?"":" ui-state-active"),m="ui-state-focus";h.label===null&&(h.label=this.buttonElement.html()),this.buttonElement.addClass(g).attr("role","button").bind("mouseenter.button",function(){if(h.disabled)return;a(this).addClass("ui-state-hover"),this===c&&a(this).addClass("ui-state-active")}).bind("mouseleave.button",function(){if(h.disabled)return;a(this).removeClass(l)}).bind("click.button",function(a){h.disabled&&(a.preventDefault(),a.stopImmediatePropagation())}),this.element.bind("focus.button",function(){b.buttonElement.addClass(m)}).bind("blur.button",function(){b.buttonElement.removeClass(m)}),i&&(this.element.bind("change.button",function(){if(f)return;b.refresh()}),this.buttonElement.bind("mousedown.button",function(a){if(h.disabled)return;f=!1,d=a.pageX,e=a.pageY}).bind("mouseup.button",function(a){if(h.disabled)return;if(d!==a.pageX||e!==a.pageY)f=!0})),this.type==="checkbox"?this.buttonElement.bind("click.button",function(){if(h.disabled||f)return!1;a(this).toggleClass("ui-state-active"),b.buttonElement.attr("aria-pressed",b.element[0].checked)}):this.type==="radio"?this.buttonElement.bind("click.button",function(){if(h.disabled||f)return!1;a(this).addClass("ui-state-active"),b.buttonElement.attr("aria-pressed","true");var c=b.element[0];k(c).not(c).map(function(){return a(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown.button",function(){if(h.disabled)return!1;a(this).addClass("ui-state-active"),c=this,a(document).one("mouseup",function(){c=null})}).bind("mouseup.button",function(){if(h.disabled)return!1;a(this).removeClass("ui-state-active")}).bind("keydown.button",function(b){if(h.disabled)return!1;(b.keyCode==a.ui.keyCode.SPACE||b.keyCode==a.ui.keyCode.ENTER)&&a(this).addClass("ui-state-active")}).bind("keyup.button",function(){a(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(b){b.keyCode===a.ui.keyCode.SPACE&&a(this).click()})),this._setOption("disabled",h.disabled),this._resetButton()},_determineButtonType:function(){this.element.is(":checkbox")?this.type="checkbox":this.element.is(":radio")?this.type="radio":this.element.is("input")?this.type="input":this.type="button";if(this.type==="checkbox"||this.type==="radio"){var a=this.element.parents().filter(":last"),b="label[for='"+this.element.attr("id")+"']";this.buttonElement=a.find(b),this.buttonElement.length||(a=a.length?a.siblings():this.element.siblings(),this.buttonElement=a.filter(b),this.buttonElement.length||(this.buttonElement=a.find(b))),this.element.addClass("ui-helper-hidden-accessible");var c=this.element.is(":checked");c&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.attr("aria-pressed",c)}else this.buttonElement=this.element},widget:function(){return this.buttonElement},destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass(g+" "+h+" "+i).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title"),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments);if(b==="disabled"){c?this.element.propAttr("disabled",!0):this.element.propAttr("disabled",!1);return}this._resetButton()},refresh:function(){var b=this.element.is(":disabled");b!==this.options.disabled&&this._setOption("disabled",b),this.type==="radio"?k(this.element[0]).each(function(){a(this).is(":checked")?a(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):a(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}):this.type==="checkbox"&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))},_resetButton:function(){if(this.type==="input"){this.options.label&&this.element.val(this.options.label);return}var b=this.buttonElement.removeClass(i),c=a("<span></span>",this.element[0].ownerDocument).addClass("ui-button-text").html(this.options.label).appendTo(b.empty()).text(),d=this.options.icons,e=d.primary&&d.secondary,f=[];d.primary||d.secondary?(this.options.text&&f.push("ui-button-text-icon"+(e?"s":d.primary?"-primary":"-secondary")),d.primary&&b.prepend("<span class='ui-button-icon-primary ui-icon "+d.primary+"'></span>"),d.secondary&&b.append("<span class='ui-button-icon-secondary ui-icon "+d.secondary+"'></span>"),this.options.text||(f.push(e?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||b.attr("title",c))):f.push("ui-button-text-only"),b.addClass(f.join(" "))}}),a.widget("ui.buttonset",{options:{items:":button, :submit, :reset, :checkbox, :radio, a, :data(button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(b,c){b==="disabled"&&this.buttons.button("option",b,c),a.Widget.prototype._setOption.apply(this,arguments)},refresh:function(){var b=this.element.css("direction")==="rtl";this.buttons=this.element.find(this.options.items).filter(":ui-button").button("refresh").end().not(":ui-button").button().end().map(function(){return a(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(b?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(b?"ui-corner-left":"ui-corner-right").end().end()},destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return a(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy"),a.Widget.prototype.destroy.call(this)}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.dialog.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){var c="ui-dialog ui-widget ui-widget-content ui-corner-all ",d={buttons:!0,height:!0,maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0,width:!0},e={maxHeight:!0,maxWidth:!0,minHeight:!0,minWidth:!0},f=a.attrFn||{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0,click:!0};a.widget("ui.dialog",{options:{autoOpen:!0,buttons:{},closeOnEscape:!0,closeText:"close",dialogClass:"",draggable:!0,hide:null,height:"auto",maxHeight:!1,maxWidth:!1,minHeight:150,minWidth:150,modal:!1,position:{my:"center",at:"center",collision:"fit",using:function(b){var c=a(this).css(b).offset().top;c<0&&a(this).css("top",b.top-c)}},resizable:!0,show:null,stack:!0,title:"",width:300,zIndex:1e3},_create:function(){this.originalTitle=this.element.attr("title"),typeof this.originalTitle!="string"&&(this.originalTitle=""),this.options.title=this.options.title||this.originalTitle;var b=this,d=b.options,e=d.title||"&#160;",f=a.ui.dialog.getTitleId(b.element),g=(b.uiDialog=a("<div></div>")).appendTo(document.body).hide().addClass(c+d.dialogClass).css({zIndex:d.zIndex}).attr("tabIndex",-1).css("outline",0).keydown(function(c){d.closeOnEscape&&!c.isDefaultPrevented()&&c.keyCode&&c.keyCode===a.ui.keyCode.ESCAPE&&(b.close(c),c.preventDefault())}).attr({role:"dialog","aria-labelledby":f}).mousedown(function(a){b.moveToTop(!1,a)}),h=b.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(g),i=(b.uiDialogTitlebar=a("<div></div>")).addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(g),j=a('<a href="#"></a>').addClass("ui-dialog-titlebar-close ui-corner-all").attr("role","button").hover(function(){j.addClass("ui-state-hover")},function(){j.removeClass("ui-state-hover")}).focus(function(){j.addClass("ui-state-focus")}).blur(function(){j.removeClass("ui-state-focus")}).click(function(a){return b.close(a),!1}).appendTo(i),k=(b.uiDialogTitlebarCloseText=a("<span></span>")).addClass("ui-icon ui-icon-closethick").text(d.closeText).appendTo(j),l=a("<span></span>").addClass("ui-dialog-title").attr("id",f).html(e).prependTo(i);a.isFunction(d.beforeclose)&&!a.isFunction(d.beforeClose)&&(d.beforeClose=d.beforeclose),i.find("*").add(i).disableSelection(),d.draggable&&a.fn.draggable&&b._makeDraggable(),d.resizable&&a.fn.resizable&&b._makeResizable(),b._createButtons(d.buttons),b._isOpen=!1,a.fn.bgiframe&&g.bgiframe()},_init:function(){this.options.autoOpen&&this.open()},destroy:function(){var a=this;return a.overlay&&a.overlay.destroy(),a.uiDialog.hide(),a.element.unbind(".dialog").removeData("dialog").removeClass("ui-dialog-content ui-widget-content").hide().appendTo("body"),a.uiDialog.remove(),a.originalTitle&&a.element.attr("title",a.originalTitle),a},widget:function(){return this.uiDialog},close:function(b){var c=this,d,e;if(!1===c._trigger("beforeClose",b))return;return c.overlay&&c.overlay.destroy(),c.uiDialog.unbind("keypress.ui-dialog"),c._isOpen=!1,c.options.hide?c.uiDialog.hide(c.options.hide,function(){c._trigger("close",b)}):(c.uiDialog.hide(),c._trigger("close",b)),a.ui.dialog.overlay.resize(),c.options.modal&&(d=0,a(".ui-dialog").each(function(){this!==c.uiDialog[0]&&(e=a(this).css("z-index"),isNaN(e)||(d=Math.max(d,e)))}),a.ui.dialog.maxZ=d),c},isOpen:function(){return this._isOpen},moveToTop:function(b,c){var d=this,e=d.options,f;return e.modal&&!b||!e.stack&&!e.modal?d._trigger("focus",c):(e.zIndex>a.ui.dialog.maxZ&&(a.ui.dialog.maxZ=e.zIndex),d.overlay&&(a.ui.dialog.maxZ+=1,d.overlay.$el.css("z-index",a.ui.dialog.overlay.maxZ=a.ui.dialog.maxZ)),f={scrollTop:d.element.scrollTop(),scrollLeft:d.element.scrollLeft()},a.ui.dialog.maxZ+=1,d.uiDialog.css("z-index",a.ui.dialog.maxZ),d.element.attr(f),d._trigger("focus",c),d)},open:function(){if(this._isOpen)return;var b=this,c=b.options,d=b.uiDialog;return b.overlay=c.modal?new a.ui.dialog.overlay(b):null,b._size(),b._position(c.position),d.show(c.show),b.moveToTop(!0),c.modal&&d.bind("keydown.ui-dialog",function(b){if(b.keyCode!==a.ui.keyCode.TAB)return;var c=a(":tabbable",this),d=c.filter(":first"),e=c.filter(":last");if(b.target===e[0]&&!b.shiftKey)return d.focus(1),!1;if(b.target===d[0]&&b.shiftKey)return e.focus(1),!1}),a(b.element.find(":tabbable").get().concat(d.find(".ui-dialog-buttonpane :tabbable").get().concat(d.get()))).eq(0).focus(),b._isOpen=!0,b._trigger("open"),b},_createButtons:function(b){var c=this,d=!1,e=a("<div></div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"),g=a("<div></div>").addClass("ui-dialog-buttonset").appendTo(e);c.uiDialog.find(".ui-dialog-buttonpane").remove(),typeof b=="object"&&b!==null&&a.each(b,function(){return!(d=!0)}),d&&(a.each(b,function(b,d){d=a.isFunction(d)?{click:d,text:b}:d;var e=a('<button type="button"></button>').click(function(){d.click.apply(c.element[0],arguments)}).appendTo(g);a.each(d,function(a,b){if(a==="click")return;a in f?e[a](b):e.attr(a,b)}),a.fn.button&&e.button()}),e.appendTo(c.uiDialog))},_makeDraggable:function(){function f(a){return{position:a.position,offset:a.offset}}var b=this,c=b.options,d=a(document),e;b.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(d,g){e=c.height==="auto"?"auto":a(this).height(),a(this).height(a(this).height()).addClass("ui-dialog-dragging"),b._trigger("dragStart",d,f(g))},drag:function(a,c){b._trigger("drag",a,f(c))},stop:function(g,h){c.position=[h.position.left-d.scrollLeft(),h.position.top-d.scrollTop()],a(this).removeClass("ui-dialog-dragging").height(e),b._trigger("dragStop",g,f(h)),a.ui.dialog.overlay.resize()}})},_makeResizable:function(c){function h(a){return{originalPosition:a.originalPosition,originalSize:a.originalSize,position:a.position,size:a.size}}c=c===b?this.options.resizable:c;var d=this,e=d.options,f=d.uiDialog.css("position"),g=typeof c=="string"?c:"n,e,s,w,se,sw,ne,nw";d.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:d.element,maxWidth:e.maxWidth,maxHeight:e.maxHeight,minWidth:e.minWidth,minHeight:d._minHeight(),handles:g,start:function(b,c){a(this).addClass("ui-dialog-resizing"),d._trigger("resizeStart",b,h(c))},resize:function(a,b){d._trigger("resize",a,h(b))},stop:function(b,c){a(this).removeClass("ui-dialog-resizing"),e.height=a(this).height(),e.width=a(this).width(),d._trigger("resizeStop",b,h(c)),a.ui.dialog.overlay.resize()}}).css("position",f).find(".ui-resizable-se").addClass("ui-icon ui-icon-grip-diagonal-se")},_minHeight:function(){var a=this.options;return a.height==="auto"?a.minHeight:Math.min(a.minHeight,a.height)},_position:function(b){var c=[],d=[0,0],e;if(b){if(typeof b=="string"||typeof b=="object"&&"0"in b)c=b.split?b.split(" "):[b[0],b[1]],c.length===1&&(c[1]=c[0]),a.each(["left","top"],function(a,b){+c[a]===c[a]&&(d[a]=c[a],c[a]=b)}),b={my:c.join(" "),at:c.join(" "),offset:d.join(" ")};b=a.extend({},a.ui.dialog.prototype.options.position,b)}else b=a.ui.dialog.prototype.options.position;e=this.uiDialog.is(":visible"),e||this.uiDialog.show(),this.uiDialog.css({top:0,left:0}).position(a.extend({of:window},b)),e||this.uiDialog.hide()},_setOptions:function(b){var c=this,f={},g=!1;a.each(b,function(a,b){c._setOption(a,b),a in d&&(g=!0),a in e&&(f[a]=b)}),g&&this._size(),this.uiDialog.is(":data(resizable)")&&this.uiDialog.resizable("option",f)},_setOption:function(b,d){var e=this,f=e.uiDialog;switch(b){case"beforeclose":b="beforeClose";break;case"buttons":e._createButtons(d);break;case"closeText":e.uiDialogTitlebarCloseText.text(""+d);break;case"dialogClass":f.removeClass(e.options.dialogClass).addClass(c+d);break;case"disabled":d?f.addClass("ui-dialog-disabled"):f.removeClass("ui-dialog-disabled");break;case"draggable":var g=f.is(":data(draggable)");g&&!d&&f.draggable("destroy"),!g&&d&&e._makeDraggable();break;case"position":e._position(d);break;case"resizable":var h=f.is(":data(resizable)");h&&!d&&f.resizable("destroy"),h&&typeof d=="string"&&f.resizable("option","handles",d),!h&&d!==!1&&e._makeResizable(d);break;case"title":a(".ui-dialog-title",e.uiDialogTitlebar).html(""+(d||"&#160;"))}a.Widget.prototype._setOption.apply(e,arguments)},_size:function(){var b=this.options,c,d,e=this.uiDialog.is(":visible");this.element.show().css({width:"auto",minHeight:0,height:0}),b.minWidth>b.width&&(b.width=b.minWidth),c=this.uiDialog.css({height:"auto",width:b.width}).height(),d=Math.max(0,b.minHeight-c);if(b.height==="auto")if(a.support.minHeight)this.element.css({minHeight:d,height:"auto"});else{this.uiDialog.show();var f=this.element.css("height","auto").height();e||this.uiDialog.hide(),this.element.height(Math.max(f,d))}else this.element.height(Math.max(b.height-c,0));this.uiDialog.is(":data(resizable)")&&this.uiDialog.resizable("option","minHeight",this._minHeight())}}),a.extend(a.ui.dialog,{version:"1.8.20",uuid:0,maxZ:0,getTitleId:function(a){var b=a.attr("id");return b||(this.uuid+=1,b=this.uuid),"ui-dialog-title-"+b},overlay:function(b){this.$el=a.ui.dialog.overlay.create(b)}}),a.extend(a.ui.dialog.overlay,{instances:[],oldInstances:[],maxZ:0,events:a.map("focus,mousedown,mouseup,keydown,keypress,click".split(","),function(a){return a+".dialog-overlay"}).join(" "),create:function(b){this.instances.length===0&&(setTimeout(function(){a.ui.dialog.overlay.instances.length&&a(document).bind(a.ui.dialog.overlay.events,function(b){if(a(b.target).zIndex()<a.ui.dialog.overlay.maxZ)return!1})},1),a(document).bind("keydown.dialog-overlay",function(c){b.options.closeOnEscape&&!c.isDefaultPrevented()&&c.keyCode&&c.keyCode===a.ui.keyCode.ESCAPE&&(b.close(c),c.preventDefault())}),a(window).bind("resize.dialog-overlay",a.ui.dialog.overlay.resize));var c=(this.oldInstances.pop()||a("<div></div>").addClass("ui-widget-overlay")).appendTo(document.body).css({width:this.width(),height:this.height()});return a.fn.bgiframe&&c.bgiframe(),this.instances.push(c),c},destroy:function(b){var c=a.inArray(b,this.instances);c!=-1&&this.oldInstances.push(this.instances.splice(c,1)[0]),this.instances.length===0&&a([document,window]).unbind(".dialog-overlay"),b.remove();var d=0;a.each(this.instances,function(){d=Math.max(d,this.css("z-index"))}),this.maxZ=d},height:function(){var b,c;return a.browser.msie&&a.browser.version<7?(b=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight),c=Math.max(document.documentElement.offsetHeight,document.body.offsetHeight),b<c?a(window).height()+"px":b+"px"):a(document).height()+"px"},width:function(){var b,c;return a.browser.msie?(b=Math.max(document.documentElement.scrollWidth,document.body.scrollWidth),c=Math.max(document.documentElement.offsetWidth,document.body.offsetWidth),b<c?a(window).width()+"px":b+"px"):a(document).width()+"px"},resize:function(){var b=a([]);a.each(a.ui.dialog.overlay.instances,function(){b=b.add(this)}),b.css({width:0,height:0}).css({width:a.ui.dialog.overlay.width(),height:a.ui.dialog.overlay.height()})}}),a.extend(a.ui.dialog.overlay.prototype,{destroy:function(){a.ui.dialog.overlay.destroy(this.$el)}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.slider.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){var c=5;a.widget("ui.slider",a.ui.mouse,{widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null},_create:function(){var b=this,d=this.options,e=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),f="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",g=d.values&&d.values.length||1,h=[];this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget"+" ui-widget-content"+" ui-corner-all"+(d.disabled?" ui-slider-disabled ui-disabled":"")),this.range=a([]),d.range&&(d.range===!0&&(d.values||(d.values=[this._valueMin(),this._valueMin()]),d.values.length&&d.values.length!==2&&(d.values=[d.values[0],d.values[0]])),this.range=a("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header"+(d.range==="min"||d.range==="max"?" ui-slider-range-"+d.range:"")));for(var i=e.length;i<g;i+=1)h.push(f);this.handles=e.add(a(h.join("")).appendTo(b.element)),this.handle=this.handles.eq(0),this.handles.add(this.range).filter("a").click(function(a){a.preventDefault()}).hover(function(){d.disabled||a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover")}).focus(function(){d.disabled?a(this).blur():(a(".ui-slider .ui-state-focus").removeClass("ui-state-focus"),a(this).addClass("ui-state-focus"))}).blur(function(){a(this).removeClass("ui-state-focus")}),this.handles.each(function(b){a(this).data("index.ui-slider-handle",b)}),this.handles.keydown(function(d){var e=a(this).data("index.ui-slider-handle"),f,g,h,i;if(b.options.disabled)return;switch(d.keyCode){case a.ui.keyCode.HOME:case a.ui.keyCode.END:case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:d.preventDefault();if(!b._keySliding){b._keySliding=!0,a(this).addClass("ui-state-active"),f=b._start(d,e);if(f===!1)return}}i=b.options.step,b.options.values&&b.options.values.length?g=h=b.values(e):g=h=b.value();switch(d.keyCode){case a.ui.keyCode.HOME:h=b._valueMin();break;case a.ui.keyCode.END:h=b._valueMax();break;case a.ui.keyCode.PAGE_UP:h=b._trimAlignValue(g+(b._valueMax()-b._valueMin())/c);break;case a.ui.keyCode.PAGE_DOWN:h=b._trimAlignValue(g-(b._valueMax()-b._valueMin())/c);break;case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:if(g===b._valueMax())return;h=b._trimAlignValue(g+i);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:if(g===b._valueMin())return;h=b._trimAlignValue(g-i)}b._slide(d,e,h)}).keyup(function(c){var d=a(this).data("index.ui-slider-handle");b._keySliding&&(b._keySliding=!1,b._stop(c,d),b._change(c,d),a(this).removeClass("ui-state-active"))}),this._refreshValue(),this._animateOff=!1},destroy:function(){return this.handles.remove(),this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all").removeData("slider").unbind(".slider"),this._mouseDestroy(),this},_mouseCapture:function(b){var c=this.options,d,e,f,g,h,i,j,k,l;return c.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),d={x:b.pageX,y:b.pageY},e=this._normValueFromMouse(d),f=this._valueMax()-this._valueMin()+1,h=this,this.handles.each(function(b){var c=Math.abs(e-h.values(b));f>c&&(f=c,g=a(this),i=b)}),c.range===!0&&this.values(1)===c.min&&(i+=1,g=a(this.handles[i])),j=this._start(b,i),j===!1?!1:(this._mouseSliding=!0,h._handleIndex=i,g.addClass("ui-state-active").focus(),k=g.offset(),l=!a(b.target).parents().andSelf().is(".ui-slider-handle"),this._clickOffset=l?{left:0,top:0}:{left:b.pageX-k.left-g.width()/2,top:b.pageY-k.top-g.height()/2-(parseInt(g.css("borderTopWidth"),10)||0)-(parseInt(g.css("borderBottomWidth"),10)||0)+(parseInt(g.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(b,i,e),this._animateOff=!0,!0))},_mouseStart:function(a){return!0},_mouseDrag:function(a){var b={x:a.pageX,y:a.pageY},c=this._normValueFromMouse(b);return this._slide(a,this._handleIndex,c),!1},_mouseStop:function(a){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(a,this._handleIndex),this._change(a,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation=this.options.orientation==="vertical"?"vertical":"horizontal"},_normValueFromMouse:function(a){var b,c,d,e,f;return this.orientation==="horizontal"?(b=this.elementSize.width,c=a.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(b=this.elementSize.height,c=a.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),d=c/b,d>1&&(d=1),d<0&&(d=0),this.orientation==="vertical"&&(d=1-d),e=this._valueMax()-this._valueMin(),f=this._valueMin()+d*e,this._trimAlignValue(f)},_start:function(a,b){var c={handle:this.handles[b],value:this.value()};return this.options.values&&this.options.values.length&&(c.value=this.values(b),c.values=this.values()),this._trigger("start",a,c)},_slide:function(a,b,c){var d,e,f;this.options.values&&this.options.values.length?(d=this.values(b?0:1),this.options.values.length===2&&this.options.range===!0&&(b===0&&c>d||b===1&&c<d)&&(c=d),c!==this.values(b)&&(e=this.values(),e[b]=c,f=this._trigger("slide",a,{handle:this.handles[b],value:c,values:e}),d=this.values(b?0:1),f!==!1&&this.values(b,c,!0))):c!==this.value()&&(f=this._trigger("slide",a,{handle:this.handles[b],value:c}),f!==!1&&this.value(c))},_stop:function(a,b){var c={handle:this.handles[b],value:this.value()};this.options.values&&this.options.values.length&&(c.value=this.values(b),c.values=this.values()),this._trigger("stop",a,c)},_change:function(a,b){if(!this._keySliding&&!this._mouseSliding){var c={handle:this.handles[b],value:this.value()};this.options.values&&this.options.values.length&&(c.value=this.values(b),c.values=this.values()),this._trigger("change",a,c)}},value:function(a){if(arguments.length){this.options.value=this._trimAlignValue(a),this._refreshValue(),this._change(null,0);return}return this._value()},values:function(b,c){var d,e,f;if(arguments.length>1){this.options.values[b]=this._trimAlignValue(c),this._refreshValue(),this._change(null,b);return}if(!arguments.length)return this._values();if(!a.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(b):this.value();d=this.options.values,e=arguments[0];for(f=0;f<d.length;f+=1)d[f]=this._trimAlignValue(e[f]),this._change(null,f);this._refreshValue()},_setOption:function(b,c){var d,e=0;a.isArray(this.options.values)&&(e=this.options.values.length),a.Widget.prototype._setOption.apply(this,arguments);switch(b){case"disabled":c?(this.handles.filter(".ui-state-focus").blur(),this.handles.removeClass("ui-state-hover"),this.handles.propAttr("disabled",!0),this.element.addClass("ui-disabled")):(this.handles.propAttr("disabled",!1),this.element.removeClass("ui-disabled"));break;case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue();break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":this._animateOff=!0,this._refreshValue();for(d=0;d<e;d+=1)this._change(null,d);this._animateOff=!1}},_value:function(){var a=this.options.value;return a=this._trimAlignValue(a),a},_values:function(a){var b,c,d;if(arguments.length)return b=this.options.values[a],b=this._trimAlignValue(b),b;c=this.options.values.slice();for(d=0;d<c.length;d+=1)c[d]=this._trimAlignValue(c[d]);return c},_trimAlignValue:function(a){if(a<=this._valueMin())return this._valueMin();if(a>=this._valueMax())return this._valueMax();var b=this.options.step>0?this.options.step:1,c=(a-this._valueMin())%b,d=a-c;return Math.abs(c)*2>=b&&(d+=c>0?b:-b),parseFloat(d.toFixed(5))},_valueMin:function(){return this.options.min},_valueMax:function(){return this.options.max},_refreshValue:function(){var b=this.options.range,c=this.options,d=this,e=this._animateOff?!1:c.animate,f,g={},h,i,j,k;this.options.values&&this.options.values.length?this.handles.each(function(b,i){f=(d.values(b)-d._valueMin())/(d._valueMax()-d._valueMin())*100,g[d.orientation==="horizontal"?"left":"bottom"]=f+"%",a(this).stop(1,1)[e?"animate":"css"](g,c.animate),d.options.range===!0&&(d.orientation==="horizontal"?(b===0&&d.range.stop(1,1)[e?"animate":"css"]({left:f+"%"},c.animate),b===1&&d.range[e?"animate":"css"]({width:f-h+"%"},{queue:!1,duration:c.animate})):(b===0&&d.range.stop(1,1)[e?"animate":"css"]({bottom:f+"%"},c.animate),b===1&&d.range[e?"animate":"css"]({height:f-h+"%"},{queue:!1,duration:c.animate}))),h=f}):(i=this.value(),j=this._valueMin(),k=this._valueMax(),f=k!==j?(i-j)/(k-j)*100:0,g[d.orientation==="horizontal"?"left":"bottom"]=f+"%",this.handle.stop(1,1)[e?"animate":"css"](g,c.animate),b==="min"&&this.orientation==="horizontal"&&this.range.stop(1,1)[e?"animate":"css"]({width:f+"%"},c.animate),b==="max"&&this.orientation==="horizontal"&&this.range[e?"animate":"css"]({width:100-f+"%"},{queue:!1,duration:c.animate}),b==="min"&&this.orientation==="vertical"&&this.range.stop(1,1)[e?"animate":"css"]({height:f+"%"},c.animate),b==="max"&&this.orientation==="vertical"&&this.range[e?"animate":"css"]({height:100-f+"%"},{queue:!1,duration:c.animate}))}}),a.extend(a.ui.slider,{version:"1.8.20"})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.tabs.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){function e(){return++c}function f(){return++d}var c=0,d=0;a.widget("ui.tabs",{options:{add:null,ajaxOptions:null,cache:!1,cookie:null,collapsible:!1,disable:null,disabled:[],enable:null,event:"click",fx:null,idPrefix:"ui-tabs-",load:null,panelTemplate:"<div></div>",remove:null,select:null,show:null,spinner:"<em>Loading&#8230;</em>",tabTemplate:"<li><a href='#{href}'><span>#{label}</span></a></li>"},_create:function(){this._tabify(!0)},_setOption:function(a,b){if(a=="selected"){if(this.options.collapsible&&b==this.options.selected)return;this.select(b)}else this.options[a]=b,this._tabify()},_tabId:function(a){return a.title&&a.title.replace(/\s/g,"_").replace(/[^\w\u00c0-\uFFFF-]/g,"")||this.options.idPrefix+e()},_sanitizeSelector:function(a){return a.replace(/:/g,"\\:")},_cookie:function(){var b=this.cookie||(this.cookie=this.options.cookie.name||"ui-tabs-"+f());return a.cookie.apply(null,[b].concat(a.makeArray(arguments)))},_ui:function(a,b){return{tab:a,panel:b,index:this.anchors.index(a)}},_cleanup:function(){this.lis.filter(".ui-state-processing").removeClass("ui-state-processing").find("span:data(label.tabs)").each(function(){var b=a(this);b.html(b.data("label.tabs")).removeData("label.tabs")})},_tabify:function(c){function m(b,c){b.css("display",""),!a.support.opacity&&c.opacity&&b[0].style.removeAttribute("filter")}var d=this,e=this.options,f=/^#.+/;this.list=this.element.find("ol,ul").eq(0),this.lis=a(" > li:has(a[href])",this.list),this.anchors=this.lis.map(function(){return a("a",this)[0]}),this.panels=a([]),this.anchors.each(function(b,c){var g=a(c).attr("href"),h=g.split("#")[0],i;h&&(h===location.toString().split("#")[0]||(i=a("base")[0])&&h===i.href)&&(g=c.hash,c.href=g);if(f.test(g))d.panels=d.panels.add(d.element.find(d._sanitizeSelector(g)));else if(g&&g!=="#"){a.data(c,"href.tabs",g),a.data(c,"load.tabs",g.replace(/#.*$/,""));var j=d._tabId(c);c.href="#"+j;var k=d.element.find("#"+j);k.length||(k=a(e.panelTemplate).attr("id",j).addClass("ui-tabs-panel ui-widget-content ui-corner-bottom").insertAfter(d.panels[b-1]||d.list),k.data("destroy.tabs",!0)),d.panels=d.panels.add(k)}else e.disabled.push(b)}),c?(this.element.addClass("ui-tabs ui-widget ui-widget-content ui-corner-all"),this.list.addClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"),this.lis.addClass("ui-state-default ui-corner-top"),this.panels.addClass("ui-tabs-panel ui-widget-content ui-corner-bottom"),e.selected===b?(location.hash&&this.anchors.each(function(a,b){if(b.hash==location.hash)return e.selected=a,!1}),typeof e.selected!="number"&&e.cookie&&(e.selected=parseInt(d._cookie(),10)),typeof e.selected!="number"&&this.lis.filter(".ui-tabs-selected").length&&(e.selected=this.lis.index(this.lis.filter(".ui-tabs-selected"))),e.selected=e.selected||(this.lis.length?0:-1)):e.selected===null&&(e.selected=-1),e.selected=e.selected>=0&&this.anchors[e.selected]||e.selected<0?e.selected:0,e.disabled=a.unique(e.disabled.concat(a.map(this.lis.filter(".ui-state-disabled"),function(a,b){return d.lis.index(a)}))).sort(),a.inArray(e.selected,e.disabled)!=-1&&e.disabled.splice(a.inArray(e.selected,e.disabled),1),this.panels.addClass("ui-tabs-hide"),this.lis.removeClass("ui-tabs-selected ui-state-active"),e.selected>=0&&this.anchors.length&&(d.element.find(d._sanitizeSelector(d.anchors[e.selected].hash)).removeClass("ui-tabs-hide"),this.lis.eq(e.selected).addClass("ui-tabs-selected ui-state-active"),d.element.queue("tabs",function(){d._trigger("show",null,d._ui(d.anchors[e.selected],d.element.find(d._sanitizeSelector(d.anchors[e.selected].hash))[0]))}),this.load(e.selected)),a(window).bind("unload",function(){d.lis.add(d.anchors).unbind(".tabs"),d.lis=d.anchors=d.panels=null})):e.selected=this.lis.index(this.lis.filter(".ui-tabs-selected")),this.element[e.collapsible?"addClass":"removeClass"]("ui-tabs-collapsible"),e.cookie&&this._cookie(e.selected,e.cookie);for(var g=0,h;h=this.lis[g];g++)a(h)[a.inArray(g,e.disabled)!=-1&&!a(h).hasClass("ui-tabs-selected")?"addClass":"removeClass"]("ui-state-disabled");e.cache===!1&&this.anchors.removeData("cache.tabs"),this.lis.add(this.anchors).unbind(".tabs");if(e.event!=="mouseover"){var i=function(a,b){b.is(":not(.ui-state-disabled)")&&b.addClass("ui-state-"+a)},j=function(a,b){b.removeClass("ui-state-"+a)};this.lis.bind("mouseover.tabs",function(){i("hover",a(this))}),this.lis.bind("mouseout.tabs",function(){j("hover",a(this))}),this.anchors.bind("focus.tabs",function(){i("focus",a(this).closest("li"))}),this.anchors.bind("blur.tabs",function(){j("focus",a(this).closest("li"))})}var k,l;e.fx&&(a.isArray(e.fx)?(k=e.fx[0],l=e.fx[1]):k=l=e.fx);var n=l?function(b,c){a(b).closest("li").addClass("ui-tabs-selected ui-state-active"),c.hide().removeClass("ui-tabs-hide").animate(l,l.duration||"normal",function(){m(c,l),d._trigger("show",null,d._ui(b,c[0]))})}:function(b,c){a(b).closest("li").addClass("ui-tabs-selected ui-state-active"),c.removeClass("ui-tabs-hide"),d._trigger("show",null,d._ui(b,c[0]))},o=k?function(a,b){b.animate(k,k.duration||"normal",function(){d.lis.removeClass("ui-tabs-selected ui-state-active"),b.addClass("ui-tabs-hide"),m(b,k),d.element.dequeue("tabs")})}:function(a,b,c){d.lis.removeClass("ui-tabs-selected ui-state-active"),b.addClass("ui-tabs-hide"),d.element.dequeue("tabs")};this.anchors.bind(e.event+".tabs",function(){var b=this,c=a(b).closest("li"),f=d.panels.filter(":not(.ui-tabs-hide)"),g=d.element.find(d._sanitizeSelector(b.hash));if(c.hasClass("ui-tabs-selected")&&!e.collapsible||c.hasClass("ui-state-disabled")||c.hasClass("ui-state-processing")||d.panels.filter(":animated").length||d._trigger("select",null,d._ui(this,g[0]))===!1)return this.blur(),!1;e.selected=d.anchors.index(this),d.abort();if(e.collapsible){if(c.hasClass("ui-tabs-selected"))return e.selected=-1,e.cookie&&d._cookie(e.selected,e.cookie),d.element.queue("tabs",function(){o(b,f)}).dequeue("tabs"),this.blur(),!1;if(!f.length)return e.cookie&&d._cookie(e.selected,e.cookie),d.element.queue("tabs",function(){n(b,g)}),d.load(d.anchors.index(this)),this.blur(),!1}e.cookie&&d._cookie(e.selected,e.cookie);if(g.length)f.length&&d.element.queue("tabs",function(){o(b,f)}),d.element.queue("tabs",function(){n(b,g)}),d.load(d.anchors.index(this));else throw"jQuery UI Tabs: Mismatching fragment identifier.";a.browser.msie&&this.blur()}),this.anchors.bind("click.tabs",function(){return!1})},_getIndex:function(a){return typeof a=="string"&&(a=this.anchors.index(this.anchors.filter("[href$='"+a+"']"))),a},destroy:function(){var b=this.options;return this.abort(),this.element.unbind(".tabs").removeClass("ui-tabs ui-widget ui-widget-content ui-corner-all ui-tabs-collapsible").removeData("tabs"),this.list.removeClass("ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"),this.anchors.each(function(){var b=a.data(this,"href.tabs");b&&(this.href=b);var c=a(this).unbind(".tabs");a.each(["href","load","cache"],function(a,b){c.removeData(b+".tabs")})}),this.lis.unbind(".tabs").add(this.panels).each(function(){a.data(this,"destroy.tabs")?a(this).remove():a(this).removeClass(["ui-state-default","ui-corner-top","ui-tabs-selected","ui-state-active","ui-state-hover","ui-state-focus","ui-state-disabled","ui-tabs-panel","ui-widget-content","ui-corner-bottom","ui-tabs-hide"].join(" "))}),b.cookie&&this._cookie(null,b.cookie),this},add:function(c,d,e){e===b&&(e=this.anchors.length);var f=this,g=this.options,h=a(g.tabTemplate.replace(/#\{href\}/g,c).replace(/#\{label\}/g,d)),i=c.indexOf("#")?this._tabId(a("a",h)[0]):c.replace("#","");h.addClass("ui-state-default ui-corner-top").data("destroy.tabs",!0);var j=f.element.find("#"+i);return j.length||(j=a(g.panelTemplate).attr("id",i).data("destroy.tabs",!0)),j.addClass("ui-tabs-panel ui-widget-content ui-corner-bottom ui-tabs-hide"),e>=this.lis.length?(h.appendTo(this.list),j.appendTo(this.list[0].parentNode)):(h.insertBefore(this.lis[e]),j.insertBefore(this.panels[e])),g.disabled=a.map(g.disabled,function(a,b){return a>=e?++a:a}),this._tabify(),this.anchors.length==1&&(g.selected=0,h.addClass("ui-tabs-selected ui-state-active"),j.removeClass("ui-tabs-hide"),this.element.queue("tabs",function(){f._trigger("show",null,f._ui(f.anchors[0],f.panels[0]))}),this.load(0)),this._trigger("add",null,this._ui(this.anchors[e],this.panels[e])),this},remove:function(b){b=this._getIndex(b);var c=this.options,d=this.lis.eq(b).remove(),e=this.panels.eq(b).remove();return d.hasClass("ui-tabs-selected")&&this.anchors.length>1&&this.select(b+(b+1<this.anchors.length?1:-1)),c.disabled=a.map(a.grep(c.disabled,function(a,c){return a!=b}),function(a,c){return a>=b?--a:a}),this._tabify(),this._trigger("remove",null,this._ui(d.find("a")[0],e[0])),this},enable:function(b){b=this._getIndex(b);var c=this.options;if(a.inArray(b,c.disabled)==-1)return;return this.lis.eq(b).removeClass("ui-state-disabled"),c.disabled=a.grep(c.disabled,function(a,c){return a!=b}),this._trigger("enable",null,this._ui(this.anchors[b],this.panels[b])),this},disable:function(a){a=this._getIndex(a);var b=this,c=this.options;return a!=c.selected&&(this.lis.eq(a).addClass("ui-state-disabled"),c.disabled.push(a),c.disabled.sort(),this._trigger("disable",null,this._ui(this.anchors[a],this.panels[a]))),this},select:function(a){a=this._getIndex(a);if(a==-1)if(this.options.collapsible&&this.options.selected!=-1)a=this.options.selected;else return this;return this.anchors.eq(a).trigger(this.options.event+".tabs"),this},load:function(b){b=this._getIndex(b);var c=this,d=this.options,e=this.anchors.eq(b)[0],f=a.data(e,"load.tabs");this.abort();if(!f||this.element.queue("tabs").length!==0&&a.data(e,"cache.tabs")){this.element.dequeue("tabs");return}this.lis.eq(b).addClass("ui-state-processing");if(d.spinner){var g=a("span",e);g.data("label.tabs",g.html()).html(d.spinner)}return this.xhr=a.ajax(a.extend({},d.ajaxOptions,{url:f,success:function(f,g){c.element.find(c._sanitizeSelector(e.hash)).html(f),c._cleanup(),d.cache&&a.data(e,"cache.tabs",!0),c._trigger("load",null,c._ui(c.anchors[b],c.panels[b]));try{d.ajaxOptions.success(f,g)}catch(h){}},error:function(a,f,g){c._cleanup(),c._trigger("load",null,c._ui(c.anchors[b],c.panels[b]));try{d.ajaxOptions.error(a,f,b,e)}catch(g){}}})),c.element.dequeue("tabs"),this},abort:function(){return this.element.queue([]),this.panels.stop(!1,!0),this.element.queue("tabs",this.element.queue("tabs").splice(-2,2)),this.xhr&&(this.xhr.abort(),delete this.xhr),this._cleanup(),this},url:function(a,b){return this.anchors.eq(a).removeData("cache.tabs").data("load.tabs",b),this},length:function(){return this.anchors.length}}),a.extend(a.ui.tabs,{version:"1.8.20"}),a.extend(a.ui.tabs.prototype,{rotation:null,rotate:function(a,b){var c=this,d=this.options,e=c._rotate||(c._rotate=function(b){clearTimeout(c.rotation),c.rotation=setTimeout(function(){var a=d.selected;c.select(++a<c.anchors.length?a:0)},a),b&&b.stopPropagation()}),f=c._unrotate||(c._unrotate=b?function(a){e()}:function(a){a.clientX&&c.rotate(null)});return a?(this.element.bind("tabsshow",e),this.anchors.bind(d.event+".tabs",f),e()):(clearTimeout(c.rotation),this.element.unbind("tabsshow",e),this.anchors.unbind(d.event+".tabs",f),delete this._rotate,delete this._unrotate),this}})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.datepicker.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function($,undefined){function Datepicker(){this.debug=!1,this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},$.extend(this._defaults,this.regional[""]),this.dpDiv=bindHover($('<div id="'+this._mainDivId+'" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>'))}function bindHover(a){var b="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return a.bind("mouseout",function(a){var c=$(a.target).closest(b);if(!c.length)return;c.removeClass("ui-state-hover ui-datepicker-prev-hover ui-datepicker-next-hover")}).bind("mouseover",function(c){var d=$(c.target).closest(b);if($.datepicker._isDisabledDatepicker(instActive.inline?a.parent()[0]:instActive.input[0])||!d.length)return;d.parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),d.addClass("ui-state-hover"),d.hasClass("ui-datepicker-prev")&&d.addClass("ui-datepicker-prev-hover"),d.hasClass("ui-datepicker-next")&&d.addClass("ui-datepicker-next-hover")})}function extendRemove(a,b){$.extend(a,b);for(var c in b)if(b[c]==null||b[c]==undefined)a[c]=b[c];return a}function isArray(a){return a&&($.browser.safari&&typeof a=="object"&&a.length||a.constructor&&a.constructor.toString().match(/\Array\(\)/))}$.extend($.ui,{datepicker:{version:"1.8.20"}});var PROP_NAME="datepicker",dpuuid=(new Date).getTime(),instActive;$.extend(Datepicker.prototype,{markerClassName:"hasDatepicker",maxRows:4,log:function(){this.debug&&console.log.apply("",arguments)},_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(a){return extendRemove(this._defaults,a||{}),this},_attachDatepicker:function(target,settings){var inlineSettings=null;for(var attrName in this._defaults){var attrValue=target.getAttribute("date:"+attrName);if(attrValue){inlineSettings=inlineSettings||{};try{inlineSettings[attrName]=eval(attrValue)}catch(err){inlineSettings[attrName]=attrValue}}}var nodeName=target.nodeName.toLowerCase(),inline=nodeName=="div"||nodeName=="span";target.id||(this.uuid+=1,target.id="dp"+this.uuid);var inst=this._newInst($(target),inline);inst.settings=$.extend({},settings||{},inlineSettings||{}),nodeName=="input"?this._connectDatepicker(target,inst):inline&&this._inlineDatepicker(target,inst)},_newInst:function(a,b){var c=a[0].id.replace(/([^A-Za-z0-9_-])/g,"\\\\$1");return{id:c,input:a,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:b,dpDiv:b?bindHover($('<div class="'+this._inlineClass+' ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>')):this.dpDiv}},_connectDatepicker:function(a,b){var c=$(a);b.append=$([]),b.trigger=$([]);if(c.hasClass(this.markerClassName))return;this._attachments(c,b),c.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp).bind("setData.datepicker",function(a,c,d){b.settings[c]=d}).bind("getData.datepicker",function(a,c){return this._get(b,c)}),this._autoSize(b),$.data(a,PROP_NAME,b),b.settings.disabled&&this._disableDatepicker(a)},_attachments:function(a,b){var c=this._get(b,"appendText"),d=this._get(b,"isRTL");b.append&&b.append.remove(),c&&(b.append=$('<span class="'+this._appendClass+'">'+c+"</span>"),a[d?"before":"after"](b.append)),a.unbind("focus",this._showDatepicker),b.trigger&&b.trigger.remove();var e=this._get(b,"showOn");(e=="focus"||e=="both")&&a.focus(this._showDatepicker);if(e=="button"||e=="both"){var f=this._get(b,"buttonText"),g=this._get(b,"buttonImage");b.trigger=$(this._get(b,"buttonImageOnly")?$("<img/>").addClass(this._triggerClass).attr({src:g,alt:f,title:f}):$('<button type="button"></button>').addClass(this._triggerClass).html(g==""?f:$("<img/>").attr({src:g,alt:f,title:f}))),a[d?"before":"after"](b.trigger),b.trigger.click(function(){return $.datepicker._datepickerShowing&&$.datepicker._lastInput==a[0]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&&$.datepicker._lastInput!=a[0]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(a[0])):$.datepicker._showDatepicker(a[0]),!1})}},_autoSize:function(a){if(this._get(a,"autoSize")&&!a.inline){var b=new Date(2009,11,20),c=this._get(a,"dateFormat");if(c.match(/[DM]/)){var d=function(a){var b=0,c=0;for(var d=0;d<a.length;d++)a[d].length>b&&(b=a[d].length,c=d);return c};b.setMonth(d(this._get(a,c.match(/MM/)?"monthNames":"monthNamesShort"))),b.setDate(d(this._get(a,c.match(/DD/)?"dayNames":"dayNamesShort"))+20-b.getDay())}a.input.attr("size",this._formatDate(a,b).length)}},_inlineDatepicker:function(a,b){var c=$(a);if(c.hasClass(this.markerClassName))return;c.addClass(this.markerClassName).append(b.dpDiv).bind("setData.datepicker",function(a,c,d){b.settings[c]=d}).bind("getData.datepicker",function(a,c){return this._get(b,c)}),$.data(a,PROP_NAME,b),this._setDate(b,this._getDefaultDate(b),!0),this._updateDatepicker(b),this._updateAlternate(b),b.settings.disabled&&this._disableDatepicker(a),b.dpDiv.css("display","block")},_dialogDatepicker:function(a,b,c,d,e){var f=this._dialogInst;if(!f){this.uuid+=1;var g="dp"+this.uuid;this._dialogInput=$('<input type="text" id="'+g+'" style="position: absolute; top: -100px; width: 0px; z-index: -10;"/>'),this._dialogInput.keydown(this._doKeyDown),$("body").append(this._dialogInput),f=this._dialogInst=this._newInst(this._dialogInput,!1),f.settings={},$.data(this._dialogInput[0],PROP_NAME,f)}extendRemove(f.settings,d||{}),b=b&&b.constructor==Date?this._formatDate(f,b):b,this._dialogInput.val(b),this._pos=e?e.length?e:[e.pageX,e.pageY]:null;if(!this._pos){var h=document.documentElement.clientWidth,i=document.documentElement.clientHeight,j=document.documentElement.scrollLeft||document.body.scrollLeft,k=document.documentElement.scrollTop||document.body.scrollTop;this._pos=[h/2-100+j,i/2-150+k]}return this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),f.settings.onSelect=c,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),$.blockUI&&$.blockUI(this.dpDiv),$.data(this._dialogInput[0],PROP_NAME,f),this},_destroyDatepicker:function(a){var b=$(a),c=$.data(a,PROP_NAME);if(!b.hasClass(this.markerClassName))return;var d=a.nodeName.toLowerCase();$.removeData(a,PROP_NAME),d=="input"?(c.append.remove(),c.trigger.remove(),b.removeClass(this.markerClassName).unbind("focus",this._showDatepicker).unbind("keydown",this._doKeyDown).unbind("keypress",this._doKeyPress).unbind("keyup",this._doKeyUp)):(d=="div"||d=="span")&&b.removeClass(this.markerClassName).empty()},_enableDatepicker:function(a){var b=$(a),c=$.data(a,PROP_NAME);if(!b.hasClass(this.markerClassName))return;var d=a.nodeName.toLowerCase();if(d=="input")a.disabled=!1,c.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""});else if(d=="div"||d=="span"){var e=b.children("."+this._inlineClass);e.children().removeClass("ui-state-disabled"),e.find("select.ui-datepicker-month, select.ui-datepicker-year").removeAttr("disabled")}this._disabledInputs=$.map(this._disabledInputs,function(b){return b==a?null:b})},_disableDatepicker:function(a){var b=$(a),c=$.data(a,PROP_NAME);if(!b.hasClass(this.markerClassName))return;var d=a.nodeName.toLowerCase();if(d=="input")a.disabled=!0,c.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"});else if(d=="div"||d=="span"){var e=b.children("."+this._inlineClass);e.children().addClass("ui-state-disabled"),e.find("select.ui-datepicker-month, select.ui-datepicker-year").attr("disabled","disabled")}this._disabledInputs=$.map(this._disabledInputs,function(b){return b==a?null:b}),this._disabledInputs[this._disabledInputs.length]=a},_isDisabledDatepicker:function(a){if(!a)return!1;for(var b=0;b<this._disabledInputs.length;b++)if(this._disabledInputs[b]==a)return!0;return!1},_getInst:function(a){try{return $.data(a,PROP_NAME)}catch(b){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(a,b,c){var d=this._getInst(a);if(arguments.length==2&&typeof b=="string")return b=="defaults"?$.extend({},$.datepicker._defaults):d?b=="all"?$.extend({},d.settings):this._get(d,b):null;var e=b||{};typeof b=="string"&&(e={},e[b]=c);if(d){this._curInst==d&&this._hideDatepicker();var f=this._getDateDatepicker(a,!0),g=this._getMinMaxDate(d,"min"),h=this._getMinMaxDate(d,"max");extendRemove(d.settings,e),g!==null&&e.dateFormat!==undefined&&e.minDate===undefined&&(d.settings.minDate=this._formatDate(d,g)),h!==null&&e.dateFormat!==undefined&&e.maxDate===undefined&&(d.settings.maxDate=this._formatDate(d,h)),this._attachments($(a),d),this._autoSize(d),this._setDate(d,f),this._updateAlternate(d),this._updateDatepicker(d)}},_changeDatepicker:function(a,b,c){this._optionDatepicker(a,b,c)},_refreshDatepicker:function(a){var b=this._getInst(a);b&&this._updateDatepicker(b)},_setDateDatepicker:function(a,b){var c=this._getInst(a);c&&(this._setDate(c,b),this._updateDatepicker(c),this._updateAlternate(c))},_getDateDatepicker:function(a,b){var c=this._getInst(a);return c&&!c.inline&&this._setDateFromField(c,b),c?this._getDate(c):null},_doKeyDown:function(a){var b=$.datepicker._getInst(a.target),c=!0,d=b.dpDiv.is(".ui-datepicker-rtl");b._keyEvent=!0;if($.datepicker._datepickerShowing)switch(a.keyCode){case 9:$.datepicker._hideDatepicker(),c=!1;break;case 13:var e=$("td."+$.datepicker._dayOverClass+":not(."+$.datepicker._currentClass+")",b.dpDiv);e[0]&&$.datepicker._selectDay(a.target,b.selectedMonth,b.selectedYear,e[0]);var f=$.datepicker._get(b,"onSelect");if(f){var g=$.datepicker._formatDate(b);f.apply(b.input?b.input[0]:null,[g,b])}else $.datepicker._hideDatepicker();return!1;case 27:$.datepicker._hideDatepicker();break;case 33:$.datepicker._adjustDate(a.target,a.ctrlKey?-$.datepicker._get(b,"stepBigMonths"):-$.datepicker._get(b,"stepMonths"),"M");break;case 34:$.datepicker._adjustDate(a.target,a.ctrlKey?+$.datepicker._get(b,"stepBigMonths"):+$.datepicker._get(b,"stepMonths"),"M");break;case 35:(a.ctrlKey||a.metaKey)&&$.datepicker._clearDate(a.target),c=a.ctrlKey||a.metaKey;break;case 36:(a.ctrlKey||a.metaKey)&&$.datepicker._gotoToday(a.target),c=a.ctrlKey||a.metaKey;break;case 37:(a.ctrlKey||a.metaKey)&&$.datepicker._adjustDate(a.target,d?1:-1,"D"),c=a.ctrlKey||a.metaKey,a.originalEvent.altKey&&$.datepicker._adjustDate(a.target,a.ctrlKey?-$.datepicker._get(b,"stepBigMonths"):-$.datepicker._get(b,"stepMonths"),"M");break;case 38:(a.ctrlKey||a.metaKey)&&$.datepicker._adjustDate(a.target,-7,"D"),c=a.ctrlKey||a.metaKey;break;case 39:(a.ctrlKey||a.metaKey)&&$.datepicker._adjustDate(a.target,d?-1:1,"D"),c=a.ctrlKey||a.metaKey,a.originalEvent.altKey&&$.datepicker._adjustDate(a.target,a.ctrlKey?+$.datepicker._get(b,"stepBigMonths"):+$.datepicker._get(b,"stepMonths"),"M");break;case 40:(a.ctrlKey||a.metaKey)&&$.datepicker._adjustDate(a.target,7,"D"),c=a.ctrlKey||a.metaKey;break;default:c=!1}else a.keyCode==36&&a.ctrlKey?$.datepicker._showDatepicker(this):c=!1;c&&(a.preventDefault(),a.stopPropagation())},_doKeyPress:function(a){var b=$.datepicker._getInst(a.target);if($.datepicker._get(b,"constrainInput")){var c=$.datepicker._possibleChars($.datepicker._get(b,"dateFormat")),d=String.fromCharCode(a.charCode==undefined?a.keyCode:a.charCode);return a.ctrlKey||a.metaKey||d<" "||!c||c.indexOf(d)>-1}},_doKeyUp:function(a){var b=$.datepicker._getInst(a.target);if(b.input.val()!=b.lastVal)try{var c=$.datepicker.parseDate($.datepicker._get(b,"dateFormat"),b.input?b.input.val():null,$.datepicker._getFormatConfig(b));c&&($.datepicker._setDateFromField(b),$.datepicker._updateAlternate(b),$.datepicker._updateDatepicker(b))}catch(d){$.datepicker.log(d)}return!0},_showDatepicker:function(a){a=a.target||a,a.nodeName.toLowerCase()!="input"&&(a=$("input",a.parentNode)[0]);if($.datepicker._isDisabledDatepicker(a)||$.datepicker._lastInput==a)return;var b=$.datepicker._getInst(a);$.datepicker._curInst&&$.datepicker._curInst!=b&&($.datepicker._curInst.dpDiv.stop(!0,!0),b&&$.datepicker._datepickerShowing&&$.datepicker._hideDatepicker($.datepicker._curInst.input[0]));var c=$.datepicker._get(b,"beforeShow"),d=c?c.apply(a,[a,b]):{};if(d===!1)return;extendRemove(b.settings,d),b.lastVal=null,$.datepicker._lastInput=a,$.datepicker._setDateFromField(b),$.datepicker._inDialog&&(a.value=""),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(a),$.datepicker._pos[1]+=a.offsetHeight);var e=!1;$(a).parents().each(function(){return e|=$(this).css("position")=="fixed",!e}),e&&$.browser.opera&&($.datepicker._pos[0]-=document.documentElement.scrollLeft,$.datepicker._pos[1]-=document.documentElement.scrollTop);var f={left:$.datepicker._pos[0],top:$.datepicker._pos[1]};$.datepicker._pos=null,b.dpDiv.empty(),b.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),$.datepicker._updateDatepicker(b),f=$.datepicker._checkOffset(b,f,e),b.dpDiv.css({position:$.datepicker._inDialog&&$.blockUI?"static":e?"fixed":"absolute",display:"none",left:f.left+"px",top:f.top+"px"});if(!b.inline){var g=$.datepicker._get(b,"showAnim"),h=$.datepicker._get(b,"duration"),i=function(){var a=b.dpDiv.find("iframe.ui-datepicker-cover");if(!!a.length){var c=$.datepicker._getBorders(b.dpDiv);a.css({left:-c[0],top:-c[1],width:b.dpDiv.outerWidth(),height:b.dpDiv.outerHeight()})}};b.dpDiv.zIndex($(a).zIndex()+1),$.datepicker._datepickerShowing=!0,$.effects&&$.effects[g]?b.dpDiv.show(g,$.datepicker._get(b,"showOptions"),h,i):b.dpDiv[g||"show"](g?h:null,i),(!g||!h)&&i(),b.input.is(":visible")&&!b.input.is(":disabled")&&b.input.focus(),$.datepicker._curInst=b}},_updateDatepicker:function(a){var b=this;b.maxRows=4;var c=$.datepicker._getBorders(a.dpDiv);instActive=a,a.dpDiv.empty().append(this._generateHTML(a));var d=a.dpDiv.find("iframe.ui-datepicker-cover");!d.length||d.css({left:-c[0],top:-c[1],width:a.dpDiv.outerWidth(),height:a.dpDiv.outerHeight()}),a.dpDiv.find("."+this._dayOverClass+" a").mouseover();var e=this._getNumberOfMonths(a),f=e[1],g=17;a.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),f>1&&a.dpDiv.addClass("ui-datepicker-multi-"+f).css("width",g*f+"em"),a.dpDiv[(e[0]!=1||e[1]!=1?"add":"remove")+"Class"]("ui-datepicker-multi"),a.dpDiv[(this._get(a,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),a==$.datepicker._curInst&&$.datepicker._datepickerShowing&&a.input&&a.input.is(":visible")&&!a.input.is(":disabled")&&a.input[0]!=document.activeElement&&a.input.focus();if(a.yearshtml){var h=a.yearshtml;setTimeout(function(){h===a.yearshtml&&a.yearshtml&&a.dpDiv.find("select.ui-datepicker-year:first").replaceWith(a.yearshtml),h=a.yearshtml=null},0)}},_getBorders:function(a){var b=function(a){return{thin:1,medium:2,thick:3}[a]||a};return[parseFloat(b(a.css("border-left-width"))),parseFloat(b(a.css("border-top-width")))]},_checkOffset:function(a,b,c){var d=a.dpDiv.outerWidth(),e=a.dpDiv.outerHeight(),f=a.input?a.input.outerWidth():0,g=a.input?a.input.outerHeight():0,h=document.documentElement.clientWidth+$(document).scrollLeft(),i=document.documentElement.clientHeight+$(document).scrollTop();return b.left-=this._get(a,"isRTL")?d-f:0,b.left-=c&&b.left==a.input.offset().left?$(document).scrollLeft():0,b.top-=c&&b.top==a.input.offset().top+g?$(document).scrollTop():0,b.left-=Math.min(b.left,b.left+d>h&&h>d?Math.abs(b.left+d-h):0),b.top-=Math.min(b.top,b.top+e>i&&i>e?Math.abs(e+g):0),b},_findPos:function(a){var b=this._getInst(a),c=this._get(b,"isRTL");while(a&&(a.type=="hidden"||a.nodeType!=1||$.expr.filters.hidden(a)))a=a[c?"previousSibling":"nextSibling"];var d=$(a).offset();return[d.left,d.top]},_hideDatepicker:function(a){var b=this._curInst;if(!b||a&&b!=$.data(a,PROP_NAME))return;if(this._datepickerShowing){var c=this._get(b,"showAnim"),d=this._get(b,"duration"),e=function(){$.datepicker._tidyDialog(b)};$.effects&&$.effects[c]?b.dpDiv.hide(c,$.datepicker._get(b,"showOptions"),d,e):b.dpDiv[c=="slideDown"?"slideUp":c=="fadeIn"?"fadeOut":"hide"](c?d:null,e),c||e(),this._datepickerShowing=!1;var f=this._get(b,"onClose");f&&f.apply(b.input?b.input[0]:null,[b.input?b.input.val():"",b]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),$.blockUI&&($.unblockUI(),$("body").append(this.dpDiv))),this._inDialog=!1}},_tidyDialog:function(a){a.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar")},_checkExternalClick:function(a){if(!$.datepicker._curInst)return;var b=$(a.target),c=$.datepicker._getInst(b[0]);(b[0].id!=$.datepicker._mainDivId&&b.parents("#"+$.datepicker._mainDivId).length==0&&!b.hasClass($.datepicker.markerClassName)&&!b.closest("."+$.datepicker._triggerClass).length&&$.datepicker._datepickerShowing&&(!$.datepicker._inDialog||!$.blockUI)||b.hasClass($.datepicker.markerClassName)&&$.datepicker._curInst!=c)&&$.datepicker._hideDatepicker()},_adjustDate:function(a,b,c){var d=$(a),e=this._getInst(d[0]);if(this._isDisabledDatepicker(d[0]))return;this._adjustInstDate(e,b+(c=="M"?this._get(e,"showCurrentAtPos"):0),c),this._updateDatepicker(e)},_gotoToday:function(a){var b=$(a),c=this._getInst(b[0]);if(this._get(c,"gotoCurrent")&&c.currentDay)c.selectedDay=c.currentDay,c.drawMonth=c.selectedMonth=c.currentMonth,c.drawYear=c.selectedYear=c.currentYear;else{var d=new Date;c.selectedDay=d.getDate(),c.drawMonth=c.selectedMonth=d.getMonth(),c.drawYear=c.selectedYear=d.getFullYear()}this._notifyChange(c),this._adjustDate(b)},_selectMonthYear:function(a,b,c){var d=$(a),e=this._getInst(d[0]);e["selected"+(c=="M"?"Month":"Year")]=e["draw"+(c=="M"?"Month":"Year")]=parseInt(b.options[b.selectedIndex].value,10),this._notifyChange(e),this._adjustDate(d)},_selectDay:function(a,b,c,d){var e=$(a);if($(d).hasClass(this._unselectableClass)||this._isDisabledDatepicker(e[0]))return;var f=this._getInst(e[0]);f.selectedDay=f.currentDay=$("a",d).html(),f.selectedMonth=f.currentMonth=b,f.selectedYear=f.currentYear=c,this._selectDate(a,this._formatDate(f,f.currentDay,f.currentMonth,f.currentYear))},_clearDate:function(a){var b=$(a),c=this._getInst(b[0]);this._selectDate(b,"")},_selectDate:function(a,b){var c=$(a),d=this._getInst(c[0]);b=b!=null?b:this._formatDate(d),d.input&&d.input.val(b),this._updateAlternate(d);var e=this._get(d,"onSelect");e?e.apply(d.input?d.input[0]:null,[b,d]):d.input&&d.input.trigger("change"),d.inline?this._updateDatepicker(d):(this._hideDatepicker(),this._lastInput=d.input[0],typeof d.input[0]!="object"&&d.input.focus(),this._lastInput=null)},_updateAlternate:function(a){var b=this._get(a,"altField");if(b){var c=this._get(a,"altFormat")||this._get(a,"dateFormat"),d=this._getDate(a),e=this.formatDate(c,d,this._getFormatConfig(a));$(b).each(function(){$(this).val(e)})}},noWeekends:function(a){var b=a.getDay();return[b>0&&b<6,""]},iso8601Week:function(a){var b=new Date(a.getTime());b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1},parseDate:function(a,b,c){if(a==null||b==null)throw"Invalid arguments";b=typeof b=="object"?b.toString():b+"";if(b=="")return null;var d=(c?c.shortYearCutoff:null)||this._defaults.shortYearCutoff;d=typeof d!="string"?d:(new Date).getFullYear()%100+parseInt(d,10);var e=(c?c.dayNamesShort:null)||this._defaults.dayNamesShort,f=(c?c.dayNames:null)||this._defaults.dayNames,g=(c?c.monthNamesShort:null)||this._defaults.monthNamesShort,h=(c?c.monthNames:null)||this._defaults.monthNames,i=-1,j=-1,k=-1,l=-1,m=!1,n=function(b){var c=s+1<a.length&&a.charAt(s+1)==b;return c&&s++,c},o=function(a){var c=n(a),d=a=="@"?14:a=="!"?20:a=="y"&&c?4:a=="o"?3:2,e=new RegExp("^\\d{1,"+d+"}"),f=b.substring(r).match(e);if(!f)throw"Missing number at position "+r;return r+=f[0].length,parseInt(f[0],10)},p=function(a,c,d){var e=$.map(n(a)?d:c,function(a,b){return[[b,a]]}).sort(function(a,b){return-(a[1].length-b[1].length)}),f=-1;$.each(e,function(a,c){var d=c[1];if(b.substr(r,d.length).toLowerCase()==d.toLowerCase())return f=c[0],r+=d.length,!1});if(f!=-1)return f+1;throw"Unknown name at position "+r},q=function(){if(b.charAt(r)!=a.charAt(s))throw"Unexpected literal at position "+r;r++},r=0;for(var s=0;s<a.length;s++)if(m)a.charAt(s)=="'"&&!n("'")?m=!1:q();else switch(a.charAt(s)){case"d":k=o("d");break;case"D":p("D",e,f);break;case"o":l=o("o");break;case"m":j=o("m");break;case"M":j=p("M",g,h);break;case"y":i=o("y");break;case"@":var t=new Date(o("@"));i=t.getFullYear(),j=t.getMonth()+1,k=t.getDate();break;case"!":var t=new Date((o("!")-this._ticksTo1970)/1e4);i=t.getFullYear(),j=t.getMonth()+1,k=t.getDate();break;case"'":n("'")?q():m=!0;break;default:q()}if(r<b.length)throw"Extra/unparsed characters found in date: "+b.substring(r);i==-1?i=(new Date).getFullYear():i<100&&(i+=(new Date).getFullYear()-(new Date).getFullYear()%100+(i<=d?0:-100));if(l>-1){j=1,k=l;do{var u=this._getDaysInMonth(i,j-1);if(k<=u)break;j++,k-=u}while(!0)}var t=this._daylightSavingAdjust(new Date(i,j-1,k));if(t.getFullYear()!=i||t.getMonth()+1!=j||t.getDate()!=k)throw"Invalid date";return t},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925))*24*60*60*1e7,formatDate:function(a,b,c){if(!b)return"";var d=(c?c.dayNamesShort:null)||this._defaults.dayNamesShort,e=(c?c.dayNames:null)||this._defaults.dayNames,f=(c?c.monthNamesShort:null)||this._defaults.monthNamesShort,g=(c?c.monthNames:null)||this._defaults.monthNames,h=function(b){var c=m+1<a.length&&a.charAt(m+1)==b;return c&&m++,c},i=function(a,b,c){var d=""+b;if(h(a))while(d.length<c)d="0"+d;return d},j=function(a,b,c,d){return h(a)?d[b]:c[b]},k="",l=!1;if(b)for(var m=0;m<a.length;m++)if(l)a.charAt(m)=="'"&&!h("'")?l=!1:k+=a.charAt(m);else switch(a.charAt(m)){case"d":k+=i("d",b.getDate(),2);break;case"D":k+=j("D",b.getDay(),d,e);break;case"o":k+=i("o",Math.round(((new Date(b.getFullYear(),b.getMonth(),b.getDate())).getTime()-(new Date(b.getFullYear(),0,0)).getTime())/864e5),3);break;case"m":k+=i("m",b.getMonth()+1,2);break;case"M":k+=j("M",b.getMonth(),f,g);break;case"y":k+=h("y")?b.getFullYear():(b.getYear()%100<10?"0":"")+b.getYear()%100;break;case"@":k+=b.getTime();break;case"!":k+=b.getTime()*1e4+this._ticksTo1970;break;case"'":h("'")?k+="'":l=!0;break;default:k+=a.charAt(m)}return k},_possibleChars:function(a){var b="",c=!1,d=function(b){var c=e+1<a.length&&a.charAt(e+1)==b;return c&&e++,c};for(var e=0;e<a.length;e++)if(c)a.charAt(e)=="'"&&!d("'")?c=!1:b+=a.charAt(e);else switch(a.charAt(e)){case"d":case"m":case"y":case"@":b+="0123456789";break;case"D":case"M":return null;case"'":d("'")?b+="'":c=!0;break;default:b+=a.charAt(e)}return b},_get:function(a,b){return a.settings[b]!==undefined?a.settings[b]:this._defaults[b]},_setDateFromField:function(a,b){if(a.input.val()==a.lastVal)return;var c=this._get(a,"dateFormat"),d=a.lastVal=a.input?a.input.val():null,e,f;e=f=this._getDefaultDate(a);var g=this._getFormatConfig(a);try{e=this.parseDate(c,d,g)||f}catch(h){this.log(h),d=b?"":d}a.selectedDay=e.getDate(),a.drawMonth=a.selectedMonth=e.getMonth(),a.drawYear=a.selectedYear=e.getFullYear(),a.currentDay=d?e.getDate():0,a.currentMonth=d?e.getMonth():0,a.currentYear=d?e.getFullYear():0,this._adjustInstDate(a)},_getDefaultDate:function(a){return this._restrictMinMax(a,this._determineDate(a,this._get(a,"defaultDate"),new Date))},_determineDate:function(a,b,c){var d=function(a){var b=new Date;return b.setDate(b.getDate()+a),b},e=function(b){try{return $.datepicker.parseDate($.datepicker._get(a,"dateFormat"),b,$.datepicker._getFormatConfig(a))}catch(c){}var d=(b.toLowerCase().match(/^c/)?$.datepicker._getDate(a):null)||new Date,e=d.getFullYear(),f=d.getMonth(),g=d.getDate(),h=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,i=h.exec(b);while(i){switch(i[2]||"d"){case"d":case"D":g+=parseInt(i[1],10);break;case"w":case"W":g+=parseInt(i[1],10)*7;break;case"m":case"M":f+=parseInt(i[1],10),g=Math.min(g,$.datepicker._getDaysInMonth(e,f));break;case"y":case"Y":e+=parseInt(i[1],10),g=Math.min(g,$.datepicker._getDaysInMonth(e,f))}i=h.exec(b)}return new Date(e,f,g)},f=b==null||b===""?c:typeof b=="string"?e(b):typeof b=="number"?isNaN(b)?c:d(b):new Date(b.getTime());return f=f&&f.toString()=="Invalid Date"?c:f,f&&(f.setHours(0),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0)),this._daylightSavingAdjust(f)},_daylightSavingAdjust:function(a){return a?(a.setHours(a.getHours()>12?a.getHours()+2:0),a):null},_setDate:function(a,b,c){var d=!b,e=a.selectedMonth,f=a.selectedYear,g=this._restrictMinMax(a,this._determineDate(a,b,new Date));a.selectedDay=a.currentDay=g.getDate(),a.drawMonth=a.selectedMonth=a.currentMonth=g.getMonth(),a.drawYear=a.selectedYear=a.currentYear=g.getFullYear(),(e!=a.selectedMonth||f!=a.selectedYear)&&!c&&this._notifyChange(a),this._adjustInstDate(a),a.input&&a.input.val(d?"":this._formatDate(a))},_getDate:function(a){var b=!a.currentYear||a.input&&a.input.val()==""?null:this._daylightSavingAdjust(new Date(a.currentYear,a.currentMonth,a.currentDay));return b},_generateHTML:function(a){var b=new Date;b=this._daylightSavingAdjust(new Date(b.getFullYear(),b.getMonth(),b.getDate()));var c=this._get(a,"isRTL"),d=this._get(a,"showButtonPanel"),e=this._get(a,"hideIfNoPrevNext"),f=this._get(a,"navigationAsDateFormat"),g=this._getNumberOfMonths(a),h=this._get(a,"showCurrentAtPos"),i=this._get(a,"stepMonths"),j=g[0]!=1||g[1]!=1,k=this._daylightSavingAdjust(a.currentDay?new Date(a.currentYear,a.currentMonth,a.currentDay):new Date(9999,9,9)),l=this._getMinMaxDate(a,"min"),m=this._getMinMaxDate(a,"max"),n=a.drawMonth-h,o=a.drawYear;n<0&&(n+=12,o--);if(m){var p=this._daylightSavingAdjust(new Date(m.getFullYear(),m.getMonth()-g[0]*g[1]+1,m.getDate()));p=l&&p<l?l:p;while(this._daylightSavingAdjust(new Date(o,n,1))>p)n--,n<0&&(n=11,o--)}a.drawMonth=n,a.drawYear=o;var q=this._get(a,"prevText");q=f?this.formatDate(q,this._daylightSavingAdjust(new Date(o,n-i,1)),this._getFormatConfig(a)):q;var r=this._canAdjustMonth(a,-1,o,n)?'<a class="ui-datepicker-prev ui-corner-all" onclick="DP_jQuery_'+dpuuid+".datepicker._adjustDate('#"+a.id+"', -"+i+", 'M');\""+' title="'+q+'"><span class="ui-icon ui-icon-circle-triangle-'+(c?"e":"w")+'">'+q+"</span></a>":e?"":'<a class="ui-datepicker-prev ui-corner-all ui-state-disabled" title="'+q+'"><span class="ui-icon ui-icon-circle-triangle-'+(c?"e":"w")+'">'+q+"</span></a>",s=this._get(a,"nextText");s=f?this.formatDate(s,this._daylightSavingAdjust(new Date(o,n+i,1)),this._getFormatConfig(a)):s;var t=this._canAdjustMonth(a,1,o,n)?'<a class="ui-datepicker-next ui-corner-all" onclick="DP_jQuery_'+dpuuid+".datepicker._adjustDate('#"+a.id+"', +"+i+", 'M');\""+' title="'+s+'"><span class="ui-icon ui-icon-circle-triangle-'+(c?"w":"e")+'">'+s+"</span></a>":e?"":'<a class="ui-datepicker-next ui-corner-all ui-state-disabled" title="'+s+'"><span class="ui-icon ui-icon-circle-triangle-'+(c?"w":"e")+'">'+s+"</span></a>",u=this._get(a,"currentText"),v=this._get(a,"gotoCurrent")&&a.currentDay?k:b;u=f?this.formatDate(u,v,this._getFormatConfig(a)):u;var w=a.inline?"":'<button type="button" class="ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all" onclick="DP_jQuery_'+dpuuid+'.datepicker._hideDatepicker();">'+this._get(a,"closeText")+"</button>",x=d?'<div class="ui-datepicker-buttonpane ui-widget-content">'+(c?w:"")+(this._isInRange(a,v)?'<button type="button" class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" onclick="DP_jQuery_'+dpuuid+".datepicker._gotoToday('#"+a.id+"');\""+">"+u+"</button>":"")+(c?"":w)+"</div>":"",y=parseInt(this._get(a,"firstDay"),10);y=isNaN(y)?0:y;var z=this._get(a,"showWeek"),A=this._get(a,"dayNames"),B=this._get(a,"dayNamesShort"),C=this._get(a,"dayNamesMin"),D=this._get(a,"monthNames"),E=this._get(a,"monthNamesShort"),F=this._get(a,"beforeShowDay"),G=this._get(a,"showOtherMonths"),H=this._get(a,"selectOtherMonths"),I=this._get(a,"calculateWeek")||this.iso8601Week,J=this._getDefaultDate(a),K="";for(var L=0;L<g[0];L++){var M="";this.maxRows=4;for(var N=0;N<g[1];N++){var O=this._daylightSavingAdjust(new Date(o,n,a.selectedDay)),P=" ui-corner-all",Q="";if(j){Q+='<div class="ui-datepicker-group';if(g[1]>1)switch(N){case 0:Q+=" ui-datepicker-group-first",P=" ui-corner-"+(c?"right":"left");break;case g[1]-1:Q+=" ui-datepicker-group-last",P=" ui-corner-"+(c?"left":"right");break;default:Q+=" ui-datepicker-group-middle",P=""}Q+='">'}Q+='<div class="ui-datepicker-header ui-widget-header ui-helper-clearfix'+P+'">'+(/all|left/.test(P)&&L==0?c?t:r:"")+(/all|right/.test(P)&&L==0?c?r:t:"")+this._generateMonthYearHeader(a,n,o,l,m,L>0||N>0,D,E)+'</div><table class="ui-datepicker-calendar"><thead>'+"<tr>";var R=z?'<th class="ui-datepicker-week-col">'+this._get(a,"weekHeader")+"</th>":"";for(var S=0;S<7;S++){var T=(S+y)%7;R+="<th"+((S+y+6)%7>=5?' class="ui-datepicker-week-end"':"")+">"+'<span title="'+A[T]+'">'+C[T]+"</span></th>"}Q+=R+"</tr></thead><tbody>";var U=this._getDaysInMonth(o,n);o==a.selectedYear&&n==a.selectedMonth&&(a.selectedDay=Math.min(a.selectedDay,U));var V=(this._getFirstDayOfMonth(o,n)-y+7)%7,W=Math.ceil((V+U)/7),X=j?this.maxRows>W?this.maxRows:W:W;this.maxRows=X;var Y=this._daylightSavingAdjust(new Date(o,n,1-V));for(var Z=0;Z<X;Z++){Q+="<tr>";var _=z?'<td class="ui-datepicker-week-col">'+this._get(a,"calculateWeek")(Y)+"</td>":"";for(var S=0;S<7;S++){var ba=F?F.apply(a.input?a.input[0]:null,[Y]):[!0,""],bb=Y.getMonth()!=n,bc=bb&&!H||!ba[0]||l&&Y<l||m&&Y>m;_+='<td class="'+((S+y+6)%7>=5?" ui-datepicker-week-end":"")+(bb?" ui-datepicker-other-month":"")+(Y.getTime()==O.getTime()&&n==a.selectedMonth&&a._keyEvent||J.getTime()==Y.getTime()&&J.getTime()==O.getTime()?" "+this._dayOverClass:"")+(bc?" "+this._unselectableClass+" ui-state-disabled":"")+(bb&&!G?"":" "+ba[1]+(Y.getTime()==k.getTime()?" "+this._currentClass:"")+(Y.getTime()==b.getTime()?" ui-datepicker-today":""))+'"'+((!bb||G)&&ba[2]?' title="'+ba[2]+'"':"")+(bc?"":' onclick="DP_jQuery_'+dpuuid+".datepicker._selectDay('#"+a.id+"',"+Y.getMonth()+","+Y.getFullYear()+', this);return false;"')+">"+(bb&&!G?"&#xa0;":bc?'<span class="ui-state-default">'+Y.getDate()+"</span>":'<a class="ui-state-default'+(Y.getTime()==b.getTime()?" ui-state-highlight":"")+(Y.getTime()==k.getTime()?" ui-state-active":"")+(bb?" ui-priority-secondary":"")+'" href="#">'+Y.getDate()+"</a>")+"</td>",Y.setDate(Y.getDate()+1),Y=this._daylightSavingAdjust(Y)}Q+=_+"</tr>"}n++,n>11&&(n=0,o++),Q+="</tbody></table>"+(j?"</div>"+(g[0]>0&&N==g[1]-1?'<div class="ui-datepicker-row-break"></div>':""):""),M+=Q}K+=M}return K+=x+($.browser.msie&&parseInt($.browser.version,10)<7&&!a.inline?'<iframe src="javascript:false;" class="ui-datepicker-cover" frameborder="0"></iframe>':""),a._keyEvent=!1,K},_generateMonthYearHeader:function(a,b,c,d,e,f,g,h){var i=this._get(a,"changeMonth"),j=this._get(a,"changeYear"),k=this._get(a,"showMonthAfterYear"),l='<div class="ui-datepicker-title">',m="";if(f||!i)m+='<span class="ui-datepicker-month">'+g[b]+"</span>";else{var n=d&&d.getFullYear()==c,o=e&&e.getFullYear()==c;m+='<select class="ui-datepicker-month" onchange="DP_jQuery_'+dpuuid+".datepicker._selectMonthYear('#"+a.id+"', this, 'M');\" "+">";for(var p=0;p<12;p++)(!n||p>=d.getMonth())&&(!o||p<=e.getMonth())&&(m+='<option value="'+p+'"'+(p==b?' selected="selected"':"")+">"+h[p]+"</option>");m+="</select>"}k||(l+=m+(f||!i||!j?"&#xa0;":""));if(!a.yearshtml){a.yearshtml="";if(f||!j)l+='<span class="ui-datepicker-year">'+c+"</span>";else{var q=this._get(a,"yearRange").split(":"),r=(new Date).getFullYear(),s=function(a){var b=a.match(/c[+-].*/)?c+parseInt(a.substring(1),10):a.match(/[+-].*/)?r+parseInt(a,10):parseInt(a,10);return isNaN(b)?r:b},t=s(q[0]),u=Math.max(t,s(q[1]||""));t=d?Math.max(t,d.getFullYear()):t,u=e?Math.min(u,e.getFullYear()):u,a.yearshtml+='<select class="ui-datepicker-year" onchange="DP_jQuery_'+dpuuid+".datepicker._selectMonthYear('#"+a.id+"', this, 'Y');\" "+">";for(;t<=u;t++)a.yearshtml+='<option value="'+t+'"'+(t==c?' selected="selected"':"")+">"+t+"</option>";a.yearshtml+="</select>",l+=a.yearshtml,a.yearshtml=null}}return l+=this._get(a,"yearSuffix"),k&&(l+=(f||!i||!j?"&#xa0;":"")+m),l+="</div>",l},_adjustInstDate:function(a,b,c){var d=a.drawYear+(c=="Y"?b:0),e=a.drawMonth+(c=="M"?b:0),f=Math.min(a.selectedDay,this._getDaysInMonth(d,e))+(c=="D"?b:0),g=this._restrictMinMax(a,this._daylightSavingAdjust(new Date(d,e,f)));a.selectedDay=g.getDate(),a.drawMonth=a.selectedMonth=g.getMonth(),a.drawYear=a.selectedYear=g.getFullYear(),(c=="M"||c=="Y")&&this._notifyChange(a)},_restrictMinMax:function(a,b){var c=this._getMinMaxDate(a,"min"),d=this._getMinMaxDate(a,"max"),e=c&&b<c?c:b;return e=d&&e>d?d:e,e},_notifyChange:function(a){var b=this._get(a,"onChangeMonthYear");b&&b.apply(a.input?a.input[0]:null,[a.selectedYear,a.selectedMonth+1,a])},_getNumberOfMonths:function(a){var b=this._get(a,"numberOfMonths");return b==null?[1,1]:typeof b=="number"?[1,b]:b},_getMinMaxDate:function(a,b){return this._determineDate(a,this._get(a,b+"Date"),null)},_getDaysInMonth:function(a,b){return 32-this._daylightSavingAdjust(new Date(a,b,32)).getDate()},_getFirstDayOfMonth:function(a,b){return(new Date(a,b,1)).getDay()},_canAdjustMonth:function(a,b,c,d){var e=this._getNumberOfMonths(a),f=this._daylightSavingAdjust(new Date(c,d+(b<0?b:e[0]*e[1]),1));return b<0&&f.setDate(this._getDaysInMonth(f.getFullYear(),f.getMonth())),this._isInRange(a,f)},_isInRange:function(a,b){var c=this._getMinMaxDate(a,"min"),d=this._getMinMaxDate(a,"max");return(!c||b.getTime()>=c.getTime())&&(!d||b.getTime()<=d.getTime())},_getFormatConfig:function(a){var b=this._get(a,"shortYearCutoff");return b=typeof b!="string"?b:(new Date).getFullYear()%100+parseInt(b,10),{shortYearCutoff:b,dayNamesShort:this._get(a,"dayNamesShort"),dayNames:this._get(a,"dayNames"),monthNamesShort:this._get(a,"monthNamesShort"),monthNames:this._get(a,"monthNames")}},_formatDate:function(a,b,c,d){b||(a.currentDay=a.selectedDay,a.currentMonth=a.selectedMonth,a.currentYear=a.selectedYear);var e=b?typeof b=="object"?b:this._daylightSavingAdjust(new Date(d,c,b)):this._daylightSavingAdjust(new Date(a.currentYear,a.currentMonth,a.currentDay));return this.formatDate(this._get(a,"dateFormat"),e,this._getFormatConfig(a))}}),$.fn.datepicker=function(a){if(!this.length)return this;$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick).find("body").append($.datepicker.dpDiv),$.datepicker.initialized=!0);var b=Array.prototype.slice.call(arguments,1);return typeof a!="string"||a!="isDisabled"&&a!="getDate"&&a!="widget"?a=="option"&&arguments.length==2&&typeof arguments[1]=="string"?$.datepicker["_"+a+"Datepicker"].apply($.datepicker,[this[0]].concat(b)):this.each(function(){typeof a=="string"?$.datepicker["_"+a+"Datepicker"].apply($.datepicker,[this].concat(b)):$.datepicker._attachDatepicker(this,a)}):$.datepicker["_"+a+"Datepicker"].apply($.datepicker,[this[0]].concat(b))},$.datepicker=new Datepicker,$.datepicker.initialized=!1,$.datepicker.uuid=(new Date).getTime(),$.datepicker.version="1.8.20",window["DP_jQuery_"+dpuuid]=$})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.ui.progressbar.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.widget("ui.progressbar",{options:{value:0,max:100},min:0,_create:function(){this.element.addClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").attr({role:"progressbar","aria-valuemin":this.min,"aria-valuemax":this.options.max,"aria-valuenow":this._value()}),this.valueDiv=a("<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>").appendTo(this.element),this.oldValue=this._value(),this._refreshValue()},destroy:function(){this.element.removeClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.valueDiv.remove(),a.Widget.prototype.destroy.apply(this,arguments)},value:function(a){return a===b?this._value():(this._setOption("value",a),this)},_setOption:function(b,c){b==="value"&&(this.options.value=c,this._refreshValue(),this._value()===this.options.max&&this._trigger("complete")),a.Widget.prototype._setOption.apply(this,arguments)},_value:function(){var a=this.options.value;return typeof a!="number"&&(a=0),Math.min(this.options.max,Math.max(this.min,a))},_percentage:function(){return 100*this._value()/this.options.max},_refreshValue:function(){var a=this.value(),b=this._percentage();this.oldValue!==a&&(this.oldValue=a,this._trigger("change")),this.valueDiv.toggle(a>this.min).toggleClass("ui-corner-right",a===this.options.max).width(b.toFixed(0)+"%"),this.element.attr("aria-valuenow",a)}}),a.extend(a.ui.progressbar,{version:"1.8.20"})})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.core.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
jQuery.effects||function(a,b){function c(b){var c;return b&&b.constructor==Array&&b.length==3?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[parseFloat(c[1])*2.55,parseFloat(c[2])*2.55,parseFloat(c[3])*2.55]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:(c=/rgba\(0, 0, 0, 0\)/.exec(b))?e.transparent:e[a.trim(b).toLowerCase()]}function d(b,d){var e;do{e=a.curCSS(b,d);if(e!=""&&e!="transparent"||a.nodeName(b,"body"))break;d="backgroundColor"}while(b=b.parentNode);return c(e)}function h(){var a=document.defaultView?document.defaultView.getComputedStyle(this,null):this.currentStyle,b={},c,d;if(a&&a.length&&a[0]&&a[a[0]]){var e=a.length;while(e--)c=a[e],typeof a[c]=="string"&&(d=c.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),b[d]=a[c])}else for(c in a)typeof a[c]=="string"&&(b[c]=a[c]);return b}function i(b){var c,d;for(c in b)d=b[c],(d==null||a.isFunction(d)||c in g||/scrollbar/.test(c)||!/color/i.test(c)&&isNaN(parseFloat(d)))&&delete b[c];return b}function j(a,b){var c={_:0},d;for(d in b)a[d]!=b[d]&&(c[d]=b[d]);return c}function k(b,c,d,e){typeof b=="object"&&(e=c,d=null,c=b,b=c.effect),a.isFunction(c)&&(e=c,d=null,c={});if(typeof c=="number"||a.fx.speeds[c])e=d,d=c,c={};return a.isFunction(d)&&(e=d,d=null),c=c||{},d=d||c.duration,d=a.fx.off?0:typeof d=="number"?d:d in a.fx.speeds?a.fx.speeds[d]:a.fx.speeds._default,e=e||c.complete,[b,c,d,e]}function l(b){return!b||typeof b=="number"||a.fx.speeds[b]?!0:typeof b=="string"&&!a.effects[b]?!0:!1}a.effects={},a.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","borderColor","color","outlineColor"],function(b,e){a.fx.step[e]=function(a){a.colorInit||(a.start=d(a.elem,e),a.end=c(a.end),a.colorInit=!0),a.elem.style[e]="rgb("+Math.max(Math.min(parseInt(a.pos*(a.end[0]-a.start[0])+a.start[0],10),255),0)+","+Math.max(Math.min(parseInt(a.pos*(a.end[1]-a.start[1])+a.start[1],10),255),0)+","+Math.max(Math.min(parseInt(a.pos*(a.end[2]-a.start[2])+a.start[2],10),255),0)+")"}});var e={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]},f=["add","remove","toggle"],g={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};a.effects.animateClass=function(b,c,d,e){return a.isFunction(d)&&(e=d,d=null),this.queue(function(){var g=a(this),k=g.attr("style")||" ",l=i(h.call(this)),m,n=g.attr("class")||"";a.each(f,function(a,c){b[c]&&g[c+"Class"](b[c])}),m=i(h.call(this)),g.attr("class",n),g.animate(j(l,m),{queue:!1,duration:c,easing:d,complete:function(){a.each(f,function(a,c){b[c]&&g[c+"Class"](b[c])}),typeof g.attr("style")=="object"?(g.attr("style").cssText="",g.attr("style").cssText=k):g.attr("style",k),e&&e.apply(this,arguments),a.dequeue(this)}})})},a.fn.extend({_addClass:a.fn.addClass,addClass:function(b,c,d,e){return c?a.effects.animateClass.apply(this,[{add:b},c,d,e]):this._addClass(b)},_removeClass:a.fn.removeClass,removeClass:function(b,c,d,e){return c?a.effects.animateClass.apply(this,[{remove:b},c,d,e]):this._removeClass(b)},_toggleClass:a.fn.toggleClass,toggleClass:function(c,d,e,f,g){return typeof d=="boolean"||d===b?e?a.effects.animateClass.apply(this,[d?{add:c}:{remove:c},e,f,g]):this._toggleClass(c,d):a.effects.animateClass.apply(this,[{toggle:c},d,e,f])},switchClass:function(b,c,d,e,f){return a.effects.animateClass.apply(this,[{add:c,remove:b},d,e,f])}}),a.extend(a.effects,{version:"1.8.20",save:function(a,b){for(var c=0;c<b.length;c++)b[c]!==null&&a.data("ec.storage."+b[c],a[0].style[b[c]])},restore:function(a,b){for(var c=0;c<b.length;c++)b[c]!==null&&a.css(b[c],a.data("ec.storage."+b[c]))},setMode:function(a,b){return b=="toggle"&&(b=a.is(":hidden")?"show":"hide"),b},getBaseline:function(a,b){var c,d;switch(a[0]){case"top":c=0;break;case"middle":c=.5;break;case"bottom":c=1;break;default:c=a[0]/b.height}switch(a[1]){case"left":d=0;break;case"center":d=.5;break;case"right":d=1;break;default:d=a[1]/b.width}return{x:d,y:c}},createWrapper:function(b){if(b.parent().is(".ui-effects-wrapper"))return b.parent();var c={width:b.outerWidth(!0),height:b.outerHeight(!0),"float":b.css("float")},d=a("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),e=document.activeElement;return b.wrap(d),(b[0]===e||a.contains(b[0],e))&&a(e).focus(),d=b.parent(),b.css("position")=="static"?(d.css({position:"relative"}),b.css({position:"relative"})):(a.extend(c,{position:b.css("position"),zIndex:b.css("z-index")}),a.each(["top","left","bottom","right"],function(a,d){c[d]=b.css(d),isNaN(parseInt(c[d],10))&&(c[d]="auto")}),b.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),d.css(c).show()},removeWrapper:function(b){var c,d=document.activeElement;return b.parent().is(".ui-effects-wrapper")?(c=b.parent().replaceWith(b),(b[0]===d||a.contains(b[0],d))&&a(d).focus(),c):b},setTransition:function(b,c,d,e){return e=e||{},a.each(c,function(a,c){var f=b.cssUnit(c);f[0]>0&&(e[c]=f[0]*d+f[1])}),e}}),a.fn.extend({effect:function(b,c,d,e){var f=k.apply(this,arguments),g={options:f[1],duration:f[2],callback:f[3]},h=g.options.mode,i=a.effects[b];return a.fx.off||!i?h?this[h](g.duration,g.callback):this.each(function(){g.callback&&g.callback.call(this)}):i.call(this,g)},_show:a.fn.show,show:function(a){if(l(a))return this._show.apply(this,arguments);var b=k.apply(this,arguments);return b[1].mode="show",this.effect.apply(this,b)},_hide:a.fn.hide,hide:function(a){if(l(a))return this._hide.apply(this,arguments);var b=k.apply(this,arguments);return b[1].mode="hide",this.effect.apply(this,b)},__toggle:a.fn.toggle,toggle:function(b){if(l(b)||typeof b=="boolean"||a.isFunction(b))return this.__toggle.apply(this,arguments);var c=k.apply(this,arguments);return c[1].mode="toggle",this.effect.apply(this,c)},cssUnit:function(b){var c=this.css(b),d=[];return a.each(["em","px","%","pt"],function(a,b){c.indexOf(b)>0&&(d=[parseFloat(c),b])}),d}}),a.easing.jswing=a.easing.swing,a.extend(a.easing,{def:"easeOutQuad",swing:function(b,c,d,e,f){return a.easing[a.easing.def](b,c,d,e,f)},easeInQuad:function(a,b,c,d,e){return d*(b/=e)*b+c},easeOutQuad:function(a,b,c,d,e){return-d*(b/=e)*(b-2)+c},easeInOutQuad:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b+c:-d/2*(--b*(b-2)-1)+c},easeInCubic:function(a,b,c,d,e){return d*(b/=e)*b*b+c},easeOutCubic:function(a,b,c,d,e){return d*((b=b/e-1)*b*b+1)+c},easeInOutCubic:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b+c:d/2*((b-=2)*b*b+2)+c},easeInQuart:function(a,b,c,d,e){return d*(b/=e)*b*b*b+c},easeOutQuart:function(a,b,c,d,e){return-d*((b=b/e-1)*b*b*b-1)+c},easeInOutQuart:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b+c:-d/2*((b-=2)*b*b*b-2)+c},easeInQuint:function(a,b,c,d,e){return d*(b/=e)*b*b*b*b+c},easeOutQuint:function(a,b,c,d,e){return d*((b=b/e-1)*b*b*b*b+1)+c},easeInOutQuint:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b*b+c:d/2*((b-=2)*b*b*b*b+2)+c},easeInSine:function(a,b,c,d,e){return-d*Math.cos(b/e*(Math.PI/2))+d+c},easeOutSine:function(a,b,c,d,e){return d*Math.sin(b/e*(Math.PI/2))+c},easeInOutSine:function(a,b,c,d,e){return-d/2*(Math.cos(Math.PI*b/e)-1)+c},easeInExpo:function(a,b,c,d,e){return b==0?c:d*Math.pow(2,10*(b/e-1))+c},easeOutExpo:function(a,b,c,d,e){return b==e?c+d:d*(-Math.pow(2,-10*b/e)+1)+c},easeInOutExpo:function(a,b,c,d,e){return b==0?c:b==e?c+d:(b/=e/2)<1?d/2*Math.pow(2,10*(b-1))+c:d/2*(-Math.pow(2,-10*--b)+2)+c},easeInCirc:function(a,b,c,d,e){return-d*(Math.sqrt(1-(b/=e)*b)-1)+c},easeOutCirc:function(a,b,c,d,e){return d*Math.sqrt(1-(b=b/e-1)*b)+c},easeInOutCirc:function(a,b,c,d,e){return(b/=e/2)<1?-d/2*(Math.sqrt(1-b*b)-1)+c:d/2*(Math.sqrt(1-(b-=2)*b)+1)+c},easeInElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(b==0)return c;if((b/=e)==1)return c+d;g||(g=e*.3);if(h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return-(h*Math.pow(2,10*(b-=1))*Math.sin((b*e-f)*2*Math.PI/g))+c},easeOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(b==0)return c;if((b/=e)==1)return c+d;g||(g=e*.3);if(h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return h*Math.pow(2,-10*b)*Math.sin((b*e-f)*2*Math.PI/g)+d+c},easeInOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(b==0)return c;if((b/=e/2)==2)return c+d;g||(g=e*.3*1.5);if(h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return b<1?-0.5*h*Math.pow(2,10*(b-=1))*Math.sin((b*e-f)*2*Math.PI/g)+c:h*Math.pow(2,-10*(b-=1))*Math.sin((b*e-f)*2*Math.PI/g)*.5+d+c},easeInBack:function(a,c,d,e,f,g){return g==b&&(g=1.70158),e*(c/=f)*c*((g+1)*c-g)+d},easeOutBack:function(a,c,d,e,f,g){return g==b&&(g=1.70158),e*((c=c/f-1)*c*((g+1)*c+g)+1)+d},easeInOutBack:function(a,c,d,e,f,g){return g==b&&(g=1.70158),(c/=f/2)<1?e/2*c*c*(((g*=1.525)+1)*c-g)+d:e/2*((c-=2)*c*(((g*=1.525)+1)*c+g)+2)+d},easeInBounce:function(b,c,d,e,f){return e-a.easing.easeOutBounce(b,f-c,0,e,f)+d},easeOutBounce:function(a,b,c,d,e){return(b/=e)<1/2.75?d*7.5625*b*b+c:b<2/2.75?d*(7.5625*(b-=1.5/2.75)*b+.75)+c:b<2.5/2.75?d*(7.5625*(b-=2.25/2.75)*b+.9375)+c:d*(7.5625*(b-=2.625/2.75)*b+.984375)+c},easeInOutBounce:function(b,c,d,e,f){return c<f/2?a.easing.easeInBounce(b,c*2,0,e,f)*.5+d:a.easing.easeOutBounce(b,c*2-f,0,e,f)*.5+e*.5+d}})}(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.blind.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.blind=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right"],e=a.effects.setMode(c,b.options.mode||"hide"),f=b.options.direction||"vertical";a.effects.save(c,d),c.show();var g=a.effects.createWrapper(c).css({overflow:"hidden"}),h=f=="vertical"?"height":"width",i=f=="vertical"?g.height():g.width();e=="show"&&g.css(h,0);var j={};j[h]=e=="show"?i:0,g.animate(j,b.duration,b.options.easing,function(){e=="hide"&&c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(c[0],arguments),c.dequeue()})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.bounce.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.bounce=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right"],e=a.effects.setMode(c,b.options.mode||"effect"),f=b.options.direction||"up",g=b.options.distance||20,h=b.options.times||5,i=b.duration||250;/show|hide/.test(e)&&d.push("opacity"),a.effects.save(c,d),c.show(),a.effects.createWrapper(c);var j=f=="up"||f=="down"?"top":"left",k=f=="up"||f=="left"?"pos":"neg",g=b.options.distance||(j=="top"?c.outerHeight({margin:!0})/3:c.outerWidth({margin:!0})/3);e=="show"&&c.css("opacity",0).css(j,k=="pos"?-g:g),e=="hide"&&(g=g/(h*2)),e!="hide"&&h--;if(e=="show"){var l={opacity:1};l[j]=(k=="pos"?"+=":"-=")+g,c.animate(l,i/2,b.options.easing),g=g/2,h--}for(var m=0;m<h;m++){var n={},p={};n[j]=(k=="pos"?"-=":"+=")+g,p[j]=(k=="pos"?"+=":"-=")+g,c.animate(n,i/2,b.options.easing).animate(p,i/2,b.options.easing),g=e=="hide"?g*2:g/2}if(e=="hide"){var l={opacity:0};l[j]=(k=="pos"?"-=":"+=")+g,c.animate(l,i/2,b.options.easing,function(){c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(this,arguments)})}else{var n={},p={};n[j]=(k=="pos"?"-=":"+=")+g,p[j]=(k=="pos"?"+=":"-=")+g,c.animate(n,i/2,b.options.easing).animate(p,i/2,b.options.easing,function(){a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(this,arguments)})}c.queue("fx",function(){c.dequeue()}),c.dequeue()})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.clip.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.clip=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right","height","width"],e=a.effects.setMode(c,b.options.mode||"hide"),f=b.options.direction||"vertical";a.effects.save(c,d),c.show();var g=a.effects.createWrapper(c).css({overflow:"hidden"}),h=c[0].tagName=="IMG"?g:c,i={size:f=="vertical"?"height":"width",position:f=="vertical"?"top":"left"},j=f=="vertical"?h.height():h.width();e=="show"&&(h.css(i.size,0),h.css(i.position,j/2));var k={};k[i.size]=e=="show"?j:0,k[i.position]=e=="show"?0:j/2,h.animate(k,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){e=="hide"&&c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(c[0],arguments),c.dequeue()}})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.drop.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.drop=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right","opacity"],e=a.effects.setMode(c,b.options.mode||"hide"),f=b.options.direction||"left";a.effects.save(c,d),c.show(),a.effects.createWrapper(c);var g=f=="up"||f=="down"?"top":"left",h=f=="up"||f=="left"?"pos":"neg",i=b.options.distance||(g=="top"?c.outerHeight({margin:!0})/2:c.outerWidth({margin:!0})/2);e=="show"&&c.css("opacity",0).css(g,h=="pos"?-i:i);var j={opacity:e=="show"?1:0};j[g]=(e=="show"?h=="pos"?"+=":"-=":h=="pos"?"-=":"+=")+i,c.animate(j,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){e=="hide"&&c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(this,arguments),c.dequeue()}})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.explode.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.explode=function(b){return this.queue(function(){var c=b.options.pieces?Math.round(Math.sqrt(b.options.pieces)):3,d=b.options.pieces?Math.round(Math.sqrt(b.options.pieces)):3;b.options.mode=b.options.mode=="toggle"?a(this).is(":visible")?"hide":"show":b.options.mode;var e=a(this).show().css("visibility","hidden"),f=e.offset();f.top-=parseInt(e.css("marginTop"),10)||0,f.left-=parseInt(e.css("marginLeft"),10)||0;var g=e.outerWidth(!0),h=e.outerHeight(!0);for(var i=0;i<c;i++)for(var j=0;j<d;j++)e.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-j*(g/d),top:-i*(h/c)}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:g/d,height:h/c,left:f.left+j*(g/d)+(b.options.mode=="show"?(j-Math.floor(d/2))*(g/d):0),top:f.top+i*(h/c)+(b.options.mode=="show"?(i-Math.floor(c/2))*(h/c):0),opacity:b.options.mode=="show"?0:1}).animate({left:f.left+j*(g/d)+(b.options.mode=="show"?0:(j-Math.floor(d/2))*(g/d)),top:f.top+i*(h/c)+(b.options.mode=="show"?0:(i-Math.floor(c/2))*(h/c)),opacity:b.options.mode=="show"?1:0},b.duration||500);setTimeout(function(){b.options.mode=="show"?e.css({visibility:"visible"}):e.css({visibility:"visible"}).hide(),b.callback&&b.callback.apply(e[0]),e.dequeue(),a("div.ui-effects-explode").remove()},b.duration||500)})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.fade.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.fade=function(b){return this.queue(function(){var c=a(this),d=a.effects.setMode(c,b.options.mode||"hide");c.animate({opacity:d},{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){b.callback&&b.callback.apply(this,arguments),c.dequeue()}})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.fold.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.fold=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right"],e=a.effects.setMode(c,b.options.mode||"hide"),f=b.options.size||15,g=!!b.options.horizFirst,h=b.duration?b.duration/2:a.fx.speeds._default/2;a.effects.save(c,d),c.show();var i=a.effects.createWrapper(c).css({overflow:"hidden"}),j=e=="show"!=g,k=j?["width","height"]:["height","width"],l=j?[i.width(),i.height()]:[i.height(),i.width()],m=/([0-9]+)%/.exec(f);m&&(f=parseInt(m[1],10)/100*l[e=="hide"?0:1]),e=="show"&&i.css(g?{height:0,width:f}:{height:f,width:0});var n={},p={};n[k[0]]=e=="show"?l[0]:f,p[k[1]]=e=="show"?l[1]:0,i.animate(n,h,b.options.easing).animate(p,h,b.options.easing,function(){e=="hide"&&c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(c[0],arguments),c.dequeue()})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.highlight.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.highlight=function(b){return this.queue(function(){var c=a(this),d=["backgroundImage","backgroundColor","opacity"],e=a.effects.setMode(c,b.options.mode||"show"),f={backgroundColor:c.css("backgroundColor")};e=="hide"&&(f.opacity=0),a.effects.save(c,d),c.show().css({backgroundImage:"none",backgroundColor:b.options.color||"#ffff99"}).animate(f,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){e=="hide"&&c.hide(),a.effects.restore(c,d),e=="show"&&!a.support.opacity&&this.style.removeAttribute("filter"),b.callback&&b.callback.apply(this,arguments),c.dequeue()}})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.pulsate.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.pulsate=function(b){return this.queue(function(){var c=a(this),d=a.effects.setMode(c,b.options.mode||"show"),e=(b.options.times||5)*2-1,f=b.duration?b.duration/2:a.fx.speeds._default/2,g=c.is(":visible"),h=0;g||(c.css("opacity",0).show(),h=1),(d=="hide"&&g||d=="show"&&!g)&&e--;for(var i=0;i<e;i++)c.animate({opacity:h},f,b.options.easing),h=(h+1)%2;c.animate({opacity:h},f,b.options.easing,function(){h==0&&c.hide(),b.callback&&b.callback.apply(this,arguments)}),c.queue("fx",function(){c.dequeue()}).dequeue()})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.scale.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.puff=function(b){return this.queue(function(){var c=a(this),d=a.effects.setMode(c,b.options.mode||"hide"),e=parseInt(b.options.percent,10)||150,f=e/100,g={height:c.height(),width:c.width()};a.extend(b.options,{fade:!0,mode:d,percent:d=="hide"?e:100,from:d=="hide"?g:{height:g.height*f,width:g.width*f}}),c.effect("scale",b.options,b.duration,b.callback),c.dequeue()})},a.effects.scale=function(b){return this.queue(function(){var c=a(this),d=a.extend(!0,{},b.options),e=a.effects.setMode(c,b.options.mode||"effect"),f=parseInt(b.options.percent,10)||(parseInt(b.options.percent,10)==0?0:e=="hide"?0:100),g=b.options.direction||"both",h=b.options.origin;e!="effect"&&(d.origin=h||["middle","center"],d.restore=!0);var i={height:c.height(),width:c.width()};c.from=b.options.from||(e=="show"?{height:0,width:0}:i);var j={y:g!="horizontal"?f/100:1,x:g!="vertical"?f/100:1};c.to={height:i.height*j.y,width:i.width*j.x},b.options.fade&&(e=="show"&&(c.from.opacity=0,c.to.opacity=1),e=="hide"&&(c.from.opacity=1,c.to.opacity=0)),d.from=c.from,d.to=c.to,d.mode=e,c.effect("size",d,b.duration,b.callback),c.dequeue()})},a.effects.size=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right","width","height","overflow","opacity"],e=["position","top","bottom","left","right","overflow","opacity"],f=["width","height","overflow"],g=["fontSize"],h=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],i=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],j=a.effects.setMode(c,b.options.mode||"effect"),k=b.options.restore||!1,l=b.options.scale||"both",m=b.options.origin,n={height:c.height(),width:c.width()};c.from=b.options.from||n,c.to=b.options.to||n;if(m){var p=a.effects.getBaseline(m,n);c.from.top=(n.height-c.from.height)*p.y,c.from.left=(n.width-c.from.width)*p.x,c.to.top=(n.height-c.to.height)*p.y,c.to.left=(n.width-c.to.width)*p.x}var q={from:{y:c.from.height/n.height,x:c.from.width/n.width},to:{y:c.to.height/n.height,x:c.to.width/n.width}};if(l=="box"||l=="both")q.from.y!=q.to.y&&(d=d.concat(h),c.from=a.effects.setTransition(c,h,q.from.y,c.from),c.to=a.effects.setTransition(c,h,q.to.y,c.to)),q.from.x!=q.to.x&&(d=d.concat(i),c.from=a.effects.setTransition(c,i,q.from.x,c.from),c.to=a.effects.setTransition(c,i,q.to.x,c.to));(l=="content"||l=="both")&&q.from.y!=q.to.y&&(d=d.concat(g),c.from=a.effects.setTransition(c,g,q.from.y,c.from),c.to=a.effects.setTransition(c,g,q.to.y,c.to)),a.effects.save(c,k?d:e),c.show(),a.effects.createWrapper(c),c.css("overflow","hidden").css(c.from);if(l=="content"||l=="both")h=h.concat(["marginTop","marginBottom"]).concat(g),i=i.concat(["marginLeft","marginRight"]),f=d.concat(h).concat(i),c.find("*[width]").each(function(){var c=a(this);k&&a.effects.save(c,f);var d={height:c.height(),width:c.width()};c.from={height:d.height*q.from.y,width:d.width*q.from.x},c.to={height:d.height*q.to.y,width:d.width*q.to.x},q.from.y!=q.to.y&&(c.from=a.effects.setTransition(c,h,q.from.y,c.from),c.to=a.effects.setTransition(c,h,q.to.y,c.to)),q.from.x!=q.to.x&&(c.from=a.effects.setTransition(c,i,q.from.x,c.from),c.to=a.effects.setTransition(c,i,q.to.x,c.to)),c.css(c.from),c.animate(c.to,b.duration,b.options.easing,function(){k&&a.effects.restore(c,f)})});c.animate(c.to,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){c.to.opacity===0&&c.css("opacity",c.from.opacity),j=="hide"&&c.hide(),a.effects.restore(c,k?d:e),a.effects.removeWrapper(c),b.callback&&b.callback.apply(this,arguments),c.dequeue()}})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.shake.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.shake=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right"],e=a.effects.setMode(c,b.options.mode||"effect"),f=b.options.direction||"left",g=b.options.distance||20,h=b.options.times||3,i=b.duration||b.options.duration||140;a.effects.save(c,d),c.show(),a.effects.createWrapper(c);var j=f=="up"||f=="down"?"top":"left",k=f=="up"||f=="left"?"pos":"neg",l={},m={},n={};l[j]=(k=="pos"?"-=":"+=")+g,m[j]=(k=="pos"?"+=":"-=")+g*2,n[j]=(k=="pos"?"-=":"+=")+g*2,c.animate(l,i,b.options.easing);for(var p=1;p<h;p++)c.animate(m,i,b.options.easing).animate(n,i,b.options.easing);c.animate(m,i,b.options.easing).animate(l,i/2,b.options.easing,function(){a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(this,arguments)}),c.queue("fx",function(){c.dequeue()}),c.dequeue()})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.slide.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.slide=function(b){return this.queue(function(){var c=a(this),d=["position","top","bottom","left","right"],e=a.effects.setMode(c,b.options.mode||"show"),f=b.options.direction||"left";a.effects.save(c,d),c.show(),a.effects.createWrapper(c).css({overflow:"hidden"});var g=f=="up"||f=="down"?"top":"left",h=f=="up"||f=="left"?"pos":"neg",i=b.options.distance||(g=="top"?c.outerHeight({margin:!0}):c.outerWidth({margin:!0}));e=="show"&&c.css(g,h=="pos"?isNaN(i)?"-"+i:-i:i);var j={};j[g]=(e=="show"?h=="pos"?"+=":"-=":h=="pos"?"-=":"+=")+i,c.animate(j,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){e=="hide"&&c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(this,arguments),c.dequeue()}})})}})(jQuery);;/*! jQuery UI - v1.8.20 - 2012-04-30
* https://github.com/jquery/jquery-ui
* Includes: jquery.effects.transfer.js
* Copyright (c) 2012 AUTHORS.txt; Licensed MIT, GPL */
(function(a,b){a.effects.transfer=function(b){return this.queue(function(){var c=a(this),d=a(b.options.to),e=d.offset(),f={top:e.top,left:e.left,height:d.innerHeight(),width:d.innerWidth()},g=c.offset(),h=a('<div class="ui-effects-transfer"></div>').appendTo(document.body).addClass(b.options.className).css({top:g.top,left:g.left,height:c.innerHeight(),width:c.innerWidth(),position:"absolute"}).animate(f,b.duration,b.options.easing,function(){h.remove(),b.callback&&b.callback.apply(c[0],arguments),c.dequeue()})})}})(jQuery);;
////////////////////////////////////////
// SRC End --> libs/jquery/jquery-ui-1.8.20.custom.min.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/jquery/jquery.mobile-1.1.0.min.js
////////////////////////////////////////
/*! jQuery Mobile v1.1.0 db342b1f315c282692791aa870455901fdb46a55 jquerymobile.com | jquery.org/license */
(function(D,s,k){typeof define==="function"&&define.amd?define(["jquery"],function(a){k(a,D,s);return a.mobile}):k(D.jQuery,D,s)})(this,document,function(D,s,k){(function(a,c,b,e){function f(a){for(;a&&typeof a.originalEvent!=="undefined";)a=a.originalEvent;return a}function d(b){for(var d={},f,g;b;){f=a.data(b,t);for(g in f)if(f[g])d[g]=d.hasVirtualBinding=true;b=b.parentNode}return d}function g(){y&&(clearTimeout(y),y=0);y=setTimeout(function(){F=y=0;C.length=0;z=false;G=true},a.vmouse.resetTimerDuration)}
function h(b,d,g){var c,h;if(!(h=g&&g[b])){if(g=!g)a:{for(g=d.target;g;){if((h=a.data(g,t))&&(!b||h[b]))break a;g=g.parentNode}g=null}h=g}if(h){c=d;var g=c.type,z,j;c=a.Event(c);c.type=b;h=c.originalEvent;z=a.event.props;g.search(/^(mouse|click)/)>-1&&(z=w);if(h)for(j=z.length;j;)b=z[--j],c[b]=h[b];if(g.search(/mouse(down|up)|click/)>-1&&!c.which)c.which=1;if(g.search(/^touch/)!==-1&&(b=f(h),g=b.touches,b=b.changedTouches,g=g&&g.length?g[0]:b&&b.length?b[0]:e))for(h=0,len=u.length;h<len;h++)b=u[h],
c[b]=g[b];a(d.target).trigger(c)}return c}function j(b){var d=a.data(b.target,x);if(!z&&(!F||F!==d))if(d=h("v"+b.type,b))d.isDefaultPrevented()&&b.preventDefault(),d.isPropagationStopped()&&b.stopPropagation(),d.isImmediatePropagationStopped()&&b.stopImmediatePropagation()}function o(b){var g=f(b).touches,c;if(g&&g.length===1&&(c=b.target,g=d(c),g.hasVirtualBinding))F=L++,a.data(c,x,F),y&&(clearTimeout(y),y=0),A=G=false,c=f(b).touches[0],s=c.pageX,E=c.pageY,h("vmouseover",b,g),h("vmousedown",b,g)}
function m(a){G||(A||h("vmousecancel",a,d(a.target)),A=true,g())}function p(b){if(!G){var c=f(b).touches[0],e=A,z=a.vmouse.moveDistanceThreshold;A=A||Math.abs(c.pageX-s)>z||Math.abs(c.pageY-E)>z;flags=d(b.target);A&&!e&&h("vmousecancel",b,flags);h("vmousemove",b,flags);g()}}function l(a){if(!G){G=true;var b=d(a.target),c;h("vmouseup",a,b);if(!A&&(c=h("vclick",a,b))&&c.isDefaultPrevented())c=f(a).changedTouches[0],C.push({touchID:F,x:c.clientX,y:c.clientY}),z=true;h("vmouseout",a,b);A=false;g()}}function r(b){var b=
a.data(b,t),d;if(b)for(d in b)if(b[d])return true;return false}function n(){}function k(b){var d=b.substr(1);return{setup:function(){r(this)||a.data(this,t,{});a.data(this,t)[b]=true;v[b]=(v[b]||0)+1;v[b]===1&&H.bind(d,j);a(this).bind(d,n);if(K)v.touchstart=(v.touchstart||0)+1,v.touchstart===1&&H.bind("touchstart",o).bind("touchend",l).bind("touchmove",p).bind("scroll",m)},teardown:function(){--v[b];v[b]||H.unbind(d,j);K&&(--v.touchstart,v.touchstart||H.unbind("touchstart",o).unbind("touchmove",p).unbind("touchend",
l).unbind("scroll",m));var f=a(this),g=a.data(this,t);g&&(g[b]=false);f.unbind(d,n);r(this)||f.removeData(t)}}}var t="virtualMouseBindings",x="virtualTouchID",c="vmouseover vmousedown vmousemove vmouseup vclick vmouseout vmousecancel".split(" "),u="clientX clientY pageX pageY screenX screenY".split(" "),w=a.event.props.concat(a.event.mouseHooks?a.event.mouseHooks.props:[]),v={},y=0,s=0,E=0,A=false,C=[],z=false,G=false,K="addEventListener"in b,H=a(b),L=1,F=0;a.vmouse={moveDistanceThreshold:10,clickDistanceThreshold:10,
resetTimerDuration:1500};for(var I=0;I<c.length;I++)a.event.special[c[I]]=k(c[I]);K&&b.addEventListener("click",function(b){var d=C.length,f=b.target,g,c,e,h,z;if(d){g=b.clientX;c=b.clientY;threshold=a.vmouse.clickDistanceThreshold;for(e=f;e;){for(h=0;h<d;h++)if(z=C[h],e===f&&Math.abs(z.x-g)<threshold&&Math.abs(z.y-c)<threshold||a.data(e,x)===z.touchID){b.preventDefault();b.stopPropagation();return}e=e.parentNode}}},true)})(jQuery,s,k);(function(a,c,b){function e(a){a=a||location.href;return"#"+a.replace(/^[^#]*#?(.*)$/,
"$1")}var f="hashchange",d=k,g,h=a.event.special,j=d.documentMode,o="on"+f in c&&(j===b||j>7);a.fn[f]=function(a){return a?this.bind(f,a):this.trigger(f)};a.fn[f].delay=50;h[f]=a.extend(h[f],{setup:function(){if(o)return false;a(g.start)},teardown:function(){if(o)return false;a(g.stop)}});g=function(){function g(){var b=e(),d=t(r);if(b!==r)k(r=b,d),a(c).trigger(f);else if(d!==r)location.href=location.href.replace(/#.*/,"")+d;j=setTimeout(g,a.fn[f].delay)}var h={},j,r=e(),n=function(a){return a},k=
n,t=n;h.start=function(){j||g()};h.stop=function(){j&&clearTimeout(j);j=b};a.browser.msie&&!o&&function(){var b,c;h.start=function(){if(!b)c=(c=a.fn[f].src)&&c+e(),b=a('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){c||k(e());g()}).attr("src",c||"javascript:0").insertAfter("body")[0].contentWindow,d.onpropertychange=function(){try{if(event.propertyName==="title")b.document.title=d.title}catch(a){}}};h.stop=n;t=function(){return e(b.location.href)};k=function(g,c){var e=b.document,
h=a.fn[f].domain;if(g!==c)e.title=d.title,e.open(),h&&e.write('<script>document.domain="'+h+'"<\/script>'),e.close(),b.location.hash=g}}();return h}()})(jQuery,this);(function(a,c){if(a.cleanData){var b=a.cleanData;a.cleanData=function(f){for(var d=0,g;(g=f[d])!=null;d++)a(g).triggerHandler("remove");b(f)}}else{var e=a.fn.remove;a.fn.remove=function(b,d){return this.each(function(){d||(!b||a.filter(b,[this]).length)&&a("*",this).add([this]).each(function(){a(this).triggerHandler("remove")});return e.call(a(this),
b,d)})}}a.widget=function(b,d,g){var c=b.split(".")[0],e,b=b.split(".")[1];e=c+"-"+b;if(!g)g=d,d=a.Widget;a.expr[":"][e]=function(d){return!!a.data(d,b)};a[c]=a[c]||{};a[c][b]=function(a,b){arguments.length&&this._createWidget(a,b)};d=new d;d.options=a.extend(true,{},d.options);a[c][b].prototype=a.extend(true,d,{namespace:c,widgetName:b,widgetEventPrefix:a[c][b].prototype.widgetEventPrefix||b,widgetBaseClass:e},g);a.widget.bridge(b,a[c][b])};a.widget.bridge=function(b,d){a.fn[b]=function(g){var e=
typeof g==="string",j=Array.prototype.slice.call(arguments,1),o=this,g=!e&&j.length?a.extend.apply(null,[true,g].concat(j)):g;if(e&&g.charAt(0)==="_")return o;e?this.each(function(){var d=a.data(this,b);if(!d)throw"cannot call methods on "+b+" prior to initialization; attempted to call method '"+g+"'";if(!a.isFunction(d[g]))throw"no such method '"+g+"' for "+b+" widget instance";var e=d[g].apply(d,j);if(e!==d&&e!==c)return o=e,false}):this.each(function(){var c=a.data(this,b);c?c.option(g||{})._init():
a.data(this,b,new d(g,this))});return o}};a.Widget=function(a,b){arguments.length&&this._createWidget(a,b)};a.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",options:{disabled:false},_createWidget:function(b,d){a.data(d,this.widgetName,this);this.element=a(d);this.options=a.extend(true,{},this.options,this._getCreateOptions(),b);var g=this;this.element.bind("remove."+this.widgetName,function(){g.destroy()});this._create();this._trigger("create");this._init()},_getCreateOptions:function(){var b=
{};a.metadata&&(b=a.metadata.get(element)[this.widgetName]);return b},_create:function(){},_init:function(){},destroy:function(){this.element.unbind("."+this.widgetName).removeData(this.widgetName);this.widget().unbind("."+this.widgetName).removeAttr("aria-disabled").removeClass(this.widgetBaseClass+"-disabled ui-state-disabled")},widget:function(){return this.element},option:function(b,d){var g=b;if(arguments.length===0)return a.extend({},this.options);if(typeof b==="string"){if(d===c)return this.options[b];
g={};g[b]=d}this._setOptions(g);return this},_setOptions:function(b){var d=this;a.each(b,function(a,b){d._setOption(a,b)});return this},_setOption:function(a,b){this.options[a]=b;a==="disabled"&&this.widget()[b?"addClass":"removeClass"](this.widgetBaseClass+"-disabled ui-state-disabled").attr("aria-disabled",b);return this},enable:function(){return this._setOption("disabled",false)},disable:function(){return this._setOption("disabled",true)},_trigger:function(b,d,g){var c=this.options[b],d=a.Event(d);
d.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase();g=g||{};if(d.originalEvent)for(var b=a.event.props.length,e;b;)e=a.event.props[--b],d[e]=d.originalEvent[e];this.element.trigger(d,g);return!(a.isFunction(c)&&c.call(this.element[0],d,g)===false||d.isDefaultPrevented())}}})(jQuery);(function(a,c){a.widget("mobile.widget",{_createWidget:function(){a.Widget.prototype._createWidget.apply(this,arguments);this._trigger("init")},_getCreateOptions:function(){var b=this.element,
e={};a.each(this.options,function(a){var d=b.jqmData(a.replace(/[A-Z]/g,function(a){return"-"+a.toLowerCase()}));d!==c&&(e[a]=d)});return e},enhanceWithin:function(b,c){this.enhance(a(this.options.initSelector,a(b)),c)},enhance:function(b,c){var f,d=a(b),d=a.mobile.enhanceable(d);c&&d.length&&(f=(f=a.mobile.closestPageData(d))&&f.keepNativeSelector()||"",d=d.not(f));d[this.widgetName]()},raise:function(a){throw"Widget ["+this.widgetName+"]: "+a;}})})(jQuery);(function(a,c){var b={};a.mobile=a.extend({},
{version:"1.1.0",ns:"",subPageUrlKey:"ui-page",activePageClass:"ui-page-active",activeBtnClass:"ui-btn-active",focusClass:"ui-focus",ajaxEnabled:true,hashListeningEnabled:true,linkBindingEnabled:true,defaultPageTransition:"fade",maxTransitionWidth:false,minScrollBack:250,touchOverflowEnabled:false,defaultDialogTransition:"pop",loadingMessage:"loading",pageLoadErrorMessage:"Error Loading Page",loadingMessageTextVisible:false,loadingMessageTheme:"a",pageLoadErrorMessageTheme:"e",autoInitializePage:true,
pushStateEnabled:true,ignoreContentEnabled:false,orientationChangeEnabled:true,buttonMarkup:{hoverDelay:200},keyCode:{ALT:18,BACKSPACE:8,CAPS_LOCK:20,COMMA:188,COMMAND:91,COMMAND_LEFT:91,COMMAND_RIGHT:93,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,MENU:93,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,WINDOWS:91},silentScroll:function(b){if(a.type(b)!==
"number")b=a.mobile.defaultHomeScroll;a.event.special.scrollstart.enabled=false;setTimeout(function(){c.scrollTo(0,b);a(k).trigger("silentscroll",{x:0,y:b})},20);setTimeout(function(){a.event.special.scrollstart.enabled=true},150)},nsNormalizeDict:b,nsNormalize:function(d){return!d?void 0:b[d]||(b[d]=a.camelCase(a.mobile.ns+d))},getInheritedTheme:function(a,b){for(var c=a[0],e="",f=/ui-(bar|body|overlay)-([a-z])\b/,m,p;c;){m=c.className||"";if((p=f.exec(m))&&(e=p[2]))break;c=c.parentNode}return e||
b||"a"},closestPageData:function(a){return a.closest(':jqmData(role="page"), :jqmData(role="dialog")').data("page")},enhanceable:function(a){return this.haveParents(a,"enhance")},hijackable:function(a){return this.haveParents(a,"ajax")},haveParents:function(b,c){if(!a.mobile.ignoreContentEnabled)return b;for(var e=b.length,f=a(),o,m,p,l=0;l<e;l++){m=b.eq(l);p=false;for(o=b[l];o;){if((o.getAttribute?o.getAttribute("data-"+a.mobile.ns+c):"")==="false"){p=true;break}o=o.parentNode}p||(f=f.add(m))}return f}},
a.mobile);a.fn.jqmData=function(b,c){var f;typeof b!="undefined"&&(b&&(b=a.mobile.nsNormalize(b)),f=this.data.apply(this,arguments.length<2?[b]:[b,c]));return f};a.jqmData=function(b,c,f){var e;typeof c!="undefined"&&(e=a.data(b,c?a.mobile.nsNormalize(c):c,f));return e};a.fn.jqmRemoveData=function(b){return this.removeData(a.mobile.nsNormalize(b))};a.jqmRemoveData=function(b,c){return a.removeData(b,a.mobile.nsNormalize(c))};a.fn.removeWithDependents=function(){a.removeWithDependents(this)};a.removeWithDependents=
function(b){b=a(b);(b.jqmData("dependents")||a()).remove();b.remove()};a.fn.addDependents=function(b){a.addDependents(a(this),b)};a.addDependents=function(b,c){var f=a(b).jqmData("dependents")||a();a(b).jqmData("dependents",a.merge(f,c))};a.fn.getEncodedText=function(){return a("<div/>").text(a(this).text()).html()};a.fn.jqmEnhanceable=function(){return a.mobile.enhanceable(this)};a.fn.jqmHijackable=function(){return a.mobile.hijackable(this)};var e=a.find,f=/:jqmData\(([^)]*)\)/g;a.find=function(b,
c,h,j){b=b.replace(f,"[data-"+(a.mobile.ns||"")+"$1]");return e.call(this,b,c,h,j)};a.extend(a.find,e);a.find.matches=function(b,c){return a.find(b,null,null,c)};a.find.matchesSelector=function(b,c){return a.find(c,null,null,[b]).length>0}})(jQuery,this);(function(a){a(s);var c=a("html");a.mobile.media=function(){var b={},e=a("<div id='jquery-mediatest'>"),f=a("<body>").append(e);return function(a){if(!(a in b)){var g=k.createElement("style"),h="@media "+a+" { #jquery-mediatest { position:absolute; } }";
g.type="text/css";g.styleSheet?g.styleSheet.cssText=h:g.appendChild(k.createTextNode(h));c.prepend(f).prepend(g);b[a]=e.css("position")==="absolute";f.add(g).remove()}return b[a]}}()})(jQuery);(function(a,c){function b(a){var b=a.charAt(0).toUpperCase()+a.substr(1),a=(a+" "+g.join(b+" ")+b).split(" "),f;for(f in a)if(d[a[f]]!==c)return true}function e(a,b,c){var d=k.createElement("div"),c=c?[c]:g,f;for(i=0;i<c.length;i++){var e=c[i],h="-"+e.charAt(0).toLowerCase()+e.substr(1)+"-"+a+": "+b+";",e=e.charAt(0).toUpperCase()+
e.substr(1)+(a.charAt(0).toUpperCase()+a.substr(1));d.setAttribute("style",h);d.style[e]&&(f=true)}return!!f}var f=a("<body>").prependTo("html"),d=f[0].style,g=["Webkit","Moz","O"],h="palmGetResource"in s,j=s.operamini&&{}.toString.call(s.operamini)==="[object OperaMini]",o=s.blackberry;a.extend(a.mobile,{browser:{}});a.mobile.browser.ie=function(){for(var a=3,b=k.createElement("div"),c=b.all||[];b.innerHTML="<\!--[if gt IE "+ ++a+"]><br><![endif]--\>",c[0];);return a>4?a:!a}();a.extend(a.support,
{orientation:"orientation"in s&&"onorientationchange"in s,touch:"ontouchend"in k,cssTransitions:"WebKitTransitionEvent"in s||e("transition","height 100ms linear"),pushState:"pushState"in history&&"replaceState"in history,mediaquery:a.mobile.media("only all"),cssPseudoElement:!!b("content"),touchOverflow:!!b("overflowScrolling"),cssTransform3d:e("perspective","10px","moz")||a.mobile.media("(-"+g.join("-transform-3d),(-")+"-transform-3d),(transform-3d)"),boxShadow:!!b("boxShadow")&&!o,scrollTop:("pageXOffset"in
s||"scrollTop"in k.documentElement||"scrollTop"in f[0])&&!h&&!j,dynamicBaseTag:function(){var b=location.protocol+"//"+location.host+location.pathname+"ui-dir/",c=a("head base"),d=null,e="",g;c.length?e=c.attr("href"):c=d=a("<base>",{href:b}).appendTo("head");g=a("<a href='testurl' />").prependTo(f)[0].href;c[0].href=e||location.pathname;d&&d.remove();return g.indexOf(b)===0}()});f.remove();h=function(){var a=s.navigator.userAgent;return a.indexOf("Nokia")>-1&&(a.indexOf("Symbian/3")>-1||a.indexOf("Series60/5")>
-1)&&a.indexOf("AppleWebKit")>-1&&a.match(/(BrowserNG|NokiaBrowser)\/7\.[0-3]/)}();a.mobile.gradeA=function(){return a.support.mediaquery||a.mobile.browser.ie&&a.mobile.browser.ie>=7};a.mobile.ajaxBlacklist=s.blackberry&&!s.WebKitPoint||j||h;h&&a(function(){a("head link[rel='stylesheet']").attr("rel","alternate stylesheet").attr("rel","stylesheet")});a.support.boxShadow||a("html").addClass("ui-mobile-nosupport-boxshadow")})(jQuery);(function(a,c,b){function e(b,c,d){var f=d.type;d.type=c;a.event.handle.call(b,
d);d.type=f}a.each("touchstart touchmove touchend orientationchange throttledresize tap taphold swipe swipeleft swiperight scrollstart scrollstop".split(" "),function(b,c){a.fn[c]=function(a){return a?this.bind(c,a):this.trigger(c)};a.attrFn[c]=true});var f=a.support.touch,d=f?"touchstart":"mousedown",g=f?"touchend":"mouseup",h=f?"touchmove":"mousemove";a.event.special.scrollstart={enabled:true,setup:function(){function b(a,f){d=f;e(c,d?"scrollstart":"scrollstop",a)}var c=this,d,f;a(c).bind("touchmove scroll",
function(c){a.event.special.scrollstart.enabled&&(d||b(c,true),clearTimeout(f),f=setTimeout(function(){b(c,false)},50))})}};a.event.special.tap={setup:function(){var b=this,c=a(b);c.bind("vmousedown",function(d){function f(){clearTimeout(q)}function g(){f();c.unbind("vclick",h).unbind("vmouseup",f);a(k).unbind("vmousecancel",g)}function h(a){g();n==a.target&&e(b,"tap",a)}if(d.which&&d.which!==1)return false;var n=d.target,q;c.bind("vmouseup",f).bind("vclick",h);a(k).bind("vmousecancel",g);q=setTimeout(function(){e(b,
"taphold",a.Event("taphold",{target:n}))},750)})}};a.event.special.swipe={scrollSupressionThreshold:10,durationThreshold:1E3,horizontalDistanceThreshold:30,verticalDistanceThreshold:75,setup:function(){var c=a(this);c.bind(d,function(d){function f(b){if(l){var c=b.originalEvent.touches?b.originalEvent.touches[0]:b;k={time:(new Date).getTime(),coords:[c.pageX,c.pageY]};Math.abs(l.coords[0]-k.coords[0])>a.event.special.swipe.scrollSupressionThreshold&&b.preventDefault()}}var e=d.originalEvent.touches?
d.originalEvent.touches[0]:d,l={time:(new Date).getTime(),coords:[e.pageX,e.pageY],origin:a(d.target)},k;c.bind(h,f).one(g,function(){c.unbind(h,f);l&&k&&k.time-l.time<a.event.special.swipe.durationThreshold&&Math.abs(l.coords[0]-k.coords[0])>a.event.special.swipe.horizontalDistanceThreshold&&Math.abs(l.coords[1]-k.coords[1])<a.event.special.swipe.verticalDistanceThreshold&&l.origin.trigger("swipe").trigger(l.coords[0]>k.coords[0]?"swipeleft":"swiperight");l=k=b})})}};(function(a,b){function c(){var a=
f();a!==e&&(e=a,d.trigger("orientationchange"))}var d=a(b),f,e,g,h,t={0:true,180:true};if(a.support.orientation&&(g=b.innerWidth||a(b).width(),h=b.innerHeight||a(b).height(),g=g>h&&g-h>50,h=t[b.orientation],g&&h||!g&&!h))t={"-90":true,90:true};a.event.special.orientationchange={setup:function(){if(a.support.orientation&&a.mobile.orientationChangeEnabled)return false;e=f();d.bind("throttledresize",c)},teardown:function(){if(a.support.orientation&&a.mobile.orientationChangeEnabled)return false;d.unbind("throttledresize",
c)},add:function(a){var b=a.handler;a.handler=function(a){a.orientation=f();return b.apply(this,arguments)}}};a.event.special.orientationchange.orientation=f=function(){var c=true,c=k.documentElement;return(c=a.support.orientation?t[b.orientation]:c&&c.clientWidth/c.clientHeight<1.1)?"portrait":"landscape"}})(jQuery,c);(function(){a.event.special.throttledresize={setup:function(){a(this).bind("resize",b)},teardown:function(){a(this).unbind("resize",b)}};var b=function(){f=(new Date).getTime();g=f-
c;g>=250?(c=f,a(this).trigger("throttledresize")):(d&&clearTimeout(d),d=setTimeout(b,250-g))},c=0,d,f,g})();a.each({scrollstop:"scrollstart",taphold:"tap",swipeleft:"swipe",swiperight:"swipe"},function(b,c){a.event.special[b]={setup:function(){a(this).bind(c,a.noop)}}})})(jQuery,this);(function(a){a.widget("mobile.page",a.mobile.widget,{options:{theme:"c",domCache:false,keepNativeDefault:":jqmData(role='none'), :jqmData(role='nojs')"},_create:function(){var a=this;if(a._trigger("beforecreate")===
false)return false;a.element.attr("tabindex","0").addClass("ui-page ui-body-"+a.options.theme).bind("pagebeforehide",function(){a.removeContainerBackground()}).bind("pagebeforeshow",function(){a.setContainerBackground()})},removeContainerBackground:function(){a.mobile.pageContainer.removeClass("ui-overlay-"+a.mobile.getInheritedTheme(this.element.parent()))},setContainerBackground:function(c){this.options.theme&&a.mobile.pageContainer.addClass("ui-overlay-"+(c||this.options.theme))},keepNativeSelector:function(){var c=
this.options;return c.keepNative&&a.trim(c.keepNative)&&c.keepNative!==c.keepNativeDefault?[c.keepNative,c.keepNativeDefault].join(", "):c.keepNativeDefault}})})(jQuery);(function(a,c,b){var e=function(d){d===b&&(d=true);return function(b,f,e,o){var k=new a.Deferred,p=f?" reverse":"",l=a.mobile.urlHistory.getActive().lastScroll||a.mobile.defaultHomeScroll,r=a.mobile.getScreenHeight(),n=a.mobile.maxTransitionWidth!==false&&a(c).width()>a.mobile.maxTransitionWidth,q=!a.support.cssTransitions||n||!b||
b==="none",t=function(){a.mobile.pageContainer.toggleClass("ui-mobile-viewport-transitioning viewport-"+b)},x=function(){a.event.special.scrollstart.enabled=false;c.scrollTo(0,l);setTimeout(function(){a.event.special.scrollstart.enabled=true},150)},u=function(){o.removeClass(a.mobile.activePageClass+" out in reverse "+b).height("")},n=function(){o&&d&&u();e.addClass(a.mobile.activePageClass);a.mobile.focusPage(e);e.height(r+l);x();q||e.animationComplete(w);e.addClass(b+" in"+p);q&&w()},w=function(){d||
o&&u();e.removeClass("out in reverse "+b).height("");t();a(c).scrollTop()!==l&&x();k.resolve(b,f,e,o,true)};t();o&&!q?(d?o.animationComplete(n):n(),o.height(r+a(c).scrollTop()).addClass(b+" out"+p)):n();return k.promise()}},f=e(),e=e(false);a.mobile.defaultTransitionHandler=f;a.mobile.transitionHandlers={"default":a.mobile.defaultTransitionHandler,sequential:f,simultaneous:e};a.mobile.transitionFallbacks={}})(jQuery,this);(function(a,c){function b(b){r&&(!r.closest(".ui-page-active").length||b)&&
r.removeClass(a.mobile.activeBtnClass);r=null}function e(){t=false;q.length>0&&a.mobile.changePage.apply(null,q.pop())}function f(b,c,d,f){c&&c.data("page")._trigger("beforehide",null,{nextPage:b});b.data("page")._trigger("beforeshow",null,{prevPage:c||a("")});a.mobile.hidePageLoadingMsg();d&&!a.support.cssTransform3d&&a.mobile.transitionFallbacks[d]&&(d=a.mobile.transitionFallbacks[d]);d=(a.mobile.transitionHandlers[d||"default"]||a.mobile.defaultTransitionHandler)(d,f,b,c);d.done(function(){c&&
c.data("page")._trigger("hide",null,{nextPage:b});b.data("page")._trigger("show",null,{prevPage:c||a("")})});return d}function d(){return s.innerHeight||a(s).height()}function g(){var b=a("."+a.mobile.activePageClass),c=parseFloat(b.css("padding-top")),f=parseFloat(b.css("padding-bottom"));b.css("min-height",d()-c-f)}function h(b,c){c&&b.attr("data-"+a.mobile.ns+"role",c);b.page()}function j(a){for(;a;){if(typeof a.nodeName==="string"&&a.nodeName.toLowerCase()=="a")break;a=a.parentNode}return a}function o(b){var b=
a(b).closest(".ui-page").jqmData("url"),c=v.hrefNoHash;if(!b||!l.isPath(b))b=c;return l.makeUrlAbsolute(b,c)}var m=a(s);a("html");var p=a("head"),l={urlParseRE:/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,parseUrl:function(b){if(a.type(b)==="object")return b;b=l.urlParseRE.exec(b||"")||[];return{href:b[0]||"",hrefNoHash:b[1]||"",hrefNoSearch:b[2]||"",domain:b[3]||"",
protocol:b[4]||"",doubleSlash:b[5]||"",authority:b[6]||"",username:b[8]||"",password:b[9]||"",host:b[10]||"",hostname:b[11]||"",port:b[12]||"",pathname:b[13]||"",directory:b[14]||"",filename:b[15]||"",search:b[16]||"",hash:b[17]||""}},makePathAbsolute:function(a,b){if(a&&a.charAt(0)==="/")return a;for(var a=a||"",c=(b=b?b.replace(/^\/|(\/[^\/]*|[^\/]+)$/g,""):"")?b.split("/"):[],d=a.split("/"),f=0;f<d.length;f++){var e=d[f];switch(e){case ".":break;case "..":c.length&&c.pop();break;default:c.push(e)}}return"/"+
c.join("/")},isSameDomain:function(a,b){return l.parseUrl(a).domain===l.parseUrl(b).domain},isRelativeUrl:function(a){return l.parseUrl(a).protocol===""},isAbsoluteUrl:function(a){return l.parseUrl(a).protocol!==""},makeUrlAbsolute:function(a,b){if(!l.isRelativeUrl(a))return a;var c=l.parseUrl(a),d=l.parseUrl(b),f=c.protocol||d.protocol,e=c.protocol?c.doubleSlash:c.doubleSlash||d.doubleSlash,g=c.authority||d.authority,h=c.pathname!=="",j=l.makePathAbsolute(c.pathname||d.filename,d.pathname);return f+
e+g+j+(c.search||!h&&d.search||"")+c.hash},addSearchParams:function(b,c){var d=l.parseUrl(b),f=typeof c==="object"?a.param(c):c,e=d.search||"?";return d.hrefNoSearch+e+(e.charAt(e.length-1)!=="?"?"&":"")+f+(d.hash||"")},convertUrlToDataUrl:function(a){var b=l.parseUrl(a);if(l.isEmbeddedPage(b))return b.hash.split(x)[0].replace(/^#/,"");else if(l.isSameDomain(b,v))return b.hrefNoHash.replace(v.domain,"");return a},get:function(a){if(a===c)a=location.hash;return l.stripHash(a).replace(/[^\/]*\.[^\/*]+$/,
"")},getFilePath:function(b){var c="&"+a.mobile.subPageUrlKey;return b&&b.split(c)[0].split(x)[0]},set:function(a){location.hash=a},isPath:function(a){return/\//.test(a)},clean:function(a){return a.replace(v.domain,"")},stripHash:function(a){return a.replace(/^#/,"")},cleanHash:function(a){return l.stripHash(a.replace(/\?.*$/,"").replace(x,""))},isExternal:function(a){a=l.parseUrl(a);return a.protocol&&a.domain!==w.domain?true:false},hasProtocol:function(a){return/^(:?\w+:)/.test(a)},isFirstPageUrl:function(b){var b=
l.parseUrl(l.makeUrlAbsolute(b,v)),d=a.mobile.firstPage,d=d&&d[0]?d[0].id:c;return(b.hrefNoHash===w.hrefNoHash||y&&b.hrefNoHash===v.hrefNoHash)&&(!b.hash||b.hash==="#"||d&&b.hash.replace(/^#/,"")===d)},isEmbeddedPage:function(a){a=l.parseUrl(a);return a.protocol!==""?a.hash&&(a.hrefNoHash===w.hrefNoHash||y&&a.hrefNoHash===v.hrefNoHash):/^#/.test(a.href)}},r=null,n={stack:[],activeIndex:0,getActive:function(){return n.stack[n.activeIndex]},getPrev:function(){return n.stack[n.activeIndex-1]},getNext:function(){return n.stack[n.activeIndex+
1]},addNew:function(a,b,c,d,f){n.getNext()&&n.clearForward();n.stack.push({url:a,transition:b,title:c,pageUrl:d,role:f});n.activeIndex=n.stack.length-1},clearForward:function(){n.stack=n.stack.slice(0,n.activeIndex+1)},directHashChange:function(b){var d,f,e;this.getActive();a.each(n.stack,function(a,c){b.currentUrl===c.url&&(d=a<n.activeIndex,f=!d,e=a)});this.activeIndex=e!==c?e:this.activeIndex;d?(b.either||b.isBack)(true):f&&(b.either||b.isForward)(false)},ignoreNextHashChange:false},q=[],t=false,
x="&ui-state=dialog",u=p.children("base"),w=l.parseUrl(location.href),v=u.length?l.parseUrl(l.makeUrlAbsolute(u.attr("href"),w.href)):w,y=w.hrefNoHash!==v.hrefNoHash,B=a.support.dynamicBaseTag?{element:u.length?u:a("<base>",{href:v.hrefNoHash}).prependTo(p),set:function(a){B.element.attr("href",l.makeUrlAbsolute(a,v))},reset:function(){B.element.attr("href",v.hrefNoHash)}}:c;a.mobile.focusPage=function(a){var b=a.find("[autofocus]"),c=a.find(".ui-title:eq(0)");b.length?b.focus():c.length?c.focus():
a.focus()};var E=true,A,C;A=function(){if(E){var b=a.mobile.urlHistory.getActive();if(b){var c=m.scrollTop();b.lastScroll=c<a.mobile.minScrollBack?a.mobile.defaultHomeScroll:c}}};C=function(){setTimeout(A,100)};m.bind(a.support.pushState?"popstate":"hashchange",function(){E=false});m.one(a.support.pushState?"popstate":"hashchange",function(){E=true});m.one("pagecontainercreate",function(){a.mobile.pageContainer.bind("pagechange",function(){E=true;m.unbind("scrollstop",C);m.bind("scrollstop",C)})});
m.bind("scrollstop",C);a.mobile.getScreenHeight=d;a.fn.animationComplete=function(b){return a.support.cssTransitions?a(this).one("webkitAnimationEnd animationend",b):(setTimeout(b,0),a(this))};a.mobile.path=l;a.mobile.base=B;a.mobile.urlHistory=n;a.mobile.dialogHashKey=x;a.mobile.allowCrossDomainPages=false;a.mobile.getDocumentUrl=function(b){return b?a.extend({},w):w.href};a.mobile.getDocumentBase=function(b){return b?a.extend({},v):v.href};a.mobile._bindPageRemove=function(){var b=a(this);!b.data("page").options.domCache&&
b.is(":jqmData(external-page='true')")&&b.bind("pagehide.remove",function(){var b=a(this),c=new a.Event("pageremove");b.trigger(c);c.isDefaultPrevented()||b.removeWithDependents()})};a.mobile.loadPage=function(b,d){var f=a.Deferred(),e=a.extend({},a.mobile.loadPage.defaults,d),g=null,j=null,k=l.makeUrlAbsolute(b,a.mobile.activePage&&o(a.mobile.activePage)||v.hrefNoHash);if(e.data&&e.type==="get")k=l.addSearchParams(k,e.data),e.data=c;if(e.data&&e.type==="post")e.reloadPage=true;var u=l.getFilePath(k),
n=l.convertUrlToDataUrl(k);e.pageContainer=e.pageContainer||a.mobile.pageContainer;g=e.pageContainer.children(":jqmData(url='"+n+"')");g.length===0&&n&&!l.isPath(n)&&(g=e.pageContainer.children("#"+n).attr("data-"+a.mobile.ns+"url",n));if(g.length===0)if(a.mobile.firstPage&&l.isFirstPageUrl(u))a.mobile.firstPage.parent().length&&(g=a(a.mobile.firstPage));else if(l.isEmbeddedPage(u))return f.reject(k,d),f.promise();B&&B.reset();if(g.length){if(!e.reloadPage)return h(g,e.role),f.resolve(k,d,g),f.promise();
j=g}var m=e.pageContainer,x=new a.Event("pagebeforeload"),p={url:b,absUrl:k,dataUrl:n,deferred:f,options:e};m.trigger(x,p);if(x.isDefaultPrevented())return f.promise();if(e.showLoadMsg)var r=setTimeout(function(){a.mobile.showPageLoadingMsg()},e.loadMsgDelay);!a.mobile.allowCrossDomainPages&&!l.isSameDomain(w,k)?f.reject(k,d):a.ajax({url:u,type:e.type,data:e.data,dataType:"html",success:function(c,o,m){var x=a("<div></div>"),v=c.match(/<title[^>]*>([^<]*)/)&&RegExp.$1,w=RegExp("\\bdata-"+a.mobile.ns+
"url=[\"']?([^\"'>]*)[\"']?");RegExp("(<[^>]+\\bdata-"+a.mobile.ns+"role=[\"']?page[\"']?[^>]*>)").test(c)&&RegExp.$1&&w.test(RegExp.$1)&&RegExp.$1&&(b=u=l.getFilePath(RegExp.$1));B&&B.set(u);x.get(0).innerHTML=c;g=x.find(":jqmData(role='page'), :jqmData(role='dialog')").first();g.length||(g=a("<div data-"+a.mobile.ns+"role='page'>"+c.split(/<\/?body[^>]*>/gmi)[1]+"</div>"));v&&!g.jqmData("title")&&(~v.indexOf("&")&&(v=a("<div>"+v+"</div>").text()),g.jqmData("title",v));if(!a.support.dynamicBaseTag){var q=
l.get(u);g.find("[src], link[href], a[rel='external'], :jqmData(ajax='false'), a[target]").each(function(){var b=a(this).is("[href]")?"href":a(this).is("[src]")?"src":"action",c=a(this).attr(b),c=c.replace(location.protocol+"//"+location.host+location.pathname,"");/^(\w+:|#|\/)/.test(c)||a(this).attr(b,q+c)})}g.attr("data-"+a.mobile.ns+"url",l.convertUrlToDataUrl(u)).attr("data-"+a.mobile.ns+"external-page",true).appendTo(e.pageContainer);g.one("pagecreate",a.mobile._bindPageRemove);h(g,e.role);k.indexOf("&"+
a.mobile.subPageUrlKey)>-1&&(g=e.pageContainer.children(":jqmData(url='"+n+"')"));e.showLoadMsg&&(clearTimeout(r),a.mobile.hidePageLoadingMsg());p.xhr=m;p.textStatus=o;p.page=g;e.pageContainer.trigger("pageload",p);f.resolve(k,d,g,j)},error:function(b,c,g){B&&B.set(l.get());p.xhr=b;p.textStatus=c;p.errorThrown=g;b=new a.Event("pageloadfailed");e.pageContainer.trigger(b,p);b.isDefaultPrevented()||(e.showLoadMsg&&(clearTimeout(r),a.mobile.hidePageLoadingMsg(),a.mobile.showPageLoadingMsg(a.mobile.pageLoadErrorMessageTheme,
a.mobile.pageLoadErrorMessage,true),setTimeout(a.mobile.hidePageLoadingMsg,1500)),f.reject(k,d))}});return f.promise()};a.mobile.loadPage.defaults={type:"get",data:c,reloadPage:false,role:c,showLoadMsg:false,pageContainer:c,loadMsgDelay:50};a.mobile.changePage=function(d,g){if(t)q.unshift(arguments);else{var j=a.extend({},a.mobile.changePage.defaults,g);j.pageContainer=j.pageContainer||a.mobile.pageContainer;j.fromPage=j.fromPage||a.mobile.activePage;var u=j.pageContainer,o=new a.Event("pagebeforechange"),
m={toPage:d,options:j};u.trigger(o,m);if(!o.isDefaultPrevented())if(d=m.toPage,t=true,typeof d=="string")a.mobile.loadPage(d,j).done(function(b,c,d,e){t=false;c.duplicateCachedPage=e;a.mobile.changePage(d,c)}).fail(function(){t=false;b(true);e();j.pageContainer.trigger("pagechangefailed",m)});else{if(d[0]===a.mobile.firstPage[0]&&!j.dataUrl)j.dataUrl=w.hrefNoHash;var o=j.fromPage,p=j.dataUrl&&l.convertUrlToDataUrl(j.dataUrl)||d.jqmData("url"),v=p;l.getFilePath(p);var r=n.getActive(),s=n.activeIndex===
0,y=0,B=k.title,A=j.role==="dialog"||d.jqmData("role")==="dialog";if(o&&o[0]===d[0]&&!j.allowSamePageTransition)t=false,u.trigger("pagechange",m);else{h(d,j.role);j.fromHashChange&&n.directHashChange({currentUrl:p,isBack:function(){y=-1},isForward:function(){y=1}});try{k.activeElement&&k.activeElement.nodeName.toLowerCase()!="body"?a(k.activeElement).blur():a("input:focus, textarea:focus, select:focus").blur()}catch(E){}A&&r&&(p=(r.url||"")+x);if(j.changeHash!==false&&p)n.ignoreNextHashChange=true,
l.set(p);var C=!r?B:d.jqmData("title")||d.children(":jqmData(role='header')").find(".ui-title").getEncodedText();C&&B==k.title&&(B=C);d.jqmData("title")||d.jqmData("title",B);j.transition=j.transition||(y&&!s?r.transition:c)||(A?a.mobile.defaultDialogTransition:a.mobile.defaultPageTransition);y||n.addNew(p,j.transition,B,v,j.role);k.title=n.getActive().title;a.mobile.activePage=d;j.reverse=j.reverse||y<0;f(d,o,j.transition,j.reverse).done(function(c,f,g,h,l){b();j.duplicateCachedPage&&j.duplicateCachedPage.remove();
l||a.mobile.focusPage(d);e();u.trigger("pagechange",m)})}}}};a.mobile.changePage.defaults={transition:c,reverse:false,changeHash:true,fromHashChange:false,role:c,duplicateCachedPage:c,pageContainer:c,showLoadMsg:true,dataUrl:c,fromPage:c,allowSamePageTransition:false};a.mobile._registerInternalEvents=function(){a(k).delegate("form","submit",function(b){var c=a(this);if(a.mobile.ajaxEnabled&&!c.is(":jqmData(ajax='false')")&&c.jqmHijackable().length){var d=c.attr("method"),e=c.attr("target"),f=c.attr("action");
if(!f&&(f=o(c),f===v.hrefNoHash))f=w.hrefNoSearch;f=l.makeUrlAbsolute(f,o(c));!l.isExternal(f)&&!e&&(a.mobile.changePage(f,{type:d&&d.length&&d.toLowerCase()||"get",data:c.serialize(),transition:c.jqmData("transition"),direction:c.jqmData("direction"),reloadPage:true}),b.preventDefault())}});a(k).bind("vclick",function(c){if(!(c.which>1)&&a.mobile.linkBindingEnabled&&(c=j(c.target),a(c).jqmHijackable().length&&c&&l.parseUrl(c.getAttribute("href")||"#").hash!=="#"))b(true),r=a(c).closest(".ui-btn").not(".ui-disabled"),
r.addClass(a.mobile.activeBtnClass),a("."+a.mobile.activePageClass+" .ui-btn").not(c).blur(),a(c).jqmData("href",a(c).attr("href")).attr("href","#")});a(k).bind("click",function(d){if(a.mobile.linkBindingEnabled){var f=j(d.target),e=a(f),g;if(f&&!(d.which>1)&&e.jqmHijackable().length){g=function(){s.setTimeout(function(){b(true)},200)};e.jqmData("href")&&e.attr("href",e.jqmData("href"));if(e.is(":jqmData(rel='back')"))return s.history.back(),false;var h=o(e),f=l.makeUrlAbsolute(e.attr("href")||"#",
h);if(!a.mobile.ajaxEnabled&&!l.isEmbeddedPage(f))g();else{if(f.search("#")!=-1)if(f=f.replace(/[^#]*#/,""))f=l.isPath(f)?l.makeUrlAbsolute(f,h):l.makeUrlAbsolute("#"+f,w.hrefNoHash);else{d.preventDefault();return}var h=e.is("[rel='external']")||e.is(":jqmData(ajax='false')")||e.is("[target]"),k=a.mobile.allowCrossDomainPages&&w.protocol==="file:"&&f.search(/^https?:/)!=-1;h||l.isExternal(f)&&!k?g():(g=e.jqmData("transition"),h=(h=e.jqmData("direction"))&&h==="reverse"||e.jqmData("back"),e=e.attr("data-"+
a.mobile.ns+"rel")||c,a.mobile.changePage(f,{transition:g,reverse:h,role:e}),d.preventDefault())}}}});a(k).delegate(".ui-page","pageshow.prefetch",function(){var b=[];a(this).find("a:jqmData(prefetch)").each(function(){var c=a(this),d=c.attr("href");d&&a.inArray(d,b)===-1&&(b.push(d),a.mobile.loadPage(d,{role:c.attr("data-"+a.mobile.ns+"rel")}))})});a.mobile._handleHashChange=function(b){var d=l.stripHash(b),f={transition:a.mobile.urlHistory.stack.length===0?"none":c,changeHash:false,fromHashChange:true};
if(!a.mobile.hashListeningEnabled||n.ignoreNextHashChange)n.ignoreNextHashChange=false;else{if(n.stack.length>1&&d.indexOf(x)>-1)if(a.mobile.activePage.is(".ui-dialog"))n.directHashChange({currentUrl:d,either:function(b){var c=a.mobile.urlHistory.getActive();d=c.pageUrl;a.extend(f,{role:c.role,transition:c.transition,reverse:b})}});else{n.directHashChange({currentUrl:d,isBack:function(){s.history.back()},isForward:function(){s.history.forward()}});return}d?(d=typeof d==="string"&&!l.isPath(d)?l.makeUrlAbsolute("#"+
d,v):d,a.mobile.changePage(d,f)):a.mobile.changePage(a.mobile.firstPage,f)}};m.bind("hashchange",function(){a.mobile._handleHashChange(location.hash)});a(k).bind("pageshow",g);a(s).bind("throttledresize",g)}})(jQuery);(function(a,c){var b={},e=a(c),f=a.mobile.path.parseUrl(location.href);a.extend(b,{initialFilePath:f.pathname+f.search,initialHref:f.hrefNoHash,state:function(){return{hash:location.hash||"#"+b.initialFilePath,title:k.title,initialHref:b.initialHref}},resetUIKeys:function(b){var c="&"+
a.mobile.subPageUrlKey,f=b.indexOf(a.mobile.dialogHashKey);f>-1?b=b.slice(0,f)+"#"+b.slice(f):b.indexOf(c)>-1&&(b=b.split(c).join("#"+c));return b},hashValueAfterReset:function(c){c=b.resetUIKeys(c);return a.mobile.path.parseUrl(c).hash},nextHashChangePrevented:function(c){a.mobile.urlHistory.ignoreNextHashChange=c;b.onHashChangeDisabled=c},onHashChange:function(){if(!b.onHashChangeDisabled){var c,f;c=location.hash;var e=a.mobile.path.isPath(c),j=e?location.href:a.mobile.getDocumentUrl();c=e?c.replace("#",
""):c;f=b.state();c=a.mobile.path.makeUrlAbsolute(c,j);e&&(c=b.resetUIKeys(c));history.replaceState(f,k.title,c)}},onPopState:function(c){var c=c.originalEvent.state,f,h;if(c){f=b.hashValueAfterReset(a.mobile.urlHistory.getActive().url);h=b.hashValueAfterReset(c.hash.replace("#",""));if(f=f!==h)e.one("hashchange.pushstate",function(){b.nextHashChangePrevented(false)});b.nextHashChangePrevented(false);a.mobile._handleHashChange(c.hash);f&&b.nextHashChangePrevented(true)}},init:function(){e.bind("hashchange",
b.onHashChange);e.bind("popstate",b.onPopState);location.hash===""&&history.replaceState(b.state(),k.title,location.href)}});a(function(){a.mobile.pushStateEnabled&&a.support.pushState&&b.init()})})(jQuery,this);jQuery.mobile.transitionFallbacks.pop="fade";(function(a){a.mobile.transitionHandlers.slide=a.mobile.transitionHandlers.simultaneous;a.mobile.transitionFallbacks.slide="fade"})(jQuery,this);jQuery.mobile.transitionFallbacks.slidedown="fade";jQuery.mobile.transitionFallbacks.slideup="fade";
jQuery.mobile.transitionFallbacks.flip="fade";jQuery.mobile.transitionFallbacks.flow="fade";jQuery.mobile.transitionFallbacks.turn="fade";(function(a){a.mobile.page.prototype.options.degradeInputs={color:false,date:false,datetime:false,"datetime-local":false,email:false,month:false,number:false,range:"number",search:"text",tel:false,time:false,url:false,week:false};a(k).bind("pagecreate create",function(c){var b=a.mobile.closestPageData(a(c.target)),e;if(b)e=b.options,a(c.target).find("input").not(b.keepNativeSelector()).each(function(){var b=
a(this),c=this.getAttribute("type"),g=e.degradeInputs[c]||"text";if(e.degradeInputs[c]){var h=a("<div>").html(b.clone()).html(),j=h.indexOf(" type=")>-1;b.replaceWith(h.replace(j?/\s+type=["']?\w+['"]?/:/\/?>/,' type="'+g+'" data-'+a.mobile.ns+'type="'+c+'"'+(j?"":">")))}})})})(jQuery);(function(a,c){a.widget("mobile.dialog",a.mobile.widget,{options:{closeBtnText:"Close",overlayTheme:"a",initSelector:":jqmData(role='dialog')"},_create:function(){var b=this,c=this.element,f=a("<a href='#' data-"+a.mobile.ns+
"icon='delete' data-"+a.mobile.ns+"iconpos='notext'>"+this.options.closeBtnText+"</a>"),d=a("<div/>",{role:"dialog","class":"ui-dialog-contain ui-corner-all ui-overlay-shadow"});c.addClass("ui-dialog ui-overlay-"+this.options.overlayTheme);c.wrapInner(d).children().find(":jqmData(role='header')").prepend(f).end().children(":first-child").addClass("ui-corner-top").end().children(":last-child").addClass("ui-corner-bottom");f.bind("click",function(){b.close()});c.bind("vclick submit",function(b){var b=
a(b.target).closest(b.type==="vclick"?"a":"form"),c;b.length&&!b.jqmData("transition")&&(c=a.mobile.urlHistory.getActive()||{},b.attr("data-"+a.mobile.ns+"transition",c.transition||a.mobile.defaultDialogTransition).attr("data-"+a.mobile.ns+"direction","reverse"))}).bind("pagehide",function(){a(this).find("."+a.mobile.activeBtnClass).removeClass(a.mobile.activeBtnClass)}).bind("pagebeforeshow",function(){b.options.overlayTheme&&b.element.page("removeContainerBackground").page("setContainerBackground",
b.options.overlayTheme)})},close:function(){c.history.back()}});a(k).delegate(a.mobile.dialog.prototype.options.initSelector,"pagecreate",function(){a.mobile.dialog.prototype.enhance(this)})})(jQuery,this);(function(a){a.fn.fieldcontain=function(){return this.addClass("ui-field-contain ui-body ui-br")};a(k).bind("pagecreate create",function(c){a(":jqmData(role='fieldcontain')",c.target).jqmEnhanceable().fieldcontain()})})(jQuery);(function(a){a.fn.grid=function(c){return this.each(function(){var b=
a(this),e=a.extend({grid:null},c),f=b.children(),d={solo:1,a:2,b:3,c:4,d:5},e=e.grid;if(!e)if(f.length<=5)for(var g in d)d[g]===f.length&&(e=g);else e="a";d=d[e];b.addClass("ui-grid-"+e);f.filter(":nth-child("+d+"n+1)").addClass("ui-block-a");d>1&&f.filter(":nth-child("+d+"n+2)").addClass("ui-block-b");d>2&&f.filter(":nth-child(3n+3)").addClass("ui-block-c");d>3&&f.filter(":nth-child(4n+4)").addClass("ui-block-d");d>4&&f.filter(":nth-child(5n+5)").addClass("ui-block-e")})}})(jQuery);(function(a){a(k).bind("pagecreate create",
function(c){a(":jqmData(role='nojs')",c.target).addClass("ui-nojs")})})(jQuery);(function(a,c){function b(a){for(var b;a;){if((b=typeof a.className==="string"&&a.className+" ")&&b.indexOf("ui-btn ")>-1&&b.indexOf("ui-disabled ")<0)break;a=a.parentNode}return a}a.fn.buttonMarkup=function(b){for(var b=b&&a.type(b)=="object"?b:{},d=0;d<this.length;d++){var g=this.eq(d),h=g[0],j=a.extend({},a.fn.buttonMarkup.defaults,{icon:b.icon!==c?b.icon:g.jqmData("icon"),iconpos:b.iconpos!==c?b.iconpos:g.jqmData("iconpos"),
theme:b.theme!==c?b.theme:g.jqmData("theme")||a.mobile.getInheritedTheme(g,"c"),inline:b.inline!==c?b.inline:g.jqmData("inline"),shadow:b.shadow!==c?b.shadow:g.jqmData("shadow"),corners:b.corners!==c?b.corners:g.jqmData("corners"),iconshadow:b.iconshadow!==c?b.iconshadow:g.jqmData("iconshadow"),mini:b.mini!==c?b.mini:g.jqmData("mini")},b),o="ui-btn-inner",m,p,l,r,n,q;a.each(j,function(b,c){h.setAttribute("data-"+a.mobile.ns+b,c);g.jqmData(b,c)});(q=a.data(h.tagName==="INPUT"||h.tagName==="BUTTON"?
h.parentNode:h,"buttonElements"))?(h=q.outer,g=a(h),l=q.inner,r=q.text,a(q.icon).remove(),q.icon=null):(l=k.createElement(j.wrapperEls),r=k.createElement(j.wrapperEls));n=j.icon?k.createElement("span"):null;e&&!q&&e();if(!j.theme)j.theme=a.mobile.getInheritedTheme(g,"c");m="ui-btn ui-btn-up-"+j.theme;m+=j.inline?" ui-btn-inline":"";m+=j.shadow?" ui-shadow":"";m+=j.corners?" ui-btn-corner-all":"";j.mini!==c&&(m+=j.mini?" ui-mini":" ui-fullsize");j.inline!==c&&(m+=j.inline===false?" ui-btn-block":" ui-btn-inline");
if(j.icon)j.icon="ui-icon-"+j.icon,j.iconpos=j.iconpos||"left",p="ui-icon "+j.icon,j.iconshadow&&(p+=" ui-icon-shadow");j.iconpos&&(m+=" ui-btn-icon-"+j.iconpos,j.iconpos=="notext"&&!g.attr("title")&&g.attr("title",g.getEncodedText()));o+=j.corners?" ui-btn-corner-all":"";j.iconpos&&j.iconpos==="notext"&&!g.attr("title")&&g.attr("title",g.getEncodedText());q&&g.removeClass(q.bcls||"");g.removeClass("ui-link").addClass(m);l.className=o;r.className="ui-btn-text";q||l.appendChild(r);if(n&&(n.className=
p,!q||!q.icon))n.appendChild(k.createTextNode("\u00a0")),l.appendChild(n);for(;h.firstChild&&!q;)r.appendChild(h.firstChild);q||h.appendChild(l);q={bcls:m,outer:h,inner:l,text:r,icon:n};a.data(h,"buttonElements",q);a.data(l,"buttonElements",q);a.data(r,"buttonElements",q);n&&a.data(n,"buttonElements",q)}return this};a.fn.buttonMarkup.defaults={corners:true,shadow:true,iconshadow:true,wrapperEls:"span"};var e=function(){var c=a.mobile.buttonMarkup.hoverDelay,d,g;a(k).bind({"vmousedown vmousecancel vmouseup vmouseover vmouseout focus blur scrollstart":function(e){var j,
k=a(b(e.target)),e=e.type;if(k.length)if(j=k.attr("data-"+a.mobile.ns+"theme"),e==="vmousedown")a.support.touch?d=setTimeout(function(){k.removeClass("ui-btn-up-"+j).addClass("ui-btn-down-"+j)},c):k.removeClass("ui-btn-up-"+j).addClass("ui-btn-down-"+j);else if(e==="vmousecancel"||e==="vmouseup")k.removeClass("ui-btn-down-"+j).addClass("ui-btn-up-"+j);else if(e==="vmouseover"||e==="focus")a.support.touch?g=setTimeout(function(){k.removeClass("ui-btn-up-"+j).addClass("ui-btn-hover-"+j)},c):k.removeClass("ui-btn-up-"+
j).addClass("ui-btn-hover-"+j);else if(e==="vmouseout"||e==="blur"||e==="scrollstart")k.removeClass("ui-btn-hover-"+j+" ui-btn-down-"+j).addClass("ui-btn-up-"+j),d&&clearTimeout(d),g&&clearTimeout(g)},"focusin focus":function(c){a(b(c.target)).addClass(a.mobile.focusClass)},"focusout blur":function(c){a(b(c.target)).removeClass(a.mobile.focusClass)}});e=null};a(k).bind("pagecreate create",function(b){a(":jqmData(role='button'), .ui-bar > a, .ui-header > a, .ui-footer > a, .ui-bar > :jqmData(role='controlgroup') > a",
b.target).not(".ui-btn, :jqmData(role='none'), :jqmData(role='nojs')").buttonMarkup()})})(jQuery);(function(a){a.mobile.page.prototype.options.backBtnText="Back";a.mobile.page.prototype.options.addBackBtn=false;a.mobile.page.prototype.options.backBtnTheme=null;a.mobile.page.prototype.options.headerTheme="a";a.mobile.page.prototype.options.footerTheme="a";a.mobile.page.prototype.options.contentTheme=null;a(k).delegate(":jqmData(role='page'), :jqmData(role='dialog')","pagecreate",function(){var c=a(this),
b=c.data("page").options,e=c.jqmData("role"),f=b.theme;a(":jqmData(role='header'), :jqmData(role='footer'), :jqmData(role='content')",this).jqmEnhanceable().each(function(){var d=a(this),g=d.jqmData("role"),h=d.jqmData("theme"),j=h||b.contentTheme||e==="dialog"&&f,k;d.addClass("ui-"+g);if(g==="header"||g==="footer"){var m=h||(g==="header"?b.headerTheme:b.footerTheme)||f;d.addClass("ui-bar-"+m).attr("role",g==="header"?"banner":"contentinfo");g==="header"&&(h=d.children("a"),k=h.hasClass("ui-btn-left"),
j=h.hasClass("ui-btn-right"),k=k||h.eq(0).not(".ui-btn-right").addClass("ui-btn-left").length,j||h.eq(1).addClass("ui-btn-right"));b.addBackBtn&&g==="header"&&a(".ui-page").length>1&&c.jqmData("url")!==a.mobile.path.stripHash(location.hash)&&!k&&a("<a href='#' class='ui-btn-left' data-"+a.mobile.ns+"rel='back' data-"+a.mobile.ns+"icon='arrow-l'>"+b.backBtnText+"</a>").attr("data-"+a.mobile.ns+"theme",b.backBtnTheme||m).prependTo(d);d.children("h1, h2, h3, h4, h5, h6").addClass("ui-title").attr({role:"heading",
"aria-level":"1"})}else g==="content"&&(j&&d.addClass("ui-body-"+j),d.attr("role","main"))})})})(jQuery);(function(a){a.widget("mobile.collapsible",a.mobile.widget,{options:{expandCueText:" click to expand contents",collapseCueText:" click to collapse contents",collapsed:true,heading:"h1,h2,h3,h4,h5,h6,legend",theme:null,contentTheme:null,iconTheme:"d",mini:false,initSelector:":jqmData(role='collapsible')"},_create:function(){var c=this.element,b=this.options,e=c.addClass("ui-collapsible"),f=c.children(b.heading).first(),
d=e.wrapInner("<div class='ui-collapsible-content'></div>").find(".ui-collapsible-content"),g=c.closest(":jqmData(role='collapsible-set')").addClass("ui-collapsible-set");f.is("legend")&&(f=a("<div role='heading'>"+f.html()+"</div>").insertBefore(f),f.next().remove());if(g.length){if(!b.theme)b.theme=g.jqmData("theme")||a.mobile.getInheritedTheme(g,"c");if(!b.contentTheme)b.contentTheme=g.jqmData("content-theme");if(!b.iconPos)b.iconPos=g.jqmData("iconpos");if(!b.mini)b.mini=g.jqmData("mini")}d.addClass(b.contentTheme?
"ui-body-"+b.contentTheme:"");f.insertBefore(d).addClass("ui-collapsible-heading").append("<span class='ui-collapsible-heading-status'></span>").wrapInner("<a href='#' class='ui-collapsible-heading-toggle'></a>").find("a").first().buttonMarkup({shadow:false,corners:false,iconpos:c.jqmData("iconpos")||b.iconPos||"left",icon:"plus",mini:b.mini,theme:b.theme}).add(".ui-btn-inner",c).addClass("ui-corner-top ui-corner-bottom");e.bind("expand collapse",function(c){if(!c.isDefaultPrevented()){c.preventDefault();
var j=a(this),c=c.type==="collapse",k=b.contentTheme;f.toggleClass("ui-collapsible-heading-collapsed",c).find(".ui-collapsible-heading-status").text(c?b.expandCueText:b.collapseCueText).end().find(".ui-icon").toggleClass("ui-icon-minus",!c).toggleClass("ui-icon-plus",c);j.toggleClass("ui-collapsible-collapsed",c);d.toggleClass("ui-collapsible-content-collapsed",c).attr("aria-hidden",c);if(k&&(!g.length||e.jqmData("collapsible-last")))f.find("a").first().add(f.find(".ui-btn-inner")).toggleClass("ui-corner-bottom",
c),d.toggleClass("ui-corner-bottom",!c);d.trigger("updatelayout")}}).trigger(b.collapsed?"collapse":"expand");f.bind("click",function(a){var b=f.is(".ui-collapsible-heading-collapsed")?"expand":"collapse";e.trigger(b);a.preventDefault()})}});a(k).bind("pagecreate create",function(c){a.mobile.collapsible.prototype.enhanceWithin(c.target)})})(jQuery);(function(a,c){a.widget("mobile.collapsibleset",a.mobile.widget,{options:{initSelector:":jqmData(role='collapsible-set')"},_create:function(){var b=this.element.addClass("ui-collapsible-set"),
e=this.options;if(!e.theme)e.theme=a.mobile.getInheritedTheme(b,"c");if(!e.contentTheme)e.contentTheme=b.jqmData("content-theme");if(!e.corners)e.corners=b.jqmData("corners")===c?true:false;b.jqmData("collapsiblebound")||b.jqmData("collapsiblebound",true).bind("expand collapse",function(b){var c=b.type==="collapse",b=a(b.target).closest(".ui-collapsible"),e=b.data("collapsible");e.options.contentTheme&&b.jqmData("collapsible-last")&&(b.find(e.options.heading).first().find("a").first().add(".ui-btn-inner").toggleClass("ui-corner-bottom",
c),b.find(".ui-collapsible-content").toggleClass("ui-corner-bottom",!c))}).bind("expand",function(b){a(b.target).closest(".ui-collapsible").siblings(".ui-collapsible").trigger("collapse")})},_init:function(){this.refresh()},refresh:function(){var b=this.options,c=this.element.children(":jqmData(role='collapsible')");a.mobile.collapsible.prototype.enhance(c.not(".ui-collapsible"));c.each(function(){a(this).find(a.mobile.collapsible.prototype.options.heading).find("a").first().add(".ui-btn-inner").removeClass("ui-corner-top ui-corner-bottom")});
c.first().find("a").first().addClass(b.corners?"ui-corner-top":"").find(".ui-btn-inner").addClass("ui-corner-top");c.last().jqmData("collapsible-last",true).find("a").first().addClass(b.corners?"ui-corner-bottom":"").find(".ui-btn-inner").addClass("ui-corner-bottom")}});a(k).bind("pagecreate create",function(b){a.mobile.collapsibleset.prototype.enhanceWithin(b.target)})})(jQuery);(function(a,c){a.widget("mobile.navbar",a.mobile.widget,{options:{iconpos:"top",grid:null,initSelector:":jqmData(role='navbar')"},
_create:function(){var b=this.element,e=b.find("a"),f=e.filter(":jqmData(icon)").length?this.options.iconpos:c;b.addClass("ui-navbar").attr("role","navigation").find("ul").jqmEnhanceable().grid({grid:this.options.grid});f||b.addClass("ui-navbar-noicons");e.buttonMarkup({corners:false,shadow:false,inline:true,iconpos:f});b.delegate("a","vclick",function(b){a(b.target).hasClass("ui-disabled")||(e.removeClass(a.mobile.activeBtnClass),a(this).addClass(a.mobile.activeBtnClass))});b.closest(".ui-page").bind("pagebeforeshow",
function(){e.filter(".ui-state-persist").addClass(a.mobile.activeBtnClass)})}});a(k).bind("pagecreate create",function(b){a.mobile.navbar.prototype.enhanceWithin(b.target)})})(jQuery);(function(a){var c={};a.widget("mobile.listview",a.mobile.widget,{options:{theme:null,countTheme:"c",headerTheme:"b",dividerTheme:"b",splitIcon:"arrow-r",splitTheme:"b",mini:false,inset:false,initSelector:":jqmData(role='listview')"},_create:function(){var a="";a+=this.options.inset?" ui-listview-inset ui-corner-all ui-shadow ":
"";a+=this.element.jqmData("mini")||this.options.mini===true?" ui-mini":"";this.element.addClass(function(c,f){return f+" ui-listview "+a});this.refresh(true)},_removeCorners:function(a,c){a=a.add(a.find(".ui-btn-inner, .ui-li-link-alt, .ui-li-thumb"));c==="top"?a.removeClass("ui-corner-top ui-corner-tr ui-corner-tl"):c==="bottom"?a.removeClass("ui-corner-bottom ui-corner-br ui-corner-bl"):a.removeClass("ui-corner-top ui-corner-tr ui-corner-tl ui-corner-bottom ui-corner-br ui-corner-bl")},_refreshCorners:function(a){var c,
f;this.options.inset&&(c=this.element.children("li"),f=a?c.not(".ui-screen-hidden"):c.filter(":visible"),this._removeCorners(c),c=f.first().addClass("ui-corner-top"),c.add(c.find(".ui-btn-inner").not(".ui-li-link-alt span:first-child")).addClass("ui-corner-top").end().find(".ui-li-link-alt, .ui-li-link-alt span:first-child").addClass("ui-corner-tr").end().find(".ui-li-thumb").not(".ui-li-icon").addClass("ui-corner-tl"),f=f.last().addClass("ui-corner-bottom"),f.add(f.find(".ui-btn-inner")).find(".ui-li-link-alt").addClass("ui-corner-br").end().find(".ui-li-thumb").not(".ui-li-icon").addClass("ui-corner-bl"));
a||this.element.trigger("updatelayout")},_findFirstElementByTagName:function(a,c,f,d){var g={};for(g[f]=g[d]=true;a;){if(g[a.nodeName])return a;a=a[c]}return null},_getChildrenByTagName:function(b,c,f){var d=[],g={};g[c]=g[f]=true;for(b=b.firstChild;b;)g[b.nodeName]&&d.push(b),b=b.nextSibling;return a(d)},_addThumbClasses:function(b){var c,f,d=b.length;for(c=0;c<d;c++)f=a(this._findFirstElementByTagName(b[c].firstChild,"nextSibling","img","IMG")),f.length&&(f.addClass("ui-li-thumb"),a(this._findFirstElementByTagName(f[0].parentNode,
"parentNode","li","LI")).addClass(f.is(".ui-li-icon")?"ui-li-has-icon":"ui-li-has-thumb"))},refresh:function(b){this.parentPage=this.element.closest(".ui-page");this._createSubPages();var c=this.options,f=this.element,d=f.jqmData("dividertheme")||c.dividerTheme,g=f.jqmData("splittheme"),h=f.jqmData("spliticon"),j=this._getChildrenByTagName(f[0],"li","LI"),o=a.support.cssPseudoElement||!a.nodeName(f[0],"ol")?0:1,m={},p,l,r,n,q,t,x;o&&f.find(".ui-li-dec").remove();if(!c.theme)c.theme=a.mobile.getInheritedTheme(this.element,
"c");for(var u=0,w=j.length;u<w;u++){p=j.eq(u);l="ui-li";if(b||!p.hasClass("ui-li"))r=p.jqmData("theme")||c.theme,n=this._getChildrenByTagName(p[0],"a","A"),n.length?(t=p.jqmData("icon"),p.buttonMarkup({wrapperEls:"div",shadow:false,corners:false,iconpos:"right",icon:n.length>1||t===false?false:t||"arrow-r",theme:r}),t!=false&&n.length==1&&p.addClass("ui-li-has-arrow"),n.first().removeClass("ui-link").addClass("ui-link-inherit"),n.length>1&&(l+=" ui-li-has-alt",n=n.last(),q=g||n.jqmData("theme")||
c.splitTheme,x=n.jqmData("icon"),n.appendTo(p).attr("title",n.getEncodedText()).addClass("ui-li-link-alt").empty().buttonMarkup({shadow:false,corners:false,theme:r,icon:false,iconpos:false}).find(".ui-btn-inner").append(a(k.createElement("span")).buttonMarkup({shadow:true,corners:true,theme:q,iconpos:"notext",icon:x||t||h||c.splitIcon})))):p.jqmData("role")==="list-divider"?(l+=" ui-li-divider ui-bar-"+d,p.attr("role","heading"),o&&(o=1)):l+=" ui-li-static ui-body-"+r;o&&l.indexOf("ui-li-divider")<
0&&(r=p.is(".ui-li-static:first")?p:p.find(".ui-link-inherit"),r.addClass("ui-li-jsnumbering").prepend("<span class='ui-li-dec'>"+o++ +". </span>"));m[l]||(m[l]=[]);m[l].push(p[0])}for(l in m)a(m[l]).addClass(l).children(".ui-btn-inner").addClass(l);f.find("h1, h2, h3, h4, h5, h6").addClass("ui-li-heading").end().find("p, dl").addClass("ui-li-desc").end().find(".ui-li-aside").each(function(){var b=a(this);b.prependTo(b.parent())}).end().find(".ui-li-count").each(function(){a(this).closest("li").addClass("ui-li-has-count")}).addClass("ui-btn-up-"+
(f.jqmData("counttheme")||this.options.countTheme)+" ui-btn-corner-all");this._addThumbClasses(j);this._addThumbClasses(f.find(".ui-link-inherit"));this._refreshCorners(b)},_idStringEscape:function(a){return a.replace(/[^a-zA-Z0-9]/g,"-")},_createSubPages:function(){var b=this.element,e=b.closest(".ui-page"),f=e.jqmData("url"),d=f||e[0][a.expando],g=b.attr("id"),h=this.options,j="data-"+a.mobile.ns,k=this,m=e.find(":jqmData(role='footer')").jqmData("id"),p;typeof c[d]==="undefined"&&(c[d]=-1);g=g||
++c[d];a(b.find("li>ul, li>ol").toArray().reverse()).each(function(c){var d=a(this),e=d.attr("id")||g+"-"+c,c=d.parent(),k=a(d.prevAll().toArray().reverse()),k=k.length?k:a("<span>"+a.trim(c.contents()[0].nodeValue)+"</span>"),o=k.first().getEncodedText(),e=(f||"")+"&"+a.mobile.subPageUrlKey+"="+e,x=d.jqmData("theme")||h.theme,u=d.jqmData("counttheme")||b.jqmData("counttheme")||h.countTheme;p=true;d.detach().wrap("<div "+j+"role='page' "+j+"url='"+e+"' "+j+"theme='"+x+"' "+j+"count-theme='"+u+"'><div "+
j+"role='content'></div></div>").parent().before("<div "+j+"role='header' "+j+"theme='"+h.headerTheme+"'><div class='ui-title'>"+o+"</div></div>").after(m?a("<div "+j+"role='footer' "+j+"id='"+m+"'>"):"").parent().appendTo(a.mobile.pageContainer).page();d=c.find("a:first");d.length||(d=a("<a/>").html(k||o).prependTo(c.empty()));d.attr("href","#"+e)}).listview();p&&e.is(":jqmData(external-page='true')")&&e.data("page").options.domCache===false&&e.unbind("pagehide.remove").bind("pagehide.remove",function(b,
c){var d=c.nextPage;c.nextPage&&(d=d.jqmData("url"),d.indexOf(f+"&"+a.mobile.subPageUrlKey)!==0&&(k.childPages().remove(),e.remove()))})},childPages:function(){var b=this.parentPage.jqmData("url");return a(":jqmData(url^='"+b+"&"+a.mobile.subPageUrlKey+"')")}});a(k).bind("pagecreate create",function(b){a.mobile.listview.prototype.enhanceWithin(b.target)})})(jQuery);(function(a,c){a.widget("mobile.checkboxradio",a.mobile.widget,{options:{theme:null,initSelector:"input[type='checkbox'],input[type='radio']"},
_create:function(){var b=this,e=this.element,f=a(e).closest("label"),d=f.length?f:a(e).closest("form,fieldset,:jqmData(role='page'),:jqmData(role='dialog')").find("label").filter("[for='"+e[0].id+"']"),g=e[0].type,f=e.jqmData("mini")||e.closest("form,fieldset").jqmData("mini"),h=g+"-on",j=g+"-off",o=e.parents(":jqmData(type='horizontal')").length?c:j,m=e.jqmData("iconpos")||e.closest("form,fieldset").jqmData("iconpos");if(!(g!=="checkbox"&&g!=="radio")){a.extend(this,{label:d,inputtype:g,checkedClass:"ui-"+
h+(o?"":" "+a.mobile.activeBtnClass),uncheckedClass:"ui-"+j,checkedicon:"ui-icon-"+h,uncheckedicon:"ui-icon-"+j});if(!this.options.theme)this.options.theme=a.mobile.getInheritedTheme(this.element,"c");d.buttonMarkup({theme:this.options.theme,icon:o,shadow:false,mini:f,iconpos:m});f=k.createElement("div");f.className="ui-"+g;e.add(d).wrapAll(f);d.bind({vmouseover:function(b){a(this).parent().is(".ui-disabled")&&b.stopPropagation()},vclick:function(a){if(e.is(":disabled"))a.preventDefault();else return b._cacheVals(),
e.prop("checked",g==="radio"&&true||!e.prop("checked")),e.triggerHandler("click"),b._getInputSet().not(e).prop("checked",false),b._updateAll(),false}});e.bind({vmousedown:function(){b._cacheVals()},vclick:function(){var c=a(this);c.is(":checked")?(c.prop("checked",true),b._getInputSet().not(c).prop("checked",false)):c.prop("checked",false);b._updateAll()},focus:function(){d.addClass(a.mobile.focusClass)},blur:function(){d.removeClass(a.mobile.focusClass)}});this.refresh()}},_cacheVals:function(){this._getInputSet().each(function(){a(this).jqmData("cacheVal",
this.checked)})},_getInputSet:function(){return this.inputtype==="checkbox"?this.element:this.element.closest("form,fieldset,:jqmData(role='page')").find("input[name='"+this.element[0].name+"'][type='"+this.inputtype+"']")},_updateAll:function(){var b=this;this._getInputSet().each(function(){var c=a(this);(this.checked||b.inputtype==="checkbox")&&c.trigger("change")}).checkboxradio("refresh")},refresh:function(){var a=this.element[0],c=this.label,f=c.find(".ui-icon");a.checked?(c.addClass(this.checkedClass).removeClass(this.uncheckedClass),
f.addClass(this.checkedicon).removeClass(this.uncheckedicon)):(c.removeClass(this.checkedClass).addClass(this.uncheckedClass),f.removeClass(this.checkedicon).addClass(this.uncheckedicon));a.disabled?this.disable():this.enable()},disable:function(){this.element.prop("disabled",true).parent().addClass("ui-disabled")},enable:function(){this.element.prop("disabled",false).parent().removeClass("ui-disabled")}});a(k).bind("pagecreate create",function(b){a.mobile.checkboxradio.prototype.enhanceWithin(b.target,
true)})})(jQuery);(function(a,c){a.widget("mobile.button",a.mobile.widget,{options:{theme:null,icon:null,iconpos:null,inline:false,corners:true,shadow:true,iconshadow:true,initSelector:"button, [type='button'], [type='submit'], [type='reset'], [type='image']",mini:false},_create:function(){var b=this.element,e,f=this.options,d;d="";var g;if(b[0].tagName==="A")!b.hasClass("ui-btn")&&b.buttonMarkup();else{if(!this.options.theme)this.options.theme=a.mobile.getInheritedTheme(this.element,"c");~b[0].className.indexOf("ui-btn-left")&&
(d="ui-btn-left");~b[0].className.indexOf("ui-btn-right")&&(d="ui-btn-right");e=this.button=a("<div></div>").text(b.text()||b.val()).insertBefore(b).buttonMarkup({theme:f.theme,icon:f.icon,iconpos:f.iconpos,inline:f.inline,corners:f.corners,shadow:f.shadow,iconshadow:f.iconshadow,mini:f.mini}).addClass(d).append(b.addClass("ui-btn-hidden"));f=b.attr("type");d=b.attr("name");f!=="button"&&f!=="reset"&&d&&b.bind("vclick",function(){g===c&&(g=a("<input>",{type:"hidden",name:b.attr("name"),value:b.attr("value")}).insertBefore(b),
a(k).one("submit",function(){g.remove();g=c}))});b.bind({focus:function(){e.addClass(a.mobile.focusClass)},blur:function(){e.removeClass(a.mobile.focusClass)}});this.refresh()}},enable:function(){this.element.attr("disabled",false);this.button.removeClass("ui-disabled").attr("aria-disabled",false);return this._setOption("disabled",false)},disable:function(){this.element.attr("disabled",true);this.button.addClass("ui-disabled").attr("aria-disabled",true);return this._setOption("disabled",true)},refresh:function(){var b=
this.element;b.prop("disabled")?this.disable():this.enable();a(this.button.data("buttonElements").text).text(b.text()||b.val())}});a(k).bind("pagecreate create",function(b){a.mobile.button.prototype.enhanceWithin(b.target,true)})})(jQuery);(function(a){a.fn.controlgroup=function(c){function b(a,b){a.removeClass("ui-btn-corner-all ui-shadow").eq(0).addClass(b[0]).end().last().addClass(b[1]).addClass("ui-controlgroup-last")}return this.each(function(){var e=a(this),f=a.extend({direction:e.jqmData("type")||
"vertical",shadow:false,excludeInvisible:true,mini:e.jqmData("mini")},c),d=e.children("legend"),g=f.direction=="horizontal"?["ui-corner-left","ui-corner-right"]:["ui-corner-top","ui-corner-bottom"];e.find("input").first().attr("type");d.length&&(e.wrapInner("<div class='ui-controlgroup-controls'></div>"),a("<div role='heading' class='ui-controlgroup-label'>"+d.html()+"</div>").insertBefore(e.children(0)),d.remove());e.addClass("ui-corner-all ui-controlgroup ui-controlgroup-"+f.direction);b(e.find(".ui-btn"+
(f.excludeInvisible?":visible":"")).not(".ui-slider-handle"),g);b(e.find(".ui-btn-inner"),g);f.shadow&&e.addClass("ui-shadow");f.mini&&e.addClass("ui-mini")})}})(jQuery);(function(a){a(k).bind("pagecreate create",function(c){a(c.target).find("a").jqmEnhanceable().not(".ui-btn, .ui-link-inherit, :jqmData(role='none'), :jqmData(role='nojs')").addClass("ui-link")})})(jQuery);(function(a){var c=a("meta[name=viewport]"),b=c.attr("content"),e=b+",maximum-scale=1, user-scalable=no",f=b+",maximum-scale=10, user-scalable=yes",
d=/(user-scalable[\s]*=[\s]*no)|(maximum-scale[\s]*=[\s]*1)[$,\s]/.test(b);a.mobile.zoom=a.extend({},{enabled:!d,locked:false,disable:function(b){if(!d&&!a.mobile.zoom.locked)c.attr("content",e),a.mobile.zoom.enabled=false,a.mobile.zoom.locked=b||false},enable:function(b){if(!d&&(!a.mobile.zoom.locked||b===true))c.attr("content",f),a.mobile.zoom.enabled=true,a.mobile.zoom.locked=false},restore:function(){if(!d)c.attr("content",b),a.mobile.zoom.enabled=true}})})(jQuery);(function(a){a.widget("mobile.textinput",
a.mobile.widget,{options:{theme:null,preventFocusZoom:/iPhone|iPad|iPod/.test(navigator.platform)&&navigator.userAgent.indexOf("AppleWebKit")>-1,initSelector:"input[type='text'], input[type='search'], :jqmData(type='search'), input[type='number'], :jqmData(type='number'), input[type='password'], input[type='email'], input[type='url'], input[type='tel'], textarea, input[type='time'], input[type='date'], input[type='month'], input[type='week'], input[type='datetime'], input[type='datetime-local'], input[type='color'], input:not([type])",
clearSearchButtonText:"clear text"},_create:function(){var c=this.element,b=this.options,e=b.theme||a.mobile.getInheritedTheme(this.element,"c"),f=" ui-body-"+e,d=c.jqmData("mini")==true,g=d?" ui-mini":"",h,j;a("label[for='"+c.attr("id")+"']").addClass("ui-input-text");h=c.addClass("ui-input-text ui-body-"+e);typeof c[0].autocorrect!=="undefined"&&!a.support.touchOverflow&&(c[0].setAttribute("autocorrect","off"),c[0].setAttribute("autocomplete","off"));c.is("[type='search'],:jqmData(type='search')")?
(h=c.wrap("<div class='ui-input-search ui-shadow-inset ui-btn-corner-all ui-btn-shadow ui-icon-searchfield"+f+g+"'></div>").parent(),j=a("<a href='#' class='ui-input-clear' title='"+b.clearSearchButtonText+"'>"+b.clearSearchButtonText+"</a>").bind("click",function(a){c.val("").focus().trigger("change");j.addClass("ui-input-clear-hidden");a.preventDefault()}).appendTo(h).buttonMarkup({icon:"delete",iconpos:"notext",corners:true,shadow:true,mini:d}),e=function(){setTimeout(function(){j.toggleClass("ui-input-clear-hidden",
!c.val())},0)},e(),c.bind("paste cut keyup focus change blur",e)):c.addClass("ui-corner-all ui-shadow-inset"+f+g);c.focus(function(){h.addClass(a.mobile.focusClass)}).blur(function(){h.removeClass(a.mobile.focusClass)}).bind("focus",function(){b.preventFocusZoom&&a.mobile.zoom.disable(true)}).bind("blur",function(){b.preventFocusZoom&&a.mobile.zoom.enable(true)});if(c.is("textarea")){var o=function(){var a=c[0].scrollHeight;c[0].clientHeight<a&&c.height(a+15)},m;c.keyup(function(){clearTimeout(m);
m=setTimeout(o,100)});a(k).one("pagechange",o);a.trim(c.val())&&a(s).load(o)}},disable:function(){(this.element.attr("disabled",true).is("[type='search'],:jqmData(type='search')")?this.element.parent():this.element).addClass("ui-disabled")},enable:function(){(this.element.attr("disabled",false).is("[type='search'],:jqmData(type='search')")?this.element.parent():this.element).removeClass("ui-disabled")}});a(k).bind("pagecreate create",function(c){a.mobile.textinput.prototype.enhanceWithin(c.target,
true)})})(jQuery);(function(a){a.mobile.listview.prototype.options.filter=false;a.mobile.listview.prototype.options.filterPlaceholder="Filter items...";a.mobile.listview.prototype.options.filterTheme="c";a.mobile.listview.prototype.options.filterCallback=function(a,b){return a.toLowerCase().indexOf(b)===-1};a(k).delegate(":jqmData(role='listview')","listviewcreate",function(){var c=a(this),b=c.data("listview");if(b.options.filter){var e=a("<form>",{"class":"ui-listview-filter ui-bar-"+b.options.filterTheme,
role:"search"});a("<input>",{placeholder:b.options.filterPlaceholder}).attr("data-"+a.mobile.ns+"type","search").jqmData("lastval","").bind("keyup change",function(){var e=a(this),d=this.value.toLowerCase(),g=null,g=e.jqmData("lastval")+"",h=false,j="";e.jqmData("lastval",d);g=d.length<g.length||d.indexOf(g)!==0?c.children():c.children(":not(.ui-screen-hidden)");if(d){for(var k=g.length-1;k>=0;k--)e=a(g[k]),j=e.jqmData("filtertext")||e.text(),e.is("li:jqmData(role=list-divider)")?(e.toggleClass("ui-filter-hidequeue",
!h),h=false):b.options.filterCallback(j,d)?e.toggleClass("ui-filter-hidequeue",true):h=true;g.filter(":not(.ui-filter-hidequeue)").toggleClass("ui-screen-hidden",false);g.filter(".ui-filter-hidequeue").toggleClass("ui-screen-hidden",true).toggleClass("ui-filter-hidequeue",false)}else g.toggleClass("ui-screen-hidden",false);b._refreshCorners()}).appendTo(e).textinput();b.options.inset&&e.addClass("ui-listview-filter-inset");e.bind("submit",function(){return false}).insertBefore(c)}})})(jQuery);(function(a,
c){a.widget("mobile.slider",a.mobile.widget,{options:{theme:null,trackTheme:null,disabled:false,initSelector:"input[type='range'], :jqmData(type='range'), :jqmData(role='slider')",mini:false},_create:function(){var b=this,e=this.element,f=a.mobile.getInheritedTheme(e,"c"),d=this.options.theme||f,f=this.options.trackTheme||f,g=e[0].nodeName.toLowerCase(),h=g=="select"?"ui-slider-switch":"",j=e.attr("id"),o=j+"-label",j=a("[for='"+j+"']").attr("id",o),m=function(){return g=="input"?parseFloat(e.val()):
e[0].selectedIndex},p=g=="input"?parseFloat(e.attr("min")):0,l=g=="input"?parseFloat(e.attr("max")):e.find("option").length-1,r=s.parseFloat(e.attr("step")||1),n=this.options.inline||e.jqmData("inline")==true?" ui-slider-inline":"",q=this.options.mini||e.jqmData("mini")?" ui-slider-mini":"",t=k.createElement("a"),x=a(t),u=k.createElement("div"),w=a(u),v=e.jqmData("highlight")&&g!="select"?function(){var b=k.createElement("div");b.className="ui-slider-bg ui-btn-active ui-btn-corner-all";return a(b).prependTo(w)}():
false;t.setAttribute("href","#");u.setAttribute("role","application");u.className=["ui-slider ",h," ui-btn-down-",f," ui-btn-corner-all",n,q].join("");t.className="ui-slider-handle";u.appendChild(t);x.buttonMarkup({corners:true,theme:d,shadow:true}).attr({role:"slider","aria-valuemin":p,"aria-valuemax":l,"aria-valuenow":m(),"aria-valuetext":m(),title:m(),"aria-labelledby":o});a.extend(this,{slider:w,handle:x,valuebg:v,dragging:false,beforeStart:null,userModified:false,mouseMoved:false});if(g=="select"){d=
k.createElement("div");d.className="ui-slider-inneroffset";h=0;for(o=u.childNodes.length;h<o;h++)d.appendChild(u.childNodes[h]);u.appendChild(d);x.addClass("ui-slider-handle-snapping");u=e.find("option");d=0;for(h=u.length;d<h;d++)o=!d?"b":"a",n=!d?" ui-btn-down-"+f:" "+a.mobile.activeBtnClass,k.createElement("div"),q=k.createElement("span"),q.className=["ui-slider-label ui-slider-label-",o,n," ui-btn-corner-all"].join(""),q.setAttribute("role","img"),q.appendChild(k.createTextNode(u[d].innerHTML)),
a(q).prependTo(w);b._labels=a(".ui-slider-label",w)}j.addClass("ui-slider");e.addClass(g==="input"?"ui-slider-input":"ui-slider-switch").change(function(){b.mouseMoved||b.refresh(m(),true)}).keyup(function(){b.refresh(m(),true,true)}).blur(function(){b.refresh(m(),true)});a(k).bind("vmousemove",function(a){if(b.dragging)return b.mouseMoved=true,g==="select"&&x.removeClass("ui-slider-handle-snapping"),b.refresh(a),b.userModified=b.beforeStart!==e[0].selectedIndex,false});w.bind("vmousedown",function(a){b.dragging=
true;b.userModified=false;b.mouseMoved=false;if(g==="select")b.beforeStart=e[0].selectedIndex;b.refresh(a);return false}).bind("vclick",false);w.add(k).bind("vmouseup",function(){if(b.dragging)return b.dragging=false,g==="select"&&(x.addClass("ui-slider-handle-snapping"),b.mouseMoved?b.userModified?b.refresh(b.beforeStart==0?1:0):b.refresh(b.beforeStart):b.refresh(b.beforeStart==0?1:0)),b.mouseMoved=false});w.insertAfter(e);g=="select"&&this.handle.bind({focus:function(){w.addClass(a.mobile.focusClass)},
blur:function(){w.removeClass(a.mobile.focusClass)}});this.handle.bind({vmousedown:function(){a(this).focus()},vclick:false,keydown:function(c){var d=m();if(!b.options.disabled){switch(c.keyCode){case a.mobile.keyCode.HOME:case a.mobile.keyCode.END:case a.mobile.keyCode.PAGE_UP:case a.mobile.keyCode.PAGE_DOWN:case a.mobile.keyCode.UP:case a.mobile.keyCode.RIGHT:case a.mobile.keyCode.DOWN:case a.mobile.keyCode.LEFT:if(c.preventDefault(),!b._keySliding)b._keySliding=true,a(this).addClass("ui-state-active")}switch(c.keyCode){case a.mobile.keyCode.HOME:b.refresh(p);
break;case a.mobile.keyCode.END:b.refresh(l);break;case a.mobile.keyCode.PAGE_UP:case a.mobile.keyCode.UP:case a.mobile.keyCode.RIGHT:b.refresh(d+r);break;case a.mobile.keyCode.PAGE_DOWN:case a.mobile.keyCode.DOWN:case a.mobile.keyCode.LEFT:b.refresh(d-r)}}},keyup:function(){if(b._keySliding)b._keySliding=false,a(this).removeClass("ui-state-active")}});this.refresh(c,c,true)},refresh:function(b,c,f){(this.options.disabled||this.element.attr("disabled"))&&this.disable();var d=this.element,g=d[0].nodeName.toLowerCase(),
h=g==="input"?parseFloat(d.attr("min")):0,j=g==="input"?parseFloat(d.attr("max")):d.find("option").length-1,k=g==="input"&&parseFloat(d.attr("step"))>0?parseFloat(d.attr("step")):1;if(typeof b==="object"){if(!this.dragging||b.pageX<this.slider.offset().left-8||b.pageX>this.slider.offset().left+this.slider.width()+8)return;b=Math.round((b.pageX-this.slider.offset().left)/this.slider.width()*100)}else b==null&&(b=g==="input"?parseFloat(d.val()||0):d[0].selectedIndex),b=(parseFloat(b)-h)/(j-h)*100;if(!isNaN(b)){b<
0&&(b=0);b>100&&(b=100);var m=b/100*(j-h)+h,p=(m-h)%k;m-=p;Math.abs(p)*2>=k&&(m+=p>0?k:-k);m=parseFloat(m.toFixed(5));m<h&&(m=h);m>j&&(m=j);this.handle.css("left",b+"%");this.handle.attr({"aria-valuenow":g==="input"?m:d.find("option").eq(m).attr("value"),"aria-valuetext":g==="input"?m:d.find("option").eq(m).getEncodedText(),title:g==="input"?m:d.find("option").eq(m).getEncodedText()});this.valuebg&&this.valuebg.css("width",b+"%");if(this._labels){var h=this.handle.width()/this.slider.width()*100,
l=b&&h+(100-h)*b/100,r=b===100?0:Math.min(h+100-l,100);this._labels.each(function(){var b=a(this).is(".ui-slider-label-a");a(this).width((b?l:r)+"%")})}if(!f)f=false,g==="input"?(f=d.val()!==m,d.val(m)):(f=d[0].selectedIndex!==m,d[0].selectedIndex=m),!c&&f&&d.trigger("change")}},enable:function(){this.element.attr("disabled",false);this.slider.removeClass("ui-disabled").attr("aria-disabled",false);return this._setOption("disabled",false)},disable:function(){this.element.attr("disabled",true);this.slider.addClass("ui-disabled").attr("aria-disabled",
true);return this._setOption("disabled",true)}});a(k).bind("pagecreate create",function(b){a.mobile.slider.prototype.enhanceWithin(b.target,true)})})(jQuery);(function(a){a.widget("mobile.selectmenu",a.mobile.widget,{options:{theme:null,disabled:false,icon:"arrow-d",iconpos:"right",inline:false,corners:true,shadow:true,iconshadow:true,overlayTheme:"a",hidePlaceholderMenuItems:true,closeText:"Close",nativeMenu:true,preventFocusZoom:/iPhone|iPad|iPod/.test(navigator.platform)&&navigator.userAgent.indexOf("AppleWebKit")>
-1,initSelector:"select:not(:jqmData(role='slider'))",mini:false},_button:function(){return a("<div/>")},_setDisabled:function(a){this.element.attr("disabled",a);this.button.attr("aria-disabled",a);return this._setOption("disabled",a)},_focusButton:function(){var a=this;setTimeout(function(){a.button.focus()},40)},_selectOptions:function(){return this.select.find("option")},_preExtension:function(){var c="";~this.element[0].className.indexOf("ui-btn-left")&&(c=" ui-btn-left");~this.element[0].className.indexOf("ui-btn-right")&&
(c=" ui-btn-right");this.select=this.element.wrap("<div class='ui-select"+c+"'>");this.selectID=this.select.attr("id");this.label=a("label[for='"+this.selectID+"']").addClass("ui-select");this.isMultiple=this.select[0].multiple;if(!this.options.theme)this.options.theme=a.mobile.getInheritedTheme(this.select,"c")},_create:function(){this._preExtension();this._trigger("beforeCreate");this.button=this._button();var c=this,b=this.options,e=this.button.text(a(this.select[0].options.item(this.select[0].selectedIndex==
-1?0:this.select[0].selectedIndex)).text()).insertBefore(this.select).buttonMarkup({theme:b.theme,icon:b.icon,iconpos:b.iconpos,inline:b.inline,corners:b.corners,shadow:b.shadow,iconshadow:b.iconshadow,mini:b.mini});b.nativeMenu&&s.opera&&s.opera.version&&this.select.addClass("ui-select-nativeonly");if(this.isMultiple)this.buttonCount=a("<span>").addClass("ui-li-count ui-btn-up-c ui-btn-corner-all").hide().appendTo(e.addClass("ui-li-has-count"));(b.disabled||this.element.attr("disabled"))&&this.disable();
this.select.change(function(){c.refresh()});this.build()},build:function(){var c=this;this.select.appendTo(c.button).bind("vmousedown",function(){c.button.addClass(a.mobile.activeBtnClass)}).bind("focus",function(){c.button.addClass(a.mobile.focusClass)}).bind("blur",function(){c.button.removeClass(a.mobile.focusClass)}).bind("focus vmouseover",function(){c.button.trigger("vmouseover")}).bind("vmousemove",function(){c.button.removeClass(a.mobile.activeBtnClass)}).bind("change blur vmouseout",function(){c.button.trigger("vmouseout").removeClass(a.mobile.activeBtnClass)}).bind("change blur",
function(){c.button.removeClass("ui-btn-down-"+c.options.theme)});c.button.bind("vmousedown",function(){c.options.preventFocusZoom&&a.mobile.zoom.disable(true)}).bind("mouseup",function(){c.options.preventFocusZoom&&a.mobile.zoom.enable(true)})},selected:function(){return this._selectOptions().filter(":selected")},selectedIndices:function(){var a=this;return this.selected().map(function(){return a._selectOptions().index(this)}).get()},setButtonText:function(){var c=this,b=this.selected();this.button.find(".ui-btn-text").text(function(){return!c.isMultiple?
b.text():b.length?b.map(function(){return a(this).text()}).get().join(", "):c.placeholder})},setButtonCount:function(){var a=this.selected();this.isMultiple&&this.buttonCount[a.length>1?"show":"hide"]().text(a.length)},refresh:function(){this.setButtonText();this.setButtonCount()},open:a.noop,close:a.noop,disable:function(){this._setDisabled(true);this.button.addClass("ui-disabled")},enable:function(){this._setDisabled(false);this.button.removeClass("ui-disabled")}});a(k).bind("pagecreate create",
function(c){a.mobile.selectmenu.prototype.enhanceWithin(c.target,true)})})(jQuery);(function(a){var c=function(b){var c=b.selectID,f=b.label,d=b.select.closest(".ui-page"),g=a("<div>",{"class":"ui-selectmenu-screen ui-screen-hidden"}).appendTo(d),h=b._selectOptions(),j=b.isMultiple=b.select[0].multiple,o=c+"-button",m=c+"-menu",p=a("<div data-"+a.mobile.ns+"role='dialog' data-"+a.mobile.ns+"theme='"+b.options.theme+"' data-"+a.mobile.ns+"overlay-theme='"+b.options.overlayTheme+"'><div data-"+a.mobile.ns+
"role='header'><div class='ui-title'>"+f.getEncodedText()+"</div></div><div data-"+a.mobile.ns+"role='content'></div></div>"),l=a("<div>",{"class":"ui-selectmenu ui-selectmenu-hidden ui-overlay-shadow ui-corner-all ui-body-"+b.options.overlayTheme+" "+a.mobile.defaultDialogTransition}).insertAfter(g),r=a("<ul>",{"class":"ui-selectmenu-list",id:m,role:"listbox","aria-labelledby":o}).attr("data-"+a.mobile.ns+"theme",b.options.theme).appendTo(l),n=a("<div>",{"class":"ui-header ui-bar-"+b.options.theme}).prependTo(l),
q=a("<h1>",{"class":"ui-title"}).appendTo(n),t;b.isMultiple&&(t=a("<a>",{text:b.options.closeText,href:"#","class":"ui-btn-left"}).attr("data-"+a.mobile.ns+"iconpos","notext").attr("data-"+a.mobile.ns+"icon","delete").appendTo(n).buttonMarkup());a.extend(b,{select:b.select,selectID:c,buttonId:o,menuId:m,thisPage:d,menuPage:p,label:f,screen:g,selectOptions:h,isMultiple:j,theme:b.options.theme,listbox:l,list:r,header:n,headerTitle:q,headerClose:t,menuPageContent:void 0,menuPageClose:void 0,placeholder:"",
build:function(){var c=this;c.refresh();c.select.attr("tabindex","-1").focus(function(){a(this).blur();c.button.focus()});c.button.bind("vclick keydown",function(b){if(b.type=="vclick"||b.keyCode&&(b.keyCode===a.mobile.keyCode.ENTER||b.keyCode===a.mobile.keyCode.SPACE))c.open(),b.preventDefault()});c.list.attr("role","listbox").bind("focusin",function(b){a(b.target).attr("tabindex","0").trigger("vmouseover")}).bind("focusout",function(b){a(b.target).attr("tabindex","-1").trigger("vmouseout")}).delegate("li:not(.ui-disabled, .ui-li-divider)",
"click",function(b){var d=c.select[0].selectedIndex,e=c.list.find("li:not(.ui-li-divider)").index(this),f=c._selectOptions().eq(e)[0];f.selected=c.isMultiple?!f.selected:true;c.isMultiple&&a(this).find(".ui-icon").toggleClass("ui-icon-checkbox-on",f.selected).toggleClass("ui-icon-checkbox-off",!f.selected);(c.isMultiple||d!==e)&&c.select.trigger("change");c.isMultiple||c.close();b.preventDefault()}).keydown(function(c){var d=a(c.target),e=d.closest("li");switch(c.keyCode){case 38:return c=e.prev().not(".ui-selectmenu-placeholder"),
c.is(".ui-li-divider")&&(c=c.prev()),c.length&&(d.blur().attr("tabindex","-1"),c.addClass("ui-btn-down-"+b.options.theme).find("a").first().focus()),false;case 40:return c=e.next(),c.is(".ui-li-divider")&&(c=c.next()),c.length&&(d.blur().attr("tabindex","-1"),c.addClass("ui-btn-down-"+b.options.theme).find("a").first().focus()),false;case 13:case 32:return d.trigger("click"),false}});c.menuPage.bind("pagehide",function(){c.list.appendTo(c.listbox);c._focusButton();a.mobile._bindPageRemove.call(c.thisPage)});
c.screen.bind("vclick",function(){c.close()});c.isMultiple&&c.headerClose.click(function(){if(c.menuType=="overlay")return c.close(),false});c.thisPage.addDependents(this.menuPage)},_isRebuildRequired:function(){var a=this.list.find("li");return this._selectOptions().text()!==a.text()},refresh:function(b){var c=this;this._selectOptions();this.selected();var d=this.selectedIndices();(b||this._isRebuildRequired())&&c._buildList();c.setButtonText();c.setButtonCount();c.list.find("li:not(.ui-li-divider)").removeClass(a.mobile.activeBtnClass).attr("aria-selected",
false).each(function(b){a.inArray(b,d)>-1&&(b=a(this),b.attr("aria-selected",true),c.isMultiple?b.find(".ui-icon").removeClass("ui-icon-checkbox-off").addClass("ui-icon-checkbox-on"):b.is(".ui-selectmenu-placeholder")?b.next().addClass(a.mobile.activeBtnClass):b.addClass(a.mobile.activeBtnClass))})},close:function(){if(!this.options.disabled&&this.isOpen)this.menuType=="page"?s.history.back():(this.screen.addClass("ui-screen-hidden"),this.listbox.addClass("ui-selectmenu-hidden").removeAttr("style").removeClass("in"),
this.list.appendTo(this.listbox),this._focusButton()),this.isOpen=false},open:function(){function b(){c.list.find("."+a.mobile.activeBtnClass+" a").focus()}if(!this.options.disabled){var c=this,d=a(s),e=c.list.parent(),f=e.outerHeight(),e=e.outerWidth();a(".ui-page-active");var g=d.scrollTop(),j=c.button.offset().top,h=d.height(),d=d.width();c.button.addClass(a.mobile.activeBtnClass);setTimeout(function(){c.button.removeClass(a.mobile.activeBtnClass)},300);if(f>h-80||!a.support.scrollTop){c.menuPage.appendTo(a.mobile.pageContainer).page();
c.menuPageContent=p.find(".ui-content");c.menuPageClose=p.find(".ui-header a");c.thisPage.unbind("pagehide.remove");if(g==0&&j>h)c.thisPage.one("pagehide",function(){a(this).jqmData("lastScroll",j)});c.menuPage.one("pageshow",function(){b();c.isOpen=true});c.menuType="page";c.menuPageContent.append(c.list);c.menuPage.find("div .ui-title").text(c.label.text());a.mobile.changePage(c.menuPage,{transition:a.mobile.defaultDialogTransition})}else{c.menuType="overlay";c.screen.height(a(k).height()).removeClass("ui-screen-hidden");
var l=j-g,m=g+h-j,n=f/2,o=parseFloat(c.list.parent().css("max-width")),f=l>f/2&&m>f/2?j+c.button.outerHeight()/2-n:l>m?g+h-f-30:g+30;e<o?g=(d-e)/2:(g=c.button.offset().left+c.button.outerWidth()/2-e/2,g<30?g=30:g+e>d&&(g=d-e-30));c.listbox.append(c.list).removeClass("ui-selectmenu-hidden").css({top:f,left:g}).addClass("in");b();c.isOpen=true}}},_buildList:function(){var b=this.options,c=this.placeholder,d=true,e=this.isMultiple?"checkbox-off":"false";this.list.empty().filter(".ui-listview").listview("destroy");
var f=this.select.find("option"),g=f.length,j=this.select[0],h="data-"+a.mobile.ns,l=h+"option-index",m=h+"icon";h+="role";for(var n=k.createDocumentFragment(),o,p=0;p<g;p++){var r=f[p],q=a(r),s=r.parentNode,t=q.text(),D=k.createElement("a"),J=[];D.setAttribute("href","#");D.appendChild(k.createTextNode(t));s!==j&&s.nodeName.toLowerCase()==="optgroup"&&(s=s.getAttribute("label"),s!=o&&(o=k.createElement("li"),o.setAttribute(h,"list-divider"),o.setAttribute("role","option"),o.setAttribute("tabindex",
"-1"),o.appendChild(k.createTextNode(s)),n.appendChild(o),o=s));if(d&&(!r.getAttribute("value")||t.length==0||q.jqmData("placeholder")))if(d=false,b.hidePlaceholderMenuItems&&J.push("ui-selectmenu-placeholder"),!c)c=this.placeholder=t;q=k.createElement("li");r.disabled&&(J.push("ui-disabled"),q.setAttribute("aria-disabled",true));q.setAttribute(l,p);q.setAttribute(m,e);q.className=J.join(" ");q.setAttribute("role","option");D.setAttribute("tabindex","-1");q.appendChild(D);n.appendChild(q)}this.list[0].appendChild(n);
!this.isMultiple&&!c.length?this.header.hide():this.headerTitle.text(this.placeholder);this.list.listview()},_button:function(){return a("<a>",{href:"#",role:"button",id:this.buttonId,"aria-haspopup":"true","aria-owns":this.menuId})}})};a(k).bind("selectmenubeforecreate",function(b){b=a(b.target).data("selectmenu");b.options.nativeMenu||c(b)})})(jQuery);(function(a){a.widget("mobile.fixedtoolbar",a.mobile.widget,{options:{visibleOnPageShow:true,disablePageZoom:true,transition:"slide",fullscreen:false,
tapToggle:true,tapToggleBlacklist:"a, input, select, textarea, .ui-header-fixed, .ui-footer-fixed",hideDuringFocus:"input, textarea, select",updatePagePadding:true,trackPersistentToolbars:true,supportBlacklist:function(){var a=s,b=navigator.userAgent,e=navigator.platform,f=b.match(/AppleWebKit\/([0-9]+)/),f=!!f&&f[1],d=b.match(/Fennec\/([0-9]+)/),d=!!d&&d[1],g=b.match(/Opera Mobi\/([0-9]+)/),h=!!g&&g[1];return(e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1||e.indexOf("iPod")>-1)&&f&&f<534||a.operamini&&
{}.toString.call(a.operamini)==="[object OperaMini]"||g&&h<7458||b.indexOf("Android")>-1&&f&&f<533||d&&d<6||"palmGetResource"in s&&f&&f<534||b.indexOf("MeeGo")>-1&&b.indexOf("NokiaBrowser/8.5.0")>-1?true:false},initSelector:":jqmData(position='fixed')"},_create:function(){var a=this.options,b=this.element,e=b.is(":jqmData(role='header')")?"header":"footer",f=b.closest(".ui-page");a.supportBlacklist()?this.destroy():(b.addClass("ui-"+e+"-fixed"),a.fullscreen?(b.addClass("ui-"+e+"-fullscreen"),f.addClass("ui-page-"+
e+"-fullscreen")):f.addClass("ui-page-"+e+"-fixed"),this._addTransitionClass(),this._bindPageEvents(),this._bindToggleHandlers())},_addTransitionClass:function(){var a=this.options.transition;a&&a!=="none"&&(a==="slide"&&(a=this.element.is(".ui-header")?"slidedown":"slideup"),this.element.addClass(a))},_bindPageEvents:function(){var c=this,b=c.options;c.element.closest(".ui-page").bind("pagebeforeshow",function(){b.disablePageZoom&&a.mobile.zoom.disable(true);b.visibleOnPageShow||c.hide(true)}).bind("webkitAnimationStart animationstart updatelayout",
function(){b.updatePagePadding&&c.updatePagePadding()}).bind("pageshow",function(){c.updatePagePadding();b.updatePagePadding&&a(s).bind("throttledresize."+c.widgetName,function(){c.updatePagePadding()})}).bind("pagebeforehide",function(e,f){b.disablePageZoom&&a.mobile.zoom.enable(true);b.updatePagePadding&&a(s).unbind("throttledresize."+c.widgetName);if(b.trackPersistentToolbars){var d=a(".ui-footer-fixed:jqmData(id)",this),g=a(".ui-header-fixed:jqmData(id)",this),h=d.length&&f.nextPage&&a(".ui-footer-fixed:jqmData(id='"+
d.jqmData("id")+"')",f.nextPage),j=g.length&&f.nextPage&&a(".ui-header-fixed:jqmData(id='"+g.jqmData("id")+"')",f.nextPage),h=h||a();if(h.length||j.length)h.add(j).appendTo(a.mobile.pageContainer),f.nextPage.one("pageshow",function(){h.add(j).appendTo(this)})}})},_visible:true,updatePagePadding:function(){var a=this.element,b=a.is(".ui-header");this.options.fullscreen||a.closest(".ui-page").css("padding-"+(b?"top":"bottom"),a.outerHeight())},_useTransition:function(c){var b=this.element,e=a(s).scrollTop(),
f=b.height(),d=b.closest(".ui-page").height(),g=a.mobile.getScreenHeight(),b=b.is(":jqmData(role='header')")?"header":"footer";return!c&&(this.options.transition&&this.options.transition!=="none"&&(b==="header"&&!this.options.fullscreen&&e>f||b==="footer"&&!this.options.fullscreen&&e+g<d-f)||this.options.fullscreen)},show:function(a){var b=this.element;this._useTransition(a)?b.removeClass("out ui-fixed-hidden").addClass("in"):b.removeClass("ui-fixed-hidden");this._visible=true},hide:function(a){var b=
this.element,e="out"+(this.options.transition==="slide"?" reverse":"");this._useTransition(a)?b.addClass(e).removeClass("in").animationComplete(function(){b.addClass("ui-fixed-hidden").removeClass(e)}):b.addClass("ui-fixed-hidden").removeClass(e);this._visible=false},toggle:function(){this[this._visible?"hide":"show"]()},_bindToggleHandlers:function(){var c=this,b=c.options;c.element.closest(".ui-page").bind("vclick",function(e){b.tapToggle&&!a(e.target).closest(b.tapToggleBlacklist).length&&c.toggle()}).bind("focusin focusout",
function(e){if(screen.width<500&&a(e.target).is(b.hideDuringFocus)&&!a(e.target).closest(".ui-header-fixed, .ui-footer-fixed").length)c[e.type==="focusin"&&c._visible?"hide":"show"]()})},destroy:function(){this.element.removeClass("ui-header-fixed ui-footer-fixed ui-header-fullscreen ui-footer-fullscreen in out fade slidedown slideup ui-fixed-hidden");this.element.closest(".ui-page").removeClass("ui-page-header-fixed ui-page-footer-fixed ui-page-header-fullscreen ui-page-footer-fullscreen")}});a(k).bind("pagecreate create",
function(c){a(c.target).jqmData("fullscreen")&&a(a.mobile.fixedtoolbar.prototype.options.initSelector,c.target).not(":jqmData(fullscreen)").jqmData("fullscreen",true);a.mobile.fixedtoolbar.prototype.enhanceWithin(c.target)})})(jQuery);(function(a,c){if(/iPhone|iPad|iPod/.test(navigator.platform)&&navigator.userAgent.indexOf("AppleWebKit")>-1){var b=a.mobile.zoom,e,f,d,g,h;a(c).bind("orientationchange.iosorientationfix",b.enable).bind("devicemotion.iosorientationfix",function(a){e=a.originalEvent;
h=e.accelerationIncludingGravity;f=Math.abs(h.x);d=Math.abs(h.y);g=Math.abs(h.z);!c.orientation&&(f>7||(g>6&&d<8||g<8&&d>6)&&f>5)?b.enabled&&b.disable():b.enabled||b.enable()})}})(jQuery,this);(function(a,c){function b(){var b=a("."+a.mobile.activeBtnClass).first();h.css({top:a.support.scrollTop&&g.scrollTop()+g.height()/2||b.length&&b.offset().top||100})}function e(){var c=h.offset(),d=g.scrollTop(),f=a.mobile.getScreenHeight();if(c.top<d||c.top-d>f)h.addClass("ui-loader-fakefix"),b(),g.unbind("scroll",
e).bind("scroll",b)}function f(){d.removeClass("ui-mobile-rendering")}var d=a("html");a("head");var g=a(c);a(c.document).trigger("mobileinit");if(a.mobile.gradeA()){if(a.mobile.ajaxBlacklist)a.mobile.ajaxEnabled=false;d.addClass("ui-mobile ui-mobile-rendering");setTimeout(f,5E3);var h=a("<div class='ui-loader'><span class='ui-icon ui-icon-loading'></span><h1></h1></div>");a.extend(a.mobile,{showPageLoadingMsg:function(b,c,f){d.addClass("ui-loading");if(a.mobile.loadingMessage){var k=f||a.mobile.loadingMessageTextVisible;
b=b||a.mobile.loadingMessageTheme;h.attr("class","ui-loader ui-corner-all ui-body-"+(b||"a")+" ui-loader-"+(k?"verbose":"default")+(f?" ui-loader-textonly":"")).find("h1").text(c||a.mobile.loadingMessage).end().appendTo(a.mobile.pageContainer);e();g.bind("scroll",e)}},hidePageLoadingMsg:function(){d.removeClass("ui-loading");a.mobile.loadingMessage&&h.removeClass("ui-loader-fakefix");a(c).unbind("scroll",b);a(c).unbind("scroll",e)},initializePage:function(){var b=a(":jqmData(role='page'), :jqmData(role='dialog')");
b.length||(b=a("body").wrapInner("<div data-"+a.mobile.ns+"role='page'></div>").children(0));b.each(function(){var b=a(this);b.jqmData("url")||b.attr("data-"+a.mobile.ns+"url",b.attr("id")||location.pathname+location.search)});a.mobile.firstPage=b.first();a.mobile.pageContainer=b.first().parent().addClass("ui-mobile-viewport");g.trigger("pagecontainercreate");a.mobile.showPageLoadingMsg();f();!a.mobile.hashListeningEnabled||!a.mobile.path.stripHash(location.hash)?a.mobile.changePage(a.mobile.firstPage,
{transition:"none",reverse:true,changeHash:false,fromHashChange:true}):g.trigger("hashchange",[true])}});a.mobile._registerInternalEvents();a(function(){c.scrollTo(0,1);a.mobile.defaultHomeScroll=!a.support.scrollTop||a(c).scrollTop()===1?0:1;a.fn.controlgroup&&a(k).bind("pagecreate create",function(b){a(":jqmData(role='controlgroup')",b.target).jqmEnhanceable().controlgroup({excludeInvisible:false})});a.mobile.autoInitializePage&&a.mobile.initializePage();g.load(a.mobile.silentScroll)})}})(jQuery,
this)});

////////////////////////////////////////
// SRC End --> libs/jquery/jquery.mobile-1.1.0.min.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/jquery/jquery.mobile-events.min.js
////////////////////////////////////////
(function(e){function d(){var e=o();if(e!==u){u=e;i.trigger("orientationchange")}}function E(t,n,r,i){var s=r.type;r.type=n;e.event.dispatch.call(t,r,i);r.type=s}e.attrFn=e.attrFn||{};var t=navigator.userAgent.toLowerCase(),n=t.indexOf("chrome")>-1&&(t.indexOf("windows")>-1||t.indexOf("macintosh")>-1||t.indexOf("linux")>-1)&&t.indexOf("chrome")<0,r={swipe_h_threshold:50,swipe_v_threshold:50,taphold_threshold:750,doubletap_int:500,touch_capable:"ontouchstart"in document.documentElement&&!n,orientation_support:"orientation"in window&&"onorientationchange"in window,startevent:"ontouchstart"in document.documentElement&&!n?"touchstart":"mousedown",endevent:"ontouchstart"in document.documentElement&&!n?"touchend":"mouseup",moveevent:"ontouchstart"in document.documentElement&&!n?"touchmove":"mousemove",tapevent:"ontouchstart"in document.documentElement&&!n?"tap":"click",scrollevent:"ontouchstart"in document.documentElement&&!n?"touchmove":"scroll",hold_timer:null,tap_timer:null};e.isTouchCapable=function(){return r.touch_capable};e.getStartEvent=function(){return r.startevent};e.getEndEvent=function(){return r.endevent};e.getMoveEvent=function(){return r.moveevent};e.getTapEvent=function(){return r.tapevent};e.getScrollEvent=function(){return r.scrollevent};e.each(["tapstart","tapend","tap","singletap","doubletap","taphold","swipe","swipeup","swiperight","swipedown","swipeleft","swipeend","scrollstart","scrollend","orientationchange"],function(t,n){e.fn[n]=function(e){return e?this.bind(n,e):this.trigger(n)};e.attrFn[n]=true});e.event.special.tapstart={setup:function(){var t=this,n=e(t);n.bind(r.startevent,function(e){n.data("callee",arguments.callee);if(e.which&&e.which!==1){return false}var i=e.originalEvent,s={position:{x:r.touch_capable?i.touches[0].screenX:e.screenX,y:r.touch_capable?i.touches[0].screenY:e.screenY},offset:{x:r.touch_capable?i.touches[0].pageX-i.touches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?i.touches[0].pageY-i.touches[0].target.offsetTop:e.offsetY},time:(new Date).getTime(),target:e.target};E(t,"tapstart",e,s);return true})},remove:function(){e(this).unbind(r.startevent,e(this).data.callee)}};e.event.special.tapend={setup:function(){var t=this,n=e(t);n.bind(r.endevent,function(e){n.data("callee",arguments.callee);var i=e.originalEvent;var s={position:{x:r.touch_capable?i.changedTouches[0].screenX:e.screenX,y:r.touch_capable?i.changedTouches[0].screenY:e.screenY},offset:{x:r.touch_capable?i.changedTouches[0].pageX-i.changedTouches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?i.changedTouches[0].pageY-i.changedTouches[0].target.offsetTop:e.offsetY},time:(new Date).getTime(),target:e.target};E(t,"tapend",e,s);return true})},remove:function(){e(this).unbind(r.endevent,e(this).data.callee)}};e.event.special.taphold={setup:function(){var t=this,n=e(t),i,s,o={x:0,y:0};n.bind(r.startevent,function(e){if(e.which&&e.which!==1){return false}else{n.data("tapheld",false);i=e.target;var s=e.originalEvent;var u=(new Date).getTime(),a={x:r.touch_capable?s.touches[0].screenX:e.screenX,y:r.touch_capable?s.touches[0].screenY:e.screenY},f={x:r.touch_capable?s.touches[0].pageX-s.touches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?s.touches[0].pageY-s.touches[0].target.offsetTop:e.offsetY};o.x=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageX:e.pageX;o.y=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageY:e.pageY;r.hold_timer=window.setTimeout(function(){var l=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageX:e.pageX,c=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageY:e.pageY;if(e.target==i&&o.x==l&&o.y==c){n.data("tapheld",true);var h=(new Date).getTime(),p={x:r.touch_capable?s.touches[0].screenX:e.screenX,y:r.touch_capable?s.touches[0].screenY:e.screenY},d={x:r.touch_capable?s.touches[0].pageX-s.touches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?s.touches[0].pageY-s.touches[0].target.offsetTop:e.offsetY};duration=h-u;var v={startTime:u,endTime:h,startPosition:a,startOffset:f,endPosition:p,endOffset:d,duration:duration,target:e.target};n.data("callee1",arguments.callee);E(t,"taphold",e,v)}},r.taphold_threshold);return true}}).bind(r.endevent,function(){n.data("callee2",arguments.callee);n.data("tapheld",false);window.clearTimeout(r.hold_timer)})},remove:function(){e(this).unbind(r.startevent,e(this).data.callee1).unbind(r.endevent,e(this).data.callee2)}};e.event.special.doubletap={setup:function(){var t=this,n=e(t),i,s,o,u;n.bind(r.startevent,function(e){if(e.which&&e.which!==1){return false}else{n.data("doubletapped",false);i=e.target;n.data("callee1",arguments.callee);u=e.originalEvent;o={position:{x:r.touch_capable?u.touches[0].screenX:e.screenX,y:r.touch_capable?u.touches[0].screenY:e.screenY},offset:{x:r.touch_capable?u.touches[0].pageX-u.touches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?u.touches[0].pageY-u.touches[0].target.offsetTop:e.offsetY},time:(new Date).getTime(),target:e.target};return true}}).bind(r.endevent,function(e){var a=(new Date).getTime();var f=n.data("lastTouch")||a+1;var l=a-f;window.clearTimeout(s);n.data("callee2",arguments.callee);if(l<r.doubletap_int&&l>0&&e.target==i&&l>100){n.data("doubletapped",true);window.clearTimeout(r.tap_timer);var c={position:{x:r.touch_capable?u.touches[0].screenX:e.screenX,y:r.touch_capable?u.touches[0].screenY:e.screenY},offset:{x:r.touch_capable?u.touches[0].pageX-u.touches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?u.touches[0].pageY-u.touches[0].target.offsetTop:e.offsetY},time:(new Date).getTime(),target:e.target};var h={firstTap:o,secondTap:c,interval:c.time-o.time};E(t,"doubletap",e,h)}else{n.data("lastTouch",a);s=window.setTimeout(function(e){window.clearTimeout(s)},r.doubletap_int,[e])}n.data("lastTouch",a)})},remove:function(){e(this).unbind(r.startevent,e(this).data.callee1).unbind(r.endevent,e(this).data.callee2)}};e.event.special.singletap={setup:function(){var t=this,n=e(t),i=null,s=null,o={x:0,y:0};n.bind(r.startevent,function(e){if(e.which&&e.which!==1){return false}else{s=(new Date).getTime();i=e.target;n.data("callee1",arguments.callee);o.x=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageX:e.pageX;o.y=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageY:e.pageY;return true}}).bind(r.endevent,function(e){n.data("callee2",arguments.callee);if(e.target==i){end_pos_x=e.originalEvent.changedTouches?e.originalEvent.changedTouches[0].pageX:e.pageX;end_pos_y=e.originalEvent.changedTouches?e.originalEvent.changedTouches[0].pageY:e.pageY;r.tap_timer=window.setTimeout(function(){if(!n.data("doubletapped")&&!n.data("tapheld")&&o.x==end_pos_x&&o.y==end_pos_y){var i=e.originalEvent;var u={position:{x:r.touch_capable?i.changedTouches[0].screenX:e.screenX,y:r.touch_capable?i.changedTouches[0].screenY:e.screenY},offset:{x:r.touch_capable?i.changedTouches[0].pageX-i.changedTouches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?i.changedTouches[0].pageY-i.changedTouches[0].target.offsetTop:e.offsetY},time:(new Date).getTime(),target:e.target};if(u.time-s<r.taphold_threshold){E(t,"singletap",e,u)}}},r.doubletap_int)}})},remove:function(){e(this).unbind(r.startevent,e(this).data.callee1).unbind(r.endevent,e(this).data.callee2)}};e.event.special.tap={setup:function(){var t=this,n=e(t),i=false,s=null,o,u={x:0,y:0};n.bind(r.startevent,function(e){n.data("callee1",arguments.callee);if(e.which&&e.which!==1){return false}else{i=true;u.x=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageX:e.pageX;u.y=e.originalEvent.targetTouches?e.originalEvent.targetTouches[0].pageY:e.pageY;o=(new Date).getTime();s=e.target;return true}}).bind(r.endevent,function(e){n.data("callee2",arguments.callee);var a=e.originalEvent.targetTouches?e.originalEvent.changedTouches[0].pageX:e.pageX,f=e.originalEvent.targetTouches?e.originalEvent.changedTouches[0].pageY:e.pageY;if(s==e.target&&i&&(new Date).getTime()-o<r.taphold_threshold&&u.x==a&&u.y==f){var l=e.originalEvent;var c={position:{x:r.touch_capable?l.changedTouches[0].screenX:e.screenX,y:r.touch_capable?l.changedTouches[0].screenY:e.screenY},offset:{x:r.touch_capable?l.changedTouches[0].pageX-l.changedTouches[0].target.offsetLeft:e.offsetX,y:r.touch_capable?l.changedTouches[0].pageY-l.changedTouches[0].target.offsetTop:e.offsetY},time:(new Date).getTime(),target:e.target};E(t,"tap",e,c)}})},remove:function(){e(this).unbind(r.startevent,e(this).data.callee1).unbind(r.endevent,e(this).data.callee2)}};e.event.special.swipe={setup:function(){function f(t){n=e(t.target);n.data("callee1",arguments.callee);o.x=t.originalEvent.targetTouches?t.originalEvent.targetTouches[0].pageX:t.pageX;o.y=t.originalEvent.targetTouches?t.originalEvent.targetTouches[0].pageY:t.pageY;u.x=o.x;u.y=o.y;i=true;var s=t.originalEvent;a={position:{x:r.touch_capable?s.touches[0].screenX:t.screenX,y:r.touch_capable?s.touches[0].screenY:t.screenY},offset:{x:r.touch_capable?s.touches[0].pageX-s.touches[0].target.offsetLeft:t.offsetX,y:r.touch_capable?s.touches[0].pageY-s.touches[0].target.offsetTop:t.offsetY},time:(new Date).getTime(),target:t.target};var f=new Date;while(new Date-f<100){}}function l(t){n=e(t.target);n.data("callee2",arguments.callee);u.x=t.originalEvent.targetTouches?t.originalEvent.targetTouches[0].pageX:t.pageX;u.y=t.originalEvent.targetTouches?t.originalEvent.targetTouches[0].pageY:t.pageY;window.clearTimeout(r.hold_timer);var f;var l=n.data("xthreshold"),c=n.data("ythreshold"),h=typeof l!=="undefined"&&l!==false&&parseInt(l)?parseInt(l):r.swipe_h_threshold,p=typeof c!=="undefined"&&c!==false&&parseInt(c)?parseInt(c):r.swipe_v_threshold;if(o.y>u.y&&o.y-u.y>p){f="swipeup"}if(o.x<u.x&&u.x-o.x>h){f="swiperight"}if(o.y<u.y&&u.y-o.y>p){f="swipedown"}if(o.x>u.x&&o.x-u.x>h){f="swipeleft"}if(f!=undefined&&i){o.x=0;o.y=0;u.x=0;u.y=0;i=false;var d=t.originalEvent;endEvnt={position:{x:r.touch_capable?d.touches[0].screenX:t.screenX,y:r.touch_capable?d.touches[0].screenY:t.screenY},offset:{x:r.touch_capable?d.touches[0].pageX-d.touches[0].target.offsetLeft:t.offsetX,y:r.touch_capable?d.touches[0].pageY-d.touches[0].target.offsetTop:t.offsetY},time:(new Date).getTime(),target:t.target};var v=Math.abs(a.position.x-endEvnt.position.x),m=Math.abs(a.position.y-endEvnt.position.y);var g={startEvnt:a,endEvnt:endEvnt,direction:f.replace("swipe",""),xAmount:v,yAmount:m,duration:endEvnt.time-a.time};s=true;n.trigger("swipe",g).trigger(f,g)}}function c(t){n=e(t.target);var o="";n.data("callee3",arguments.callee);if(s){var u=n.data("xthreshold"),f=n.data("ythreshold"),l=typeof u!=="undefined"&&u!==false&&parseInt(u)?parseInt(u):r.swipe_h_threshold,c=typeof f!=="undefined"&&f!==false&&parseInt(f)?parseInt(f):r.swipe_v_threshold;var h=t.originalEvent;endEvnt={position:{x:r.touch_capable?h.changedTouches[0].screenX:t.screenX,y:r.touch_capable?h.changedTouches[0].screenY:t.screenY},offset:{x:r.touch_capable?h.changedTouches[0].pageX-h.changedTouches[0].target.offsetLeft:t.offsetX,y:r.touch_capable?h.changedTouches[0].pageY-h.changedTouches[0].target.offsetTop:t.offsetY},time:(new Date).getTime(),target:t.target};if(a.position.y>endEvnt.position.y&&a.position.y-endEvnt.position.y>c){o="swipeup"}if(a.position.x<endEvnt.position.x&&endEvnt.position.x-a.position.x>l){o="swiperight"}if(a.position.y<endEvnt.position.y&&endEvnt.position.y-a.position.y>c){o="swipedown"}if(a.position.x>endEvnt.position.x&&a.position.x-endEvnt.position.x>l){o="swipeleft"}var p=Math.abs(a.position.x-endEvnt.position.x),d=Math.abs(a.position.y-endEvnt.position.y);var v={startEvnt:a,endEvnt:endEvnt,direction:o.replace("swipe",""),xAmount:p,yAmount:d,duration:endEvnt.time-a.time};n.trigger("swipeend",v)}i=false;s=false}var t=this,n=e(t),i=false,s=false,o={x:0,y:0},u={x:0,y:0},a;n.bind(r.startevent,f);n.bind(r.moveevent,l);n.bind(r.endevent,c)},remove:function(){e(this).unbind(r.startevent,e(this).data.callee1).unbind(r.moveevent,e(this).data.callee2).unbind(r.endevent,e(this).data.callee3)}};e.event.special.scrollstart={setup:function(){function o(e,n){i=n;E(t,i?"scrollstart":"scrollend",e)}var t=this,n=e(t),i,s;n.bind(r.scrollevent,function(e){n.data("callee",arguments.callee);if(!i){o(e,true)}clearTimeout(s);s=setTimeout(function(){o(e,false)},50)})},remove:function(){e(this).unbind(r.scrollevent,e(this).data.callee)}};var i=e(window),s,o,u,a,f,l={0:true,180:true};if(r.orientation_support){var c=window.innerWidth||e(window).width(),h=window.innerHeight||e(window).height(),p=50;a=c>h&&c-h>p;f=l[window.orientation];if(a&&f||!a&&!f){l={"-90":true,90:true}}}e.event.special.orientationchange=s={setup:function(){if(r.orientation_support){return false}u=o();i.bind("throttledresize",d);return true},teardown:function(){if(r.orientation_support){return false}i.unbind("throttledresize",d);return true},add:function(e){var t=e.handler;e.handler=function(e){e.orientation=o();return t.apply(this,arguments)}}};e.event.special.orientationchange.orientation=o=function(){var e=true,t=document.documentElement;if(r.orientation_support){e=l[window.orientation]}else{e=t&&t.clientWidth/t.clientHeight<1.1}return e?"portrait":"landscape"};e.event.special.throttledresize={setup:function(){e(this).bind("resize",m)},teardown:function(){e(this).unbind("resize",m)}};var v=250,m=function(){b=(new Date).getTime();w=b-g;if(w>=v){g=b;e(this).trigger("throttledresize")}else{if(y){window.clearTimeout(y)}y=window.setTimeout(d,v-w)}},g=0,y,b,w;e.each({scrollend:"scrollstart",swipeup:"swipe",swiperight:"swipe",swipedown:"swipe",swipeleft:"swipe",swipeend:"swipe"},function(t,n,r){e.event.special[t]={setup:function(){e(this).bind(n,e.noop)}}})})(jQuery)

////////////////////////////////////////
// SRC End --> libs/jquery/jquery.mobile-events.min.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/jquery/jquery.pep.js
////////////////////////////////////////
/*      
 *         ________                                                            ________        
 *         ______(_)_____ ____  __________________  __ _____________________   ______(_)_______
 *         _____  /_  __ `/  / / /  _ \_  ___/_  / / / ___  __ \  _ \__  __ \  _____  /__  ___/
 *         ____  / / /_/ // /_/ //  __/  /   _  /_/ /____  /_/ /  __/_  /_/ /______  / _(__  ) 
 *         ___  /  \__, / \__,_/ \___//_/    _\__, /_(_)  .___/\___/_  .___/_(_)__  /  /____/  
 *         /___/     /_/                     /____/    /_/          /_/        /___/           
 *      
 *        http://pep.briangonzalez.org
 *        Kinetic drag for mobile/desktop.
 *        
 *        Copyright (c) 2013 Brian Gonzalez
 *        Licensed under the MIT license.
 *
 *        Title generated using "Speed" @ 
 *        http://patorjk.com/software/taag/#p=display&f=Speed&t=jquery.pep.js
 */
      
;(function ( $, window, undefined ) {

  "use strict";
  
  //  create the defaults once
  var pluginName = 'pep';
  var defaults   = {

    // Options
    // ----------------------------------------------------------------------------------------------
    // See ** https://github.com/briangonzalez/jquery.pep.js ** for fully documented options.
    // It was too hard to manage options here and in the readme.
    // ----------------------------------------------------------------------------------------------
    initiate:                       function(){},                                
    start:                          function(){},                                
    drag:                           function(){},                                
    stop:                           function(){},                                
    rest:                           function(){},
    startThreshold:                 [0,0],        
    grid:                           [1,1],                                                               
    debug:                          false,                                       
    activeClass:                    'pep-active',                                
    multiplier:                     1,                                           
    velocityMultiplier:             1.9,                                         
    shouldPreventDefault:           true,                                        
    allowDragEventPropagation:      true,                                        
    stopEvents:                     '',                                          
    hardwareAccelerate:             true,                                        
    useCSSTranslation:              true,                                        
    disableSelect:                  true,                                        
    cssEaseString:                  "cubic-bezier(0.190, 1.000, 0.220, 1.000)",  
    cssEaseDuration:                750,                                         
    shouldEase:                     true,                                        
    droppable:                      false,                                       
    droppableActiveClass:           'pep-dpa',                                   
    overlapFunction:                false,                                       
    constrainTo:                    false,                                       
    removeMargins:                  true,                                        
    place:                          true,                                        
    deferPlacement:                 false,                                       
    axis:                           null,                                        
    forceNonCSS3Movement:           false                                       
  };

  //  ---------------------------------
  //  -----  Our main Pep object  -----
  //  ---------------------------------
  function Pep( el, options ) {

    this.name = pluginName;

    // reference to our DOM object 
    // and it's jQuery equivalent.
    this.el  = el;
    this.$el = $(el);

    //  merge in defaults
    this.defaults   = defaults;
    this.options    = $.extend( {}, this.defaults, options) ;

    // store document/body so we don't need to keep grabbing them
    // throughout the code
    this.$document  = $(this.$el[0].ownerDocument);
    this.$body      = this.$document.find('body'); 

    //  Create our triggers based on touch/click device 
    this.moveTrigger  = "MSPointerMove touchmove mousemove";
    this.startTrigger = "MSPointerDown touchstart mousedown";
    this.stopTrigger  = "MSPointerUp touchend mouseup";

    this.stopEvents   = [ this.stopTrigger, this.options.stopEvents ].join(' ');

    if ( this.options.constrainTo === 'parent' ) {
      this.$container = this.$el.parent();
    } else if ( this.options.constrainTo === 'window' ) {
      this.$container = this.$document;
    }

    // IE need this
    if ( this.isPointerEventCompatible() )
      this.applyMSDefaults();

    this.CSSEaseHash    = this.getCSSEaseHash();
    this.scale          = 1;
    this.started        = false;
    this.disabled       = false;
    this.resetVelocityQueue();

    this.init();
  }

  //  init();
  //    initialization logic 
  //    you already have access to the DOM el and the options via the instance, 
  //    e.g., this.el and this.options
  Pep.prototype.init = function () {
    var self = this;

    if ( this.options.debug )
      this.buildDebugDiv();

    if ( this.options.disableSelect )
      this.disableSelect();

    // position the parent & place the object, if necessary.
    if ( this.options.place && !this.options.deferPlacement ) {
      this.positionParent();
      this.placeObject();
    }

    this.ev = {};       // to store our event movements
    this.pos = {};      // to store positions
    this.subscribe();
  };

  //  subscribe(); 
  //    useful in the event we want to programmatically 
  //    interact with our Pep object.
  //      e.g.:     $('#pep').trigger('stop')
  Pep.prototype.subscribe = function () {
    var self = this;

    // Subscribe to our start event 
    this.$el.bind( this.startTrigger, function(ev){
      self.handleStart(ev);
    });

    // Subscribe to our stop event  
    this.$document.bind( this.stopEvents, function(ev) {
      self.handleStop(ev);
    });

    // Subscribe to our move event  
    this.$document.bind( this.moveTrigger, function(ev){
      self.moveEvent = ev;
    });
  };

  //  handleStart();
  //    once this.startTrigger occurs, handle all of the logic
  //    that must go on. This is where Pep's heavy lifting is done. 
  Pep.prototype.handleStart = function(ev) {
    var self = this;

            // only continue chugging if our start event is a valid move event. 
            if ( this.isValidMoveEvent(ev) && !this.disabled ){

                    // IE10 Hack. Me not happy.
                    if ( this.isPointerEventCompatible() && ev.preventManipulation )
                      ev.preventManipulation();

                    // normalize event
                    ev = this.normalizeEvent(ev);

                    // position the parent & place the object, if necessary.
                    if ( this.options.place && this.options.deferPlacement ) {
                      this.positionParent();
                      this.placeObject();
                    }

                    // log it
                    this.log({ type: 'event', event: ev.type });

                    // hardware accelerate, if necessary.
                    if ( this.options.hardwareAccelerate && !this.hardwareAccelerated ) {
                      this.hardwareAccelerate();
                      this.hardwareAccelerated = true;
                    }

                    // fire user's initiate event.
                    this.options.initiate.call(this, ev, this);

                    // cancel the rest timeout
                    clearTimeout( this.restTimeout );

                    // add active class and reset css animation, if necessary
                    this.$el.addClass( this.options.activeClass );
                    this.removeCSSEasing();

                    // store x & y values for later use
                    this.startX = this.ev.x = ev.pep.x;
                    this.startY = this.ev.y = ev.pep.y;

                    // store the initial touch/click event, used to calculate the inital delta values.
                    this.startEvent = this.moveEvent = ev;

                    // make object active, so watchMoveLoop starts looping.
                    this.active     = true;

                    // preventDefault(), is necessary
                    if ( this.options.shouldPreventDefault )
                      ev.preventDefault();

                    // allow / disallow event bubbling
                    if ( !this.options.allowDragEventPropagation ) 
                      ev.stopPropagation();

                    // animation loop to ensure we don't fire 
                    // too many unneccessary repaints  
                    (function watchMoveLoop(){
                        if ( !self.active ) return;
                        self.handleMove();
                        self.requestAnimationFrame( watchMoveLoop );
                    })($, self);

            }
  };

  //  handleMove();
  //    the logic for when the move events occur 
  Pep.prototype.handleMove = function() {

            // setup our event object
            if ( typeof(this.moveEvent) === 'undefined' ) 
              return;

            // get our move event's x & y
            var ev      = this.normalizeEvent( this.moveEvent );
            var curX    = window.parseInt(ev.pep.x / this.options.grid[0]) * this.options.grid[0];
            var curY    = window.parseInt(ev.pep.y / this.options.grid[1]) * this.options.grid[1];

            // last in, first out (LIFO) queue to help us manage velocity
            this.addToLIFO( { time: ev.timeStamp, x: curX, y: curY } );

            // calculate values necessary to moving
            var dx, dy;

            if ( this.startTrigger.split(' ').indexOf(ev.type) > -1  ){
              dx = 0;
              dy = 0;
            } else{
              dx = curX - this.ev.x;
              dy = curY - this.ev.y;
            }

            this.dx   = dx;
            this.dy   = dy;
            this.ev.x = curX;
            this.ev.y = curY;

            // no movement in either direction -- so return
            if (dx === 0 && dy === 0){
              this.log({ type: 'event', event: '** stopped **' });
              return;
            }

            // check if object has moved past X/Y thresholds
            // if so, fire users start event
            var initialDx  = Math.abs(this.startX - curX);
            var initialDy  = Math.abs(this.startY - curY);
            if ( !this.started && ( initialDx > this.options.startThreshold[0] || initialDy > this.options.startThreshold[1] ) ){
              this.started = true;
              this.$el.addClass('pep-start');
              this.options.start.call(this, this.startEvent, this);
            }

            // Calculate our drop regions
            if ( this.options.droppable ) {
              this.calculateActiveDropRegions();
            }

            // fire user's drag event.
            var continueDrag = this.options.drag.call(this, ev, this);

            if ( continueDrag === false ) {
              this.resetVelocityQueue();
              return;
            }

            // log the move trigger & event position
            this.log({ type: 'event', event: ev.type });
            this.log({ type: 'event-coords', x: this.ev.x, y: this.ev.y });
            this.log({ type: 'velocity' });

            var hash = this.handleConstraint(dx, dy);

            // if using not using CSS transforms, move object via absolute position
            if ( !this.shouldUseCSSTranslation() ){  
              var xOp     = ( dx >= 0 ) ? "+=" + Math.abs(dx/this.scale)*this.options.multiplier : "-=" + Math.abs(dx/this.scale)*this.options.multiplier;
              var yOp     = ( dy >= 0 ) ? "+=" + Math.abs(dy/this.scale)*this.options.multiplier : "-=" + Math.abs(dy/this.scale)*this.options.multiplier;

              if ( this.options.constrainTo ) {
                xOp = (hash.x !== false) ? hash.x : xOp;
                yOp = (hash.y !== false) ? hash.y : yOp;
              }

              this.moveTo(xOp, yOp);
            }
            else {

              dx = (dx/this.scale)*this.options.multiplier;
              dy = (dy/this.scale)*this.options.multiplier;

              if ( this.options.constrainTo ) {
                dx = (hash.x === false) ? dx : 0 ;
                dy = (hash.y === false) ? dy : 0 ;
              }
              this.moveToUsingTransforms( dx, dy );
            }
  };

  //  handleStop();
  //    the logic for when the stop events occur
  Pep.prototype.handleStop = function(ev) {

            // no need to handle stop event if we're not active
            if (!this.active) 
              return;

            // log it
            this.log({ type: 'event', event: ev.type });

            // make object inactive, so watchMoveLoop returns
            this.active = false;

            // remove our start class
            this.$el.removeClass('pep-start')
                    .addClass('pep-ease');

            // Calculate our drop regions
            if ( this.options.droppable ) {
              this.calculateActiveDropRegions();
            }

            // ease the object, if necessary
            if (this.options.shouldEase)
              this.ease(ev);

            // fire user's stop event.
            this.options.stop.call(this, ev, this);

            // this must be set to false after 
            // the user's stop event is called, so the dev
            // has access to it. 
            this.started = false;

            // reset the velocity queue 
            this.resetVelocityQueue();

  };

  //  ease();
  //    used in conjunction with the LIFO queue 
  //    to ease the object after stop
  Pep.prototype.ease = function(ev){

            var pos       = this.$el.position();
            var vel       = this.velocity();
            var dt        = this.dt;
            var x         = (vel.x/this.scale) * this.options.multiplier;
            var y         = (vel.y/this.scale) * this.options.multiplier;

            var hash      = this.handleConstraint(x, y);

            // ✪  Apply the CSS3 animation easing magic  ✪
            if ( this.cssAnimationsSupported() )
              this.$el.css( this.getCSSEaseHash() );
            
            var xOp = ( vel.x > 0 ) ? "+=" + x : "-=" + Math.abs(x);
            var yOp = ( vel.y > 0 ) ? "+=" + y : "-=" + Math.abs(y);

            if ( this.options.constrainTo ) {
              xOp = (hash.x !== false) ? hash.x : xOp;
              yOp = (hash.y !== false) ? hash.y : yOp;
            }

            // ease it via JS, the last true tells it to animate.
            var jsAnimateFallback = !this.cssAnimationsSupported() || this.options.forceNonCSS3Movement;
                   this.moveTo(xOp, yOp, jsAnimateFallback);

            // when the rest occurs, remove active class and call
            // user's rest event.
            var self = this;
            this.restTimeout = setTimeout( function(){ 

              // Calculate our drop regions
              if ( self.options.droppable ) {
                self.calculateActiveDropRegions();
              }
              
              // call users rest event.
              self.options.rest.call(self, ev, self);

              // remove active class 
              self.$el.removeClass( [self.options.activeClass, 'pep-ease'].join(' ') ); 
                                        
            }, this.options.cssEaseDuration );
    
  }; 

  // normalizeEvent()
  Pep.prototype.normalizeEvent = function(ev) {
      ev.pep        = {};

      if ( this.isPointerEventCompatible() || !this.isTouch(ev) ) {
        ev.pep.x      = ev.originalEvent.pageX;
        ev.pep.y      = ev.originalEvent.pageY;
        ev.pep.type   = ev.type;
      } 
      else {
        ev.pep.x      = ev.originalEvent.touches[0].pageX;
        ev.pep.y      = ev.originalEvent.touches[0].pageY;
        ev.pep.type   = ev.type;
      }

       return ev;
   };

  // resetVelocityQueue()
  //    
  Pep.prototype.resetVelocityQueue = function() {
    this.velocityQueue = new Array(5);
  };

  //  moveTo();
  //    move the object to an x and/or y value
  //    using jQuery's .css function -- this fxn uses the 
  //    .css({top: "+=20", left: "-=30"}) syntax
  Pep.prototype.moveTo = function(x,y, animate) {

    animate = ( animate === false || typeof(animate) === 'undefined' ) ? 
      false : true; 

    if ( this.options.axis  === 'x' ){
      y = "+=0";
    } 
    else if ( this.options.axis  === 'y' ){
      x = "+=0";
    }

    var animateDuration = 300;
    this.log({ type: 'delta', x: x, y: y });
    if ( animate ) {
      this.$el.animate({ top: y, left: x }, animateDuration, 'easeOutCirc', {queue: false});
    } else{
      this.$el.stop(true, false).css({ top: y , left: x });
    } 

  };

  //  moveToUsingTransforms();
  //    move the object to an x and/or y value
  Pep.prototype.moveToUsingTransforms = function(x,y) {

    // only move along single axis, if necessary
    if ( this.options.axis  === 'x' )
      y = 0;
    
    if ( this.options.axis  === 'y' )
      x = 0;

    // Check for our initial values if we don't have them.
    var matrixArray  = this.matrixToArray( this.matrixString() );
    if ( !this.cssX )
      this.cssX = parseInt(matrixArray[4], 10);

    if ( !this.cssY )
      this.cssY = parseInt(matrixArray[5], 10);

    // CSS3 transforms are additive from current position
    this.cssX = this.cssX + x;
    this.cssY = this.cssY + y;

    this.log({ type: 'delta', x: x, y: y });

    matrixArray[4]    = this.cssX;
    matrixArray[5]    = this.cssY;
    
    this.translation  = this.arrayToMatrix( matrixArray );

    this.$el.css({ 
        '-webkit-transform': this.translation,
           '-moz-transform': this.translation,
            '-ms-transform': this.translation,
             '-o-transform': this.translation,
                'transform': this.translation  });
  };

  // 3 helper functions for working with the 
  // objects CSS3 transforms
  // matrixString
  // matrixToArray
  // arrayToMatrix
  Pep.prototype.matrixString = function() {

    var validMatrix = function(o){
      return !( !o || o === 'none' || o.indexOf('matrix') === -1);
    };

    var matrix = "matrix(1, 0, 0, 1, 0, 0)";

    if ( validMatrix( this.$el.css('-webkit-transform') ) )
      matrix = this.$el.css('-webkit-transform');

    if ( validMatrix( this.$el.css('-moz-transform') ) )
      matrix = this.$el.css('-moz-transform');

    if ( validMatrix( this.$el.css('-ms-transform') ) )
      matrix = this.$el.css('-ms-transform');

    if ( validMatrix( this.$el.css('-o-transform') ) )
      matrix = this.$el.css('-o-transform');

    if ( validMatrix( this.$el.css('transform') ) )
      matrix = this.$el.css('transform');

    return matrix;
  };

  Pep.prototype.matrixToArray = function(str) {
      return str.split('(')[1].split(')')[0].split(',');
  };

  Pep.prototype.arrayToMatrix = function(array) {
      return "matrix(" +  array.join(',')  + ")";
  };

  //  addToLIFO();
  //    a Last-In/First-Out array of the 5 most recent 
  //    velocity points, which is used for easing
  Pep.prototype.addToLIFO = function(val){
    // last in, first out
    var arr = this.velocityQueue;
    arr = arr.slice(1, arr.length);
    arr.push(val);
    this.velocityQueue = arr;
  };

  //  velocity();
  //    using the LIFO, calculate velocity and return
  //    velocity in each direction (x & y)
  Pep.prototype.velocity = function(){
    var sumX = 0;
    var sumY = 0;

    for ( var i = 0; i < this.velocityQueue.length -1; i++  ){
      if ( this.velocityQueue[i] ){
        sumX        += (this.velocityQueue[i+1].x - this.velocityQueue[i].x);
        sumY        += (this.velocityQueue[i+1].y - this.velocityQueue[i].y);
        this.dt     = ( this.velocityQueue[i+1].time - this.velocityQueue[i].time );
      }
    }

    // return velocity in each direction.
    return { x: sumX*this.options.velocityMultiplier, y: sumY*this.options.velocityMultiplier};
  };

  //  requestAnimationFrame();
  //    requestAnimationFrame Polyfill
  //    More info:
  //    http://paulirish.com/2011/requestanimationframe-for-smart-animating/
  Pep.prototype.requestAnimationFrame = function(callback) {
    return  window.requestAnimationFrame        && window.requestAnimationFrame(callback)         || 
            window.webkitRequestAnimationFrame  && window.webkitRequestAnimationFrame(callback)   || 
            window.mozRequestAnimationFrame     && window.mozRequestAnimationFrame(callback)      || 
            window.oRequestAnimationFrame       && window.mozRequestAnimationFrame(callback)      || 
            window.msRequestAnimationFrame      && window.msRequestAnimationFrame(callback)       || 
            window.setTimeout(callback, 1000 / 60);
  };

  //  positionParent();
  //    add the right positioning to the parent object
  Pep.prototype.positionParent = function() {

    if ( !this.options.constrainTo || this.parentPositioned )
      return;

    this.parentPositioned = true;

    // make `relative` parent if necessary
    if ( this.options.constrainTo === 'parent' ) {
      this.$container.css({ position: 'relative' });
    } else if ( this.options.constrainTo === 'window' && this.$container.get(0).nodeName !== "#document" &&
                this.$container.css('position') !== 'static' )
    {
      this.$container.css({ position: 'static' });
    }

  };

  //  placeObject();
  //    add the right positioning to the object
  Pep.prototype.placeObject = function() {

    if ( this.objectPlaced )
      return;

    this.objectPlaced = true;

    this.offset = (this.options.constrainTo === 'parent' || this.hasNonBodyRelative() ) ?
                    this.$el.position() : this.$el.offset();
    
    // better to leave absolute position alone if
    // it already has one.
    if ( parseInt( this.$el.css('left'), 10 ) )
      this.offset.left = this.$el.css('left');

    if ( parseInt( this.$el.css('top'), 10 ) )
      this.offset.top = this.$el.css('top');

    if ( this.options.removeMargins )
      this.$el.css({margin: 0});
    
    this.$el.css({
      position:   'absolute',
      top:        this.offset.top,
      left:       this.offset.left
    });

  };

  //  hasNonBodyRelative()
  //    returns true if any parent other than the body
  //    has relative positioning
  Pep.prototype.hasNonBodyRelative = function() {
    return this.$el.parents().filter(function() {  
        var $this = $(this);
        return $this.is('body') || $this.css('position') === 'relative';
    }).length > 1;
  };

  //  setScale()
  //    set the scale of the object being moved.
  Pep.prototype.setScale = function(val) {
    this.scale = val;
  };

  //  setMultiplier()
  //    set the multiplier of the object being moved.
  Pep.prototype.setMultiplier = function(val) {
    this.options.multiplier = val;
  };

  //  removeCSSEasing();
  //    remove CSS easing properties, if necessary
  Pep.prototype.removeCSSEasing = function() {
    if ( this.cssAnimationsSupported() )
      this.$el.css( this.getCSSEaseHash(true) );
  };

  //  disableSelect();
  //    add the property which causes the object
  //    to not be selected user drags over text areas
  Pep.prototype.disableSelect = function() {

    this.$el.css({ 
      '-webkit-touch-callout' : 'none',
        '-webkit-user-select' : 'none',
         '-khtml-user-select' : 'none',
           '-moz-user-select' : 'none',
            '-ms-user-select' : 'none',
                'user-select' : 'none'
    });

  };

  //  handleConstraint();
  //    returns a hash of where to move to
  //    when we constrain to parent/window
  Pep.prototype.handleConstraint = function(dx, dy) {
    var pos               = this.$el.position();
    this.pos.x            = pos.left;
    this.pos.y            = pos.top;
    var hash              = { x: false, y: false };

    var upperYLimit, upperXLimit, lowerXLimit, lowerYLimit;

    // log our positions
    this.log({ type: "pos-coords", x: this.pos.x, y: this.pos.y});

    if ( $.isArray( this.options.constrainTo ) ) {

      if ( this.options.constrainTo[3] !== undefined && this.options.constrainTo[1] !== undefined ) { 
        upperXLimit     = this.options.constrainTo[1];
        lowerXLimit     = this.options.constrainTo[3];
      }
      if ( this.options.constrainTo[0] !== false && this.options.constrainTo[2] !== false ) { 
        upperYLimit       = this.options.constrainTo[2];
        lowerYLimit       = this.options.constrainTo[0];
      }

      // is our object trying to move outside lower X & Y limits?
      if ( this.pos.x + dx < lowerXLimit)     hash.x = lowerXLimit; 
      if ( this.pos.y + dy < lowerYLimit)     hash.y = lowerYLimit;

    } else if ( typeof this.options.constrainTo === 'string' ) {
      upperXLimit       = this.$container.width()  - this.$el.outerWidth();
      upperYLimit       = this.$container.height() - this.$el.outerHeight();
      // is our object trying to move outside lower X & Y limits?
      if ( this.pos.x + dx < 0 )              hash.x = 0; 
      if ( this.pos.y + dy < 0 )              hash.y = 0;
    }
  
    // is our object trying to move outside upper X & Y limits?
    if ( this.pos.x + dx > upperXLimit )    hash.x = upperXLimit;
    if ( this.pos.y + dy > upperYLimit )    hash.y = upperYLimit;

    return hash;
  };

  //  getCSSEaseHash();
  //    returns a hash of params used in conjunction 
  //    with this.options.cssEaseString
  Pep.prototype.getCSSEaseHash = function(reset){    
    if ( typeof(reset) === 'undefined' ) reset = false;

    var cssEaseString;
    if (reset){
      cssEaseString = '';
    } else if ( this.CSSEaseHash ) {
      return this.CSSEaseHash;
    } else {
      cssEaseString = ['all', this.options.cssEaseDuration + 'ms', this.options.cssEaseString].join(' ');
    }

    return {
                  '-webkit-transition'   : cssEaseString,   // chrome, safari, etc.
                     '-moz-transition'   : cssEaseString,   // firefox
                      '-ms-transition'   : cssEaseString,   // microsoft
                       '-o-transition'   : cssEaseString,   // opera
                          'transition'   : cssEaseString    // future
          };
  };

  // calculateActiveDropRegions()
  //    sets parent droppables of this.
  Pep.prototype.calculateActiveDropRegions = function() {
    var self = this;
    this.activeDropRegions = [];

    $.each( $(this.options.droppable), function(idx, el){
      var $el = $(el);
      if ( self.isOverlapping($el, self.$el) ){
        $el.addClass(self.options.droppableActiveClass);
        self.activeDropRegions.push($el);
      } else {
        $el.removeClass(self.options.droppableActiveClass);
      }
    });

  };

  //  isOverlapping();
  //    returns true if element a over
  Pep.prototype.isOverlapping = function($a,$b) {

    if ( this.options.overlapFunction ) {
      return this.options.overlapFunction($a,$b);
    }

    var rect1 = $a[0].getBoundingClientRect();
    var rect2 = $b[0].getBoundingClientRect();

    return !( rect1.right   < rect2.left  || 
              rect1.left    > rect2.right || 
              rect1.bottom  < rect2.top   || 
              rect1.top     > rect2.bottom  );
  };

  //  isTouch();
  //    returns whether or not event is a touch event
  Pep.prototype.isTouch = function(ev){    
    return ev.type.search('touch') > -1;
  };

  // isPointerEventCompatible();
  //    return whether or note our device is pointer 
  //    event compatible; typically means where on a 
  //    touch Win8 device
  Pep.prototype.isPointerEventCompatible = function() {
    return ("MSPointerEvent" in window);
  };

  // applyMSDefaults();
  Pep.prototype.applyMSDefaults = function(first_argument) {
    this.$body.css({
        '-ms-touch-action' :    'none',
        'touch-action' :        'none',
        '-ms-scroll-chaining':  'none', 
        '-ms-scroll-limit':     '0 0 0 0', 
        'overflow':             'hidden'
    });
  };

  //  isValidMoveEvent();
  //    returns true if we're on a non-touch device -- or -- 
  //    if the event is a non-pinch event on a touch device
  Pep.prototype.isValidMoveEvent = function(ev){   
    if ( !this.isTouch(ev) || ( this.isTouch(ev) && ev.originalEvent.hasOwnProperty('touches') && ev.originalEvent.touches.length === 1 ) ){
      return true;
    } else{
      return false;
    }
  };

  //  shouldUseCSSTranslation();
  //    return true if we should use CSS transforms for move the object
  Pep.prototype.shouldUseCSSTranslation = function() {

    if ( typeof(this.useCSSTranslation) !== "undefined" )
      return this.useCSSTranslation;

    var useCSSTranslation = false;

    if ( !this.options.useCSSTranslation || ( typeof(Modernizr) !== "undefined" && !Modernizr.csstransforms)){
      useCSSTranslation = false;
    } 
    else{
      useCSSTranslation = true;
    }

    this.useCSSTranslation = useCSSTranslation;
    return useCSSTranslation;
  };

  //  cssAnimationsSupported():
  //    returns true if the browser supports CSS animations
  //    which are used for easing..
  Pep.prototype.cssAnimationsSupported = function() {

    if ( typeof(this.cssAnimationsSupport) !== "undefined" ){
      return this.cssAnimationsSupport;
    }

    // If the page has Modernizr, let them do the heavy lifting.
    if ( ( typeof(Modernizr) !== "undefined" && Modernizr.cssanimations) ){
      this.cssAnimationsSupport = true;
      return true;
    }

    var animation = false,
        elm = document.createElement('div'),
        animationstring = 'animation',
        keyframeprefix = '',
        domPrefixes = 'Webkit Moz O ms Khtml'.split(' '),
        pfx  = '';
    
    if( elm.style.animationName ) { animation = true; }    
     
    if( animation === false ) {
      for( var i = 0; i < domPrefixes.length; i++ ) {
        if( elm.style[ domPrefixes[i] + 'AnimationName' ] !== undefined ) {
          pfx = domPrefixes[ i ];
          animationstring = pfx + 'Animation';
          keyframeprefix = '-' + pfx.toLowerCase() + '-';
          animation = true;
          break;
        }
      }
    }

    this.cssAnimationsSupport = animation;
    return animation;
  };

  //  hardwareAccelerate();
  //    add fool-proof CSS3 hardware acceleration.
  Pep.prototype.hardwareAccelerate = function() {
    this.$el.css({     
      '-webkit-perspective':          1000,
      'perspective':                  1000,
      '-webkit-backface-visibility':  'hidden',
      'backface-visibility':          'hidden'  
    });
   }; 

  //  getMovementValues();
  //    returns object pos, event position, and velocity in each direction.
  Pep.prototype.getMovementValues = function() {
    return { ev: this.ev, pos: this.pos, velocity: this.velocity() };
   }; 

  //  buildDebugDiv();
  //    Create a little div in the lower right corner of the window
  //    for extra info about the object currently moving
  Pep.prototype.buildDebugDiv = function() {

    // Build the debugDiv and it's inner HTML -- if necessary
    var $debugDiv;
    if ( $('#pep-debug').length === 0 ){
      $debugDiv = $('<div></div>');
      $debugDiv
        .attr('id', 'pep-debug')
        .append("<div style='font-weight:bold; background: red; color: white;'>DEBUG MODE</div>")
        .append("<div id='pep-debug-event'>no event</div>")
        .append("<div id='pep-debug-ev-coords'>event coords: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .append("<div id='pep-debug-pos-coords'>position coords: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .append("<div id='pep-debug-velocity'>velocity: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .append("<div id='pep-debug-delta'>&Delta; movement: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .css({
          position:   'fixed',
          bottom:     5,
          right:      5,
          zIndex:     99999,    
          textAlign:  'right',
          fontFamily: 'Arial, sans',
          fontSize:   10,
          border:     '1px solid #DDD',
          padding:    '3px',
          background: 'white',
          color:      '#333'
        });
    }

    var self = this;
    setTimeout(function(){
      self.debugElements = {
        $event:      $("#pep-debug-event"),
        $velocityX:  $("#pep-debug-velocity .pep-x"),
        $velocityY:  $("#pep-debug-velocity .pep-y"),
        $dX:         $("#pep-debug-delta .pep-x"),
        $dY:         $("#pep-debug-delta .pep-y"),
        $evCoordsX:  $("#pep-debug-ev-coords .pep-x"),
        $evCoordsY:  $("#pep-debug-ev-coords .pep-y"),
        $posCoordsX: $("#pep-debug-pos-coords .pep-x"),
        $posCoordsY: $("#pep-debug-pos-coords .pep-y")
      };
    }, 0);

    $('body').append( $debugDiv );
  };

  // log()
  Pep.prototype.log = function(opts) {
    if ( !this.options.debug ) return;

    switch (opts.type){
    case "event": 
      this.debugElements.$event.text(opts.event);
      break;
    case "pos-coords": 
      this.debugElements.$posCoordsX.text(opts.x);
      this.debugElements.$posCoordsY.text(opts.y);
      break;
    case "event-coords": 
      this.debugElements.$evCoordsX.text(opts.x);
      this.debugElements.$evCoordsY.text(opts.y);
      break;
    case "delta": 
      this.debugElements.$dX.text(opts.x);
      this.debugElements.$dY.text(opts.y);
      break;
    case "velocity": 
      var vel = this.velocity();
      this.debugElements.$velocityX.text( Math.round(vel.x) );
      this.debugElements.$velocityY.text( Math.round(vel.y) );
      break;
    }
  };

  // toggle()
  //  toggle the pep object
  Pep.prototype.toggle = function(on) {
    if ( typeof(on) === "undefined"){
      this.disabled = !this.disabled;
    }
    else {
      this.disabled = !on;
    }   
  };

  //  wrap it 
  //    A really lightweight plugin wrapper around the constructor, 
  //    preventing against multiple instantiations.
  $.fn[pluginName] = function ( options ) {
    return this.each(function () {
      if (!$.data(this, 'plugin_' + pluginName)) {
        var pepObj = new Pep( this, options );
        $.data(this, 'plugin_' + pluginName, pepObj);
        $.pep.peps.push(pepObj);
      }
    });
  };

  //  The   _   ___ ___ 
  //       /_\ | _ \_ _|
  //      / _ \|  _/| | 
  //     /_/ \_\_| |___|
  //
  $.pep = {};
  $.pep.peps = [];
  $.pep.toggleAll = function(on){
    $.each(this.peps, function(index, pepObj){
      pepObj.toggle(on);
    }); 
  };

  $.pep.unbind = function($obj){
    var pep = $obj.data('plugin_' + pluginName);

    if ( typeof pep === 'undefined' )
      return;

    pep.toggle(false);
    $obj.removeData('plugin_' + pluginName);
  };

}(jQuery, window));





////////////////////////////////////////
// SRC End --> libs/jquery/jquery.pep.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/mustache/mustache_0.7.0.js
////////////////////////////////////////
/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */

/*global define: false*/

var Mustache;

(function (exports) {
  if (typeof module !== "undefined" && module.exports) {
    module.exports = exports; // CommonJS
  } else if (typeof define === "function") {
    define(exports); // AMD
  } else {
    Mustache = exports; // <script>
  }
}((function () {

  var exports = {};

  exports.name = "mustache.js";
  exports.version = "0.7.0";
  exports.tags = ["{{", "}}"];

  exports.Scanner = Scanner;
  exports.Context = Context;
  exports.Writer = Writer;

  var whiteRe = /\s*/;
  var spaceRe = /\s+/;
  var nonSpaceRe = /\S/;
  var eqRe = /\s*=/;
  var curlyRe = /\s*\}/;
  var tagRe = /#|\^|\/|>|\{|&|=|!/;

  // Workaround for https://issues.apache.org/jira/browse/COUCHDB-577
  // See https://github.com/janl/mustache.js/issues/189
  function testRe(re, string) {
    return RegExp.prototype.test.call(re, string);
  }

  function isWhitespace(string) {
    return !testRe(nonSpaceRe, string);
  }

  var isArray = Array.isArray || function (obj) {
    return Object.prototype.toString.call(obj) === "[object Array]";
  };

  function escapeRe(string) {
    return string.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&");
  }

  var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
  };

  function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
    });
  }

  // Export the escaping function so that the user may override it.
  // See https://github.com/janl/mustache.js/issues/244
  exports.escape = escapeHtml;

  function Scanner(string) {
    this.string = string;
    this.tail = string;
    this.pos = 0;
  }

  /**
   * Returns `true` if the tail is empty (end of string).
   */
  Scanner.prototype.eos = function () {
    return this.tail === "";
  };

  /**
   * Tries to match the given regular expression at the current position.
   * Returns the matched text if it can match, the empty string otherwise.
   */
  Scanner.prototype.scan = function (re) {
    var match = this.tail.match(re);

    if (match && match.index === 0) {
      this.tail = this.tail.substring(match[0].length);
      this.pos += match[0].length;
      return match[0];
    }

    return "";
  };

  /**
   * Skips all text until the given regular expression can be matched. Returns
   * the skipped string, which is the entire tail if no match can be made.
   */
  Scanner.prototype.scanUntil = function (re) {
    var match, pos = this.tail.search(re);

    switch (pos) {
    case -1:
      match = this.tail;
      this.pos += this.tail.length;
      this.tail = "";
      break;
    case 0:
      match = "";
      break;
    default:
      match = this.tail.substring(0, pos);
      this.tail = this.tail.substring(pos);
      this.pos += pos;
    }

    return match;
  };

  function Context(view, parent) {
    this.view = view;
    this.parent = parent;
    this.clearCache();
  }

  Context.make = function (view) {
    return (view instanceof Context) ? view : new Context(view);
  };

  Context.prototype.clearCache = function () {
    this._cache = {};
  };

  Context.prototype.push = function (view) {
    return new Context(view, this);
  };

  Context.prototype.lookup = function (name) {
    var value = this._cache[name];

    if (!value) {
      if (name === ".") {
        value = this.view;
      } else {
        var context = this;

        while (context) {
          if (name.indexOf(".") > 0) {
            var names = name.split("."), i = 0;

            value = context.view;

            while (value && i < names.length) {
              value = value[names[i++]];
            }
          } else {
            value = context.view[name];
          }

          if (value != null) {
            break;
          }

          context = context.parent;
        }
      }

      this._cache[name] = value;
    }

    if (typeof value === "function") {
      value = value.call(this.view);
    }

    return value;
  };

  function Writer() {
    this.clearCache();
  }

  Writer.prototype.clearCache = function () {
    this._cache = {};
    this._partialCache = {};
  };

  Writer.prototype.compile = function (template, tags) {
    var fn = this._cache[template];

    if (!fn) {
      var tokens = exports.parse(template, tags);
      fn = this._cache[template] = this.compileTokens(tokens, template);
    }

    return fn;
  };

  Writer.prototype.compilePartial = function (name, template, tags) {
    var fn = this.compile(template, tags);
    this._partialCache[name] = fn;
    return fn;
  };

  Writer.prototype.compileTokens = function (tokens, template) {
    var fn = compileTokens(tokens);
    var self = this;

    return function (view, partials) {
      if (partials) {
        if (typeof partials === "function") {
          self._loadPartial = partials;
        } else {
          for (var name in partials) {
            self.compilePartial(name, partials[name]);
          }
        }
      }

      return fn(self, Context.make(view), template);
    };
  };

  Writer.prototype.render = function (template, view, partials) {
    return this.compile(template)(view, partials);
  };

  Writer.prototype._section = function (name, context, text, callback) {
    var value = context.lookup(name);

    switch (typeof value) {
    case "object":
      if (isArray(value)) {
        var buffer = "";

        for (var i = 0, len = value.length; i < len; ++i) {
          buffer += callback(this, context.push(value[i]));
        }

        return buffer;
      }

      return value ? callback(this, context.push(value)) : "";
    case "function":
      var self = this;
      var scopedRender = function (template) {
        return self.render(template, context);
      };

      return value.call(context.view, text, scopedRender) || "";
    default:
      if (value) {
        return callback(this, context);
      }
    }

    return "";
  };

  Writer.prototype._inverted = function (name, context, callback) {
    var value = context.lookup(name);

    // Use JavaScript's definition of falsy. Include empty arrays.
    // See https://github.com/janl/mustache.js/issues/186
    if (!value || (isArray(value) && value.length === 0)) {
      return callback(this, context);
    }

    return "";
  };

  Writer.prototype._partial = function (name, context) {
    if (!(name in this._partialCache) && this._loadPartial) {
      this.compilePartial(name, this._loadPartial(name));
    }

    var fn = this._partialCache[name];

    return fn ? fn(context) : "";
  };

  Writer.prototype._name = function (name, context) {
    var value = context.lookup(name);

    if (typeof value === "function") {
      value = value.call(context.view);
    }

    return (value == null) ? "" : String(value);
  };

  Writer.prototype._escaped = function (name, context) {
    return exports.escape(this._name(name, context));
  };

  /**
   * Calculates the bounds of the section represented by the given `token` in
   * the original template by drilling down into nested sections to find the
   * last token that is part of that section. Returns an array of [start, end].
   */
  function sectionBounds(token) {
    var start = token[3];
    var end = start;

    var tokens;
    while ((tokens = token[4]) && tokens.length) {
      token = tokens[tokens.length - 1];
      end = token[3];
    }

    return [start, end];
  }

  /**
   * Low-level function that compiles the given `tokens` into a function
   * that accepts three arguments: a Writer, a Context, and the template.
   */
  function compileTokens(tokens) {
    var subRenders = {};

    function subRender(i, tokens, template) {
      if (!subRenders[i]) {
        var fn = compileTokens(tokens);
        subRenders[i] = function (writer, context) {
          return fn(writer, context, template);
        };
      }

      return subRenders[i];
    }

    return function (writer, context, template) {
      var buffer = "";
      var token, sectionText;

      for (var i = 0, len = tokens.length; i < len; ++i) {
        token = tokens[i];

        switch (token[0]) {
        case "#":
          sectionText = template.slice.apply(template, sectionBounds(token));
          buffer += writer._section(token[1], context, sectionText, subRender(i, token[4], template));
          break;
        case "^":
          buffer += writer._inverted(token[1], context, subRender(i, token[4], template));
          break;
        case ">":
          buffer += writer._partial(token[1], context);
          break;
        case "&":
          buffer += writer._name(token[1], context);
          break;
        case "name":
          buffer += writer._escaped(token[1], context);
          break;
        case "text":
          buffer += token[1];
          break;
        }
      }

      return buffer;
    };
  }

  /**
   * Forms the given array of `tokens` into a nested tree structure where
   * tokens that represent a section have a fifth item: an array that contains
   * all tokens in that section.
   */
  function nestTokens(tokens) {
    var tree = [];
    var collector = tree;
    var sections = [];
    var token, section;

    for (var i = 0; i < tokens.length; ++i) {
      token = tokens[i];

      switch (token[0]) {
      case "#":
      case "^":
        token[4] = [];
        sections.push(token);
        collector.push(token);
        collector = token[4];
        break;
      case "/":
        if (sections.length === 0) {
          throw new Error("Unopened section: " + token[1]);
        }

        section = sections.pop();

        if (section[1] !== token[1]) {
          throw new Error("Unclosed section: " + section[1]);
        }

        if (sections.length > 0) {
          collector = sections[sections.length - 1][4];
        } else {
          collector = tree;
        }
        break;
      default:
        collector.push(token);
      }
    }

    // Make sure there were no open sections when we're done.
    section = sections.pop();

    if (section) {
      throw new Error("Unclosed section: " + section[1]);
    }

    return tree;
  }

  /**
   * Combines the values of consecutive text tokens in the given `tokens` array
   * to a single token.
   */
  function squashTokens(tokens) {
    var token, lastToken;

    for (var i = 0; i < tokens.length; ++i) {
      token = tokens[i];

      if (lastToken && lastToken[0] === "text" && token[0] === "text") {
        lastToken[1] += token[1];
        lastToken[3] = token[3];
        tokens.splice(i--, 1); // Remove this token from the array.
      } else {
        lastToken = token;
      }
    }
  }

  function escapeTags(tags) {
    if (tags.length !== 2) {
      throw new Error("Invalid tags: " + tags.join(" "));
    }

    return [
      new RegExp(escapeRe(tags[0]) + "\\s*"),
      new RegExp("\\s*" + escapeRe(tags[1]))
    ];
  }

  /**
   * Breaks up the given `template` string into a tree of token objects. If
   * `tags` is given here it must be an array with two string values: the
   * opening and closing tags used in the template (e.g. ["<%", "%>"]). Of
   * course, the default is to use mustaches (i.e. Mustache.tags).
   */
  exports.parse = function (template, tags) {
    tags = tags || exports.tags;

    var tagRes = escapeTags(tags);
    var scanner = new Scanner(template);

    var tokens = [],      // Buffer to hold the tokens
        spaces = [],      // Indices of whitespace tokens on the current line
        hasTag = false,   // Is there a {{tag}} on the current line?
        nonSpace = false; // Is there a non-space char on the current line?

    // Strips all whitespace tokens array for the current line
    // if there was a {{#tag}} on it and otherwise only space.
    function stripSpace() {
      if (hasTag && !nonSpace) {
        while (spaces.length) {
          tokens.splice(spaces.pop(), 1);
        }
      } else {
        spaces = [];
      }

      hasTag = false;
      nonSpace = false;
    }

    var start, type, value, chr;

    while (!scanner.eos()) {
      start = scanner.pos;
      value = scanner.scanUntil(tagRes[0]);

      if (value) {
        for (var i = 0, len = value.length; i < len; ++i) {
          chr = value.charAt(i);

          if (isWhitespace(chr)) {
            spaces.push(tokens.length);
          } else {
            nonSpace = true;
          }

          tokens.push(["text", chr, start, start + 1]);
          start += 1;

          if (chr === "\n") {
            stripSpace(); // Check for whitespace on the current line.
          }
        }
      }

      start = scanner.pos;

      // Match the opening tag.
      if (!scanner.scan(tagRes[0])) {
        break;
      }

      hasTag = true;
      type = scanner.scan(tagRe) || "name";

      // Skip any whitespace between tag and value.
      scanner.scan(whiteRe);

      // Extract the tag value.
      if (type === "=") {
        value = scanner.scanUntil(eqRe);
        scanner.scan(eqRe);
        scanner.scanUntil(tagRes[1]);
      } else if (type === "{") {
        var closeRe = new RegExp("\\s*" + escapeRe("}" + tags[1]));
        value = scanner.scanUntil(closeRe);
        scanner.scan(curlyRe);
        scanner.scanUntil(tagRes[1]);
        type = "&";
      } else {
        value = scanner.scanUntil(tagRes[1]);
      }

      // Match the closing tag.
      if (!scanner.scan(tagRes[1])) {
        throw new Error("Unclosed tag at " + scanner.pos);
      }

      tokens.push([type, value, start, scanner.pos]);

      if (type === "name" || type === "{" || type === "&") {
        nonSpace = true;
      }

      // Set the tags for the next time around.
      if (type === "=") {
        tags = value.split(spaceRe);
        tagRes = escapeTags(tags);
      }
    }

    squashTokens(tokens);

    return nestTokens(tokens);
  };

  // The high-level clearCache, compile, compilePartial, and render functions
  // use this default writer.
  var _writer = new Writer();

  /**
   * Clears all cached templates and partials in the default writer.
   */
  exports.clearCache = function () {
    return _writer.clearCache();
  };

  /**
   * Compiles the given `template` to a reusable function using the default
   * writer.
   */
  exports.compile = function (template, tags) {
    return _writer.compile(template, tags);
  };

  /**
   * Compiles the partial with the given `name` and `template` to a reusable
   * function using the default writer.
   */
  exports.compilePartial = function (name, template, tags) {
    return _writer.compilePartial(name, template, tags);
  };

  /**
   * Compiles the given array of tokens (the output of a parse) to a reusable
   * function using the default writer.
   */
  exports.compileTokens = function (tokens, template) {
    return _writer.compileTokens(tokens, template);
  };

  /**
   * Renders the `template` with the given `view` and `partials` using the
   * default writer.
   */
  exports.render = function (template, view, partials) {
    return _writer.render(template, view, partials);
  };

  // This is here for backwards compatibility with 0.4.x.
  exports.to_html = function (template, view, partials, send) {
    var result = exports.render(template, view, partials);

    if (typeof send === "function") {
      send(result);
    } else {
      return result;
    }
  };

  return exports;

}())));

////////////////////////////////////////
// SRC End --> libs/mustache/mustache_0.7.0.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> libs/lodash/lodash-2.2.1.js
////////////////////////////////////////
/**
 * @license
 * Lo-Dash 2.2.1 (Custom Build) lodash.com/license | Underscore.js 1.5.2 underscorejs.org/LICENSE
 * Build: `lodash modern -o ./dist/lodash.js`
 */
;(function(){function n(n,t,e){e=(e||0)-1;for(var r=n?n.length:0;++e<r;)if(n[e]===t)return e;return-1}function t(t,e){var r=typeof e;if(t=t.l,"boolean"==r||null==e)return t[e]?0:-1;"number"!=r&&"string"!=r&&(r="object");var u="number"==r?e:_+e;return t=(t=t[r])&&t[u],"object"==r?t&&-1<n(t,e)?0:-1:t?0:-1}function e(n){var t=this.l,e=typeof n;if("boolean"==e||null==n)t[n]=!0;else{"number"!=e&&"string"!=e&&(e="object");var r="number"==e?n:_+n,t=t[e]||(t[e]={});"object"==e?(t[r]||(t[r]=[])).push(n):t[r]=!0
}}function r(n){return n.charCodeAt(0)}function u(n,t){var e=n.m,r=t.m;if(e!==r){if(e>r||typeof e=="undefined")return 1;if(e<r||typeof r=="undefined")return-1}return n.n-t.n}function o(n){var t=-1,r=n.length,u=n[0],o=n[0|r/2],a=n[r-1];if(u&&typeof u=="object"&&o&&typeof o=="object"&&a&&typeof a=="object")return!1;for(u=f(),u["false"]=u["null"]=u["true"]=u.undefined=!1,o=f(),o.k=n,o.l=u,o.push=e;++t<r;)o.push(n[t]);return o}function a(n){return"\\"+G[n]}function i(){return g.pop()||[]}function f(){return y.pop()||{k:null,l:null,m:null,"false":!1,n:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,undefined:!1,o:null}
}function l(){}function c(n){n.length=0,g.length<d&&g.push(n)}function p(n){var t=n.l;t&&p(t),n.k=n.l=n.m=n.object=n.number=n.string=n.o=null,y.length<d&&y.push(n)}function s(n,t,e){t||(t=0),typeof e=="undefined"&&(e=n?n.length:0);var r=-1;e=e-t||0;for(var u=Array(0>e?0:e);++r<e;)u[r]=n[t+r];return u}function v(e){function g(n){if(!n||je.call(n)!=z)return!1;var t=n.valueOf,e=typeof t=="function"&&(e=ge(t))&&ge(e);return e?n==e||ge(n)==e:st(n)}function y(n,t,e){if(!n||!V[typeof n])return n;t=t&&typeof e=="undefined"?t:et(t,e,3);
for(var r=-1,u=V[typeof n]&&Ke(n),o=u?u.length:0;++r<o&&(e=u[r],false!==t(n[e],e,n)););return n}function d(n,t,e){var r;if(!n||!V[typeof n])return n;t=t&&typeof e=="undefined"?t:et(t,e,3);for(r in n)if(false===t(n[r],r,n))break;return n}function G(n,t,e){var r,u=n,o=u;if(!u)return o;for(var a=arguments,i=0,f=typeof e=="number"?2:a.length;++i<f;)if((u=a[i])&&V[typeof u])for(var l=-1,c=V[typeof u]&&Ke(u),p=c?c.length:0;++l<p;)r=c[l],"undefined"==typeof o[r]&&(o[r]=u[r]);return o}function J(n,t,e){var r,u=n,o=u;
if(!u)return o;var a=arguments,i=0,f=typeof e=="number"?2:a.length;if(3<f&&"function"==typeof a[f-2])var l=et(a[--f-1],a[f--],2);else 2<f&&"function"==typeof a[f-1]&&(l=a[--f]);for(;++i<f;)if((u=a[i])&&V[typeof u])for(var c=-1,p=V[typeof u]&&Ke(u),s=p?p.length:0;++c<s;)r=p[c],o[r]=l?l(o[r],u[r]):u[r];return o}function Q(n){var t,e=[];if(!n||!V[typeof n])return e;for(t in n)ye.call(n,t)&&e.push(t);return e}function Y(n){return n&&typeof n=="object"&&!Pe(n)&&ye.call(n,"__wrapped__")?n:new nt(n)}function nt(n,t){this.__chain__=!!t,this.__wrapped__=n
}function tt(n,t,e,r,u){if(e){var o=e(n);if(typeof o!="undefined")return o}if(!bt(n))return n;var a=je.call(n);if(!L[a])return n;var f=We[a];switch(a){case F:case T:return new f(+n);case q:case K:return new f(n);case P:return o=f(n.source,O.exec(n)),o.lastIndex=n.lastIndex,o}if(a=Pe(n),t){var l=!r;r||(r=i()),u||(u=i());for(var p=r.length;p--;)if(r[p]==n)return u[p];o=a?f(n.length):{}}else o=a?s(n):J({},n);return a&&(ye.call(n,"index")&&(o.index=n.index),ye.call(n,"input")&&(o.input=n.input)),t?(r.push(n),u.push(o),(a?It:y)(n,function(n,a){o[a]=tt(n,t,e,r,u)
}),l&&(c(r),c(u)),o):o}function et(n,t,e){if(typeof n!="function")return Gt;if(typeof t=="undefined")return n;var r=n.__bindData__||qe.funcNames&&!n.name;if(typeof r=="undefined"){var u=R&&he.call(n);qe.funcNames||!u||I.test(u)||(r=!0),(qe.funcNames||!r)&&(r=!qe.funcDecomp||R.test(u),ze(n,r))}if(true!==r&&r&&1&r[1])return n;switch(e){case 1:return function(e){return n.call(t,e)};case 2:return function(e,r){return n.call(t,e,r)};case 3:return function(e,r,u){return n.call(t,e,r,u)};case 4:return function(e,r,u,o){return n.call(t,e,r,u,o)
}}return Mt(n,t)}function rt(n,t,e,r){r=(r||0)-1;for(var u=n?n.length:0,o=[];++r<u;){var a=n[r];if(a&&typeof a=="object"&&typeof a.length=="number"&&(Pe(a)||ht(a))){t||(a=rt(a,t,e));var i=-1,f=a.length,l=o.length;for(o.length+=f;++i<f;)o[l++]=a[i]}else e||o.push(a)}return o}function ut(n,t,e,r,u,o){if(e){var a=e(n,t);if(typeof a!="undefined")return!!a}if(n===t)return 0!==n||1/n==1/t;if(n===n&&!(n&&V[typeof n]||t&&V[typeof t]))return!1;if(null==n||null==t)return n===t;var f=je.call(n),l=je.call(t);
if(f==B&&(f=z),l==B&&(l=z),f!=l)return!1;switch(f){case F:case T:return+n==+t;case q:return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case P:case K:return n==oe(t)}if(l=f==$,!l){if(ye.call(n,"__wrapped__")||ye.call(t,"__wrapped__"))return ut(n.__wrapped__||n,t.__wrapped__||t,e,r,u,o);if(f!=z)return!1;var f=n.constructor,p=t.constructor;if(f!=p&&!(_t(f)&&f instanceof f&&_t(p)&&p instanceof p))return!1}for(p=!u,u||(u=i()),o||(o=i()),f=u.length;f--;)if(u[f]==n)return o[f]==t;var s=0,a=!0;if(u.push(n),o.push(t),l){if(f=n.length,s=t.length,a=s==n.length,!a&&!r)return a;
for(;s--;)if(l=f,p=t[s],r)for(;l--&&!(a=ut(n[l],p,e,r,u,o)););else if(!(a=ut(n[s],p,e,r,u,o)))break;return a}return d(t,function(t,i,f){return ye.call(f,i)?(s++,a=ye.call(n,i)&&ut(n[i],t,e,r,u,o)):void 0}),a&&!r&&d(n,function(n,t,e){return ye.call(e,t)?a=-1<--s:void 0}),p&&(c(u),c(o)),a}function ot(n,t,e,r,u){(Pe(t)?It:y)(t,function(t,o){var a,i,f=t,l=n[o];if(t&&((i=Pe(t))||g(t))){for(f=r.length;f--;)if(a=r[f]==t){l=u[f];break}if(!a){var c;e&&(f=e(l,t),c=typeof f!="undefined")&&(l=f),c||(l=i?Pe(l)?l:[]:g(l)?l:{}),r.push(t),u.push(l),c||ot(l,t,e,r,u)
}}else e&&(f=e(l,t),typeof f=="undefined"&&(f=t)),typeof f!="undefined"&&(l=f);n[o]=l})}function at(e,r,u){var a=-1,f=pt(),l=e?e.length:0,s=[],v=!r&&l>=b&&f===n,h=u||v?i():s;if(v){var g=o(h);g?(f=t,h=g):(v=!1,h=u?h:(c(h),s))}for(;++a<l;){var g=e[a],y=u?u(g,a,e):g;(r?!a||h[h.length-1]!==y:0>f(h,y))&&((u||v)&&h.push(y),s.push(g))}return v?(c(h.k),p(h)):u&&c(h),s}function it(n){return function(t,e,r){var u={};e=Y.createCallback(e,r,3),r=-1;var o=t?t.length:0;if(typeof o=="number")for(;++r<o;){var a=t[r];
n(u,a,e(a,r,t),t)}else y(t,function(t,r,o){n(u,t,e(t,r,o),o)});return u}}function ft(n,t,e,r,u,o){var a=1&t,i=2&t,f=4&t,l=8&t,c=16&t,p=32&t,s=n;if(!i&&!_t(n))throw new ae;c&&!e.length&&(t&=-17,c=e=!1),p&&!r.length&&(t&=-33,p=r=!1);var v=n&&n.__bindData__;if(v)return!a||1&v[1]||(v[4]=u),!a&&1&v[1]&&(t|=8),!f||4&v[1]||(v[5]=o),c&&_e.apply(v[2]||(v[2]=[]),e),p&&_e.apply(v[3]||(v[3]=[]),r),v[1]|=t,ft.apply(null,v);if(!a||i||f||p||!(qe.fastBind||Ce&&c))g=function(){var v=arguments,h=a?u:this;return(f||c||p)&&(v=$e.call(v),c&&ke.apply(v,e),p&&_e.apply(v,r),f&&v.length<o)?(t|=16,ft(n,l?t:-4&t,v,null,u,o)):(i&&(n=h[s]),this instanceof g?(h=lt(n.prototype),v=n.apply(h,v),bt(v)?v:h):n.apply(h,v))
};else{if(c){var h=[u];_e.apply(h,e)}var g=c?Ce.apply(n,h):Ce.call(n,u)}return ze(g,$e.call(arguments)),g}function lt(n){return bt(n)?Oe(n):{}}function ct(n){return Le[n]}function pt(){var t=(t=Y.indexOf)===Wt?n:t;return t}function st(n){var t,e;return n&&je.call(n)==z&&(t=n.constructor,!_t(t)||t instanceof t)?(d(n,function(n,t){e=t}),typeof e=="undefined"||ye.call(n,e)):!1}function vt(n){return Me[n]}function ht(n){return n&&typeof n=="object"&&typeof n.length=="number"&&je.call(n)==B||!1}function gt(n,t,e){var r=Ke(n),u=r.length;
for(t=et(t,e,3);u--&&(e=r[u],false!==t(n[e],e,n)););return n}function yt(n){var t=[];return d(n,function(n,e){_t(n)&&t.push(e)}),t.sort()}function mt(n){for(var t=-1,e=Ke(n),r=e.length,u={};++t<r;){var o=e[t];u[n[o]]=o}return u}function _t(n){return typeof n=="function"}function bt(n){return!(!n||!V[typeof n])}function dt(n){return typeof n=="number"||je.call(n)==q}function wt(n){return typeof n=="string"||je.call(n)==K}function jt(n){for(var t=-1,e=Ke(n),r=e.length,u=Xt(r);++t<r;)u[t]=n[e[t]];return u
}function kt(n,t,e){var r=-1,u=pt(),o=n?n.length:0,a=!1;return e=(0>e?Re(0,o+e):e)||0,Pe(n)?a=-1<u(n,t,e):typeof o=="number"?a=-1<(wt(n)?n.indexOf(t,e):u(n,t,e)):y(n,function(n){return++r<e?void 0:!(a=n===t)}),a}function xt(n,t,e){var r=!0;t=Y.createCallback(t,e,3),e=-1;var u=n?n.length:0;if(typeof u=="number")for(;++e<u&&(r=!!t(n[e],e,n)););else y(n,function(n,e,u){return r=!!t(n,e,u)});return r}function Ct(n,t,e){var r=[];t=Y.createCallback(t,e,3),e=-1;var u=n?n.length:0;if(typeof u=="number")for(;++e<u;){var o=n[e];
t(o,e,n)&&r.push(o)}else y(n,function(n,e,u){t(n,e,u)&&r.push(n)});return r}function Ot(n,t,e){t=Y.createCallback(t,e,3),e=-1;var r=n?n.length:0;if(typeof r!="number"){var u;return y(n,function(n,e,r){return t(n,e,r)?(u=n,!1):void 0}),u}for(;++e<r;){var o=n[e];if(t(o,e,n))return o}}function It(n,t,e){var r=-1,u=n?n.length:0;if(t=t&&typeof e=="undefined"?t:et(t,e,3),typeof u=="number")for(;++r<u&&false!==t(n[r],r,n););else y(n,t);return n}function Nt(n,t,e){var r=n?n.length:0;if(t=t&&typeof e=="undefined"?t:et(t,e,3),typeof r=="number")for(;r--&&false!==t(n[r],r,n););else{var u=Ke(n),r=u.length;
y(n,function(n,e,o){return e=u?u[--r]:--r,t(o[e],e,o)})}return n}function Et(n,t,e){var r=-1,u=n?n.length:0;if(t=Y.createCallback(t,e,3),typeof u=="number")for(var o=Xt(u);++r<u;)o[r]=t(n[r],r,n);else o=[],y(n,function(n,e,u){o[++r]=t(n,e,u)});return o}function St(n,t,e){var u=-1/0,o=u;if(!t&&Pe(n)){e=-1;for(var a=n.length;++e<a;){var i=n[e];i>o&&(o=i)}}else t=!t&&wt(n)?r:Y.createCallback(t,e,3),It(n,function(n,e,r){e=t(n,e,r),e>u&&(u=e,o=n)});return o}function Rt(n,t){var e=-1,r=n?n.length:0;if(typeof r=="number")for(var u=Xt(r);++e<r;)u[e]=n[e][t];
return u||Et(n,t)}function At(n,t,e,r){if(!n)return e;var u=3>arguments.length;t=et(t,r,4);var o=-1,a=n.length;if(typeof a=="number")for(u&&(e=n[++o]);++o<a;)e=t(e,n[o],o,n);else y(n,function(n,r,o){e=u?(u=!1,n):t(e,n,r,o)});return e}function Dt(n,t,e,r){var u=3>arguments.length;return t=et(t,r,4),Nt(n,function(n,r,o){e=u?(u=!1,n):t(e,n,r,o)}),e}function Bt(n){var t=-1,e=n?n.length:0,r=Xt(typeof e=="number"?e:0);return It(n,function(n){var e=Jt(++t);r[t]=r[e],r[e]=n}),r}function $t(n,t,e){var r;t=Y.createCallback(t,e,3),e=-1;
var u=n?n.length:0;if(typeof u=="number")for(;++e<u&&!(r=t(n[e],e,n)););else y(n,function(n,e,u){return!(r=t(n,e,u))});return!!r}function Ft(e){var r=-1,u=pt(),a=e?e.length:0,i=rt(arguments,!0,!0,1),f=[],l=a>=b&&u===n;if(l){var c=o(i);c?(u=t,i=c):l=!1}for(;++r<a;)c=e[r],0>u(i,c)&&f.push(c);return l&&p(i),f}function Tt(n,t,e){var r=0,u=n?n.length:0;if(typeof t!="number"&&null!=t){var o=-1;for(t=Y.createCallback(t,e,3);++o<u&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[0]:h;return s(n,0,Ae(Re(0,r),u))
}function Wt(t,e,r){if(typeof r=="number"){var u=t?t.length:0;r=0>r?Re(0,u+r):r||0}else if(r)return r=zt(t,e),t[r]===e?r:-1;return n(t,e,r)}function qt(n,t,e){if(typeof t!="number"&&null!=t){var r=0,u=-1,o=n?n.length:0;for(t=Y.createCallback(t,e,3);++u<o&&t(n[u],u,n);)r++}else r=null==t||e?1:Re(0,t);return s(n,r)}function zt(n,t,e,r){var u=0,o=n?n.length:u;for(e=e?Y.createCallback(e,r,1):Gt,t=e(t);u<o;)r=u+o>>>1,e(n[r])<t?u=r+1:o=r;return u}function Pt(n,t,e,r){return typeof t!="boolean"&&null!=t&&(e=(r=e)&&r[t]===n?null:t,t=!1),null!=e&&(e=Y.createCallback(e,r,3)),at(n,t,e)
}function Kt(){for(var n=1<arguments.length?arguments:arguments[0],t=-1,e=n?St(Rt(n,"length")):0,r=Xt(0>e?0:e);++t<e;)r[t]=Rt(n,t);return r}function Lt(n,t){for(var e=-1,r=n?n.length:0,u={};++e<r;){var o=n[e];t?u[o]=t[e]:o&&(u[o[0]]=o[1])}return u}function Mt(n,t){return 2<arguments.length?ft(n,17,$e.call(arguments,2),null,t):ft(n,1,null,null,t)}function Ut(n,t,e){function r(){c&&se(c),a=c=p=h,(g||v!==t)&&(s=me(),i=n.apply(l,o))}function u(){var e=t-(me()-f);0<e?c=de(u,e):(a&&se(a),e=p,a=c=p=h,e&&(s=me(),i=n.apply(l,o)))
}var o,a,i,f,l,c,p,s=0,v=!1,g=!0;if(!_t(n))throw new ae;if(t=Re(0,t)||0,true===e)var y=!0,g=!1;else bt(e)&&(y=e.leading,v="maxWait"in e&&(Re(t,e.maxWait)||0),g="trailing"in e?e.trailing:g);return function(){if(o=arguments,f=me(),l=this,p=g&&(c||!y),false===v)var e=y&&!c;else{a||y||(s=f);var h=v-(f-s);0<h?a||(a=de(r,h)):(a&&(a=se(a)),s=f,i=n.apply(l,o))}return c||t===v||(c=de(u,t)),e&&(i=n.apply(l,o)),i}}function Vt(n){if(!_t(n))throw new ae;var t=$e.call(arguments,1);return de(function(){n.apply(h,t)},1)
}function Gt(n){return n}function Ht(n,t){var e=n,r=!t||_t(e);t||(e=nt,t=n,n=Y),It(yt(t),function(u){var o=n[u]=t[u];r&&(e.prototype[u]=function(){var t=this.__wrapped__,r=[t];return _e.apply(r,arguments),r=o.apply(n,r),t&&typeof t=="object"&&t===r?this:(r=new e(r),r.__chain__=this.__chain__,r)})})}function Jt(n,t,e){var r=null==n,u=null==t;return null==e&&(typeof n=="boolean"&&u?(e=n,n=1):u||typeof t!="boolean"||(e=t,u=!0)),r&&u&&(t=1),n=+n||0,u?(t=n,n=0):t=+t||0,r=Be(),e||n%1||t%1?Ae(n+r*(t-n+parseFloat("1e-"+((r+"").length-1))),t):n+ve(r*(t-n+1))
}function Qt(){return this.__wrapped__}e=e?Z.defaults(H.Object(),e,Z.pick(H,D)):H;var Xt=e.Array,Yt=e.Boolean,Zt=e.Date,ne=e.Function,te=e.Math,ee=e.Number,re=e.Object,ue=e.RegExp,oe=e.String,ae=e.TypeError,ie=[],fe=re.prototype,le=e._,ce=ue("^"+oe(fe.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),pe=te.ceil,se=e.clearTimeout,ve=te.floor,he=ne.prototype.toString,ge=ce.test(ge=re.getPrototypeOf)&&ge,ye=fe.hasOwnProperty,me=ce.test(me=Zt.now)&&me||function(){return+new Zt
},_e=ie.push,be=e.setImmediate,de=e.setTimeout,we=ie.splice,je=fe.toString,ke=ie.unshift,xe=function(){try{var n={},t=ce.test(t=re.defineProperty)&&t,e=t(n,n,n)&&t}catch(r){}return e}(),Ce=ce.test(Ce=je.bind)&&Ce,Oe=ce.test(Oe=re.create)&&Oe,Ie=ce.test(Ie=Xt.isArray)&&Ie,Ne=e.isFinite,Ee=e.isNaN,Se=ce.test(Se=re.keys)&&Se,Re=te.max,Ae=te.min,De=e.parseInt,Be=te.random,$e=ie.slice,Fe=ce.test(e.attachEvent),Te=Ce&&!/\n|true/.test(Ce+Fe),We={};We[$]=Xt,We[F]=Yt,We[T]=Zt,We[W]=ne,We[z]=re,We[q]=ee,We[P]=ue,We[K]=oe,nt.prototype=Y.prototype;
var qe=Y.support={};qe.fastBind=Ce&&!Te,qe.funcDecomp=!ce.test(e.a)&&R.test(v),qe.funcNames=typeof ne.name=="string",Y.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:N,variable:"",imports:{_:Y}},Oe||(lt=function(n){if(bt(n)){l.prototype=n;var t=new l;l.prototype=null}return t||{}});var ze=xe?function(n,t){U.value=t,xe(n,"__bindData__",U)}:l,Pe=Ie||function(n){return n&&typeof n=="object"&&typeof n.length=="number"&&je.call(n)==$||!1},Ke=Se?function(n){return bt(n)?Se(n):[]
}:Q,Le={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Me=mt(Le),Ue=ue("("+Ke(Me).join("|")+")","g"),Ve=ue("["+Ke(Le).join("")+"]","g"),Ge=it(function(n,t,e){ye.call(n,e)?n[e]++:n[e]=1}),He=it(function(n,t,e){(ye.call(n,e)?n[e]:n[e]=[]).push(t)}),Je=it(function(n,t,e){n[e]=t});Te&&X&&typeof be=="function"&&(Vt=function(n){if(!_t(n))throw new ae;return be.apply(e,arguments)});var Qe=8==De(w+"08")?De:function(n,t){return De(wt(n)?n.replace(E,""):n,t||0)};return Y.after=function(n,t){if(!_t(t))throw new ae;
return function(){return 1>--n?t.apply(this,arguments):void 0}},Y.assign=J,Y.at=function(n){for(var t=arguments,e=-1,r=rt(t,!0,!1,1),t=t[2]&&t[2][t[1]]===n?1:r.length,u=Xt(t);++e<t;)u[e]=n[r[e]];return u},Y.bind=Mt,Y.bindAll=function(n){for(var t=1<arguments.length?rt(arguments,!0,!1,1):yt(n),e=-1,r=t.length;++e<r;){var u=t[e];n[u]=ft(n[u],1,null,null,n)}return n},Y.bindKey=function(n,t){return 2<arguments.length?ft(t,19,$e.call(arguments,2),null,n):ft(t,3,null,null,n)},Y.chain=function(n){return n=new nt(n),n.__chain__=!0,n
},Y.compact=function(n){for(var t=-1,e=n?n.length:0,r=[];++t<e;){var u=n[t];u&&r.push(u)}return r},Y.compose=function(){for(var n=arguments,t=n.length;t--;)if(!_t(n[t]))throw new ae;return function(){for(var t=arguments,e=n.length;e--;)t=[n[e].apply(this,t)];return t[0]}},Y.countBy=Ge,Y.createCallback=function(n,t,e){var r=typeof n;if(null==n||"function"==r)return et(n,t,e);if("object"!=r)return function(t){return t[n]};var u=Ke(n),o=u[0],a=n[o];return 1!=u.length||a!==a||bt(a)?function(t){for(var e=u.length,r=!1;e--&&(r=ut(t[u[e]],n[u[e]],null,!0)););return r
}:function(n){return n=n[o],a===n&&(0!==a||1/a==1/n)}},Y.curry=function(n,t){return t=typeof t=="number"?t:+t||n.length,ft(n,4,null,null,null,t)},Y.debounce=Ut,Y.defaults=G,Y.defer=Vt,Y.delay=function(n,t){if(!_t(n))throw new ae;var e=$e.call(arguments,2);return de(function(){n.apply(h,e)},t)},Y.difference=Ft,Y.filter=Ct,Y.flatten=function(n,t,e,r){return typeof t!="boolean"&&null!=t&&(e=(r=e)&&r[t]===n?null:t,t=!1),null!=e&&(n=Et(n,e,r)),rt(n,t)},Y.forEach=It,Y.forEachRight=Nt,Y.forIn=d,Y.forInRight=function(n,t,e){var r=[];
d(n,function(n,t){r.push(t,n)});var u=r.length;for(t=et(t,e,3);u--&&false!==t(r[u--],r[u],n););return n},Y.forOwn=y,Y.forOwnRight=gt,Y.functions=yt,Y.groupBy=He,Y.indexBy=Je,Y.initial=function(n,t,e){var r=0,u=n?n.length:0;if(typeof t!="number"&&null!=t){var o=u;for(t=Y.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else r=null==t||e?1:t||r;return s(n,0,Ae(Re(0,u-r),u))},Y.intersection=function(e){for(var r=arguments,u=r.length,a=-1,f=i(),l=-1,s=pt(),v=e?e.length:0,h=[],g=i();++a<u;){var y=r[a];f[a]=s===n&&(y?y.length:0)>=b&&o(a?r[a]:g)
}n:for(;++l<v;){var m=f[0],y=e[l];if(0>(m?t(m,y):s(g,y))){for(a=u,(m||g).push(y);--a;)if(m=f[a],0>(m?t(m,y):s(r[a],y)))continue n;h.push(y)}}for(;u--;)(m=f[u])&&p(m);return c(f),c(g),h},Y.invert=mt,Y.invoke=function(n,t){var e=$e.call(arguments,2),r=-1,u=typeof t=="function",o=n?n.length:0,a=Xt(typeof o=="number"?o:0);return It(n,function(n){a[++r]=(u?t:n[t]).apply(n,e)}),a},Y.keys=Ke,Y.map=Et,Y.max=St,Y.memoize=function(n,t){function e(){var r=e.cache,u=t?t.apply(this,arguments):_+arguments[0];return ye.call(r,u)?r[u]:r[u]=n.apply(this,arguments)
}if(!_t(n))throw new ae;return e.cache={},e},Y.merge=function(n){var t=arguments,e=2;if(!bt(n))return n;if("number"!=typeof t[2]&&(e=t.length),3<e&&"function"==typeof t[e-2])var r=et(t[--e-1],t[e--],2);else 2<e&&"function"==typeof t[e-1]&&(r=t[--e]);for(var t=$e.call(arguments,1,e),u=-1,o=i(),a=i();++u<e;)ot(n,t[u],r,o,a);return c(o),c(a),n},Y.min=function(n,t,e){var u=1/0,o=u;if(!t&&Pe(n)){e=-1;for(var a=n.length;++e<a;){var i=n[e];i<o&&(o=i)}}else t=!t&&wt(n)?r:Y.createCallback(t,e,3),It(n,function(n,e,r){e=t(n,e,r),e<u&&(u=e,o=n)
});return o},Y.omit=function(n,t,e){var r=pt(),u=typeof t=="function",o={};if(u)t=Y.createCallback(t,e,3);else var a=rt(arguments,!0,!1,1);return d(n,function(n,e,i){(u?!t(n,e,i):0>r(a,e))&&(o[e]=n)}),o},Y.once=function(n){var t,e;if(!_t(n))throw new ae;return function(){return t?e:(t=!0,e=n.apply(this,arguments),n=null,e)}},Y.pairs=function(n){for(var t=-1,e=Ke(n),r=e.length,u=Xt(r);++t<r;){var o=e[t];u[t]=[o,n[o]]}return u},Y.partial=function(n){return ft(n,16,$e.call(arguments,1))},Y.partialRight=function(n){return ft(n,32,null,$e.call(arguments,1))
},Y.pick=function(n,t,e){var r={};if(typeof t!="function")for(var u=-1,o=rt(arguments,!0,!1,1),a=bt(n)?o.length:0;++u<a;){var i=o[u];i in n&&(r[i]=n[i])}else t=Y.createCallback(t,e,3),d(n,function(n,e,u){t(n,e,u)&&(r[e]=n)});return r},Y.pluck=Rt,Y.pull=function(n){for(var t=arguments,e=0,r=t.length,u=n?n.length:0;++e<r;)for(var o=-1,a=t[e];++o<u;)n[o]===a&&(we.call(n,o--,1),u--);return n},Y.range=function(n,t,e){n=+n||0,e=typeof e=="number"?e:+e||1,null==t&&(t=n,n=0);var r=-1;t=Re(0,pe((t-n)/(e||1)));
for(var u=Xt(t);++r<t;)u[r]=n,n+=e;return u},Y.reject=function(n,t,e){return t=Y.createCallback(t,e,3),Ct(n,function(n,e,r){return!t(n,e,r)})},Y.remove=function(n,t,e){var r=-1,u=n?n.length:0,o=[];for(t=Y.createCallback(t,e,3);++r<u;)e=n[r],t(e,r,n)&&(o.push(e),we.call(n,r--,1),u--);return o},Y.rest=qt,Y.shuffle=Bt,Y.sortBy=function(n,t,e){var r=-1,o=n?n.length:0,a=Xt(typeof o=="number"?o:0);for(t=Y.createCallback(t,e,3),It(n,function(n,e,u){var o=a[++r]=f();o.m=t(n,e,u),o.n=r,o.o=n}),o=a.length,a.sort(u);o--;)n=a[o],a[o]=n.o,p(n);
return a},Y.tap=function(n,t){return t(n),n},Y.throttle=function(n,t,e){var r=!0,u=!0;if(!_t(n))throw new ae;return false===e?r=!1:bt(e)&&(r="leading"in e?e.leading:r,u="trailing"in e?e.trailing:u),M.leading=r,M.maxWait=t,M.trailing=u,Ut(n,t,M)},Y.times=function(n,t,e){n=-1<(n=+n)?n:0;var r=-1,u=Xt(n);for(t=et(t,e,1);++r<n;)u[r]=t(r);return u},Y.toArray=function(n){return n&&typeof n.length=="number"?s(n):jt(n)},Y.transform=function(n,t,e,r){var u=Pe(n);return t=et(t,r,4),null==e&&(u?e=[]:(r=n&&n.constructor,e=lt(r&&r.prototype))),(u?It:y)(n,function(n,r,u){return t(e,n,r,u)
}),e},Y.union=function(){return at(rt(arguments,!0,!0))},Y.uniq=Pt,Y.values=jt,Y.where=Ct,Y.without=function(n){return Ft(n,$e.call(arguments,1))},Y.wrap=function(n,t){if(!_t(t))throw new ae;return function(){var e=[n];return _e.apply(e,arguments),t.apply(this,e)}},Y.zip=Kt,Y.zipObject=Lt,Y.collect=Et,Y.drop=qt,Y.each=It,Y.b=Nt,Y.extend=J,Y.methods=yt,Y.object=Lt,Y.select=Ct,Y.tail=qt,Y.unique=Pt,Y.unzip=Kt,Ht(Y),Y.clone=function(n,t,e,r){return typeof t!="boolean"&&null!=t&&(r=e,e=t,t=!1),tt(n,t,typeof e=="function"&&et(e,r,1))
},Y.cloneDeep=function(n,t,e){return tt(n,!0,typeof t=="function"&&et(t,e,1))},Y.contains=kt,Y.escape=function(n){return null==n?"":oe(n).replace(Ve,ct)},Y.every=xt,Y.find=Ot,Y.findIndex=function(n,t,e){var r=-1,u=n?n.length:0;for(t=Y.createCallback(t,e,3);++r<u;)if(t(n[r],r,n))return r;return-1},Y.findKey=function(n,t,e){var r;return t=Y.createCallback(t,e,3),y(n,function(n,e,u){return t(n,e,u)?(r=e,!1):void 0}),r},Y.findLast=function(n,t,e){var r;return t=Y.createCallback(t,e,3),Nt(n,function(n,e,u){return t(n,e,u)?(r=n,!1):void 0
}),r},Y.findLastIndex=function(n,t,e){var r=n?n.length:0;for(t=Y.createCallback(t,e,3);r--;)if(t(n[r],r,n))return r;return-1},Y.findLastKey=function(n,t,e){var r;return t=Y.createCallback(t,e,3),gt(n,function(n,e,u){return t(n,e,u)?(r=e,!1):void 0}),r},Y.has=function(n,t){return n?ye.call(n,t):!1},Y.identity=Gt,Y.indexOf=Wt,Y.isArguments=ht,Y.isArray=Pe,Y.isBoolean=function(n){return true===n||false===n||je.call(n)==F},Y.isDate=function(n){return n?typeof n=="object"&&je.call(n)==T:!1},Y.isElement=function(n){return n?1===n.nodeType:!1
},Y.isEmpty=function(n){var t=!0;if(!n)return t;var e=je.call(n),r=n.length;return e==$||e==K||e==B||e==z&&typeof r=="number"&&_t(n.splice)?!r:(y(n,function(){return t=!1}),t)},Y.isEqual=function(n,t,e,r){return ut(n,t,typeof e=="function"&&et(e,r,2))},Y.isFinite=function(n){return Ne(n)&&!Ee(parseFloat(n))},Y.isFunction=_t,Y.isNaN=function(n){return dt(n)&&n!=+n},Y.isNull=function(n){return null===n},Y.isNumber=dt,Y.isObject=bt,Y.isPlainObject=g,Y.isRegExp=function(n){return n?typeof n=="object"&&je.call(n)==P:!1
},Y.isString=wt,Y.isUndefined=function(n){return typeof n=="undefined"},Y.lastIndexOf=function(n,t,e){var r=n?n.length:0;for(typeof e=="number"&&(r=(0>e?Re(0,r+e):Ae(e,r-1))+1);r--;)if(n[r]===t)return r;return-1},Y.mixin=Ht,Y.noConflict=function(){return e._=le,this},Y.parseInt=Qe,Y.random=Jt,Y.reduce=At,Y.reduceRight=Dt,Y.result=function(n,t){if(n){var e=n[t];return _t(e)?n[t]():e}},Y.runInContext=v,Y.size=function(n){var t=n?n.length:0;return typeof t=="number"?t:Ke(n).length},Y.some=$t,Y.sortedIndex=zt,Y.template=function(n,t,e){var r=Y.templateSettings;
n||(n=""),e=G({},e,r);var u,o=G({},e.imports,r.imports),r=Ke(o),o=jt(o),i=0,f=e.interpolate||S,l="__p+='",f=ue((e.escape||S).source+"|"+f.source+"|"+(f===N?C:S).source+"|"+(e.evaluate||S).source+"|$","g");n.replace(f,function(t,e,r,o,f,c){return r||(r=o),l+=n.slice(i,c).replace(A,a),e&&(l+="'+__e("+e+")+'"),f&&(u=!0,l+="';"+f+";__p+='"),r&&(l+="'+((__t=("+r+"))==null?'':__t)+'"),i=c+t.length,t}),l+="';\n",f=e=e.variable,f||(e="obj",l="with("+e+"){"+l+"}"),l=(u?l.replace(j,""):l).replace(k,"$1").replace(x,"$1;"),l="function("+e+"){"+(f?"":e+"||("+e+"={});")+"var __t,__p='',__e=_.escape"+(u?",__j=Array.prototype.join;function print(){__p+=__j.call(arguments,'')}":";")+l+"return __p}";
try{var c=ne(r,"return "+l).apply(h,o)}catch(p){throw p.source=l,p}return t?c(t):(c.source=l,c)},Y.unescape=function(n){return null==n?"":oe(n).replace(Ue,vt)},Y.uniqueId=function(n){var t=++m;return oe(null==n?"":n)+t},Y.all=xt,Y.any=$t,Y.detect=Ot,Y.findWhere=Ot,Y.foldl=At,Y.foldr=Dt,Y.include=kt,Y.inject=At,y(Y,function(n,t){Y.prototype[t]||(Y.prototype[t]=function(){var t=[this.__wrapped__],e=this.__chain__;return _e.apply(t,arguments),t=n.apply(Y,t),e?new nt(t,e):t})}),Y.first=Tt,Y.last=function(n,t,e){var r=0,u=n?n.length:0;
if(typeof t!="number"&&null!=t){var o=u;for(t=Y.createCallback(t,e,3);o--&&t(n[o],o,n);)r++}else if(r=t,null==r||e)return n?n[u-1]:h;return s(n,Re(0,u-r))},Y.sample=function(n,t,e){var r=n?n.length:0;return typeof r!="number"&&(n=jt(n)),null==t||e?n?n[Jt(r-1)]:h:(n=Bt(n),n.length=Ae(Re(0,t),n.length),n)},Y.take=Tt,Y.head=Tt,y(Y,function(n,t){var e="sample"!==t;Y.prototype[t]||(Y.prototype[t]=function(t,r){var u=this.__chain__,o=n(this.__wrapped__,t,r);return u||null!=t&&(!r||e&&typeof t=="function")?new nt(o,u):o
})}),Y.VERSION="2.2.1",Y.prototype.chain=function(){return this.__chain__=!0,this},Y.prototype.toString=function(){return oe(this.__wrapped__)},Y.prototype.value=Qt,Y.prototype.valueOf=Qt,It(["join","pop","shift"],function(n){var t=ie[n];Y.prototype[n]=function(){var n=this.__chain__,e=t.apply(this.__wrapped__,arguments);return n?new nt(e,n):e}}),It(["push","reverse","sort","unshift"],function(n){var t=ie[n];Y.prototype[n]=function(){return t.apply(this.__wrapped__,arguments),this}}),It(["concat","slice","splice"],function(n){var t=ie[n];
Y.prototype[n]=function(){return new nt(t.apply(this.__wrapped__,arguments),this.__chain__)}}),Y}var h,g=[],y=[],m=0,_=+new Date+"",b=75,d=40,w=" \t\x0B\f\xa0\ufeff\n\r\u2028\u2029\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000",j=/\b__p\+='';/g,k=/\b(__p\+=)''\+/g,x=/(__e\(.*?\)|\b__t\))\+'';/g,C=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,O=/\w*$/,I=/^function[ \n\r\t]+\w/,N=/<%=([\s\S]+?)%>/g,E=RegExp("^["+w+"]*0+(?=.$)"),S=/($^)/,R=/\bthis\b/,A=/['\n\r\t\u2028\u2029\\]/g,D="Array Boolean Date Function Math Number Object RegExp String _ attachEvent clearTimeout isFinite isNaN parseInt setImmediate setTimeout".split(" "),B="[object Arguments]",$="[object Array]",F="[object Boolean]",T="[object Date]",W="[object Function]",q="[object Number]",z="[object Object]",P="[object RegExp]",K="[object String]",L={};
L[W]=!1,L[B]=L[$]=L[F]=L[T]=L[q]=L[z]=L[P]=L[K]=!0;var M={leading:!1,maxWait:0,trailing:!1},U={configurable:!1,enumerable:!1,value:null,writable:!1},V={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},G={"\\":"\\","'":"'","\n":"n","\r":"r","\t":"t","\u2028":"u2028","\u2029":"u2029"},H=V[typeof window]&&window||this,J=V[typeof exports]&&exports&&!exports.nodeType&&exports,Q=V[typeof module]&&module&&!module.nodeType&&module,X=Q&&Q.exports===J&&J,Y=V[typeof global]&&global;!Y||Y.global!==Y&&Y.window!==Y||(H=Y);
var Z=v();typeof define=="function"&&typeof define.amd=="object"&&define.amd?(H._=Z, define(function(){return Z})):J&&Q?X?(Q.exports=Z)._=Z:J._=Z:H._=Z}).call(this);
////////////////////////////////////////
// SRC End --> libs/lodash/lodash-2.2.1.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/infra/lang_ext.js
////////////////////////////////////////
(function() {

    // The following code (inheritance) is taken from the book - Secrets of the JavaScript Ninja (John Resig).
    var initializing = false;

    // Determine if functions can be serialized
    var fnTest = /xyz/.test(function() { xyz; }) ? /\b_super\b/ : /.*/;

    // Create a new Class that inherits from this class
    Object.subClass = function(prop) {
        var _super = this.prototype;

        // Instantiate a base class (but only create the instance, don't run the init constructor)
        initializing = true;
        var proto = new this();
        initializing = false;

        var name;
        // Copy the properties over onto the new prototype
        for (name in prop) {
            // Check if we're overwriting an existing function
            var isAnExistingFunction =
                typeof prop[name] == "function" && typeof _super[name] == "function" && fnTest.test(prop[name]);

            proto[name] = isAnExistingFunction ?
                (function(name, fn) {
                    return function() {
                        var tmp = this._super;

                        // Add a new ._super() method that is the same method but on the super-class.
                        this._super = _super[name];

                        // The method only need to be bound temporarily, so we remove it when we're done executing.
                        var ret = fn.apply(this, arguments);
                        this._super = tmp;

                        return ret;
                    };
                })(name, prop[name]) :
                prop[name];
        }

        // The dummy class constructor
        function Class() {
            // All construction is actually done in the init method
            if (!initializing && this.ctor) this.ctor.apply(this, arguments);
        }

        // Handle static members
        for (name in this){
        	if (this.hasOwnProperty(name) && typeof(this[name]) != 'function')
                Class[name] = this[name];
        }

        // Populate our constructed prototype object
        Class.prototype = proto;

        // Enforce the constructor to be what we expect
        Class.constructor = Class;

        // And make this class extensible
        Class.subClass = arguments.callee;

        // Add behavior ability
        Class.addBehavior = function (behaviorAbstractClass, behaviorOverrides) {
            behaviorOverrides = behaviorOverrides || {};
            if (behaviorAbstractClass) {
                override(proto, behaviorOverrides, new behaviorAbstractClass());
            } else {
                throw 'behaviorAbstractClass must be a vaild behavior class';
            }
        };

        return Class;
    };
})();

/**
 * 1. This should be elsewhere.
 * 2. $.browser is going away in future versions of jQuery.
 */
jQuery.extend({
    xmlToString: function(xmlObj) {
        if (this.browser.msie) {
            return xmlObj.xml || xmlObj.outerHTML;
        } else {
            return (new XMLSerializer()).serializeToString(xmlObj);
        }
    }
});


////////////////////////////////////////
// SRC End --> t2k/infra/lang_ext.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/infra/namespaces.js
////////////////////////////////////////
var t2k = {
	host:{},
    compile: {
		results: {}
	},
    compilePlay:{
        results: {}
    },
    behavior: {},
    component: {
    	dialog: {},
    	answer: {},
        buttons: {},
        container: {},
        imageViewer: {},
        keyboard: {},
        mediaPlayer: {},
        select: {},
        textViewer: {},
        text: {},
        textarea: {},
        subAnswer: {},
        subQuestion: {},
        group: {},
        sharedarea: {},
        balloon: {},
        cloze: {},
        bank: {},
        mathField: {},
        tre: {},
        definition: {},
        mtq : {},
        options : {},
        table : {},
        thirdParty : {},
        modal:{},
        applet:{},
	    help:{}
    },
    controls: {},
    core: {
        layout: {}
    },
    io: {},
    model: {},
    player: {
        sequence: {},
        task: {
        	progress: {},
	        controls: {}
        }
    },
    util: {
        managers: {}
    }
};

////////////////////////////////////////
// SRC End --> t2k/infra/namespaces.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/host/SequenceFacade.js
////////////////////////////////////////
( function() {

	t2k.host.SequenceFacade = Object.subClass( {

	//////////////////////////////////////////////////////////////
	// public scope - start
	//////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////
		// class members - start
		//////////////////////////////////////////////////////////

		// facade config
		settings: {
			// rebuild (new+state) player instead of recycle (state only) player.
			rebuildPlayerOnState: true,
			// set state from config or by setState method.
			injectionUseConfigState: false
		},
		
		crossApiConfig: {},
		
		// player future reference
		player: null,

		// host's callback to call when player done
		hostCallback: null,

		// flag to determine when host callback is needed
		callHostCallback: true,

		// flag to determine
		wasStateSet: false,
		
		// collection of functions to call on success
		successStack: [],
		
		//////////////////////////////////////////////////////////
		// class members - end
		//////////////////////////////////////////////////////////


		//////////////////////////////////////////////////////////
		// class functions - start
		//////////////////////////////////////////////////////////
		ctor: function( config ) {

			this.config = copy( {}, config ) ;

		},

		setPlayer: function( config, callback ) {
			
			var mergedConfig = $.extend( {}, config.initData, this.crossApiConfig )
			
			this.setCrossApiConfig( mergedConfig ) ;

			this.player = new t2k.player.SequencePlayer( config, callback );

		},

		resetPlayer: function() {

			Perf.reset() ;
			dndManager.reset();
			Mustache.clearCache();
			jQuery.cache = {};
			jQuery.fragments = {};

			if( this.player ) {
				this.player.destroy() ;
				delete this.player ;
			}

		},

		getPlayerID: function() {
			return this.player.cfg.data.id ;
		},
		
		//////////////////////////////////////////////////////////
		// INTERNAL - start
		//////////////////////////////////////////////////////////
		
		reload: function( overrideOptions, rejectCallback ) {
			
			if( !this.playParams.config.overrideOptions ) {
				this.playParams.config.overrideOptions = {} ;
			}
			
			var thi$ = this ;
			
			if( overrideOptions.reloadInitiator != this.playParams.config.overrideOptions.reloadInitiator ) {
				
				function reloadSequence() {
					
					$.extend( thi$.playParams.config.overrideOptions, overrideOptions ) ;
					
					thi$.playSequence( thi$.playParams.config, thi$.playParams.success, thi$.playParams.error, true ) ;
					
				} ;
				
				this.successStack.push( reloadSequence ) ;
				
			} else {
				
				rejectCallback() ;
				
			}
			
		},
		
		//////////////////////////////////////////////////////////
		// INTERNAL - end
		//////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////
		// incoming - start
		//////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////
		// Host API - start
		//////////////////////////////////////////////////////////

		api: function( config ) {

//			console.log( config ) ;
//			debugger;
			
			var thi$ = this ;
			
			var handler = this[ config.action ] ;
			if( handler ) {
				
				this.setCrossApiConfig( config.data ) ;
				
				function successWrapper( successData ) {
					while( thi$.successStack.length > 0 ) {
						var callTo = thi$.successStack[0] ;
						thi$.successStack.shift() ;
						callTo() ;
					}
					config.success( successData ) ;
				} ;
				
				handler.call(this, config.data, successWrapper, config.error ) ;
				
			} else {
				if( config.error ) {
					config.error() ;
				} else {
					throw new Error( "Unhandled api action --> " + config.action ) ;
				}
			}

		},

		setCrossApiConfig: function( data ) {
			
			if ( data ){
				
				if( typeof data.saveState != "undefined" ) {
					var saveState = !!data.saveState ;
					this.crossApiConfig.saveState = saveState ;
					ENV.saveState = saveState ;
					console.log( "[DL][API][Flag override] --> saveState --> " + saveState ) ;
				}
				
				if ( data && typeof data.gradualExposure != "undefined" ) {
					var gradualExposure = !!data.gradualExposure ;
					this.crossApiConfig.gradualExposure = gradualExposure ;
					ENV.overrideGradualExposure = gradualExposure ;
					console.log( "[DL][API][Flag override] --> gradualExposure --> " + gradualExposure ) ;
				}
				
				if ( data && typeof data.viewMode != "undefined" ) {
					this.crossApiConfig.viewMode = data.viewMode ;
					console.log( "[DL][API][Flag override] --> viewMode --> " + data.viewMode ) ;
				}
				
				if ( data && typeof data.role != "undefined" ) {
					this.crossApiConfig.role = data.role ;
					console.log( "[DL][API][Flag override] --> role --> " + data.role ) ;
				}
				
			}
		},

		//////////////////////////////////////////////////////////
		// Host API - end
		//////////////////////////////////////////////////////////

		playSequence: function( config, success, error, ignoreValidation ) {

			var thi$ = this ;
			
			this.playParams = {
					config: config,
					success: success,
					error: error
			} ;
			
			var playSeqFunc = function() {

				var successData = {
						mainElement: $("body")[0]
				} ;

				var successWrapper = function(){
					setTimeout( function() {
						success( successData )
					}, 0 ) ;
				} ;

				var newPlayerCallback = successWrapper ;

				var configAddition = config ; //{ data: config.data } ;

				thi$.resetPlayer() ;

				if( thi$.settings.injectionUseConfigState ) {

					configAddition.state = config.state ;

				} else {

					newPlayerCallback  = function(){

						thi$.player.setState( config.state, successWrapper ) ;

					} ;

				}

				var newConfig = copy( configAddition, copy( {}, thi$.config ) ) ;

				var newPlayerCallbackWrapper = function() {
					setTimeout( function() {
						newPlayerCallback() ;
					}, 0 ) ;
				} ;

				thi$.setPlayer( newConfig, newPlayerCallbackWrapper );

			}
			
			if( !ignoreValidation ) {
				////////////////////////////////////////////////////////
				// check play config validity
				////////////////////////////////////////////////////////
				var isDataValid = validatePlayData( config, error ) ;
				
				if( !isDataValid ) {
					
					var emptyDataString = getEmptySequenceData() ;
					var mustachedString = Mustache.render( emptyDataString, config )
					config.data = $( mustachedString )[0] ;
					
				} else if (typeof config.data == "string") {
					
					config.data = $(config.data)[0] ;
					
				} else if( typeof config.data[config.id].convertedData == "string" ) {
					
					config.data = $(config.data[config.id].convertedData)[0] ;
					
				}
			}
			
			playSeqFunc() ;
			
		},

		getState: function( config, success, error ) {
			this.player.getState( success ) ;
		},

		focusOnTask: function( config, success, error ) {
			var taskCid = config.taskCid ;
			!!this.player && this.player.focusOnTask( taskCid, true, success ) ;
		},

		overrideScores: function( config, success, error ) {
			if(this.player){
				this.player.setTasksScores( config ) ;
				success() ;
			}else{
				console.log("------> no palyer object");
			}
		},

		suspend: function ( config, success, error ) {
			this.player.suspend();
			success() ;
		},

		resume: function ( config, success, error ) {
			this.player.resume() ;
			success() ;
		},

		setVolume: function (  config, success, error  ) {
			this.player.setVolume( config );
			success() ;
		},

		terminateSequence: function ( config, success, error ) {

			var self = this ;

			var successWrapper = function(){

				self.resetPlayer() ;

				success() ;

			} ;

			if( this.player ) {
				this.player.suspend();
				if( ENV.saveState ) {
					var sendLogs = false ;
					this.player.fireState( successWrapper, error, sendLogs ) ;
				} else {
					successWrapper() ;
				}
			} else {
				success() ;
			}

		},

		terminate: function ( config, success, error ) {
			this.resetPlayer() ;
			success() ;
		},

		//////////////////////////////////////////////////////////
		// incoming - end
		//////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////
		// outgoing - start
		//////////////////////////////////////////////////////////
		
		onUIEvent: function( eventString ) {
			
			var playerID = this.getPlayerID() ;
			
			ENV.externalHost.api( {
				action: 'onUIEvent',
				id: playerID,
				data: eventString,
				success: function() {},
				error: function() { throw new Error("onUIEvent error callback") ; }
			} ) ;
		},
		
		taskChanged: function( taskCid, changedTo ) {
			ENV.externalHost.api( {
				action: 'taskChanged',
				id: this.getPlayerID(),
				data: {
					taskCid: taskCid,
					status: changedTo
				},
				success: function() {},
				error: function() { throw new Error("taskChanged error callback") ; }
			} ) ;
		},

		playMovie: function( src ) {
			ENV.externalHost.api( {
				action: 'playMovie',
				id: this.getPlayerID(),
				data: { src: src },
				success: function() {},
				error: function() { throw new Error("playMovie error callback") ; }
			} ) ;
		},

		playAudio: function( src, stopHandler, context ) {
			ENV.externalHost.api( {
				action: 'playAudio',
				id: this.getPlayerID(),
				data: {
					src 		: src,
					stopHandler	: stopHandler,
					context		: context
				},
				success: function() {},
				error: function() { throw new Error("playAudio error callback") ; }
			} ) ;
		},

		stopAudio: function() {
			ENV.externalHost.api( {
				action: 'stopAudio',
				id: this.getPlayerID(),
				data: {},
				success: function() {},
				error: function() { throw new Error("stopAudio error callback") ; }
			} ) ;
		},

		onSwipe: function( swipeDirection ) {
			ENV.externalHost.api( {
				action: 'onSwipe',
				id: this.getPlayerID(),
				data: { direction: swipeDirection },
				success: function() {},
				error: function() { throw new Error("onSwipe error callback") ; }
			} ) ;
		},

		onDone: function() {
			ENV.externalHost.api({
				action:'onEndSequence',
				id:this.getPlayerID(),
				data:null,
				success: function() {},
				error: function() { throw new Error("onEndSequence error callback") ; }
			});
		},

		saveState: function( state, logs, scores, success, error ) {

			var errorCallback = error || function() { throw new Error("saveState error callback") ; }

			if( ENV.saveState ) {

				ENV.externalHost.api( {
					action: 'saveState',
					id: this.getPlayerID(),
					data: {
						state: state,
						scores: scores,
						eventLog: logs
					},
					success: success || function() {},
					error: errorCallback
				} ) ;

			} else {

				errorCallback() ;

			}
		}

		//////////////////////////////////////////////////////////
		// outgoing - end
		//////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////
		// Assessment - start
		//////////////////////////////////////////////////////////
//		fetchResult: function () {
//			 return this.player.fetchResult() ;
//		},
//
//		updateRubrics: function ( staticDataString ) {
//			return this.player.updateRubrics( staticDataString ) ;
//		},
//
//		getScreenByRubric: function ( rubricId ) {
//			return this.player.getScreenByRubric( rubricId ) ;
//		},
//
//		setAssessmentStateInput: function ( atomsList ) {
//			return this.player.setAssessmentStateInput( atomsList ) ;
//		}
		//////////////////////////////////////////////////////////
		// Assessment - end
		//////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////
		// class functions - end
		//////////////////////////////////////////////////////////


	//////////////////////////////////////////////////////////////
	// public scope - end
	//////////////////////////////////////////////////////////////
	});

	//////////////////////////////////////////////////////////////
	// private scope - start
	//////////////////////////////////////////////////////////////
	
	function validatePlayData( config, error ) {
		
		var isDataValid = true ;
		var errMsgs = [] ;
		
		if( !config.id ){
			
			errMsgs.push( "missing \"id\" property" ) ;
			
		} 
		
		if( !config.data ){
			
			errMsgs.push( "missing \"data\" property" ) ;
			
		} else if( config.id && typeof config.data != "string" ) {
			
			if( !config.data[config.id] ) {
				
				errMsgs.push( "id not found in data content or missing sequence data in blob" ) ;
				
			} else {
				
				var converted = config.data[config.id].convertedData ;
				
				if( !converted || converted == "null" ) {
					
					errMsgs.push( "missing convertedData property in sequence blob" ) ;
				
				}
			}
			
		}
		
		if( errMsgs.length > 0 ) {
			var msgsStr = "" ;
			isDataValid = false ;
			for( var i = 0 ; i < errMsgs.length ; i++ ) {
				msgsStr += "\n" + errMsgs[ i ] ;
			}
			error( "playSequence data is invalid:" + msgsStr ) ;
		}
		
		return isDataValid ;
	}
	
	function getEmptySequenceData() {
		var data =
			"<sequence type='simple' id='{{id}}'>\
				<task exposureid='1' type='statement'>\
					<mode>nerrative</mode>\
					<question>\
						<textviewer style='texteditor'>\
							<p>\
								<span class='normal'>\
									There isn't any content in this sequence. You can click Next to continue to the following sequence.\
								</span>\
							</p>\
						</textviewer>\
					</question>\
				</task>\
			</sequence>" ;

		return data ;
	}

	//////////////////////////////////////////////////////////////
	// private scope - end
	//////////////////////////////////////////////////////////////


} )() ;

////////////////////////////////////////
// SRC End --> t2k/host/SequenceFacade.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/ObjectUtils.js
////////////////////////////////////////
(function() {

    /** A counter for auto-generated object ids. */
    var nextGenId = 0;

    /**
     * Class: t2k.util.ObjectUtils
     * Contains string manipulation/formatting/etc. utilities
     */
    t2k.util.ObjectUtils = {
        /**
         * Method: copy
         * Copy all members of a source object into a target object except for the already existing once.
         * Default values can be guaranteed by providing a third object containing these defaults.
         *
         * Params:
         *  target - {Object} The object into which the copy is made.
         *  source - {Object} The origin of the data to copy.
         *  defaults - {Object} Contains
         *
         * Returns:
         * {Object} the given target object.
         */
        copy: function copy(target, source, defaults) {
            // Apply from source to target only if the source doesn't already has a member with the same name.
            if (target && source && typeof source == 'object')
                for (var i in source) if (!!!target[i]) target[i] = source[i];
            // Apply the defaults.
            if (defaults) copy(target, defaults);
            return target;
        }, // End of copy
        
        /**
         * Method: merge
         * Copy all members of a source object into a target object except for the already existing once.
         * the existing members merged.
         * Default values can be guaranteed by providing a third object containing these defaults.
         *
         * Params:
         *  target - {Object} The object into which the copy is made.
         *  source - {Object} The origin of the data to copy.
         *  defaults - {Object} Contains
         *
         * Returns:
         * {Object} the given target object.
         */
        merge: function merge(target, source, defaults) {
        	 // Apply from source to target only if the source doesn't already has a member with the same name.
            if (target && source && typeof source == 'object'){
            	for (var i in source) if (!!!target[i]) target[i] = source[i];
            	if (source.events && target.events)
            		this.copy(target.events, source.events);
            }
            	
            // Apply the defaults.
            if (defaults) merge(target, defaults);
            return target;
        }, // End of copy

        /**
         * Method: override
         * Copy all members of a source object into a target object overriding existing members with the same name.
         * Default values can be guaranteed by providing a third object containing these defaults.
         *
         * Params:
         *  target - {Object} The object into which the copy is made.
         *  source - {Object} The origin of the data to copy.
         *  defaults - {Object} Contains
         *
         * Returns:
         *  {Object} the given target object.
         */
        override: function override(target, source, defaults) {
            // First apply the defaults.
            if (defaults) override(target, defaults);
            // Apply from source to target.
            if (target && source && typeof source == 'object')
                for (var i in source) target[i] = source[i];
            return target;
        }, // End of override

        /**
         * Method: genId
         * Generate an id for dom elements.
         *
         * Returns:
         *  {String} an auto-generated id.
         */
        genId: function() {
            return 'gen_id_' + nextGenId++;
        } // End of genId

    }; // End of t2k.util.ObjectUtils

    
    /**
     * Method: String.format
     * .Net style string format.
     * Example: "{0} will always be {0}, and {1} is his {2}".format("bart", "homer", "dad")
     *    will result in "bart will always be bart, and homer is his dad"
     *
     * Params:
     *  replacements in the string
     *
     * Returns:
     *  {String} Formatted string.
     */
    String.prototype.format = function() {
      var args = arguments;
      return this.replace(/{(\d+)}/g, function(match, number) {
        return typeof args[number] != 'undefined'
          ? args[number]
          : match
        ;
      });
    };
    /**
     * Method: capitalize
     * Capitalize the first letter of string
     * Example: "hello World"
     *    will result in "Hello World"
     *
     * Params:
     *  replacements in the string
     *
     * Returns:
     *  {String} Formatted string.
     */
    String.prototype.capitalize = function() {
        return this.charAt(0).toUpperCase() + this.slice(1);
    };
    
    /**
     * Method: String.px2int
     * Example: "18px".px2int()  ||  jQuery(element).css('font-size').px2int()
     *    will result 18 {int}
     *
     * Params:
     *  replacements in the string
     *
     * Returns:
     *  {int}
     */
    String.prototype.px2int = function() {
    	return parseInt(this.replace('px','')) || 0;
     };
    
     /**
      * Method: String.em2int
      * Example: "2em".px2int()  ||  jQuery(element).css('font-size').px2int()
      *    will result 2 {int}
      *
      * Params:
      *  replacements in the string
      *
      * Returns:
      *  {int}
      */
     String.prototype.em2int = function() {
    	 return parseFloat(this.replace('em','')) || 0;
     };
     
    /**
     * Method: splice
     * Example: "foo baz".splice( 4, 0, "bar " );
     *    will result in "foo bar baz"
     *
     * @param idx - index 
     * @param rem
     * @param s   - string
     * @returns {String} spliced string.
     */
    String.prototype.splice = function( idx, rem, s ) {
        return (this.slice(0,idx) + s + this.slice(idx + Math.abs(rem)));
    };

    // Add ability to select jquery using regex
    // http://james.padolsey.com/javascript/regex-selector-for-jquery/
    jQuery.expr[':'].regex = function(elem, index, match) {
        var matchParams = match[3].split(','),
            validLabels = /^(data|css):/,
            attr = {
                method: matchParams[0].match(validLabels) ?
                            matchParams[0].split(':')[0] : 'attr',
                property: matchParams.shift().replace(validLabels,'')
            },
            regexFlags = 'ig',
            regex = new RegExp(matchParams.join('').replace(/^\s+|\s+$/g,''), regexFlags);
        return regex.test(jQuery(elem)[attr.method](attr.property));
    }

})();

var copy = jQuery.proxy(t2k.util.ObjectUtils.copy, t2k.util.ObjectUtils);
var override = jQuery.proxy(t2k.util.ObjectUtils.override, t2k.util.ObjectUtils);
var merge = jQuery.proxy(t2k.util.ObjectUtils.merge, t2k.util.ObjectUtils);
var genId = jQuery.proxy(t2k.util.ObjectUtils.genId, t2k.util.ObjectUtils);

////////////////////////////////////////
// SRC End --> t2k/util/ObjectUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/Environment.js
////////////////////////////////////////
(function() {

	t2k.util.Environment = {
			saveState: false,
			contentDirection: 'ltr',
			interfaceDirection: 'ltr',
			assetBasePath: '',
			taskIndexType: 'none',
			host: null,
			locale: 'en_US',
			language: 'en',
			debug: {},
			behaviors: getBehavior()
		// add user data and modes here
		};
	
	function getBehavior() {
		var appstr = navigator.appVersion.toLowerCase(),
            version = '';
		
		console.log( "[DL DEVICE] --> " + appstr ) ;
		
		var bhvName = 'Default' ;
//		var bhvName = 'Android' ;
		
		// currently handling default and Android
		// feel welcome to add more OS and/or browser types
		if( appstr.indexOf( 'android' ) != -1 ) {
			
			bhvName = 'Android';

            /** We treat Chrome for Android differently from the stock Android browser */
            if (appstr.indexOf('chrome') != -1 && appstr.indexOf('safari') != -1) {
                version = 'Chrome'
            }

            else if( appstr.indexOf( 'android 4.2' ) != -1 ) {
				version = '4.2.x';
			} else if( appstr.indexOf( 'android 4.1' ) != -1 ) {
				version = '4.1.x';
			} else if( appstr.indexOf( 'android 4.0' ) != -1 ) {
				version = '4.0.x';
			} else if( appstr.indexOf( 'android 3.2' ) != -1 ) {
				version = '3.2';
			} else if( appstr.indexOf( 'android 3.1' ) != -1 ) {
				version = '3.1';
			}
			bhvName = bhvName + version;
			
		} else if( appstr.indexOf( 'ipad' ) != -1 ) {
			bhvName = 'iPad';

		} else if (appstr.indexOf( 'msie' ) != -1){

            bhvName = 'IE';
            if( appstr.indexOf( 'msie 9.' ) != -1 ) {
                version = '9';
            } else if( appstr.indexOf( 'msie 10.' ) != -1 ) {
                version = '10';
            }
            bhvName = bhvName + version;
        }
		
//		alert(bhvName);
//		
//		console.log( "[DEV] using behaviour for --> %s", bhvName ) ;
		
		var preparedBhv = prepareBhv( bhvName ) ;
		
		console.log( "device specific behavior --> " + bhvName + " --> " + JSON.stringify( preparedBhv, null, "\t" ) ) ;
		
		return preparedBhv ;
	}
	
	function prepareBhv( type ) {
		var bhvs = getBehaviors() ;
		var bhv = bhvs[ type ] ? copy( {}, bhvs[ type ] ) : undefined ;
		var merged = {} ;
		
		if( bhv ) {
			var inheritList = bhv.inherit ;
			if( inheritList ) {
				var len = inheritList.length ;
				for( var i = 0 ; i < len ; i++ ) {
					var inheritFrom = inheritList[ i ] ;					
					merged = override( merged, bhvs[ inheritFrom ] ) ;
				}
			}
		}
		
		merged = override( merged, bhv ) ;
		
		return merged ;
	}
	
	function getBehaviors() {
		return {
			
			'Default': {
				textEditorClass: 't2k.component.textarea.TextEditor',
				extraCSS: 'css/extras/style.css',
				touch: false,
				animate: true,
				allowBlowup: false,
				scrollControl : false,
				balloonButtonAnimateDuration : 400,
				fixBalloonTop : false,
                setBalloonView : false,
                disableAutoNarrationOfInstraction : false,
                bindButtonTouchStartAndEnd:false,
                textViewerMinReadable : '18',
                textViewerFontSizeInitializeFactor : '1',
                setMediaPlayerTouchBhv : false,
                setTouchEvents : false,
                dragAndDropBehaviorTablets : false,
                mediaPlayerShowEvent:  'mousemove',
                setSwipeEvents: false,
                allowMediaPlayerFullScreen: true,
                useMathfieldKBHack: false,
                use$Ajax: true,
                fireUIEvents: false
			},
			
			'Tablet': {
				inherit: [ 'Default' ],
//				textEditorClass: 't2k.component.textarea.MiniTextEditor',
				isTablet: true,
				touch: true,
				animate: false,
                allowBlowup: false,
				scrollControl : false,
				balloonButtonAnimateDuration : 0,
				fixBalloonTop : true,
                setBalloonView : true,
                disableAutoNarrationOfInstraction : true,
                bindButtonTouchStartAndEnd:true,
                textViewerMinReadable : '19',
                textViewerFontSizeInitializeFactor : '1',
                setMediaPlayerTouchBhv : true,
                setTouchEvents : true,
                dragAndDropBehaviorTablets : 'touchAndDrop',
                mediaPlayerShowEvent:  'touchstart',
                setSwipeEvents: false,
                allowMediaPlayerFullScreen: false,
                clickOnTask_makeTaskEnabled : false,
				overrideMathNativeKeyboard: true,
				useMathfieldKBHack: true
			},
			
			'iPad': {
				inherit: [ 'Default', 'Tablet' ],
				extraCSS: 'css/extras/tablet.css',
				overrideMathNativeKeyboard: true,
                fireUIEvents: true,
				isIpad: true,
				addKeyboardDelay: true
			},

            'IE9': {
                inherit: [ 'Default' ],
                extraCSS: [ 'css/extras/style.css', 'css/extras/ie9.css' ],
                isIE: true
            },

            'IE10': {
                inherit: [ 'Default', 'IE9' ]
            },

			'Android': {
				inherit: [ 'Default', 'Tablet' ],
				extraCSS: [ 'css/extras/tablet.css', 'css/extras/android.css', 'css/extras/android-native.css' ],
                fixBalloonTop: true,
                scrollControl : false,
				overrideMathNativeKeyboard: true,
				isAndroid: true,
                use$Ajax: false
			},

            'AndroidChrome': {
                inherit: [ 'Default', 'Tablet','Android'],
                extraCSS: [ 'css/extras/tablet.css', 'css/extras/android.css'],
                // This is questionable (kind of works, but not really usable).
                // textEditorClass: 't2k.component.textarea.TextEditor',
                scrollControl : false
            },

            'Android4.2.x': {
                inherit: [ 'Default', 'Tablet', 'Android' ]
            },

            'Android4.1.x': {
                inherit: [ 'Default', 'Tablet', 'Android' ]
            },

            'Android4.0.x': {
                inherit: [ 'Default', 'Tablet', 'Android' ]
            },

            'Android3.2': {
				inherit: [ 'Default', 'Tablet', 'Android' ]
			},
			
			'Android3.1': {
				inherit: [ 'Default', 'Tablet', 'Android' ]
			}
			
		} ;
	}
	
})() ;

//Shorthand.
var ENV = t2k.util.Environment;

////////////////////////////////////////
// SRC End --> t2k/util/Environment.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/LocaleUtil.js
////////////////////////////////////////
(function(){
	
	t2k.util.LocaleUtil = function(){
	};
	
	//////////////////////////////////////////////////////////////
	// private scope
	//////////////////////////////////////////////////////////////
	var defaultLocale = 'en_US' ;
	//////////////////////////////////////////////////////////////
	
	t2k.util.LocaleUtil.prototype = {
			
			loadFiles: function( callback ) {
				
				var thi$ = this ;
				
				this.loadLangFile( function() {
					
					thi$.loadStyleFile( callback ) ;
					
				} ) ;
				
			},
			
			loadLangFile : function( callback ) {
				
				var langPathTemplate = ENV.playerBasePath + '/assets/languages/lang_{{locale}}.js' ;
				
				function getLocaleFile( locale, success, fail ) {
					
					var url = ENV.playerBasePath + '/assets/languages/lang_'+ locale +'.js' ;
					
					console.info( "[DL][Locale][Language] --> loading file: " + url );
					
					Compat.getScript( url, {}, success, fail ) ;
					
				}
				
				console.info( "[DL][Locale][Language] --> load file for defined locale" );
				
				getLocaleFile( ENV.locale, function() {
					
					console.info( "[DL][Locale][Language] --> defined language loaded successfully" );
					
					callback.call() ;
					
				}, function () {
					
					console.info( "[DL][Locale][Language] --> defined file loading failed" );
					console.info( "[DL][Locale][Language] --> load file for default locale" );
					
					getLocaleFile( defaultLocale, function() {
						
						console.info( "[DL][Locale][Language] --> default language loaded successfully" );
						callback.call() ;
						
					}, function () {
						
						//call error callback
						
						console.error( "[DL][Locale][Language] --> load default locale file failed" );
						
					} ) ;
					
				} ) ;
				
			},

			getStyleFilePath: function() {
				return 'css/locale/style_' + ENV.locale + '.css' ;
			},

			getAccentsMap: function(){
				return this.accentsMap[ENV.locale];
			},

			accentsMap : {
				"fr_FR"	: [
					{
						accent: ["à", "â", "ä"],
						replacement: "a"
					},
					{
						accent: ["À", "Â", "Ä"],
						replacement: "A"
					},
					{
						accent: ["ë", "ê", "è", "é"],
						replacement: "e"
					},
					{
						accent: ["É", "È", "Ê", "Ë"],
						replacement: "E"
					},
					{
						accent: ["æ"],
						replacement: "ae"
					},
					{
						accent: ["Æ"],
						replacement: "AE"
					},
					{
						accent: ["ç"],
						replacement: "c"
					},
					{
						accent: ["Ç"],
						replacement: "C"
					},
					{
						accent: ["œ"],
						replacement: "oe"
					},
					{
						accent: ["Œ"],
						replacement: "OE"
					},
					{
						accent: ["î,ï"],
						replacement: "i"
					},
					{
						accent: ["Î,Ï"],
						replacement: "I"
					},
					{
						accent: ["ô"],
						replacement: "O"
					},
					{
						accent: ["Ô"],
						replacement: "o"
					},
					{
						accent: ["ù", "û", "ü"],
						replacement: "u"
					},
					{
						accent: ["Ù", "Û", "Ü"],
						replacement: "U"
					}
				]
			},

			fontsMathMap : {
				"en_US"	: 'MF_T2K_US-Regular',
				"iw_IL"	: 'MF_T2K_HE-Regular',
				"fr_FR"	: 'MF_T2K_FR-Regular',
				"nl_NL"	: 'MF_T2K_NL-Regular'
			},

			fontsLocaleMap : {
				"en_US"	: 'T2K-Ayala',
				"iw_IL"	: 'daat',
				"fr_FR"	: 'verdana',
				"nl_NL"	: 'verdana'
			},

			loadStyleFile: function( callback ) {

				var langFilePath = this.getStyleFilePath() ;

				console.log( "LocaleUtil => loadStyleFile :locale style -- loading  file: " + langFilePath );

				$("head").append("<link rel='stylesheet' type='text/css' href="+ langFilePath +" />");

				$("body").append('<div style="font-family:' + this.fontsMathMap[ENV.locale] + ';height: 0px; width: 0px;">123</div>');
				$("body").append('<div style="font-family:' + this.fontsLocaleMap[ENV.locale] + ';height: 0px; width: 0px;">123</div>');

				setTimeout(function() {
					callback.call();
				}, 10);
			}

	};

})() ;

var LocaleUtil = new t2k.util.LocaleUtil() ;
////////////////////////////////////////
// SRC End --> t2k/util/LocaleUtil.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/LanguageUtil.js
////////////////////////////////////////


/**
 * _ = Identifier for localization
 * @usage _("textarea.tooltips.bold") - returns localized value
 * @param id
 * @returns translated string
 */
var _i18n = function(id) {
	return LanguageUtil.getString(id);
}; 



/**
 * Class t2k.util.LanguageUtil
 * Responsible for all translation
 */
t2k.util.LanguageUtil = function(){

	//config
	this.config = {};
	this.config.direction = 'ltr';

	this.strings = {};
	
	// navigation
	this.strings.sequence = {} ;
	
	//navigation bar
	this.strings.progressbar = {};

    //task toolbar defaults
    this.strings.tasktoolbar = {};
	
	// text area
	this.strings.textarea = {};
	this.strings.textarea.tooltips = {};


    // Media Player
    this.strings.mediaPlayer = {};
    this.strings.mediaPlayer.tooltips = {};
    this.strings.mediaPlayer.messages = {};

    // Math field
    this.strings.mathField = {};
    this.strings.mathField.symbols = {};
};

t2k.util.LanguageUtil.prototype = {
	/**
	 * getString
	 * @param identifier - string logical identifier
	 * 
	 * @returns - translated string
	 */
	getString : function(identifier) {		
		var ret;

		ret = eval('this.strings.' + identifier);
		if (!ret) {
			ret = "";
		}
		return ret;
	}
};

var LanguageUtil = new t2k.util.LanguageUtil();

////////////////////////////////////////
// SRC End --> t2k/util/LanguageUtil.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/PerfUtil.js
////////////////////////////////////////
/**
 * Turbo utils.
 */
(function() {
    /**
     * jQuery cache.
     */
    var _cache_id = {};
    var _cache_jQuery = {};

    /**
     * Debug.
     */
    window.__perf_cache__hit = 0;
    window.__perf_cache__miss = 0;

    /**
     * Exported functions.
     */
    window.Perf = {
        /**
         * jQuery with cache. Takes string.
         */
        select: function(s, del) {
            // FIXME: next few lines should not get in production code.

            // ++window['__perf_cache__' + (_cache_jQuery[s]? 'hit': 'miss')];
            // console.log('[[ ' + (_cache_jQuery[s]? 'hit': 'miss') + ' ]] ' + s);

            if (del) {
                if (_cache_jQuery[s]) {
                    var ref = _cache_jQuery[s];
                    delete _cache_jQuery[s];
                    return ref;
                }
                return jQuery(s);
            }
            return _cache_jQuery[s] || (_cache_jQuery[s] = jQuery(s));
        },
        
        reset: function() {
			_cache_id = {};
			_cache_jQuery = {};
        },
        
        /**
         * getElementById with cache. Takes string.
         */
        getElementById: function(s, del) {
            if (del) {
                if (_cache_id[s]) {
                    var ref = _cache_id[s];
                    delete _cache_id[s];
                    return ref;
                }
                return document.getElementById(s);
            }
            return _cache_id[s] || (_cache_id[s] = document.getElementById(s));
        },

        /**
         * Efficiently create element.
         */
        create: function(name) {
            return jQuery(document.createElement(name));
        }
    };
})();

////////////////////////////////////////
// SRC End --> t2k/util/PerfUtil.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/Compat.js
////////////////////////////////////////
/**
 * Compatibility utils.
 * Functions below should work in (at least) recent Google Chrome and MSIE9+.
 */
(function() {
    /**
     * Check if browser supports modern DOM traversal.
     * XXX: use more reliable method,
     * see https://bugzilla.mozilla.org/show_bug.cgi?id=673790
     */
    var hasTraversal = typeof document
        .createElement('div')
        .childElementCount !== 'undefined';

    /**
     * Get first child with type=1 (elements only, no #Text nodes).
     * Like node.firstElementChild with MSIE fallback.
     */
    var getFirstChildType1 = hasTraversal? function(node) {
        return node && node.firstElementChild;
    }: function(node) {
        node = node && node.firstChild;
        while (node && node.nodeType != 1) node = node.nextSibling;
        return node;
    };

    /* is this stuff defined? */
    if (!document.ELEMENT_NODE) {
        document.ELEMENT_NODE = 1;
        document.ATTRIBUTE_NODE = 2;
        document.TEXT_NODE = 3;
        document.CDATA_SECTION_NODE = 4;
        document.ENTITY_REFERENCE_NODE = 5;
        document.ENTITY_NODE = 6;
        document.PROCESSING_INSTRUCTION_NODE = 7;
        document.COMMENT_NODE = 8;
        document.DOCUMENT_NODE = 9;
        document.DOCUMENT_TYPE_NODE = 10;
        document.DOCUMENT_FRAGMENT_NODE = 11;
        document.NOTATION_NODE = 12;
    }

    /**
     * MSIE-compatible importNode function.
     * This is from http://www.alistapart.com/articles/crossbrowserscripting/
     * by Anthony Holdener.
     * FIXME: this should be used only when needed, as it's performance-heavy
     * compared to the native implementation.
     */
    var importNode = function(node, allChildren) {
    	/* find the node type to import */
        switch (node.nodeType) {
            case document.ELEMENT_NODE:
                /* create a new element */
                var newNode = document.createElement(node.nodeName);
                /* does the node have any attributes to add? */
                if (node.attributes && node.attributes.length > 0)
                /* add all of the attributes */
                    for (var i = 0, il = node.attributes.length; i < il;)
                        newNode.setAttribute(node.attributes[i].nodeName, node.getAttribute(node.attributes[i++].nodeName));
                /* are we going after children too, and does the node have any? */
                if (allChildren && node.childNodes && node.childNodes.length > 0)
                /* recursively get all of the child nodes */
                    for (var j = 0, jl = node.childNodes.length; j < jl;)
                        newNode.appendChild(importNode(node.childNodes[j++], allChildren));
                return newNode;
            case document.TEXT_NODE:
            case document.CDATA_SECTION_NODE:
            case document.COMMENT_NODE:
                return document.createTextNode(node.nodeValue);
        }
    };

    /**
     * This is stupid.
     */
    var importNodeToDocument = function(document, node, allChildren) {
        /* find the node type to import */
        switch (node.nodeType) {
            case document.ELEMENT_NODE:
                /* create a new element */
                var newNode = document.createElement(node.nodeName);
                /* does the node have any attributes to add? */
                if (node.attributes && node.attributes.length > 0)
                /* add all of the attributes */
                    for (var i = 0, il = node.attributes.length; i < il;)
                        newNode.setAttribute(node.attributes[i].nodeName, node.getAttribute(node.attributes[i++].nodeName));
                /* are we going after children too, and does the node have any? */
                if (allChildren && node.childNodes && node.childNodes.length > 0)
                /* recursively get all of the child nodes */
                    for (var j = 0, jl = node.childNodes.length; j < jl;)
                        newNode.appendChild(importNode(node.childNodes[j++], allChildren));
                return newNode;
            case document.TEXT_NODE:
            case document.CDATA_SECTION_NODE:
            case document.COMMENT_NODE:
                return document.createTextNode(node.nodeValue);
        }
    };

	jQuery.fn.removeNative = function() {

		if (this.length != 0) {

			var elem_arr = this[0].getElementsByTagName('*'), elem, l = elem_arr.length;

			for (var i = l - 1; i >= 0; i--) {
				elem = elem_arr[i];
				elem && elem.parentNode && elem.parentNode.removeChild(elem);
				elem = null;
			}

			this[0].parentNode && this[0].parentNode.removeChild(this[0]);
			this.remove(this.selectedIndex);
		}

	};

    /**
     * Touch events.
     */
//    if ("ontouchend" in document) {
    if ( ENV.behaviors.touch ) {
        var jQueryOn = jQuery.fn.on,
            jQueryOff = jQuery.fn.off,
            eventsTr = {
                click: "touchend",
                mousedown: "touchstart",
                mouseup: "touchend",
                mouseenter: "touchstart",
                mouseleave: "touchend",
                mouseover: "touchstart",
                mouseout: "touchend",
                mousemove: "touchmove"
            };

        jQuery.fn.on = function() {
            var newArg0 = eventsTr[arguments[0]];
            typeof newArg0 === "undefined" || (arguments[0] = newArg0);
            return jQueryOn.apply(this, arguments);
        };

        jQuery.fn.off = function() {
            var newArg0 = eventsTr[arguments[0]];
            typeof newArg0 === "undefined" || (arguments[0] = newArg0);
            return jQueryOff.apply(this, arguments);
        };
    }

    /**
     * Clear text selection.
     * See http://stackoverflow.com/questions/3169786
     */
    function clearSelection(window) {
        if (window.getSelection) {
            if (window.getSelection().empty) {  // Chrome
                window.getSelection().empty();
            } else if (window.getSelection().removeAllRanges) {  // Firefox
                window.getSelection().removeAllRanges();
            }
        } else if (document.selection) {  // IE?
            document.selection.empty();
        }
    }

    /**
     * Create node next to another node. Apply jQuery if needed.
     */
    function createNodeNextTo(anotherNode, nodeName, applyjQuery) {
        var newNode = null;

        if (anotherNode.ownerDocument) {
            newNode = anotherNode.ownerDocument.createElement(nodeName);
        }
        /* in the event this is a document */
        else try {
            newNode = anotherNode.createElement(nodeName);
        }
        catch (notUsed) {}

        if (applyjQuery) return jQuery(newNode);
        else return newNode;
    }

    /**
     * Get jQuery object with children by tag name.
     * This may be redundant, as Olga fixed the loader behavior.
     */
    function getChildren(doc, nodeName) {
        return window.ENV && ENV.behaviors.isIE?
            jQuery(doc.getElementsByTagName(nodeName)):
            jQuery(doc).children(nodeName)
    }

	function getChildren2(child) {
		return window.ENV && ENV.behaviors.isIE?
			jQuery(child.childNodes):
			jQuery(child).children();
	}

    /**
     * actualWidth function
     * IE9 and FF have implemented sub pixel precision when it comes to dimensions.
     * The jQ width methods however return the int of the value instead of a float, so in case of IE9 we need to add 1 px to the offset width
     * @param $elem
     * @return width in px
     */
    function actualWidth($elem) {
        return window.ENV && ENV.behaviors.isIE
        	?
				($elem.get(0) == null || $elem.get(0) == undefined )
					?
						''
					:
						Math.ceil($elem.get(0).offsetWidth + 1)
						
			:
				Math.ceil($elem.outerWidth() + 1);
    }

	function fullOuterWidth($elem) {
		var elem = $elem.get(0);
		if (window.getComputedStyle) {
			var computedStyle = window.getComputedStyle(elem, null);
			return elem.offsetWidth
				+ (parseInt(computedStyle.getPropertyValue('margin-left'), 10) || 0)
				+ (parseInt(computedStyle.getPropertyValue('margin-right'), 10) || 0);
		} else {
			return elem.offsetWidth
				+ (parseInt(elem.currentStyle["marginLeft"]) || 0) + (parseInt(elem.currentStyle["marginRight"]) || 0);
		}
	}

    /**
     * actualHeight function
     * IE9 and FF have implemented sub pixel precision when it comes to dimensions.
     * The jQ width methods however return the int of the value instead of a float, so in case of IE9 we need to add 1 px to the offset height
     * @param $elem
     * @return height in px
     */
    function actualHeight($elem) {
		return window.ENV && ENV.behaviors.isIE?
				($elem.get(0) == null || $elem.get(0) == undefined ) ?
					''
					: Math.ceil($elem.get(0).offsetHeight + 1)
				: $elem.outerHeight();
    }

	function hasClass(element, cls) {
		return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
	}

	function addClass(element, cls) {
		if(hasClass(element, cls)) {
			return;
		}

		element.className += ' ' + cls;
	}

	function removeClass(element, cls) {
		element.setAttribute("class", element.getAttribute("class").replace(cls, ""));
	}

    /**
     * getStyle function
     * @param el
     * @param styleProp
     * @return {*}
     */
    function getStyle(el,styleProp) {
        if (el.length) {
            el = el[0];
        }
        var style = '';
        if (el.currentStyle){
            style = el.currentStyle[styleProp];
        }else{
            if (window.getComputedStyle && el){
                style = document.defaultView.getComputedStyle(el,null).getPropertyValue(styleProp);
            }
        }

        return style;
    }

	function getActualPosition(el) {
		var top = el.offsetTop;
		var left = el.offsetLeft;

		while(el && el.offsetParent) {
			el = el.offsetParent;
			top += el.offsetTop;
			left += el.offsetLeft;
		}

		return {'top' : top, 'left' : left}
	}

	function elementInViewport(el, viewPortEl) {
		var elPosition = getActualPosition(el);
		var viewPortOffset = getActualPosition(viewPortEl);

		return ({
			'inTop':    elPosition.top >= viewPortEl.scrollTop,
			'inLeft':   elPosition.left >= viewPortEl.scrollLeft,
			'inBottom':(elPosition.top + el.offsetHeight) <= (viewPortOffset.top + viewPortEl.scrollHeight),
			'inRight': (elPosition.left + el.offsetWidth) <= (viewPortOffset.left + viewPortEl.scrollWidth)
		});
	}
	
	function getScript( url, options, success, fail ) {
		
		if( ENV.behaviors.use$Ajax ) {
			
			jQuery.cachedScript( url, options )
			.done( function() {
				
				var argz = arguments ;
				success && success.call( argz ) ;
				
			} ).fail( function() {
				
				var argz = arguments ;
				fail && fail.call( argz ) ;
				
			} ) ;
			
		} else {
			
			nativeXHR( url, options, success, fail ) ;
			
		}
		
	}
	
	jQuery.cachedScript = function( url, options ) {
		 
		  // allow user to set any option except for dataType, cache, and url
		  options = jQuery.extend( options || {}, {
		    dataType: "script",
		    cache: true,
		    url: url
		  } ) ;
		 
		  // Use $.ajax() since it is more flexible than $.getScript
		  // Return the jqXHR object so we can chain callbacks
		  return jQuery.ajax( options ) ;
	} ;
	
	function nativeXHR( url, options, success, fail ) {
		
	    var request = createXMLHTTPObject() ;
	    
	    if ( !request ) return ;
	    
	    var method = "GET" ;
	    
	    request.open( method, url, true ) ;
	    
	    request.onreadystatechange = function() {
	    	
	    	var argz = arguments ;
	    	
			if( request.readyState == 4 ) {
				
				if( request.status == 200 || request.status == 0 || request.status == 304 ) {
					
					success && success.call( argz ) ;
					
				} else {
					
					fail && fail.call( argz ) ;
					
				}
				
			}
			
		}
	    
		request.send();
	}

	var XMLHttpFactories = [
	    function () { return new XMLHttpRequest() ; },
	    function () { return new ActiveXObject("Msxml2.XMLHTTP") ; },
	    function () { return new ActiveXObject("Msxml3.XMLHTTP") ; },
	    function () { return new ActiveXObject("Microsoft.XMLHTTP") ; }
	];

	function createXMLHTTPObject() {
		
	    var xmlhttp = false ;
	    
	    for ( var i = 0 ; i < XMLHttpFactories.length ; i++ ) {
	        try {
	            xmlhttp = XMLHttpFactories[ i ]() ;
	        }
	        catch ( e ) {
	            continue ;
	        }
	        break ;
	    }
	    
	    return xmlhttp ;
	    
	}
	
    /**
     * Fix for missing console
     */
    window.console || (window.console = {
        log: function() {},
        debug: function() {},
        info: function() {},
        warn: function() {},
        error: function() {}
    });

    /**
     * Exported functions (Compat.*)
     */
    window.Compat = {
        getFirstChildType1: getFirstChildType1,
        importNode: importNode,
        importNodeToDocument: importNodeToDocument,
        clearSelection: clearSelection,
        createNodeNextTo: createNodeNextTo,
        getChildren: getChildren,
		getChildren2: getChildren2,
		timeSecondDifference:timeSecondDifference,
        actualWidth: actualWidth,
        actualHeight: actualHeight,
        getStyle: getStyle,
	    elementInViewport : elementInViewport,
	    fullOuterWidth: fullOuterWidth,
	    hasClass : hasClass,
	    addClass : addClass,
	    removeClass : removeClass,
	    getActualPosition : getActualPosition,
	    getScript: getScript
    };
})();


/**
 * Fix built-in objects
 * Reference: http://stackoverflow.com/questions/2790001/
 */
(function() {
    'use strict';

    // Add ECMA262-5 method binding if not supported natively
    //
    if (!('bind' in Function.prototype)) {
        Function.prototype.bind= function(owner) {
            var that= this;
            if (arguments.length<=1) {
                return function() {
                    return that.apply(owner, arguments);
                };
            } else {
                var args= Array.prototype.slice.call(arguments, 1);
                return function() {
                    return that.apply(owner, arguments.length===0? args : args.concat(Array.prototype.slice.call(arguments)));
                };
            }
        };
    }

    // Add ECMA262-5 string trim if not supported natively
    //
    if (!('trim' in String.prototype)) {
        String.prototype.trim= function() {
            return this.replace(/^\s+/, '').replace(/\s+$/, '');
        };
    }

    // Add ECMA262-5 Array methods if not supported natively
    //
    if (!('indexOf' in Array.prototype)) {
        Array.prototype.indexOf= function(find, i /*opt*/) {
            if (i===undefined) i= 0;
            if (i<0) i+= this.length;
            if (i<0) i= 0;
            for (var n= this.length; i<n; i++)
                if (i in this && this[i]===find)
                    return i;
            return -1;
        };
    }
    if (!('lastIndexOf' in Array.prototype)) {
        Array.prototype.lastIndexOf= function(find, i /*opt*/) {
            if (i===undefined) i= this.length-1;
            if (i<0) i+= this.length;
            if (i>this.length-1) i= this.length-1;
            for (i++; i-->0;) /* i++ because from-argument is sadly inclusive */
                if (i in this && this[i]===find)
                    return i;
            return -1;
        };
    }
    if (!('forEach' in Array.prototype)) {
        Array.prototype.forEach= function(action, that /*opt*/) {
            for (var i= 0, n= this.length; i<n; i++)
                if (i in this)
                    action.call(that, this[i], i, this);
        };
    }
    if (!('map' in Array.prototype)) {
        Array.prototype.map= function(mapper, that /*opt*/) {
            var other= new Array(this.length);
            for (var i= 0, n= this.length; i<n; i++)
                if (i in this)
                    other[i]= mapper.call(that, this[i], i, this);
            return other;
        };
    }
    if (!('filter' in Array.prototype)) {
        Array.prototype.filter= function(filter, that /*opt*/) {
            var other= [], v;
            for (var i=0, n= this.length; i<n; i++)
                if (i in this && filter.call(that, v= this[i], i, this))
                    other.push(v);
            return other;
        };
    }
    if (!('every' in Array.prototype)) {
        Array.prototype.every= function(tester, that /*opt*/) {
            for (var i= 0, n= this.length; i<n; i++)
                if (i in this && !tester.call(that, this[i], i, this))
                    return false;
            return true;
        };
    }
    if (!('some' in Array.prototype)) {
        Array.prototype.some= function(tester, that /*opt*/) {
            for (var i= 0, n= this.length; i<n; i++)
                if (i in this && tester.call(that, this[i], i, this))
                    return true;
            return false;
        };
    }

	NodeList.prototype.forEach = HTMLCollection.prototype.forEach = Array.prototype.forEach;
})();

/**
 *
 * Get the time difference between 2 dates in seconds
 *
 * @param endDate
 * @param startDate
 * @return {Number}
 */
function timeSecondDifference(endDate,startDate,message) {

	var difference = endDate.getTime() - startDate.getTime();
console.error('',message + ':   ');
console.log('startDate.getTime() : ',startDate.getTime());
console.log('difference in Sec : ',Math.floor(difference/1000));
console.log('difference in MillSec : ',Math.floor(difference));
console.error('===============================================');
	return Math.floor(difference/1000);
}


/**
 * CSS hack time!
 */
if( window.ENV ) {
	if( ENV.behaviors.isIE ) {
	    jQuery('html').addClass('ie9');
	}
		
		
	if( ENV.behaviors.extraCSS ){
	    var cssExtra = ENV.behaviors.extraCSS;
	
	    if (typeof cssExtra === 'string') {
	        cssExtra = [cssExtra];
	    }
	
	    for (var i = 0; i < cssExtra.length; ++i) {
	        document.write("<link rel='stylesheet' href='" + cssExtra[i] + "'>");
	    }
	}
}
////////////////////////////////////////
// SRC End --> t2k/util/Compat.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/ComponentFactory.js
////////////////////////////////////////
/**
 * Class t2k.util.ComponentFactory
 */

(function() {

    // Save component ctor functions for later usage
    var _ccache = {};

	t2k.util.ComponentFactory = Object.subClass({
		
		ctor: function() {

			// exe. text editor class
			if (ENV.behaviors.textEditorClass){
				this.setClassNameByCompName('texteditor', ENV.behaviors.textEditorClass);
			}
			
		},
		
		/**
		 * create
		 * @param config
		 * @returns component's object / null
		 */
		create : function (config) {
			if (!config || !config.data)
                return null;

            var compClassName = this.getClassName(config.data.nodeName),
                objRef = window;

            if (!compClassName)
                return null;

            if (typeof _ccache[compClassName] === 'function') {
                return new (_ccache[compClassName])(config);
            }

            compClassName.split('.').forEach(function(name) {
                objRef = objRef[name];

                if (typeof objRef === 'undefined')
                    return null;
            });

            _ccache[compClassName] = objRef;
            return new objRef(config);
		},

		/**
		 * getClassName
		 * @param name
		 * @returns className
		 */
		getClassName : function(name){
			return compNameToClassName[name.toLowerCase()];
		},

		/**
		 * isComposite
		 * @param name
		 * @returns true / false
		 */
		isComposite : function(name){
			var componentClass = this.getClassName(name);
			if (componentClass){
				return !!eval(componentClass).isComposite;
			} else {
				return false;
			}
		},
		
		/**
		 * isComponent
		 * @param name
		 * @returns true / false
		 */
		isComponent : function(name){
			name = name.toLowerCase();
			return !!compNameToClassName[name];
		},
		
		setClassNameByCompName : function(compName, className){
			compNameToClassName[compName] = className;
		}
		
	});

	//****************************************************************************
	//*************************** Private ****************************************
	//****************************************************************************

	/**
	 * compNameToClassName
	 * class name hash
	 */
	var compNameToClassName = {
		dialog : 't2k.component.dialog.Dialog',
		posts : 't2k.component.dialog.Posts',
		post : 't2k.component.dialog.Post',
		avatar : 't2k.component.dialog.Avatar',
		exposition : 't2k.component.dialog.Exposition',
		bubble : 't2k.component.dialog.Bubble',
		textviewer : 't2k.component.textViewer.TextViewer',
		option : 't2k.component.select.Option',
		imageviewer : 't2k.component.imageViewer.ImageViewer',
		mediaplayer : 't2k.component.mediaPlayer.MediaPlayer',
		texteditor: 't2k.component.textarea.TextEditor',
		subanswer: 't2k.component.subAnswer.SubAnswer',
		multisubanswer: 't2k.component.subAnswer.MultiSubAnswer',
		subquestion: 't2k.component.subQuestion.SubQuestion',
		group: 't2k.component.group.Group',
		sharedarea: 't2k.component.sharedarea.SharedArea',
		cloze: 't2k.component.cloze.Cloze',
        clozearea: 't2k.component.cloze.ClozeArea',
		bank: 't2k.component.bank.Bank',
		mathfield: 't2k.component.mathField.MathField',
        tre: 't2k.component.tre.Tre',
        layoutgroup: 't2k.component.LayoutGroup',
        questiongroup: 't2k.component.QuestionGroup',
    	question: 't2k.component.text.Question',
		helpitem: 't2k.component.help.HelpItem',
		help: 't2k.component.help.Help',
		answer: 't2k.component.answer.Answer',
        thirdparty: 't2k.component.ThirdParty',
        definition : 't2k.component.definition.Definition',
        mtqarea : 't2k.component.mtq.MtqArea',
        mtqsubquestion : 't2k.component.mtq.MtqSubQuestion',
        mtqmultisubquestion : 't2k.component.mtq.MtqMultiSubQuestion',
        mtqbank : 't2k.component.mtq.MtqBank',
    	options : 't2k.component.options.Options',
        tablecomp : 't2k.component.table.Table',
        row : 't2k.component.table.Row',
        cell : 't2k.component.table.Cell',
        thirdparty : 't2k.component.thirdParty.ThirdParty',
        applet : 't2k.component.applet.Applet'
	};

})();

// Component factory singleton
var componentFactory = new t2k.util.ComponentFactory();

////////////////////////////////////////
// SRC End --> t2k/util/ComponentFactory.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/ScrollControl.js
////////////////////////////////////////
/**
 * Class t2k.util.ScrollControl
 */

(function() {

	t2k.util.ScrollControl = Object.subClass({
		/**
		 * ctor
		 */
		ctor: function() {
			this.initMembers();
			this.bindDocumentEvents();
		},
		
		/**
		 * initMembers
		 */
		initMembers : function(){
			this.activeService = ENV.behaviors.scrollControl;
		},

        scrollToTouchStart : function(){
            this.forceScrollTop(-this.Y + 80);
        },
		
		/**
		 * bindDocumentEvents
		 */
		bindDocumentEvents : function(){
			// bind scroll events on active only
			if (!this.activeService) return;
			
			var thi$ = this, top, change;

            // bind touch start
            document.addEventListener('touchstart', function (e) {

	            if (!thi$.scrollElement)
	                return;

                thi$.Y = (e.changedTouches[0].screenY);
                thi$.marginTop = thi$.scrollElement.css('margin-top').px2int();
            }, true);
			
			// bind touch move
			document.addEventListener('touchmove',  function(e){
				//in mtq task prevent scrolling while dragging subAnswer
				if (($(e.srcElement).parents('.task.mtq .subAnswer').length > 0) || !thi$.scrollElement)
					return;

//				if (!thi$.scrollElement) return;

				e.preventDefault(); 
				e.stopPropagation();
	    		thi$.DELTA = (e.changedTouches[0].screenY) - thi$.Y;
	    		change = (thi$.DELTA * 1) + thi$.marginTop;
	    		thi$.scrollTop(change);
			}, true);
		},
		
		/**
		 * adjustMargin
		 * adjust margin val < 0 || val > maxMargin
		 * @param val
		 * @returns val
		 */
		adjustMargin : function(val){
			if (val > 0) return 0;
			return (val < this.maxMargin) ? this.maxMargin : val;
		},
		
		/**
		 * scrollTop
		 * scroll to val
		 * @param val
		 */
		scrollTop : function(val){
			val = this.adjustMargin(val);
			this.scrollElement.css( 'margin-top' , val);
		},

        forceScrollTop : function(val){
            this.scrollElement.css( 'margin-top' , val);
		},
		
		/**
		 * getMarginTop
		 * @returns {int} - margin top
		 */
		getMarginTop : function(){
            if (!this.scrollElement) return 0;

			return this.scrollElement.css('margin-top').px2int();
		},
		
		/**
		 * scrollTopAnimate
		 * @param val (margin)
		 * @param ms  (duration)
		 * @param callback
		 */
		scrollTopAnimate : function(val, ms, callback){
			val = this.adjustMargin(val);
			this.scrollElement.animate({'margin-top' : val} ,ms, callback);
		},
		
		/**
		 * initSequenceScrollControl
		 * @param $seq - sequence element
		 * @param flag {Boolean}
		 */
		initSequenceScrollControl : function($seq, flag){
			
			// init on active only
			if (!this.activeService) return;
			
			// on false, disable control
			if (!flag) {
				this.disableSequenceScrollControl();
				return;
			}
			
			// set auto height
			this.scrollElement = $seq.find('.scroll_enabled');
			this.scrollElement.height('');
			
			// get scrollable and sequence height
			var scrollElementHeight = this.scrollElement.height();
			var seqHeight = $seq.height();
			
			// set max margin
			this.maxMargin = -(scrollElementHeight - seqHeight);
		},
		
		/**
		 * disableSequenceScrollControl
		 */
		disableSequenceScrollControl : function(){
			this.scrollElement = null;
		}
		
	});

})();

// Scroll Control singleton
var ScrollControl = new t2k.util.ScrollControl();

////////////////////////////////////////
// SRC End --> t2k/util/ScrollControl.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/TabletUtil.js
////////////////////////////////////////
/**
 * Class t2k.util.TabletUtil
 */

(function () {

    t2k.util.TabletUtil = Object.subClass({

        bindButtonTouchStartAndEnd:function ($elem) {
            $elem.bind('touchstart', function () {
                $elem.addClass('selected');
            });

            $elem.bind('touchend', function () {
                $elem.removeClass('selected');
            });
        }


    });

})();

// Tablet Util singleton
var TabletUtil = new t2k.util.TabletUtil();

////////////////////////////////////////
// SRC End --> t2k/util/TabletUtil.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/TaskCheckingType.js
////////////////////////////////////////
t2k.player.task.TaskCheckingType = function() {
    var hash = [];
    hash['mc'] = "AUTOMATIC";
    hash['cloze'] = "AUTOMATIC";
	hash['shortAnswer'] = "AUTOMATIC_MANUAL";
    hash['matching'] = "AUTOMATIC";
    hash['opq'] = "MANUAL";
    hash['mtq'] = "AUTOMATIC";
    //hash['questionOnly'] = "MANUAL";
    //todo by def questionOnly should be MANUAL this makes no sense we set it to exposure need to check if it makes any other trouble
    hash['questionOnly'] = "EXPOSURE";
    hash['tre'] = "MANUAL";
    hash['statement'] = "EXPOSURE";
    hash['defaultValue'] = "EXPOSURE";

    return hash
    /*{
        mc:"AUTOMATIC",
        cloze:"AUTOMATIC",
        matching:"AUTOMATIC",
        opq:"MANUAL",
        questionOnly:"MANUAL",
        //TODO add tre checking types by tre type
        tre:"MANUAL",
        statement:"EXPOSURE",
        defaultValue:"EXPOSURE",

        NON_PEDAGOGICAL:"NON_PEDAGOGICAL",
        EXPOSURE:"EXPOSURE",
        MANUAL:"MANUAL",
        GAME:"GAME",
        DYNAMIC:"DYNAMIC",
        AUTOMATIC:"AUTOMATIC"

    }*/
}();

// Shorthand.
var TaskCheckingType = t2k.player.task.TaskCheckingType ;

////////////////////////////////////////
// SRC End --> t2k/player/task/TaskCheckingType.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/AssetUtils.js
////////////////////////////////////////
(function() {

    /**
     * Class: t2k.util.StringUtils
     * Contains string manipulation/formatting/etc. utilities
     */
    t2k.util.AssetUtils = {
        
		getAbsolutePath: function( relativePath ) {
			
			var abs = null ;
			
			var baseType = typeof ENV.assetBasePath ;
			
			if( baseType === "function" ) {
				
				abs = ENV.assetBasePath( relativePath ) ;
				
			} else if ( baseType === "string" ) {
				
				abs = ENV.assetBasePath + relativePath ;
				
			} else {
				
				throw new Error( "DL Error --> unhandled base path: " + baseType ) ;
				
			}
			
			return abs ;
			
		}

	};

})();

var AbsPath = t2k.util.AssetUtils.getAbsolutePath ;
////////////////////////////////////////
// SRC End --> t2k/util/AssetUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/DynamicLayoutUtils.js
////////////////////////////////////////
(function() {
	
	// dev logger
	var layouterLog, devEnableDynamicLayout = true, devEnableLogger = false, layouterDone;


	var setLayouterLog = function(val) {
		if (!devEnableLogger) return;

		var layouterLog = Perf.select('#log');

		if (layouterLog.attr('id') != 'log') {
			layouterLog = Perf.create("div").
                attr('id', 'log').
                css({ border:      '1px solid black',
                     'font-size':  '30px',
                      left:        '300px',
                      position:    'absolute',
                     'text-align': 'center',
                      top: 0 }).
                width(200). height(40).
                appendTo(Perf.select('body'));
		}

		layouterLog.text(val);
	};


	var setLayouterLogBackground = function(){
		
		if (!devEnableLogger) return;
		
		var layouterLog = Perf.select('#log');
		if (!layouterDone) {
			layouterLog.css('background-color', 'red');
			layouterDone = 'compileDone';
		} else {
			layouterLog.css('background-color', '#66CD00');
		} 
		
	};

	t2k.util.DynamicLayoutUtils = {
		
		// taskArray declaration
		taskArray : {},
		activeLayoutingTask : '',
		vpHeight : null,
    	
		/**
		 * dynamicLayout (!)
		 * calls from sequenceCompoiler, onTaskRendered
		 * @param task (reference)
		 * @param vpHeight (viewPort height)
		 * @param layoutState (reduction, compact, loose)
		 */
    	dynamicLayout : function (task, vpHeight, layoutState, caller, onSequenceLayoutDone) {
    		
    		this.caller = caller ;
    		
    		// dev !
    		if (!devEnableDynamicLayout) return;
    		if (!this.onSequenceLayoutDone) this.onSequenceLayoutDone = onSequenceLayoutDone;
    		
    		if (!this.vpHeight) this.vpHeight = vpHeight;
    		if (!vpHeight) vpHeight = this.vpHeight;
    		
    		// reference
    		var thi$ = this;
    		
    		// register task on taskArray
    		this.registerTask(task);
    		
    		if (!this.isActiveLayoutingTask(task)) return false;
    		
//    		console.log('>>>>>>>>>>>>>>>>>>>>>>>>>>>> TIME: ' + new Date().getTime() ) ;
    		
    		// setTimeout for dom rendering
    		setTimeout(function(){
    			
    			// check if task enabled layouting
    			if (!thi$.taskArray || !thi$.isEnableLayouting(task)) return false;
    			
    			// if reduction - loose
    			if (layoutState == 'reduce'){
    				thi$.resetTaskQuestionRendered(task);
					thi$.resetTaskAnswerRendered(task);
					setLayouterLog('loose');
    				task.question.loose();
    				task.answer.loose();
    				
    			} else {
    				
    				// check if task is heigher than view port
    				if (!!thi$.heigherTask(task, vpHeight) && thi$.isEnableLayouting(task)){
    					
    					// on loose - compact
	    				if (layoutState == 'loose'){
	    					thi$.resetTaskQuestionRendered(task);
							thi$.resetTaskAnswerRendered(task);
							setLayouterLog('compact');
	    					task.question.compact();
	    					task.answer.compact();
	    					
	    				} else {
	    					
	    					// on compact - reduce
	    					if (layoutState == 'compact'){
	    					
	    						// if reduction available on q&a - reduce them both
		    					if (task.question.reductionAvailable() && task.answer.reductionAvailable()){
		    						
		    						thi$.resetTaskQuestionRendered(task);
		    						thi$.resetTaskAnswerRendered(task);
		    						setLayouterLog('reduction Q+A');
		    						task.question.reduce();
		    						task.answer.reduce();
		    						
		    					} else {
		    						
		    						var reduced = {};
		    						// reduce only question
		    						if (task.question.reductionAvailable()){
		    							thi$.resetTaskQuestionRendered(task);
		    							setLayouterLog('reduction Q');
		    							task.question.reduce();
		    							reduced.question = true;
		    						}
		    						
		    						// reduce only answer
		    						if (task.answer.reductionAvailable()){
		    							thi$.resetTaskAnswerRendered(task);
		    							setLayouterLog('reduction A');
		    							task.answer.reduce();
		    							reduced.answer = true;
		    						}
		    						
		    						// dont reduce - stop rec
		    						if (!!!reduced.answer && !!!reduced.question){
		    							thi$.setEnableLayouting(task, false);
		    						}
		    						
		    					}
	    					} 
	    					
	    				}
    				}  else {
    					// if task is smaller than view port, stop rec
    					thi$.setEnableLayouting(task, false);
    				}
    			}
    			
    		}, 10);
        	
        },

		dynamicHelpItemLayout : function (helpItem, vpHeight, layoutState, onHelpLayoutDone) {

			if (!this.vpHeight) this.vpHeight = vpHeight;
			if (!vpHeight) vpHeight = this.vpHeight;

			if (!this.onHelpLayoutDone) this.onHelpLayoutDone = onHelpLayoutDone;

			// reference
			var thi$ = this;

			// setTimeout for dom rendering
			setTimeout(function(){

				// check if help item enabled layouting
				if (!helpItem.enableLayouting) return false;

				// if reduction - loose
				if (layoutState == 'reduce'){
					thi$.helpRendered = false;
					setLayouterLog('loose');
					helpItem.loose();
				} else {

					// check if task is heigher than view port
					if (!!thi$.heigherTask(helpItem, vpHeight) && helpItem.enableLayouting){

						// on loose - compact
						if (layoutState == 'loose'){
							thi$.helpRendered = false;
							setLayouterLog('compact');
							helpItem.compact();


						} else {

							// on compact - reduce
							if (layoutState == 'compact') {
								if (helpItem.reductionAvailable()) {
									thi$.helpRendered = false;
									setLayouterLog('reduction Help item');
									helpItem.reduce();

								} else {
									helpItem.enableLayouting = false;
								}
							}

						}
					}  else {
						// if help Item is smaller than view port, stop rec
						helpItem.enableLayouting = false;
					}
				}

				if(!helpItem.enableLayouting) {
					thi$.onHelpLayoutDone.apply(helpItem);
					thi$.onHelpLayoutDone = null;
				}

			}, 10);

		},
        
        taskCounter : 0,
        
        resetTaskCounter : function(){
        	this.taskCounter = 0;
        },
        
        incrementTaskCounter : function(){
        	this.taskCounter++;
        },
        
        /**
         * registerTask
         * on taskArray
         * @param task
         */
        registerTask : function(task){
        	
        	var taskId = this.getTaskId(task);
        	
        	// check if task already registered
        	if (!this.taskArray.taskId){
        		this.taskArray[taskId] = {
        				'enableLayouting' : true,
        				'layoutDone' : false,
        				taskRef : task
        		};
        	}
        },
        
        unRegisterTask : function(task){
        	var taskId = this.getTaskId(task);
//        	this.taskArray = this.taskArray.splice(this.getTaskIndex(taskId),1); 
        },
        
        getTaskIndex : function(taskId){
        	
        	var index = 0;
        	
			for (var task in this.taskArray){
        		if (task == taskId) return index;
        		index++;
        	}

        },
        
        isActiveLayoutingTask : function(task){
        	
        	var taskId = this.getTaskId(task);
        	
        	// in case that on (activeTask.layoutDone = true) and the next task registered after layout done,
        	// set activeLayoutingTask='', for this function will return true and update activeLayoutingTask.
        	if (this.activeLayoutingTask != '' && !!this.activeLayoutingTask){
        		if (this.taskArray[this.activeLayoutingTask].layoutDone){
        			this.activeLayoutingTask = '';
        		}
        	}
        	
        	if (this.activeLayoutingTask == ''){
        		this.activeLayoutingTask = taskId;
        		return true;
        	} else if (this.activeLayoutingTask == taskId){
        		return true;
        	}
        	
        	return false;
        },
        
        /**
         * getTaskId
         * @param task
         * @returns task id
         */
        getTaskId : function(task){
	        //TODO:: check for the caught of the bug
        	return task.view.cfg ? task.view.cfg.id : 0;
        },
        
        /**
         * isEnableLayouting
         * @param task
         * @returns true / false
         */
        isEnableLayouting : function(task){
        	var taskId = this.getTaskId(task);
        	if (!this.taskArray[taskId]) return false;
        	return this.taskArray[taskId].enableLayouting;
        },
        
        /**
         * setEnableLayouting
         * @param task
         * @param flag - boolean 
         */
        setEnableLayouting : function(task, flag, stopAfterLoose){
        	var taskId = this.getTaskId(task);
        	this.taskArray[taskId].enableLayouting = flag;
        	
        	if (!flag){
        		
        		// dev
        		setLayouterLogBackground();
        		
        		this.taskArray[taskId].layoutDone = true;
        		this.taskArray[taskId].taskRef.taskGrading = this.heigherTask(this.taskArray[taskId].taskRef, this.vpHeight);
        		this.unRegisterTask(task);
        		this.activeNextTaskLayouting();
        	}
        },
        
        activeNextTaskLayouting : function(){
        	
        	var thi$ = this, taskArrayLength = 0;
        	var layoutTask, layoutTaskId ;
        	
        	for (var task in this.taskArray){
        		
        		// increment task array length
        		taskArrayLength++;
        		
        		if (!this.taskArray[task].layoutDone){
        			layoutTask = this.taskArray[task].taskRef;
        			layoutTaskId = this.getTaskId(layoutTask);
        			this.activeLayoutingTask = layoutTaskId;
        			this.dynamicLayout(layoutTask, null, 'loose', this.caller );
        			return false;
        		}
        	}
        	
        	if (taskArrayLength == this.taskCounter){
        		
        		this.activeLayoutingTask = '';
        		this.taskArray = [];
        		var retFnc = this.onSequenceLayoutDone;
        		this.onSequenceLayoutDone = null;
        		retFnc.call( this.caller );
        		
        	}
        },
        
        /**
         * resetTaskCompositesRendered
         * reset Q & A
         * @param task
         */
        resetTaskCompositesRendered : function(task){
        	this.resetTaskQuestionRendered(task);
        	this.resetTaskAnswerRendered(task);
        },
        
        /**
         * resetTaskQuestionRendered
         * reset Q
         * @param task
         */
        resetTaskQuestionRendered : function(task){
        	task.questionRendered = false;
        },
        
        /**
         * resetTaskAnswerRendered
         * reset A
         * @param task
         */
        resetTaskAnswerRendered : function(task){
        	task.answerRendered = false;
        },
        
        /**
         * heigherTask
         * check if task is heigher than view port
         * @param task
         * @param vpHeight
         * @returns {Boolean}
         */
        heigherTask : function(task, vpHeight){
            //add the task the height of the sequence_list_head height ( with header contains height + padding top+bottom, 
            //without contains padding botton to sparate task from top viewport )
	        var sequence_list_head_Addition = 0;
	        if(task.view._view.hasClass('first_task_in_sequence')) {
                sequence_list_head_Addition = task.view._view.parent().children('.sequence_list_head').outerHeight();
	        }

            return task.view._view.height() + sequence_list_head_Addition  > vpHeight ;
        }

    }; // End of DynamicLayoutUtils

})();

// Shorthands
var DynamicLayoutUtils = t2k.util.DynamicLayoutUtils;

////////////////////////////////////////
// SRC End --> t2k/util/DynamicLayoutUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/CompilerUtils.js
////////////////////////////////////////
(function() {

	t2k.util.CompilerUtils = {
			
		/**
		 * setNumOfChildren - rec
		 * set the number of children attr on each composite
		 * @param xml
		 * @returns numbered xml
		 */
		setNumOfChildren : function(xml){
			
			// ref
			var thi$ = this;
			
			// valitation
			if (!xml || (jQuery(xml).children().length === 0)) return null;
			
			// if xml node is a composite
			// (otherwise it's doesn't have children)
			if (componentFactory.isComposite(xml.nodeName)){
				
				// reset num of composite's children
				var numOfChildren = 0;
	
				// start recursion for the composite's children and count composite's children
				jQuery(xml).children().each(function(index, child) {
					
					var childName = child.nodeName.toLowerCase();
					if (componentFactory.isComponent(childName)){
						numOfChildren++;
					}
					child = thi$.setNumOfChildren(child);
				});
	
				// add 'numOfChildren' attribute to the composite xml
				jQuery(xml).attr('numOfChildren', numOfChildren);
			}
			
			return xml;
		},

		/**
		 * groupData
		 * return the grouped xml
		 * @param xml
		 * @returns xml
		 */
		groupData : function (xml) {

			// if there is no xml, return
			if (!xml || (jQuery(xml).children().length === 0)) return null;

			// reference
			var thi$ = this;

			// start rec only for composite, except answer composite
			if (componentFactory.isComposite(xml.nodeName) && (xml.nodeName.toLowerCase() != 'answer')) {

				// clarify group type
				switch (this.groupBy(xml)) {

					case 'textViewer':
						xml = this.groupByTextViewer(xml);
						break;

					case 'similars':
						xml = this.groupBySimilars(xml);
						break;

					case 'questionGroupWrapper':
						xml = this.questionGroupWrapper(xml);
						break;

				} // end switch

				// reset num of composite's children
				var numOfChildren = 0;

				// start recursion for the composite's children and count composite's children
				jQuery(xml).children().each(function(index, child) {
					child = thi$.groupData(child);
					numOfChildren++;
				});

				// add 'numOfChildren' attribute to the composite xml
				jQuery(xml).attr('numOfChildren', numOfChildren);

			} // end if

			// return the grouped xml
			return xml;

		},

		/**
		 * questionGroupWrapper
		 * simply wrap the xml with <questionGroup/> tag
		 * @param xml
		 * @returns xml
		 */
		questionGroupWrapper: function(xml) {

			// reference
			var thi$ = this;

			// init groups and children arrays
			var groups = [];
			var children = [];

			// push composite's children to children arrary
			jQuery(xml).children().each(function(index, child) {
				children.push(child);
			});

			// reset xml
			jQuery(xml).empty();

			// create questionGroup tag and append it to xml
			var group = xml.ownerDocument.createElement('questionGroup');
			jQuery(xml).append(group);

			// append the original composite's children to group (questionGroup)
			jQuery(children).each(function(index, child) {
				jQuery(group).append(child);
			});

			// return xml
			return xml;

		},

		/**
		 * groupByTextViewer
		 * group xml with questionGroup, according to these rules:
		 * 1. every textViewer will start a new group
		 * 2. if the textViewer isn't the first component, group the first components also
		 * @param xml
		 * @returns xml
		 */
		groupByTextViewer : function(xml) {

			// init group and children arrays
			var groups = [];
			var children = [];
			var group;

			// push composite's children to children array
			jQuery(xml).children().each(function(index, child) {
				children.push(child);
			});

			// reset xml
			jQuery(xml).empty();

			// if textViewer isn't the first component, create questionGroup and append it to xml
			if (!this.tvFirst(jQuery(children))) {
				group = xml.ownerDocument.createElement(xml.nodeName.toLowerCase() === 'question'? 'questionGroup': 'layoutGroup');
				jQuery(xml).append(group);
			}

			// loop the children
			jQuery(children).each(function(index, child) {

				// if the current component is a textViewer, create questionGroup and append it to xml
				// else, do nothing. means that the current will append to the current group
				if (child.nodeName.toLowerCase() == 'textviewer') {
					group = xml.ownerDocument.createElement(xml.nodeName.toLowerCase() === 'question'? 'questionGroup': 'layoutGroup');
					jQuery(xml).append(group);
				}

				// append the current to group
				jQuery(group).append(child);
			});

			// return xml
			return xml;

		},

		/**
		 * groupBySimilars
		 * group similars tagNames with layoutGroup
		 * @param xml
		 * @returns xml
		 */
		groupBySimilars : function(xml) {

			// reference
			var thi$ = this, group;

			// init group and children arrays
			var groups = [];
			var children = [];

			// set groupFor as null.
			var groupFor = null;

			// push composite's children to children array
			jQuery(xml).children().each(function(index, child) {
				children.push(child);
			});

			// reset xml
			jQuery(xml).empty();

			// loop the children
			jQuery(children).each(function(index, child) {

				// if this tagName and the next tagName are similars..
				if (thi$.thisAndNextNeedsGroup(children, index)) {

					// if !groupFor, it's means that this is the first time similars are detected.
					// in that case, create layoutGroup and append it to xml,
					// and set groupFor with the tagName.
					// if groupFor, that means that the current group is the right group.
					if (!groupFor) {
						group = xml.ownerDocument.createElement('layoutGroup');
						jQuery(xml).append(group);
						groupFor = child.nodeName.toLowerCase();
					}

					// append the current tagName to group
					jQuery(group).append(child);

				} else {

					// if this tagName and the next tagName dont need to be group
					// and groupFor is not null, that means that this tagName is the last tagName
					// that need to be insert to group, because this tagName and the prev. tagName are similars
					// the the next one is not.
					if (groupFor) {
						// append the child to the group
						jQuery(group).append(child);
						// set groupFor = null, because this is the end of the current group
						groupFor = null;
					} else {
						// if we're not in the middle of group,
						// and this and next aren't similars,
						// simply append child to xml
						jQuery(xml).append(child);
					}
				}

			});

			// return xml
			return xml;

		},

		/**
		 * thisAndNextNeedsGroup
		 * check if index and index+1 are similars
		 * @param children
		 * @param index
		 * @returns {Boolean}
		 */
		thisAndNextNeedsGroup: function(children, index) {

			// if "this" is the last child, return false
			if (children.length == index + 1) {
				return false;
			}

			// if "this" and "next" are similar, return true
			if (children[index].nodeName.toLowerCase() == children[index + 1].nodeName.toLowerCase()) {
				return true;
			}

			// (else) return false
			return false;
		},

		/**
		 * groupBy
		 * this function clarified the group type.
		 * textViewer, similars or wrapper
		 * @param xml
		 * @returns xml
		 */
		groupBy: function(xml) {

			var result = null; // no need to group

			// count the textViewers in xml
			var countTv = this.countTv(xml);

			// if there is no need to group by textViewer
			// condition: if there is one TV and it's the first
			//			or if there is no TV, there is no neet to group by TV
			if ((this.tvFirst(jQuery(xml).children()) && (countTv == 1)) || (countTv === 0)) {

				// if this is the question composite, group anyway with question group
				if (xml.nodeName.toLowerCase() == 'question') {
					result = 'questionGroupWrapper';

					// check for similars existence
				} else if (this.isSimilars(xml) && !this.onlySimilars(xml)) {
					result = 'similars'; // group by similars
				}

			} else {
				// the 'else' means that there is a need to group by textViewer..
				result = 'textViewer'; // group by textViewer
			}

			return result;
		},

		/**
		 * tvFirst
		 * check if textViewer is the first element in xml
		 * @param xml
		 * @returns boolean
		 */
		tvFirst : function(xml) {
			return jQuery(xml)[0].nodeName.toLowerCase() == 'textviewer';
		},

		/**
		 * countTv
		 * count textViewers in xml
		 * @param xml
		 * @returns tvCounter - int
		 */
		countTv : function(xml) {
			var tvCounter = 0;

			jQuery(xml).children().each(function(index, child) {
				if (child.nodeName.toLowerCase() == 'textviewer') {
					tvCounter++;
				}
			});

			return tvCounter;
		},

		/**
		 * isSimilars
		 * check for similars and sequential nodes in xml
		 * @param xml
		 * @returns {Boolean}
		 */
		isSimilars : function(xml) {

			var currentNodeName;
			var result = false;

			jQuery(xml).children().each(function(index, child) {
				if (index === 0) {
					// on first index, init currentNodeName
					currentNodeName = child.nodeName.toLowerCase();
				} else {
					// if the last nodeName = currentNodeName, return true
					// else, update currentNodeName
					if (currentNodeName == child.nodeName.toLowerCase()) {
						result = true;
						return;
					} else {
						currentNodeName = child.nodeName.toLowerCase();
					}
				}
			});

			return result;
		},

		/**
		 * onlySimilars
		 * check if the tagNames in xml are all the same
		 * @param xml
		 * @returns {Boolean}
		 */
		onlySimilars : function(xml) {

			var currentNodeName;
			var result = true;

			jQuery(xml).children().each(function(index, child) {
				if (index === 0) {
					// on first index, init currentNodeName
					currentNodeName = child.nodeName.toLowerCase();
				} else {
					// if the last nodeName = currentNodeName, return true
					// else, update currentNodeName
					if (currentNodeName != child.nodeName.toLowerCase()) {
						result = false;
						return;
					} else {
						currentNodeName = child.nodeName.toLowerCase();
					}
				}
			});

			return result;
		},
		
		compileTaskHeight : function(taskWidth, $data){
			
			var taskToolbarHeight = 35 ;
			
			var totalHeight = taskToolbarHeight ;
			var taskComponents =[ 'instruction', 'title', 'question', 'answer' ] ;
			var currentCompSize = null ;
			var currentCompTag = null ;
			
			for( var i = 0 ; i < taskComponents.length ; i++ ) {
				currentCompTag = taskComponents[i] ;
				var additionalInformation = this.getTaskAdditionalInformation($data);
				currentCompSize= this.getCompiledHeight(taskWidth, 0, $data.find( currentCompTag ), null, additionalInformation) ;
				// this.cl(currentCompTag + ' - height: ' + currentCompSize.height + ' width: ' + currentCompSize.width);
				
				totalHeight += currentCompSize.height ;
			}
			
			return totalHeight ;
		},
		
		getCompiledHeight : function(taskWidth, taskHeight, $data, parentForcedAddDirection, additionalInformation, level){
			
			var $childData, tagName, compArray, singleCompSize, 
				thi$ = this, compSize, compositeSize = {width:0, height:0};
			
			var childrenForcedAddDirection = null ;
			
			var tagName = $data[0].tagName.toLowerCase();
			var compLevel = ( level == undefined ) ? -1 : level ;
			compLevel++ ;
			var groupName = tagName + "_level_" + compLevel //+ "_" + Math.random() ;
//			console.group( groupName ) ;
			console.groupCollapsed( groupName ) ;
			
			// get children size
			var children = $data.children() ;
//			$data.children().each(function(index, childData){
			for( var index = 0 ; index < children.length ; index++ ) {
				
				var childData = children[index] ;
				
				$childData = jQuery(childData);
				tagName = childData.tagName.toLowerCase();
				
				// reset comp size
				compSize = {width:0, height:0};
				
				switch( tagName ) {
					
					case 'layoutgroup' : {
						
					}
					
					case 'textviewer' : {
						compSize = thi$.gettextviewerCompositeSize($childData, taskWidth);
						break;
					}
					
					case 'imageviewer' : {
						compSize = thi$.getimageviewerCompositeSize($childData, taskWidth)
						break;
					}
					case 'multisubanswer':{
						if (additionalInformation.type == 'mtq' && additionalInformation.hasBank){
							var functionName = "get"+ additionalInformation.answerType+"CompositeSize";
							if(thi$[functionName]){
								compSize = thi$[functionName]($childData, taskWidth);
								compSize.heightCaseVertical = {		height : (compSize.height * (additionalInformation.max_in_array+1)),
																	width: compSize.width
															  };
								compSize.widthCaseHorizontal = {	height: compSize.height,
																	width: (compSize.width * (additionalInformation.max_in_array+1))
																};
							}else{
								compSize = thi$.getCompiledHeight( taskWidth, taskHeight, $childData, childrenForcedAddDirection, additionalInformation, compLevel );
							}
						}else{
							compSize = thi$.getCompiledHeight( taskWidth, taskHeight, $childData, childrenForcedAddDirection, additionalInformation, compLevel );

						}
						break;


					}
					case 'subanswer':{
						if (additionalInformation.type == 'mtq' && additionalInformation.hasBank){
							var functionName = "get"+ additionalInformation.answerType+"CompositeSize";
							if(thi$[functionName]){
								compSize =thi$[functionName]($childData, taskWidth)
							}
						}else{
							compSize = thi$.getCompiledHeight( taskWidth, taskHeight, $childData, childrenForcedAddDirection, additionalInformation, compLevel );

						}
						break;
					}
					
					case 'texteditor': {
						// calc for modes: letter, word, sentence, pharagraph, fullText
						compSize = {width: taskWidth * 0.75, height: 150};
						break;
					}
					
					case 'dialog' : {
						
						var $post;
						
						$childData.find('post').each(function(index, post){
							
							$post = jQuery(post);
							
							var bubbleSize = thi$.plusMargins(thi$.getCompiledHeight(taskWidth, taskHeight, $post.find('bubble'),childrenForcedAddDirection, additionalInformation, compLevel ), 21);
							var imageSize = {height: 120, width: 120};
							compSize = thi$.addVertical(compSize, thi$.addHorizontal(bubbleSize, imageSize));
							
						});
						
						// thi$.cl('tagName: ' + tagName + ' width: ' + compSize.width + 'height: ' + compSize.height);
						
						break;
					}
						
					case 'mediaplayer' : {
						
						compSize = thi$.getmediaplayerCompositeSize();
						
						break;
					}
						
					case 'mathfield' : {
						
						compSize = {width: 75, height: 50};
						
						break;
					}
						
					case 'table' : {
						
						if( $childData.attr('mainContainer') == 'question' ) {
							
							compSize = {width: 190, height: 160};
							break ;
							
						} else {
							
							childrenForcedAddDirection = 'vertical' ;
							
							// no break - go to default anyways
							// - break;
							
						}
						
					}
						
					case 'row' : {
						
						childrenForcedAddDirection = 'horizontal' ;

						// no break - go to default anyways
						// - break;
					}
					
					default : {
						compSize = thi$.getCompiledHeight( taskWidth, taskHeight, $childData, childrenForcedAddDirection, additionalInformation, compLevel );
					}
					
				}
				
				if( parentForcedAddDirection ) {
					
					if( parentForcedAddDirection == 'horizontal' ) {
						
						compositeSize = thi$.addHorizontal(compositeSize, compSize.widthCaseHorizontal? compSize.widthCaseHorizontal: compSize);
						
					} else if( parentForcedAddDirection == 'vertical' ) {
						
						compositeSize = thi$.addVertical(compositeSize, compSize.heightCaseVertical? compSize.heightCaseVertical: compSize);
						
					}
					
				} else {

					
					var temp = thi$.addHorizontal(compositeSize, compSize.widthCaseHorizontal? compSize.widthCaseHorizontal: compSize);
					
					if (temp.width > taskWidth){
						compositeSize = thi$.addVertical(compositeSize, compSize.heightCaseVertical? compSize.heightCaseVertical: compSize);
					} else {
						compositeSize = temp;
					}
					
				}
				
				if (compositeSize.width > taskWidth){
					compositeSize.width = taskWidth;
				}
				
			}
//			}); // end .each
			
			if( $data.length > 0 ) {
				this.cl( tagName + '\t- height: ' + compositeSize.height.toFixed(0) + '\t width: ' + compositeSize.width.toFixed(0) ) ;
			}
			
//			console.group( groupName ) ;
			console.groupEnd( groupName ) ;
			
			return compositeSize;
		},
		getimageviewerCompositeSize : function($childData, taskWidth){
			return  {width: 150, height: 150};
		},

		getmediaplayerCompositeSize : function($childData, taskWidth){
			return {width: 120, height: 120};
		},
						

		gettextviewerCompositeSize: function($childData, taskWidth){
			var compSize = {width:0, height:0};
			var tvText = $childData.text().trim(), 
			charSum = tvText.length,
			linesSum = 0;

			compSize.width = compSize.height = Math.sqrt(charSum * 220);

			$childData.find('h1, h2, h3, br, p, li, hr').each(function(){ linesSum++; });

			compSize.height += linesSum * 30;

			if (compSize.width < 50){
				compSize.width = 50;
				compSize.height = 30;
			} else if (compSize.width > taskWidth){
				compSize.width = taskWidth;
				compSize.height = (charSum * 300) / taskWidth;
			} else if (compSize.width < 250){
				compSize.width = 250;
				compSize.height = (charSum * 300) / 250;
			}

			return compSize;
		},
		
		getTaskAdditionalInformation: function(taskData){

			var additionalInformation = {};
			switch($(taskData).attr('type')){

				case 'mtq':{
					additionalInformation.type = 'mtq';

					var bank = $(taskData).find('mtqbank');
					if(bank.length){
						additionalInformation.hasBank =	 true;
						var subanswers =$(bank).find('subanswer');
						if(subanswers.length){
							additionalInformation.answerType = subanswers[0].children[0].tagName.toLowerCase();
						}

						var multisubanswer = $(taskData).find('multisubanswer');
						if(multisubanswer.length){
							var max_in_array = 0;
							$(multisubanswer).each(function(index, item){
								var setElement = $(item).find('set');
								if(setElement.length){
									var setList = $(setElement[0]).text();
									itemsCount =  setList.split(',').length;
									if(itemsCount > max_in_array){
										max_in_array = itemsCount;
									}
								}

							});
							additionalInformation.max_in_array = max_in_array;

						}
					}
					
					break;
				}
			}

			return additionalInformation;
		},
		
		plusMargins : function(size, margins){
			return this.mergeSizes(size, {width: margins, height: margins});
		},
		
		mergeSizes : function(size1, size2){
			return {width: (size1.width + size2.width), height: (size1.height + size2.height)};
		},
		
		addHorizontal : function(size1, size2){
			return {width : (size1.width + size2.width), height: (size1.height > size2.height ? size1.height : size2.height)};
		},
		
		addVertical : function(size1, size2){
			return {width : (size1.width > size2.width ? size1.width : size2.width), height: (size1.height + size2.height)};
		},
		
		cl : function(msg){
			console.log('[COMPILER LOG] ' + msg);
		},
		
		filterPermutations: function ( type, perms, config ) {
			
			console.groupCollapsed( "filterPermutations" ) ;
			
			// accumulate filters definitions
			var filters = [] ;
			var filteredPerms = perms ;
			
			// get minimal task width by tasks type type
			var minTaskWidth = this.getMinTaskWidth( config ) ;
			
			// V or H
			var screenRatio = config.width / config.height ;
			
			// handle shared permutations
			if( type == "shared" ) {
				
				// ratio is horizontal --> remove horizontal
				if( screenRatio >= 1 ) {
					
					filters.push( { key: "type", func: function( t ) {
						console.log( " - type --> ", t, " remove --> horizontal" ) ;
						// keep when not horizontal
						return t != 'horizontal' ;
					} } ) ;
					
				}
				
				// ratio is vertical --> remove vertical
				else {
					
					filters.push( { key: "type", func: function( t ) {
						console.log( " - type --> ", t, " remove --> vertical" ) ;
						// keep when not vertical
						return t != 'vertical' ;
					} } ) ;
					
				}
				
				// remove when no width for min task
				filters.push( { key: "ratio", func: function( r, perm ) {
					// ignore filter when horizontal - no task width change
					if( perm.type == "vertical" ) {
						var overrideRatio = perm.overrideTasksRatio ;
						// r --> 1-100 value in string, representing shared area ratio
						// get task list part (1-x)
						var taskListRatio = ( overrideRatio ? overrideRatio : r*1 ) / 100 ;
						// get task list width from config and ratio
						var taskListWidth = taskListRatio * config.width ;
						console.log( " - ratio --> ", taskListRatio, " taskListWidth --> ", taskListWidth, " minTaskWidth --> ", minTaskWidth ) ;
						// keep when enough width
						return taskListWidth > minTaskWidth ;
					} else {
						return true ;
					}
				} } ) ;
			}

			// handle simple permutations
			if( type == "simple" ) {

				// remove when no width for min task
				filters.push( { key: "tasksWidth", func: function( em ) {
					// simple task list width is definded by em
					// convert to px
					var taskWidth = em * 14 ;
					console.log( " - taskWidth --> ", taskWidth, " minTaskWidth --> ", minTaskWidth, " config.width --> ", config.width ) ;
					// in case permutation fits config.width
					if( taskWidth < config.width ) {
						// keep when enough width for min task width
						return taskWidth > minTaskWidth ;
					} else {
						return false ;
					}
				} } ) ;
				
			}
			
			
			console.log( "initial permutations count --> " + perms.length) ;
			
			var self = this ;
			
			
			// apply filters collection on permutation list
			$(filters).each( function( index, filter ) {
				console.log( "perm filter by --> ", filter.key ) ;
				// get the filteres list
				filteredPerms = self.filterPermutationsBy( filteredPerms, filter.key, filter.func ) ;
				console.log( "current permutations count --> " + filteredPerms.length) ;
			} ) ;

			console.groupEnd( "filterPermutations" ) ;
			
			return filteredPerms ;
		},
		
		filterPermutationsBy: function( perms, key, func ){
			
			// start with blank list
			var filtered = [] ;
			
			// on each permutation
			$(perms).each( function( index, perm ) {
				
				// get function valuefor deciding on keeping permutation
				if( func( perm[ key ], perm ) ) {
					
					// keep
					filtered.push( perm ) ;
					
				}
				
			} ) ;
			
			return filtered ;
			
		},
		
		getMinTaskWidth: function( config, sizeKey ) {
			
			var thi$ = this ;
			
			// array to contain minimal width for the different tasks within the sequence
			var minWidths = [] ;
			
			var $data = $( config.data ) ;
			
			// get tasks data
			var tasks = $data.find( 'task' ) ;
			
			var tasksSizesLog = "" ;
			
			tasks.each( function( index, task ) {
				
				var $task = $( task ) ;
				
				// get task type
				var taskType = $task.attr( 'type' ) ;
				
				// is using bank in task ?
				var hasBank = $task.find( "bank" ).length > 0
				// is using table in task ?
				var hasTable = $task.find( "answer tablecomp" ).length > 0
				
				var taskTypeKey = taskType ;
				taskTypeKey += ( hasTable ? "_table" : "" ) ;
				taskTypeKey += ( hasBank ? "_bank" : "" ) ;
				
				var taskSize = thi$.getTaskSizes( taskTypeKey, sizeKey ? sizeKey : "min" ) ;
				
				var wpx = 14 * taskSize.width ;
				
				tasksSizesLog += taskTypeKey + ":" + wpx + "px " ;
				
				// collect values
				minWidths.push( wpx ) ;
				
			} ) ;
			
			// get the max val from array
			var max_in_array = Math.max.apply(Math, minWidths);
			
			console.log( "[DL][Compiler] --> get tasks " + sizeKey + " width, max value: "+ max_in_array +"px from tasks: " + tasksSizesLog ) ;
			
			return max_in_array ;
		},
		
		getTaskSizes: function( taskKey, sizeKey ) {
			
			var taskSizes = this.tasksSizesMap[ taskKey ] ;
			var size ;
			
			if( taskSizes ) {
				size = taskSizes[ sizeKey ] ;
			} else {
				size = this.tasksSizesMap[ "default" ][ sizeKey ] ;
			}
			
			if( !size ) {
				console.error( "unmapped size key - use min/max etc..." ) ;
			}
			
			return size ;
		},
		
		// REM Sizes
		tasksSizesMap: {
			"default": {
				"min" : { width:	25,	height:			8 },
				"max" : { width:	55,	heightSubVP:	3 }
			},
			"applet" : {
				"min" : { width:	49,	height:			8 },
				"max" : { width:	65,	heightSubVP:	3 }
			},
			"mtq_bank" : {
				"min" : { width:	25,	height:			8 },
				"max" : { width:	65,	heightSubVP:	3 }
			},
			"cloze_bank" : {
				"min" : { width:	55,	height:			11 },
				"max" : { width:	65,	heightSubVP:	3 }
			},
			"cloze_table" : {
				"min" : { width:	37,	height:			11 },
				"max" : { width:	65,	heightSubVP:	3 }
			},
			"cloze_table_bank" : {
				"min" : { width:	55,	height:			11 },
				"max" : { width:	65,	heightSubVP:	3 }
			}
		},
		
		getCompilePermutations: function( type, config ) {

			var sharedGrades = t2k.compile.GradingConfig.sequence.shared;

			var colGrade = sharedGrades.collapsed.grade;
			var colDesc = sharedGrades.collapsed.description;
			var horizGrade = sharedGrades.horizontal.grade;
			var horizDesc = sharedGrades.horizontal.description;

			// "id" reffers to type and the task list share in %, "ratio" containes shared area share in %
			var compilePermutations = {
				base:
					[
						{ id: 'base' }
					],

				simple:
					[
					 	{ id: 'tasks_max',			hasMargin:true,		tasksWidth:65, factor:1 }
						,
						{ id: 'tasks_large',		hasMargin:true,		tasksWidth:55, factor:1 }
//						,
//						{ id: 'tasks_small',		hasMargin:true,	 tasksWidth:49, factor:1 }
					],


				shared:
					[
						{ id: 'Portrait_60',		type:"vertical",	ratio:"40",		collapse:false,	factor: 1,		gradeDescriptions: null,					baseGrades: null }
						,
						{ id: 'Portrait_50',		type:"vertical",	ratio:"50",		collapse:false,	factor: 1,		gradeDescriptions: null,					baseGrades: null }
						,
						{ id: 'Portrait_67',		type:"vertical",	ratio:"33",		collapse:false,	factor: 1,		gradeDescriptions: null,					baseGrades: null }
						,
						{ id: 'Portrait_33',		type:"vertical",	ratio:"67",		collapse:false,	factor: 1,		gradeDescriptions: null,					baseGrades: null }
						,
						{ id: 'Portrait_col',		type:"vertical",	ratio:"10",		collapse:true,	factor: 1.1,	overrideTasksRatio: 100,	gradeDescriptions: [colDesc],				baseGrades: [colGrade] }
						,
						{ id: 'Landscape_50',		type:"horizontal",	ratio:"50",		collapse:false,	factor: 1,		gradeDescriptions: [horizDesc],				baseGrades: [horizGrade] }
						,
						{ id: 'Landscape_67',		type:"horizontal",	ratio:"33",		collapse:false,	factor: 1,		gradeDescriptions: [horizDesc],				baseGrades: [horizGrade] }
						,
						{ id: 'Landscape_33',		type:"horizontal",	ratio:"67",		collapse:false,	factor: 1,		gradeDescriptions: [horizDesc],				baseGrades: [horizGrade] }
						,
						{ id: 'Landscape_col',		type:"horizontal",	ratio:"10",		collapse:true,	factor: 1.1,	overrideTasksRatio: 100,	gradeDescriptions: [horizDesc, colDesc],	baseGrades: [horizGrade, colGrade] }

					]
			};
			
			var filteredPermutations = CompilerUtils.filterPermutations( type, compilePermutations[ type ], config ) ;
			
			return filteredPermutations ;
		},
		
		getSequenceLayoutProps: function( config ) {
			
			var defaultProps = {
				hasMargin: true,
				creativeTasksWidth: 55
			} ;
			
			var props = {} ;
			
			switch( config.type ) {
				
				case "simple" :
					props = this.getSequenceLayoutSimpleProps( config ) ;
					break ;
					
				case "shared" :
					props = this.getSequenceLayoutSharedProps( config ) ;
					break ;
					
				default :
					console.error( "sequence type attribute is missing" ) ;
					break ;
			} ;
			
			var layoutProps = $.extend( {}, defaultProps, props ) ;
			
			return layoutProps ;
		},
		
		getSequenceLayoutSimpleProps: function( config ) {
			
			var cfgWidthNoMargin = config.width - 3.5*14 ;
			
			var maxPossibleTaskListWidth ;
			
			var maxTaskWidth = this.getMinTaskWidth( config, "max" ) ;
			var defaultTaskWidth = 14 * this.getTaskSizes( "default", "max" ).width ;
			var minTaskWidth = this.getMinTaskWidth( config, "min" ) ;
			
			var tasksWidths = [
			                   maxTaskWidth,
			                   defaultTaskWidth,
			                   minTaskWidth,
			                   cfgWidthNoMargin - 13 * 14,
			                   cfgWidthNoMargin - 37 * 14,
			                   cfgWidthNoMargin - 54 * 14
			] ;
			
			// sort + remove duplicates
			tasksWidths.sort() ;
			tasksWidths.reverse() ;
			for ( var i = 1; i < tasksWidths.length; i++ ) {
				if ( tasksWidths[i] === tasksWidths[ i - 1 ] ) {
					tasksWidths.splice( i--, 1 );
				}
			}
			
//			
//			////////////////////////////////////////////////////////
//			// TDOD instead all the mess next (array stuff)
//			////////////////////////////////////////////////////////
//			// put all possible values in an array
//			// sort the array
//			// remove duplicated from array
//			// choose the largest value that fits VP to start with
//			////////////////////////////////////////////////////////
//			
//			addWidthToArray( defaultTaskWidth ) ;
//			addWidthToArray( minTaskWidth ) ;
//			addWidthToArray( cfgWidthNoMargin ) ;
//			
//			function addWidthToArray( width ){
//				
//				var addAtEnd = true ;
//				var useValue = true ;
//				
//				// helper function to add width to an array in a specific index
//				function addToArrayAt( addInto ) {
//					tasksWidths.splice( addInto, 0, width ) ;
//					addAtEnd = false ;
//				}
//				
//				// find the right place for config.width to be added
//				var i, w ;
//				for( i = 0 ; i < tasksWidths.length ; i++ ) {
//					var w = tasksWidths[ i ] ;
//					if( w < cfgWidthNoMargin ) {
//						addToArrayAt( i ) ;
//						break ;
//					}
//					else if( w == width ) {
//						addAtEnd = false ;
//						useValue = false ;
//						break ;
//					}
//				}
//				// in case it was not added yet, add at the end
//				if( addAtEnd && useValue ) {
//					addToArrayAt( tasksWidths.length ) ;
//				}
//				
//			}
//			
//			
			
			if( maxTaskWidth <= cfgWidthNoMargin ) {
				
				maxPossibleTaskListWidth = maxTaskWidth ;
				
			} else if( defaultTaskWidth <= cfgWidthNoMargin ) {
				
				maxPossibleTaskListWidth = defaultTaskWidth ;
				
			} else if( minTaskWidth <= cfgWidthNoMargin ) {
				
				maxPossibleTaskListWidth = minTaskWidth ;
				
			} else {
				
				console.warn( "[DL][Compiler] --> using task width below minimum" ) ;
				maxPossibleTaskListWidth = cfgWidthNoMargin ;
				
			}
			
			var selectedWidth = maxPossibleTaskListWidth ;
			
			var $creativeData = $( config.data ).children( "creativeset" ) ;
			var hasCreative = !!( $creativeData[0] ) ;
			var hasCreativeMargin = $creativeData.children( "asset[name='margin']" ).length > 0 ;
			
			if( hasCreative && hasCreativeMargin ) {
								
				var spaceForMargin ;
				
				console.log( "[DL][Compiler] --> try max task width of: " + selectedWidth + "px" ) ;
				
				spaceForMargin =  ( cfgWidthNoMargin - selectedWidth ) / 14 ;
				
				var currentWidthIndex = tasksWidths.indexOf( maxPossibleTaskListWidth ) ;
				var canUseLower = currentWidthIndex < ( tasksWidths.length - 1 ) ;
				
				var marginFit = spaceForMargin > 13 ;
				console.log( "[DL][Compiler] --> margin fit ? --> " + ( marginFit ? "yes" : "no" ) ) ;
				
				if( !marginFit && canUseLower ) {
					
					var lowerWidthIndex = currentWidthIndex + 1 ;
					var lowerWidth = tasksWidths[ lowerWidthIndex ] ;
					
					spaceForMargin =  ( cfgWidthNoMargin - lowerWidth ) / 14 ;
					marginFit = spaceForMargin > 13 ;
					
					console.log( "[DL][Compiler] --> try lower task width of: " + lowerWidth + "px" ) ;
					
					if( marginFit ) {
						
						console.log( "[DL][Compiler] --> margin fits in lower width" ) ;
						
						var isOverflowing = this.hasOverflowingTask( lowerWidth, config ) ;
						// check overflow
						if( !isOverflowing ) {
							selectedWidth = lowerWidth ;
							console.log( "[DL][Compiler] --> no overflow" ) ;
						} else {
							console.log( "[DL][Compiler] --> overflow, go back to: " + selectedWidth + "px" ) ;
						}
					}
					else {
						console.log( "[DL][Compiler] --> margin does not fit in lower width" ) ;
					}
				}
			}
			else {
				console.log( "[DL][Compiler] --> no margin or any creative wrapper" ) ;
			}
			
			
			console.log( "[DL][Compiler] --> using max task width of: " + selectedWidth + "px" ) ;
			
			var tasksWidthEM =  selectedWidth / 14 ;
			
			return {
				creativeTasksWidth: tasksWidthEM,
				hasMargin: true,
				
				// props here, else it's won't work properly
				ratio: 100,
				isVertical:true,
				isHorizontal:false,
				orientation: "vertical",
				isReadingDirection: false,
				isCollapse: false,
				isShared: false,
				sharedPosition: "right",
				sharedContentDiffWidth: 0,
				sharedContentDiffHeight: 0	
				
			} ;
		},
		
		getSequenceLayoutSharedProps: function( config ) {
			
			// check task list widths [ max(65/55), between(vp.w-shared.w), min(37-25) ]
			// X
			// with shared content [ max, min ] (depending on shared content type)
			
			var COLLAPSED_SHARED_RATIO = 10 ;
			
			var cfgWidthNoMargin = config.width - 2 * 14 ;
			
			var maxTaskWidth = this.getMinTaskWidth( config, "max" ) ;
			var defaultTaskWidth = 14 * this.getTaskSizes( "default", "max" ).width ;
			var minTaskWidth = this.getMinTaskWidth( config, "min" ) ;
			
			var tasksWidths = [ maxTaskWidth, defaultTaskWidth, minTaskWidth ] ;
			
			var $sharedComponent = $( config.data ).children( "shared" ).children( "sharedarea" ).children().get( 0 ) ;
			
			var componentName = $sharedComponent.localName ;
			
			var sharedContentMax = this.getSharedComponentSize( componentName, $sharedComponent, "max" ).width ;
			var sharedContentMin = this.getSharedComponentSize( componentName, $sharedComponent, "min" ).width ;
			
			var sharedWidth = 0 ;
			var collapse = false ;
			var reduceSharedWidthBy = 0 ;
			
			function setSharedValues() {
				console.log( "[DL][Compiler] --> collapse" ) ;
				sharedWidth = sharedContentMax ;
				collapse = true ;
				reduceSharedWidthBy = Math.floor( ( config.width * ( 100 - COLLAPSED_SHARED_RATIO ) / 100 - sharedWidth ) )
				console.log( "[DL][Compiler] --> collapse shared optimize by reducing: " + reduceSharedWidthBy + "px" ) ;
			}
			
			if( config.forceCollapsedShared ){
				
				setSharedValues() ;
				
			} else {
				
				if( ( maxTaskWidth + sharedContentMax ) <= cfgWidthNoMargin ) {
					console.log( "[DL][Compiler] --> maxTaskWidth + sharedContentMax" ) ;
					sharedWidth = sharedContentMax ;
				}
				else if( ( maxTaskWidth + sharedContentMin ) <= cfgWidthNoMargin ) {
					console.log( "[DL][Compiler] --> maxTaskWidth + sharedContentMin" ) ;
					sharedWidth = sharedContentMin ;
				}
				else if( ( defaultTaskWidth + sharedContentMax ) <= cfgWidthNoMargin ) {
					console.log( "[DL][Compiler] --> defaultTaskWidth + sharedContentMax" ) ;
					sharedWidth = sharedContentMax ;
				}
				else if( ( defaultTaskWidth + sharedContentMin ) <= cfgWidthNoMargin ) {
					console.log( "[DL][Compiler] --> defaultTaskWidth + sharedContentMin" ) ;
					sharedWidth = sharedContentMin ;
				}
				else if( ( minTaskWidth + sharedContentMax ) <= cfgWidthNoMargin ) {
					console.log( "[DL][Compiler] --> minTaskWidth + sharedContentMax" ) ;
					sharedWidth = sharedContentMax ;
				}
				else if( ( minTaskWidth + sharedContentMin ) <= cfgWidthNoMargin ) {
					console.log( "[DL][Compiler] --> minTaskWidth + sharedContentMin" ) ;
					sharedWidth = sharedContentMin ;
				} else {
					setSharedValues() ;
				}
				
			}
			
			var sharedRatio = Math.ceil( 100 * sharedWidth / config.width ) ;
			var ratio = collapse ? COLLAPSED_SHARED_RATIO : 100 - sharedRatio ;
			
			console.log( "[DL][Compiler] --> shared percent from VP : " + sharedRatio + "%" ) ;
			
			return {
				ratio: ratio,
				hasMargin: false,
				isVertical:true,
				isHorizontal:false,
				orientation: "vertical",
				isReadingDirection: false,
				isCollapse: collapse,
				isShared: true,
				sharedPosition: "right",
				sharedContentDiffWidth: reduceSharedWidthBy,
				sharedContentDiffHeight: 0	
			} ;
		},
		
		getSharedComponentSize: function( componentKey, componentData, sizeKey ) {
				
			var size ;
			var key ;
				
			if( componentKey ) {
				
				switch( componentKey ) {
					
					case "applet" : {
						var appPath =  $(componentData).attr( "path" ) ;
						var appID = this.extractGuid( appPath ).toLowerCase() ;
						size = this.getAppletSizeFromMap( appID ) ;
						break ;
					}
					
					case "imageviewer" : {
						var imgWidth = 1 * $(componentData).attr( "width" ) ;
						imgPaddingInShared = 2*2*14; //(in rem)
						
						if( sizeKey == "max" ) {
							size = { width: imgWidth } ;
						} else if ( sizeKey == "min" ) {
							var imgMinRead = 1 * $(componentData).attr( "minimumreadable" ) ;
							size = { width: imgWidth * imgMinRead + imgPaddingInShared} ;
						}
						break ;
					}
					
					case "mediaplayer" : {
						var mediaType = $(componentData).attr( "type" ) ;
						key = componentKey + "_" + mediaType + "_" + sizeKey ;
						size = this.getSharedComponentSizeFromMap( key ) ;
						break ;
					}
						
					default : {
						key = componentKey + "_" + sizeKey ;
						size = this.getSharedComponentSizeFromMap( key ) ;
						if( !size ) {
							console.log( "[DL][Compiler] --> can't find size for component : " + key ) ;
							key = componentKey + "_" + "max" ;
							console.log( "[DL][Compiler] --> trying max component size as default : " + key ) ;
							size = this.getSharedComponentSizeFromMap( key ) ;
						}
						if( !size ) {
							size = this.getCompiledHeight( 10000, 10000, $(componentData) ) ;
						}
						if( !size ) {
							console.warn( "[DL][Compiler] --> unhandled component size : " + componentKey + "_" + sizeKey ) ;
						}
						break ;
					}
				}
			}
			
			if( !size ) {
				size = this.getSharedComponentSizeFromMap( "default" ) ;
				console.error( "[DL][Compiler] --> can't match component size, using default" ) ;
			}

			size.width += 1*14 // add shared border
			
			console.log( "[DL][Compiler] --> "+ sizeKey +" \""+ componentKey +"\" component size : " + size.width + "px" ) ;
			
			return size ;
		},
		
		getSharedComponentSizeFromMap: function( key ) {
			var size = this.sharedComponentSizesMap[ key ] ;
			var extended =  $.extend( true, {}, size ? size : {} ) ;
			return size ? extended : null ;
		},
		
		sharedComponentSizesMap: {
			"default": {
				width: 350 + 2*1.5*14
			},
			"mediaplayer_video_max": {
				width: 640 + (2*2*14)
			},
			"mediaplayer_video_min": {
				width: 450 + (2*2*14)
			},
			"mediaplayer_audio_max": {
				width: 250 + (2*2*14)
			},
			"mediaplayer_audio_min": {
				width: 250 + (2*2*14)
			},
			"mediaplayer_soundButton_max": {
				width: 50 + (2*2*14)
			},
			"mediaplayer_soundButton_min": {
				width: 50 + (2*2*14)
			},
			"textviewer_max": {
				width: 500 + ((3+4 + 1)*14) //scroll+paddings
			},
			"textviewer_min": {
				width: 300 + ((2*3+1)*14)
			},
			"dialog_max": {
				width: 550 + (5*14)
			},
		},
		
		getAppletSizeFromMap: function( appID ) {
			var size = this.appletsSizeMap[ appID ] ;
			if( !size ) {
				console.warn( "[DL][Compiler] --> unmapped applet : " + appID ) ;
				size = this.appletsSizeMap[ "default" ] ;
			}
			
			size = $.extend( {}, size ) ;
			
			size.width += 2*2*14 ;
			
			return size ;
		},
		
		// finds first occurrence of a GUID within square brackets in a string
		extractGuid: function( value ) {    
			var re = /([a-z0-9]{8}(?:-[a-z0-9]{4}){3}-[a-z0-9]{12})/i;
		    // the RegEx will match the first occurrence of the pattern
		    var match = re.exec(value);
		    
		    // result is an array containing:
		    // [0] the entire string that was matched by our RegEx
		    // [1] the first (only) group within our match, specified by the
		    // () within our pattern, which contains the GUID value
		    return match ? match[1] : null ;
		},
		
		appletsSizeMap: {
			"default" : {  width: 650, height: 650 },
			"ca4920e5-2cb3-4e81-b18e-bf0ffa427c09" : { width: 630, height: 590 },
			"37f6eb06-e485-11e2-9909-f7f76188709b" : { width: 646, height: 606 },
			"d8c53f84-311e-4312-83a8-33a9821170ac" : { width: 630, height: 590 },
			"fbfafb43-4c3a-4c99-b5fb-5fef3193cdd5" : { width: 630, height: 590 },
			"aed3db81-8075-4cc4-ae01-9c2e6781cbe5" : { width: 630, height: 590 },
			"76651ce2-4dc3-4732-940d-434b850aa8ee" : { width: 630, height: 590 },
			"44467be7-8255-4765-83ae-30d64db52f57" : { width: 630, height: 590 },
			"83e38345-3f28-453d-9cdd-7a5a2402f3fb" : { width: 630, height: 590 },
			"f7ff8abe-ef10-4042-a963-bab8d5a0a144" : { width: 630, height: 432 },
			"6aa8392e-524e-4fc4-bb2e-ecc050c2dc0a" : { width: 618, height: 590 },
			"3e684854-b163-11e2-957f-47566188709b" : { width: 618, height: 560 },
			"7ee92a74-99ee-11e2-935c-337d6188709b" : { width: 618, height: 560 },
			"685c0ca4-99ee-11e2-b908-2d7d6188709b" : { width: 560, height: 560 },
			"ee97adf0-8edb-11e2-bfd2-2ca76188709b" : { width: 550, height: 560 },
			"43a85a09-812e-488e-9adf-43eb92c8b4b9" : { width: 407, height: 490 },
			"0b8fd662-0cde-40a9-8cd9-81af538d7e9f" : { width: 365, height: 460 },
			"0c4b69e4-ae4b-49b7-be6f-a422bbc3e435" : { width: 359, height: 151 },
			"7db50320-2a72-11e3-8224-0800200c9a66" : { width: 794, height: 416 }
		},
		
		hasOverflowingTask: function( testWidth, config ) {
			
			var $tasks = $( config.data ).find( "tasks" ).find( "task" ) ;
			
			var isOverflowing = false ;
			
			for( var i = 0 ; i < $tasks.length ; i++ ) {
				
				var $taskData = $( $tasks[i] ) ;
				
				var extraHeight = 0 ;
				var taskGuestimatedHeight = this.compileTaskHeight( testWidth, $taskData ) ;
				
				if( i == 0 ) {
					var header = $( config.data ).children( "header" )[0] ;
					var instruction = $( config.data ).children( "instruction" )[0] ;
					extraHeight += header ? 100 : 0 ;
					extraHeight += instruction ? 100 : 0 ;
					extraHeight && console.log( "[DL][Compiler] --> calc 1st task with sequence header/instruction extra: " + extraHeight + "px" ) ;
				
				}
				
				extraHeight += 3*14 ;
				
				var totalHeight = taskGuestimatedHeight + extraHeight ;
				extraHeight && console.log( "[DL][Compiler] --> task[" + ( i + 1 ) + "] --> guesstimated height (+3rem): " + totalHeight + "px" ) ;
				
				if( totalHeight > config.height ) {
					var overflowPercent = parseInt( 100 * ( totalHeight / config.height - 1 ) ) ;
					console.log( "[DL][Compiler] --> detected overflow: " + overflowPercent + "%" ) ;
					isOverflowing = true ;
					break ;
				}
			}
			
			return isOverflowing ;
		},
		
		enhanceConfigForLayouting: function( config ) {
			var jqXml = jQuery(config.data);
			var tasks = jqXml.find('task');

			var sharedArea = jqXml.find('sharedArea').get(0);
			sharedArea = (CompilerUtils.setNumOfChildren(sharedArea));

			jQuery(tasks).each(function(index, task) {
				var task = jQuery(task);
				var question = task.find('question').get(0);
				var answer = task.find('answer').get(0);
				var help = task.find('help').get(0);

				// group xml data
				question = (CompilerUtils.groupData(question));
				answer = (CompilerUtils.setNumOfChildren(answer));
				help = (CompilerUtils.groupData(help));
			});

			return config;
		}

	}; // End of t2k.util.CompilerUtils

} )();

// Shorthands
var CompilerUtils = t2k.util.CompilerUtils;

////////////////////////////////////////
// SRC End --> t2k/util/CompilerUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/StringUtils.js
////////////////////////////////////////
(function() {

    /**
     * Class: t2k.util.StringUtils
     * Contains string manipulation/formatting/etc. utilities
     */
    t2k.util.StringUtils = {
        /**
         * Method: formatNumber
         *
         * Params:
         *  number - the number to format.
         *  format - the format to follow.
         */
        formatNumber: function(number, format) {
            var ret = '';
            if (format != 'none') {
                var charCode = String(format).charCodeAt(0) + parseInt(number) - 1;
                if (format != 'a'&& format != 'A') {
                    if (number >= 10 && format == '1') { // numbers
                        decades = String(format).charCodeAt(0) + (Math.floor(number / 10)) - 1;
                        singles = String(format).charCodeAt(0) + (Math.round(number % 10)) - 1;
                        ret = String.fromCharCode(decades) + String.fromCharCode(singles) ;
                    } else if (number >= 10){ // hebrew
                        if (number == 14) { // tet vav
                            singles = String(format).charCodeAt(0) + 5;
                            decades = String(format).charCodeAt(0) + 8;

                        } else if (number == 15) {
                            singles = String(format).charCodeAt(0) + 6;
                            decades = String(format).charCodeAt(0) + 8;
                        } else {
                            singles = String(format).charCodeAt(0) + (Math.round(number % 10));
                            decades = String(format).charCodeAt(0) + (Math.floor(number / 10)) + 8;

                        }
                        ret = String.fromCharCode(decades) + String.fromCharCode(singles);
                    }
                    else {
                        ret = String.fromCharCode(charCode);
                    }
                } else {
                    ret = String.fromCharCode(charCode);
                }
            }
            
            ret = ret + ( format =="1" ? "." : "" ) ;
            
			return ret;
        }

	};

})();


////////////////////////////////////////
// SRC End --> t2k/util/StringUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/managers/MediaManager.js
////////////////////////////////////////
/**
 * @class t2k.util.managers.MediaManager
 *
 *
 */

t2k.util.managers.MediaManager = function (controlType) {

    /**
     * This is a reference to the custom controlbar element
     * incase null we use the built in control
     */
    this.control;
    this.controlType = controlType;

    this.currentItem; //the current media dom element (audio or video)

    this.volume = 1;
    //this.flashItems = [];
    //this.mediaItems = {};
    //this.playbackQueue = {};
    this.preloadQueue = {};

    //Initialize control bar
    if (this.controlType != undefined) {
        templatesLoader.loadComponentTemplate(this.controlType, this, this.attachControl);
    }

};
t2k.util.managers.MediaManager.prototype = {
    init:function () {
        //setters

    },

    /**
     * Having loaded the control bar we can now utilize and show it
     * wherever a media interaction occurs, play, pause
     */
    attachControl:function () {
        //jQuery(Mustache.to_html(this.controlType, this.mediaConfig)).appendTo( "#" + this.currentItem.id );
        jQuery(this.control).bind('onclick', this.togglePlay);
    },

    setMedia:function (media, isObject) {
        //pause the current media (the old one)
        if (this.currentItem) {
            if (this.currentItem != media) {
                this.pause();
            }

        }

        //change currentItem to the new one
        if (this.currentItem != media) {
            if (isObject) {
                //in this case mediaItem is an object
                this.currentItem = media;
                this.currentItem.volume = this.volume;
            } else {
                //the mediaItem is not an object its a div, than media is actually Id
                this.currentItem = Perf.select("#" + media)[0];
                this.currentItem.volume = this.volume;
            }
        }
    },
    /*register : function(mediaId, mediaConfig){

     this.mediaItems[mediaId] = mediaConfig;
     },*/

    /*registerFlash : function(flashInstance){
     console.log('flash registered');
     this.flashItems.push(flashInstance);
     },*/

    canPlayType:function (type) {
        return this.currentItem.canPlayType(type);
    },

    /*pauseAll : function(){
     for(var mediaId in this.mediaItems){
     jQuery("#" + mediaId).pause();
     }

     //2 different ways of doing the same thing
     jQuery.each(this.flashItems, function (i,flash) {
     flash.pause();
     })

     for(var flash in this.flashItems){
     this.flashItems[flash].pauseFlashSound();
     }
     },*/
    load:function () {
        this.currentItem.load();
    },
    loadAll:function () {
        for (var mediaId in this.mediaItems) {
            Perf.select("#" + mediaId).load();
        }
    },

    play:function () {
        if (this.currentItem) {
            this.currentItem.play();
        }
    },
    togglePlay:function () {
        if (this.currentItem) {
            if (this.currentItem.paused) {
                this.currentItem.play();
            } else {
                this.currentItem.pause();
            }
        }

    },
    pause:function () {
        if (this.currentItem && this.currentItem.readyState > 0) {
            this.currentItem.pause();
        }

    },
    pauseAll:function () {
//        for (var mediaId in this.mediaItems) {
//            Perf.select("#" + mediaId).pause();
//        }
        if(this.currentItem){this.currentItem.pause();}
    },
    addVideo:function (parentId, vidURL) {
        var vid, makevid;
        vid = document.createElement('video');
        vid.src = vidURL;
        vid.setAttribute('autoplay', true);
        Perf.select("#" + parentId).append(vid);
    },

    setVolume:function (volume) {
    	
    	if( volume !== 0 && !volume ) {
    		volume = 1 ;
    	}
    	
        //todo decide on volume range (0,1) or (0,100) and coordinate with dtp
        //right now we support both this code need to be deleted when decision is made
        while (volume > 1) {
            volume = volume/100;
        }

        if (this.currentItem) {
            this.currentItem.volume = volume;
        }

    },

    getVolume:function () {
        return this.volume;
    }

};
//initializations
var mediaManager = new t2k.util.managers.MediaManager();



////////////////////////////////////////
// SRC End --> t2k/util/managers/MediaManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/managers/AssessmentManager.js
////////////////////////////////////////
/**
 * @class t2k.util.managers.AssessmentManager
 *
 *
 */

t2k.util.managers.AssessmentManager = function(controlType) {

	this.rubricedSequences = {} ;
    this.AssessableTasksArray = [];
    this.answerViewMode = '';
};


t2k.util.managers.AssessmentManager.prototype = {

    /*
     this function should help create the assessment
     */
    parseAssessmentData : function (config) {
        var thi$ = this;
        jQuery(config.sequencesConfig).each(function(seqIndex, sequenceCfg) {

            var tasksConfig = jQuery(sequenceCfg.data).find("task");
            var seqArrayOfTasks = [];


            jQuery(tasksConfig).each(function(taskIndex, taskCfg) {
                var info = {};
                //TODO change names to sequence , task .
                info.screenId = seqIndex;
                info.template = null; // will get value when task is created
                if(TaskCheckingType[jQuery(taskCfg).attr('type')] != "EXPOSURE" ){
                	info.path = jQuery( taskCfg ).find('progress rubric').attr('id') ;
                    if(TaskCheckingType[jQuery(taskCfg).attr('type')] == 'AUTOMATIC'){
                        info.score = 0;
                    }

                    if(TaskCheckingType[jQuery(taskCfg).attr('type')] == 'MANUAL'){
                        info.manCheck = true;
                    }
                    
                    thi$.rubricedSequences[ seqIndex ] = info.path ;
                    
                }else{
//                    info.path = '';
                }
                    info.isAssessable = false //will be updated after task is created

                //just for test
                //info.score = null;
                //info.rubricId = taskCfg.baseURI + '/' + jQuery(taskCfg).attr('id');
                seqArrayOfTasks[taskIndex] = info;
            });

            thi$.AssessableTasksArray[seqIndex] = seqArrayOfTasks;
        });

    },

    //test

    /*getAssessmentState:function() {
        var arr = [];
        var thi$ = this;
        for (var i = 0 ; i < this.AssessableTasksArray.length; i++) {
            for (var j = 0; j<thi$.AssessableTasksArray[i].length; j++) {
                var o = thi$.AssessableTasksArray[i][j]
                arr.push(o);
            }
        }
        return arr
    },*/

    fetchResult:function() {
        //going over all the data in this.AssessableTasksArray and parse it for the wanted result structuer
        var resArray = [];
        jQuery(this.AssessableTasksArray).each(function(seqIndex, seqAssessableTasks) {
            jQuery(seqAssessableTasks).each(function(taskIndex, assessmentTaskInfo) {

                if( assessmentTaskInfo.path ) {
	                var aInfo = {};
	                aInfo.atomId = assessmentTaskInfo.atomId;
	                aInfo.rubricId = assessmentTaskInfo.path;
	                if ( assessmentTaskInfo.isAssessable ) {
	                	aInfo.score = assessmentTaskInfo.template.getAnswerAssessmentScore();
	                } else {
	                	aInfo.score = 0 ;

	                }

                    if(assessmentTaskInfo.manCheck){
                        aInfo.manCheck = true;
                    }
//	                else if(assessmentTaskInfo.score == 0 /* default for auto*/){
//	                    aInfo.score = 0;
//	                }else{
//	                    aInfo.score = null;
//	                }
	                resArray.push(aInfo);
                }
            }) ;
        });

        return resArray;
    },



    addRealTaskInstanceToArray:function(seqIndex, taskIndex, taskObject) {
    	var assTask = (this.AssessableTasksArray[seqIndex])[taskIndex] ;
    	assTask.template = taskObject;
    	assTask.isAssessable = taskObject.isAssessable();
    	assTask.path = taskObject.getRubricPath() ;
    },

    getSequenceByRubricId : function (rubric) {
        var screenId = null;
        jQuery(this.AssessableTasksArray).each(function(seqIndex, seqAssessableTasks) {
            jQuery(seqAssessableTasks).each(function(taskIndex, assessmentTaskInfo) {
                if (assessmentTaskInfo.path == rubric) {
                    screenId = seqIndex;
                    return
                }
            });

            if (screenId != null) return //this is just to break jQuery each
        });

        return screenId;
        //should return the sequence


    },


    getRubricFromIndex:function(seqIndex, taskIndex, atomId) {
        var infoObj = (this.AssessableTasksArray[seqIndex])[taskIndex];
        if (infoObj) {
            infoObj.atomId = atomId;
            return infoObj.path;
        }
    },

    updateSequenceRubric: function( seqIndex ) {
    	
    	var seqRub = this.rubricedSequences[ seqIndex ] ;
    	
		if( ENV.host.onRubricSwapped ) {
			
    		ENV.host.onRubricSwapped( seqRub ? seqRub : null ) ;
    		
    	}
    	
    }
    

};




////////////////////////////////////////
// SRC End --> t2k/util/managers/AssessmentManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/managers/CreativeLayoutManager.js
////////////////////////////////////////
(function () {

    var FULL_FOOTER = 'full_footer';
    var FOOTER = 'footer';
    var SMALL_MARGIN = 'small_margin';
    var LARGE_MARGIN = 'large_margin';
    var NO_MARGIN = 'no_margin';
    var HUGE_MARGIN = 'huge_margin' // only to know how to center the margin.
    var NO_FOOTER = 'no_footer';
    var NO_CREATIVE = 'no_creative';
    var OVERLAY = 'no_margin';
    var MANUAL = 'manual';
    var AUTOMATIC = 'automatic';
    var MARGIN_HEIGHT = 831;
    var MARGIN_WIDTH = 516;
    var FOOTER_WIDTH = 1024;
    var SMALL_MARGIN_UPPER_BOUND = 37;
    var SMALL_MARGIN_AUTO_LOWER_BOUND = 13;
    var SMALL_MARGIN_MANUAL_LOWER_BOUND = 19.143;
    var SMALL_MARGIN_PENALTY_LOWER_BOUND = 19.143;
    var LARGE_MARGIN_UPPER_BOUND = 54;
    var FOOTER_LOWER_BOUND = 14;
    var FOOTER_UPPER_BOUND = 24.5;
    var FULL_FOOTER_LOWER_BOUND = 24.5;


    t2k.util.managers.CreativeLayoutManager = Object.subClass({

        ctor:function (config, footerDiv, marginDiv, setCfg, gridService) {
            this.footerDiv = footerDiv;
            this.marginDiv = marginDiv;
            this.cfg = config
            this.gs = gridService;
            
            this.layoutStatus = {} ;
            
            this.footerLayout = NO_FOOTER;
            this.marginLayout = NO_MARGIN;
            this.showCreative = true;

            this.parseSetCfg(config.data); //apply properties from set xml element
            
            console.log( "[DL][Creative] --> creative-set type: " + this.setType ) ;
            if (this.setType == AUTOMATIC) {
                this.decideAutoMarginLayout();
                this.decideAutoFooterLayout();
            } else {
                this.decideManualMarginLayout();
                if (this.marginLayout != NO_MARGIN) {
                    this.decideManualFooterLayout();
                }
            }
            
            if( this.marginLayout == NO_MARGIN ){
                
                //penalty
                this.layoutStatus.noMargin = true ;
                
                if(this.footerLayout == NO_FOOTER){
                    //penalty
                    this.layoutStatus.noCreative = true ;
                    
                }
                
            }

            this.placeComponents();
        },

        decideAutoFooterLayout:function () {
//	        this.footerLayout = NO_FOOTER;
//	        return;
        	var footerDivHeight = this.footerDiv.height() ;
            var footerRealEstate = this.gs.getEm(footerDivHeight) ;
            
            console.log( "[DL][Creative] --> footer RE: " + footerDivHeight ) ;

            if (footerRealEstate >= FULL_FOOTER_LOWER_BOUND) {
            	console.log( "[DL][Creative] --> enough RE for full footer, skip margin" ) ;
                this.footerLayout = FULL_FOOTER;
                //change the margin layout back
                this.marginLayout = NO_MARGIN;

                return
            } else {
                if (footerRealEstate >= FOOTER_LOWER_BOUND && footerRealEstate < FOOTER_UPPER_BOUND) {
                	console.log( "[DL][Creative] --> enough RE for small footer" ) ;
                    this.footerLayout = FOOTER;
                    return
                } else {
                    this.footerLayout = NO_FOOTER;
                }

            }

        },

        decideAutoMarginLayout:function () {
            var marginRealEstate = this.gs.getEm(this.marginDiv.width());

            if (marginRealEstate < SMALL_MARGIN_AUTO_LOWER_BOUND) {
            	console.log( "[DL][Creative] --> no RE for margin" ) ;
                this.marginLayout = NO_MARGIN;
            } else {
                if (marginRealEstate >= SMALL_MARGIN_UPPER_BOUND && marginRealEstate < LARGE_MARGIN_UPPER_BOUND) {
                	console.log( "[DL][Creative] --> enough RE for large margin" ) ;
                    this.marginLayout = LARGE_MARGIN;
                } else {
                    if (marginRealEstate >= LARGE_MARGIN_UPPER_BOUND) {
                    	console.log( "[DL][Creative] --> enough RE for huge margin" ) ;
                        this.marginLayout = HUGE_MARGIN;
                    } else {
                        if (marginRealEstate >= SMALL_MARGIN_AUTO_LOWER_BOUND && marginRealEstate < SMALL_MARGIN_UPPER_BOUND) {
                        	console.log( "[DL][Creative] --> enough RE for small margin" ) ;
                            this.marginLayout = SMALL_MARGIN;
                            //penalty for very small "small margin" place
                            if(marginRealEstate < SMALL_MARGIN_PENALTY_LOWER_BOUND){
                                this.layoutStatus.smallMargin = true ;
                            }
                        }
                    }
                }

            }
        },

        decideManualFooterLayout:function () {
            var footerRealEstate = this.gs.getEm(this.footerDiv.height());

            if (footerRealEstate >= FOOTER_LOWER_BOUND && footerRealEstate < FOOTER_UPPER_BOUND) {
                this.footerLayout = FOOTER;
                return
            }

        },

        decideManualMarginLayout:function () {
            var marginRealEstate = this.gs.getEm(this.marginDiv.width());

            if (marginRealEstate < SMALL_MARGIN_MANUAL_LOWER_BOUND) {
                this.marginLayout = OVERLAY; //for now still no_margin
                //penalty for displaying overlay
                this.layoutStatus.overlay = true ;
            } else {
                if (marginRealEstate >= SMALL_MARGIN_UPPER_BOUND && marginRealEstate < LARGE_MARGIN_UPPER_BOUND) {
                    this.marginLayout = LARGE_MARGIN;
                } else {
                    if (marginRealEstate >= LARGE_MARGIN_UPPER_BOUND) {
                        this.marginLayout = HUGE_MARGIN;
                    } else {
                        if (marginRealEstate >= SMALL_MARGIN_MANUAL_LOWER_BOUND && marginRealEstate < SMALL_MARGIN_UPPER_BOUND) {
                            this.marginLayout = SMALL_MARGIN;

                        }
                    }
                }
            }


        },


        parseSetCfg:function (setXml) {
            var pathObject = {};
            jQuery(setXml).find('asset').each(function (index, asset) {
                var relativeSrc = jQuery(asset).attr('src') || jQuery(asset).attr('path') ;
                pathObject[ jQuery(asset).attr('name') ] = AbsPath( relativeSrc ) ;
            });

            this.assetsPath = pathObject;
            this.setType = jQuery(setXml).attr('type');
        },

        placeComponents:function () {
            //added for samsung demo due to bugs in footer
            //todo remove immediately after demo
//            this.footerLayout = NO_FOOTER;

            switch (this.footerLayout) {
                case FULL_FOOTER:
                    var footer = jQuery('<img/>');
                    jQuery(footer).attr('src', this.assetsPath[FULL_FOOTER]);
                    jQuery(footer).css( this.cfg.direction == 'ltr' ? 'left' : 'right', (this.footerDiv.width() - FOOTER_WIDTH  ) / 2);
                    jQuery(footer).addClass(FULL_FOOTER);
                    this.footerDiv.append(footer);
                    break;

                case FOOTER:
                    var footer = jQuery('<img/>');
                    jQuery(footer).attr('src', this.assetsPath[FOOTER]);
                    jQuery(footer).addClass(FOOTER);
                    this.footerDiv.append(footer);
                    break;
            }

            switch (this.marginLayout) {
                case LARGE_MARGIN:
                    var margin = jQuery('<img/>');
                    jQuery(margin).attr('src', this.assetsPath['margin']);
                    // horizontal align margin to the right of the screen
                    // vartical align margin to the
                    if (this.marginDiv.height() >= MARGIN_HEIGHT) {
                        jQuery(margin).css('top', 0);
                    } else {
                        jQuery(margin).css('top', (this.marginDiv.height() - MARGIN_HEIGHT ) / 2);
                    }

                    jQuery(margin).addClass(LARGE_MARGIN);

                    this.marginDiv.append(margin);
                    break;

                case SMALL_MARGIN:
                    var margin = jQuery('<img/>');
                    jQuery(margin).attr('src', this.assetsPath['margin']);
                    if (this.marginDiv.height() >= MARGIN_HEIGHT) {
                        jQuery(margin).css('top', 0);
                    } else {
                        jQuery(margin).css('top', (this.marginDiv.height() - MARGIN_HEIGHT ) / 2);
                    }
                    //align margin to the laft of it's div
                    jQuery(margin).addClass(SMALL_MARGIN);
                    this.marginDiv.append(margin);
                    break;

                case HUGE_MARGIN:
                    var margin = jQuery('<img/>');
                    jQuery(margin).attr('src', this.assetsPath['margin']);

                    if (this.marginDiv.height() >= MARGIN_HEIGHT) {
                        jQuery(margin).css('top', 0);
                    } else {
                        jQuery(margin).css('top', (this.marginDiv.height() - MARGIN_HEIGHT ) / 2);
                    }

                    jQuery(margin).css( this.cfg.direction == 'ltr' ? 'left' : 'right', (this.marginDiv.width() - MARGIN_WIDTH ) / 2);
                    //align margin to the laft of it's div
                    jQuery(margin).addClass(HUGE_MARGIN);
                    this.marginDiv.append(margin);
                    break;

            }
        },

        placeAssetInsideLayout:function () {

        },
        
        getLayoutStatus: function() {
            return this.layoutStatus ;
        }


    })

    t2k.util.creativeWrapperConsts = {


    };
})();









////////////////////////////////////////
// SRC End --> t2k/util/managers/CreativeLayoutManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/GridService.js
////////////////////////////////////////
/**
 * Class t2k.util.grid
 */
(function() {
    t2k.util.GridService = Object.subClass({
        ctor:function (view) {
            this.view = view;
            this.cfg = copy(view.cfg, t2k.util.gridConfig);
            this.em = this._px(this.cfg.em);

            this._calcScale();
            this._temp();
        },

        /**
         * Method: Define
         *
         * define the measures of the passed section
         *
         * Parameters:
         *  type - {String} section type like taskArea or sharedArea.
         *
         * Returns:
         *  {Object} returns object with width and height properties.
         */
        define:function (type) {
            return this[jQuery.camelCase('define-' + type)]();
        },

        /**
         * Method: defineTasksArea
         *
         * define the measures of task area section
         *
         * Returns:
         *  {Object} returns object with width and height properties.
         */
        defineTasksArea:function () {
            var taskAreaWidth = this._getTasksWidth(),
                taskAreaHeight = this._getTasksHeight(),
                gutterWidth = this._px('1em'),
                container = this.view._content,
                tasks = this.view._content_inner,
                wrapper = container.find('.sequence_content_wrapper'),
                marginLeft = container.find('.sequence_margin_left'),
                marginRight = container.find('.sequence_margin_right'),
                taskWidth, taskHeight, marginLeftWidth, marginRightWidth,
                type = ((this.cfg.type == 'shared' && this.cfg.isCollapse) || this.cfg.isHorizontal) ? 'simple' : this.cfg.type;
            if (taskAreaWidth < 800) {
                type = 'shared'; // if we're less than 800px, go to shared mode
            }

            //in case we are in shared that is very big and the task area gets really small we want to reduce margins to be as  little as possible
            if (taskAreaWidth < 518) {
                var gutterLeftWidth = this._px('1em');
            } else {
                var gutterLeftWidth = this._px('1em') * (type == 'shared' && !this.cfg.isCollapse ? 2 : 1);
            }

            //calc initial margin sizes if defined
            //in case we are in shared that is very big and the task area gets really small we want to reduce margins to be as  little as possible
            if (taskAreaWidth < 518 && type == 'shared' && !this.cfg.isCollapse) {
                marginLeftWidth = this._px(this.cfg[type].tasksArea.margins.left.min);
                marginRightWidth = this._px(this.cfg[type].tasksArea.margins.right.optimal);
            } else {
                marginLeftWidth = this._px(this.cfg[type].tasksArea.margins.left.optimal);
                marginRightWidth = this._px(this.cfg[type].tasksArea.margins.right.optimal);
            }
            
            var totalMargins = marginLeftWidth + marginRightWidth + this.orphanX ;
            
            // simple sequence tasks should get the full grid columns width
            if( !this.cfg.isShared ) {
            	taskAreaWidth += totalMargins ;
            }

            //calc tasks width / height
            taskWidth = taskAreaWidth - totalMargins ;
            //remove left margin if no available space
            if (taskWidth > taskAreaWidth - totalMargins) marginLeftWidth = this._px(this.cfg[this.cfg.type]['tasksArea'].margins.left.min);

            //give the margin right all the leftovers
            marginRightWidth = taskAreaWidth - taskWidth - marginLeftWidth;

            //set container (scroll)
            if(this.cfg.hasMargin){
                container.width(this.cfg.width).height(taskAreaHeight);
            }else{
                container.width(taskAreaWidth).height(taskAreaHeight);
            }

            //set wrapper (what holds the content and margins)
            wrapper.width(taskAreaWidth).css('min-height', taskAreaHeight + 'px');

            //set task area
            tasks.width(taskWidth).css('min-height', taskAreaHeight + 'px');

            //set margins
            //in case we are in shared that is very big and the task area gets really small we want to reduce margins to be as  little as possible 
            if (taskAreaWidth < 518 && type == 'shared' && !this.cfg.isCollapse) {
                marginLeft.width(marginLeftWidth - gutterLeftWidth).css('margin-right', gutterLeftWidth);
                marginRight.width(marginRightWidth - gutterWidth).css('margin-left', gutterWidth);
            } else {
                marginLeft.width(marginLeftWidth - gutterLeftWidth).css('margin-right', gutterLeftWidth);
                marginRight.width(marginRightWidth - gutterWidth).css('margin-left', gutterWidth);
            }
            return this.measures = {
                width:taskWidth,
                height:taskAreaHeight
            };
        },

        /**
         * Method: defineSharedArea
         *
         * define the measures of shared area section
         *
         * Parameters:
         *  options - {Object} options to override default behavior.
         *
         * Returns:
         *  {Object} returns object with width and height properties.
         */
        defineSharedArea:function () {
            var sharedWidth = this._getSharedWidth(),
                sharedHeight = this._getSharedHeight(),
                shared = this.view._shared;

            shared.width(sharedWidth);
            shared.height(sharedHeight);

            return {
                width:sharedWidth,
                height:sharedHeight
            };
        },

        defineCreativeMargin:function () {
            var CWWidth = this._getSharedWidth(),
                CWHeight = this._getSharedHeight(),
                cw = this.view._creative_margin;

            cw.width(CWWidth);
            cw.height(CWHeight);

            return {
                width:CWWidth,
                height:CWHeight
            };
        },

        /**
         * Method: definePositionItem
         *
         * define the measures and position for an absolute position object
         *
         * Parameters: to be defined
         *
         */
        definePositionItem:function (el, x, y, w, h) {
            return el.css({
                'position':'absolute',
                'top':(y * this.em) + 'px',
                'left':(x * this.em) + 'px',
                'width':w,
                'height':h
            }).appendTo(this.view._body);
        },

        getEm:function (width) {
            return width / this.em;
        },

        _em:function (width) {
            return this.getEm(width);
        },

        _calcScale:function () {
            this.scaleX = Math.floor(this.cfg.width / this.em);
            this.scaleY = Math.floor(this.cfg.height / this.em);

            this.orphanX = this.cfg.width - this.scaleX * this.em;
            this.orphanY = this.cfg.height - this.scaleY * this.em;

            this.gridX = this.scaleX * this.em;
            this.gridY = this.scaleY * this.em;
        },

        _px:function (width) {
            var unit = width.replace(/^\d+/i, ''),
                width = parseInt(width);

            switch (unit) {
                case '%':
                    return Math.floor(((this.scaleX * width) / 100)) * this.em;
                    break;

                case 'em':
                    return width * this.em;
                    break;

                case 'px':
                    return width;
                    break;
            }
        },

        _getSharedWidth:function () {
        	////////////////////////////////////////////
        	// reduce collapse as much as possible
        	////////////////////////////////////////////
            var reduced ;
            reduced = this.cfg.isCollapse ? this.cfg.sharedContentDiffWidth : 0;
            reduced = reduced > 0 ? reduced : 0 ;
            ////////////////////////////////////////////
            return this.cfg.isVertical ? this._px((100 - this.cfg.ratio) + '%') - reduced : this.cfg.width;
        },

        _getSharedHeight:function () {
        	////////////////////////////////////////////
        	// reduce collapse as much as possible
        	////////////////////////////////////////////
            var reduced ;
            reduced = this.cfg.isCollapse ? this.cfg.sharedContentDiffHeight : 0;
            reduced = reduced > 0 ? reduced : 0 ;
            ////////////////////////////////////////////
            return this.cfg.isVertical ? this.cfg.height : this.cfg.height * (100 - this.cfg.ratio) / 100 - reduced;
        },

        _getTasksWidth:function () {
            var width;

            if(this.cfg.isVertical){
                if(this.cfg.isShared && this.cfg.isCollapse){
                    width = this.cfg.width;
                }else{
                    if(this.cfg.isShared){
                        width = this.cfg.width - this._getSharedWidth();
                    }else{
                        if(this.cfg.hasMargin){
                            var creativeTaskWidth = this._px(this.cfg.creativeTasksWidth.toString() + 'em');
                            if(this.cfg.width > creativeTaskWidth ){
                                width = creativeTaskWidth
                            }else{
                                width = this.cfg.width;
                            }
                        }else{
                            width = this.cfg.width;
                        }
                    }
                }
            }else{
                width = this.cfg.width;
            }


           /* if (this.cfg.isVertical) {
                if (this.cfg.isShared && this.cfg.isCollapse) width = this.cfg.width;
                else if (this.cfg.isShared) width = this.cfg.width - this._getSharedWidth();
                else width = this.cfg.width;
            }
            else width = this.cfg.width;*/

            return width;
        },

        _getTasksHeight:function () {
            var height;

            if (this.cfg.isVertical || this.cfg.isCollapse) height = this.cfg.height;
            else height = this.cfg.height * this.cfg.ratio / 100;

            return height;
        },

        _temp:function () {
            /*
             var thi$ = this;

             parent.jQuery('#vertical_arch').click(function () {
             thi$.drawGrid('vertical_arch', this.checked);
             });

             parent.jQuery('#horizontal_arch').click(function () {
             thi$.drawGrid('horizontal_arch', this.checked);
             });

             parent.jQuery('#vertical_essential').click(function () {
             thi$.drawGrid('vertical_essential', this.checked);
             });

             parent.jQuery('#horizontal_essential').click(function () {
             thi$.drawGrid('horizontal_essential', this.checked);
             });
             */
        },

        drawGrid:function (type, show) {
            var zIndex = this.drawZIndex = this.drawZIndex ? ++this.drawZIndex : 10000,
                el, i;

            switch (type) {
                case 'vertical_arch':
                    if (show) {
                        for (i = 4; i <= this.scaleX; i += 4) {
                            el = Perf.create("div").addClass('grid_service_vertical_arch').css({'background':'#FF5500','z-index':zIndex});

                            this.definePositionItem(el, i, 0, '1px', '1000%');
                        }
                    }
                    else jQuery('div.grid_service_vertical_arch').hide();
                    break;

                case 'horizontal_arch':
                    if (show) {
                        for (i = 4; i <= this.scaleY; i += 4) {
                            el = Perf.create("div").addClass('grid_service_horizontal_arch').css({'background':'#FF5500','z-index':zIndex});

                            this.definePositionItem(el, 0, i, '1000%', '1px');
                        }
                    }
                    else jQuery('div.grid_service_horizontal_arch').hide();
                    break;

                case 'vertical_essential':
                    if (show) {
                        for (i = 1; i <= this.scaleX; i++) {
                            el = Perf.create("div").addClass('grid_service_vertical_essential').css({'background':'#002AFF','z-index':zIndex});

                            this.definePositionItem(el, i, 0, '1px', '100%');
                        }
                    }
                    else jQuery('div.grid_service_vertical_essential').hide();
                    break;

                case 'horizontal_essential':
                    if (show) {
                        for (i = 1; i <= this.scaleY; i++) {
                            el = Perf.create("div").addClass('grid_service_horizontal_essential').css({'background':'#002AFF','z-index':zIndex});

                            this.definePositionItem(el, 0, i, '100%', '1px');
                        }
                    }
                    else jQuery('div.grid_service_horizontal_essential').hide();
                    break;
            }
        }
    });

    t2k.util.gridConfig = {
        em:'14px',

        simple:{
            tasksArea:{
                tasksMax:'59em',

                margins:{
                    left:{
                        min:'1em',
                        optimal:'2em'
                    },

                    right:{
                        min:'2em',
                        optimal:'3em'
                    }
                }
            }
        },

        shared:{
            tasksArea:{
                tasksMax:'59em',

                margins:{
                    left:{
                        min:'1em',
                        optimal:'2em'

                    },

                    right:{
                        min:'2em',
                        optimal:'3em'
                    }
                }
            }
        }
    };

    /**
     * Private:
     * Function: getScrollOffset
     *
     * returns scroll width.
     *
     * Parameters:
     * el - {HTMLElement} element to check it scroll width.
     * width - {Int} originat element width without scroll.
     */
    function getScrollWidth(el, width) {
        var div = el.prepend('<div class="scroll-tester" />').find('.scroll-tester'),
            width = width - div.width();

        div.remove();

        return width;
    }

    /**
     * Private:
     * Function: getRatio
     *
     * returns adjusted tasks ratio.
     *
     * Parameters:
     * cfg - {Object} config object.
     */
    function getRatio(cfg) {
        return cfg.isCollapse ? 100 : cfg.ratio;
    }

    /**
     * Private:
     * Function: getTasksWidth
     *
     * returns adjusted tasks ratio.
     *
     * Parameters:
     * cfg - {Object} config object.
     */
    function getTasksWidth(cfg) {
        var ratio = getRatio(cfg),
            ratioWidth = this._px(ratio + '%'),
            maxWidth = this._px(this.cfg[this.cfg.type].tasksArea.tasksMax);

        return Math.min(ratioWidth, maxWidth);
    }
})();

var gridService = t2k.util.GridService;
var GridService = t2k.util.GridService;
////////////////////////////////////////
// SRC End --> t2k/util/GridService.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/DNDManager.js
////////////////////////////////////////
/**
 * @class t2k.util.DNDManager	
 */
	t2k.util.DNDManager = function(){
		
			/** a hash to hold all draggable components by DOM id (key = id, value = componentObject)*/
			this.draggables = {};
			
			/** a hash to hold all droppable components by DOM id (key = id, value = componentObject)*/
			this.droppables = {};
			
			/** a hash to hold bank subAnswers*/
			this.bankItems = {};
			
			/** a hash to hold answer area subAnswers*/
			this.answerAreaItems = {};

			/* a hash to hold all subAnswers */
			this.allItems = {};

			/** an array of elements that needs to be removed*/
			this.recycleBin = [];
			
			/** a reference to the draggable component is now being dragged. If null- no drag takes place now*/
			this.inDragObject = null;

            /** current subAnswer that draggable element is over it */
            this.overObject = null;

            /** ready to drop {Boolean */
			this.readyToDropFlag = false;

            /** after drop flag */
			this.afterDropFlag = false;

            /** dragged element is over bank */
            this.isOverBank = false;

            /** Draggable is being animated. */
            this.isAnimated = false;
	};
	
	t2k.util.DNDManager.prototype = {
		init : function (){
			
				
		},
		/**
		 * reset
		 * do reset to DNDManager when a new task is inited 
		 */
		reset : function(){
			delete this.draggables;
			this.draggables = {};

			delete this.droppables;
			this.droppables = {};

			delete this.bankItems;
			this.bankItems = {};

			delete this.answerAreaItems;
			this.answerAreaItems = {};

			delete this.allItems;
			this.allItems = {};

            delete this.recycleBin;
			this.recycleBin = [];

			delete this.inDragObject;
            delete this.overObject;
			this.readyToDropFlag = false;
            this.afterDropFlag = false;
            this.isOverBank = false;
		},

		removeSubAnswer: function(elementId, removeFromAllList) {
			dndManager.removeDraggable(elementId);
			dndManager.removeDroppable(elementId);
			dndManager.removeAnswerAreaItem(elementId);
			dndManager.removeBankItem(elementId);

			if(removeFromAllList) {
				dndManager.removeItem(elementId);
			}
		},

		/**
		 * addItem
		 * add a component object (subanswer) to all Items hash
		 * @param elementId
		 * @param componentObject
		 */
		addItem : function(elementId, componentObject){
			if(this.allItems[elementId]) {
				return;
			}

			this.allItems[elementId] = jQuery.extend(true, {}, componentObject);
			this.allItems[elementId].view = jQuery.extend(true, {}, componentObject.view);
			this.allItems[elementId].cfg.data = jQuery(componentObject.cfg.data).clone().get(0);

			if(componentObject.children && componentObject.children.length) {
				this.allItems[elementId].children[0] = jQuery.extend(true, {}, componentObject.children[0]);
				this.allItems[elementId].children[0].view = jQuery.extend(true, {}, componentObject.children[0].view);
				this.allItems[elementId].children[0].cfg.data = jQuery(componentObject.children[0].cfg.data).clone().get(0);
			}
		},

		/**
		 * addBankItem
		 * add a component object (subanswer) to bankItems hash
		 * @param elementId
		 * @param componentObject
		 */
		addBankItem : function(elementId, componentObject){
			this.bankItems[elementId] = componentObject;
		},
		/**
		 * addAnswerAreaItem
		 * add a component object (subanswer) to answerAreaItems hash
		 * @param elementId
		 * @param componentObject
		 */
		addAnswerAreaItem : function(elementId, componentObject){
			this.answerAreaItems[elementId] = componentObject;
		},

		/**
		 * removeItem
		 * remove a component object from allItems hash
		 * @param elementId
		 */
		removeItem : function(elementId){
			delete this.allItems[elementId];
		},

		/**
		 * removeBankItem
		 * remove a component object from bankItems hash
		 * @param elementId
		 */
		removeBankItem : function(elementId){			  
			delete this.bankItems[elementId];
		},
		/**
		 * removeAnswerAreaItem
		 * remove a component object from answerAreaItems hash
		 * @param elementId
		 */
		removeAnswerAreaItem : function(elementId){
			delete this.answerAreaItems[elementId];
		},

		/**
		 * get subAnswer with wanted answerId
		 * @param answerId
		 */
		getItem : function(answerId){
			for (var elemId in this.allItems){
				if(this.allItems[elemId].answerId == answerId){
					return this.allItems[elemId];
				}
			}
		},

		/**
		 * get subAnswer with dndContainer = 'bank' and wanted answerId
		 * @param answerId
		 */
		getBankItem : function(answerId){
			for (var elemId in this.bankItems){
        		if(this.bankItems[elemId].initAnswerId == answerId){
        			return this.bankItems[elemId];
        		}
        	}
		},
        /**
		 * get subAnswer from answerAreaItems Array and initAnswerId == answerId
		 * @param answerId
		 */
		getAnswerAreaItemByInitAnswerId : function(answerId){
			for (var elemId in this.answerAreaItems){
        		if(this.answerAreaItems[elemId].initAnswerId == answerId){
        			return this.answerAreaItems[elemId];
        		}
        	}
		},
        /**
		 * get subAnswer from answerAreaItems Array and AnswerId == answerId
		 * @param answerId
		 */
		getAnswerAreaItemByAnswerId : function(answerId){
			for (var elemId in this.answerAreaItems){
        		if(this.answerAreaItems[elemId].initAnswerId == answerId){
        			return this.answerAreaItems[elemId];
        		}
        	}
		},
		/**
		 * addDraggable
		 * add a component object (subanswer) to draggables hash
		 * @param elementId
		 * @param componentObject
		 */
		addDraggable : function(elementId, componentObject){
			this.draggables[elementId] = componentObject;
		},
		/**
		 * addDroppable
		 * add a component object (subanswer) to droppables hash
		 * @param elementId
		 * @param componentObject
		 */
		addDroppable : function(elementId, componentObject){
			this.droppables[elementId] = componentObject;
		},
		/**
		 * removeDraggable
		 * remove a component object from draggables hash
		 * @param elementId
		 */
		removeDraggable : function(elementId){			  
			delete this.draggables[elementId];
		},
		/**
		 * removeDroppable
		 * remove a component object from droppables hash
		 * @param elementId
		 */
		removeDroppable : function(elementId){
			delete this.droppables[elementId];
		},			
		/**
		 * canDrag
		 * says if the object can be dragged
		 * @param elementId
		 * @returns {Boolean}
		 */
		canDrag : function(elementId) {
            return !this.inDragObject && !!this.draggables[elementId] && !this.isAnimated;
		},
		/**
		 * canDrop 
		 * says if the object can be dropped
		 * @param elementId
		 * @returns {Boolean}
		 */
		canDrop : function(elementId) {
            return !!this.inDragObject && !!this.droppables[elementId];
		},
		/**
		 * isInDragMode
		 * is drag happened now?
		 * @returns {Boolean}
		 */
		isInDragMode:function () {

			//check for critical error - dragged element exists but there is no value in this.inDragObject
			var draggElement = document.getElementsByClassName(this.draggElementClass);
			if (draggElement.length && !this.inDragObject) {
				var draggAnswerId = draggElement[0].getAttribute('answerid');
				if (draggAnswerId) {
					var sourceItem = this.getItem(draggAnswerId);
					if(sourceItem) {
						this.inDragObject = jQuery.extend(true, {}, sourceItem);
					}
				}
			}

			return !!this.inDragObject;
		},
		/**
		 * set inDragObject by parameter elementId
		 * @param elementId
		 */
		startDrag : function(elementId){
            if (this.canDrag(elementId)) {
                this.inDragObject = jQuery.extend(true, {}, this.draggables[elementId]);
            } else {
                throw "Can't drag element with id [" + elementId + "];";
            }
		},
		/**
		 * get/set readyToDropFlag
		 * @param flag
		 * @returns {Boolean} flag
		 */
		readyToDrop : function(flag){
			if (flag === true || flag === false) {
				this.readyToDropFlag = flag;
			}

			return this.readyToDropFlag;
		},
        /**
         * get/set afterDropFlag
         * @param flag
         * @returns {Boolean} flag
         */
        afterDrop : function(flag){
            if (flag === true || flag === false) {
                this.afterDropFlag = flag;
            }

            if (flag === true) {
                this.emptyRecycleBin();
            }

            return this.afterDropFlag;
        },
        /**
         * get/set isAnimated
         * @param flag
         * @returns {Boolean} flag
         */
        animated : function(flag){
            if (flag === true || flag === false) {
                this.isAnimated = flag;
            }
            return this.isAnimated;
        },

        /**
         * insertIntoRecycleBin
         * @param elem
         */
        insertIntoRecycleBin : function(elem) {
            this.recycleBin.push(elem);
            elem.hide();
        },

        /**
         * emptyRecycleBin
         */
        emptyRecycleBin : function() {
            jQuery(this.recycleBin).each(function(){
               this.remove();
            });

            this.recycleBin = [];
        }

	};

	//initializations
	var dndManager = new t2k.util.DNDManager();
////////////////////////////////////////
// SRC End --> t2k/util/DNDManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/DOMUtils.js
////////////////////////////////////////
/**
 * @class t2k.util.DNDManager
 */
t2k.util.DOMUtils = function () {
    this.parentByElem = {};
    this.lastScrollTopOffsetByElem = {};
};

t2k.util.DOMUtils.prototype = {


    registerToScroll:function (jqueryElem, ref) {
        var scrollableParent = this.parentByElem[jqueryElem.attr('id')];

        if (!!scrollableParent) {
            jQuery(scrollableParent).bind('scroll', {thi$:this, ref:ref, elem:jqueryElem}, this.scrollHandler);
            this.lastScrollTopOffsetByElem[jqueryElem] = scrollableParent.scrollTop();
        }

    },

    unRegisterToScroll:function (jqueryElem, ref) {
        var scrollableParent = this.parentByElem[jqueryElem.attr('id')];
        jQuery(scrollableParent).unbind('scroll', this.scrollHandler);
        delete this.parentByElem[jqueryElem];
    },

    reparentOnceAndRepositionElement:function (jQueryElem, newOffset) {
        var scrollEnabledParent = jQueryElem.parents('.scroll_enabled');
        if (!!!this.parentByElem[jQueryElem.attr('id')]) {
            this.parentByElem[jQueryElem.attr('id')] = scrollEnabledParent;
        }
        //jQueryElem.parent().append(jQuery('<div/>').height(jQueryElem.height()).width(jQueryElem.width()))
        if (jQueryElem.parent().attr('id') != scrollEnabledParent.attr('id')) {
            jQueryElem.appendTo(scrollEnabledParent);
        }

        jQueryElem.offset(newOffset);
    },

    /**
     * horizontalFitToViewport
     * fit keyboard horizontal position according to the viewport width
     * @param jQueryElem
     */
    horizontalFitToViewport:function (jQueryElem) {

        var viewport_width = Perf.select('.player').width(), elem_width = jQueryElem.outerWidth(true),
            elem_left_offset = jQueryElem.offset().left;

        // check jQueryElem's offset vs. viewport
        // left offset
        if (elem_left_offset < 0) {
            jQueryElem.css('left', 0);
        }

        //right offset
        if (elem_left_offset + elem_width > viewport_width) { // move [left] to viewportWidth - jQueryElem.width()
            jQueryElem.css('left', (viewport_width - elem_width));
        }

    },

    /**
     * verticalFitToViewport_scrollDown
     * fit keyboard vertical position according to the viewport height
     * @param jQueryElem
     */
    verticalFitToViewport_scrollDown:function (jQueryElem, ownerEl) {

        var viewport_height = Perf.select('.player').height(),
            ownerTop = ownerEl.offset().top + ownerEl.outerHeight(true);

        // check if we need scrolling for owner element
        if (ownerTop > viewport_height){
            var scrollEnabledParent = jQuery('.scroll_enabled'),
                scrollCheck = (ownerEl.offset().top - ownerEl.outerHeight(true));

            scrollEnabledParent.get(0).scrollTop += scrollCheck; // scroll to owner element Height
	        scrollEnabledParent = null;
        }

        var elem_top = jQueryElem.offset().top,
            elem_height = jQueryElem.outerHeight(true);

        // check if we need up the element
        if (elem_top + elem_height > viewport_height) {
            jQueryElem.show(true);
	        var paddingAddition = (jQueryElem.css('padding-top').px2int() * 2);
            jQueryElem.css('top', jQueryElem.offset().top - elem_height - ownerEl.height() - paddingAddition);
        }

	    //check if we need down the element
	    if (elem_top < 0) {
		    jQueryElem.show(true);
		    jQueryElem.css('top', Math.abs(jQueryElem.offset().top) + elem_height + ownerEl.height());
	    }
    },

    /**
     * centerBlowUp
     * fit keyboard vertical position according to the viewport height
     * @param jQueryElem
     */
    centerBlowUp:function (jQueryElem) {

        var viewport_height = Perf.select('.player').height(), viewport_width = Perf.select('.player').width(), elem_top = jQueryElem.offset().top,
            elem_height = jQueryElem.outerHeight(true), elem_width = jQueryElem.outerWidth(true);

        if (elem_top + elem_height > viewport_height) {
            var delta = elem_height - (viewport_height - elem_top);

            jQueryElem.css('top', (viewport_height - elem_height) / 2);
            jQueryElem.css('left', (viewport_width - elem_width) / 2);
        }

    },

    scrollHandler:function (event) {
        var ref = event.data.ref;
        var thi$ = event.data.thi$;
        var movingElement = event.data.elem;
        var delta = thi$.lastScrollTopOffsetByElem[movingElement] - this.scrollTop;

        thi$.lastScrollTopOffsetByElem[movingElement] = this.scrollTop;
        var offsetObj = {
            top:movingElement.offset().top + delta,
            left:movingElement.offset().left
        };

        movingElement.offset(offsetObj);
    }

};

//initializations
var domUtils = new t2k.util.DOMUtils();
////////////////////////////////////////
// SRC End --> t2k/util/DOMUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/LogEventsService.js
////////////////////////////////////////
(function() {

    /**
     * Class: t2k.util.LogEventsService
     * Formats and sends log event to host
     */
    t2k.util.LogEventsService = Object.subClass({
    	ctor: function ( sendLogs ) {
			this.sendLogs = sendLogs ;
		},
		/**
		    checkData is optional only comes with CHECK_PRESSED EVENT
            check data is an object
            {
            checkValue:string,
             attempt:number
              }
		*/
		sendLoggingEvent: function(type, atomId, checkData) {
			if( this.sendLogs ) {
				var evt = new t2k.util.LogEvent(type,atomId,checkData);
//				ENV.host.onLogEvent( { data: evt.getEventXml() } );
			}
		}
    });
    
    t2k.util.LogEvent = Object.subClass({
    	ctor: function (eventType, atomId,checkData) {

            if(!!checkData){
                if(!!checkData.checkedValue){
                    this.checkedValue = checkData.checkedValue;
                }else{
                    this.checkedValue = '';
                }

                if(!!checkData.currentAttempt){
                    this.currentAttempt = checkData.currentAttempt;
                }else{
                    this.currentAttempt = -1;
                }

            }else{
                this.checkedValue = '';
                this.currentAttempt = -1;
            }

	    	this.eventType = eventType;
	    	this.eventTime = new Date().getTime();
	    	this.atomId = atomId;
	    	this.loId = ENV.loId;
		},
    	getEventXml : function() {
    		var outCheckType = checkValueMap[ this.checkedValue ] || checkValueMap.none ;
    		
    		var xml = 	'<Event><atomId>' + this.atomId + 
    					'</atomId><eventType>' + this.eventType + 
    					'</eventType><eventTime>' + this.eventTime + 
    					'</eventTime><checkedValue>' + outCheckType +
    					'</checkedValue><currentAttempt>' + this.currentAttempt +
    					'</currentAttempt><loId>' + this.loId +
    					'</loId></Event>';
    		return xml;    		
    	}
    });

    checkValueMap = {} ;

    checkValueMap.allCorrect = 						"ALL_RIGHT" ;
    checkValueMap.allIncorrect = 					"ALL_WRONG" ;
    checkValueMap.allCorrectPartIncorrect = 		"ALL_RIGHT_PART_WRONG" ;
    checkValueMap.allCorrectPartMissing = 			"ALL_RIGHT_PART_WRONG" ;
    checkValueMap.partCorrect = 					"PART_RIGHT" ;
    checkValueMap.partCorrectMoreThan80Percent = 	"PART_RIGHT" ;
    checkValueMap.partCorrectLessThan80Percent = 	"PART_WRONG" ;
    checkValueMap.partCorrectPartIncorrect = 		"PART_WRONG" ;
    checkValueMap.partCorrectPartMissing = 			"PART_WRONG" ;
    checkValueMap.misplacedSequence = 				"ALL_WRONG" ;
    
    checkValueMap.generic = 						"GENERIC" ;
    checkValueMap.none = 							"NONE" ;
    

    t2k.util.LogEventsService.CHECK_PRESSED 			= 1001; // used - v
    t2k.util.LogEventsService.CLUE_PRESSED 				= 1002; // used - v
    t2k.util.LogEventsService.AID_PRESSED				= 1003; // used - v
    t2k.util.LogEventsService.LINGUA_NAVIGATOR_PRESSED	= 1004; // 
    t2k.util.LogEventsService.TOOL_USED					= 1005; // 
    t2k.util.LogEventsService.OBJECT_WITHDRAWN			= 1006; // 
    t2k.util.LogEventsService.ATOM_START			    = 1007; // used - v
    t2k.util.LogEventsService.ATOM_END					= 1008; // used - v
    t2k.util.LogEventsService.ATOM_GRADE				= 1009; //
    t2k.util.LogEventsService.SHOW_ANSWER				= 1010; // used - v
    
})();
   

////////////////////////////////////////
// SRC End --> t2k/util/LogEventsService.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/FeedbackUtils.js
////////////////////////////////////////
(function() {
	
    t2k.util.FeedbackUtils = {} ;

    t2k.util.FeedbackUtils.FeedbackService = Object.subClass({
    	
    	ctor: function () {
		},
		
    	createMessage : function( type, icon, specificName ) {
    		if( !icon ) {

                switch (type) {
                    case t2k.util.FeedbackUtils.TYPE_ALL_CORRECT :
                        icon = t2k.util.FeedbackUtils.ICON_CORRECT;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_PART_CORRECT_PART_INCORRECT :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_PART_CORRECT :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_ALL_CORRECT_PART_INCORRECT :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT :
                        icon = t2k.util.FeedbackUtils.ICON_INCORRECT;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_PART_CORRECT_PART_MISSING :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_ALL_CORRECT_PART_MISSING :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_PART_CORRECT_MORE_80_PERCENT :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_PART_CORRECT_LESS_80_PERCENT :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                    case t2k.util.FeedbackUtils.TYPE_MISPLACED_SEQUENCE :
                        icon = t2k.util.FeedbackUtils.ICON_PART;
                        break;
                }
    		}
            
    		return new t2k.util.FeedbackUtils.MessageData( type, icon, specificName ) ;    		
    	}
		
    });
    
    
    t2k.util.FeedbackUtils.MessageData = Object.subClass({
    	
    	ctor: function ( type, icon, specificName ) {
    		this.data = { type: type, icon: icon, name: specificName } ;
		},
		
    	getData : function() {
    		return this.data ;    		
    	}
		
    });
    
    
    t2k.util.FeedbackUtils.ICON_CORRECT 	= 'correct' ;
    t2k.util.FeedbackUtils.ICON_INCORRECT 	= 'incorrect' ;
    t2k.util.FeedbackUtils.ICON_PART	 	= 'part' ;

    t2k.util.FeedbackUtils.TYPE_ALL_CORRECT 					= 'allCorrect' ;
    t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT 					= 'allIncorrect' ;
    t2k.util.FeedbackUtils.TYPE_ALL_CORRECT_PART_INCORRECT 		= 'allCorrectPartIncorrect' ;
    t2k.util.FeedbackUtils.TYPE_ALL_CORRECT_PART_MISSING 		= 'allCorrectPartMissing' ;

    t2k.util.FeedbackUtils.TYPE_PART_CORRECT 					= 'partCorrect' ;

    t2k.util.FeedbackUtils.TYPE_PART_CORRECT_MORE_80_PERCENT	= 'partCorrectMoreThan80Percent' ;
    t2k.util.FeedbackUtils.TYPE_PART_CORRECT_LESS_80_PERCENT	= 'partCorrectLessThan80Percent' ;

    t2k.util.FeedbackUtils.TYPE_PART_CORRECT_PART_INCORRECT 	= 'partCorrectPartIncorrect' ;
    t2k.util.FeedbackUtils.TYPE_PART_CORRECT_PART_MISSING 	    = 'partCorrectPartMissing' ;

    t2k.util.FeedbackUtils.TYPE_MISPLACED_SEQUENCE 	            = 'misplacedSequence' ;
    
    FeedbackService = new t2k.util.FeedbackUtils.FeedbackService() ;
    
})();
////////////////////////////////////////
// SRC End --> t2k/util/FeedbackUtils.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/AssessmentENV.js
////////////////////////////////////////
(function() {

	t2k.util.AssessmentENV = {
        
		setModes: function( flag, mode ) {
			AssessmentENV.assessmentMode = mode ;
        	AssessmentENV.isAssessmentMode = flag ;
        	
        	AssessmentENV.isAssessmentModeTest = 		mode == ASSESSMENT_MODE_TEST ;
        	AssessmentENV.isAssessmentModeReadOnly = 	mode == ASSESSMENT_MODE_READ_ONLY ;
        	AssessmentENV.isAssessmentModeReview = 		mode == ASSESSMENT_MODE_REVIEWED ;
        	
        	AssessmentENV.isNotAssessmentModeTest = 	flag && mode != ASSESSMENT_MODE_TEST ;
        	AssessmentENV.isNotAssessmentModeReadOnly = flag && mode != ASSESSMENT_MODE_READ_ONLY ;
        	AssessmentENV.isNotAssessmentModeReview = 	flag && mode != ASSESSMENT_MODE_REVIEWED ;
        },
        
        assessmentMode:null,
        
		isAssessmentMode: false,
		
		isAssessmentModeTest: false,
		isAssessmentModeReadOnly: false,
		isAssessmentModeReview: false,
		
		isNotAssessmentModeTest: false,
		isNotAssessmentModeReadOnly: false,
		isNotAssessmentModeReview: false

	};

	var ASSESSMENT_MODE_TEST = 'ASSESSMENT_MODE_TEST' ;
	var ASSESSMENT_MODE_READ_ONLY = 'ASSESSMENT_MODE_READ_ONLY' ;
	var ASSESSMENT_MODE_REVIEWED = 'REVIEWED' ;
})();

var AssessmentENV = t2k.util.AssessmentENV ;
////////////////////////////////////////
// SRC End --> t2k/util/AssessmentENV.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/StateUtil.js
////////////////////////////////////////
(function() {
	
	t2k.util.StateUtil = function() {
		
		this.reset() ;
		
	};

	t2k.util.StateUtil.prototype = {
			
			reset: function() {
				
				this.stateCallbacks = {} ;
				this.rootObject = null ;
				this.stateXML = null ;
				this.callbacksTotal = 0 ;
				this.callbacksDone = 0 ;
				this.collectCallback = null ;
				this.isCollecting = false ;
				
			},
			
			// called to get state from root element, both sync/async
			collectState: function( rootObject, callback ) {
				
				this.reset() ;
				
				// save state collecting params
				this.rootObject = rootObject ;
				this.collectCallback = callback ;
				
				// flag on for collecting
				this.isCollecting = true ;
				
				// start the recursive getState
				//get state with place holders dummies elements
				var rootState = this.rootObject.getState() ;
				
				// save copy on instance (single)
				this.stateXML = rootState ;
				
				// in case no async requests
				if( this.callbacksTotal == 0 ) {
					
					this.reset() ;
					
					// call collecting done callback
					callback( rootState ) ;
					
				}
			},
			
			// get async object with callback and dummy xml tag
			// (keeping most system sync )
			getStateCallback: function( objectKey ) {
				
				var utilCallback = null ;
				
				// generate unique id to register the request
				var uniqueID = objectKey + '_' + ( new Date() ).getTime() ;
				
				// create dummy tag with unique name
				var $dummyTag = $( "<" + uniqueID + "/>" ) ;
				
				// many times getState is requested without state collection request
				// in case state collecting started by this util
				if( this.isCollecting ) {
					
					var thi$ = this ;
					
					// generate callback,
					// must called with state as parameter
					utilCallback = function( finalState ) {
						
						// rout to util handler with id and final state
						thi$.stateCallbackHandler( uniqueID, finalState ) ;
						
					} ;
					
					// register request in collection 
					this.stateCallbacks[ uniqueID ] = {
						callback: utilCallback,
						state: null
					} ;
					
					// increment total
					this.callbacksTotal++ ;
					
				} else {
					
					console.warn( "asking for state callback when not collecting" ) ;
					
				}
				
				// return request data
				return {
					callback: utilCallback,
					dummyTag: $dummyTag
				} ;
				
			},
			
			// handles callbacks registered by async state requests
			stateCallbackHandler: function( uniqueID, state ) {
				
				// increment done
				this.callbacksDone++ ;
				
				// save final state to registered object
				this.stateCallbacks[ uniqueID ].state = state ;
				
				// when all done
				if( this.callbacksDone == this.callbacksTotal ) {

					// do stuff on done 
					this.onAllStatesDone() ;
					
				}
				
			},
			
			// handle states when collecting done
			onAllStatesDone: function() {
				
				var thi$ = this ;
				
				// loop on all async requests
				$.each( this.stateCallbacks, function( key, object ) {
					
					// find the matching dummy tag
					var $dummyTag = thi$.stateXML.find( key ) ;
					
					// insert the final data at the same place
					$( object.state ).insertAfter( $dummyTag ) ;

					// remove dummy, and actually replace dummy with final
					$dummyTag.remove() ;
					
				} ) ;
				
				// save objects for resetting
				var doneCallback = this.collectCallback ;
				var completeState = this.stateXML ;
				
				// reset, keep this clean from references
				this.reset() ;
				
				// call done with complete state
				doneCallback( completeState ) ;
				
			},
			
	};

})();

var StateUtil = new t2k.util.StateUtil() ;

////////////////////////////////////////
// SRC End --> t2k/util/StateUtil.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/Sound.js
////////////////////////////////////////

/**
 * Class t2k.util.Beep
 */
(function() {

    t2k.util.sound = Object.subClass({
    	
    	beepPath: "assets/audio/beep.mp3",
    	
        /**
         * ctor
         * create beep audio element
         */
        create : function () {

            this.beepElement = jQuery('<audio id="beep" />').attr('src', this.beepPath);
            Perf.select('body').append(this.beepElement);
        },

        /**
         * beep..
         */
        beep : function(){
            try {

                var audio = document.createElement("audio");
                audio.src = this.beepPath ;
                audio.play();

            } catch(e){};
        }



    });

})();

// single tone
var SOUND = new t2k.util.sound();
////////////////////////////////////////
// SRC End --> t2k/util/Sound.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/Services.js
////////////////////////////////////////

/**
 * Class t2k.util.services
 */
(function() {

    t2k.util.services = Object.subClass({
        
        /**
         * ctor
         */
        ctor : function () {
            this.reset();
        },

        /**
         * add
         */
        add : function(itemName, item){
           this._item[itemName] = item;
        },

        /**
         * get
         */
        get : function(itemName){
            return this._item[itemName] || function(){};
        },

        reset : function(){
            this._item = [];
        }

    });

})();

// single tone
var EXT_SERVICES = new t2k.util.services();
////////////////////////////////////////
// SRC End --> t2k/util/Services.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/behavior/checkable.js
////////////////////////////////////////
(function() {

    // checkResultDefaults
    var checkResultDefaults = {
        correct: 0,
        partiallyCorrect: 0,
        predictedIncorrect: 0,
        incorrect: 0,
        expected: 0,
        checked: 0,
        empty: 0
    };

    /**
     * Checkable behavior
     * Provides interface and common functionality of all checkable objects
     */
    t2k.behavior.checkable = Object.subClass({

        /**
         * check - Check object correctness
         * Run check, merge it with checkResultDefaults and return it
         * @return runCheckResult (Object)
         */
        check: function() {
            var runCheckResult = this.runCheck();
            var checkResult = override({}, runCheckResult, checkResultDefaults);

            return checkResult;
        }, // End of check

        /**
         * runCheck - implemented in classes which implement the checkable behavior
         * Run the check and return check result as outlined in the checkResultDefaults above
         */
        runCheck: function() {
            throw 'checkable class must override runCheck()';
        }, // End of runCheck

        /**
         * getValue - get value without checking
         */
        getValue: function() {
            throw 'checkable class must override getValue()';
        }, // End of getValue

        /**
         * isEmpty - check if checkable instance value is empty
         */
        isEmpty: function() {
            throw 'checkable class must override isEmpty()';
        }, // End of isEmpty

        /**
         * setLocalFeedback - set the checkable instance local feedback
         */
        setLocalFeedback: function(feedbackType) {
            throw 'checkable class must override setLocalFeedback(type)';
        }, // End of setLocalFeedback
        /**
         * reset component after applying try again
         */
        resetOnTryAgain : function(){
           throw 'checkable class must override resetOnTryAgain()';
        },  //end of resetOnTryAgain
        /**
         * apply after pressing show answer
         */
        markOnShowAnswer : function(){
            throw 'checkable class must override showAnswer()'
        }

    }); // End of t2k.behavior.checkable


})();
////////////////////////////////////////
// SRC End --> t2k/component/behavior/checkable.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/behavior/checkableMath.js
////////////////////////////////////////
(function() {

    /**
     * Checkable math behavior
     * Provides interface and common functionality of all Math checkable objects
     */
    t2k.behavior.checkableMath = t2k.behavior.checkable.subClass({

        /**
         * getMarkupValue - get the markup value inside checkableMath instance
         */
        getMarkupValue: function() {
            throw 'checkableMath class must override getMarkupValue()';
        }, // End of getMarkupValue

        /**
         * getMathCorrectness - get math correctness inside checkableMath instance
         */
        getMathCorrectness: function() {
            throw 'checkableMath class must override getMathCorrectness()';
        } // End of getMathCorrectness
    }); // End of t2k.interface.checkable


})();


////////////////////////////////////////
// SRC End --> t2k/component/behavior/checkableMath.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/behavior/subAnswerTiling.js
////////////////////////////////////////
(function() {
    /**
     * subAnswerTiling behavior
     * Provides interface and common functionality of all subAnswerTiling objects
     */
    t2k.behavior.subAnswerTiling = Object.subClass({

            getElementSize: function(elementsSizes){
                 var childElementsSizes = {'width': 0, 'height' : 0};
                 this.children.forEach(function(child) {
                    if(child.getElementSize){
                        childElementsSizes = child.getElementSize(elementsSizes);
                        elementsSizes.width = (childElementsSizes.width > elementsSizes.width) ? childElementsSizes.width : elementsSizes.width;
                        elementsSizes.height = (childElementsSizes.height > elementsSizes.height) ? childElementsSizes.height : elementsSizes.height;
                    }
                 });

                return elementsSizes;
            },

            setElementSize: function(elementSizes){
                var thi$ = this;
                if (!!!elementSizes) {
                    if (this.resetSubAnswerSizes) {
                        this.resetSubAnswerSizes();
                    }

                    elementSizes = this.getElementSize({'width': 0, 'height' : 0});
                }

                if ((elementSizes.width > 0) && (elementSizes.height > 0)) {
                    thi$.children.forEach(function(child) {
                        if (child.setElementSize) {
                            child.setElementSize(elementSizes);
                        }
                    });
                }
            }
    }); // End of t2k.behavior.subAnswerTiling


})();
////////////////////////////////////////
// SRC End --> t2k/component/behavior/subAnswerTiling.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/model/Configuration.js
////////////////////////////////////////
(function() {

    /**
     * Class: t2k.model.Configuration
     * A player configuration.
     *
     * Properties:
     *  sequencesConfig - {Array[Object]} The sequence configurations list.
     */
    t2k.model.Configuration = Object.subClass({
            
            ctor: function() {
                parseParamsXML(paramsXML);
            }

        }); // End of t2k.model.Configuration

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    function parseParamsXML(xml) {
        // Wrap the xml with jQuery.
        var $params = jQuery(xml);


        ENV.contentDirection = LanguageUtil.config.direction;
        
        ENV.interfaceDirection = LanguageUtil.config.direction;
        
        // root language
        ENV.interfaceLanguage = ENV.locale.split('_')[0] ; //$params.find('language').text();
        
        // root autoplayFeedbackNarration
        ENV.autoplayFeedbackNarration = $params.find('autoplayFeedbackNarration').text() == 'true' ;
        ENV.navigationData = $params.find('navigation')[0] ;

        var taskNavMode = null, taskIndexPerSeq = true, taskIndexType = null ;
        var taskNavData = $params.find('taskNavigation')[0] ;
        if( taskNavData ) {
        	taskNavMode =  jQuery( taskNavData ).attr( 'mode' ) ;
        	taskIndexPerSeq = jQuery( taskNavData ).attr( 'indexPerSequence' ) == 'true' ;
        	taskIndexType = jQuery( taskNavData ).attr( 'labelType' ) ;
        }
        ENV.taskNavigationMode = taskNavMode ? taskNavMode : "strict" ;
        ENV.taskIndexPerSeq = taskIndexPerSeq ;
        ENV.taskIndexType = taskIndexType ? taskIndexType : ENV.taskIndexType ;
        
        // parse root xml - text viewer default configuration - ENV
        var textViewerElem = $params.find('textViewer');
        ENV.textViewer = {
        	style: textViewerElem.find('style').text(),
        	useSideBar: textViewerElem.find('useSideBar').text(),
        	enableTextSelection: textViewerElem.find('enableTextSelection').text(),
        	baloonStyle: textViewerElem.find('baloonStyle').text(),
        	lineHeightConfig: textViewerElem.find('lineHeightConfig').text()
        };
        
        ENV.defaultTaskProgress = $params.find('defaultTaskProgress');
        
        // parse root xml for dragAndDrop Behavior
        ENV.dragAndDropBehavior = $params.find('subAnswer dragAndDropBehavior').text();
    } // End of parseParamsXML
    
    var paramsXML = "<params> \
        <direction>ltr</direction> \
        <language>en</language> \
        <locale>us</locale> \
        <navigation labelType='1' mode='open'/> \
        <taskNavigation labelType='1'/> \
        <subAnswer> \
            <dragAndDropBehavior>dragAndDrop</dragAndDropBehavior> \
        </subAnswer> \
        <textViewer> \
            <baloonStyle>baloonStyle</baloonStyle> \
            <style>textViewerStyle</style> \
            <useSideBar>false</useSideBar> \
            <lineHeightConfig>compact</lineHeightConfig> \
            <enableTextSelection>false</enableTextSelection> \
        </textViewer> \
        <defaultTaskProgress> \
            <attempts>2</attempts> \
            <autoCheck>false</autoCheck> \
            <taskButton label='Check' type='check'/> \
            <taskButton label='Continue' type='progress'/> \
            <taskButton label='Try Again' type='tryagain'/> \
            <taskButton label='Show Answer' type='showanswer'/> \
        </defaultTaskProgress> \
        <autoplayFeedbackNarration>true</autoplayFeedbackNarration> \
    </params>" ;

})();


////////////////////////////////////////
// SRC End --> t2k/model/Configuration.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/UiComponent.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.core.UiComponent
     * The super-class of all UI classes. Contains common functionality.
     *
     * Properties:
     *  cfg - {Object} The component's configuration.
     */
    t2k.core.UiComponent = Object.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            // Set the configuration.
            this.cfg = config;
            // Init the children array.
            this.children = [];
            // Validation.
            this.validate();
        }, // End of ctor

        /**
         * Method: add
         * Add a child component to this one.
         *
         * Parameters:
         *  child - {t2k.core.UiComponent} A child element to add to this.
         */
        add: function(child) {
            // If child is 'nothing' then do nothing.
            if (!child) return;
            // Add the component to the children array.
            this.children.push(child);
        }, // End of add.
        /**
         * Method: remove
         * Remove a child from children array
         * @param child
         */
        remove: function(child) {
            // If child is 'nothing' then do nothing.
            if (!child) return;

            var count;
            for(count = 0; count < this.children.length; count++) {
                if(this.children[count] == child) {
                    this.children.splice(count, 1);
                    break;
               }
            }
        }, //End of remove

	    /**
	     * Method: removeChildByIndex
	     * Remove a child from children array
	     * @param index
	     */
	    removeChildByIndex: function(index) {
		    if (index < 0) return;
		    if (this.children.length == 0) return;

		    this.children.splice(index, 1);
	    }, //End of removeChildByIndex

	    /**
	     * Method: removeChildren
	     */
	    removeChildren: function() {
		    for (var count = 0; count < this.children.length; count++) {
			    this.removeChildByIndex(count);
		    }
		    this.children.length = 0;
	    },

        /**
         * Method: insert
         * Insert a child into children array
         * @param child, index
         */
        insert: function(child, index) {
            // If child is 'nothing' then do nothing.
            if (!child) return;

            this.children.splice(index, 0, child);
            
        }, //End of insert

        /**
         * Method : orderChildren
         * order children array based on order array of indexes
         * @param order_array
         */
        orderChildren : function(order_array) {
            if(!this.children) return;

            var tmp_array = [], thi$ = this;

            jQuery(order_array).each(function(index, value) {
                tmp_array[index] = thi$.children[value];
            });

            this.children = tmp_array;
        },

        /**
         * Method: validate
         * A place for components to validate itself. Called at construction time.
         */
        validate: function() {
            /* null implementation */
        }, // End of validate

        /**
         * Method: setEnabled
         * De/Activates the ui-component.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
            this.cfg.enabled = flag;
        }, // End of setEnabled
        
        /**
         * Method: isEnabled
         * Indicates the ui-component active state.
         */
        isEnabled: function() {
            return this.cfg.enabled;
        },

        /**
         * Method: setVisible
         * 
         * Parameters:
         *  flag - {Boolean} True for visible, false otherwise.
         */
        setVisible: function(flag) {
        	this.cfg.visible = flag;
        }, // End of setVisible

        /**
         * Method: isEnabled
         * Indicates the ui-component visibility state.
         */
        isVisible: function() {
            return this.cfg.visible;
        },

        /**
         * Method: dispose
         * A place for components to handle deletion.
         */
        dispose: function() {
	        for (var key in this) {
		        if (this.hasOwnProperty(key)) {
			        if ((["children", "view", "destroy", "dispose", "_super"].indexOf(key) < 0) && this[key]) {
				        delete this[key];
			        }
		        }
	        }
	        // commented out - is failing the minification 
//	        delete this;
        }, // End of dispose

        /**
         * Method: dispatchEvent
         * Call callback methods that are passed inside the 'events' object of the configuration. If a callback with the
         * given name doesn't exist then an error is thrown.
         *
         * Parameters:
         *  name - {String} The name of the event (callback).
         *  args - {Array[Object]} The arguments to pass the event callback.
         */
        dispatchEvent: function(name, args) {
            // Reference the configuration object.
            var cfg = this.cfg;

            var argz = (args instanceof Array) ? args : [args];
            // Dispatch the event or throw an error if an  event with the given name isn't registered.
            if (cfg && cfg.events && cfg.events[name]) cfg.events[name].apply(this, argz);
        }, // End of dispatchEvent

        /**
         * Method: registerEvent
         * Registers an event with this ui-component.
         *
         * Parameters:
         *  name - {String} The name of the event.
         *  callback - {Function} The function to call when the event is dispatched.
         */
        registerEvent: function(name, callback) {
            if (!this.cfg.events) this.cfg.events = [];
            this.cfg.events[name] = callback;
        } // End of registerEvent

    }); // End of t2k.core.UiComponent


})();


////////////////////////////////////////
// SRC End --> t2k/core/UiComponent.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/layout/BaseLayout.js
////////////////////////////////////////

t2k.core.layout.BaseLayout = t2k.core.UiComponent.subClass({

    /**
     * Constructor: ctor
     * The constructor
     */
    ctor: function(config) {
        // Delegate.
        this._super(config);
        
    }, // End of ctor

    /**
     * Method: validate
     * Makes sure the parent view is set.
     */
    validate: function() {
        // Delegate()
        this._super();
        // Reference the configuration object.
        var cfg = this.cfg;
        // Check for template.
        if (cfg.view == null || cfg.view == 'undefined')
            throw "no owning view specified for this layout.";
    }, // End of validate

    /**
     * layout
     */
    layout: function() {
    	// reset layout w&h
    	this.cfg.view.children.forEach(function(child){
            if(child._view){
                child._view.height('').width('');
            }
    	});
        /* null implementation */
    },

    /**
     * scroll
     * @param index
     * @param callback
     * @param offset
     */
    scroll: function(index, callback, offset) {
        /* null implementation */
    }
});

////////////////////////////////////////
// SRC End --> t2k/core/layout/BaseLayout.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/layout/HorizontalLayout.js
////////////////////////////////////////

t2k.core.layout.HorizontalLayout = t2k.core.layout.BaseLayout.subClass({

    layout: function() {
        // Delegate.
        //this._super();
        // Reference the view.
        var view = this.cfg.view;
        // Sum the children width.
        var totalWidth = 0;

        view.children.forEach(function(child) {
            totalWidth += parseInt(child.cfg.width);
        });
        // Update the view's content to have the width that is the sum of its children width.
        // TODO: check why does this at all happen.
        // view._content.width(totalWidth);

    }, // End of layout

    scroll: function(index, callback) {
        // Reference the view.
        var view = this.cfg.view;
        // Sum the total scroll.
        var i,totalScroll = 0;
        for (i=0; i<index; i++) {
            totalScroll += parseInt(view.children[i].cfg.width);
        }

        view._view.animate({scrollLeft: totalScroll}, 250, callback);
    } // End of scroll
    
});

////////////////////////////////////////
// SRC End --> t2k/core/layout/HorizontalLayout.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/layout/InlineLayout.js
////////////////////////////////////////

t2k.core.layout.InlineLayout = t2k.core.layout.BaseLayout.subClass({

    layout: function() {
        // Delegate.
        this._super();
        // Reference the view.
        var view = this.cfg.view;
        // Layout.
        view.children.forEach(function(child) {
            child._view && child._view.length && (child._view[0].style.display = 'inline-block');
        });
    } // End of layout

});

////////////////////////////////////////
// SRC End --> t2k/core/layout/InlineLayout.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/layout/VerticalLayout.js
////////////////////////////////////////

t2k.core.layout.VerticalLayout = t2k.core.layout.BaseLayout.subClass({

    scroll: function(index, callback, offset) {
        // Reference the view.
        var view = this.cfg.view;
        var id = view._view.attr('id') + '_content';
        var totalScroll = view.children[index]._view.offset().top + view._content.scrollTop() ;     
        
        totalScroll = totalScroll - ( offset ? offset : 0 ) ;

        if ( ENV.behaviors.scrollControl ) {
        	var absScroll = view.children[index]._view.offset().top - ScrollControl.getMarginTop() - 15;
        	ScrollControl.scrollTopAnimate(-absScroll, 500, callback);
        } else {
        	Perf.select('#' + id).animate({scrollTop: totalScroll}, 250, callback);
        }

    } // End of scroll

});

////////////////////////////////////////
// SRC End --> t2k/core/layout/VerticalLayout.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/layout/TileLayout.js
////////////////////////////////////////

t2k.core.layout.TileLayout = t2k.core.layout.InlineLayout.subClass({

    layout: function() {
        // Delegate.
        this._super();
        // Reference the view.
        var view = this.cfg.view;
        // Sum the children width.
        var maxWidth = 0;
		var maxHeight = 0;
        view.children.forEach(function(child) {
            var currWidth = parseInt(child._view.innerWidth());
            maxWidth = (maxWidth > currWidth) ? maxWidth : currWidth;
			var currHeight = parseInt(child._view.innerHeight());
			maxHeight = (maxHeight > currHeight) ? maxHeight : currHeight;
        });
        view.children.forEach(function(child) {
            child._view.width(maxWidth);
			child._view.height(maxHeight);
        });
    } // End of layout

});

////////////////////////////////////////
// SRC End --> t2k/core/layout/TileLayout.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/Presenter.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//  add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.core.Presenter
     * The base presenter class. Contains common presenter functionality.
     *
     * Properties:
     *  view - {t2k.core.View} The view that is handled by the presenter.
     */
    t2k.core.Presenter = t2k.core.UiComponent.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            // Delegate.
            this._super(config);
            // isComposite (true/false) composite indicator
            
            // TODO: remove
            this.isComposite = false;
        }, // End of ctor

        /**
         * Method: add
         * Add a child presenter to this one. This method assumes that this presenter already has a view set
         * (if not then an error is thrown).
         *
         * Parameters:
         *  child - {t2k.core.Presenter} A child presenter to add to this.
         */
        add: function(child) {
            // Check for view first.
            if (!this.view) throw "child components cannot be added before the view is set";
            // Delegate.
            this._super(child);
            // Add the child's view to the array of children in this presenter's view.
            this.view.add(child.view);
        }, // End of add.

        /**
         * Method: getState
         * Exports the presenters' state as a XML object.
         *
         * Returns:
         *  {XML} The presenters' state.
         */
        getState: function() {
            return '';
        }, // End of getState

        /**
         * Method: setState
         * Sets the player state as described in the provided XML string.
         *
         * Parameters:
         * state - {String} a string XML.
         */
        setState: function(state) {
            // null implementation.
            this.stateValue = state;
        },

        /**
         * Method: setEnabled
         * De/Activates the presenter. This method sets the view's active state.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
//            if (!flag && this.isEnabled()) {
//                this.intermediateState = this.getState();
//            }
            this._super(flag);
            this.view.setEnabled(flag);
        }, // End of setEnabled

//        loadInterMediateState: function() {
//            if (this.intermediateState) {
//                this.setState(this.intermediateState,true);
//            }
//        },

        /**
         * Method: setVisible
         *
         * Parameters:
         *  flag - {Boolean} True for visible, false otherwise.
         */
        setVisible: function(flag) {
            this._super(flag);
            this.view.setVisible(flag);
        }, // End of setVisible

        /**
         * Method: orderChildren
         * @param order_array - {Array} of indexes
         */
        orderChildren : function(order_array){
            this._super(order_array);

            this.view.orderChildren(order_array);
        },

	    disposeChildren:function () {
		    var child;
		    for (var ind = this.children.length - 1; ind >= 0; ind--) {
			    child = this.children[ind];
			    !!child.view && child.view.dispose();
			    child.dispose();
		    }
	    },

	    dispose: function() {

		    !!this.children && this.disposeChildren();

		    !!this.view && this.view.dispose();

		    this._super();
	    }

    }); // End of t2k.core.Presenter


})();

////////////////////////////////////////
// SRC End --> t2k/core/Presenter.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/FlowPresenter.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.core.FlowPresenter
     * Extends the base presenter class with flow related functionality. Flow presenters provides both progress related
     * functionality. The 'Player' and 'Sequence' are examples of flow-presenters.
     */
    t2k.core.FlowPresenter = t2k.core.Presenter.subClass({

        /**
         * Method: progress
         * Instructs the presenter to move to the next step in its progress. If the presenter cannot proceed to the next
         * step an error is thrown.
         */
        progress: function() {
            /* null implementation */
        } // End of progress

    }); // End of t2k.core.FlowPresenter


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/core/FlowPresenter.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/core/View.js
////////////////////////////////////////
(function() {

    /**
     * Class: t2k.core.View
     * The base view class. Contains common view functionality.
     *
     * Properties:
     *  template - {String} The Mustache template used for rendering the view. Sub-classes must provide their templates.
     */
    t2k.core.View = t2k.core.UiComponent.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} configuration details.
         *  [config.parent] - {String|Object} the parent element for the pane.
         */
        ctor: function(config) {
            // Delegate:
            // If no configuration provided or if the configuration doesn't specify the parent use the
            // document's body as the default one. Also auto-generate an id if non provided.
            this._super(copy({}, config, { id:genId() , parent: document.body }));

            // Reference the configuration object.
            var thi$ = this;
            var cfg = this.cfg;

            // If the parent is a view and it uses layout management then call the layout's 'layout' method after
            // rendering.
            if (cfg.parent instanceof t2k.core.View) {
                // Render the view.
                this.render('#' + cfg.parent.cfg.id + '_content', cfg.template, cfg);
                if (cfg.parent.layout) cfg.parent.layout.layout(); // TODO: delete
            } else {
                var parent = typeof cfg.parent == "object" ? cfg.parent : "#" + cfg.parent;
                // Render the view.
                this.render(parent, cfg.template, cfg);
            }

            // Handle optional layout management.
            if (cfg.layout) {
                // Get the layout class
                var LayoutClass = getLayoutClass(cfg.layout);
                // Override the layout name with a layout object.
                cfg.layout = new LayoutClass({view: this});
            }

            // Keep reference to the view's DOM element.
            this._view = Perf.select('#' + cfg.id);
	
            // Keep reference to all DOM elements with id suffix.
            jQuery(this._view).find('[id^=' + cfg.id + '_]').each(function(index, elem) {
                thi$[jQuery(elem).attr('id').substring(cfg.id.length)] = jQuery(elem);
            });

            // Apply trivial settings.
            if (cfg.width) this._view.width(this.cfg.width);
            if (cfg.height) this._view.height(this.cfg.height);
            
        }, // End of ctor

        /**
         * Method: render
         * Renders the view.
         *
         * Parameters:
         *  element - {Object/String} The element/id into which the view's markup will be rendered (jQuery normalized).
         *  template - {String} The mustache template to apply.
         *  context - {Object } The data to supply to mustache.
         */
        render : function(element, template, context) {
            jQuery(element).append(Mustache.to_html(template, context));
        }, // End of render

        /**
         * Method: add
         * Add a child view to this one. this method assumes that the view has a layout set for maneging sub-views
         * (if not then an error is thrown).
         *
         * Parameters:
         *  child - {t2k.core.View} A child view to add to this.
         */
        add: function(child) {
            // Reference the configuration object.
            var cfg = this.cfg;
            // Check for layout.
            if (!cfg.layout || !(cfg.layout instanceof t2k.core.layout.BaseLayout))
                throw "not layout is set for this view. sub-views cannot be added";
            // Check for content div.
            if (!this._content)
                throw "not content element is set for this view. sub-views cannot be added";
            // Delegate.
            this._super(child);
            
            // Layout
            this.cfg.layout.layout();
            
        }, // End of add.

        /**
         * Method: validate
         * Makes sure a template is set.
         */
        validate: function() {
            // Delegate()
            this._super();
            // Reference the configuration object.
            var cfg = this.cfg;
            // Check for template.
            if (cfg.template == null || cfg.template == 'undefined')
                throw "no template specified for this view.";
        }, // End of validate

        /**
         * Method: scroll
         * Scrolls to the child with the provided index.
         *
         * Parameters:
         *  index - {Number} The array location of the child. First child is at index 0.
         */
        scroll: function(index, callback, offset) {
            if (this.cfg.layout) this.cfg.layout.scroll(index, callback, offset);
        },

        /**
         * Method: setEnabled
         * De/Activates the view. This method adds/removes the 'disabled' CSS class to the view.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
            this._super(flag);
            if (flag) this._view.removeClass('disabled');
            else this._view.addClass('disabled');
        }, // End of setEnabled
        
        /**
         * Method: setVisible
         * 
         * Parameters:
         *  flag - {Boolean} True for visible, false otherwise.
         */
        setVisible: function(flag) {
        	this._super(flag);
        	if (!flag){
        		// hidden
        		this._view.addClass('visibleHidden');
        	} else {
        		// show
        		this._view.removeClass('visibleHidden');
        	}
        } // End of setVisible
        
    }); // End of t2k.core.View

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    function getUnderscoredChildren(baseId, parent) {
        jQuery(parent).find('[id^=' + baseId + '_]').each(function(index, elem) {
            console.log(jQuery(elem).attr('id').substring(baseId.length));
//            this['_' + jQuery(elem).attr('id')] = elem;
        });
//        var elems = jQuery(parent).find('[id^=' + baseId + '_]');
//        debugger
/*
        jQuery(parent).children().each(function(index, child) {
            alert(index + ' - ' + child);
        });
*/
    }

    /**
     * Private:
     * Method: getLayoutClass
     * constructs a layout management class that corresponds to the given name. This process makes use of a naming
     * convention (much like the creation of tasks). The layout name's first character is uppercased and the name is
     * appended with the 'Layout' suffix. The result is the name of the layout class under the 't2k.core.layout'
     * namespace.
     *
     * Parameters:
     *  name - {String} The name of the layout to create.
     */
    function getLayoutClass(name) {
        var layoutClassName = name.charAt(0).toUpperCase() + name.substring(1) + "Layout";
        return t2k.core.layout[layoutClassName];
    }

})();

////////////////////////////////////////
// SRC End --> t2k/core/View.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/BaseComponent.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.BaseComponent
     * A base class for all components.
     */
    t2k.component.BaseComponent = t2k.core.Presenter.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy({}, config));
            
            this.setParent();

            // init layout object
            this.layout = {};

            // init compiled xml obj.
            this.initWriteCompiled();
            
            // read compiled
            this.readCompiled();

            // init 'canReduce' as true
            // if the reduction will get to it's end, canReduce will be false
            this.layout.canReduce = true;

            // insert 'onRendered' function from the configuration to layout object
            if (this.cfg.onRendered) {
                this.layout.onRendered = this.cfg.onRendered;
            } else {
                console.error("{0}:\nonRendered() not found in cfg. You must provide onRendered() function in your cfg.".format(this.name));
                // throw "onRendered not found. You must provide onRendered function in your cfg";
            }

            // del 'onRendered' function from configuration
            delete this.cfg.onRendered;

        }, // End of ctor
        
        setParent : function(){
        	
    		if (typeof(this.cfg.parent) == 'string' ){
    			
    			if (this.cfg.parent.indexOf('#') == -1){
    				this.cfg.parent = '#' + this.cfg.parent;
    			} 
    			
    			this.cfg.parent = jQuery(this.cfg.parent)
    		}
        	
        },

        /**
         * createNewView
         * every composite / component must use this function to create it's view
         * this function will merge the 'onRendered' event and 'cantReduce' event to config.event,
         * and apply the componentViewCerified = true
         *
         * @param classObj
         * @param config
         * @returns {classObj}
         */
        createNewView : function(classObj, config) {
            // reference
            var thi$ = this;

            return new classObj(merge(config, {
            	
            events : {
                onRendered : function() {
                	
                    thi$.layout.onRendered();
                },

                cantReduce : function() {
                    thi$.layout.canReduce = false;
                }
            }, // end of 'events'

            viewCerified : true,
            
            dummyMode : thi$.cfg.dummyMode,
            
            compiledLayoutRes : thi$.compiledLayoutRes

            }));

        },
        
        /**
         * reductionAvailable
         * @returns {Boolean}
         */
        reductionAvailable : function() {
            return this.layout.canReduce;
        },
        
        /**
         * reduce
         * @param val
         */
        reduce : function(val) {
            if (typeof this.view.reduce === "function") {
	            this.view.reduce(val);
                this.writeCompiled('reduction', this.getReductionStep());
            } else {
	            this.dispatchEvent('cantReduce');
	            this.dispatchEvent('onRendered');
            }
        },

        /**
         * getReductionStep
         * @return {*}
         */
        getReductionStep : function(){
        	return !!this.view.getReductionStep ? this.view.getReductionStep() : 0;
        },

        /**
         * initWriteCompiled
         */
        initWriteCompiled : function(){
        	if (!!this.cfg.dummyMode  && !!this.cfg.data){
                this.compiledLayout = Compat.createNodeNextTo(this.cfg.data, 'compiled_layout', true);
                this.compiledLayout.attr({'reduction' : 0, 'type' : 'loose'});

                //this.compiledLayout.appendTo(jQuery(this.cfg.data));
                jQuery(this.cfg.data).append(this.compiledLayout.detach());
                this.compiledLayout.remove();
        	}
        },

        /**
         * writeCompiled
         * @param key
         * @param val
         */
        writeCompiled : function(key, val){
        	if (!!this.cfg.dummyMode){
        		this.compiledLayout.attr(key, val);
        	}
        },

        /**
         * readCompiled
         */
        readCompiled:function () {
            if (!this.cfg.dummyMode && !!this.cfg.data) {

                var compiledElement = jQuery(this.cfg.data).children('compiled_layout');
                this.compiledLayoutRes = {
                    reduction:compiledElement.attr('reduction'),
                    type:compiledElement.attr('type')
                };

                this.readCompiled_Private(compiledElement);

            /*    try {
                    console.log('comp: ' + this.cfg.data.tagName + ' reduction: ' + this.compiledLayoutRes.reduction + ' type: ' + this.compiledLayoutRes.type)
                } catch (e) {
                }*/

            }
        },

        /**
         * readCompiled_Private
         */
        readCompiled_Private : function(compiledElement){
        	
        },
        
        /**
         * Method: setEnabled
         * De/Activates the component.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
            // Delegate.
            this._super(flag);

            this.children.forEach(function(child) {
                child.setEnabled(flag);
            });
        },

        /**
         * loadInterMediateState
         */
//        loadInterMediateState: function() {
//            // Delegate.
//            this._super();
//
//            this.children.forEach(function(child) {
//                child.loadInterMediateState();
//            });
//        },
        
        /**
         * compact
         * compact and rendered
         */
        compact : function() {
	        this.layoutStatus = 'compact';
        	this.writeCompiled('type', 'compact');
            this.view.compact();
            this.layout.onRendered();
        },
		
        /**
         * resize
         * resize and rendered
         * @param size
         */
		resize : function(size){
			this.view.resize(size);
			this.layout.onRendered();
		},

        /**
         * setWidth
         * @param newWidth
         */
        setWidth : function(newWidth) {
            this.view.setWidth(newWidth);
			this.layout.onRendered();
        },

	    setMaxWidth : function(newWidth) {
		    if(typeof this.view.setMaxWidth == 'function') {
		        this.view.setMaxWidth(newWidth);
		    }
	    },

        /**
         * setHeight
         * @param newHeight
         */
        setHeight : function(newHeight) {
            this.view.setHeight(newHeight);
			this.layout.onRendered();
        },
        
		/**
		 * loose
		 * loose and rendered
		 */
        loose : function() {
			this.layoutStatus = 'loose';
        	this.writeCompiled('type', 'loose');
            this.view.loose();
            this.layout.onRendered();
        },

        /**
         * setState - parse state of current component
         * @param state - {jQuery} State xml
         */
        setState:function (state) {
        	//this.resetState();
            this.setMyState(state);
        },
        
        /**
         * resetState
         * place holder
         */
        resetState : function(){
        	// place holder
        },
        
        /**
         * getSize
         * @returns size
         */
        getSize : function(){
        	return this.view.getSize();
        },
        
        /**
         * looseHeight
         * loose view's height (tile prop.)
         */
        looseHeight: function(){
        	this.view.looseHeight();
        },
        
        /**
         * setHeight
         * @param val
         */
        setHeight : function(val){
        	this.view.setHeight(val);
        },

        /**
         * looseWidth
         */
        looseWidth : function(){
        	this.view.looseWidth();
        },

        /**
         * setWidth
         * @param val
         * @param overwriteLaydownSize- ignore the value in laydownsize and use the new value (used in text viewer)
         */
        setWidth : function(val, overwriteLaydownSize){
        	this.view.setWidth(val, overwriteLaydownSize);
        },

        /**
         * spaceEatingAvailable
         */
		spaceEatingAvailable : function(){
        	return false;
        },

        /**
         * resetTile
         */
        resetTile : function(){
        	this.view.resetTile();
        },

        /**
         * getHorizontalSize
         */
        getHorizontalSize : function(){
          return null;
        },

        /**
         * setVerticalLayout
         */
        setVerticalLayout : function(){
          // mtq place holder
        },

        /**
         * getState - create state of current component
         * @return state - {jQuery} State xml
         */
        getState:function () {
            var state = this.addMyState();
            if (state) {
                var children = state.children();
                return this.getStateTag().append(children);
            }
            return null;
        },
        
        /**
         * getTagName - get current component node name to use in state XML
         * @return nodeName - string
         */
        getTagName : function() {
            var nodeName;
            if (!!this.name) {
                nodeName = this.name.slice(this.name.lastIndexOf('.') + 1);
            } else {
                // 'Component without name';
                throw('Please provide Components name');
            }

            return nodeName;
        },
        
        /**
         * getStateTag - creates component state root node
         */
        getStateTag: function() {
            var stateTag = jQuery('<' + this.getTagName() + '/>', {
                enabled: !!this.isEnabled()
            });
            return stateTag;
        },

        /**
         * addMyState
         * adds component data to state, placeholder - will be overridden in derived classes
         * @return state - jQuery xml
         */
        addMyState : function() {
            return null;
        },
        
        /**
         * sets current component state, placeholder - will be overridden in derived classes
         * @param state
         */
        setMyState : function(state) {
        	// place holder
        },

        /**
         * Method: remove
         * Remove a child presenter from this children. This method assumes that this presenter already has a view set
         * (if not then an error is thrown).
         *
         * Parameters:
         *  child - {t2k.core.Presenter} A child presenter to be removed
         */
        remove: function(child) {
            // Check for view first.
            if (!this.view) throw "child components cannot be removed before the view is set";
            // Delegate.
            this._super(child);
            // Add the child's view to the array of children in this presenter's view.
            this.view.remove(child.view);
        }, // End of add.
        
        /**
         * Method: insert
         * Insert a child presenter into specified index in children array. This method assumes that this presenter already has a view set
         * (if not then an error is thrown).
         *
         * Parameters:
         *  child - {t2k.core.Presenter} A child presenter to be inserted
         *  index - Integer
        */
        insert : function(child, index){
            // Check for view first.
            if (!this.view) throw "child components cannot be removed before the view is set";
            // Delegate.
            this._super(child, index);
            // Add the child's view to the array of children in this presenter's view.
            this.view.insert(child.view, index);
        }, // End of insert.
        
        getReductionReport: function(){
        	return this.view.getReductionReport() ;
        },

        /**
         * addToSpecialConfiguration
         * @param addCfg
         */
        addToSpecialConfiguration:function (addCfg) {
            this.cfg.specialConfiguration = override(copy({}, this.cfg.specialConfiguration), addCfg);
        },
        removeSpecificFeedback: function(){
            this.view.removeSpecificFeedback();
        }

    }); // End of t2k.component.BaseComponent

})();
////////////////////////////////////////
// SRC End --> t2k/component/BaseComponent.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/BaseComponentView.js
////////////////////////////////////////
(function() {
	
	/**
	 * BaseComponentView
	 * every component will inherit BaseComponentView
	 */
	
	t2k.component.BaseComponentView = t2k.core.UiComponent.subClass({

			/** The class' name (for debugging purpose). */
			name : 't2k.component.BaseComponentView',

			/**
			 * @constructor
			 */
			ctor : function(config) {
				
				// delegate with genId()
				this._super(copy({}, config, { id:genId() }));
				
				// Reference the configuration object.
	            var thi$ = this;
	            var cfg = this.cfg;

	            // If the parent is a view and it uses layout management then call the layout's 'layout' method after
	            // rendering.
	            if (cfg.parent instanceof t2k.core.View) {
	                // Render the view.
	                this.render('#' + cfg.parent.cfg.id + '_content', cfg.template, cfg, cfg.partials);
	                if (cfg.parent.layout) cfg.parent.layout.layout(); // TODO: delete
	            } else {
	                this.cfg.parent = typeof cfg.parent == "object" ? cfg.parent : "#" + cfg.parent;
	                // Render the view.
	                this.render(this.cfg.parent, cfg.template, cfg, cfg.partials);
	            }


	            // Keep reference to the view's DOM element.
                this._view = Perf.select('#' + cfg.id);

                // Keep reference to all DOM elements with id suffix.
                this._view.find('[id^=' + cfg.id + '_]').each(function(index, elem) {
                    thi$[jQuery(elem).attr('id').substring(cfg.id.length)] = jQuery(elem);
                });
                
                // Apply trivial settings.
                if (cfg.width) this._view.width(this.cfg.width);
                if (cfg.height) this._view.height(this.cfg.height);
                
				// validate correct view creation
				// BaseComponent presenter (createNewView()) merge 'onRendered' event to config.events
				// and set componentViewCerified = true.
				// if !!!componentViewCerified, it's means that the 'new view' wasn't created by createNewView()
				if (!!!this.cfg.viewCerified){
					throw('componentViewCerified failure. Use createNewView() to create a view');
				}
				
				// delete validation param 
				delete this.cfg.componentViewCerified;
				
				// BaseComponentView will automatic dispatch 'onRendered' event to prevent dead lock
				// if you want to achieve a full control about the rendering order, 
				// simply override onViewRendered() function with an empty function
				this.onViewRendered();
				
			}, // end of ctor
			
			/**
			 * onViewRendered
			 * dispatch onRendered event
			 * this function may be override by (any) component / composite view,
			 * to achieve rendering correct order
			 */
			onViewRendered : function(){
				this.dispatchEvent('onRendered');
			}, // end of onViewRendered
			
			/**
	         * Method: render
	         * Renders the view.
	         *
	         * Parameters:
	         *  element - {Object/String} The element/id into which the view's markup will be rendered (jQuery normalized).
	         *  template - {String} The mustache template to apply.
	         *  context - {Object } The data to supply to mustache.
	         *  partials - {Object } Hash of partial mustache templates.
	         */
	        render : function(element, template, context, partials) {
	            jQuery(element).append(Mustache.to_html(template, context, partials));
				template = null;
	        }, // End of render
	        
	        /**
	         * compact
	         * set display inline-block
	         */
	        compact : function() {
                if (this._view && this._view.length) {
                    this._view[0].style.display = 'inline-block';
                    this._view[0].style.verticalAlign = 'top';
	                this._view.removeClass('loose').addClass('compact');
                }
	        },
	        
	        /**
	         * loose
	         * set display block
	         */
	        loose : function() {
                if(this._view.length) {
					this._view[0].style.display = 'block';
					this._view.removeClass('compact').addClass('');
                }
	        },
	        
	        /**
	         * getSize
	         * @returns size
	         */
	        getSize : function(){
	        	return {'width': Compat.actualWidth(this._view), 'height': Compat.actualHeight(this._view)};
	        },

	        /**
	         * getInnerSize
	         * place holder for flow
	         * @returns null
	         */
	        getInnerSize : function(){
	        	return null;
	        },
	        
	        /**
	         * resize
	         * resize dom
	         * @param size
	         */
	        resize : function(size){
	        	if (size){
	        		this.setWidth(size.width);
	        		this.setHeight(size.height);
	        	}
	        },

            /**
             * setWidth
             * @param newWidth
             */
            setWidth : function(newWidth) {
                this._view.width(newWidth);
                this.dispatchEvent('onRendered');
            },
        
			setMaxWidth : function (newWidth) {
				this._view.css('max-width', newWidth + 'px');
			},

            /**
             * setHeight
             * @param newHeight
             */
            setHeight : function(newHeight) {
                this._view.height(newHeight);
                this.dispatchEvent('onRendered');
            },

            /**
             * resetSize
             */
            resetSize : function() {
                this._view.width('').height('');
            },

	        /**
	         * looseHeight
	         * set height = '' (tile)
	         */
	        looseHeight: function(){
	        	this._view.height('');
	        },
	        
	        setHeight : function(val){
	        	this._view.height(val);
	        },
	        
	        looseWidth : function(){
	        	this._view.width('');
	        },
	        
	        setWidth : function(val){
	        	this._view.width(val);
	        },
	        
	        getReductionStep : function(){
	        	return this.reductionStep ? this.reductionStep : 0;
	        },

	        /**
             * resetTile
             * set height and width = ''
             */
            resetTile : function(){
                this._view.width('').height('');
            },
	        
	        /**
	         * Method: add
	         * Add a child view to this one. this method assumes that the view has a layout set for maneging sub-views
	         * (if not then an error is thrown).
	         *
	         * Parameters:
	         *  child - {t2k.core.View} A child view to add to this.
	         */
	        add: function(child) {
	            // Reference the configuration object.
	            var cfg = this.cfg;
//	            // Check for layout.
//	            if (!cfg.layout || !(cfg.layout instanceof t2k.core.layout.BaseLayout))
//	                throw "not layout is set for this view. sub-views cannot be added";
	            // Check for content div.
	            if (!this._view)
	                throw "not content element is set for this view. sub-views cannot be added";
	            // Delegate.
	            this._super(child);
	            
	        }, // End of add.

	        /**
	         * Method: validate
	         * Makes sure a template is set.
	         */
	        validate: function() {
	            // Delegate()
	            this._super();
	            // Reference the configuration object.
	            var cfg = this.cfg;
	            // Check for template.
	            if (cfg.template == null || cfg.template == 'undefined')
	                throw "no template specified for this view.";
	        }, // End of validate
	        
	        /**
	         * Method: dispose
	         * Removes the player's view element.
	         */
	        dispose: function() {
		        this._view && this._view.removeNative();
		        delete this._view;
		        this._super();
	        }, // End of dispose

            /**
             * Method: orderChildren
             * @param order_array - {Array} of indexes
             */
            orderChildren: function (order_array) {
                var thi$ = this;

                jQuery(order_array).each(function (index, value) {
                    if(!!thi$.children[value]) {
                        thi$.children[value]._view.insertAfter(thi$._view.children().last());
                    }
                });

                this._super();
            },

	        /**
	         * Method: setEnabled
	         * De/Activates the view. This method adds/removes the 'disabled' CSS class to the view.
	         *
	         * Parameters:
	         *  flag - {Boolean} True for active, false otherwise.
	         */
	        setEnabled: function(flag) {
	            this._super(flag);
	            if (flag) this._view.removeClass('disabled');
	            else this._view.addClass('disabled');
	        }, // End of setEnabled
	        
	        /**
	         * Method: setVisible
	         * 
	         * Parameters:
	         *  flag - {Boolean} True for visible, false otherwise.
	         */
	        setVisible: function(flag) {
	        	this._super(flag);
	        	if (!flag){
	        		// hidden
	        		this._view.addClass('visibleHidden');
	        	} else {
	        		// show
	        		this._view.removeClass('visibleHidden');
	        	}
	        }, // End of setVisible
	        
	        /**
	         * domRandomize
	         */
	        domRandomize : function(){
	        	
	        	var countOfChildren = this.children.length;
	        	
	        	// don't random if there is less than 2 children
	        	if (countOfChildren < 2) return;
	        	
	        	// map spacer
	        	var spacerMap = [];
	        	this._content.children().each(function(index, child){
	        		spacerMap[index] = !!(jQuery(child).attr('class') == 'spacer');
	        		if (spacerMap[index]) jQuery(child).remove();
	        	});
	        	
	            this.xmlRanDomInsert = Perf.create('randominsert');  //log of actions to make random movement (insertBefore/insertAfter) of children
	            this.xmlRandomRevert = Perf.create('randomrevert');  //log of actions in order to revert random movement of children (return to feeding order)

	            for(var i=0; i<=Math.floor(countOfChildren/2); i++){
	                var ranDomArray = this.getRandomArray(countOfChildren);

	                var lineRandomInsert = Perf.create('line');
	                lineRandomInsert.attr('firstindex',ranDomArray[0]);
	                lineRandomInsert.attr('secondindex',ranDomArray[1]);

	                var lineRandomRevert = Perf.create('line');

	                lineRandomRevert.attr('firstindex',ranDomArray[0]);

	                if(ranDomArray[0] < (countOfChildren-1)){
	                    this.children[ranDomArray[0]]._view.insertBefore(this.children[ranDomArray[1]]._view);
	                    lineRandomInsert.attr('action', 'insertBefore');
	                    lineRandomRevert.attr('secondindex',parseInt(ranDomArray[0]) + 1);
	                    lineRandomRevert.attr('action', 'insertBefore');

	                } else {
	                    this.children[ranDomArray[0]]._view.insertAfter(this.children[ranDomArray[1]]._view);
	                    lineRandomInsert.attr('action', 'insertAfter');
	                    lineRandomRevert.attr('secondindex',parseInt(ranDomArray[0]) - 1);
	                    lineRandomRevert.attr('action', 'insertAfter');
	                }

	                this.xmlRanDomInsert.append(lineRandomInsert);
	                this.xmlRandomRevert.append(lineRandomRevert);
	            }
	            
	            // set spacers
	            var spacerMapIdx = 0;
	            this._content.children().each(function(index, child){
	            	if (spacerMap[spacerMapIdx]){
                        Perf.create("div").attr('class','spacer').insertBefore(jQuery(child));
	            		spacerMapIdx++;
	            	}
	            	spacerMapIdx++;
	        	});

	        },
	        
	         /**
	          * getRandomArray - return 2 indexes from children array - child to move and child to move after
	          * @param countOfChildren
	          */
	        getRandomArray : function(countOfChildren){
	            var indexArray = new Array(countOfChildren);

	            for(var i=0 ; i < countOfChildren ; i++) {
	              indexArray[i] = i;
	            }

	            var resultArray = [];
	            resultArray.push(indexArray.splice(Math.random()*indexArray.length,1));
	            resultArray.push(indexArray.splice(Math.random()*indexArray.length,1));

	            return resultArray;
	        },

            /**
             * getReductionReport
             */
	        getReductionReport: function() {
	        	return { percent: 100, belowRead: false, belowAbs: false } ;
	        },

	        setSpecificFeedback: function(message, parentClass){
	            var parentDomObj = this._view.find('.status_icon').parent();
	            
	            this.SpecificFeedbackBalloon = new t2k.player.task.controls.SpecificFeedbackBalloon(copy({
	                data : message[0],
	                parent: parentDomObj,
	                parentClass: parentClass,
	                onRendered: function() {
	                }
	            }));

	        },
	        removeSpecificFeedback: function(){
	        	this.SpecificFeedbackBalloon && this.SpecificFeedbackBalloon.remove();
	        }
			
		});
	
})();

////////////////////////////////////////
// SRC End --> t2k/component/BaseComponentView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/CompositeConstants.js
////////////////////////////////////////
/*
 * Composite constants (layout sequence definitions).
 * Valid sections are: init, reduce, loose, compact
 */
t2k.component.CompositeConstants = {
    tileSequence: {
        init: [
            {inlineChildren: null},
            {resetTile: null},
            {tile: null},
            {squeezeComposite: false}
        ],
        compact: [
            {resetTile: null},
            {compactChildren: null},
            {tile: null},
            {squeezeComposite: false},
            {spaceEater: 'all'},
            {looseHeight: null},
            {tileHeight: null}
        ],
        loose: [
            {resetTile: null},
            {tile: null},
            {squeezeComposite: false}
        ],
        reduce: []
    }
};

////////////////////////////////////////
// SRC End --> t2k/component/CompositeConstants.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/Composite.js
////////////////////////////////////////
(function() {

    var constants = t2k.component.CompositeConstants;

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Class Declaration.
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.Composite A base class for all composites.
     */
    t2k.component.Composite = t2k.component.BaseComponent.subClass({

        /**
         * Constructor: ctor The constructor
         *
         * Parameters: config - {Object} Configuration details.
         */
        ctor : function(config) {
            // Delegate.
            this._super(config);
            this.initCompositeLayouter();
            this.layout.setLayoutSequence('init');
        }, // End of ctor
        
        /**
         * initCompositeLayouter
         * init composite layouter declarations and functions
         */
        initCompositeLayouter : function() {

            // ref
            var thi$ = this;

            // get numOfChildren from xml
            this.layout.compiledNumOfChildren = jQuery(this.cfg.data).attr('numOfChildren') || 0;

            try {
                if (!!!this.layout.compiledNumOfChildren || this.layout.compiledNumOfChildren == 0)
                    this.layout.onRendered();
            } catch(e) {
                // do nothing
            }


            /**
             * Initialize layout sequence (layout sequence is an array that provides layouting commands).
             */
            if (!jQuery.isArray(thi$.layout.layoutSequence)) {
                thi$.layout.layoutSequence = [];
            }

            /**
             * Initialize layout sequence handlers, if none defined in subclass,
             * or get layout sequence by name (see CompositeConstants).
             */
            if (typeof thi$['layoutSequenceDef'] === 'undefined') {
                thi$.layoutSequenceDef = {};
            } else if (typeof thi$['layoutSequenceDef'] === 'string') {
                thi$.layoutSequenceOriginal =thi$.layoutSequenceDef;
                thi$.layoutSequenceDef = copy({}, constants[thi$.layoutSequenceDef]);
            }

            /** Initialize layout sequence handlers (sections). */
            ['init', 'loose', 'compact', 'reduce'].forEach(function(section) {
                if (!jQuery.isArray(thi$.layoutSequenceDef[section])) {
                    thi$.layoutSequenceDef[section] = [];
                }
            });

            /** Add call to inline() to the front of layout sequence. */
            if (thi$.initInlineLayout) {
                thi$.layoutSequenceDef['init'].splice(0, 0, {inline: null});
            }

            /** Activate layout sequence. */
            thi$.layout.setLayoutSequence = function(section) {
                thi$.layout.layoutSequence = copy([], thi$.layoutSequenceDef[section]);
                thi$.layout.layoutSequenceCounter = 0;
            };


            // default for disable spaceEating
            this.layout.disableSpaceEating = function() {
                return null;
            };

            /**
             * .layout.command
             * handle composite layout commabd
             * @param command
             */
            this.layout.command = function(command) {

                // get command's key & value
                for (var value in command) {
                    command.com = value;
                    command.args = command[value];
                }

                // handle command
                switch (command.com) {
                    case 'tile':
                        var maxSize = thi$.getChildrenMaxSize();
                        thi$.resizeChildren(maxSize);
                        break;

                    case 'resetTile':
                        thi$.view._view.find('.spacer').remove();
                        thi$.resetChildrenTile();
                        thi$.compositeRenderComplete();
                        break;

                    case 'looseHeight':
                    	thi$.looseChildrenHeight();
                    	thi$.compositeRenderComplete();
                    break;
                        
                    case 'tileHeight':

                    	var maxHeight = 0, childHeight;
                    	
                    	jQuery(thi$.children).each(function(index, child){
                    		childHeight = child.view._view.outerHeight();
                    		maxHeight = maxHeight > childHeight ? maxHeight : childHeight;
                    	});
                    	
                    	jQuery(thi$.children).each(function(index, child){
                    		child.setHeight(maxHeight);
                    	});
                    	
                    	thi$.compositeRenderComplete();
                    break;

                    case 'adjustHeight' :
                        thi$.adjustHeight();
                        thi$.compositeRenderComplete();
                        break;

                    default :
                        if (typeof thi$[ command.com ] === "function")
                    	thi$[ command.com ]( command.args );
                    	break;
                }

            };

            /**
             * resetRenderedCounter
             */
            this.layout.resetRenderedCounter = function() {
                thi$.layout.onRenderedCounter = 0;
            };

        },

        /**
         * createNewView
         * @param classObj
         * @param config
         * @returns view object
         */
        createNewView : function(classObj, config) {
            return new classObj(merge(config, {
            	viewCerified : true,
            	dummyMode : this.cfg.dummyMode
            }));
        },

        /**
         * Method: startComposite Add children from a data xml.
         *
         * Parameters: cfg - {Object} a configuration object that holds
         * the data. tagName - {String} the name of the XML element to
         * parse for children.
         *
         * @returns {Boolean} - xml validation
         */
        startComposite2 : function(cfg, tagName) {

            // reset rendered counter
            this.layout.resetRenderedCounter();

            // declarations
            var newComponent, thi$ = this, ret = false, xml = jQuery(this.cfg.data), specialConfiguration = null;

            // xml validation
            if (tagName)
                xml = xml.find(tagName).get(0);
            else
                xml = xml.get(0);

            if (xml) {
                ret = true;
                this.isComposite = true;

                // parse the first childNodes
                jQuery(xml).children().each(function(index, element) {

                    // delete the provided rendered function
                    // (the original function saves as layout.onRendered()
                    delete cfg.onRendered;

                    if (thi$.cfg.specialConfiguration){
                        specialConfiguration = thi$.cfg.specialConfiguration;
                        delete specialConfiguration.parent;
                        delete specialConfiguration.data;
                        delete specialConfiguration.container;
                    }

                    // create child component, and merge composite's onRendered
                    newComponent = componentFactory.create(copy({
                        data : element,
                        container: cfg.container || thi$.cfg.container,
                        specialConfiguration: specialConfiguration,
                        // init components with dummyMode (Boolean)
                        dummyMode : thi$.cfg.dummyMode
                    }, merge(cfg, {onRendered : function() {

                        // set rendered counter
                        thi$.layout.onRenderedCounter++;

                        // on full composite rendered, call compositeRenderComplete()
                        if (thi$.layout.onRenderedCounter == thi$.layout.compiledNumOfChildren) {
                            // if rendered happens before all children added
                            if (thi$.children.length == thi$.layout.compiledNumOfChildren) {
                                thi$.compositeRenderComplete();
                            }
                        }
                    }
                    })));

                    if (newComponent) {
                        // add child
                        thi$.add(newComponent);

                        // if rendered happens before all children added
                        if (thi$.layout.onRenderedCounter == thi$.layout.compiledNumOfChildren) {
                            thi$.compositeRenderComplete();
                        }

                    } else {

                        // if !newComponent
                        //thi$.layout.onRenderedCounter--;
                    }

                });
            }

            return ret;
        }, // End of startComposite

        /**
         * compositeRenderComplete
         * this functions calls on full composite's rendering
         */
        compositeRenderComplete : function() {

            // reference
            var thi$ = this;

            // if all the children can't reduce, canReduce will stay 'false'
            // if one of the children is reductionAvailable, set composite's canReduce flag as true
            this.layout.canReduce = this.children.some(function(child) {
                return child.reductionAvailable();
            });

            // reset layout counter
            this.layout.resetRenderedCounter();

            // on composite's layoutSequence, start layout command.
            // on done || if (!layoutSequence), call on composite rendered
            if (this.layout.layoutSequence.length > this.layout.layoutSequenceCounter) {
                this.layout.layoutSequenceCounter++;
                this.layout.command(copy({}, this.layout.layoutSequence[this.layout.layoutSequenceCounter - 1]));
            } else {
                this.layout.layoutSequenceCounter = 0;
                this.layout.layoutSequence = [];
                this.layout.onRendered();
            }

        },

        /**
         * getChildrenMaxSize
         * @returns {childrenMaxWidth, childrenMaxHeight}
         */
        getChildrenMaxSize : function() {

            var childrenSize, maxWidth = 0, maxHeight = 0;

            jQuery(this.children).each(function(index, child) {
                childrenSize = child.getSize();
                maxHeight = Math.max(childrenSize.height, maxHeight);
                maxWidth = Math.max(childrenSize.width, maxWidth);
            });
            // return max size
            return {'width' : maxWidth, 'height' : maxHeight};
        },

        /**
         * resizeChildren
         * @param size
         */
        resizeChildren : function(size) {
            jQuery(this.children).each(function(index, child) {
                child.resize(size);
            });
        },

        /**
         * resizeChildrenWidth
         * @param width
         */
        resizeChildrenWidth : function(width){
        	jQuery(this.children).each(function(index, child) {
                child.setWidth(width);
            });
        },

        /**
         * setHeight
         * @param val
         */
/*
        setHeight : function(val){
        	this._super();
        	var innerHeight = 0, maxInnerHeight = 0, innerSize;
        	
        	// max inner height
        	jQuery(this.children).each(function(index, child) {
        		innerSize = child.view.getInnerSize();
        		if (innerSize) innerHeight = innerSize.height;
        		maxInnerHeight = maxInnerHeight > innerHeight ? maxInnerHeight : innerHeight;
        	});
        	
        	
        	jQuery(this.children).each(function(index, child) {
        		child.setHeight(maxInnerHeight ? maxInnerHeight : val);
        	});
        },
*/

        /**
         * resize
         * @param size
         * @param widthOnly
         */
        resize : function(size, widthOnly) {
            // ref
            var thi$ = this;
            // resize me
            this.view.resize(size);
            // reset rendered counter
            this.layout.resetRenderedCounter();
            // get composite inner size
            var innerSize = this.view.getInnerSize();
            // resize children with composite's innerSize (else, set size)
            jQuery(this.children).each(function(index, child) {
                child.resize(innerSize ? innerSize : size);
            });
        },
        
        /**
         * setWidth
         * @param newWidth
         * @param overwriteLaydownSize- ignore the value in laydownsize and use the new value (used in text viewer)
         */
        setWidth : function(newWidth, overrideLaydownSize) {
            // ref
            var thi$ = this;
            // set new width
            this.view.setWidth(newWidth);
            // reset rendered counter
            this.layout.resetRenderedCounter();
            // get composite inner size
            var innerSize = this.view.getInnerSize();
            // resize children with composite's innerSize (else, set size)
            jQuery(this.children).each(function(index, child) {
                child.setWidth(innerSize ? innerSize.width : newWidth, overrideLaydownSize);
            });
        },
        
	    setMaxWidth: function(newWidth) {
		    this._super(newWidth);

		    this.children.forEach(function(child, index){
			    child.setMaxWidth(newWidth);
		    });
	    },

        /**
         * setHeight
         * @param newHeight
         */
        setHeight : function(newHeight) {
            // ref
            var thi$ = this;
            // set new Height
            this.view.setHeight(newHeight);
            // reset rendered counter
            this.layout.resetRenderedCounter();
            // get composite inner size
            var innerSize = this.view.getInnerSize();
            // resize children with composite's innerSize (else, set size)
            jQuery(this.children).each(function(index, child) {
                child.setHeight(innerSize ? innerSize.height : newHeight);
            });
        },

        /**
         * compact
         */
        compact : function() {
	        this.layoutStatus = 'compact';
            this.layout.setLayoutSequence('compact');

            // compact me
            this.view.compact();

            if (this.children == 0) {
                this.layout.onRendered();
                return;
            }
            // resetRenderedCounter
            this.layout.resetRenderedCounter();

            if (this.layoutSequenceOriginal == 'tileSequence') {
                this.compositeRenderComplete();
            } else {
                this.compactChildren();
            }
        },

        /**
         * compactChildren
         */
        compactChildren : function() {
            /*
            jQuery(this.children).each(function(index, child) {
                child.compact();
            });
            */
            for (var i = 0, j = this.children.length; i < j; ++i) {
                this.children[i].compact();
            }
        },

        /**
         * inline
         * Called if initInlineLayout is set on child.
         */
        inline : function() {
            this.view.compact();
            this.compositeRenderComplete();
        },

        /**
         * inlineChildren
         * css inline-block
         */
        inlineChildren : function() {
            this.children.forEach(function(child) {
                child.view._view.length && (child.view._view[0].style.display = 'inline-block');
            });
            this.compositeRenderComplete();
        },

        /**
         * loose
         */
        loose : function() {
	        this.layoutStatus = 'loose';
            this.layout.setLayoutSequence('loose');

            // loose me
            this.view.loose();

            if (this.children == 0) {
                this.layout.onRendered();
                return;
            }

            // resetRenderedCounter
            this.layout.resetRenderedCounter();

            if (this.layoutSequenceOriginal == 'tileSequence') {
                this.compositeRenderComplete();
            } else {
                this.looseChildren();
            }
        },

        /**
         * looseChildren
         */
        looseChildren : function() {
            jQuery(this.children).each(function(index, child) {
                child.loose();
            });
        },

        /**
         * reduce
         * @param val
         */
        reduce : function(val) {
            this.layout.setLayoutSequence('reduce');

            if (this.children == 0) {
                this.layout.canReduce = false;
                this.layout.onRendered();
                return;
            }
            // resetRenderedCounter
            this.layout.resetRenderedCounter();

            this.children.forEach(function(child) {
                child.reduce();
            });
        },
        
        getReductionStep : function(){
        	return 0;
        },

        /**
         * looseComposite
         */
        looseComposite: function() {
            this.view._view.width('');
        },

        /**
         * resetChildrenTile
         */
        resetChildrenTile : function(){
        	this.children.forEach(function(child) {
                child.resetTile();
            });
        },

        /**
         * resetTile
         * css width & height reset
         * and return to compositeRenderComplete
         */
        resetTile : function() {
        	this._super();
        	this.layout.resetRenderedCounter();        	
        	
        	this.view._view.find('.spacer').remove();
        	
            this.children.forEach(function(child) {
                child.resetTile();
            });
            
//            this.compositeRenderComplete();
        },

        /**
         * squeezeComposite
         * @param domSqueeze {Boolean}
         */
        squeezeComposite: function(domSqueeze, afterState) {

            if (this.children.length < 1) {
                return;
            }
            if (!!!this.squeeze)  this.squeeze = {};

            this.squeeze.looseWidth = this.view._view.width();

            this.view._view.find('.spacer').each(function(index, child) {
                jQuery(child).remove();
            });

            if (!!!domSqueeze) {
                this.view._view.width('');
            }

            this.squeeze.compositeMap = [];
            this.squeeze.compositeLines = 1;
            this.squeeze.compositeWidth = this.view._view.width();

            var widthCounter = 0;

            var domChildren = this.view._content.children();

            for (var index = 0; index < domChildren.length; index++) {

                var childId = jQuery(domChildren[index]).attr('id');
                if (!childId) continue;

                var childIndex = this.getChildIndexById(childId),
                    jQ = jQuery(this.children[childIndex].view._view),
                    item = {
                        'jQ'        : jQ,
                        'index'     : index,
                        'width'     : Compat.fullOuterWidth(jQ),
                        'height'    : jQ.outerHeight(true)
                    };
                this.squeeze.compositeMap.push(item);

                widthCounter += item.width;

                if (widthCounter > this.squeeze.compositeWidth) {
                    this.squeeze.compositeWidth = widthCounter - item.width;
                    this.squeeze.compositeLines++;

                    widthCounter = 0;
                }
            }


            if (this.children.length > 1) {

                if (this.squeeze.compositeMap[0].jQ.offset().left == this.squeeze.compositeMap[1].jQ.offset().left) {
                    if (!!!afterState) {
                        this.compositeRenderComplete();
                    }
                    return;
                }



                var newWidth = this.getSqueezedWidth();
                if (newWidth > 0) {

                    //in order to get real width we need to add element borders width + side padding
                    var widthAddition =
                        (parseInt(this.view._view.css('borderLeftWidth'))  || 0) +
                        (parseInt(this.view._view.css('borderRightWidth')) || 0) +
                        (parseInt(this.view._view.css('paddingLeft'))      || 0) +
                        (parseInt(this.view._view.css('paddingRight'))     || 0);
                    newWidth += widthAddition;
                    this.view._view.width(newWidth);

                    if (!domSqueeze) {
                        var firstChildLeft = this.squeeze.compositeMap[0].jQ.offset().left;

                        this.squeeze.maxElementInOneLine = 1;
                        var tempMax = 1;

                        for (var index = 1; index < this.squeeze.compositeMap.length; ++index) {
                            ++tempMax;
                            if (this.squeeze.compositeMap[index].jQ.offset().left == firstChildLeft) {
                                Perf.create("div").attr('class','spacer').insertBefore(this.squeeze.compositeMap[index].jQ);

                                if (tempMax > this.squeeze.maxElementInOneLine) {
                                    this.squeeze.maxElementInOneLine = tempMax - 1;
                                }

                                tempMax = 0;
                            }
                        }

                        this.squeeze.squeezedWidth = this.view._view.width();
                        this.view._view.width(this.squeeze.looseWidth + widthAddition);

                    }

                }
            }


            // return to render function for more commands or rendered
            if(!!!afterState) {
                this.compositeRenderComplete();
            }

        },

        /**
         * getChildIndexById
         * @param childId
         */
        getChildIndexById : function(childId) {
            var ret;
            jQuery(this.children).each(function(index, child) {
                if (child.view.cfg.id == childId) {
                    ret = index;
                }
            });

            if (ret < 0) throw ('getChildIndexById error');
            return ret;
        },

        /**
         * getSqueezedWidth
         * @returns squeezedWidth
         */
        getSqueezedWidth: function() {
            this.squeeze.widthSimulation = this.squeeze.compositeWidth;
            return this.simulateSqueezedComposite() ? this.squeeze.compositeWidth : '';
        },

        /**
         * simulateSqueezedComposite
         * recursive function
         */
        simulateSqueezedComposite: function() {

            this.squeeze.widthSimulation--;
            var widthCounter = 0;
            var simulateLines = 1;
            this.squeeze.maxWidthSimulation = 0;

            for (var index = 0; index < this.squeeze.compositeMap.length; index++) {

                widthCounter += this.squeeze.compositeMap[index].width;
                if (widthCounter > this.squeeze.widthSimulation) {
                    var lineWidth = widthCounter - this.squeeze.compositeMap[index].width;
                    this.squeeze.maxWidthSimulation = this.squeeze.maxWidthSimulation < lineWidth ? lineWidth : this.squeeze.maxWidthSimulation;
                    widthCounter = this.squeeze.compositeMap[index].width;
                    simulateLines++;
                }
            }

            this.squeeze.widthSimulation = this.squeeze.maxWidthSimulation;

            if (simulateLines > this.squeeze.compositeLines) {
                return true;
            } else {
                this.squeeze.compositeWidth = this.squeeze.widthSimulation;
                return this.simulateSqueezedComposite();
            }
        },

        /**
         * simulateSizeByWidth - simulate component width according to given width
         * @param width
         */
        simulateSizeByWidth : function(width){
            this.createSqueezeMap();

	        var obj_view = this.view._view, widthAddition = 0;
	        widthAddition += obj_view.css("margin-left").px2int() + obj_view.css("margin-right").px2int(); //Total Margin Width
	        widthAddition += obj_view.css("borderLeftWidth").px2int() + obj_view.css("borderRightWidth").px2int(); //Total Border Width

	        width -= widthAddition;

	        var heightAddition = 0;
	        heightAddition += obj_view.css("margin-top").px2int() + obj_view.css("margin-bottom").px2int(); //Total Margin Height
	        heightAddition += obj_view.css("borderTopWidth").px2int() + obj_view.css("borderBottomWidth").px2int(); //Total Border Height

	        var size = {'width' : 0, 'height' : 0};
            var line = {'width' : 0, 'height' : 0};
            var lines = [];
            var maxLineWidth = 0, maxLineHeight = 0;
            var lastChecked_newLine, largerChild = false;

            jQuery(this.squeeze.compositeMap).each(function(index, child){
                if ((maxLineWidth + child.width) > width){

                    // stop rec. on child width is larger than width
                    if (child.width > width) {
                        largerChild = true;
                        return;
                    }

                    line.height = (maxLineHeight > child.height) ? maxLineHeight : child.height;
                    line.width = maxLineWidth;

                    lines.push({'width' : line.width, 'height' : line.height});

                    maxLineWidth = child.width;
                    maxLineHeight = child.height;
                    lastChecked_newLine = true;

                } else {

                    maxLineWidth += child.width;
                    maxLineHeight = (maxLineHeight > child.height) ? maxLineHeight : child.height;
                    lastChecked_newLine = false;
                }
            });

            if (largerChild) return null;

            line.height = maxLineHeight;
            line.width = maxLineWidth;
            lines.push(line);
            
            // set size
            jQuery(lines).each(function(index, line){
                size.height += line.height;
                size.width = (size.width > line.width) ? size.width : line.width;
            });

            size.width = (size.width + widthAddition);
            size.height = (size.height + heightAddition);

            return size;

        },

        /**
         * setVerticalLayout
         */
        setVerticalLayout : function(){
            this._super();
            jQuery(this.children).each(function(index, child){
                child.setVerticalLayout();
            });
        },

        /**
         * createSqueezeMap
         */
        createSqueezeMap : function(){

            if (!!!this.squeeze)
                this.squeeze = {};

            this.squeeze.compositeMap = [];

            var domChildren = this.view._content.children();

            for (var index = 0; index < domChildren.length; index++) {

                var childId = jQuery(domChildren[index]).attr('id');
                if (!childId) continue;

                var childIndex = this.getChildIndexById(childId);
                var item = {};
                var jQ = jQuery(this.children[childIndex].view._view);
                item.jQ = jQ;
                item.index = index;

                if (this.children[childIndex].getVerticalSize) {
                    var sizeV = this.children[childIndex].getVerticalSize(true);
                    item.width = sizeV.width;
                    item.height = sizeV.height;
                } else {
                    item.width = jQ.outerWidth(true);
                    item.height = jQ.outerHeight(true);
                }

                this.squeeze.compositeMap.push(item);
            }
            
        },

        /**
         * spaceEater
         * @param type
         */
        spaceEater: function(type) {
        	
        	var thi$ = this;
        	var direction = thi$.view._view.css('direction');
        	
        	/**
        	 * spaceEater functions [start]
        	 */ 
        	
				var getTextViewer = function(){
	        		
	        		var componentName, ret = null;
	        		jQuery(thi$.children).each(function(index, child){
	        			componentName = child.name.toLowerCase().split('.');
	        			componentName = componentName[componentName.length - 1];
	        			if (componentName == 'textviewer'){
	        				ret = child;
	        			}
	        		});
	        		return ret;
	        	};
	        	
	        	var getFirstLineRemainder = function(firstLineComponentsArray){
	        		
	        		var firstLineComponentsWidth = 0;
	        		
	        		jQuery(firstLineComponentsArray).each(function(index, child){
						if(child && child.view && child.view._view.length){
							firstLineComponentsWidth += child.view._view.outerWidth() + child.view._view.css('margin-right').px2int() + child.view._view.css('margin-left').px2int();
						}
	        		});
	        		
	        		var remainder = thi$.view._view.width() - firstLineComponentsWidth;
	        		return  remainder;
	        		
	        	};
	        	
	        	var getFirstLineComponentsArray = function(){
	        		var firstLineComponentsArray = [];
	        		var firstOffset = getOffset(thi$.children[0]);
	        		var ret;
	        			
	        		jQuery(thi$.children).each(function(index, child){
	        			
	        			if (index == 0){
	        				
	        				firstLineComponentsArray.push(child);
	        				
	        			} else {
	        				
	        				if (getOffset(child) != firstOffset && !ret){
	        					firstLineComponentsArray.push(child);
	        				} else {
	        					ret = true;
	        				}
	        			}
	        			
	        		});
	        		
	        		return firstLineComponentsArray;
	        		
	        	};
	        	
	        	var getOffset = function(child){
					var tmpOffset = 0;
					if(child && child.view && child.view._view.length){
						tmpOffset = child.view._view.offset().left + (direction == 'rtl' ? child.view._view.width() : 0);
					}
	        		return tmpOffset;
	        	};
        	
        	/**
        	 * spaceEater functions [end]
        	 */
            switch(type){

                case 'all':
                    // get remainder value
                    var remainder = (this.squeeze.looseWidth - this.squeeze.squeezedWidth) / this.squeeze.maxElementInOneLine;
                    if (this.spaceEatingAvailable()) this.expandChildrenWidth(remainder);

                    this.compositeRenderComplete();
                    
                break;

                case 'mtqArea':

                    // TODO: not finished. - wating for QA and more PRD
                    var remainder = (this.mtqArea.squeeze.looseWidth - this.mtqArea.squeeze.squeezedWidth) / this.mtqArea.squeeze.maxElementInOneLine;
//                    if (this.mtqArea.spaceEatingAvailable()){
//                        console.log('mtqSpaceEater reminder: ' + remainder)
//                    }

                    //this.expandChildrenWidth(remainder);
                    this.compositeRenderComplete();

                break;

                default:

                    var textViewer = getTextViewer();

                    // if textViewer doesn't exist, do nothing
                    if (!textViewer){

                        this.compositeRenderComplete();

                    } else {
                        var firstLineRemainder = getFirstLineRemainder(getFirstLineComponentsArray());
                        textViewer.spaceEaterAddWidth(firstLineRemainder);
                        thi$.compositeRenderComplete();
                    }

                break;

            }



        },
        
        spaceEatingAvailable : function(){
        	var ret = false;
        	
        	jQuery(this.children).each(function(index, child){
        		if (child.spaceEatingAvailable()) ret = true;
        	});
        	
        	return ret;
        },

        /**
         * expandChildrenWidth
         * @param addWidth
         */
        expandChildrenWidth : function(addWidth) {

            if (!!!this.layout.disableSpaceEating()) {

                var expendedChildWidth = this.children[0].view._view.width() + addWidth;
                this.resizeChildrenWidth(expendedChildWidth);
            }

        },

        /**
         * looseChildrenWidth
         */
        looseChildrenWidth : function() {
            jQuery(this.children).each(function(index, child) {
                child.looseWidth();
            });
        },

        /**
         * looseChildrenHeight
         */
        looseChildrenHeight: function() {
            jQuery(this.children).each(function(index, child) {
                child.looseHeight();
            });
        },

        /**
         * looseHeight
         */
        looseHeight : function() {
            // delegate
            this._super();
            jQuery(this.children).each(function(index, child) {
                child.looseHeight();
            });
        },

        /**
         * getState - creates state of composite component and it's children
         * @return state
         */
        getState : function() {
            var childState;
            var childrenState = Perf.create('children');  //children state
            this.children.forEach(function(child, index) {

                childState = child.getState();

                if (childState && childState.jquery) {
                    childState.attr('index', index);
                    childrenState.append(childState);
                }
            });

            var mystate = this.addMyState();  //component state

            var state;

            if (mystate == null && childrenState.children().length == 0) {
                return null;
            } else {
                state = this.getStateTag();

                if (mystate) {
                    state.append(jQuery(mystate).children());
                }

                if (childrenState.children().length > 0) {
                    state.append(jQuery(childrenState));
                }
            }

            return state;
        },
        /**
         * setState - parse state of composite component and it's children
         * @param state - xml
         */
        setState : function(state) {
            this._super(state);

            state = jQuery(state);

            if ((state.length > 0) && (state.children('children').length > 0)) {
                var thi$ = this;
                var childIndex;

	            function setChildState(index, childState) {
		            childState = jQuery(childState);
		            childIndex = parseInt(childState.attr('index'));

		            thi$.children[childIndex] && thi$.children[childIndex].setState(childState);
	            }

                state.children('children').children().each(setChildState);
            }
        },

        /**
         * getChildrenByClass return array of children with specific class
         * @param className String
         */
        getChildrenByClass : function(className) {
            var arrChildren = [];

            this.children.forEach(function(child) {
                if (Object.getPrototypeOf(child).name == (className)) {
                    arrChildren.push(child);
                }
            });
            return arrChildren;
        }


    }); // End of t2k.component.Composite

    t2k.component.Composite.isComposite = true;

})();
////////////////////////////////////////
// SRC End --> t2k/component/Composite.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/CompositeView.js
////////////////////////////////////////
(function() {
	
	/**
	 * CompositeView
	 * every composite will inherit CompositeView
	 */
	
	t2k.component.CompositeView = t2k.component.BaseComponentView.subClass({

			/** The class' name (for debugging purpose). */
			name : 't2k.component.CompositeView',

			/**
			 * @constructor
			 */
			ctor : function(config) {
				// delegate 
				this._super(config);
			}, // end of ctor
			
			/**
			 * onViewRendered
			 * override
			 */
			onViewRendered : function(){
				// do nothing
			}, // end of onViewRendered
			
	        compact : function(){
	        	this._view.css('display','inline-block');
	        },
	        
	        loose : function(){
	        	this._view.css('display','block');
	        }//,
	        
//	        /**
//	         * Method: add
//	         * Add a child view to this one. this method assumes that the view has a layout set for maneging sub-views
//	         * (if not then an error is thrown).
//	         *
//	         * Parameters:
//	         *  child - {t2k.core.View} A child view to add to this.
//	         */
//	        add: function(child) {
//	            // Reference the configuration object.
//	            var cfg = this.cfg;
////	            // Check for layout.
////	            if (!cfg.layout || !(cfg.layout instanceof t2k.core.layout.BaseLayout))
////	                throw "not layout is set for this view. sub-views cannot be added";
//	            // Check for content div.
//	            if (!this._content)
//	                throw "not content element is set for this view. sub-views cannot be added";
//	            // Delegate.
//	            this._super(child);
//	            
//	        } // End of add.

		});
	
})();

////////////////////////////////////////
// SRC End --> t2k/component/CompositeView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/options/Options.js
////////////////////////////////////////
(function() {

    t2k.component.options.Options = t2k.component.Composite.subClass({
    	
    	/** The class' name (for debugging purpose). */
        name: 't2k.component.options.Options',

        layoutSequenceDef: 'tileSequence',

        ctor: function(config) {
            // Delegate
            this._super(config);
            var thi$ = this;
            
            this.view = this.createNewView(t2k.component.options.OptionsView, this.cfg);
            this.startComposite2(copy({parent: this.view.cfg.id + '_content'}, config));
            
            this.layout.disableSpaceEating = function(){
            	return thi$.children[0].layout.disableSpaceEating();
            };
            
            if (jQuery(this.cfg.data).attr('random') == 'true'){
            	this.view.domRandomize();
            }
        },
        
        /**
         * setMyState
         * override - set state of component
         * @param state
         */
        setMyState : function(state){
        	// reference
        	var thi$ = this;

        	if(state.length > 0){
                this.setEnabled(jQuery(state).attr('enabled') === 'true');
                
                //apply reverse random order of bank subAnswers from state
                jQuery(state).find('randominsert').children().each(function(index, line){

                    var firstElement = thi$.view.children[parseInt(jQuery(line).attr('firstindex'))];
                    var secondElement = thi$.view.children[parseInt(jQuery(line).attr('secondindex'))];

                    try {
                        if(jQuery.trim(jQuery(line).attr('action')) == 'insertBefore'){
                            firstElement._view.insertBefore(secondElement._view);
                        } else {
                            firstElement._view.insertAfter(secondElement._view);
                        }

                    } catch(e){
                    }

                });

                this.squeezeComposite(true, true);
            }
        },	
        
        /**
         * addMyState
         * override - get state of component
         * @returns state
         */
        addMyState : function(){
            var state = Perf.create('state');
            state.append(this.view.xmlRanDomInsert);
            return state;
        },
        
        /**
         * resetState
         * revert children randomize
         */
        resetState : function(){
        	
        	var thi$ = this;
        	
            //reverse current random order of bank subAnswers
            jQuery(this.view.xmlRandomRevert).children().each(function(index, line){

                var firstElement = thi$.view.children[parseInt(jQuery(line).attr('firstindex'))];
                var secondElement = thi$.view.children[parseInt(jQuery(line).attr('secondindex'))];

                try {
                    if(jQuery.trim(jQuery(line).attr('action')) == 'insertBefore'){
                        firstElement._view.insertBefore(secondElement._view);
                    } else {
                        firstElement._view.insertAfter(secondElement._view);
                    }

                } catch(e){
                }

            });
        }
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/options/Options.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/options/OptionsView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div class='options' id='{{id}}'>\
        <div class='options_content' id={{id}}_content></div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'tile',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.options.OptionsView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(override(config, defaultConfig));
        }
        
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/options/OptionsView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/applet/AppletConfig.js
////////////////////////////////////////
t2k.component.applet.AppletConfigParams = {
		
		paths: {
			main: "/data/index.html",
			icon: "/data/media/icon.png"
		},
		
		apiVersion					: '1.0',
		enabled						: true,
		editMode					: false,
	    playerSelector          	: 'div.player_content',
	    thumbNailWidth              : 124,
	    thumbNailHeight             : 124,
	    thumbNailImgWidth	        : 120,
	    thumbNailImgHeight	        : 120,
	    
        classes: {
			hidden: 'hidden',
       }
	    
} ;

////////////////////////////////////////
// SRC End --> t2k/component/applet/AppletConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/applet/AppletView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div id='{{id}}' class='appletWrapper_content not_selectable'>\
    		<iframe id='{{id}}_frame' name='applet_{{id}}' class='appletFrame {{appletVisabilityClass}}'/>\
	    	<div id='{{id}}_thumbnail' class='{{thumbnailVisabilityClass}} thumbnail'  style='width:{{thumbnailWidth}}px; height:{{thumbnailHeight}}px'>\
    			<img id='{{id}}_thumbnailImg' class='thumbnailImg'  style='width:{{thumbnailImgWidth}}px; height:{{thumbnailImgHeight}}px'></img>\
	    	    <div id='{{id}}_zoomGlass' class='zoomGlass'>!</div>\
	    	</div>\
        </div>";

	var appletConfig = t2k.component.applet.AppletConfigParams;
    
    
    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
        template: TEMPLATE,
        //appletVisabilityClass: appletConfig.classes.hidden,
        thumbnailVisabilityClass: appletConfig.classes.hidden,
        thumbnailWidth: appletConfig.thumbNailWidth,
        thumbnailHeight: appletConfig.thumbNailHeight,
        thumbnailImgWidth: appletConfig.thumbNailImgWidth,
        thumbnailImgHeight: appletConfig.thumbNailImgHeight,
        
    }; // End of defaultConfig.

    t2k.component.applet.AppletView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(override(config, defaultConfig));
            
            var id = this.cfg.id; 
            this._view = this._appletWrapperContent = jQuery('#' + id);
            this._applet = jQuery('#' + id + '_applet');
            this._thumbnail = jQuery('#' + id + '_thumbnail'); 
            this._thumbnailImg = jQuery('#' + id + '_thumbnailImg'); 
            this.initEvents();
                       
        },
	    
	    dispose: function() {
	    	this.setFrameURL( "" );
	    	this.setBlowupState( null );
	    	this.readyToBeCheckedCallback && delete this.readyToBeCheckedCallback ;
	    	this._super() ;
	    },
        
        onViewRendered : function(){
        	
		}, 
        
        updateFrameSize: function( size ) {
        	$( this._frame ).css( size ) ;
        },
        
        setFrameURL: function( url ) {
        	this._frame && this._frame.attr( "src", url ) ;
        },
        
        readyToBeChecked : function(callback){
        	this.readyToBeCheckedCallback = callback;
        },
        
        setThumbnailImg:function(url){
        	this._thumbnailImg.attr('src', url);
        },
        
        getRootElement:function(){
        	
        	return this._applet;
        },
        
        initEvents:function(){
            var thi$ = this;
            
            this._thumbnail.click(function(){
            	thi$.showBlowup();
            });
        },
        
        setBlowupState: function( state ) {
    		this.blowupState = state ;
        },
        
        showBlowup:function () {
        	var thi$ = this ;
            //ENV.Modal.show(copy(this.cfg, {clonedContent: this._applet.clone()}));
        	
        	var modalConfig = $.extend( {
        		state: this.blowupState
        	}, this.cfg ) ;
			
        	ENV.Modal.show( modalConfig );
        },
        
//        onClose: function( state ) {
//        	this.config.onClose && this.config.onClose( state ) ;
//        },
        
        reduce : function(fullscreenOnly) {
        	
        	this._frame.remove() ;
        	

            var path = $(this.cfg.data).attr('path');
        	
        	this.setThumbnailImg( AbsPath( path + appletConfig.paths.icon ) ) ;
        	
            this._thumbnail.removeClass(appletConfig.classes.hidden);
            if(fullscreenOnly){
                this._view.addClass('fullScreen');
            }
            this.dispatchEvent('cantReduce');
            this.dispatchEvent('onRendered');

            /*
            // Make sure onRendered gets called only once.
            var onRenderedFunction = this.cfg.presenter.layout.onRendered;

            this.cfg.presenter.layout.onRendered = function() {
                onRenderedFunction();
                onRenderedFunction = function() {};
            };
            */

            this.readyToBeCheckedCallback && this.readyToBeCheckedCallback() ;
        },
       
        
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/applet/AppletView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/applet/Applet.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.applet.Applet
     * @desc A textViewer Presenter component class
     * @namespace t2k.component.applet
     * @extends t2k.component.BaseComponent
     * @type {Object}
     */
	var appletConfig = t2k.component.applet.AppletConfigParams;
	
    t2k.component.applet.Applet = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.applet.Applet',

	    /**
	     * applet - ctor
	     * @param config
	     */
	    ctor: function(config) {
		    var thi$ = this;

		    config = $.extend( { onClose: function( state ) {

			    thi$.onModalClose( state ) ;

		    } }, config ) ;

		    // Delegate
            this._super(config);
            
            this.hasApplet = true ;
            
            this.initView();

			this.initApplet();
	    },
        
        /**
         * initView
         * init view and register view presenter events
         */
        initView : function(){
            // this.cfg.presenter = this;
        	
            this.view = this.createNewView(t2k.component.applet.AppletView, this.cfg);
        },

	    initApplet:function (){
		    var container = this.cfg.container || this.cfg.parent.parents('.task_container');
		    var viewPortContainer = jQuery(appletConfig.playerSelector);

		    var appletData = $(this.cfg.data).find('data').html();

		    var jsonData = null ;
		    try {
			    jsonData = JSON.parse( appletData ) ;
		    } catch( e ) {
			    jsonData = null ;
		    }

		    appletData = jsonData ? jsonData : appletData ;

		    this.appletParams = {
			    data:appletData,
			    apiVersion:appletConfig.apiVersion,
			    maxSize:{width : container.width(),height : viewPortContainer.height()},
			    locale:ENV.locale.toLowerCase(),
			    enable:appletConfig.enable,
			    volume:mediaManager.getVolume(),
			    editMode:appletConfig.editMode,
			    device:ENV.behaviors.isTablet?'tablet':'pc'
		    };

		    // Applet assets
		    var self = this;
		    this.appletFiles = {};

		    $.each($(this.cfg.data).find('files appletFile'), function(elem) {
			    self.appletFiles[$(this).attr('assetId')] = $(this).attr('path');
		    });

		    this.view.updateFrameSize( this.appletParams.maxSize ) ;

		    var thi$ = this;

		    var id = this.view.cfg.id ;
		    var path = $(this.cfg.data).attr('path');

		    var appletFrame = window.frames[ "applet_" + id ] || window.frames[0] ;

		    thi$.messageMenager = new PostMessageManager( window, appletFrame, appletAPI, thi$ ) ;

		    var relativePath = path + appletConfig.paths.main ;
		    var absolutePath = AbsPath( relativePath ) ;

		    thi$.view.setFrameURL( absolutePath ) ;
	    },
	    
	    dispose: function() {
	    	this.messageMenager.destroy() ;
	    	this._super() ;
	    },
        
        compact : function(){
        	this._super();
        },
        
        loose : function(){
        	this._super();
        },
        
        reduce : function(fullscreenOnly){
	        if(this.cfg.dontEnableBlowup) {
		        this.dispatchEvent('cantReduce');
		        this.dispatchEvent('onRendered');
		        return;
	        }

        	this.hasApplet = false ;
        	this._super(fullscreenOnly);
        },
        
        onModalClose: function( state ) {
    		this.keepModalState( state ) ;
        },
        
        keepModalState: function( state ) {
    		this.modalState = state ;
        	this.view.setBlowupState( state ) ;
        },
        
        setMyState:function (state) {
            
        	this.keepModalState( state ) ;

	        var $state = jQuery(state);
            
            if( this.hasApplet ) {
                console.debug( "applet.js - has applet" ) ;
                
                var $appletState = $state.find( "appletState" ) ;
                
                if( $appletState ) {
                    
                    var appletStateString = $appletState.html() ;
                    
                    var appletState = null ;
                    
                    try {
                        
                        appletState = JSON.parse( appletStateString ) ;
                        
                    } catch( e ) {
                        
                        appletState = appletStateString ;
                        
                    }
                    //save applet state to use inside setStatetoAppletFunction
                    this.appletState = appletState;

	                var thi$ = this;
	                var callback = function () {
		                thi$.setEnabled($state.attr('enabled') === 'true');
		                $appletState = null;
		                $state = null;
	                };

                    //after ready function is fired we can set the state,
                    //otherwise, we need to wait untill it is fired and than set the state
	                if (this.readyToSetState) {
		                this.setStatetoAppletFunction(callback);
	                } else {
		                //save the set state function to later
		                this.setStateFunction = jQuery.proxy(this.setStatetoAppletFunction, this, callback);
	                }
                    
                }

            }
        },

        setStatetoAppletFunction  : function(callback){
            this.callApplet( "setState", this.appletState, callback ) ;
        },

        addMyState:function () {

        	var state = null ;
        	
        	var $stateTag = Perf.create( "state" ) ;
        	
        	if( this.hasApplet ) {
				
	        	// get async state request ( callback + dummy $tag )
	        	var stateUtilData = StateUtil.getStateCallback( this.view.cfg.id ) ;
	        	
	        	// if state is needed
		        if (stateUtilData.callback) {

			        // communicate with applet to get it's state
			        this.callApplet("getState", null, function (state) {

				        // handle Json/String data
				        var isJson = ( typeof state != "string" );
				        var stateString = isJson ? JSON.stringify(state, null, '\t') : state;

				        // applet state wrapper
				        var $final = Perf.create("appletState");

				        // add state to wrapper
				        $final.html(stateString);

				        // update state util with real state from applet
				        stateUtilData.callback($final);

				        $final = null;

			        });

		        }
	        	
	        	// prepare dummy
	        	$stateTag.append( stateUtilData.dummyTag ) ;
	        	
        	} else {
        		
        		if( this.modalState ) {
            		$stateTag =  $(this.modalState).clone();
        		}
        	}
        	
        	// return state with dummy to be replace later upon applet callback
        	return $stateTag ;
        },
        
        setEnabled:function( flag ){
	        console.log('Applet setEnabled:', flag);
	        this.cfg.enabled = flag;

	        this.callApplet("setEnabled", flag);
        },
        
        tryAgain:function(){
            
            this.callApplet( "tryAgain" ) ;
            this.setEnabled(true);
        },
        
        showAnswer:function(){
            
            this.callApplet( "showAnswer" ) ;
            this.setEnabled(false);
        },
        
        check:function( callback ){

	        var thi$ = this;
            var continueCallback = function(result){
                callback(result);
	            thi$.setEnabled(false);
            };

        	this.callApplet( "check", null, continueCallback ) ;
        },
        
        readyToBeChecked:function(callback){
        	this.view.readyToBeChecked(callback);
        },

	    checkWidthVsContainer: function(size) {
	    	if( size ) {
	    		this.view.updateFrameSize(size);
	    	}

		    if ( (!this.cfg.isBlowup) && (!size || size.width > this.appletParams.maxSize.width)) {  //applet size doesn't fit, need to be reduced
			    this.reduce();
		    }
	    },
	    
	    callApplet: function( method, config, callback, options ) {
	    	
	    	if( this.hasApplet ) {
	    		
	    		this.messageMenager.send( method, config, callback, options ) ;
	    		
	    	} else {
	    		
	    		console.log( "[DL][APPLET] --> in reduction, no applet instance, calling callback( null )" ) ;
	    		
	    		callback && callback( null ) ;
	    		
	    	}
	    	
	    }
        
    });
    
    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // Applet API - start
    //////////////////////////////////////////////////////////////////////////
    var appletAPI = {
    	
        ready: function( config ) {
        	var options = {} ;
        	if( this.cfg.isBlowup ) {
        		options.timeout = 10 * 1000 ;
        	}
        	else {
        		options.timeout = 60 * 1000 ;
        	}
            
            if( config ) {
                this.fullscreenOnly = config.fullscreenOnly;
            }

            if(this.fullscreenOnly && !this.cfg.isBlowup){
                
                this.reduce(this.fullscreenOnly);
                this.layout.onRendered(this.fullscreenOnly);

            }else{
                
               this.callApplet( "init", this.appletParams, appletAPI.rendered.bind(this), options ) ;
            }
        },
        
        rendered: function( size ) {
	        //check if size is bigger then this.appletParams.maxSize
			this.checkWidthVsContainer(size);

        	this.layout.onRendered(this.fullscreenOnly);

            //after ready we can set the applet state (if exists)
            this.readyToSetState = true;
            if(this.setStateFunction){
                this.setStateFunction();
            }
        },

        getAssetUrl: function( config, callback ) {
            if (typeof callback == 'function')
                callback( AbsPath( this.appletFiles[config.assetId] ) );
        }
        
    } ;
    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // Applet API - end
    //////////////////////////////////////////////////////////////////////////

})();
////////////////////////////////////////
// SRC End --> t2k/component/applet/Applet.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/help/HelpView.js
////////////////////////////////////////
(function() {

	var TEMPLATE =
		"<div class='question' id='{{id}}'>\
			<div id={{id}}_content></div>\
		</div>";

	/**
	 * Private: defaultConfig
	 * Hold sensible defaults for the help's view to use.
	 */
	var defaultConfig = {
		layout: 'inline',
		/** The mustache template to render. */
		template: TEMPLATE
	}; // End of defaultConfig.

	t2k.component.help.HelpView = t2k.component.CompositeView.subClass({

		/**
		 * @constructor
		 * @see superclass documentation
		 */
		ctor: function(config) {
			// Delegate.
			this._super(copy(config, defaultConfig));
		},

		onViewRendered : function(){

		}

	});

})();


////////////////////////////////////////
// SRC End --> t2k/component/help/HelpView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/help/Help.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.help.Help
     * @desc A Help Presenter component class
     * @namespace t2k.component.help
     * @extends t2k.component.Composite
     * @type {Object}
     */

    t2k.component.help.Help = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.help.Help',
        
        /**
         * help - ctor
         * @param config
         */
        ctor: function(config) {
        	
            // Delegate            	
            this._super(config);

            this.initView();

	        this.startComposite2({parent: this.view.cfg.id + '_content'});
            
        },
        
        /**
         * initView
         * init view and register view presenter events
         */
        initView : function(){
            this.view = this.createNewView(t2k.component.help.HelpView, this.cfg);
        },

	    /**
	     * setState
	     * Set the question and its children to the specified state xml
	     * @param state - {jQuery} State xml
	     */
	    setState:function (state) {
		    this._super(state);
	    },

	    /**
	     * getState
	     * Get the question state xml
	     * @return state - {jQuery} State xml
	     */
	    getState:function () {
		    return this._super();
	    }
        
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/help/Help.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/help/HelpItemView.js
////////////////////////////////////////
(function () {

	var TEMPLATE =
		"<div class='question' id='{{id}}' style='visibility: hidden;' >\
			<div id={{id}}_content></div>\
		</div>";

	/**
	 * Private: defaultConfig
	 * Hold sensible defaults for the help item view to use.
	 */
	var defaultConfig = {
		layout:'inline',
		/** The mustache template to render. */
		template:TEMPLATE
	}; // End of defaultConfig.

	t2k.component.help.HelpItemView = t2k.component.CompositeView.subClass({

			/**
			 * @constructor
			 * @see superclass documentation
			 */
			ctor:function (config) {
				// Delegate.
				this._super(copy(config, defaultConfig));
			},

			show: function(flag) {
				this.cfg.container.find('.question').css('visibility', flag ? 'visible' : 'hidden');
			}


		}
	);

})();


////////////////////////////////////////
// SRC End --> t2k/component/help/HelpItemView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/help/HelpItem.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.help.HelpItem
     * @desc A Help Presenter component class
     * @namespace t2k.component.help
     * @extends t2k.component.Composite
     * @type {Object}
     */
	
    t2k.component.help.HelpItem = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.help.HelpItem',
        
        /**
         * help - ctor
         * @param config
         */
        ctor: function(config) {

	        var thi$ = this;

	        var cfgOnRendered = config.onRendered;

	        config.onRendered = function () {
		        thi$.helpRendered = true;
		        if (thi$.helpRendered) {
			        thi$.onHelpItemRendered(thi$, cfgOnRendered);
		        }
	        }

            // Delegate            	
            this._super(config);

            this.initView();

	        this.startComposite2({	parent: this.view.cfg.id + '_content', 
	        						dontEnableBlowup: true,
	        						isInsideModal: true});

	        this.enableLayouting = true;

        },

	    onHelpItemRendered : function(helpItem, cfgOnRendered) {
		    var thi$ = this;
		    helpItem.layoutState = thi$.setLayoutState(helpItem.layoutState);

		    console.log("onHelpItemRendered - start");
		    console.time("layouter");

		    var renderedWrapper = function () {
			    console.log("onHelpItemRendered - done");
			    console.timeEnd("layouter");

			    globalEvents.run();
			    cfgOnRendered();

			    thi$.view.show(true);
		    };

		    helpItem.enableLayouting = true;

		    var containerHeight = helpItem.cfg.container.height() - (helpItem.cfg.parent.offset().top * 2);

		    DynamicLayoutUtils.dynamicHelpItemLayout(helpItem, containerHeight, helpItem.layoutState, renderedWrapper, helpItem);
	    },

	    setLayoutState: function(state) {

		    var result;

		    switch (state) {

			    case 'compact':
				    result = 'reduce';
				    break;

			    case 'loose':
				    result = 'compact';
				    break;

			    case 'reduce':
				    result = 'loose';
				    break;

			    default: // on first time
				    result = 'loose';
				    break;

		    }

		    return result;
	    },

	    compact : function() {
		  //don't compact me
		    this.compositeRenderComplete();
	    },
        
        /**
         * initView
         * init view and register view presenter events
         */
        initView : function(){
            this.view = this.createNewView(t2k.component.help.HelpItemView, this.cfg);
        },

	    /**
	     * setState
	     * Set the question and its children to the specified state xml
	     * @param state - {jQuery} State xml
	     */
	    setState:function (state) {
		    this._super(state);
	    },

	    /**
	     * getState
	     * Get the question state xml
	     * @return state - {jQuery} State xml
	     */
	    getState:function () {
		    this.state = this._super();
		    return this.state;
	    }
        
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/help/HelpItem.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/TableViewConfig.js
////////////////////////////////////////

// table Viewer constant values
t2k.component.table.TableViewConstants = {

	bordersToClasses : {
		fullGrid : 'boxBorder horizontalGrid verticalGrid',
        verticalGrid : 'boxBorder verticalGrid',
        horizontalGrid : 'boxBorder horizontalGrid'
	},

    MinNumberRowsForViewZebraHorizontal : 4,

    MinNumberCellsForViewZebraVertical  : 4,

    ZebraClasses : {
        'true' : 'dark',
        'false': 'light'
    },

    minimumReadableFontSize	: 16,

    playerSelector          : 'div.player_content',

    reduction : {
        reductionScaleSteps : 10,
        absMinTableWidth : 200
    },

    fadeSpeed : 200,

    zoomTableCssProperty : {
        'marginTop':10,
        'marginRight':30,
        'marginBottom':10,
        'marginLeft':10,
        'paddingTop':16,
        'paddingRight':16,
        'paddingBottom':16,
        'paddingLeft':16,

        'heightX' : 10,
        'notActiveClass' : 'tableMascReductionError',
        'notActiveText' : 'The system can not process the data <br>Please change the data entered. <br>Possible reasons for this: <br> 1. very large volume of data <br> 2. too much is not decreasing components such as graphics, media players, etc.'
    }

};
////////////////////////////////////////
// SRC End --> t2k/component/table/TableViewConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/Table.js
////////////////////////////////////////
(function() {

    // copy all tableViewe constants from TableViewConstants to be readable
    var constants = t2k.component.table.TableViewConstants;

    t2k.component.table.Table = t2k.component.Composite.subClass({

        /** The class' name (for debugging and state tag name purpose). */
        name: 't2k.component.table.TableComponent',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: {
            init: [
	            {checkWidthVsContainer: null}
            ],
            reduce: [
                {checkWidthVsContainer: null}
            ],
            loose: [
                {checkWidthVsContainer: null}
            ],
            compact: [
                {checkWidthVsContainer: null}
            ]
        },

        /**
         *  ctor
         * @param config
         */
        ctor: function(config) {
            // Delegate
            this._super(config);

            this.initMembers(config);

            this.view = this.createNewView(t2k.component.table.TableView, override(this.cfg, {
                container       : this.container,
                mainContainer   : this.mainContainer
            }));

            this.initLayout();

            if(this.cfg.isInsideModal){
               
                this.view._view.parents('.modal_content').css('min-width', '90%');
                this.view._view.parents('.modal_content').parent().css('min-width', '90%');
            }

            this.startComposite2({parent: this.view.cfg.id + '_content'});

	        this.compositeCellsChildren();

            this.initZebra();
            
            if(this.cfg.isInsideModal){
                this.view._view.parents('.modal_content').parent().css('min-width', '0');
                this.view._view.parents('.modal_content').parent().css('width', 'auto');
                this.view._view.parents('.modal_content').css('min-width', '0');
                this.view._view.parents('.modal_content').css('width', 'auto');
            }
	        this.view._content.css('width', 'auto');
        },

        /**
         * initLayout
         * init layout vars
         */
        initLayout : function(){
            this.layout.reductionStep = 0;
        },

        /**
         * initMembers
         */
        initMembers : function(config){
            // table text, means that all components inside the table are textViewer
            this.isTableText = jQuery(config.data).attr('tableText') == 'true';
            // mainContainer determines table place
            // and accordingly it : how to perform a reduced ( "question/answer/nothing" ( nothing = '' ) )
            this.mainContainer = jQuery(config.data).attr('mainContainer');

            // init container, if container recieved from configuration, use it (shared, sequence buffer etc..)
            // else, search task container
            this.container = config.container || Perf.select('#' + config.parent).parents('.task_container');

            this.scale = 1;
            this.scaleAvailable = true;
        },

        /**
         * initZebra
         */
        initZebra : function(){
            // on table text [true], start zebra
            if (this.isTableText){
                this.zebraType = this.getZebraType();
                if (this.zebraType) this.setZebra();
            }
        },

	    compositeCellsChildren: function() {
		    this.children.forEach(function(row){ //rows
			    row.children.forEach(function(cell){ //cells
				    cell.compositeConfig && cell.startComposite2(cell.compositeConfig);
			    })
		    });
	    },

	    looseWidthCellsChildren: function() {
		    this.children.forEach(function(row){ //rows
			    row.children.forEach(function(cell){ //cells
				    cell.view.looseWidth();
			    })
		    });
	    },

        /**
         * compact
         * on table compact, just set whole table view (inline-block), and return
         * dont compact table's children
         */
        compact : function() {
            this.view.compact();
            this.layout.onRendered();
        },

        /**
         * loose
         * on table loose, just set whole table view (block), and return
         * dont loose table's children
         */
        loose : function() {
            this.view.loose();
            this.layout.onRendered();
        },

        /**
         * checkWidthVsContainer
         * table mathod
         * calls on table rendered
         */
        checkWidthVsContainer : function(){
	        this.looseWidthCellsChildren();

            var containerWidth = this.container.width(),
                tableWidth = this.view._content.width() * this.scale;

            if ((containerWidth < tableWidth) && this.reductionAvailable()){
                this.reduce(1, true);
            } else {
                this.compositeRenderComplete();
            }
        },

        /**
         * reductionAvailable
         * override
         * table reduction, first reduce internal components,
         * and after that scale
         * @return {Boolean}
         */
        reductionAvailable : function() {
            // if table can normally reduce - return true
            if (this.layout.canReduce){
                return true;
            } else{
                // check for max. scale reduction
                if (this.layout.reductionStep < constants.reduction.reductionScaleSteps && this.scaleAvailable) {
                    return true;
                } else{
                    return false;

                }
            }
        },

        /**
         * reduce
         * override
         * first 'normally' recuce table components,
         * on can't reduce, scale
         * @param val
         */
        reduce : function(val, scale){

            var containerWidth = this.container.width(),
                tmpScale = scale;

            if (this.layout.canReduce){
                // 'normally reduction'
                this._super(val);

            } else {

                // If a table is inside the questionContainer
                // cancels 'use scale only with method (checkWidthVsContainer)'
                if(this.mainContainer == 'question'){
                    tmpScale = true;
                }

                // use scale only with method (checkWidthVsContainer)
                if(tmpScale && (constants.reduction.absMinTableWidth < this.view._content.width())){
                    // calc reduction step size
                    this.layout.reductionStepSize = this.calcReductionStepSize();
                    if (this.layout.reductionStep >= constants.reduction.reductionScaleSteps) {
                        this.compositeRenderComplete();
                        return;
                    }

                    this.layout.reductionStep++;

                    // calc reduced scale
                    this.scale = (1 - (this.layout.reductionStep * (this.layout.reductionStepSize))).toFixed(2);

                    // set table view scale
                    this.view.setScale(this.scale);

                    // on scale, set blowup
                    this.view.setBlowup(this.scale);

                    // reset the counter methods for
                    // to call this method until it is satisfied :
                    // table.width < container.width or table.width = absolute minimum
                    this.layout.layoutSequenceCounter=0;
                    this.compositeRenderComplete();

                }else{
                    this.scaleAvailable = false;
                    this.compositeRenderComplete();
                }
            }
        },

        /**
         * calcReductionStepSize
         */
        calcReductionStepSize : function(){
            return ( ((100- (constants.reduction.absMinTableWidth/ (this.view._content.width()/100)))/100)/constants.reduction.reductionScaleSteps).toFixed(2);
        },


        /**
         * getZebraType
         * @return String - 'zebra-horizontal' || 'zebra-vertical' || null
         */
        getZebraType : function(){

            var rowCount = 0,
                cellCount = 0,
                zebraType = null;

            // loop table row
            jQuery(this.children).each(function (index, row){
                if (row.internalType == 'body') {
                    rowCount++;
                    if (cellCount == 0) {
                        cellCount =  row.bodyCellSum();
                    }
                }
            });

            // check the condition if need zebraType
            if ( (cellCount >= constants.MinNumberCellsForViewZebraVertical) 
                    || (rowCount >= constants.MinNumberRowsForViewZebraHorizontal) ) {
                // check zebraType
                if ( (cellCount > rowCount) || 
                        (cellCount == rowCount && this.view._content.outerWidth() > this.view._content.outerHeight()) ) {
                   zebraType = 'ZebraVertical';
                } else {
                    zebraType = 'ZebraHorizontal';
                }
            }

            return zebraType;
        },

        /**
         * setZebra
         * pass row class by Zebra type and
         */
         setZebra :function(){

             var thi$ = this, dark = false;

             jQuery(this.children).each(function(index, row){
                 if (row.type == 'body'){
                     row['set' + thi$.zebraType](dark);
                     dark = !dark;
                 }
             });

        }
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/table/Table.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/TableView.js
////////////////////////////////////////
(function () {

    var TEMPLATE =
        "<div class='table {{bordersClasses}} {{tableDirection}}' id='{{id}}'>\
        	<div id='{{id}}_content' class='table_content' />\
        </div>";

    var BLOWUP_MASC_TEMPLATE =
        "<div class='blowup_masc' id='{{id}}_masc'>\
        	<div class='zoomButton' />\
        </div>";

    var BLOWUP_TEMPLATE =
        "<div class='table {{bordersClasses}} {{tableDirection}} zoomTable' id='{{id}}_zoomTable'>\
        	<div class='x' id='{{id}}_x' />\
        </div>";

    var MODAL_TEMPLATE =
        "<div class='table {{bordersClasses}} {{tableDirection}} modalTable' id='{{id}}_zoomTable'>\
        </div>";


    // copy all tableViewe constants from TableViewConstants to be readable
    var constants = t2k.component.table.TableViewConstants;

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
        layout:'inline',
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

    /**
     *TableView
     */
    t2k.component.table.TableView = t2k.component.CompositeView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.table.TableView',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {

            //  init members
            this.initMembers(config);
            this._super(copy(config, defaultConfig));
        },

        /**
         * initMembers
         * @param config
         */
        initMembers:function (config) {
            this.container = config.container;
            this.mainContainer = config.mainContainer;
            this.borders = jQuery(config.data).attr('borders');
            config.bordersClasses = constants.bordersToClasses[this.borders];
            config.tableDirection = jQuery(config.data).attr('direction');
            this.blowupCreated = false;

            this.playerElement = jQuery(constants.playerSelector);
            var playerWidth = this.playerElement.width() - (constants.zoomTableCssProperty.marginRight + constants.zoomTableCssProperty.marginLeft + constants.zoomTableCssProperty.paddingLeft + constants.zoomTableCssProperty.paddingRight);
            var playerHeight = this.playerElement.height() - (constants.zoomTableCssProperty.marginTop + constants.zoomTableCssProperty.marginBottom + constants.zoomTableCssProperty.paddingTop + constants.zoomTableCssProperty.paddingBottom);

            this.playerSize = {
                'width':playerWidth,
                'height':playerHeight
            };
        },

        /**
         * setScale
         * @param scale
         */
        setScale:function (scale) {

            var tableHeight = parseInt(this._content.height() * scale, 10),
                tableWidth = parseInt(this._content.width() * scale, 10),
                tableHeightTop = parseInt((tableHeight - this._content.height() ) / 2, 10),
                tableHeightLeft = parseInt((tableWidth - this._content.width() ) / 2, 10);

            this._view.css({
                'position':'relative',
                'min-height':'22px', //icon height
                'width':tableWidth,
                'height':tableHeight});

            this._content.css({
                'position':'absolute',
                'top':tableHeightTop,
                'left':tableHeightLeft,
                '-webkit-transform':'scale(' + scale + ')',
                '-ms-transform':'scale(' + scale + ')'
            });
        },

        /**
         * setBlowup
         */
        setBlowup:function (scale) {
            // reference
            var thi$ = this;

            if (!this.blowupCreated) {
                this.blowupCreated = true;
                this._view.addClass('blowup');

                // append blowup template
                this.masc = jQuery(Mustache.to_html(BLOWUP_MASC_TEMPLATE, {'id':this.cfg.id}));
                // mainContainer
                // determines table place
                // and accordingly it : how to perform a BLOWUP_MASC_TEMPLATE ( "question/answer/nothing" ( nothing = '' ) )
                if (this.mainContainer != 'answer') {
                    this.masc.click(function () {
                        thi$.showBlowup();
                    });
                } else {
                    this.masc.addClass(constants.zoomTableCssProperty.notActiveClass).find('div.zoomButton').remove();
                    this.masc.append('<p class="tableReductionError">' + constants.zoomTableCssProperty.notActiveText + '</p>');
                }

                this._view.append(this.masc);
            }
        },


        /**
         * set to Clone ratio height/width as in the this._content
         * @param content
         * @param cloned
         */
        alignContentVsCloned:function (content, cloned) {

            // get row index
            var $rowContent = null, $rowCloned = null, $row;
            content.children().each(function (index, row) {
                $row = jQuery(row);
                if ($row.hasClass('body')) {
                    $rowContent = $row;
                    $rowCloned = jQuery(cloned.children()[index]);
                    return false;
                }
            });

            if (!!$rowContent) {
                $rowCloned.children().each(function (index, cell) {
                    jQuery(cell).width(jQuery($rowContent.children()[index]).outerWidth());
                });
            }
        },


        /**
         * showBlowup
         */
            //old blowup implementation
        showBlowup_delete_me:function () {

            // ref
            var thi$ = this;

            // if open some sort of Blowup then close it
            if (this.blowup) {
                this.blowup.remove();
            }

            // create clone
            var clonedContent = this._content.clone(true, true, true);
            this.alignContentVsCloned(this._content, clonedContent);

            // create blowup wrapper
            this.blowup = jQuery(Mustache.to_html(BLOWUP_TEMPLATE, {
                'id':this.cfg.id,
                'bordersClasses':this.cfg.bordersClasses,
                'tableDirection':this.cfg.tableDirection
            }));
            // append blowup wrapper to DOM
            this.container.append(this.blowup);
            // append cloned to blowup
            this.blowup.append(clonedContent);
            // bind closeBlowup to X
            this.blowup.find('div.x').click(function () {
                thi$.closeBlowup();
            });

            // remove blowup property
            var removeBlowup = function () {
                thi$.blowup.remove();
                Perf.select('body').unbind('keyup', bodyKeyEventHandler);
                Perf.select('body').unbind('mousedown', bodyClickEventHandler);
            };

            // remove blowup on ESC pressed
            var bodyKeyEventHandler = function (e) {
                if (e.keyCode == 27) {
                    removeBlowup();
                }
            };

            // remove blowup on body click
            var bodyClickEventHandler = function (e) {
                removeBlowup();
            };

            // set body events (keyup and mousedown)
            Perf.select('body').bind('keyup', bodyKeyEventHandler).bind('mousedown', bodyClickEventHandler);


            // fade to 0.01 to get DOM properties
            this.blowup.fadeTo(0, 0.01, function () {

                var blowupData = thi$.getBlowupData(clonedContent);

                // set blowup width & height
                thi$.blowup.width(blowupData.blowupSize.width).height(blowupData.blowupSize.height);
                //fixed table_content width
                thi$.blowup.find('.table_content').width(blowupData.clonedSize.width);
                // align blowup
                thi$.alignBlowup(blowupData.blowupSize);

                // set scale
                clonedContent.css({
                    '-webkit-transform':'scale(' + blowupData.scale + ')',
                    '-ms-transform':'scale(' + blowupData.scale + ')'
                });

                // align Cloned Into Blowup
                thi$.alignClonedIntoBlowup(clonedContent);

                // show
                thi$.blowup.fadeTo(constants.fadeSpeed, 1);

            });

        },

        showBlowup:function () {

            var clonedContent = this._content.clone(true, true, true);
            // create blowup wrapper
            this.cfg.clonedContent = jQuery(Mustache.to_html(MODAL_TEMPLATE, {
                'id':this.cfg.id,
                'bordersClasses':this.cfg.bordersClasses,
                'tableDirection':this.cfg.tableDirection
            }));
            this.cfg.clonedContent.append(clonedContent);

            var blowupData = this.getBlowupData(clonedContent);

            // set blowup width & height
            this.cfg.clonedContent.width(blowupData.blowupSize.width).height(blowupData.blowupSize.height);
            //fixed table_content width
            this.cfg.clonedContent.find('.table_content').width(blowupData.clonedSize.width);
            // align blowup

            // set scale
            clonedContent.css({
                '-webkit-transform':'scale(' + blowupData.scale + ')',
                '-ms-transform':'scale(' + blowupData.scale + ')'
            });

            // TODO: remove unneeded css props
            this.cfg.clonedContent.css({
                width: '',
                height: ''
            });
            clonedContent.css({
                top: '',
                left: '',
                position: ''
            });

            ENV.Modal.show(this.cfg);
        },

        /**
         * set offsetTop and offsetLeft by current position of Blowup
         * @param cloned
         */
        alignClonedIntoBlowup:function (cloned) {

            var blowupData = this.getElementData(this.blowup),
                tmpTop = blowupData.offsetTop + constants.zoomTableCssProperty.heightX + constants.zoomTableCssProperty.paddingTop,
                tmpLeft = blowupData.offsetLeft + constants.zoomTableCssProperty.paddingLeft;

            cloned.offset({'top':tmpTop, 'left':tmpLeft});
        },

        /**
         * correct Blowup position by view port and current element
         * @param blowupSize
         */
        alignBlowup:function (blowupSize) {

            // center blowup
            var tableData = this.getElementData(this._view);

            var correctBlowupOffset = {
                'left':tableData.offsetLeft - ((blowupSize.width - tableData.width) / 2),
                'top':tableData.offsetTop - ((blowupSize.height - tableData.height) / 2)
            };

            // set blowup offset for center align with original table
            this.blowup.offset(correctBlowupOffset);

            var blowupData = this.getElementData(this.blowup);
            var vpData = this.getElementData(this.playerElement);

            this.alignBlowupVsViewPort(blowupData, vpData);

        },

        /**
         * correct Blowup position by view port
         * @param zoomData
         * @param vpData
         */
        alignBlowupVsViewPort:function (zoomData, vpData) {

            //top
            if (zoomData.offsetBottom > vpData.offsetBottom) {
                var tmpTop = (zoomData.offsetTop - (zoomData.offsetBottom - vpData.offsetBottom) - constants.zoomTableCssProperty.marginBottom);
                tmpTop < vpData.offsetTop ? tmpTop = (vpData.offsetTop + constants.zoomTableCssProperty.marginTop) : tmpTop;
                zoomData.$.offset({'top':tmpTop});
            }
            if (zoomData.offsetTop < vpData.offsetTop) {
                zoomData.$.offset({'top':vpData.offsetTop + constants.zoomTableCssProperty.marginTop});
            }

            //left
            if (zoomData.offsetLeft <= vpData.offsetLeft) {
                zoomData.$.offset({'left':constants.zoomTableCssProperty.marginLeft});
            }
            if (zoomData.offsetRight > vpData.offsetRight) {
                zoomData.$.offset({'left':constants.zoomTableCssProperty.marginLeft});
            }
        },

        /**
         * get Element Data
         * return : {width , height , offsetLeft , offsetTop , offsetRight , offsetBottom , offsetTopCenter , offsetLeftCenter}
         * @param element
         */
        getElementData:function (element) {
            var $element = jQuery(element);
            var data = {
                '$':$element,
                'width':$element.width(),
                'height':$element.height(),
                'offsetLeft':$element.offset().left,
                'offsetTop':$element.offset().top
            };

            data.offsetRight = data.offsetLeft + data.width;
            data.offsetBottom = data.offsetTop + data.height;
            data.offsetTopCenter = parseInt(((data.offsetBottom - data.offsetTop) / 2), 10);
            data.offsetLeftCenter = parseInt(((data.offsetRight - data.offsetLeft) / 2), 10);

            return data;
        },


        /**
         * closeBlowup
         */
        closeBlowup:function () {
            this.blowup.remove();
        },


        /**
         * calculation Blowup by Cloned Element
         * return : { blowupSize{'width','height'}, clonedSize{'width','height'}, scale(int) }
         * @param clonedContent
         */
        getBlowupData:function (clonedContent) {

            var clonedSize = {
                'width':clonedContent.width(),
                'height':clonedContent.height()
            };

            var widthScale = (this.playerSize.width / clonedSize.width);
            widthScale = (widthScale > 1) ? 1 : widthScale;

            var heightScale = (this.playerSize.height / clonedSize.height);
            heightScale = (heightScale > 1) ? 1 : heightScale;

            var scale = (widthScale < heightScale) ? widthScale.toFixed(2) : heightScale.toFixed(2);

            var blowupSize = {
                'width':((clonedSize.width * scale) + (constants.zoomTableCssProperty.paddingLeft + constants.zoomTableCssProperty.paddingRight)),
                'height':((clonedSize.height * scale) + constants.zoomTableCssProperty.heightX + (constants.zoomTableCssProperty.paddingTop + constants.zoomTableCssProperty.paddingBottom))
            };

            return {
                'blowupSize':blowupSize,
                'clonedSize':clonedSize,
                'scale':scale};
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/table/TableView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/Row.js
////////////////////////////////////////
(function () {

    // copy all tableViewe constants from TableViewConstants to be readable
    var constants = t2k.component.table.TableViewConstants;

    t2k.component.table.Row = t2k.component.Composite.subClass ( {

        /** The class' name (for debugging purpose). */
        name:'t2k.component.table.Row',

        ctor:function ( config ) {
            // Delegate
            this._super ( config );
            this.initMembers ( config );

	        this.view = this.createNewView(t2k.component.table.RowView, config);
	        this.startComposite2({  parent:this.view.cfg.id,
		                            minimumReadableFontSize:constants.minimumReadableFontSize,
		                            numOfColumns:this.cfg.data.children.length
	                             });

	        this.setInternalType();
        },

        /**
         * initMembers
         * @param config
         */
        initMembers:function(config) {

            // this.type recieved from xml.
            // if there is no type on the xml, set (row) type = body
            // options: body, copyrights, title
            this.type = config.type = !!jQuery (config.data).attr('type') ? jQuery(config.data).attr('type') : 'body';
        },

        /**
         * setInternalType
         * set internal type of row for calculation Zebra Type in table.getZebraType()
         */
        setInternalType:function () {

            // if type is copyrights or title, set it type and return
            if (this.type != 'body'){
                this.internalType = this.type;
                return;
            }

            // if type is body, internal type will be determine by it's cell
            // options: body, difinition, summary
            var thi$ = this,
                counter = {
                    definition      : 0,
                    summary         : 0,
                    intersection    : 0,
                    body            : 0
                };

            // count cell types
            jQuery(this.children).each(function(index, cell) {
                counter[cell.type]++;

                // if one cell type counter is 2, set this type for the whole row
                if (counter[cell.type] > 1) {
                    thi$.internalType = cell.type;
                    return;
                }
            });
        },

        /**
         *  bodyCellSum
         *  count body cell
         *  [ for calculation Zebra Type in table.getZebraType() ]
         *  @return bodyCellSum {int}
         */
        bodyCellSum : function() {

            var bodyCellSum = 0;

            jQuery(this.children).each(function(index, cell) {
                if (cell.type == 'body') bodyCellSum++;
            });

            return bodyCellSum;
        },

        /**
         * setZebraHorizontal
         * passed current zebra class to cell.setZebra()
         * is called from table.setZebra()
         * @param dark
         */
        setZebraHorizontal : function(dark) {
            jQuery(this.children).each(function(index, cell) {
                cell.setZebra(dark);
            });
        },

        /**
         * setZebraVertical
         * passed current zebra class to cell.setZebra()
         * is called from table.setZebra()
         */
        setZebraVertical : function() {

            var dark = false;

            jQuery(this.children).each(function(index, cell) {
                cell.setZebra(dark);
                dark = !dark;
            });
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/table/Row.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/RowView.js
////////////////////////////////////////
(function() {

	var TEMPLATE =
        "<div class='row {{type}}' id='{{id}}'>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
        layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

	/**
	 *TableView
	 */
	t2k.component.table.RowView = t2k.component.CompositeView.subClass({

				/** The class' name (for debugging purpose). */
				name : 't2k.component.table.RowView',

				/**
				 * @constructor
				 * @see superclass documentation
				 */
				ctor : function(config){
                    this._super(copy(config, defaultConfig));
				}

			});

	})();
////////////////////////////////////////
// SRC End --> t2k/component/table/RowView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/Cell.js
////////////////////////////////////////
(function() {

    // copy all tableViewe constants from TableViewConstants to be readable
    var constants = t2k.component.table.TableViewConstants;

    t2k.component.table.Cell = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.table.Cell',

        /**
         * ctor
         * @param config
         */
        ctor: function(config) {
            // Delegate
            this._super(config);
            this.initMembers(config);

            this.view = this.createNewView(t2k.component.table.CellView, config);
	        this.compositeConfig = {
		        parent: this.view.cfg.id,
		        container: this.view._view,
		        minimumReadableFontSize: constants.minimumReadableFontSize,
		        maxReduction_minReadable : true,
		        setMaxWidth : this.cfg.container.outerWidth()
	        };
        },

        /**
         * initMembers
         * @param config
         */
        initMembers:function(config){
            var type = jQuery(config.data).attr('type');
            this.type = config.type = !!type ? type : 'body';
        },

        /**
         * setZebra
         * set zebra class to current cell
         * is called from Row.setZebraVertical() or Row.setZebraHorizontal()
         * @param dark
         */
        setZebra : function(dark) {
            this.view.addClass(constants.ZebraClasses[dark.toString()]);
         }
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/table/Cell.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/table/CellView.js
////////////////////////////////////////
(function() {

	var TEMPLATE =
        "<div class='cell {{type}} {{zebraClass}}' id='{{id}}' style='width: {{cellWidth}}' >\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
        layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

	/**
	 *TableView
	 */
	t2k.component.table.CellView = t2k.component.CompositeView.subClass({

        /** The class' name (for debugging purpose). */
        name : 't2k.component.table.CellView',

        /**
         * @constructor
         * @see superclass documentation
         */

        ctor:function (config) {
	        config.cellWidth = config.numOfColumns ? (100 / config.numOfColumns) + '%' : '100%';

	        this._super(copy(config, defaultConfig));
        },

        /**
         * append current Zebra class to DOM (div.cell)
         * @param ClassName
         */
        addClass:function(ClassName){
            this._view.addClass(ClassName);
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/table/CellView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/LayoutGroup.js
////////////////////////////////////////
(function() {
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//  add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.LayoutGroup
     */
    t2k.component.LayoutGroup = t2k.component.Composite.subClass({

    	/** The class' name (for debugging purpose). */
        name: 't2k.component.LayoutGroup',

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            this._super(config);
            this.view = this.createNewView(t2k.component.LayoutGroupView, this.cfg);
            delete this.cfg.template;
            this.startComposite2(merge({parent: this.view.cfg.id + '_content'}, config));
        }, // End of ctor
        
        compact: function(){
        	this._super();
        	this.squeezeComposite();
        },
        
        loose: function(){
        	this._super();
        	this.looseComposite();
        }
        
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
})();

////////////////////////////////////////
// SRC End --> t2k/component/LayoutGroup.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/LayoutGroupView.js
////////////////////////////////////////
(function() {
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    var TEMPLATE =
        "<div id='{{id}}' class='layoutGroup'>\
            <div id={{id}}_content></div>\
        </div>";

    var defaultConfig = {
    	 layout: 'vertical',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.AnswerView
     * The view for the answer part of tasks.
     */
    t2k.component.LayoutGroupView = t2k.component.CompositeView.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        } // End of ctor

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/LayoutGroupView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/QuestionGroup.js
////////////////////////////////////////
(function() {
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//  add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.QuestionGroup
     */
    t2k.component.QuestionGroup = t2k.component.Composite.subClass({

    	/** The class' name (for debugging purpose). */
        name: 't2k.component.QuestionGroup',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: {
            compact: [
                {spaceEater: 'textOnly'}
            ]
        },

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            this._super(config);
            this.view = this.createNewView(t2k.component.QuestionGroupView, this.cfg);
            delete this.cfg.template;
            this.startComposite2(merge({parent: this.view.cfg.id + '_content'}, config));
        } // End of ctor

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
})();

////////////////////////////////////////
// SRC End --> t2k/component/QuestionGroup.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/QuestionGroupView.js
////////////////////////////////////////
(function() {
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    var TEMPLATE =
        "<div id='{{id}}' class='questionGroup'>\
            <div id={{id}}_content></div>\
        </div>";

    var defaultConfig = {
    	 layout: 'vertical',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.QuestionGroup
     * The view for the answer part of tasks.
     */
    t2k.component.QuestionGroupView = t2k.component.CompositeView.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }, // End of ctor
        
        compact : function(){
        	var width = this._view.width();
        	this._view.width(width);
        	// don't compact my view
        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/QuestionGroupView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/ButtonView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div id='{{id}}' class='{{style}} disabled {{currState}} not_selectable'>\
            <div id='{{id}}_content' class='{{style}}_content'>\
                <div id='{{id}}_icon' class='{{style}}_icon'></div>\
                <div id='{{id}}_title' class='{{style}}_text'></div>\
            </div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.buttons.ButtonView = t2k.core.View.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.ButtonView',

        /**
         * 2d0 - complete doc
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            this.setMode(this.cfg.currMode);
            this.setReduced( !!this.cfg.isReduced ) ;

            // Closure ref.
            var thi$ = this;

            // handle click + prevent fast second click (300ms delay)
            function clickHandler() {
                if (thi$.isEnabled()) {
                    mediaManager.pauseAll();
                    thi$.dispatchEvent(thi$.cfg.currMode);
                }
                setTimeout( function() {
                	thi$._view && thi$._view.one( 'click', clickHandler ) ;
                }, ENV.behaviors.isTablet ? 600 : 300 ) ;
            };

	        if (ENV.behaviors.bindButtonTouchStartAndEnd) {
		        TabletUtil.bindButtonTouchStartAndEnd(this._view);
		        this._view.one('touchstart', clickHandler);
	        } else {
		        this._view.one('click', clickHandler);
	        }
        },

        setMode: function(name) {
            this._view.click(null);
            Perf.select('#' + this.cfg.id).removeClass(this.cfg.currMode);
            this.cfg.currMode = name;
            Perf.select('#' + this.cfg.id).addClass(this.cfg.currMode);
            var state = this.cfg.states[this.cfg.currMode];
            Perf.select('#' + this.cfg.id + '_title').text(state? state.title: '');
            // or set tooltip, if we're reduced
            if (this.cfg.isReduced) {
            	this.setTooltip(this.cfg.states[this.cfg.currMode].title);
            }
        },

        setText: function(label) {
             Perf.select('#' + this.cfg.id + '_title').text(label);
        },

        getText:function(){
          return Perf.select('#' + this.cfg.id + '_title').text();
        },

        setReduced: function( value ) {
        	var title = Perf.getElementById(this.cfg.id + '_title');
        	if (this.cfg.isReduced != value) {
	        	if (value) {
	            	title.style.display = 'none';
	            	this._view.addClass('reduced');
	            	this.setTooltip(this.cfg.states[this.cfg.currMode].title);
	        	}
                else {
                    title.style.display = 'inline';
	        		this._view.removeClass('reduced');
	        	}
	        	this.cfg.isReduced = value ;
        	}
        },

        setTooltip: function(value) {
            Perf.getElementById(this.cfg.id + '_icon').title = value;
        }
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/buttons/ButtonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/Button.js
////////////////////////////////////////
(function() {

    t2k.component.buttons.Button = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.Button',

        ctor: function(config) {
            // Delegate
            this._super(config);
            // Create the view
            this.initView() ;
            // Start in disabled mode.
            this.cfg.enabled = false ;
            this.setEnabled( false ) ;
        },
        
        initView: function() {
        	this.view = new t2k.component.buttons.ButtonView(this.cfg) ;
        },

        setClickHandler: function(mode, callback) {
        	
            // make the triggered callback be delayed to run after focus-out events  
        	function delayedCallback() {
                var argz = arguments ;
				var funcThis = this ;
				function applyFunc() {
					callback.apply( funcThis, argz ) ;
	            } ;
				setTimeout( applyFunc, 10 ) ;
            } ;
            
//            this.view.registerEvent(mode, callback);
            this.view.registerEvent(mode, delayedCallback);
        },

        setMode: function(name) {
            this.cfg.currMode = name;
            this.view.setMode(name);
        },

        setText: function(label) {
            this.view.setText(label);
        },

        getText:function(){
          return this.view.getText();
        },

        getMode: function() {
            return this.cfg.currMode;
        },
        
        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	this.cfg.isReduced = value ;
	        	this.view.setReduced( value ) ;
        	}
        },

        getState: function() {
            var state = jQuery('<button/>');
            jQuery(state).attr("enabled", !!this.isEnabled());
            jQuery(state).attr("visible", !!this.isVisible());
            jQuery(state).attr("mode", this.cfg.currMode);
            jQuery(state).attr("text" , this.getText());
            return state;
        },

        setState: function(xml) {
            this._super(xml);
            var jqXml = jQuery(xml);
            if (jqXml.length <= 0) return;
            this.setEnabled(jqXml.attr('enabled') === 'true');
            this.setVisible(jqXml.attr('visible') === 'true');
            this.setMode(jqXml.attr('mode'));
            this.setText(jqXml.attr('text'));
        },

        setEnabled: function(flag) {
            this.prevEnabledState = this.isEnabled();
            this._super(flag);
        },

        setPrevEnabledState: function(){
            this.setEnabled(this.prevEnabledState);
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/buttons/Button.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/ProgressButtonView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div id='{{id}}' class='{{style}} disabled {{currState}} not_selectable'>\
            <div id='{{id}}_content' class='{{style}}_content'>\
                <div id='{{id}}_icon' class='{{style}}_icon'><span id='check'>8</span><span id='tryagain'>=</span><span id='showanswer'>9</span><span id='progress'>4</span></div>\
                <div id='{{id}}_title' class='{{style}}_text'></div>\
            </div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.buttons.ProgressButtonView = t2k.component.buttons.ButtonView.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.ProgressButtonView',

        /**
         * 2d0 - complete doc
         */
        ctor: function(config) {
            // Delegate.
            this._super(override(config, defaultConfig));
        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/buttons/ProgressButtonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/ProgressButton.js
////////////////////////////////////////
(function() {

    t2k.component.buttons.ProgressButton = t2k.component.buttons.Button.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.ProgressButton',

        initView: function() {
        	this.view = new t2k.component.buttons.ProgressButtonView(this.cfg) ;
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/buttons/ProgressButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/ToggleButtonView.js
////////////////////////////////////////
(function() {

    t2k.component.buttons.ToggleButtonView = t2k.component.buttons.ButtonView.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.ToggleButtonView',

        ctor: function(config) {
            // Delegate.
            this._super(config);
            // Closure ref.
            var thi$ = this;
            
            this._view.click( function(){
            	thi$.dispatchEvent('toggle');
            } ) ;
        },
        
        setToggled: function( flag ){
        	this.toggled = flag ;
        	if( flag ) {
        		this._view.addClass( 'toggled' ) ;
        	} else {
        		this._view.removeClass( 'toggled' ) ;
        	}
        }
        
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/buttons/ToggleButtonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/ToggleButton.js
////////////////////////////////////////
(function() {

    t2k.component.buttons.ToggleButton = t2k.component.buttons.Button.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.ToggleButton',

        ctor: function(config) {
            // Delegate
            this._super(config);
            this.toggled = this.cfg.toggled ;
            
            var thi$ = this ;
            
            // register view events
            this.view.registerEvent( 'toggle', function() {
                thi$.toggled = !thi$.toggled ;
                thi$.view.setToggled( thi$.toggled ) ;
                thi$.cfg.clickCallback( thi$.toggled ) ;
            } ) ;
        },

        initView: function() {
            this.view = new t2k.component.buttons.ToggleButtonView( this.cfg ) ;
        },

        getState: function() {
            var state = _super.getState() ;
            jQuery(state).attr( 'toggled', !!this.cfg.toggled ) ;
            return state ;
        },

        setState: function(xml) {
            this._super(xml);
            var jqXml = jQuery( xml ) ;
            if ( jqXml.length <= 0 ) return ;
            this.setToggled( jqXml.attr( 'toggled' ) );
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/buttons/ToggleButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/PushButtonView.js
////////////////////////////////////////
(function() {

    t2k.component.buttons.PushButtonView = t2k.component.buttons.ButtonView.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.PushButtonView',

        ctor: function(config) {
            // Delegate.
            this._super(config);
            // Closure ref.
            var thi$ = this;

            // set push and release callbacks
	        function onMouseDown(e) {
		        e.stopPropagation();
		        if (thi$.isEnabled()) {
			        thi$.dispatchEvent('push');
		        }

		        jQuery(document).one('mouseup', onMouseUp);
		        return false;
	        }

	        function onMouseUp(e) {
		        e.stopPropagation();
		        if (thi$.isEnabled()) {
			        thi$.dispatchEvent('release');
		        }
		        return false;
	        }

            this._view.mousedown(onMouseDown);
        }
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/buttons/PushButtonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/buttons/PushButton.js
////////////////////////////////////////
(function() {

    t2k.component.buttons.PushButton = t2k.component.buttons.Button.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.buttons.PushButton',

        ctor: function(config) {
            // Delegate
            this._super(config);

            // register view events
            this.view.registerEvent('push', this.cfg.pushCallback);
            this.view.registerEvent('release', this.cfg.releaseCallback);
        },

        initView: function() {
            this.view = new t2k.component.buttons.PushButtonView(this.cfg) ;
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/buttons/PushButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/imageViewer/ImageViewerViewConfig.js
////////////////////////////////////////

// Image Viewer constant values
t2k.component.imageViewer.ImageViewerViewConstants = { 
		playerSelector		: "div.player",
		navigationBarSelector : "div.progress-bar",
		minimumReadableParamName : "minimumReadable",
		thumbnailWidth : 124,
		thumbnailHeight : 124,
		minImageConteinerWidth : 124,
		absoluteMinimumLong : 252,
		absoluteMinimumShort : 70,
		reductionRange : 3,
		reduction : 'reduction',
		optimumWidthCoefficient : 0.8,
		thumbnailWrapperPadding : 4,
		normalWrapperPadding : 2,
		iconSize : 20,
		maximumSizeIndex : 0.72,
		maximumSizeIndex_Balloon : 0.98,
		imageViewerMinimumWidth : 252,
		defaultMinReadable : 1,
        blowupMargin : 10,
        blowupMarginRight : 20, // + scrollbar width
        modalCloseSize: 35,
		sharedAreaPadding : {
			top: 42,
			left: 21
		}
};
////////////////////////////////////////
// SRC End --> t2k/component/imageViewer/ImageViewerViewConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/imageViewer/ImageViewer.js
////////////////////////////////////////
(function() {

    t2k.component.imageViewer.ImageViewer = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.imageViewer.ImageViewer',

        ctor: function(config) {
            // Delegate
            this._super(config);
            // reference
            var thi$ = this;

	        this.$data = jQuery(this.cfg.data);

            // get pic type and init view with onAbsMin event
            this.getPicType();
            
            this.initMembers();
            
            if (this.type == 'swf'){
            	this.view = this.createNewView(t2k.component.imageViewer.ImageViewerViewSwf, merge(this.cfg,{
            			isInteractive: jQuery( this.cfg.data ).attr( 'isInteractive' ) == 'true',
            			events:{
                    		onAbsMin : function(){
                    			if (thi$.cfg.onAbsMin)
                    				thi$.cfg.onAbsMin();
                    		},
                    		
                    		setTumbnailAppliedForSmallImage : function(){
                    			thi$.tumbnailAppliedForSmallImage = true;
                    		}
                    	}	
            		}
            	));
            } else {
            	this.view = this.createNewView(t2k.component.imageViewer.ImageViewerView, merge(this.cfg,{
	        			events:{
	                		onAbsMin : function(){
	                			if (thi$.cfg.onAbsMin)
	                				thi$.cfg.onAbsMin();
	                		},
	                		
	                		setTumbnailAppliedForSmallImage : function(){
                    			thi$.tumbnailAppliedForSmallImage = true;
                    		}
	                	}
	            	}
	            ));
            }
        },
        /**
		 * reduce
		 */
		reduce : function(val){
			this._super(val);
			this.layout.onRendered();
		},
		
		/**
		 * setEnabled
		 * @param flag
		 */
		setEnabled : function(flag){
			this._super(flag);
			this.view.setEnabled(flag);
		},
		
		/**
		 * getPicType
		 * from xml
		 */
		getPicType: function(){
			var src = this.cfg.src ? this.cfg.src : this.$data.attr('src');
			var srcArr = src.split('.');
            this.type = srcArr[srcArr.length - 1];
		},
		
		initMembers : function(){
			this.tumbnailAppliedForSmallImage = false;
			this.cfg.imageWidth =  this.$data.length  ? (this.$data.attr('width')  ? this.$data.attr('width').px2int()  : 1) : this.cfg.width;
			this.cfg.imageHeight = this.$data.length  ? (this.$data.attr('height') ? this.$data.attr('height').px2int() : 1) : this.cfg.height;
		}

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/imageViewer/ImageViewer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/imageViewer/ImageViewerView.js
////////////////////////////////////////
(function () {

    var TEMPLATE =
        "<div class='imageViewer' id='{{id}}'>\
        	<div id='{{id}}_content' class='imageViewer_content'>\
        		<div id='{{id}}_imageContainer' class='imageContainer' style='width:{{imageContainerWidth}}px;height:{{imageContainerHeight}}px'>\
        			<img id='{{id}}_img' class='image' src='{{src}}' style='width:{{imgWidth}}px; height:{{imgHeight}}px' alt='{{alt}}'/>\
        			<div id='{{id}}_zoomButton' class='zoomButton'/>\
        			{{#enableSoundButton}}\
        				<div id='{{id}}_soundButton' class='soundButton'></div>\
					{{/enableSoundButton}}\
        		</div>\
				{{#enableCredit}}\
        			<div id='{{id}}_credit' class='credit'></div>\
				{{/enableCredit}}\
				{{#enableCaption}}\
				<div id='{{id}}_caption' class='caption'></div>\
				{{/enableCaption}}\
        	</div>\
			<div id='{{id}}_masc' class='masc'></div>\
        </div>";


    // copy all ImageViewer constants from ImageViewerViewConstants to be readable
    var constants = t2k.component.imageViewer.ImageViewerViewConstants;

    /**
     * ImageViewerView
     */
    t2k.component.imageViewer.ImageViewerView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.imageViewer.ImageViewerView',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config, superMe) {

            // first ctor init it's class members and get image size
            // getImgSize.. calls ctor again fot _super()

	        //if in config we got viewObject - use it don't create image (d&d dropping event)
	        if (config.viewObject) {
		        this.cfg = config;

		        this.initClassMembers(config);
		        this._view = this.cfg.viewObject;
		        this.cfg.parent.html(config.viewObject);

		        this.setEnabled(true);
		        this._view.show();

		        // dispatch rendered
		        this.dispatchEvent('onRendered');

	        } else {
		        if (!superMe) {
			        this.cfg = config;
			        this.initClassMembers(config);
			        this.getImgSize();
			        this.checkBlowup();
		        } else {
			        // super - render mustache
			        this._super(copy(this.cfg, {
				        template:this.getTemplate(),
				        src:this.src,
				        imgWidth:this.imageWidth,
				        imgHeight:this.imageHeight,
				        imageContainerHeight:this.imageContainerHeight,
				        imageContainerWidth:this.imageContainerWidth + 2,
				        alt:this.alt,
				        enableSoundButton:!!this.imageSound,
				        enableCredit:!!this.credit,
				        enableCaption:!!this.caption
			        }));

			        this.convinietShortHand();
			        this.preventUserDrag();
			        // TODO: delete
			        this.devReduction();
			        this.checkBlowup();
			        this.checkThumbnail();

			        // build imageSound / credit / caption
			        this.buildAdditionalComponents();

			        // dispatch rendered
			        this.dispatchEvent('onRendered');
		        }
	        }
        },

        /**
         * getTemplate
         * this function will override on imageViewerViewSwf,
         * to provide each class it's own template
         * @returns {String}
         */
        getTemplate:function () {
            return TEMPLATE;
        },

        resize:function (size) {

        },

        /**
         * resetTile
         * override
         */
        resetTile : function(){

        },

        /**
         * render
         * override original render.
         * if image viewer is not a blowup, add the html before the place holder and delete the place holder
         * @param element
         * @param template
         * @param context
         */
        render:function (element, template, context) {
	        jQuery(element).append(Mustache.to_html(template, context));
        },

        /**
         * convinietShortHand
         */
        convinietShortHand:function () {
            this._imageContainer = this._view.find('div[class=imageContainer]');
            this._image = this._view.find('img[class=image]');
            this._credit = this._view.find('div[class=credit]');
            this._capture = this._view.find('div[class=capture]');
            this._masc = this._view.find('div[class=masc]');
        },


        /**
         * Don't let user drag the image viewer.
         */
        preventUserDrag: function() {
            // FireFox, WebKit
            this._image.attr({draggable: false});
            // + IE
            this._image.bind("dragstart", function() {return false});
        },


        /**
         * checkBlowup
         * check if image viewer should apply blowup, and init blowup behavior
         */
        checkBlowup:function () {
            if (!this.enableBlowup && !this.isBlowup && (this.imageWidth < (this.nativeImageWidth * this.minimumReadable))) {
                this.applyBlowup();
            }else{
                if(this.cfg.dontEnableBlowup && (this.imageWidth < (this.nativeImageWidth * this.minimumReadable))){
                    this.dispatchEvent('cantReduce');
                    return;
                }
            }
        },

        /**
         * applyBlowup
         * init blowup behavior
         */
        applyBlowup:function () {
            var thi$ = this;
            // set blowup flag - true
            this.enableBlowup = true;

            // if configuration doesn't forbid blowup, init blowup behavior
            if (!this.dontEnableBlowup || (!!this.caption || !!this.credit )) {
                // hover behavior sets by css
                this._content && this._content.addClass('blowup');
                // onClick show blowup
                this._imageContainer.click(function () {
                    thi$.showBlowup();
                });
            }
        },

        /**
         * checkThumbnail
         * check if image viewer should be at thumbnail mode and apply
         */
        checkThumbnail:function () {

            // if image viewer is already at thumbnail mode - return
            if (!!this.enableThumbnail || !!this.cfg.disableTumbnail || this.cfg.dontEnableBlowup) {
                return;
            }

            // u'll find a full explanation at initClassMembers() fnc.
            if (this.tumbnailAppliedForSmallImage) {
                this.applyThumbnail();
                return;
            }

            var longest, shortest;

            // get shortest and longest
            if (this.imageWidth > this.imageHeight) {
                longest = this.imageWidth;
                shortest = this.imageHeight;
            } else {
                longest = this.imageHeight;
                shortest = this.imageWidth;
            }

            // check img size vs. thumbnail size
            if ((longest < constants.absoluteMinimumLong) || (shortest < constants.absoluteMinimumShort)) {

                // don't apply thumbnail on Zero reduction step
                if (this.reductionStep > 0) {
                    this._imageContainer.length && (this._imageContainer[0].style.paddingLeft = '');
                    this.applyThumbnail();
                }
                else {
                    // on zero stepReduction align the image to the center
                    this._imageContainer.length && (this._imageContainer[0].style.paddingLeft =
                        ((this.imageContainerWidth - this.imageWidth) / 2) + 'px');
                }
            }
        },

        /**
         * applyThumbnail
         */
        applyThumbnail:function () {

            if (!!this._soundButton || this._credit.length || !!this._caption) {
                this.applyBlowup();
            }

            // dispatch cantReduce any more
            this.dispatchEvent('cantReduce');
            this.dispatchEvent("onAbsMin", this);

            // set thumbnail flag - true
            this.enableThumbnail = true;
            // remove imageSound, credit and caption
            this.removeAdditionalComponents();
            this._content && this._content.addClass('thumbnail');

            // get image conteiner size
            this.imageContainerHeight = this.thumbnailSize.height;
            this.imageContainerWidth = this.thumbnailSize.width;

            // set Img Size and align image to center
            if (!this.optimumSizeIsSmallerThanThumbnail()) {
                this.setSizeImageByRealAspectRatio(this.imageWidth, this.imageHeight);
            } else if (!this.caption && !this.credit) {
	            this.setSizeImageByRealAspectRatio(this.thumbnailSize.width, this.thumbnailSize.height);
                this.dispatchEvent('setTumbnailAppliedForSmallImage');
                this.tumbnailAppliedForSmallImage = true;
            }
            this.changeImageSizes({
                'left':parseInt((this.imageContainerWidth - this.imageWidth) / 2, 10),
                'top':parseInt((this.imageContainerHeight - this.imageHeight) / 2, 10)
            });

        },

        /**
         * calculated and modified image size accordingly Real Aspect Ratio of Image
         * @param widthImg
         * @param heightImg
         */
        setSizeImageByRealAspectRatio:function (widthImg, heightImg) {
            if (widthImg > heightImg) {
                this.imageWidth = parseInt(constants.thumbnailWidth - 2, 10);
                this.imageHeight = parseInt(constants.thumbnailWidth * this.aspectRatio, 10);

            } else if (heightImg > widthImg) {
                this.imageWidth = parseInt(constants.thumbnailWidth / this.aspectRatio, 10);
                this.imageHeight = parseInt(constants.thumbnailHeight - 2, 10);

            } else {
                this.imageWidth = parseInt(constants.thumbnailWidth - 2, 10);
                this.imageHeight = parseInt(constants.thumbnailHeight - 2, 10);
            }
        },

        /**
         * showBlowup
         */
        //old blowup implementation
        /*showBlowup:function () {
            // remove prev. blowup
            Perf.select('#imageViewerBlowup', 1).remove();

            // reference
            var thi$ = this;

            // set blowup div
            this.blowup = jQuery('<div/>').attr('id', 'imageViewerBlowup').fadeTo(1, 0.01).appendTo(this._view);

            // close button
            jQuery('<div/>').attr('class', 'x').click(
                function () {
                    thi$.blowup.remove();
                }).appendTo(this.blowup);

            // remove blowup property
            var removeBlowup = function () {
                thi$.blowup.remove();
                Perf.select('body').unbind('keyup', bodyKeyEventHandler);
                Perf.select('body').unbind('mousedown', bodyClickEventHandler);
                thi$.unbindScrollEvent();
            };

            // remove blowup on ESC pressed
            var bodyKeyEventHandler = function (e) {
                if (e.keyCode == 27) {
                    removeBlowup();
                }
            };

            // remove blowup on body click
            var bodyClickEventHandler = function (e) {
                removeBlowup();

            };

            // set body events (keyup and mousedown)
                Perf.select('body').bind('keyup', bodyKeyEventHandler).bind('mousedown', bodyClickEventHandler);

            // init image viewer inside the blowup div
            new t2k.component.imageViewer.ImageViewer(copy({}, {
                data:this.cfg.data,
                parent:'imageViewerBlowup',
                isBlowup:true,
                container:this.viewPortContainer,
                // on blowup, set blowup position
                onRendered:function () {
                    thi$.setBlowupPosition();
                }
            }));

            // set blowup position by scroll
            var scroll_parent = thi$.blowup.parents('.scroll_enabled')[0];
            if (scroll_parent && (scroll_parent.scrollHeight > scroll_parent.clientHeight)) {
                domUtils.reparentOnceAndRepositionElement(thi$.blowup, thi$.blowup.offset());
            }
            thi$.bindScrollEvent();
        },*/

        showBlowup:function () {
            // remove prev.
            $('.modal_content').find('.imageViewer').html('');
            ENV.Modal.show(this.cfg);
        },

        /**
         * setBlowupPosition
         */
        setBlowupPosition:function () {

            //  reference
            var blowup = this.blowup,
            //  declarations
                blowupSetting = {},
            //  current this._content position relative to viewport
                contentLeft = this._content.offset().left,
                contentTop  = this._content.offset().top,
            //  we have navigation bar over viewport on the top
            //  get it demensions to fix the top position of the blowup
                navigationBar = jQuery(constants.navigationBarSelector);

            blowupSetting.navigationBarHeight = navigationBar ? navigationBar.height() : 0;
            blowupSetting.width  = parseInt(blowup.outerWidth());
            blowupSetting.height = parseInt(blowup.outerHeight());
            //blowup offset from the this._content
            blowupSetting.left = contentLeft - (~~((blowupSetting.width - this._content.width()) / 2));
            blowupSetting.top  = blowupSetting.navigationBarHeight + contentTop - (~~((blowupSetting.height - this._content.height()) / 2));//~~ == Math.round
            //check/override the blowup position according to the viewport
            blowupSetting = this.checkBlowupPositionInViewport(blowupSetting);
            // set position according the regular measurements
            blowup.offset({'top':blowupSetting.top,'left':blowupSetting.left});
            // set blowup correct position and fade in
            this.blowup.fadeTo(300, 1);
        },

        /**
         * checkBlowupPositionInViewport : check/override the blowup position according to the viewport
         * @param blowupSetting
         * return checked/overrided blowupSetting
         */
        checkBlowupPositionInViewport : function(blowupSetting){
            var _blowupSetting  = blowupSetting,
                blowupMargin    = constants.blowupMargin,
                viewportHeight  = this.viewPortContainer.outerHeight(),
                viewportWidth   = this.viewPortContainer.outerWidth();
            // check top beyond viewport
            _blowupSetting.top =_blowupSetting.top <= _blowupSetting.navigationBarHeight ? _blowupSetting.navigationBarHeight + blowupMargin : _blowupSetting.top;
            // check left beyond viewport
            _blowupSetting.left =_blowupSetting.left < blowupMargin ? blowupMargin : _blowupSetting.left;
            // check right beyond viewport
            if(_blowupSetting.left + _blowupSetting.width > viewportWidth){
                _blowupSetting.left = _blowupSetting.left - ((_blowupSetting.left + _blowupSetting.width) - viewportWidth) - constants.blowupMarginRight ;
            }
            // check bottom beyond viewport
            if(_blowupSetting.top + _blowupSetting.height > viewportHeight){
                _blowupSetting.top = _blowupSetting.top - ((_blowupSetting.top + _blowupSetting.height) - viewportHeight)- blowupMargin;
            }
            return _blowupSetting;
        },

        // TODO: dev only. delete on production !
        devReduction:function () {
            var thi$ = this;
            Perf.select('body').keyup(function (e) {
                if (e.keyCode == 32) {
                    thi$.reduce();
                }
            });
        },

        // set blowup position by scroll
        bindScrollEvent:function () {
            domUtils.registerToScroll(this.blowup,this);
        },
        // set blowup position by scroll
        unbindScrollEvent:function () {
            domUtils.unRegisterToScroll(this.blowup,this);
        },

        /**
         * initClassMembers
         * @param config
         */
        initClassMembers:function (config) {

            // class members:
            this.imageWidth;
            this.imageHeight;
            this.optimumWidth;
            this.optimumHeight;

            this.cfg.isNotIinteractive = !!!this.cfg.isInteractive;

            // this var, mean that iv in thumbnail mode,
            // and it's image is smaller than thumbnail size, and iv has no caption or credit.
            // use: on option blowup, iv will init again inside the cloned option,
            // if the original's var is true, that var will appears on the initialize iv as config member.
            // if this var is true, iv will automatic be set sa thumbnail,
            // so the size of the original and the cloned will be the same.
            this.tumbnailAppliedForSmallImage = !!this.cfg.tumbnailAppliedForSmallImage;

            // get a xml from config
            this.xml = jQuery(config.data);

            // save minimum width parameter on this object
            this.minWidth = constants.imageViewerMinimumWidth;

            // size (in pixel) of every reduction step that may be done to ImageViewer
            this.reductionStepSize;

            this.dontEnableBlowup = !!config.dontEnableBlowup;
            this.dontEnableThumbnail = false;

            this.enableBlowup = false;
            this.enableThumbnail = false;

            // thumbnailSize
            this.thumbnailSize = !!this.cfg.thumbnailSize ? this.cfg.thumbnailSize : {width:constants.thumbnailWidth, height:constants.thumbnailHeight};

            // allowReduction
            this.enableReduction = true;

            // set credit member
            this.credit = this.xml.find('credit textViewer').get(0);
            if (this.credit == undefined) {
                this.credit = false;
            }

            // set caption member
            this.caption = this.xml.find('imageCaption textViewer').get(0);
            if (this.caption == undefined) {
                this.caption = false;
            }

            // set imageSound member
            this.imageSound = jQuery(this.xml.find('imageSound').get(0));
            if (this.imageSound.length == 0) {
                this.imageSound = false;
            }

            // how many times a reduction was done
            this.reductionStep = this.cfg.reductionStep || 0;

            if (!this.cfg.dummyMode && !!this.cfg.compiledLayoutRes && !!this.cfg.compiledLayoutRes.reduction && (this.isBlowup !== true)) {
                this.reductionStep = this.cfg.compiledLayoutRes.reduction;
            }

            // A value in percents (%). If an image was reduced and its width now less then 'minimumReadable' blowup is shown
            this.minimumReadable;

            // retrieve minimumReadable. if undefined receives default - 1
            var minimumReadableParam = this.xml.attr(constants.minimumReadableParamName);
            if (minimumReadableParam != null && minimumReadableParam != undefined) {
                this.minimumReadable = parseFloat(minimumReadableParam);
            } else {
                // receive default value - 100%
                this.minimumReadable = constants.defaultMinReadable;
            }

	        if(this.minimumReadable > 1) { //not float - percent integer value
		        this.minimumReadable = (this.minimumReadable / 100);
	        }

            // maxReduction_minReadable means that imaveViewer will maximum reduced to it's min. Readable Size.
            // (uses in tables, for now)
            // gets it value from xml || configuration
            this.maxReduction_minReadable = !!this.cfg.maxReduction_minReadable || !!(this.xml.attr('maxReduction_minReadable') == 'true');

            // a native size of the image we get from Image object when it loaded
            this.nativeImageWidth;
            this.nativeImageHeight;

            // a relation between width and height to decide if an image has landscape or portret orientation
            this.aspectRatio;
            this.isLandscape;

            // get alt from xml
            this.alt = this.xml.attr('alt');

            // get src from xml or from config
            this.src = AbsPath(config.src ? config.src : this.xml.attr('src'));

            // on config.src, srt this.src and delete config.src for right copy to mustache
            delete this.cfg.src;
        },

        /**
         * getImgSize
         */
        getImgSize:function () {
//          build image object and preload an image

	        this.calcOptimumSize();
	        this.calcReductionStepSize();
	        this.calculateImageViewerInitLayoutParams();
	        this.checkImageWidthVsTaskWidth();
	        this.calcImageSizeAfterReduction();
	        this.calcImageConteinerSize();
	        // call ctor for _super
	        this.ctor(this.cfg, true);

        },

        /**
         * onViewRendered
         * override with an empty function.
         * imageViewerView will dispatch the 'onRendered' event himself.
         */
        onViewRendered:function () {
        },

        /**
         * calcImageConteinerSize
         */
        calcImageConteinerSize:function () {
            this.imageContainerHeight = this.imageHeight;// + 2
            this.imageContainerWidth = this.imageWidth;

            // if there is credit or capture and the conteiner width is smaller then min. set conteiner width = min.
            if ((this.credit || this.capture) && (this.imageContainerWidth < constants.minImageConteinerWidth)) {
                this.imageContainerWidth = constants.minImageConteinerWidth;
            }
        },

        /**
         * checkImageWidthVsTaskWidth
         * and set reductionStep.
         * even on init, imageViewer is not allowed to be wither than the task
         */
        checkImageWidthVsTaskWidth:function () {

            var parent = (typeof(this.cfg.parent) == 'object') ? this.cfg.parent : Perf.select('#' + this.cfg.parent);
            var netoTaskWidth;

            var taskWidth = 0;

            var container = this.cfg.container || parent.parents('.task_container');

            if (!container) {
                throw ('image viewer has no container');
            }

            netoTaskWidth = container.width();


            // if the neto task width is bigger then image width, configure reduction step
            if (this.imageWidth > netoTaskWidth) {
                // calc reduction step to align imageWidth and taskWidth
                var widthDelta = this.imageWidth - netoTaskWidth;
                var reductionVal = Math.ceil(widthDelta / this.reductionStepSize);
                this.reductionStep = (this.reductionStep > reductionVal) ? this.reductionStep : reductionVal;
            }
        },

        validateReductionVsMinReadableStopper:function () {
            if (!this.maxReduction_minReadable) return true;

            var nextStepwidth = this.optimumWidth - ((this.reductionStep + 1) * this.reductionStepSize);
            var minReadableWidth = this.optimumWidth * this.minimumReadable;

            if (nextStepwidth < minReadableWidth)
                return false;

            return true;

        },

        /**
         * calcImageSizeAfterReduction
         */
        calcImageSizeAfterReduction:function () {
            var nextStepwidth = this.optimumWidth - (this.reductionStep * this.reductionStepSize);

            /** Cannot reduce to negative values. */
            if (nextStepwidth < 0) return;

            var stepReduction = nextStepwidth / this.nativeImageWidth;

            if (stepReduction < this.cfg.reductionStopper) {
                nextStepwidth = this.nativeImageWidth * this.cfg.reductionStopper;
                this.stopReduction = true;
            }

            this.imageWidth = nextStepwidth;
            this.imageHeight = this.aspectRatio * this.imageWidth;


        },

        /**
         * removeAdditionalComponents
         */
        removeAdditionalComponents:function () {
            if (!!this._soundButton) {
                this._soundButton.hide();
            }
            if (!!this._credit) {
                this._credit.hide();
            }
            if (!!this._caption) {
                this._caption.hide();
            }
        },

        /**
         * buildImageSound
         * init mediaPlayer (soundButton)
         */
        buildImageSound:function () {
            // build mediaPlayer sound button
            if (!!this.imageSound) {
                this._soundButton = this._view.find('.soundButton');
                var imageSoundSrc = this.imageSound.attr('src');
                this.imageSound = new t2k.component.mediaPlayer.MediaPlayer(copy({}, {
                    parent:this._soundButton,
                    type:'soundButton',
                    src:imageSoundSrc,
                    onRendered:function () {
                    },
                    dummyMode:this.cfg.dummyMode
                }));
                this.imageSound.setEnabled(true);
            }
        },

        /**
         * buildCaptionAndCredit
         */
        buildCaptionAndCredit:function () {
            // check if there's a credit text and initialize a text viewer component
            if (!!this.credit) {
                this.textViewerCredit = componentFactory.create({
                    data:this.credit,
                    parent:this.cfg.id + '_credit',
                    width:this.imageContainerWidth + 'px',
                    onRendered:function () {
                    }
                });
            }

            // check if there's a caption text and initialize a text viewer component
            if (!!this.caption) {
                this.textViewerCaption = componentFactory.create({
                    data:this.caption,
                    parent:this.cfg.id + '_caption',
                    width:this.imageContainerWidth + 'px',
                    onRendered:function () {
                    }
                });
            }
        },

        /**
         * buildAdditionalComponents
         * build additional components (TextViewer for caption, credit... sound) and append them to ImageViewer)
         */
        buildAdditionalComponents:function () {
            // build additional component only if IV is not on a thumbnail mode
            if (!this.enableThumbnail) {
                this.buildImageSound();
                this.buildCaptionAndCredit();
                this.reduceCaptionAndCredit();
            }
        },

        /**
         * removeCaptionAndCreditContent
         * use on reduction, for textViewer rebuild
         */
        removeCaptionAndCreditContent:function () {
            if (!!this._credit) {
                this._credit.html('');
            }
            if (!!this._caption) {
                this._caption.html('');
            }
        },

        /**
         * reduceCaptionAndCredit
         * makes reduction to additional image viewer components (TextViewer)
         * @param reductionValue
         */
        reduceCaptionAndCredit:function () {
            if (this.reductionStep == 0) {
                return;
            }
            if (this.textViewerCaption) {
                this.textViewerCaption.reduce(this.reductionStep);
            }
            if (this.textViewerCredit) {
                this.textViewerCredit.reduce(this.reductionStep);
            }
        },

        /**
         * fitRectangles
         * Fit rectInner in rectOuter
         * @param rectInner {width, height}
         * @param rectOuter {width, height}
         * @return newInnerSize {width, height}
         */
        fitRectangles:function (rectInner, rectOuter) {
            // calculate scale ratios
            var ratioW = rectOuter.width / rectInner.width;
            var ratioH = rectOuter.height / rectInner.height;

            // We need to smaller ratio between the widths and heights ratios
            var selectedRatio = ratioW < ratioH ? ratioW : ratioH;

            // we don't have to scale if inner rect fits in the outer one
            if (selectedRatio > 1) {
                selectedRatio = 1;
            }

            // calculate our new image dimensions
            //if is  in blowup we need to reduce the frame around the image
            var newInnerRect = {
                width:(rectInner.width * selectedRatio) - (this.isBlowup? (constants.blowupMargin*2) : 0),
                height:(rectInner.height * selectedRatio)- (this.isBlowup? (constants.blowupMargin*2) : 0)
            };

            return newInnerRect;
        },

        /**
         * calcOptimumSize
         * is used to calculate image optimum size according to current resolution
         */
        calcOptimumSize:function () {
            // get image properties: width and height
            this.nativeImageWidth = this.cfg.imageWidth;
            this.nativeImageHeight = this.cfg.imageHeight;

            // get aspect ratio in order to know every time a right image proportion
            this.aspectRatio = this.nativeImageHeight / this.nativeImageWidth;

            // calculate image display mode: true - landscape, false - portrait
            this.isLandscape = this.aspectRatio <= 1;

            // get viewport size
            this.viewPortContainer = jQuery(constants.playerSelector);
            //get container element from config, in case of table- we dont want the cell to be the parent because it dont have ist full size yet. 
            //and than the img might apear too small 
            var containerElement = this.cfg.container ? this.cfg.container : jQuery(constants.playerSelector);
            var widthTmp = containerElement.outerWidth();
            var heightTmp = containerElement.outerHeight();         

            // calculation the actual size of the modal 
            // 0.85 - coefficient calculated from the css rules for the modal ( .modal_wrapper -> max-width:90% && .modal_content -> max-width:95% : 0.9*0.95 = 0.85)
            if (this.cfg.isBlowup) {
                widthTmp = (this.viewPortContainer.width() * 0.85) - constants.sharedAreaPadding.left - constants.modalCloseSize;
                heightTmp = (this.viewPortContainer.height() * 0.85) - constants.sharedAreaPadding.top;
            }

            //get maximum size. if is blowup we need to reduce the size of the cloze of the modal view
	        var maximum = (this.cfg.useMax || this.cfg.isBlowup ) ? {
                width:widthTmp - (this.cfg.isBlowup ? constants.modalCloseSize : 0) - constants.sharedAreaPadding.left,
		        height:heightTmp - (this.cfg.isBlowup ? constants.modalCloseSize : 0) - constants.sharedAreaPadding.top
	        } : {
		        width:widthTmp * (this.cfg.parentType == 'balloon' ? constants.maximumSizeIndex_Balloon : constants.maximumSizeIndex),
		        height:this.viewPortContainer.height() * (this.cfg.parentType == 'balloon' ? constants.maximumSizeIndex_Balloon : constants.maximumSizeIndex)
	        };

            //get image size. if is in blowup we need to add margins of blowup frame to img diamentions 
	        var cfgSize = {
		        width:this.nativeImageWidth + (this.cfg.isBlowup ? (constants.blowupMargin * 2 ) : 0),
		        height:this.nativeImageHeight + (this.cfg.isBlowup ? (constants.blowupMargin * 2 ) : 0)
	        };

            this.optimumSize = this.fitRectangles(cfgSize, maximum);
            this.optimumWidth = this.imageWidth = this.optimumSize.width;
            this.optimumHeight = this.imageHeight = this.optimumSize.height;

            // on configuration height, set it, calc width, and delete height configuration to allow correct copy for mustache

            if (this.cfg.height) {
                var calcHeight = this.cfg.height;
                this.optimumWidth = this.imageWidth = calcHeight / this.aspectRatio;
                this.optimumHeight = this.imageHeight = calcHeight;
            }
        },

        getReductionReport:function () {

            var percent = this.imageWidth / this.nativeImageWidth,
                belowRead = !!this.enableBlowup,
                belowAbs = !!this.enableThumbnail
                ;

            return { percent:percent, belowRead:belowRead, belowAbs:belowAbs };
        },

        /**
         * calculateImageViewerInitLayoutParams
         */
        calculateImageViewerInitLayoutParams:function () {
            this.layoutParams = this.getLayoutParams();
            if (this.layoutParams != null && this.layoutParams != undefined) {
                // happend during playing
                this.analizeLayoutParams();
            }
        },

        /**
         * calcReductionStepSize
         * calculates how long in pixels every
         * reduction step
         */
        calcReductionStepSize:function () {

            // calculate a reduction step size- a number of pixels IV will be reduce on every reduction step
            if (this.aspectRatio > 1) { // meand that height is longest
                // portrait

                if (constants.absoluteMinimumLong / constants.absoluteMinimumShort > this.aspectRatio) {
                    this.reductionStepSize = Math.abs(((this.imageHeight - constants.absoluteMinimumLong) / constants.reductionRange) / this.aspectRatio);
                    this.reductionStepSize = this.reductionStepSize > 0 ? this.reductionStepSize : 1;
                } else {
                    //this.reductionStepSize = Math.abs((this.imageWidth - constants.absoluteMinimumLong)/ constants.reductionRange);
                    this.reductionStepSize = (this.imageWidth - constants.absoluteMinimumLong) / constants.reductionRange;
                   
                    this.reductionStepSize = this.reductionStepSize > 0 ? this.reductionStepSize : 1;
                }
            } else { // means that width is longest

                if (constants.absoluteMinimumShort / constants.absoluteMinimumLong >= this.aspectRatio) {
                    this.reductionStepSize = (( (this.imageHeight - constants.absoluteMinimumShort) / constants.reductionRange) / this.aspectRatio);
                    this.reductionStepSize = this.reductionStepSize > 0 ? this.reductionStepSize : 1;
                } else {
                    this.reductionStepSize = Math.abs((this.imageWidth - constants.absoluteMinimumLong) / constants.reductionRange);
                }
            }

            this.reductionStepSize = Math.ceil(this.reductionStepSize) + 0.1;
        },

        /**
         * getLayoutParams
         * retrieve layouts parameters from compiled xml file
         */
        getLayoutParams:function () {
            var layoutParamsEl = null;
            var layoutParams = {};
            if ((layoutParamsEl = jQuery(this.xml.find('layout').get(0))) != undefined) {
                layoutParamsEl.children().each(function () {
                    var item = jQuery(this).get(0);
                    layoutParams[item.tagName] = item.textContent;
                });
                return layoutParams;
            }
            return null;
        },

        /**
         * analizeLayoutParams
         * iterates through all layout parameters and call to appropriate function to handle them
         */
        analizeLayoutParams:function () {
            for (var key in this.layoutParams) {
                switch (key) {
                    case constants.reduction:
                        this.reductionStep = this.layoutParams[key];
                        break;
                }
            }
        },

        /**
         * reduce
         * reduce method- used to reduce an ImageViewer size according to resolution
         * @param reductionValue
         */
        reduce:function (reductionValue) {

            if (this.stopReduction || !!this.enableThumbnail) {
                this.dispatchEvent('cantReduce');
                return;
            }

            // validate reduction vs this.maxReduction_minReadable
            if (!this.validateReductionVsMinReadableStopper()) {
                this.dispatchEvent('cantReduce');
                return;
            }

            if (reductionValue == undefined || reductionValue == null) {
                this.reductionStep++;
            } else {
                this.reductionStep += reductionValue;
            }

            //stop reduction in the 10'th time to prevent infinite loops
            if(this.reductionStep >= 10){
                this.dispatchEvent('cantReduce');
                return;
            }

            // if reduction calls,
            // and optimum size is smaller than thumbnail, apply blowup and thumbnail
            if (!this.optimumSizeIsSmallerThanThumbnail()) {
                this.calcImageSizeAfterReduction();
                this.calcImageConteinerSize();
                this.changeImageSizes();
                this.checkThumbnail();
                this.checkBlowup();                
            } else {
                // apply thumbnail
                this.applyBlowup();
                this.applyThumbnail();
            }

            if (!!!this.enableThumbnail) {
                this.removeCaptionAndCreditContent();
                this.buildCaptionAndCredit();
                this.reduceCaptionAndCredit();
            }

        },

        optimumSizeIsSmallerThanThumbnail:function () {

            // if image optimus size is smaller than thumbnail size - return
            return (this.optimumWidth < this.thumbnailSize.width) &&
                (this.optimumHeight < this.thumbnailSize.height);
        },

        /**
         * changeImageSizes
         * @param [css] optional
         */
        changeImageSizes:function (css) {
            this._image.width(this.imageWidth).height(this.imageHeight);
            this._imageContainer.width(this.imageContainerWidth + 2).height(this.imageContainerHeight + 2);

            // if css, set css..
            if (css) {
                this._image.css(css);
            }
        },

        /**
         * setEnabled
         * overrides parent method. enables or disables IV component
         * @param flag: if true- enable, false- disable
         */
        setEnabled:function (flag) {

            if (!this._masc) {
                return;
            }

            if (!flag) {
                this._masc.show();
            } else {
                this._masc.hide();
            }
        },
        /**
         * setWidth override
         */
        setWidth:function () {
            // do nothing
        },
        /**
         * setHeight override
         */
        setHeight:function () {
            // do nothing
        }

        /* imageSoundView Object END */

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/imageViewer/ImageViewerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/imageViewer/ImageViewerViewSwf.js
////////////////////////////////////////
(function() {
	
	var TEMPLATE =
        "<div class='imageViewer' id='{{id}}'>\
        	<div id='{{id}}_content' class='imageViewer_content'>\
				{{#isNotIinteractive}}\
		        	<div id='{{id}}_imageContainer' class='imageContainer' style='position:absolute;width:{{imageContainerWidth}}px;height:{{imageContainerHeight}}px'>\
						<div id='{{id}}_zoomButton' class='zoomButton'/>\
						{{#enableSoundButton}}\
						<div id='{{id}}_soundButton' class='soundButton'></div>\
						{{/enableSoundButton}}\
					</div>\
				{{/isNotIinteractive}}\
				<div id='{{id}}_flashWrapper'>\
					<object 	id='{{id}}_flash' \
								width='{{imgWidth}}' height='{{imgHeight}}' \
		                        classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' \
		                        codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9.0.115'>\
		                            \
		                            <param name='movie' value='{{src}}'>\
		                            <param name='quality' value='high'>\
		                            <param name='wmode' value='opaque'>\
									<param name='scale' value='noBorder'>\
									<param name='play' value='true' />\
									<param name='loop' value='false' />\
		                            \
		                            <embed	src='{{src}}' \
				                            id='{{id}}_flash_embed' \
				                            scale='noBorder' \
				                            width='{{imgWidth}}' height='{{imgHeight}}' \
				                            swliveconnect='true' \
				                            quality='high' \
				                            wmode='opaque' \
				                            pluginspage='http://www.macromedia.com/go/getflashplayer' \
				                            type='application/x-shockwave-flash'/>\
					</object>\
				</div>\
				{{#enableCredit}}\
        			<div id='{{id}}_credit' class='credit'></div>\
				{{/enableCredit}}\
				{{#enableCaption}}\
				<div id='{{id}}_caption' class='caption'></div>\
				{{/enableCaption}}\
        	</div>\
        </div>";
		
	
	// copy all ImageViewer constants from ImageViewerViewConstants to be readable 
	var constants = t2k.component.imageViewer.ImageViewerViewConstants;
	
	/**
	 * ImageViewerView
	 */
	t2k.component.imageViewer.ImageViewerViewSwf = t2k.component.imageViewer.ImageViewerView.subClass({

				/** The class' name (for debugging purpose). */
				name : 't2k.component.imageViewer.ImageViewerViewSwf',

				/**
				 * @constructor
				 * @see superclass documentation
				 */
				ctor : function(config, superMe){
					this._super(config, superMe);
				},
				
				/**
				 * getTemplate
				 * override to provide it's own template
				 * @returns {String}
				 */
				getTemplate: function(){
					return TEMPLATE;
				},
				
				/**
				 * initClassMembers
				 * add members to _super
				 * @param config
				 */
				initClassMembers: function(config){
					this._super(config);
					this.tempImage = {};
					// width & height are taken from feeding
					this.tempImage.width = this.xml.attr('width');
					this.tempImage.height = this.xml.attr('height');
					
					// if !feeding - throw
					if (!this.tempImage.width || !this.tempImage.height){
						throw ('image viewer must get width & height on feeding swf image');
					}
				},
				
				/**
				 * getImgSize
				 * override (width & height are taken from feeding, no need to load the image)
				 */
				getImgSize: function(){
					// build image object and preload an image
					
					// reference
					var thi$ = this;
					
					// onload get size
					thi$.calcOptimumSize();
					thi$.calcReductionStepSize();
					thi$.calculateImageViewerInitLayoutParams();
					thi$.checkImageWidthVsTaskWidth();
					thi$.calcImageSizeAfterReduction();
					thi$.calcImageConteinerSize();
					thi$.ctor(thi$.cfg, true);
				}, 
				
				/**
				 * calcImageConteinerSize
				 * add to _super
				 * imageContainerWidth should have 2 more pixels cause of the flash player
				 */
				calcImageConteinerSize: function(){
					this._super();
					this.imageContainerWidth = this.imageWidth + 2;
				},
				
				/**
				 * changeImageSizes
				 * override (flash resize is different than img resize)
				 * @param css
				 */
				changeImageSizes: function(css){
					this._image.attr({
						'width': this.imageWidth, 
						'height': this.imageHeight
					});
					
					this._image.find('#' + this.cfg.id + '_flash_embed')
						.attr({
							'width': this.imageWidth,
							'height': this.imageHeight
						});
					this._imageContainer.css({
						'width': this.imageContainerWidth-2,
						'height': this.imageContainerHeight
					});
					
					if (css){
						this._view.find('#' + this.cfg.id + '_flashWrapper').css(css);
					}
					
				},
				
				/**
				 * convinietShortHand
				 * update _image shorthand (flash object) 
				 */
				convinietShortHand: function(){
					this._super();
					this._image = this._view.find('#' + this.cfg.id + '_flash');
				},
				
				/**
				 * applyThumbnail
				 * add flash thumbnail changes
				 */
				applyThumbnail: function(){
					this._super();
					var bgColor = this._imageContainer.css('background-color');
					this._imageContainer.css('background-color','transparent');
					this._content.css('background-color',bgColor).width(this._imageContainer.width()).height(this._imageContainer.height());
				}
				
				
			/* imageSoundViewSwf Object END */
				
			});
	
})();
////////////////////////////////////////
// SRC End --> t2k/component/imageViewer/ImageViewerViewSwf.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/keyboard/KeyboardConfig.js
////////////////////////////////////////
(function() {

// Keyboard constant values
    t2k.component.keyboard.KeyboardConfig = {
        classes: {
            keyboard: 'keyboard',
            selected: 'selected',
            hidden: 'hidden',
            none: 'none',
            shadow: 'shadow',
            key: 'key',
            keyWidth: 'keyWidth',
            tabsNav: 'tabs-nav',
            tabsNavItem: 'tabs-nav-item',
            over: 'over',
            pressed: 'pressed',
            disabled: 'disabled',
            generalKey: 'generalKey',
            verticalSpacer: 'verticalSpacer',
            verticalSpacerLines: 'verticalSpacerLines',
            close: 'close',
            mini: 'mini'
        }
    };
})();
////////////////////////////////////////
// SRC End --> t2k/component/keyboard/KeyboardConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/keyboard/KeyboardView.js
////////////////////////////////////////
(function () {

    var constants = t2k.component.keyboard.KeyboardConfig;

    var TEMPLATE = "\
        <div id='{{id}}' class='{{invokerClass}} keyboard {{fontLocale}}'>\
            <div id='{{id}}_content' class='keyboard_content'>\
                <ul class='tabs-nav'>\
                    {{#tabs}}\
                        <li class='tabs-nav-item {{classes}}' data-tab-name='{{name}}'>{{name}}</li>\
                    {{/tabs}}\
                </ul>\
                <div class='close' id='{{id}}_btn_close' >\
    			    <span class='mobile-touch-area'></span>\
                </div>\
                {{#tabs}}\
                    <div class='tab {{name}}'>\
                    {{#boxes}}\
                        <div class='box'>\
                        {{#lines}}\
                            <div class='line {{align}}'>\
                            {{#keys}}\
                                <div class='key {{#keyWidth}}keyWidth{{keyWidth}}{{/keyWidth}}' data-key-name='{{name}}'>\
                                		{{symbol}}\
                                </div>\
                            {{/keys}}\
                            </div>\
                        {{/lines}}\
                        </div>\
                    {{/boxes}}\
                    </div>\
                {{/tabs}}\
            </div>\
        </div>\
    ";
    /**
     * KeyboardView
     */
    t2k.component.keyboard.KeyboardView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.keyboard.KeyboardView',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            // Render the virtual keyboard
            this._super(override(config, config.preset.virtualKeys, {
                template:TEMPLATE //,parent: jQuery('.sequence_content_inner')
            }));

            this.triggerClickOnDocument();
            //this.lastScrollTopOffset = 0;
            this.initMembers();
            this.initKeyboardState();
            this.initVirtualKeyboard();
            this.initDeviceEvents();
            this.bindClickEvents();
            this.bindScrollEvent();

	        this._enableDraggableKeyboard(true);
        },

        /**
         * initMembers
         * Init members
         */
        initMembers:function () {
            this.id = this.cfg.id;
            this.preset = this.cfg.preset;
            this.keyboardState = {
                virtualKeys:{},
                charCodes2deviceKeys:{},
                charCodes2deviceSpecialKeys:{}
            };

	        this.$parent = this.cfg.$parent ? this.cfg.$parent : Perf.select('#' + this.cfg.parent_dom_id);
        },
        /**
         * initKeyboardState
         * Init keyboard state
         */
        initKeyboardState:function () {

            // Populate virtual keys
            var nonKeys = [
                constants.classes.none
            ].join('|');
            var preset = this.preset;
            var tabs = preset.virtualKeys.tabs;
            var tab;
            var boxes;
            var box;
            var lines;
            var line;
            var keys;
            var key;
            var keyName;
            var keyboardActions;

            for (tab in tabs) {
                boxes = tabs[tab].boxes;
                for (box in boxes) {
                    lines = boxes[box].lines;
                    for (line in lines) {
                        keys = lines[line].keys;
                        for (key in keys) {
                            keyName = keys[key].name;
                            keyboardActions = keys[key].keyboardActions;
                            if (keyName.search(nonKeys) === -1) { // Avoid populating non-keys
                                this.keyboardState.virtualKeys[keyName] = {
                                    name:keyName,
                                    enabled:true
                                };

                                if (keyboardActions) {
                                    this.keyboardState.virtualKeys[keyName].keyboardActions = keyboardActions;
                                }
                            }
                        }
                    }
                }
            }

            // local function to populate key to charCodesMap
            var populateStateCharCodes = function (keys) {
                var charCodesMap = {};
                var key;
                var charCodes;
                var i;
                for (keyName in keys) {
                    key = keys[keyName];
	                if(key['key_' + this.cfg.fontLocale]) {
		                keyName = key['key_' + this.cfg.fontLocale];
	                }

                    charCodes =  key.charCodes;
                    for (i in charCodes) {
                        // reference between virtual key state and device key state, if it exists
                        charCodesMap[charCodes[i]] = this.keyboardState.virtualKeys[keyName] ?
                            this.keyboardState.virtualKeys[keyName] :
                        {
                            name:keyName,
                            enabled:true
                        };
                    }
                }

                return charCodesMap;
            };

            override(this.keyboardState, {
                // Populate device keys - these are charCodes that are handled by this.keypress (and are different from this.keydown)
                charCodes2deviceKeys:populateStateCharCodes.call(this, this.preset.deviceKeys),
                // populate device special keys - these are charCodes that are handled by this.keydown (and are different from this.keypress)
                charCodes2deviceSpecialKeys:populateStateCharCodes.call(this, this.preset.deviceSpecialKeys)
            });
        },

        /**
         * initVirtualKeyboard
         * Init the keyboard view
         */
        initVirtualKeyboard:function () {
            // If there's one tab and one box - define the keyboard as mini
            if (this.preset.virtualKeys.tabs.length == 1
                && this.preset.virtualKeys.tabs[0].boxes.length == 1) {

                this._view.addClass(constants.classes.mini);
            }

	        delete this.preset;

            // Offset the keyboard according to offsetData
            domUtils.reparentOnceAndRepositionElement(this._view, this.cfg.offset);

            // init virtual keyboard keys
            this.initVirtualKeyboardKeys();

            // Init virtual keyboard events
            this.initVirtualKeyboardEvents();

            // set virtual keyboard size
            this.initVirtualKeyboardSize();

            // Select the first tab
            this.selectVirtualKeyboardTab(0);

            //fit keyboard horizontal position according to viewport width
            domUtils.horizontalFitToViewport(this._view);

            //fit keyboard vertically position according to viewport height
            domUtils.verticalFitToViewport_scrollDown(this._view, this.$parent);
        },

        /**
         * initVirtualKeyboardKeys
         * init virtual keyboard keys if needed
         */
        initVirtualKeyboardKeys:function () {
            // init 'none' keys
            var none = constants.classes.none;
	        Perf.select('.{0}[data-key-name={1}]'.format(constants.classes.key, none))
                .addClass(none)
                .text('!');

            // init larger keys
            var keyWidthClass = constants.classes.keyWidth;
            var keyWidth;
            var $key;

	        var setKeyWidth = function (key) {
		        $key = jQuery(key);
		        keyWidth = parseInt(/keyWidth([0-9])/ig.exec(key.className)[1]);
		        $key.width($key.width() * keyWidth - (keyWidth - 1));
		        $key = null;
	        };

	        var keys_arr = Perf.select('#{0} :regex(class,{1}[0-9])'.format(this.id, keyWidthClass));

	        for (var i = 0, len = keys_arr.length; i < len; i++) {
		        setKeyWidth(keys_arr[i]);
	        };

	        keys_arr = null;

        },

        /**
         * initVirtualKeyboardSize
         * Set the virtual keyboard size according to the widest tab and the tallest tab
         */
        initVirtualKeyboardSize:function () {
            // Hide the virtual keyboard
            this._view.css({
                visibility:'hidden'
            });

            // Loop tabs and get the max width and height
            var maxSize = {
                width:0,
                height:0
            };

            var thi$ = this;
            var keyboardWidthForCurrentTab;
            var keyboardHeightForCurrentTab;
            var tabNavItem;

	        for (var i = 0, len = this.tabsNavItems.length; i < len; i++) {
                tabNavItem = jQuery(this.tabsNavItems[i]);
                // Select the tab
                thi$.changeToTab(tabNavItem.attr('data-tab-name'));

                // Check max width / height
                keyboardWidthForCurrentTab = thi$._view.outerWidth(false);
                keyboardHeightForCurrentTab = thi$._view.outerHeight(false);

                if (keyboardWidthForCurrentTab > maxSize.width) maxSize.width = keyboardWidthForCurrentTab;
                if (keyboardHeightForCurrentTab > maxSize.height) maxSize.height = keyboardHeightForCurrentTab;

                var setTabNavItemWidth = function () {
                    // Set the width of the tab header
                    // Check normal and bold for max. width
                    var tab = tabNavItem[0], normal, bold;

                    tab.style.fontWeight = 'normal';
                    normal = tabNavItem.width();

                    tab.style.fontWeight = 'bold';
                    bold = tabNavItem.width();

                    tab.style.fontWeight = '';
                    tabNavItem.width(Math.max(normal, bold));
                };


                if (tabNavItem.hasClass(constants.classes.hidden)) {
                    // Show the tab header temporarily to calc width
                    tabNavItem.removeClass(constants.classes.hidden);
                    setTabNavItemWidth();
                    tabNavItem.addClass(constants.classes.hidden);
                } else { // tabNavItem.hasClass(constants.classes.hidden) == false
                    setTabNavItemWidth();
                }

		        tabNavItem = null;

            }

            // Remove the virtual keyboard opacity
	        if(!ENV.behaviors.isTablet) {
                this._view.css({'width' : maxSize.width, visibility:'visible'});
	        } else {
		        this._view.css(override(maxSize, {visibility:'visible'}));
	        }
        },

        /**
         * changeToTab
         * Change to the specified tabName
         */
        changeToTab:function (tabName) {
            // remove selected class from all keyboard elements
	        this._view.find('.' + constants.classes.selected).removeClass(constants.classes.selected);

	        Perf.select('[data-tab-name={0}]'.format(tabName), this._view)
                .addClass(constants.classes.selected);

	        Perf.select('.{0}'.format(tabName), this._view)
                .addClass(constants.classes.selected);
        },

        /**
         * hideTab
         * Hide the specified tab
         * @param {string} tabName
         */
        hideTab:function (tabName) {
	        Perf.select('[data-tab-name="{0}"]'.format(tabName), this._view)
                .addClass(constants.classes.hidden);
        },

        /**
         * showTab
         * Show the specified tab
         * @param {string} tabName
         */
        showTab:function (tabName) {
	        Perf.select('[data-tab-name="{0}"]'.format(tabName), this._view)
                .removeClass(constants.classes.hidden);
        },

	    bindKeyEvents:function (thi$){
		    this.keys = Perf.select('.{0}:not({1})'.format(constants.classes.key, constants.classes.none), this._view);

		    this.keys.unbind(); //unbind all prev events listeners

		    var key,
		        keyboardActions;

		    var onKeyMouseDown = function (e) {
			    thi$._enableDraggableKeyboard(false);

			    //Keeps the rest of the handlers from being executed and prevents the event from bubbling up the DOM tree.
			    e.stopImmediatePropagation();

			    // if the current status of this control is disable, do nothing
			    if (this.getAttribute("class").indexOf('disable') > -1) {
				    return;
			    }

			    Compat.addClass(this, constants.classes.pressed);

			    key = this.getAttribute('data-key-name');
			    thi$.cfg.onKeyboardPressed(key);

			    e.preventDefault();

			    if (!!ENV.behaviors.isTablet) {
				    e.stopPropagation();
				    return false;
			    }


		    };

		    var onKeyMouseOver = function (e) {
			    //Keeps the rest of the handlers from being executed and prevents the event from bubbling up the DOM tree.
			    e.stopImmediatePropagation();

			    Compat.addClass(this, constants.classes.over);
		    };

		    var onKeyMouseOut = function (e) {
			    //Keeps the rest of the handlers from being executed and prevents the event from bubbling up the DOM tree.
			    e.stopImmediatePropagation();

			    // if the current status of this control is disable, do nothing
			    if (this.getAttribute("class").indexOf('disable') > -1) {
				    return;
			    }

			    Compat.removeClass(this, constants.classes.over);
			    Compat.removeClass(this, constants.classes.pressed);
		    };

		    var onKeyMouseUp = function (e) {
			    //Keeps the rest of the handlers from being executed and prevents the event from bubbling up the DOM tree.
			    e.stopImmediatePropagation();
			    e.preventDefault();

			    key = this.getAttribute('data-key-name');

			    // execute keyboard actions if the key has any
			    keyboardActions = thi$.keyboardState.virtualKeys[key].keyboardActions;
			    if (keyboardActions) {
				    thi$.executeKeyboardActions(keyboardActions);
			    }

			    thi$._enableDraggableKeyboard(true);

			    if(!!ENV.behaviors.isTablet) {
				    e.stopPropagation();
				    return false;
			    }
		    };

		    function preventDefault(e) {
			    e.preventDefault();
			    e.stopImmediatePropagation();
			    e.stopPropagation();
			    return false;
		    }

		    function onKeyDoubleClick(e){
			    preventDefault(e);
		    }

		    var pressTimer;

		    if (ENV.behaviors.addKeyboardDelay) {
			    this.keys.mouseup(function (event) {
				    clearTimeout(pressTimer);
				    preventDefault(event);
			    }).mousedown(function (event) {
					    var event_this = this;
					    pressTimer = window.setTimeout(function () {
						    onKeyMouseDown.call(event_this, event);
						    onKeyMouseUp.call(event_this, event);
					    }, 50);
					    event.preventDefault();
				    })
				  .mouseover(onKeyMouseOver)
				  .mouseout(onKeyMouseOut)
				  .dblclick(onKeyDoubleClick);

		    } else {

			    this.keys.mousedown(onKeyMouseDown)
				    .mouseover(onKeyMouseOver)
				    .mouseout(onKeyMouseOut)
				    .mouseup(onKeyMouseUp)
				    .dblclick(onKeyDoubleClick);
		    }
	    },

	    initVirtualKeyboardEvents:function () {
		    var thi$ = this;

		    // Handle virtual keyboard tab events
		    this.tabsNavItems = Perf.select('.{0}'.format(constants.classes.tabsNavItem), this._view);
	        var onTabClick = function (e) {
		        e.stopImmediatePropagation();
		        e.stopPropagation();
		        thi$.changeToTab(e.currentTarget.getAttribute('data-tab-name'));
		        return false;
	        };
	        this.tabsNavItems.mousedown(onTabClick);

	        var fncPreventDefault = function (e) {
		        e.preventDefault();
		        return false;
	        };
	        this._view.dblclick(fncPreventDefault);

		    this._view.mousedown(fncPreventDefault);

            // Handle virtual keys events
		    this.bindKeyEvents(thi$);

		    // Handle close button events
	        this._btn_close.mousedown(thi$.cfg.onKeyboardClosed);
        },

        /**
         * executeKeyboardActions
         * execute the specified keyboard actions
         * @param keyboardActions {Object} Array of function names and their arguments
         */
        executeKeyboardActions:function (keyboardActions) {
            var thi$ = this;
            keyboardActions.forEach(function (keyboardAction) {
                thi$[keyboardAction.actionName].apply(thi$, keyboardAction.actionArgs);
            });
        },

        /**
         * selectVirtualKeyboardTab
         * Select a virtual keyboard tab, by the specified tab name / number
         * @param tab {String/Integer} Either the name of the tab, or the tab index
         */
        selectVirtualKeyboardTab:function (tab) {
            tab = (typeof tab === 'number') ? this.tabsNavItems.eq(tab) : this.tabsNavItems.filter('[data-tab-name="{0}"]'.format(tab));

            // Select tab
	        this.changeToTab(tab[0].getAttribute('data-tab-name'));
        },

        /**
         * enableKeys
         * enable the specified keys
         * @param keys - {String} Key Names (virtual and device), or 'all' / 'none' (for virtual keys only)
         * @param enable - {Boolean} enable or disable - default is true
         */
        enableKeys:function (keys, enable) {
            if (typeof enable === 'undefined') enable = true;
            var enabled = (keys != 'none');
            enabled = !enable ? enabled = !enabled : enabled;
            var key;
            var i;
            var charCode;
            var stateSection;
            if (keys === 'none' || keys === 'all') { // 'all' / 'none' - handle only virtual keys
                for (stateSection in this.keyboardState) {
                    for (key in this.keyboardState[stateSection]) {
                        this.keyboardState[stateSection][key].enabled = enabled;
                    }
                }

            } else {
                var keysSeparated = keys.split(',');
                keys = {};
                for (i in keysSeparated) {
                    keys[keysSeparated[i]] = {};
                }

                for (key in keys) {
                    if (this.keyboardState.virtualKeys[key]) {
                        this.keyboardState.virtualKeys[key].enabled = enabled;
                    }

                    // It's not a virtual key, look for it in the device keys
                    for (charCode in this.keyboardState.charCodes2deviceKeys) {
                        if (this.keyboardState.charCodes2deviceKeys[charCode].name === key) {
                            this.keyboardState.charCodes2deviceKeys[charCode].enabled = enabled;
                        }
                    }

                    // It's not a virtual key and device key, look for it in the device special keys
                    for (charCode in this.keyboardState.charCodes2deviceSpecialKeys) {
                        if (this.keyboardState.charCodes2deviceSpecialKeys[charCode].name === key) {
                            this.keyboardState.charCodes2deviceSpecialKeys[charCode].enabled = enabled;
                        }
                    }
                }
            }
            //disable comma sign, when auto comma is on
            if(this.cfg.autoComma){
               !!this.keyboardState.virtualKeys['comma'] && (this.keyboardState.virtualKeys['comma'].enabled = false);
            }

            // handle virtual keys view
            for (key in this.keyboardState.virtualKeys) {
                jQuery(".{0}[data-key-name='{1}']".format(constants.classes.key, key), this._view)
                    .toggleClass(
                    constants.classes.disabled,
                    !this.keyboardState.virtualKeys[key].enabled
                );
            }
        },

        /**
         * disableKeys
         * disable the specified keys
         * @param keys - {String} Key Names (virtual and device), or 'all' / 'none' (for virtual keys only)
         */
        disableKeys:function (keys) {
            this.enableKeys(keys, false);
        },

        /**
         * resetKeyboardStyle
         * reset keyboard press and over classes
         */
        resetKeyboardStyle:function () {
            this._view.find('.pressed').removeClass('pressed');
            this._view.find('.over').removeClass('over');
        },

        /**
         * selectKeys
         * select the specified keys
         * @param keys - {String} Virtual keys names
         */
        selectKeys:function (keys) {
            var keyDivs = jQuery('.{0}'.format(constants.classes.key), this._view);

            keyDivs
                .removeClass(constants.classes.selected);

            if (keys !== 'none') {
                keys = keys.replace(',', '|');
                keyDivs
                    .filter('[data-key-name={0}]'.format(keys))
                    .addClass(constants.classes.selected);
            }
        },

        /**
         * initDeviceEvents
         * Init keyboard device events
         */
        initDeviceEvents:function () {
            var thi$ = this;

            // We need to handle control keys like enter and del
			var onKeyDown = function (e) {
				if(!!ENV.behaviors.isTablet) {
					e.preventDefault();
					e.stopPropagation();
				}
				var charCode = e.which;

				// Check if a special key was pressed. If not we handle key press in this.onKeyPress
				var specialKey = thi$.keyboardState.charCodes2deviceSpecialKeys[charCode];
				if (specialKey) {
					if (specialKey.enabled) {
						thi$.cfg.onKeyboardPressed(specialKey.name);
                        
                        //defalut backspace event is to go "back" on browser. need to prevent when clicked from mathfield
                        if(specialKey.name == "backspace" ){
                            e.preventDefault();
                        }
					} else { // !specialKey || !specialKey.enabled
						e.preventDefault();
					}
					e.preventDefault();
					e.stopPropagation();
					return false;
				}

				if (!!ENV.behaviors.isTablet) {
					return false;
				}
			};
            this.onKeyDown = onKeyDown;
	        onKeyDown = null;

	        // define onKeyPress handler - store in this to be able to unbind it later
	        var onKeyPress = function (e) {
		        if(!!ENV.behaviors.isTablet) {
			        e.preventDefault();
			        e.stopPropagation();
		        }

		        // get the key char code
		        var charCode = e.which;

		        // enable key stroke only if it's in the map and not disabled
		        var deviceKey = thi$.keyboardState.charCodes2deviceKeys[charCode];
		        if (deviceKey && deviceKey.enabled) {
			        thi$.cfg.onKeyboardPressed(deviceKey.name);
		        }
		        return false;
	        };
	        this.onKeyPress = onKeyPress;
	        onKeyPress = null;


	        this.listenToKeystrokes(true);
        },

        _enableDraggableKeyboard:function (enable) {


	        if (!!$.pep) { //using pep library

		        var thi$ = this;
		        var fncPepStop = function (event) {
			        thi$._view && thi$._view.trigger('pep.stop');
		        };

		        if (!enable) {
			        this._view.unbind('mouseup', fncPepStop);
			        if (window.parent && window.parent.document) {
				        jQuery(window.parent.document).unbind('mouseup doubleclick', fncPepStop);

				        if (window.parent.parent && window.parent.parent.document) {
					        jQuery(window.parent.parent.document).unbind('mouseup doubleclick', fncPepStop);
				        }
			        }

			        $.pep.unbind(this._view);
		        } else {
			        this._view.pep({constrainTo:'parent', useCSSTranslation:false, startThreshold:[15, 15],
				        allowDragEventPropagation:false, stopEvents:'pep.stop'});

			        this._view.bind('mouseup doubleclick', fncPepStop);

			        if (window.parent && window.parent.document) {
				        jQuery(window.parent.document).bind('mouseup doubleclick', fncPepStop);

				        if (window.parent.parent && window.parent.parent.document) {
					        jQuery(window.parent.parent.document).bind('mouseup doubleclick', fncPepStop);
				        }
			        }
		        }

	        } else {
		        if (!enable) { //pep library doesn't exist use jQuery UI
			        this._view.is('.ui-draggable') && this._view.draggable("destroy");
		        } else {
			        this._view.draggable();
		        }
	        }

        },

        /**
         * listenToKeystrokes
         * Listen to keyboard strokes
         * @param bListen {Boolean} Listen or not
         */
        listenToKeystrokes:function (bListen) {
	        if (bListen) {
		        // Register keypress event
                this.cfg.target[0].addEventListener('keypress', this.onKeyPress);
		        this.cfg.target[0].addEventListener('keydown', this.onKeyDown);

	        } else { //!bListen
                if (this.onKeyPress) {
	                this.cfg.target[0].removeEventListener('keypress', this.onKeyPress);
	                this.cfg.target[0].removeEventListener('keydown', this.onKeyDown);
		        }
	        }
        },
        /**
         * show
         * show the keyboard
         * @param newOffset the new offset to place the keyboard
         */
        show:function (newOffset) {
            var thi$ = this;
            this.triggerClickOnDocument();

            if (!!this.detachedView && (this._view.parent().length == 0)) {
                //attach keyboard back to DOM
	            this.detachedView.appendTo(this.cfg.parent);
	            delete this.detachedView;
	            this.detachedView = null;

                this.cfg.offset = newOffset;
                // Offset the keyboard according to offsetData
	            domUtils.reparentOnceAndRepositionElement(this._view, newOffset);
                //fit keyboard horizontal position according to viewport width
                domUtils.horizontalFitToViewport(this._view);
                //fit keyboard vertically position according to viewport height
                domUtils.verticalFitToViewport_scrollDown(this._view, this.$parent);

	            // Listen to key strokes
                this.listenToKeystrokes(true);
                this.bindClickEvents();
	            this.bindScrollEvent();
	            this.bindKeyEvents(thi$);

	            this._enableDraggableKeyboard(true);
            }
        },


        bindScrollEvent:function () {
            domUtils.registerToScroll(this._view, this);
        },

        unbindScrollEvent:function () {
            domUtils.unRegisterToScroll(this._view, this);
        },

        bindClickEvents:function () {
            var thi$ = this;

	        if (this.cfg.useMathfieldKBHack || !!ENV.behaviors.useMathfieldKBHack) {
		        if (!window._hack_close_mf_keyboard) {
			        window._hack_close_mf_keyboard = [];
		        }
		        window._hack_close_mf_keyboard.push(thi$.cfg.onKeyboardClosed);
	        }

	        var triggerOnKeyboardClosed = function (e) {
		        if (!!jQuery(e.srcElement).parents('.keyboard').length) {
			        e.stopPropagation();
			        return false;
		        } else if (!!thi$._view.parent().length && !thi$._view.hasClass(constants.classes.hidden)) {
			        thi$.cfg.onKeyboardClosed();
		        }
	        };

	        this.cfg.target.one('mousedown', triggerOnKeyboardClosed);

            //bind iframe documents
            jQuery('iframe', document).contents().one('mousedown', triggerOnKeyboardClosed);

	        var parent_elem = document.getElementById(thi$.cfg.parent_dom_id);
	        var fncListenToClick = jQuery.proxy(this.eventStopPropagation, this);

	        if (!!parent_elem) {
		        parent_elem.removeEventListener('mousedown', fncListenToClick);
		        parent_elem.addEventListener('mousedown', fncListenToClick);
	        } else {
		        if (!!this.cfg.$parent && !!this.cfg.$parent.length) {
			        this.cfg.$parent[0].removeEventListener('mousedown', fncListenToClick);
			        this.cfg.$parent[0].addEventListener('mousedown', fncListenToClick);
		        }
	        }

	        parent_elem = null; fncListenToClick = null;  this_elem = null;
        },

        unbindClickEvents:function () {
	        var this_elem = document.getElementById(this.cfg.id);
	        !!this_elem && this_elem.removeEventListener('mousedown', this.eventStopPropagation);

	        var parent_elem = document.getElementById(this.cfg.parent_dom_id);
	        !!parent_elem && parent_elem.removeEventListener('mousedown', this.eventStopPropagation);
        },


        eventStopPropagation:function (event) {
	        event.stopImmediatePropagation();
            event.stopPropagation();
	        return false;
        },



        /**
         * triggerClickOnDocument
         * will trigger the mousedown event on document
         we need it in order to avoid the case of parralel open keyboards , so whenever we open a new keyboard
         we want to simulate a mousedown event to close the last one
         *
         */

        triggerClickOnDocument:function () {
            this.cfg.target.trigger('mousedown');
        },

        scrollHandler:function (event) {
            var thi$ = event.data.ref,
            delta = thi$.lastScrollTopOffset - this.scrollTop;

            thi$.lastScrollTopOffset = this.scrollTop;
            var offsetObj = {
	            top:thi$._view.offset().top + delta,
	            left:thi$._view.offset().left
            };

            thi$._view.offset(offsetObj);
        },
        /**
         * hide
         * hide the keyboard
         */
        hide:function () {
            // Add hidden class
	        //this._view.addClass(constants.classes.hidden);
	        this.unbindClickEvents();
	        this.unbindScrollEvent();
	        this.keys.unbind();

	        // UnListen to key strokes
	        this.listenToKeystrokes(false);
	        this._enableDraggableKeyboard(false);

	        this.detachedView = this._view.detach();
        },

	    reset : function() {
		    this.listenToKeystrokes(false);
		    this.keys.unbind();
		    delete this.preset;
		    delete this.keyboardState;
	    },

        /**
         * destroy
         * Destroy the keyboard
         */
        dispose:function () {
            this.reset();
	        delete this.keys;
	        delete this.detachedView;

	        this._super();
        }
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/keyboard/KeyboardView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/keyboard/KeyboardAndroidView.js
////////////////////////////////////////
(function () {

	/**
     * KeyboardView
     */
    t2k.component.keyboard.KeyboardAndroidView = t2k.component.BaseComponentView.subClass({
    	name:'t2k.component.keyboard.KeyboardAndroidView',
        //the hash beatwin kebord to mathfield 
        innerHash:{
            "32":"none",
            "small":"small",
            "20":"caps",
            "46":"del",
            "40":"arrowDown",
            "39":"arrowRight",
            "38":"arrowUp",
            "37":"arrowLeft",
//            "13":"enter",
            "08":"backspace",
            "a":"smallA",
            "b":"smallB",
            "c":"smallC",
            "d":"smallD",
            "e":"smallE",
            "f":"smallF",
            "g":"smallG",
            "h":"smallH",
            "i":"smallI",
            "j":"smallJ",
            "k":"smallK",
            "l":"smallL",
            "m":"smallM",
            "n":"smallN",
            "o":"smallO",
            "p":"smallP",
            "q":"smallQ",
            "r":"smallR",
            "s":"smallS",
            "t":"smallT",
            "u":"smallU",
            "v":"smallV",
            "w":"smallW",
            "x":"smallX",
            "y":"smallY",
            "z":"smallZ",
            "A":"capitalA",
            "B":"capitalB",
            "C":"capitalC",
            "D":"capitalD",
            "E":"capitalE",
            "F":"capitalF",
            "G":"capitalG",
            "H":"capitalH",
            "I":"capitalI",
            "J":"capitalJ",
            "K":"capitalK",
            "L":"capitalL",
            "M":"capitalM",
            "N":"capitalN",
            "O":"capitalO",
            "P":"capitalP",
            "Q":"capitalQ",
            "R":"capitalR",
            "S":"capitalS",
            "T":"capitalT",
            "U":"capitalU",
            "V":"capitalV",
            "W":"capitalW",
            "X":"capitalX",
            "Y":"capitalY",
            "Z":"capitalZ",
            "0":"zero",
            "1":"one",
            "2":"two",
            "3":"three",
            "4":"four",
            "5":"five",
            "6":"six",
            "7":"seven",
            "8":"eight",
            "9":"nine"
        },
    	/**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
        	this.editableContrainer = {};
        	var self = this;
            self.cfg = config;
            self.currentInput = config.parent.find(".mathField").find(".editMobile");
            config.parent.find(".mathField").on("click",function(e){
                var inputx = $(this).find(".editMobile");
                var divStatus = $("<div>").attr("id","divStatus");
                if($(this).find("#divStatus").length == 0){
                    $(this).append(divStatus);
                }
                inputx.on("focus",function(){
                  $(this).parent().find("#divStatus").text("focus");
                });
                inputx.on("blur",function(){
                   $(this).parent().find("#divStatus").text("blur");
                });
                inputx.focus();

            })
            self.editableContrainer = $(this);
            self.initVirtualKeyboardEvents(self);
            setTimeout(0,self.currentInput.focus);

        	
        },
        /**
         * initMembers
         * Init members
         */
        initMembers:function () {},
        /**
         * initKeyboardState
         * Init keyboard state
         */
        initKeyboardState:function () {},
        /**
         * initVirtualKeyboard
         * Init the keyboard view
         */
        initVirtualKeyboard:function () {},
        /**
         * initVirtualKeyboardKeys
         * init virtual keyboard keys if needed
         */
        initVirtualKeyboardKeys:function () {},
        /**
         * initVirtualKeyboardSize
         * Set the virtual keyboard size according to the widest tab and the tallest tab
         */
        initVirtualKeyboardSize:function () {},
        /**
         * changeToTab
         * Change to the specified tabName
         */
        changeToTab:function (tabName) {},
        /**
         * hideTab
         * Hide the specified tab
         * @param {string} tabName
         */
        hideTab:function (tabName) {},
        /**
         * showTab
         * Show the specified tab
         * @param {string} tabName
         */
        showTab:function (tabName) {},
        sortHash: function(keyCode){

        },
        caseMethod : {
                //backspace was click
                "0":function(self){return self.innerHash["08"];},
                "2":function(inputVal,self){
                    //use the innerhash object
                    inputVal = inputVal.substr(1);
                    return self.innerHash[inputVal];
                },
                "3":function(inputVal){
                    //remove the z char and send the value
                    return inputVal.substr(1);
                }
        },
        /**
         * initVirtualKeyboardEvents
         * Init the virtual keyboard events
         */
        initVirtualKeyboardEvents:function (self) {
        	//need to cjange to keyup event
        	//thi$ = self;

        	self.currentInput.on('keyup',$.proxy(function(e){
        		
        		
                
                var inputValLength, charHash, inputVal = e.currentTarget.value;

                inputValLength = inputVal.length > 2 ? 3 : inputVal.length;

                if(typeof self.caseMethod[inputValLength] == "function"){
                    //use the config object to defined what to write 
                    charHash = self.caseMethod[inputValLength](inputVal,self);
                    //sending the right value to the mathfield object
                    self.cfg.onKeyboardPressed(charHash);
                }
                //reValue the input with z char - the z char is needed for detecting backspase
                self.currentInput.val("z");
                
        	},this)); 
        },
        /**
         * executeKeyboardActions
         * execute the specified keyboard actions
         * @param keyboardActions {Object} Array of function names and their arguments
         */
        executeKeyboardActions:function (keyboardActions) {},

        /**
         * selectVirtualKeyboardTab
         * Select a virtual keyboard tab, by the specified tab name / number
         * @param tab {String/Integer} Either the name of the tab, or the tab index
         */
        selectVirtualKeyboardTab:function (tab) {
            //todo: Send choose tab event to keyboard

        },
        /**
         * enableKeys
         * enable the specified keys
         * @param keys - {String} Key Names (virtual and device), or 'all' / 'none' (for virtual keys only)
         * @param enable - {Boolean} enable or disable - default is true
         */
        enableKeys:function (keys, enable) {
        	
        },
        /**
         * disableKeys
         * disable the specified keys
         * @param keys - {String} Key Names (virtual and device), or 'all' / 'none' (for virtual keys only)
         */
        disableKeys:function (keys) {
        	
        },
        /**
         * resetKeyboardStyle
         * reset keyboard press and over classes
         */
        resetKeyboardStyle:function () {
        	//todo: fire event resetKeyboard
        },
        /**
         * selectKeys
         * select the specified keys
         * @param keys - {String} Virtual keys names
         */
        selectKeys:function (keys) {},
        /**
         * initDeviceEvents
         * Init keyboard device events
         */
        initDeviceEvents:function () {},
        /**
         * listenToKeystrokes
         * Listen to keyboard strokes
         * @param bListen {Boolean} Listen or not
         */
        listenToKeystrokes:function (bListen) {},
        /**
         * show
         * show the keyboard
         * @param newOffset the new offset to place the keyboard
         */
        show:function (newOffset) {
        	//todo:fire event show
        },

        bindScrollEvent:function () {
        },

        unbindScrollEvent:function () {
        },

        bindClickEvents:function () {},
        unbindClickEvents:function () {
        	//editableContrainer.off();
        },
        listenToClick:function (event) {
        },
         /**
         * triggerClickOnDocument
         * will trigger the click event on documetn
         we need it in order to avoid the case of parralel open keyboards , so whenever we open a new keyboard
         we want to simulate a click event to close the last one
         *
         */

        triggerClickOnDocument:function () {},
        scrollHandler:function (event) {},
        /**
         * hide
         * hide the keyboard
         */
        hide:function () {
        	//todo: fire event hide
        },
        /**
         * destroy
         * Destroy the keyboard
         */
        destroy:function () {
        	editableContrainer.off();
        }
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/keyboard/KeyboardAndroidView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/keyboard/Keyboard.js
////////////////////////////////////////
(function() {

    t2k.component.keyboard.Keyboard = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.keyboard.Keyboard',

        ctor: function(config) {
            this._super(config);

            //selecte the right keyboard normal or android
            //todo: need to repalce with useExternalKeyboard
           if( !! ENV.behaviors.useExternalMediaPlayer && !ENV.behaviors.overrideMathNativeKeyboard){
                this.view = this.createNewView(t2k.component.keyboard.KeyboardAndroidView, config);
            }else{
                this.view = this.createNewView(t2k.component.keyboard.KeyboardView, config);
            }

        },

        enableKeys : function(keys, enable) {
        	this.resetKeyboardStyle();
            this.view.enableKeys(keys, enable);
        },

        disableKeys : function(keys) {
        	this.resetKeyboardStyle();
            this.view.disableKeys(keys);
        },

        selectKeys : function(keys) {
            this.view.selectKeys(keys);
        },

        show: function(newOffset) {
            this.view.show(newOffset);
        },

        hide: function() {
            this.view.hide();
        },

	    dispose: function() {
            this.view.dispose();
        },

	    reset: function() {
			this.view.reset();
	    },
        
        resetKeyboardStyle : function(){
        	this.view.resetKeyboardStyle();
        }
    });
})();

////////////////////////////////////////
// SRC End --> t2k/component/keyboard/Keyboard.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerConfig.js
////////////////////////////////////////
(function(){
// Media Player constant values
t2k.component.mediaPlayer.MediaPlayerViewConstants = { 
		mediaFormat : {
			mp3 : {
                type: 'audio',
                isVideo: false,
                className: 'MediaPlayerViewAudio'
			},
			mp4 : {
                type: 'htmlVideo',
                isVideo : true,
                className: 'MediaPlayerViewVideo',
                minimumReadableFactor: 0.7
			},
			avi : {
                type: 'htmlVideo',
                isVideo : true,
                className: 'MediaPlayerViewFlashVideo',
                minimumReadableFactor: 0.7
			},
			swf : {
                type: 'flashVideo',
                isVideo : true,
                className: 'MediaPlayerViewFlashVideo',
                minimumReadableFactor: 0.9
			},
			flv : {
                type: 'flashVideo',
                isVideo : true,
                className: 'MediaPlayerViewFlashVideo',
                minimumReadableFactor: 0.95
			}
		},
        numReductionSteps: 3,
        absoluteMinimum: {
			width: 400,
			height: 300
		},
        absoluteThumbnailSize: {
            width: 168,
            height: 126
        },
        maxSizeFactor : 0.8,
        maxAudioWidth: 350,
        classes: {
            player: 'player',
            navigation: 'player_navigation',
			hidden: 'hidden',
            hideCursor: 'hideCursor',
            pressed: 'pressed',
            play: 'play',
            pause: 'pause',
            stop: 'stop',
            fullscreen: 'fullscreen',
            fullscreenExit: 'fullscreenExit',
            thumbnail: 'thumbnail'
        },
		blowup: {
			selector: 'mediaPlayerBlowup',
			parentSelector: 'body',
			exitKeycode: 27 // escape key code
		},
		reductionStates: {
			REGULAR: 0,
			BIG_THUMBNAIL: 1,
			ABSOLUTE_THUMBNAIL: 2
		},
		blowupStates: {
			EXIT: 0,
			OPTIMUM: 1,
			FULL_SCREEN: 2
		},
		controlPanel: {
			minTimelineWidth : 150,
			timeSectionWidthShowHours : 48,
			timeSectionWidthHideHours : 31,
			timeSectionSeparatorWidth : 4,
            hideTimeout: 20
		},
        animation: {
            speed: 300,
            effect: 'blind',
            stateFeedbackSpeed: 600,
            fullscreenFeedbackFadeSpeed: 3000
        }
		
};
})();
////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayer.js
////////////////////////////////////////
(function() {
	var constants = {
			mediaFormat : t2k.component.mediaPlayer.MediaPlayerViewConstants.mediaFormat
	};
    t2k.component.mediaPlayer.MediaPlayer = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.mediaPlayer.MediaPlayer',

        ctor: function(config) {
            // Delegate
            this._super(config);

            // a flag to indicate if we deal with flash content now
            this.isFlashMedia = false;

            this.cfg.originalSrc = this.cfg.src;
            
            // init media player component parameters
            this.analyzeParams();
            
            // encode src ( ' ' = %20 etc.. )
            if (!this.cfg.dummyMode){
            	this.cfg.src = encodeURI(this.cfg.src);
            }
            
            this.cfg.reductionStep = 0;

            // Init the view according the media type (video/audio etc).
            if(this.cfg.type === 'soundButton') {
                this.view = this.createNewView(t2k.component.mediaPlayer.MediaPlayerViewSoundButton, this.cfg);
            } else { // this.cfg.type !== 'soundButton'
                this.view = this.createNewView(t2k.component.mediaPlayer[this.cfg.mediaFormat.className], this.cfg);
            }
        },
        
        /**
         * analyzeParams
         */
        analyzeParams : function(){
        	// get a xml from config
			var xml = jQuery(this.cfg.data);
			// save src in local variable
			var srcPath = this.cfg.src || xml.attr('src');
			var src = AbsPath(srcPath);

            override(this.cfg, {
                src: src,
                fileExtension: src.substring(src.lastIndexOf('.') + 1),
                type: xml.attr('type') || this.cfg.type,
                width: parseInt(xml.attr('width')),
                height: parseInt(xml.attr('height')),
                reductionStep: parseInt(xml.attr('reductionStep')),
                autoplay: this.cfg.autoplay ? this.cfg.autoplay : ((xml.attr('auto_play') === 'true') ? true : false)
            });

            this.cfg.mediaFormat = constants.mediaFormat[this.cfg.fileExtension.toLowerCase()];
        },

        /**
		 * reduce
		 */
		reduce : function(val){
			var reductionValue = val ? val : 1;
			this.cfg.reductionStep += reductionValue;
			this.view.reduce(this.cfg);
			this.writeCompiled('reduction', this.cfg.reductionStep);
		},
		
		/**
		 * setEnabled
         * Enable/Disable this component view
		 * @param active - {Boolean} True for active, false otherwise.
		 */
		setEnabled : function(active){
			this._super(active);
			this.view.setEnabled(active);
		},

        /**
         * setMyState
         * Set media player state
         * @param state - {jQuery} State xml
         */
        setMyState : function(state){
            this.view.setMyState(state);
        },

        /**
         * setMyState
         * Set media player state
         * @param state - {jQuery} State xml
         */
        addMyState : function(){
            return this.view.addMyState();
        },
        
        bindEvent : function(event, host, callback, one, unbind){
        	this.view.bindEvent(event, host, callback, one, unbind);
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewHtmlPlayer.js
////////////////////////////////////////

(function() {

/*
 * MediaPlayerViewHtmlPlayer
 * build HTML5 video/audio player, fire media events to init class
 */
t2k.component.mediaPlayer.MediaPlayerViewHtmlPlayer = function(view){

    /** The class' name (for debugging purpose). */
    this.name = 't2k.component.mediaPlayer.MediaPlayerViewHtmlPlayer';
    
    var thi$ = this ;
    
    var video = view.video;
    if ( !video && (view._mediaPlayer[0].localName === "video") ) {
        video = view._mediaPlayer;
    }

    var media = video || view._mediaPlayer;
    

	var timeToSetOnMetadata = 0 ;
	var hasMetadataLoaded = false ;
    
	// call player private function init()
	init();

    function setMediaSrc() {
    	
        // We need to change the src with setTimeout because of a bug in Chrome.
        // Check out http://stackoverflow.com/questions/4694519/how-do-i-change-the-src-of-an-html5-video-via-javascript-without-either-crashing

		setTimeout(function() {
			video.attr( 'src', view.cfg.src ) ;
		}, 10);

    }

    /**
	 * init
	 * init media player
	 */
	function init(){
		
		// We never want the default HTML5 controls and autoplay
		// media.attr('controls', false);
        media.attr('autoplay', false);

        // Set the media src

	    if (video){
            if(view.cfg.setSrcAtStart){
                video.attr( 'src', view.cfg.src ) ;


            }else{

                globalEvents.add({
                    fnc: function(){
                        video.attr( 'src', view.cfg.src ) ;
                    }
                })
            }
	    }
//        video && setMediaSrc();
        // bind events
        
        // media loading progress event
		media.bind('click', function(event){
			event.preventDefault();
		});
		
        // media loading progress event
		media.bind('progress', function(event){
            view.onMediaLoadingProgress();
		});

		// media playing progress event
		media.bind('timeupdate',function(event){
            view.onTimeupdate(event.target.currentTime);
		});

		// start load media event
		media.bind('loadstart', function(event){
            view.onLoadstart();
		});		
		
		// media metadata (duration, videoWidth, videoHeight...) loaded event
		media.bind('loadedmetadata', function(event){
            var loadedMetadataParams = {
                duration: event.target.duration
            };
			
			if ('videoHeight' in event.target) {
				jQuery.extend(loadedMetadataParams, {
					videoHeight: event.target.videoHeight,
					videoWidth: event.target.videoWidth
				});
			}
			
			hasMetadataLoaded = true ;
			
			if( timeToSetOnMetadata ) {
				thi$.setCurrentTime( timeToSetOnMetadata ) ;
			}
			
			// change flag to true to indicate that metadata is available
			view.onLoadedMetadata(loadedMetadataParams);
		});
		
		// media data loaded event
		media.bind('loadeddata', function(event){
            view.onPlayerReady();
		});
		 
		// media pause event
		media.bind('pause', function(event){
            view.onPause();
		});
		
		// media play event
		media.bind('play', function(event){
            view.onPlay();
		});
		
		// media playing ended event
		media.bind('ended', function(event){
            view.onEnd();
		});

		// media playing error event
		media.bind('error', function(event){
            // media playback failed - show a message saying why
            var msg = '';
            var error = event.target.error;
            switch (error.code) {
                case error.MEDIA_ERR_ABORTED:
                    msg = 'You aborted the video playback.';
                    break;
                case error.MEDIA_ERR_NETWORK:
                    msg = 'A network error caused the video download to fail part-way.';
                    break;
                case error.MEDIA_ERR_DECODE:
                    msg = 'The video playback was aborted due to a corruption problem or because the video used features your browser did not support.';
                    break;
                case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                    msg = 'The video could not be loaded, either because the server or network failed or because the format is not supported.';
                    break;
                default:
                    msg = 'An unknown error occurred.';
                    break;
            }

            view.onError('{0}\n{1}'.format(msg, media.attr('src')));
        });
    };
	/**
	 * MediaPlayerViewHtmlPlayer class public methods
	 */

    /**
     * play
     * play media
     * @returns
     */
    this.play = function(){
        mediaManager.setMedia(media[0], true);
        mediaManager.play();
    };

    /**
     * pause
     * pause media
     * @returns
     */
    this.pause = function(){
        if (media[0] === mediaManager.currentItem) {
            mediaManager.pause();
        }
    };

    /**
     * stop
     * stop media
     * @returns
     */
    this.stop = function(){
        this.pause();
        this.setCurrentTime(0);
    };

    /**
     * playFrom
     * play media from some point (currentTime) on timeline
     * @param time
     * @returns
     */
    this.playFrom = function(time){
        this.setCurrentTime(time);
        this.play();
    };

    /**
     * isPaused
     * check if a media is paused now
     * @returns
     */
    this.isPaused = function(){
        return media[0].paused;
    };

    /**
     * setCurrentTime
     * set current time on timeline
     * @param time
     * @returns
     */
    this.setCurrentTime = function(time){
    	
    	if( hasMetadataLoaded ) {
    		try {
    			media[0].currentTime = time;
    		} catch (e) {
    			/*          When you set this property, the media play head moves to the new location.
            An INVALID_STATE_ERR DOM exception is raised if there is no selected media resource when you set this property.
            An INDEX_SIZE_ERR DOM exception is raised if the specified time is not within the start and end times.*/
    			media[0].currentTime = 0;
    		}
    	} else {
    		timeToSetOnMetadata = time ;
    	}
    	
    };

    /**
     * getCurrentTime
     * @returns
     */
    this.getCurrentTime = function(){
        return media[0].currentTime;
    };
};
})();

////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewHtmlPlayer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewControlPanelTimeline.js
////////////////////////////////////////
(function() {

/**
 * MediaPlayerViewControlPanelTimeline
 * object to manage timeline functionality
 */

// save reference to this class for global scope
t2k.component.mediaPlayer.MediaPlayerViewControlPanelTimeline = t2k.core.View.subClass({
			
    /** The class' name (for debugging purpose). */
    name : 't2k.component.mediaPlayer.MediaPlayerViewControlPanelTimeline',

    /**
     * @constructor
     * @see superclass documentation
     */
    ctor : function(config) {
        this._super(override(config, { template : "" })); // Mustache template is in MediaPlayerViewControlPanel
        this.initMembers();
    },

    /**
     * init members
     */
    initMembers: function() {
        jQuery.extend(this, {
            // timeline range - px/sec
            range: 0
        });
    }, // End of initMembers

    /**
     * setup timeline view
     * @param dynamicControlsDimensionsParams
     */
    setup : function(dynamicControlsDimensionsParams) {

    	var mediaPlayerView = this.cfg.mediaPlayerView;

        // init members
        this._controlPanel = mediaPlayerView.controlPanel._controlPanel;
        this._timeline = mediaPlayerView.controlPanel._timeline;
        this._timelineTooltip = mediaPlayerView.controlPanel._timelineTooltip;
        this._timelineTooltipProgress = mediaPlayerView.controlPanel._timelineTooltipProgress;
        this._timelineTooltipSeparator = mediaPlayerView.controlPanel._timelineTooltipSeparator;
        this._timelineTooltipTotalTime = mediaPlayerView.controlPanel._timelineTooltipTotalTime;
        this._progressBar = mediaPlayerView.controlPanel._progressBar;
        this._mediaSlider = mediaPlayerView.controlPanel._mediaSlider;
        this._timelineBackground = mediaPlayerView.controlPanel._timelineBackground;
        this.dynamicControlsDimensionsParams = dynamicControlsDimensionsParams;
        this.timelineWidth = dynamicControlsDimensionsParams.timelineWidth;
        this._timeline
        	.css({
                width : dynamicControlsDimensionsParams.timelineWidth,
                minWidth : dynamicControlsDimensionsParams.timelineWidth
            });

        // calculate timeline range value
        this.range = dynamicControlsDimensionsParams.timelineWidth / dynamicControlsDimensionsParams.duration;

        // progress bar shows video / audio progress on timeline
        this._progressBar
            .css({
                maxWidth : dynamicControlsDimensionsParams.timelineWidth
            });

        // init timeline tooltip events
        this.initTimelineTooltipEvents();

        // init media slider events
        this.initMediaSliderEvents();

        // Set half timeline tooltip width for tooltip positioning
        this.halfTimelineTooltipWidth = this._timelineTooltip.outerWidth(true) / 2;
    },
    /**
     * initTimelineTooltipEvents
     * init timeline tooltip show on timeline mouse move
     */
    initTimelineTooltipEvents : function() {
        var thi$ = this;
        var mediaPlayerView = this.cfg.mediaPlayerView;

        this.offsetX = 0;

        // Hide the timeline tooltip if the mouse enters it
        this._timelineTooltip.mouseenter(function() {
            thi$.hideTimelineTooltip();
        });

        // Track mouse moves inside timeline
        // We're using setTimeout to improve performence
        this._timeline
            
             // handle timeline clicks
            .mousedown(function(event) {
            	
                if (event.target.id == thi$._timeline[0].id
                    || event.target.id == thi$._progressBar[0].id
                    || event.target.id == thi$._timelineBackground[0].id){
                	
                	thi$.offsetX = thi$.getPageX(event) - thi$._timeline.offset().left;
                    var secsEllapsed = thi$.offsetX / thi$.range;
                    mediaPlayerView.setCurrentTime(secsEllapsed);
                }
            });
            

    },

    /**
     * hideTimelineTooltip
     * Hide the timeline tooltip
     */
    hideTimelineTooltip : function() {
        this._timelineTooltip.css({
            display: 'none'
        });
    },

    /**
     * onMouseStop
     * This code captures the mouse position and adjusts the timeline tooltip position
     */
    onMouseStop : function() {
    	clearTimeout(this.onMouseStopThread);
    	
    	
    	if (this.mousemoveEventTarget != this._timelineTooltip[0]) {
            // Keep offsetX in timeline bounds
            if (this.offsetX < 0) {
                this.offsetX = 0;
            }
            else if (this.offsetX > this.timelineWidth) {
                this.offsetX = this.timelineWidth;
            }

            // set new time and move timeline tooltip
            
            this.newCurrentTime = this.dynamicControlsDimensionsParams.duration * this.offsetX / this.dynamicControlsDimensionsParams.timelineWidth;
            


            // Drag media slider if mouse is down
            if(this.mediaSliderMouseDown) {
                     this._mediaSlider.css({
                        left: this.offsetX
                    });
                     
            }
        }
    },

    /**
     * onMouseMove
     * Handle mouse move
     * @param event
     */
    onMouseMove : function(event) {
    	if(event.type == "touchmove"){
    		event.preventDefault();
    	}    	
    	
        var thi$ = this;
        this.offsetX = this.getPageX(event) - this._timeline.offset().left;
        this.mousemoveEventTarget = event.target;
        clearTimeout(this.onMouseStopThread);
        this.onMouseStopThread = setTimeout(function() {
            thi$.onMouseStop();
        }, 4);
    },
    
    getPageX:function(event){
    	
    	var origEvent = event;
    	var pageX;
    	
    	if(origEvent.type == "touchstart" || origEvent.type == "touchend" || origEvent.type == "touchmove"){
    		origEvent = event.originalEvent;
    		pageX = origEvent.touches[origEvent.touches.length - 1].pageX;
    	}
    	else{
    		pageX = origEvent.pageX;
    	}
    	
    	
    	return pageX;
    },

    /**
     * initMediaSliderEvents
     * init media slider drag and drop
     */
    initMediaSliderEvents : function() {
        var thi$ = this;

        var onDocumentMouseMove = function(event) {
            thi$.onMouseMove(event);
        };
        

        
        var onDocumentMouseUp = function() {
            jQuery(document)
                .unbind('mousemove', onDocumentMouseMove)
                .unbind('mouseup', onDocumentMouseUp);

            jQuery(document.body)
                .removeClass('unselectable');
            thi$.onMouseStop();
            thi$.hideTimelineTooltip();
            thi$.onMediaSliderDragEnd();
        };

        
        this._mediaSlider
        		.mousedown(function(event) {
        		//temporarily the sliding on the tablet is disabled
        		if(event.type == "touchstart"){
        			return;
        		}	
                thi$.onMediaSliderDragStart();
                jQuery(document)
                    .mousemove(onDocumentMouseMove)
                    .mouseup(onDocumentMouseUp);
                jQuery(document.body)
                    .addClass('unselectable');
            });
    },

    /**
     * onMediaSliderDragStart
     * Pause the playback
     */
    onMediaSliderDragStart : function() {
        this.mediaSliderMouseDown = true;
        
        //this._mediaSlider.addClass('mobile');
        this._mediaSlider.addClass('drag');
        
        //this.dragStartOffset = this.offsetX;

        var mediaPlayerView = this.cfg.mediaPlayerView;
        
        // If the video was playing before drag we want to keep playing after it
        this.playAfterDrag = !mediaPlayerView.isPaused();

        // Pause player
        mediaPlayerView.pause();
    },

    /**
     * onMediaSliderDragEnd
     * Set media time and resume playback if necessary
     */
    onMediaSliderDragEnd : function() {
        if(this.mediaSliderMouseDown) {
            this.mediaSliderMouseDown = false;
            
            this._mediaSlider.removeClass('drag');


            var mediaPlayerView = this.cfg.mediaPlayerView;

            // Update video current time and play if necessary
        		mediaPlayerView.setCurrentTime(this.newCurrentTime);

            if(this.playAfterDrag){
                mediaPlayerView.play();
            }
            
        }
    },

    /**
     * progress
     * @param secs
     */
    progress : function(secs) {
        var shift = secs * this.range;
        this._progressBar && this._progressBar.css({
            minWidth : shift
        });

        this._mediaSlider && this._mediaSlider.css({
            left : shift
        });
        
    }
});  // End of t2k.component.mediaPlayer.MediaPlayerViewControlPanelTimeline

})();

////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewControlPanelTimeline.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewControlPanelIndicator.js
////////////////////////////////////////
(function() {
// class constants
var constants = {
    controlPanel: t2k.component.mediaPlayer.MediaPlayerViewConstants.controlPanel
};

/**
 * MediaPlayerViewControlPanelIndicator
 * an object to display total time and ellapsed time values
 */
// save reference to this class for global scope
t2k.component.mediaPlayer.MediaPlayerViewControlPanelIndicator = t2k.component.BaseComponentView.subClass({
			
    /** The class' name (for debugging purpose). */
    name : 't2k.component.mediaPlayer.ControlPanelIndicatorView',

    /**
     * @constructor
     * @see superclass documentation
     */
    ctor : function(config, type) {
    	this.type = type;
        this._super(override(config, { template : "" })); // Mustache template is in MediaPlayerViewControlPanel
        this.initMembers();
    },

    //Guy - no need to render here
    onViewRendered:function(){

    },

    /**
     * init members
     */
    initMembers: function() {
    }, // End of initMembers

    /**
     * setup
     * time indicator (total and ellapsed time) object
     * @param dynamicControlsDimensionsParams
     */
    setup : function(dynamicControlsDimensionsParams) {
    	var wholeIndicatorWidth = 0;
        var eachSectionIndicatorWidth = 0;
        var mediaPlayerView = this.cfg.mediaPlayerView;
        
        // init members
        
        if(this.type == "total"){
        	this._indicator = mediaPlayerView.controlPanel._indicatorTotalTime;
            this._indicator
        	.text(mediaPlayerView.controlPanel.totalDurationText);
        } else{
        	this._indicator = mediaPlayerView.controlPanel._indicatorProgress;
			var txtDuration = '00:00';
            if(dynamicControlsDimensionsParams){
				txtDuration = dynamicControlsDimensionsParams.duration >= 3600 ? '00:00:00' : '00:00';
			}
			this._indicator.text(txtDuration);
        }
    },

    /**
     * setMediaProgressTime
     * set a new value of progress time indicator
     * @param secs
     */
    setMediaProgressTime : function(secs) {
        if(this._indicator && this._indicator.length > 0){
            var mediaPlayerView = this.cfg.mediaPlayerView;
            var progressTime = mediaPlayerView.controlPanel.convertDurationToTimeFormat(secs);
            this._indicator.text(progressTime);
        }
    }
});  // End of t2k.component.mediaPlayer.MediaPlayerViewControlPanelIndicator

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewControlPanelIndicator.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewControlPanel.js
////////////////////////////////////////
(function() {

// class constants
var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

// Mustache template
var controlPanelTemplate = "\
	<div id='{{id}}_controlPanel'  onselectstart='return false' class='controlPanel unselectable'>\
		<div id='{{id}}_playButton' class='mpControlButton playButton {{playClass}}' title='{{playText}}'>\
			<div id='playState'>\
					?\
			</div>\
			<div id='pauseState'>\
					C\
			</div>\
			<span class='mobile-touch-area'></span>\
        </div>\
		<div id='{{id}}_indicatorProgress' class='indicator indicatorProgress'>{{indicatorTimeFormat}}</div>\
		<div id='{{id}}_timeline' class='newTimeline'>\
			<div id='{{id}}_timelineBackground' class='timelineBackground'></div>\
			<div id='{{id}}_progressBar' class='timelineNewProgressBar'></div>\
			<div id='{{id}}_mediaSlider' class='mediaSliderKnob'>\
			    <div id='{{id}}_mediaInternalSlider' class='mediaInternalSliderKnob'></div>\
			    <span class='mobile-touch-area'></span>\
			</div>\
	        <span class='mobile-touch-area'></span>\
		</div>\
		<div id='{{id}}_indicatorTotalTime' class='indicator indicatorTotalTime'>{{indicatorTimeFormat}}</div>\
		{{#isVideo}}\
			<div id='{{id}}_fullscreenButton' class='mpControlButton fullScreenButton' title='{{fullscreenText}}'>\
			 	A\
			    <span class='mobile-touch-area'></span>\
			</div>\
		{{/isVideo}}\
	</div>";
		

/**
 * MediaPlayerViewControlPanel
 */

// save reference to this class for global scope
t2k.component.mediaPlayer.MediaPlayerViewControlPanel = t2k.component.BaseComponentView.subClass({
			
    /** The class' name (for debugging purpose). */
    name : 't2k.component.mediaPlayer.MediaPlayerViewControlPanel',

    /**
     * @constructor
     * @see superclass documentation
     */
    ctor : function(config) {
        this._super(override(config, { template : "" })); // There's no mustache template for control panel, we build it using jQuery in build()
        this._initMembers();
    },
    
    onViewRendered : function(){
    	
    },

    /**
     * init members
     */
    _initMembers: function() {
        jQuery.extend(this, {
            cpWidth : 0,

            // a flag indicates if media slider is draged now
            isSlided : false,

            // timer id to manage controls panel behaiviour
            timerId : 0,

            // children
            indicatorProgress:new t2k.component.mediaPlayer.MediaPlayerViewControlPanelIndicator(this.cfg, "progress"),
            timeline : new t2k.component.mediaPlayer.MediaPlayerViewControlPanelTimeline(this.cfg),
            indicatorTotal : new t2k.component.mediaPlayer.MediaPlayerViewControlPanelIndicator(this.cfg, "total"),

            loadedMetadata: null,
            totalDurationText: null,
            showHours: false
        });
    }, // End of _initMembers

    /**
     * build
     * build controls panel
     * @param loadedMetadata
     */
    setLoadedMetaData : function(loadedMetadata) {
        this.loadedMetadata = loadedMetadata;
        this.showHours = loadedMetadata.duration >= 3600;
        this.totalDurationText = this.convertDurationToTimeFormat(loadedMetadata.duration);
    },
    /**
     * build
     * build controls panel
     */
    build : function() {
		var mediaPlayerView = this.cfg.mediaPlayerView;

		// Render the control panel and its controls
		this.render(
			mediaPlayerView._content,
			controlPanelTemplate,
			override(mediaPlayerView.cfg, {
                // isVideo use to show/hide full screen button. 
                // show this button only on video, and only behaviors permission.
                // (on tablets, behaviors probebly won't allow to show full screen)
				isVideo: mediaPlayerView.cfg.mediaFormat.isVideo && ENV.behaviors.allowMediaPlayerFullScreen ,
                playClass: constants.classes.play,
                pauseClass: constants.classes.pause,
                stopClass: constants.classes.stop,
                fullscreenClass: constants.classes.fullscreen,
				indicatorSeparator: '/',
				indicatorTimeFormat: this.showHours ? '00:00:00' : '00:00',
                playText: _i18n('mediaPlayer.tooltips.play'),
                stopText: _i18n('mediaPlayer.tooltips.stop'),
                fullscreenText: _i18n('mediaPlayer.tooltips.fullscreen')
			})
		);

        // Store members
		var id = mediaPlayerView.cfg.id;
        this._controlPanel = jQuery('#' + id + '_controlPanel');
        this._playButton = jQuery('#' + id + '_playButton');
        this._playButtonBorder = jQuery('#' + id + '_playButtonBorder');
        
        // timeline
        this._timeline = jQuery('#' + id + '_timeline');
        this._progressBar = jQuery('#' + id + '_progressBar');
        this._mediaSlider = jQuery('#' + id + '_mediaSlider');
        this._timelineTooltip = jQuery('#' + id + '_timelineTooltip');
        this._timelineTooltipProgress = jQuery('#' + id + '_timelineTooltipProgress');
        this._timelineTooltipSeparator = jQuery('#' + id + '_timelineTooltipSeparator');
        this._timelineTooltipTotalTime = jQuery('#' + id + '_timelineTooltipTotalTime');
        this._timelineBackground = jQuery('#' + id + '_timelineBackground');
        
        // indicators
        this._indicatorProgress = jQuery('#' + id + '_indicatorProgress');
        this._indicatorTotalTime = jQuery('#' + id + '_indicatorTotalTime');
        
        // full screen
        this._fullscreenButton = jQuery('#' + id + '_fullscreenButton');

        // Init control panel controls 
        this.initControls();

		// setup control panel events
		this.initEvents();

        // We're ready
		this.isReady = true;
    },

    /**
     * initControls
     * Resize control panel controls
     */
    initControls : function() {
    	var cp = this._controlPanel;
    	var mediaPlayerView = this.cfg.mediaPlayerView;
    	
    	// set control panel size / position
        this.cpWidth = mediaPlayerView._content.width();

        cp.css({
            width : this.cpWidth,
            maxWidth : this.cpWidth
        });
        
        // calculate dimensions of dynamic controls
        var dynamicControlsDimensionsParams = this.calculateDynamicControlsDimensions();

        // resize the control panel controls 
        this.resizeControls(dynamicControlsDimensionsParams);
    },
    /**
     * calculateDynamicControlsDimensions
     * calculate controls demensions according to priority
     * @returns {} timeline and indicator widths
     */
    calculateDynamicControlsDimensions : function() {
    	// calculate the total width off all static controls and spacing
    	var staticElementsWidth = this.calculateStaticElementsWidth();

    	// Change dynamic controls according to available width
        var timeSectionWidth = this._indicatorProgress.width();
        var twoTimeSectionsWidth = 2 * timeSectionWidth;        
        var indicatorWidth = twoTimeSectionsWidth;
        
        // Product want these hidden. I'm leaving them in the template because they may change their mind...
        this._timelineTooltipSeparator.hide();
        this._timelineTooltipTotalTime.hide();

        // timeline width will be what's left
        var timelineWidth = this.cpWidth - staticElementsWidth;

        // Create return object
        var dynamicControlsDimensionsParams = override(this.loadedMetadata, {
        	timelineWidth: timelineWidth,
        	indicatorWidth: indicatorWidth
        });

        return dynamicControlsDimensionsParams;
    },

    /**
     * calculateStaticElementsWidth
     * calculate width of all static elements
     * @return static elements width
     */
    calculateStaticElementsWidth : function() {
    	
    	var staticElementsWidth = Math.ceil(this._playButton.outerWidth(true)) 
    							+ Math.ceil(this._indicatorProgress.outerWidth(true))
    							+ Math.ceil(this._indicatorTotalTime.outerWidth(true))
    							+ Math.ceil(this._fullscreenButton.outerWidth(true));
        
        return Math.ceil(staticElementsWidth);
    },
    /**
     * resizeControls
     * resize controls on controls panel(buttons, timeline,indicator)
     * @param dynamicControlsDimensionsParams
     */
    resizeControls : function(dynamicControlsDimensionsParams) {
        var mediaPlayerView = this.cfg.mediaPlayerView;
            
        this.indicatorTotal.setup(dynamicControlsDimensionsParams);   
        this.indicatorProgress.setup(dynamicControlsDimensionsParams);   

        // build timeline
        this.timeline.setup(dynamicControlsDimensionsParams);
        
        // if the player is not ready to play disable controls panel
        //if(!mediaPlayerView.isPlayerReady){
        	//this._controlPanel.attr('disabled', 'disabled');
        //}
        
        // Update controls to current play state
        this.changeControls(mediaPlayerView.isPaused() ? 'play' : 'pause');
    },
    /**
     * initEvents
     * Init control panel events
     */
    initEvents : function() {
		var mediaPlayerView = this.cfg.mediaPlayerView;
		var thi$ = this;

	    mediaPlayerView._content
		    .bind(ENV.behaviors.mediaPlayerShowEvent, function (event) {
			    var $target = jQuery(event.target);
			    if($target.parents('.controlPanel').length) { //mouse is over control panel
				    event.preventDefault();
				    event.stopPropagation();
				    return false;
			    }
			    $target = null;

			    mediaPlayerView.isPaused() || thi$.show(true);
			    mediaPlayerView.isPaused() || thi$.waitAndHide();
		    });
        
        // init play button
        this._playButton
        	.click(function() {
        		mediaPlayerView.togglePlayPause();
        	});

        
        // init fullscreen button if needed
        var isVideo = mediaPlayerView.cfg.mediaFormat.isVideo;
        if(isVideo){
            // init fullscreen button
        	this._fullscreenButton
        		.click(function() {
                    mediaPlayerView.onFullScreen();
                });
        }

        // init all control buttons pressed state
        jQuery('.controlButton', this._controlPanel)
            .mousedown(function () {
                jQuery(this).addClass(constants.classes.pressed);
            })
            .mouseup(function () {
                jQuery(this).removeClass(constants.classes.pressed);
            });
    },

    /**
     * show
     * Shows the control panel
     * @param bShow boolean
     */
    show: function(bShow) {
        var thi$ = this;

        // start animation only if we're not already animating
        // Also, perform animation only if we can (hide when we're visible, show when we're hidden)
        if (this._controlPanel
            && !this.controlPanelAnimated
            && bShow !== this._controlPanel.is(':visible')) {

            var animationMethod;
            var classMethod;

            if(bShow) {
                animationMethod = 'fadeIn';
                classMethod = 'removeClass';
                this.waitAndHide();
            } else { // !bShow
                animationMethod = 'fadeOut';
                classMethod = 'addClass';
            }
            thi$.cfg.mediaPlayerView._content[classMethod](constants.classes.hideCursor);

            this.controlPanelAnimated = true;
			this._controlPanel[animationMethod](
                constants.animation.speed,
                function() {
                    thi$.controlPanelAnimated = false;
                });
		}
    },

    /**
     * waitAndHide
     * Wait a timeout and then hide cpanel
     * @param waitTimeout - {Integer} Time to wait before hiding in milliseconds
     */
    waitAndHide: function(waitTimeout) {
        var mediaPlayerView = this.cfg.mediaPlayerView;
        if(waitTimeout === undefined) {
            waitTimeout = constants.controlPanel.hideTimeout;
        }

        // hide cpanel only if media is a video
        if (mediaPlayerView.cfg.mediaFormat.isVideo &&
            !mediaPlayerView.isPaused()) {

            var thi$ = this;
            // run timer to hide controls panel on automatically
            clearTimeout(this.timerId);
            thi$.timerId = setTimeout(function() {
                clearTimeout(thi$.timerId);
                if (!this.isSlided && !mediaPlayerView.isPaused()) {
                    // TODO: demo - don't hide cpanel
                    thi$.show(false);
                }
            }, waitTimeout);
        } else { // Either it's
            clearTimeout(this.timerId);
        }
    },
    /**
     * remove
     * Removes the control panel
     */
    remove: function() {
        if (this._controlPanel) {
			this._controlPanel.remove();
		}
    },
	
    /**
     * changeControls
     * Changes controls (play or pause)
	 * @param state - 'play' / 'pause'
     */
    changeControls : function(state) {
        if (!this._playButton) return;

        this._playButton
            .attr('title', _i18n('mediaPlayer.tooltips.' + state));

        if(state === constants.classes.pause) {
            this._playButton
                .removeClass(constants.classes.play)
                .addClass(constants.classes.pause);
        } else {
            this._playButton
                .removeClass(constants.classes.pause)
                .addClass(constants.classes.play);
        }
	},

    /**
     * onPlay
     * Change controls (pause) and show control panel
     */
    onPlay : function() {
        this.changeControls('pause');
        //this.waitAndHide();
    },

    /**
     * onPause
     * Change controls (play) and show control panel
     */
    onPause : function() {
        this.changeControls('play');
        this.show(true);
    },

    /**
     * convertDurationToTimeFormat
     * convert duration in secounds to time format hh:mm:ss
     * @param secs - {Integer}
     * @returns {String}
     */
    convertDurationToTimeFormat : function(secs) {
        var hours = Math.floor(secs / (60 * 60));
        var divisor_for_minutes = secs % (60 * 60);
        var minutes = Math.floor(divisor_for_minutes / 60);

        var divisor_for_seconds = divisor_for_minutes % 60;
        var seconds = Math.floor(divisor_for_seconds);

        minutes = (minutes < 10) ? '0' + minutes : minutes;
        seconds = (seconds < 10) ? '0' + seconds : seconds;

        var timeFormatArr = [minutes, ':', seconds];

        if (this.showHours) {
            hours = (hours < 10) ? '0' + hours : hours;
            timeFormatArr.splice(0, 0, hours, ':');
        }
        return timeFormatArr.join('');
    }

});  // End of t2k.component.mediaPlayer.MediaPlayerViewControlPanel

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewControlPanel.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerView.js
////////////////////////////////////////
(function() {
/**
 * MediaPlayerView
 */

// class constants
var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

// save reference to this class for global scope
t2k.component.mediaPlayer.MediaPlayerView = t2k.component.BaseComponentView.subClass({
			
			/** The class' name (for debugging purpose). */
			name : 't2k.component.mediaPlayer.MediaPlayerView',

            /**
             * @constructor
             * @see superclass documentation
             */
            ctor : function(config) {

                this.initMembers();

                // render template with Mustache
                this._super(config);
                
                // set dummyMode as a member, 
                // to let the mediaPlayer's components know the dummyMode
                this.dummyMode = this.cfg.dummyMode;

                // reduction step
                // this.reductionStep = jQuery.isNaN(this.cfg.reductionStep) ? 0 : this.cfg.reductionStep;
                this.reductionStep = jQuery.isNumeric(this.cfg.reductionStep) ? this.cfg.reductionStep : 0 ;

                // calculate dimensions
                this.calcVisualSettings();

                // Create control panel
                this.controlPanel = new t2k.component.mediaPlayer.MediaPlayerViewControlPanel(override(config, {
                    mediaPlayerView: this
                }));

                // set the media size
				this.setSize();

                // get player reference
                this.player = this._initPlayer();
				
				// init UI behavior
				this.initUiBehavior();
				
				// on dummy mode - dispatch onRendered.
				// (dummy mode won't load meta data and won't call rendered)
				if (this.dummyMode){
					this.dispatchEvent('onRendered');
				}
            },

            /**
             * onViewRendered
             */
            onViewRendered: function (){
                
            },
            
            /**
             * checkWidth
             * check media player width vs container width
             * on delta, calc reduction steps, and set size
             */
            checkWidth : function(){
            	// get containter
            	this.container = this.cfg.container || this._view.parents('.task_container');
            	
            	// calc delta
            	var deltaWidth = this._view.width() - this.container.width();
            	
            	// on delta, calc reduction steps and set the new size
            	if (deltaWidth > 0){
            		var reductionStepSum = Math.ceil(deltaWidth / this.reductionStepSize);
    	        	this.reductionStep = reductionStepSum;
    	            this.setSize();
            	}
            },


            /**
             * initMembers
             * init class members
             */
            initMembers: function (){
                // class properties
                this.player = null;

                // a original size from the configuration
                this.originalSize = {
                    width: undefined,
                    height: undefined
                };

                this.size = {
                    width: undefined,
                    height: undefined
                };

                // a relation between width and height to decide if an image has landscape or portrait orientation
                this.aspectRatio;
                this.isLandscape;

                // a flag indicates if the player is ready to play media
                this.isPlayerReady = false;

                // to play when media was loaded or not
                this.playWhenLoaded = false;
            },
			
			/**
			 * _initPlayer
			 * init media player according to media content
			 * @returns t2k.component.mediaPlayer.MediaPlayerViewHtmlPlayer
			 */
			_initPlayer : function(){
				var anyPlayer = null;
				if(!this.cfg.isFlashMedia){
					// init and return generic (HTML5) media player
                    anyPlayer = new t2k.component.mediaPlayer.MediaPlayerViewHtmlPlayer(this);
				}else{
					// init and return FLASH media player
					// anyPlayer = new FlashPlayer For example!!!
				}
				return anyPlayer;
			},
			
			/**
			 * initUiBehavior
			 * init user interface behavior - events etc.
			 */
			initUiBehavior : function(){
				var thi$ = this;
				this._content.click(function(e) {
                    // Avoid clicks on control panel and decsendants
                    if(jQuery(e.target).closest('.controlPanel').length === 0){
                        thi$.onMediaClick();
                    }
				});
			},
			
            /****************************************************************************************************************************
             * Media player methods
             ****************************************************************************************************************************/

			play : function() {
				this.player.play();
			},

			stop : function() {
				this.player.stop();
			},

			pause : function() {
				this.player.pause();
			},

			playFrom : function(sec) {
				this.player.playFrom(sec);
			},

			setCurrentTime : function(time) {
				this.player.setCurrentTime(time);
			},
			
			getCurrentTime : function() {
				return this.player.getCurrentTime();
			},

			isPaused : function() {
				return this.player.isPaused();
			},

			/****************************************************************************************************************************
			 * player callback methods to listen to media player (HTML5 or Flash) events
			 ****************************************************************************************************************************/ 
			
			/**
			 * onLoadedMetadata
			 * onLoadedMetadata called from player implementation when
			 * loadedMetadata media player event fired
			 * 
			 * @param loadedMetadataParams
			 */
			onLoadedMetadata : function(loadedMetadata) {
                this.controlPanel.setLoadedMetaData(loadedMetadata);
                if(!this.blowupEnabled){
                    this.buildControls();
                }

                // after the media player video refactor, this on rendered is buggy.
                // this.dispatchEvent('onRendered');
			},
			
			/**
			 * onPlayerReady
			 * called from media player when all media data completely loaded 
			 */
			onPlayerReady : function(){
				this.isPlayerReady = true;
				// can play now
				if(this.playWhenLoaded) {
					this.play();
				}
			},
			
			/**
			 * onTimeupdate
			 * onTimeupdate called from player (HTML5 or Flash) on media playing progress
			 * @param currentTime
			 */
			onTimeupdate : function(currentTime) {
				this.controlPanel.timeline.progress(currentTime);
				this.controlPanel.indicatorProgress.setMediaProgressTime(currentTime);
			},
			
			/**
			 * onPlay 
			 * fired when media begins to play
			 */
			onPlay : function() {
                this._content
                    .addClass('play')
                    .removeClass('pause');
                this.controlPanel.onPlay();
                this.showStateSwitchFeedback();
			},
			
			/**
			 * onPause 
			 * onPause fired when media player is paused
			 */
			onPause : function() {
                this._content
                    .addClass('pause')
                    .removeClass('play');
                this.controlPanel.onPause();
                this.showStateSwitchFeedback();

			},
			
			/**
			 * onMediaLoadingProgress
			 * onMediaLoadingProgress fired on media resource loading progress
			 */
			onMediaLoadingProgress : function(){
				
			},

			/**
			 * onLoadstart
			 * onLoadstart fired on media loading start
			 */
			onLoadstart : function(){
				
			},
			
			/**
			 * onEnd
			 * onEnd fired when player finishes to play media
			 */
			onEnd : function(){
				this._mediaPlayer.trigger('pause');
			},
			/**
			 * onError
			 * onError fired when player has an error when loading media
             * @param msg
			 */
			onError : function(msg){
				console.error(msg);

				//remove video player onError
				if(this.video.length) {
					this.video.trigger('pause');
					this.video.remove();
				}

                this.dispatchEvent('cantReduce');
                this.dispatchEvent('onRendered');
			},
			/****************************************************************************************************************************
			 * player callback methods END!!!
			 ****************************************************************************************************************************/ 
			onMediaClick : function() {
				// overriden in derived classes
			},

            /**
             * setMyState
             * Return media player view to the specified state
             * @param state - {jQuery} State xml
             */
            setMyState : function(state){
                var currentTime = parseFloat(state.children('currentTime').text());
                this.setCurrentTime(currentTime);
            },

            /**
             * addMyState
             * Add media player state
             */
            addMyState : function(){
                var state = jQuery('<state/>')
                    .append(jQuery('<currentTime/>').text(this.getCurrentTime()));

                return state;
            },

            /**
             * reduce
             * reduce use to make a reduction
             */
            reduce : function() {
                // overridden in derived classes
            },

            /**
             * calcVisualSettings
             * calculate width / height, optimum size, thresholds
             */
            calcVisualSettings : function() {
                var t2kPlayer = Perf.select('.' + constants.classes.player);
                var navigation = Perf.select('.' + constants.classes.navigation);

                this.viewportSize = {
                    width: t2kPlayer.width(),
                    height: t2kPlayer.height()
                };

				var containerElement = this.cfg.container ? this.cfg.container : t2kPlayer ;
				
                this.pageContentSize = this.cfg.container ? {
                	 width: containerElement.width(),
                	 height: containerElement.height()
                 } : {
                    width: containerElement.width(),
                    height: containerElement.height() - navigation.height()
                };

                this.aspectRatio = this.cfg.width / this.cfg.height;
                this.isLandscape = this.aspectRatio > 1;

                // the rest is in derived classes
            },

            /**
             * setSize
             * set the media size according to the specified optimum size
             */
            setSize: function() {
                // overridden in derived classes
            },
			
            /**
             * rebuildControls
             * Rebuild control panel and title
             */
			rebuildControls : function() {
				this.removeControls();
				this.buildControls();
			},
			
            /**
             * removeControls
             * Remove control panel and title
             */
			removeControls : function() {
                this.controlPanel.remove();
                //this.title.remove();
			},
			
            /**
             * buildControls
             * Build control panel and title
             */
			buildControls : function() {
                this.controlPanel.build();
                //this.title.build();
				
				// Trigger timeupdate to set the slider and time indicator
				this._mediaPlayer.trigger('timeupdate');
			},
			
			
            /**
             * togglePlayPause
             * hook the 
             */
			togglePlayPause : function() {
				if (this.isPaused()) { // video is paused - play it
					this.play();
				} else { // video is playing - pause it
					this.pause();
				}
			},

            /**
             * showSwitchStateFeedback
             * Show the switch state feedback (play / pause)
             */
            showStateSwitchFeedback : function() {

                var thi$ = this;
                 $(this._stateSwitchFeedback)
                    .css({
                        display: 'block',
                        opacity: 0.8,
                        width: 68.9,
                        height: 58.5,
                        'margin-left': -34.45,
                        'margin-top': -29.25
                    })
                    .animate({
                        opacity: 0,
                        width: 106,
                        height: 90,
                        'margin-left': -53,
                        'margin-top': -45
                    }, constants.animation.stateFeedbackSpeed, function() {
                        thi$._stateSwitchFeedback.hide();
                    });
            },

        /**
         * setEnabled
         * Enable/Disable this component view
         * @param active - {Boolean} True for active, false otherwise.
         */
        setEnabled : function(active){
            if (active) {
                var autoplay = this.cfg.autoplay;
                var isVideo = this.cfg.mediaFormat.isVideo;
                if(isVideo) {
                    autoplay = autoplay && !this.blowupEnabled;
                }

                if(autoplay) {
                    if (this.isPlayerReady) {
                        this.play();
                    } else {
                        this.playWhenLoaded = true;
                    }
                }
            } else { // !active
                this.pause();
            }
        }

    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewVideo.js
////////////////////////////////////////
var timer = {};

(function() {
    /**
     * MediaPlayerViewVideo
     */

// class constants
    var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

// mustache template
//<iframe scrolling='no' frameborder=0 id='{{id}}_mediaPlayer' style='width:{{width}}px; height:{{height}}px'/>\
    var mediaTemplate = "\
    <div id='{{id}}' class='mediaPlayer htmlVideo'  onselectstart='return false'>\
		<div id='{{id}}_placeholderContainer' class='placeholderContainer'>\
			<div id='{{id}}_placeholder' class='placeholder'>\
				<div id='{{id}}_content' class='mediaContainer' style='width:{{width}}px; height:{{height}}px'>\
                    <video id='{{id}}_mediaPlayer' style='width:99%; height:99%'/>\
                    <div id='{{id}}_thumbnailBlowupIcon' class='thumbnailBlowupIcon'>\
                    </div>\
				</div>\
			</div>\
		</div>\
	</div>\
";

    var overlayTemplate = "\
	<div id='{{mediaPlayerBlowup}}' class='mediaPlayerBlowup {{hiddenClass}}'  onselectstart='return false'>\
		<div id='{{mediaPlayerBlowup}}_overlay' class='mediaPlayerBlowupOverlay'>\
		</div>\
		<div id='{{mediaPlayerBlowup}}_container' class='mediaPlayerBlowupContainer'>\
			<a id='{{mediaPlayerBlowup}}_close' class='mediaPlayerBlowupClose' title='Close'>\
			    <span class='mobile-touch-area'> > </span>\
			</a>\
			<div id='{{mediaPlayerBlowup}}_wrap' class='mediaPlayerBlowupWrap'>\
			</div>\
		</div>\
        <div id='{{mediaPlayerBlowup}}_fullscreenFeedback' class='fullscreenFeedback'>{{fullscreenFeedback}}\
        </div>\
	</div>\
";

    var playThumbnailMaskTemplate = "\
    <div id='{{id}}_playThumbnailMask' class='playThumbnailMask'>\
        <img class='play' src='assets/images/mediaPlayer/play.svg' />\
    </div>\
";

// save reference to this class for global scope
    t2k.component.mediaPlayer.MediaPlayerViewVideo = t2k.component.mediaPlayer.MediaPlayerView.subClass({

        /** The class' name (for debugging purpose). */
        name : 't2k.component.mediaPlayer.MediaPlayerViewVideo',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            
            // render template with Mustache
            this._super(override(config, { template : mediaTemplate }));
            this.video = this._mediaPlayer || $("<video style='width:98%; height:98%' />");

            // check mp width vs. containter width
            this.checkWidth();

            // this.$iframeBody = this._mediaPlayer.contents().find('body');
            // this.$iframeBody.css('margin', '0px').append(this.video);

	        this.dispatchEvent('onRendered');
        },

        /**
         * initOverlay
         * Init overlay when we need blowup
         */
        initOverlay: function() {
            // Add the overlay only once to the page, even on multiple videos
            var blowupParent = jQuery(constants.blowup.parentSelector),
                blowupId = constants.blowup.selector;
            if (blowupParent.children('#' + blowupId).length === 0) {
                jQuery(constants.blowup.parentSelector)
                    .append(Mustache.to_html(overlayTemplate, {
                    mediaPlayerBlowup: blowupId,
                    hiddenClass: constants.classes.hidden,
                    fullscreenFeedback: _i18n('mediaPlayer.messages.fullscreenExit')
                }));
            }

            // Store overlay sections
            this._blowup             = Perf.select('#' + blowupId);
            this._blowupOverlay      = Perf.select('#' + blowupId + '_overlay');
            this._blowupContainer    = Perf.select('#' + blowupId + '_container');
            this._blowupWrap         = Perf.select('#' + blowupId + '_wrap');
            this._fullscreenFeedback = Perf.select('#' + blowupId + '_fullscreenFeedback');

            // handle blowup close event
            var thi$ = this;
            Perf.select('#' + blowupId + '_close').click(function() {
                thi$.onCloseBlowup();
            });
        },

        /**
         * reduce method - reduce the video by the specified amount of refucton steps
         * @param numReductionSteps
         */
        reduce : function(numReductionSteps) {
            // if numReductionSteps was not properly supplied as a number, it will be 1
            numReductionSteps = (typeof numReductionSteps == 'number') ? numReductionSteps : 1;
            this.reductionStep += numReductionSteps;

            // set the new size
            this.setSize();

            this.dispatchEvent('onRendered');
        },

        /**
         * calcVisualSettings
         * calculate width / height, optimum size, thresholds
         */
        calcVisualSettings: function() {
            // calculate viewport dimensions
            this._super();

            // calculate optimum size
            this.calcOptimumSize();

            // Calculate minimum readable height. When the media player is reduced, this is threshold from which to start using blowup
            this.minimumReadableHeight = this.cfg.mediaFormat.minimumReadableFactor * this.optimumSize.height;

            // This is the height threshold from which we show the video as a thumbnail
            this.absoluteMinimumHeight = (this.aspectRatio > 1) ? (constants.absoluteMinimum.width / this.aspectRatio) : (constants.absoluteMinimum.height * this.aspectRatio);

            // fix minimumReadableHeight if it's smaller than absoluteMinimumHeight
            this.minimumReadableHeight < this.absoluteMinimumHeight ? this.minimumReadableHeight = this.absoluteMinimumHeight : jQuery.noop();

            // Calculate reduction step size
            var reductionHeightRange = this.optimumSize.height - this.absoluteMinimumHeight;
            this.reductionStepSize = reductionHeightRange / constants.numReductionSteps;
        },

        getReductionReport: function() {

            var percent =  this.size.width / this.cfg.width,
                belowRead = false,
                belowAbs = false
                ;

            return { percent: percent, belowRead: belowRead, belowAbs: belowAbs };
        },

        /**
         * calcOptimumSize
         * optimum size is either native dimensions, or 80% of the viewport if bigger (80% of the width or height)
         */
        calcOptimumSize: function () {
            // calculate maximum width and height according to viewport dimensions and take 80% from its value
            var maximum = (this.cfg.useMax || false) ? {
                width: this.pageContentSize.width,
                height: this.pageContentSize.height

            } : {
                width: this.pageContentSize.width * constants.maxSizeFactor,
                height: this.pageContentSize.height * constants.maxSizeFactor
            };

            var cfgSize = {
                width: this.cfg.width,
                height: this.cfg.height
            };

            this.optimumSize = this.fitRectangles(cfgSize, maximum);
        },

        /**
         * fitRectangles
         * Fit rectInner in rectOuter
         * @param rectInner {width, height}
         * @param rectOuter {width, height}
         * @return newInnerSize {width, height}
         */
        fitRectangles: function(rectInner, rectOuter) {
            // calculate scale ratios
            var ratioW = rectOuter.width / rectInner.width;
            var ratioH = rectOuter.height / rectInner.height;

            // We need to smaller ratio between the widths and heights ratios
            var selectedRatio = ratioW < ratioH ? ratioW : ratioH;

            // we don't have to scale if inner rect fits in the outer one
            if (selectedRatio > 1) {
                selectedRatio = 1;
            }


            // calculate our new video dimensions
            var newInnerRect = {
                width: rectInner.width * selectedRatio,
                height: rectInner.height * selectedRatio
            };

            if(constants.absoluteThumbnailSize.width > newInnerRect.width || constants.absoluteThumbnailSize.height > newInnerRect.height ){
                newInnerRect.width = constants.absoluteThumbnailSize.width;
                newInnerRect.height = constants.absoluteThumbnailSize.height;
            }
            return newInnerRect;
        },

        /**
         * setSize
         * set the media size according to the reduction and size
         */
        setSize: function() {
            // calculate the new size
            var newHeight = this.optimumSize.height - this.reductionStep * this.reductionStepSize;

	        if(newHeight < this.minimumReadableHeight) {
		        newHeight = this.minimumReadableHeight;
		        this.dispatchEvent('cantReduce');
	        }

            this.size = {
                width: newHeight * this.aspectRatio,
                height: newHeight
            };

            // Check: if the size is less than the size of its container
            if (this.container && ( this.size.width > this.container.width() ) ) {
                this.size.width = this.container.width();
                this.size.height = this.container.width()/this.aspectRatio;
            }
            // Check: if thumbnail
            if (this.size.width < constants.absoluteThumbnailSize.width) {
                // Prepare the thumbnail
                this.prepareThumbnail();
            }

            // Determine reduction state (regular / big thumbnail / thumbnail)
            this.reductionState = this.determineReductionState();

            // resize media player
            this._view.css(this.size);
            this._content.css(this.size);            

	        var self = this;

        },

        /**
         * prepareThumbnail
         * Prepare thumbnail for big thumbnail and absolute minimum thumbnail
         */
        prepareThumbnail : function() {
            // Set up thumbnail features
            if (this.reductionState === constants.reductionStates.ABSOLUTE_THUMBNAIL) {
                // Fit the optimum size in the absolute thumbnail size
                this.size = this.fitRectangles(this.optimumSize, constants.absoluteThumbnailSize);

                this.preparePlaceholder(constants.absoluteThumbnailSize);

                // position the video in the middle of the thumbnail
                this._placeholder.css({
                    top: Math.round((constants.absoluteThumbnailSize.height - this.size.height) / 2),
                    left: Math.round((constants.absoluteThumbnailSize.width - this.size.width) / 2)
                });
            } else { // (this.reductionState !== constants.reductionStates.ABSOLUTE_THUMBNAIL)
                this.preparePlaceholder(this.size);
            }

            // Create a play overlay over the thumbnail if doesn't exist already
            if (!this._playThumbnailMask) {
                var thi$ = this;
                var playThumbnailMask = jQuery(Mustache.to_html(playThumbnailMaskTemplate, {
                    id: this.cfg.id
                }))
                    .click(function() {
                        thi$.onMediaClick();
                    });

                this._placeholderContainer.append(playThumbnailMask);
                this._playThumbnailMask = jQuery('.playThumbnailMask', this._view);
            }
        },

        /**
         * preparePlaceholder
         * Prepare placeholder size and such
         * @param placeholderContainerSize
         */
        preparePlaceholder : function(placeholderContainerSize) {
            // Set placeholder its size
            this._placeholderContainer
                .css(placeholderContainerSize)
                .addClass(constants.classes.thumbnail);
            this._placeholder.css(this.size);
        },

        /**
         * onMediaClick
         * Either toggle play / pause or activate blowup
         */
        onMediaClick : function() {
            var now = Date.now();
            if (typeof this._mediaClickTime !== "number" || this._mediaClickTime + 250 < now) {
                this._mediaClickTime = now;
            }
            else return;

            if (this.blowupEnabled && !this.showingBlowup) {
                // Use the overlay to show the blowup
                this.showBlowup(constants.blowupStates.OPTIMUM);
            }
        },

        /**
         * onCloseBlowup
         * Either close blowup or return from full screen to opimum size blowup
         */
        onCloseBlowup : function() {
            if (this.returnFullScreenToState === constants.blowupStates.OPTIMUM) {
                this.showBlowup(constants.blowupStates.OPTIMUM);
            } else { // (this.returnFullScreenToState !== constants.blowupStates.OPTIMUM)
                this.exitBlowup();
            }
        },

        /**
         * showBlowup
         * Show or hide blowup according to specified state
         * @param state - blowup state
         */
        showBlowup : function(state) {
            this.currentBlowupState = state;
            switch (state) {
                case constants.blowupStates.FULL_SCREEN:
                    // store last state before full screen
                    this.returnFullScreenToState = this.showingBlowup ? constants.blowupStates.OPTIMUM : constants.blowupStates.EXIT;
                    this.startBlowup();

                    this._blowup.addClass(constants.classes.fullscreen);

                    // Animate fullscreen esc message
                    this._fullscreenFeedback
                        .show()
                        .css({opacity: .7})
                        .animate({
                            'opacity': 0
                        }, constants.animation.fullscreenFeedbackFadeSpeed, 'easeInExpo', function() {
                            jQuery(this).hide();
                        });

                    break;
                case constants.blowupStates.OPTIMUM:
                    this.startBlowup();
                    this._blowup.removeClass(constants.classes.fullscreen);
                    break;
                case constants.blowupStates.EXIT:
                    this._blowup.removeClass(constants.classes.fullscreen);
                    this.exitBlowup();
                    break;
            }
        },

        /**
         * startBlowup
         * Start blowup (optimum size or full screen)
         */
        startBlowup : function() {

            // if we need to create the blowup because it is now closed
            if (!this.showingBlowup) {
                this.showingBlowup = true;
                var thi$ = this;

                // init the blowup / fullscreen overlay
                this.initOverlay();

                // we need to hold this.blowupOnExitKeydown for when the blowup is exited
                if (!this.blowupOnExitKeydown) {
                    this.blowupOnExitKeydown = function(e) {
                        if (e.keyCode == constants.blowup.exitKeycode) { // 'escape' key
                            thi$.onCloseBlowup();
                        }
                    };
                }

                // append the media player to the blowup overlay
                jQuery('#' + constants.blowup.selector + '_wrap').append(this._content);

                // show the blowup
                jQuery('#' + constants.blowup.selector).removeClass(constants.classes.hidden);

	            //recalc new optimum size according to blowup size
	            this.cfg.useMax = true;
	            this.calcOptimumSize();

                // During blowup we show the optimum size
                this._content.css(this.optimumSize);

                // center the video in the overlay
                jQuery('#' + constants.blowup.selector + '_container').css(this.getCenterOffset(this.optimumSize, this.pageContentSize));

                // Hide thumbnail blowup icon if visible
                this._thumbnailBlowupIcon.addClass(constants.classes.hidden);

                jQuery('#' + constants.blowup.selector + '_close').click(function() {
                    thi$.onCloseBlowup();
                });

                // listen to escape keystrokes to close the blowup
                jQuery(document).bind('keydown', this.blowupOnExitKeydown);

                // Blowup auto starts the play
                this.play();

                // hide playThumbnailMask if exists
                if (this._playThumbnailMask) {
                    this._playThumbnailMask.hide();
                }
            }

            if (this.isFullScreenOn()) {
                // resize to viewport size
                this._content.css(this.viewportSize);

                // restyle blowup container
                jQuery('#' + constants.blowup.selector + '_container')
                .css({
                    top: 0,
                    left: 0,
                    padding: 0
                });
                jQuery('#' + constants.blowup.selector + '_close').addClass(constants.classes.fullscreen);


            } else { // !this.isFullScreenOn()
                // resize to optimum size
                this._content.css(this.optimumSize);
                jQuery('#' + constants.blowup.selector + '_close').removeClass(constants.classes.fullscreen);

                // handle mediaPlayer overlay close event
                jQuery('#mediaPlayerBlowup_overlay').click(function() {
                    thi$.onCloseBlowup();
                });
                // restyle blowup container
                jQuery('#' + constants.blowup.selector + '_container')
                    .css(jQuery.extend(this.getCenterOffset(this.optimumSize, this.pageContentSize), {
                    padding: ''
                }));

                // next time close blowup
                this.returnFullScreenToState = constants.blowupStates.EXIT;
            }

            // rebuild media player controls
            this.rebuildControls();
        },

        /**
         * exitBlowup
         * Exit blowup
         */
        exitBlowup : function() {
            this.currentBlowupState = constants.blowupStates.EXIT;
            this.showingBlowup = false;

            // save play state
            var wasPlaying = !this.isPaused();

            // return the media player to the placeholder
            this._placeholder.append(this._content);

            // Play if we were playing before and blowup is not enabled
            if (wasPlaying && !this.blowupEnabled) {
                this.play();
            }

            // Set the thumbnail size
            this._content.css(this.size);

            // Show the thumbnail blowup icon if we're in thumbnail
            this._thumbnailBlowupIcon.removeClass(constants.classes.hidden);

            // remove the overlay
            jQuery('#'+constants.blowup.selector).remove();


            // rebuild / remove controls in the thumbnail
            if (this.blowupEnabled) {
                this.removeControls();
            } else {
                this.rebuildControls();
            }

            // unlisten to escape keystrokes to close the blowup
            jQuery(document).unbind('keydown', this.blowupOnExitKeydown);

            // show playThumbnailMask if exists
            if (this._playThumbnailMask) {
                this._playThumbnailMask.show();
            }
        },

        /**
         * getCenterOffset
         * get center offset of size a in size b
         * @param sizeA
         * @param sizeB
         */
        getCenterOffset : function(sizeA, sizeB) {
            return {
                top:  Math.round((sizeB.height - sizeA.height) / 2),
                left: Math.round((sizeB.width - sizeA.width) / 2)
            }
        },

        /**
         * onLoadedMetadata
         * onLoadedMetadata called from player implementation when
         * loadedMetadata media player event fired
         * @param loadedMetadataParams
         */
        onLoadedMetadata : function(loadedMetadata) {
            
            var thi$ = this, 
                video = this.video.get(0);

            video.play();

            var getMetaData = function(){
                if (video.duration > 1){
                    clearTimeout(timer[thi$.cfg.id]);
                    video.pause();
                    loadedMetadata.duration = video.duration;
                    thi$.controlPanel.setLoadedMetaData(loadedMetadata);
	                thi$.controlPanel.build();
//                    thi$.dispatchEvent('onRendered');
                } else {
                    timer[thi$.cfg.id] = setTimeout(function(){
                        getMetaData();
                    }, 100);
                }
            }

            getMetaData();

            //   old code: this._super(loadedMetadata);

        },

        /**
         * onFullScreen
         * Toggle full screen mode
         */
        onFullScreen : function() {
            // Show blowup or exit blowup
            if (this.isFullScreenOn()) {
                this.onCloseBlowup();
                this.controlPanel._fullscreenButton.attr('title', _i18n('mediaPlayer.tooltips.fullscreen'));
            } else { // !this.isFullScreenOn()
                this.showBlowup(constants.blowupStates.FULL_SCREEN);
                this.controlPanel._fullscreenButton.attr('title', _i18n('mediaPlayer.tooltips.fullscreenExit'));
            }

        },

        /**
         * onEnd
         * Exit full screen if needed
         */
        onEnd : function() {
            this._super();

            if (this.isFullScreenOn()) {
                this.onCloseBlowup();
            }
        },

        /**
         * isFullScreenOn
         * Test if we're in fullscreen mode
         */
        isFullScreenOn : function() {
            return this.currentBlowupState === constants.blowupStates.FULL_SCREEN;
        },

        /**
         * determineReductionState
         * determine reduction state according to height
         */
        determineReductionState: function() {
            var reductionState;
            this.blowupEnabled = false;

            if (this.size.height >= this.minimumReadableHeight && this.size.height > this.absoluteMinimumHeight) {
                reductionState = constants.reductionStates.REGULAR;
                this.blowupEnabled = false;
            }
            else if (this.size.height > this.absoluteMinimumHeight) {
                reductionState = constants.reductionStates.BIG_THUMBNAIL;
            }
            else { //(this.size.height < this.absoluteMinimumHeight) {
                reductionState = constants.reductionStates.ABSOLUTE_THUMBNAIL;
                this.dispatchEvent('cantReduce');
            }

            return reductionState;
        }
    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewVideo.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewAudio.js
////////////////////////////////////////
(function() {
    /**
     * MediaPlayerViewAudio
     */

// class constants
    var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

// mustache template
    var template =
        "<div id='{{id}}' class='mediaPlayer audio'>\
            <div id='{{id}}_content' style='width: {{width}}px; height: {{height}}px;' class='mediaContainer pause'>\
                <audio id='{{id}}_mediaPlayer' src={{src}}/>\
                <div id='{{id}}_stateSwitchFeedback' class='stateSwitchFeedback'>\
                    <img class='feedback play' src='assets/images/mediaPlayer/play.svg' />\
                    <img class='feedback pause' src='assets/images/mediaPlayer/pause.svg' />\
                </div>\
            </div>\
        </div>";

// save reference to this class for global scope
    t2k.component.mediaPlayer.MediaPlayerViewAudio = t2k.component.mediaPlayer.MediaPlayerView.subClass({

        /** The class' name (for debugging purpose). */
        name : 't2k.component.mediaPlayer.MediaPlayerViewAudio',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            // render template with Mustache
            this._super(override(config, { 
            	template : template,
            	dummyMode : config.dummyMode
            	}));
            // check mp width vs. containter width
            this.checkWidth();
        },
        
        /**
         * initMembers
         * init class members
         */
        initMembers: function() {
            this._super();
        },

        /**
         * calcVisualSettings
         * calculate width / height, optimum size, thresholds
         */
        calcVisualSettings: function() {
            // calculate viewport dimensions
            this._super();

            // calculate optimum size
            this.calcOptimumSize();

            // This is the width threshold from which we show audio at a fixed size
            this.absoluteMinimumWidth = constants.absoluteMinimum.width;

            // Calculate reduction step size
            var reductionWidthRange = this.optimumSize.width - this.absoluteMinimumWidth;
            this.reductionStepSize = reductionWidthRange / constants.numReductionSteps;
        },

        getReductionReport: function() {

            var percent = this.size.width / this.cfg.width,
                belowRead = false,
                belowAbs = false
                ;

            return { percent: percent, belowRead: belowRead, belowAbs: belowAbs };
        },

        /**
         * calcOptimumSize
         * optimum size is either native dimensions, or 80% of the viewport if bigger (80% of the width)
         */
        calcOptimumSize: function () {
            // calculate maximum width and height according to viewport dimensions and take 80% from its value
            var maximumWidth = this.pageContentSize.width * constants.maxSizeFactor;

            // Make sure that maximum width is smaller than maximum
            if (maximumWidth > constants.maxAudioWidth) {
                maximumWidth = constants.maxAudioWidth;
            }

            this.optimumSize = {
                width: this.cfg.width < maximumWidth ? this.cfg.width : maximumWidth,
                height: this.cfg.height
            };
        },

        /**
         * reduce method - reduce the video by the specified amount of refucton steps
         * @param numReductionSteps
         */
        reduce : function(numReductionSteps) {
            // if numReductionSteps was not properly supplied as a number, it will be 1
            numReductionSteps = (typeof numReductionSteps == 'number') ? numReductionSteps : 1;
            this.reductionStep += numReductionSteps;

            // set the new size
            if (this.setSize()){
            	this.dispatchEvent('onRendered');
            }
        },

        /**
         * setSize
         * set the media size according to the reduction and size
         */
        setSize: function() {
            // calculate the new size
            var newWidth = this.optimumSize.width - this.reductionStep * this.reductionStepSize;
            
            if (newWidth < this.absoluteMinimumWidth){
            	this.dispatchEvent('cantReduce');
            	this.dispatchEvent('onRendered');
            	return false;
            }
            
            this.size = {
                width: newWidth,
                height: this.cfg.height
            };
             // Check: if the size is less than the size of its container
            if (this.container && ( this.size.width > this.container.width() ) ) {
                this.size.width = this.container.width();
                this.size.height = this.container.width()/this.aspectRatio;
            }       
            // Determine reduction state (regular / big thumbnail / thumbnail)
            this.reductionState = this.determineReductionState();

            // resize media player
            this._view.css(this.size);
            this._content.css(this.size);

            // rebuild controls
            if (this.isPlayerReady) {
                // rebuild controls
                this.rebuildControls();
            }
            
            return true;
        },

        /**
         * determineReductionState
         * determine reduction state according to height
         */
        determineReductionState: function() {
            var reductionState;

            if (this.size.width >= this.absoluteMinimumWidth) {
                reductionState = constants.reductionStates.REGULAR;
            }
            else { //(this.size.height < this.absoluteMinimumHeight) {
                reductionState = constants.reductionStates.ABSOLUTE_THUMBNAIL;
            }

            return reductionState;
        },

        /**
         * buildControls
         * Build control panel and title
         */
        buildControls : function() {
            this.controlPanel.build();
            //this.title.build();

            // Trigger timeupdate to set the slider and time indicator
            this._mediaPlayer.trigger('timeupdate');
        },

        /**
         * onMediaClick
         * Toggle play / pause
         */
        onMediaClick : function() {
            this.togglePlayPause();
        },

        /**
         * onLoadedMetadata
         * onLoadedMetadata called from player implementation when
         * loadedMetadata media player event fired
         * @param loadedMetadataParams
         */
        onLoadedMetadata : function(loadedMetadata) {
            this._super(loadedMetadata);
        }

    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewAudio.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mediaPlayer/MediaPlayerViewSoundButton.js
////////////////////////////////////////
(function() {
    /**
     * MediaPlayerViewAudio
     */

// class constants
    var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

// mustache template
    var template =
        "<div id='{{id}}' class='mediaPlayer soundButton'>\
            <div id='{{id}}_content' class='soundButton_content'>{{text}}\
                <audio src={{src}} id='{{id}}_soundButtonMedia' {{#loadResource}} src='{{src}}' {{/loadResource}} preload='none'/>\
            </div>\
            <span class='mobile-touch-area'></span>\
        </div>";

// save reference to this class for global scope
    t2k.component.mediaPlayer.MediaPlayerViewSoundButton = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name : 't2k.component.mediaPlayer.MediaPlayerViewSoundButton',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            // load resource only on dummyMode = false
            config.loadResource =  !config.dummyMode;

            // render template with Mustache
            this._super(override(config, {
                template : template
            }));

            // init members
            this.initMembers();

            // Init sound button events
            this.initEvents();

        },

        /**
         * initMembers
         * init class members
         */
        initMembers : function() {
            jQuery.extend(this, {
                playWhenLoaded: false,
                isPlayerReady: false
            });

            this.mobile_touch_area = this._view.children(".mobile-touch-area");
        },

        /**
         * initEvents
         * init sound button events
         */
        initEvents : function() {
            var thi$ = this;

            // div events
            this._view
                //.add(this._view.children(".mobile-touch-area"))
                .mousedown(function(e){
		            jQuery(document).trigger('mousedown');

		            thi$.togglePlayStop();
                    thi$._view.addClass('mouseDown');
                    e.stopPropagation();
                })
                .mouseup(function(e){
                    thi$._view.removeClass('mouseDown');
                    // e.stopPropagation();
                })

                /**
                 * Fire drag-n-drop events on mouse move.
                 * This is needed when the sound button is inside a draggable sub answer.
                 */
                .mousemove(function(event) {
                    if (thi$._view.hasClass('mouseDown')) {
                        var parent = thi$._view.parent().parent().parent();
	                    var eventParams = [{'pageY': event.pageY, 'pageX': event.pageX, 'screenX': event.screenX, 'screenY': event.screenY}];

                        if (ENV.behaviors.dragAndDropBehaviorTablets) {
                            parent.trigger('touchstart', eventParams).trigger('touchmove', eventParams);
                        }
                        else {
                            parent.trigger('mousedown', eventParams).trigger('mousemove', eventParams);
                        }
                    }
                })

                .mouseover(function(){
                    if(!thi$._view.hasClass('disabled')){
                        thi$._view.addClass('hover');
                    }
                })
                .mouseout(function(){
                    thi$._view.removeClass('hover');
                });

            /**
             * Any mouseup clears mouse down class.
             */
            $('body').mouseup(function(event){
                thi$._view.removeClass('mouseDown');
            });

            // audio events
            if( this._soundButtonMedia ) {
                this._soundButtonMedia
                    .bind('loadeddata', function(e){
                    thi$.isPlayerReady = true;
                    if (thi$.playWhenLoaded) {
                        thi$.play();
                    }
                })
                    .bind('ended', function(){
                        thi$.ended();
                    })
                    .bind('pause', function(){
                        thi$._soundButtonMedia.trigger('ended');
                    });
            } else {
                console.error( 'no ready sound button' ) ;
            }
        },

        /**
         * togglePlayStop
         * Play from beginning if stopped, Stop if playing
         */
        togglePlayStop : function() {
            var stopped = this._soundButtonMedia[0].paused;
            if(stopped) {
                this.play();
            } else { // playing
                EXT_SERVICES.get('stopAudio')();
                this.stop();
            }
        },

        /**
         * Play the sound button audio
         */
        play : function(IsPlayWhenLoaded) {

            var thi$ = this;

//             if(!this.isPlayerReady && this.isEnabled()){
//                 // try {
//                 //     jQuery.ajax({
//                 //         url: thi$._soundButtonMedia[0].src,
//                 //         success: function(result) {
//                 //             thi$.isPlayerReady = true;
//                 //             thi$.play();
//                 //         },
//                 //         error:function(response, q, t){
//                 //             console.error('MPVSB.js -> play -> ERROR-Message: ', response);
//                 //         }
//                 //     });


//                     //todo : remove element on stopping play or pause ?
// //                    var audio = document.createElement("audio");
// //                    audio.src = this._soundButtonMedia[0].src;
// //                    audio.play();
// //                    this.isPlayerReady = true;
// //                    this._view.addClass('playing');

//                 } catch(e){
//                     //console.error('e: ',e.typeName);
//                 };
//             }

            if (this.isEnabled()) {
                mediaManager.setMedia(this._soundButtonMedia[0].id);
                mediaManager.play();
                this._view.addClass('playing');
                EXT_SERVICES.get('playAudio')(thi$.cfg.originalSrc, thi$.stop, thi$);
            }
        },

        /**
         * stop
         * Stop the sound button audio
         * readyState 0 = HAVE_NOTHING - no information whether or not the audio/video is ready
         */
        stop:function () {
            if (this.isPlayerReady) {

                mediaManager.pause();

                if (this._soundButtonMedia[0].readyState > 0) {
                    this._soundButtonMedia[0].currentTime = 0;
                }

                this._view.removeClass('playing');
            }
        },

        /**
         * ended
         * calls on media ended. set currentTime and class
         * readyState 0 = HAVE_NOTHING - no information whether or not the audio/video is ready
         */
        ended : function(){
            if (this._soundButtonMedia[0].readyState > 0) {
                this._soundButtonMedia[0].pause();  // make sure it stopped.
                this._soundButtonMedia[0].currentTime = 0;
            }
            this._view.removeClass('playing');
        },

        /**
         * isStopped
         * Is the sound button stopped or not
         */
        isStopped : function() {
            return this._soundButtonMedia[0].paused;
        },

        /**
         * reduce
         * Sound button has no reduction
         */
        reduce : function() {
            this.dispatchEvent('cantReduce');
            this.dispatchEvent('onRendered');
        },

        setWidth : function(){
            // Do nothing
        },

        /**
         * onPlayerReady
         * called from media player when all media data completely loaded
         */
        onPlayerReady : function(){
            this.isPlayerReady = true;
            // can play now
        },

        /**
         * setMyState
         * Return media player view to the specified state
         * @param state - {jQuery} State xml
         */
        setMyState : function(state){
            // soundButton has no state
        },

        /**
         * addMyState
         * Add media player state
         */
        addMyState : function(){
            // soundButton has no state
        },

        /**
         * setEnabled
         * Enable/Disable this component view
         * @param active - {Boolean} True for active, false otherwise.
         */
        setEnabled : function(active){

            this._super(active);

            if(active && this.cfg.autoplay) {
                if (this.isPlayerReady) {
                    if (this.isStopped()) {
                        this.play();
                    }
                } else {
                    this.playWhenLoaded = true;
                }
            } else { // !active || !this.cfg.autoplay
                this.stop();
            }

            if (!active){
                this._view.addClass('disabled');
            } else {
                this._view.removeClass('disabled');
            }
        },

        bindEvent : function(event, host, callback, one, unbind){
            var element = (host == 'audio') ? this._soundButtonMedia : this._content;

            if (!!unbind){
                element.unbind(event);

                this.mobile_touch_area.unbind(event);

            } else {
                if (!!!one){
                    element.bind(event, callback);
                    this.mobile_touch_area.bind(event, callback);
                } else {
                    element.one(event, callback);
                    this.mobile_touch_area.one(event, callback);
                }
            }


        }

    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/mediaPlayer/MediaPlayerViewSoundButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/externalMediaPlayer/ExternalMediaPlayer.js
////////////////////////////////////////
(function() {

	// var constants = {
	// 		mediaFormat : t2k.component.mediaPlayer.MediaPlayerViewConstants.mediaFormat
	// };

    t2k.component.mediaPlayer.ExternalMediaPlayer = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.mediaPlayer.ExternalMediaPlayer',

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.type = $(this.cfg.data).attr('type') || this.cfg.type;
            var viewClass;
            
            // Init the view according the media type (video/audio etc).
            switch (this.type) {

	            case 'audio':
                case 'soundButton':
                    viewClass = t2k.component.mediaPlayer.ExternalMediaPlayerViewSoundButton;
                    break;
//
//                case 'audio':
//                    viewClass = t2k.component.mediaPlayer.ExternalMediaPlayerViewAudio;
//                    break;

                case 'video':
                    viewClass = t2k.component.mediaPlayer.ExternalMediaPlayerViewVideo;
                    break;


            };

            // create the view
            this.view = this.createNewView(viewClass, this.cfg);
        }	

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/externalMediaPlayer/ExternalMediaPlayer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/externalMediaPlayer/ExternalMediaPlayerViewVideo.js
////////////////////////////////////////
(function() {
/**
 * MediaPlayerView
 */

// class constants
var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

var template = "<div id='{{id}}' class='externalMediaPlayerVideo'></div>";

// save reference to this class for global scope
t2k.component.mediaPlayer.ExternalMediaPlayerViewVideo = t2k.component.BaseComponentView.subClass({
			
			/** The class' name (for debugging purpose). */
			name : 't2k.component.mediaPlayer.ExternalMediaPlayerViewVideo',

            /**
             * @constructor
             * @see superclass documentation
             */
            ctor : function(config) {

                var thi$ = this,
                    src = $(config.data).attr('src');

                // render template with Mustache
                this._super(override(config, { 
                    template : template,
                }));


                this._view.click(function(){
                    EXT_SERVICES.get('playMovie')(src);
                });
               
            }

    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/externalMediaPlayer/ExternalMediaPlayerViewVideo.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/externalMediaPlayer/ExternalMediaPlayerViewAudio.js
////////////////////////////////////////
(function() {
/**
 * MediaPlayerView
 */

// class constants
var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

var template = "<div id='{{id}}' class='externalMediaPlayerAudio'></div>";

// save reference to this class for global scope
t2k.component.mediaPlayer.ExternalMediaPlayerViewAudio = t2k.component.BaseComponentView.subClass({
			
			/** The class' name (for debugging purpose). */
			name : 't2k.component.mediaPlayer.ExternalMediaPlayerViewAudio',

            /**
             * @constructor
             * @see superclass documentation
             */
            ctor : function(config) {

                var thi$ = this,
                    src = $(config.data).attr('src');

                // render template with Mustache
                this._super(override(config, { 
                    template : template,
                }));


                this._view.click(function(){
                    EXT_SERVICES.get('playAudio')(src);
                });
               
            }

    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/externalMediaPlayer/ExternalMediaPlayerViewAudio.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/externalMediaPlayer/ExternalMediaPlayerViewSoundButton.js
////////////////////////////////////////
(function() {
/**
 * MediaPlayerView
 */
// class constants
var constants = t2k.component.mediaPlayer.MediaPlayerViewConstants;

var template = "<div id='{{id}}'><div id='{{id}}_content' class='ExternalMediaPlayerViewSoundButton' /></div>";

// save reference to this class for global scope
t2k.component.mediaPlayer.ExternalMediaPlayerViewSoundButton = t2k.component.BaseComponentView.subClass({
			
			/** The class' name (for debugging purpose). */
			name : 't2k.component.mediaPlayer.ExternalMediaPlayerViewSoundButton',

            /**
             * @constructor
             * @see superclass documentation
             */
            ctor : function(config) {

                var thi$ = this,
                    src = $(config.data).attr('src') || config.src ;

                // render template with Mustache
                this._super(override(config, { 
                    template : template
                }));

                this.mode = 'stop';

                this._content.click(function(){

                    if (thi$.mode == 'stop'){ // PLAY AUDIO
                        thi$.changeMode('play');
                        EXT_SERVICES.get('playAudio')(src, thi$.changeMode, thi$);
                    } else {                  // STOP AUDIO
                        EXT_SERVICES.get('stopAudio')();
                        // DEV
                        thi$.changeMode('stop');
                    }
                });
            },

            changeMode : function(mode){
                this.mode = mode ? mode : 'stop';
                this.setGui();
            },

            setGui : function(){
                if (this.mode == 'stop'){ // STOP
	                this._content.addClass('stop').removeClass('play');
                } else {                  // PLAY
	                this._content.addClass('play').removeClass('stop');
                }
            }

    });
})();
////////////////////////////////////////
// SRC End --> t2k/component/externalMediaPlayer/ExternalMediaPlayerViewSoundButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/modal/ModalView.js
////////////////////////////////////////
(function () {
            
    var TEMPLATE =
        "<div id='{{id}}' class='modal'>\
            <div id='{{id}}_modal_wrapper' class='modal_wrapper'>\
                <div id='{{id}}_content' class='modal_content'></div>\
                <div id='{{id}}_modal_close' class='modal_close'>$</div>\
            </div>\
        </div>";
	
    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template:TEMPLATE,
        layout:'inline'
    }; // End of defaultConfig.

    t2k.component.modal.ModalView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.modal.ModalView',

        /**
         * 2d0 - complete doc
         */
        ctor:function (config) {
            // Delegate.
        	var thi$ = this;
        	
            this._super(override(config, defaultConfig));
            
            this._view
                .css({
                    //Vertical Centering With CSS : Line-Height Method 
                    'line-height':(this.cfg.parent.height())+'px'
                })
                .click(function(e){
		            e.stopPropagation();
                    // close modal on click outside the content area only when the modal is not full screen mode
		            if (jQuery(e.target).hasClass('modal_close') ||
			            ((jQuery(e.target).parents().is(thi$._content) == false) &&
				          !thi$._view.hasClass('fullScreen') &&
				          !jQuery(e.target).hasClass('fullScreenButton'))) {
			            thi$.dispatchEvent('onClose');
		            }
		            return false;
                });

            // don't care
            this.dispatchEvent('onRendered');
        },

        show : function(isFullScreenOnly){
            var thi$ = this;
            //on fullScreen mode add class to the modal and set the close button the the top rigth corner
            if (isFullScreenOnly) {
                this._view.addClass('fullScreen');
            }
            
            this._content
                .css({'height':this._modal_wrapper.outerHeight()+10})
                .fadeTo('slow',1);
            this._modal_close.fadeTo('slow',1);
        	
        },

        close:function () {
            this._modal_close.removeAttr('style');
            this._content
                .removeAttr('style')
                .html('');
            this._view.hide();
        }
        
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/modal/ModalView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/modal/Modal.js
////////////////////////////////////////
(function() {

	t2k.component.modal.Modal = t2k.component.BaseComponent.subClass({

		/** The class' name (for debugging purpose). */
		name : 't2k.component.modal.Modal',

		ctor : function() {
			var thi$ = this;
			
			this._super(copy ({}, {onRendered : function(){}}));

			this.view = this.createNewView(t2k.component.modal.ModalView, {
				
				events : {
					onClose : function() {
						thi$.onClose();
					}
				},
				parent : ENV.playerContent.parent()
			});
		},
		
		show : function(config){
			
			this.view._view.css({'display':'inline-block'});
			this.config = config ;

			var thi$ = this;

			if (config.clonedContent) {
				// blowup is a cloned html
				this.view._content.append(config.clonedContent);
				this.view.show(isFullScreenOnly);

			} else {
				// blowup is a component
				this.modalContent = componentFactory.create(copy({}, {
					data 				: config.data,
					parent 				: this.view._content,
					isBlowup 			: true,
					dontEnableBlowup 	: true,
					container 			: this.view._view,
					onRendered 			: function(isFullScreenOnly){					
						config.state && thi$.modalContent.setState( config.state ) ;						
						thi$.modalContent && thi$.modalContent.setEnabled(true);
						thi$.view.show(isFullScreenOnly);
					}
				}));
			}
			
		},
		
		onClose: function() {
			
			var thi$ = this ;
			
			if( this.config.onClose ) {
				StateUtil.collectState( this.modalContent, function( state ) {
					thi$.close( state );
				} ) ;
			} else {
				this.close() ;
			}
			
		},

		close : function( state ) {
			
			this.view.close();			
			this.config.onClose && this.config.onClose( state ) ;
			
			this.modalContent = null ;
			this.config = null ;
		}

	});

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Private Functions.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/modal/Modal.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/BubbleView.js
////////////////////////////////////////
(function () {

    var TEMPLATE = "<div class='bubble' id='{{id}}'>\
                	<div id='{{id}}_bubble_arrow' class='bubble_arrow'></div>\
                	<div id='{{id}}_content' class='bubble_content'></div>\
                </div>";


    var defaultConfig = {
        layout:'inline-block',
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

    t2k.component.dialog.BubbleView = t2k.component.CompositeView.subClass({
        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.BubbleView',
        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }
    
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/BubbleView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/Bubble.js
////////////////////////////////////////
(function() {

    t2k.component.dialog.Bubble = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.Bubble',

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.view = this.createNewView(t2k.component.dialog.BubbleView, config);

            this.startComposite2({parent: this.view.cfg.id + '_content'});
        }


        

		

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/Bubble.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/AvatarView.js
////////////////////////////////////////
(function () {

    var TEMPLATE = "<div class='avatar' id='{{id}}'>\
                    	<div id='{{id}}_content' class='avatar_content' />\
                    </div>";


    var defaultConfig = {
        layout:'inline',
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

    t2k.component.dialog.AvatarView = t2k.component.CompositeView.subClass({
        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.AvatarView',
        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

        }



    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/AvatarView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/Avatar.js
////////////////////////////////////////
(function() {

    t2k.component.dialog.Avatar = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.dialog.Avatar',

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.view = this.createNewView(t2k.component.dialog.AvatarView, config);

            this.startComposite2( { parent: this.view._content } ) ;
        },

        reduce : function(){
            this.layout.canReduce = false;
            this.layout.onRendered();
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/Avatar.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/PostsView.js
////////////////////////////////////////
(function () {

    var TEMPLATE = "<div class='posts' id='{{id}}'>\
                    	<div id='{{id}}_content' class='posts_content' />\
                    </div>";


    var defaultConfig = {
        layout:'inline',
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

    t2k.component.dialog.PostsView = t2k.component.CompositeView.subClass({
        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.PostsView',
        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

        }
    
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/PostsView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/Posts.js
////////////////////////////////////////
(function() {

    t2k.component.dialog.Posts = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.Posts',

        ctor: function(config) {
            
        	preProcessData( config.data ) ;

            // Delegate
            this._super(config);

            this.view = this.createNewView(t2k.component.dialog.PostsView, config);

            this.startComposite2( { parent: this.view._content } ) ;
            
        }

    });
    
    function preProcessData( data ) {
    	
    	var names = [] ;
    	var namesCounter = 0 ;
    	
    	var $data = jQuery( data ) ;
		var $post ;
		var postName ;
		
		var opposite ;
		var nameIndex ;
		var isNewName ;
    	
		$data.children().each( function( index, post ) {
    		
    		$post = jQuery( post ) ;
    		postName = $post.attr( 'name' ) ;
    		
    		nameIndex = names.indexOf( postName ) ;
    		isNewName = nameIndex == -1 ;
    		
    		if( isNewName ) {
    			names.push( postName ) ;
    			nameIndex = namesCounter ;
    			namesCounter++ ;
    		}
    		
    		opposite = nameIndex % 2 != 0 ;
    		
    		$post.attr( 'opposite', opposite ) ;
    		
    		$post.attr( 'skin', 'skin_' + ( nameIndex + 1 ) ) ;
    		
    	} ) ;
		
    }

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/Posts.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/ExpositionView.js
////////////////////////////////////////
(function () {

    var TEMPLATE = "<div class='exposition' id='{{id}}'>\
            	<div id='{{id}}_content' class='exposition_content' />\
            </div>";

    var defaultConfig = {
        layout:'inline',
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

    t2k.component.dialog.ExpositionView = t2k.component.CompositeView.subClass({
        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.ExpositionView',
        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

        }
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/ExpositionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/Exposition.js
////////////////////////////////////////
(function() {

    t2k.component.dialog.Exposition = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.Exposition',

        ctor: function(config) {
        	
            // Delegate
            this._super(config);
            
            // reference
            var thi$ = this;
            
            this.view = this.createNewView(t2k.component.dialog.ExpositionView, config);

            this.startComposite2({parent: this.view.cfg.id + '_content'});
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/Exposition.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/PostView.js
////////////////////////////////////////
(function() {

    var TEMPLATE = "<div id='{{id}}' class='post {{type}} {{skin}}'>\
                    	<div id='{{id}}_content' class='post_content' />\
                    </div>";

    var defaultConfig = {
        layout : 'inline-block',
        /** The mustache template to render. */
        template : TEMPLATE
    }; // End of defaultConfig.

    t2k.component.dialog.PostView = t2k.component.CompositeView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            this._view.addClass( this.cfg.isOpposite ? 'read_opposite' : 'read_normal' ) ;
            
        },
        
	    /**
		 * reduce
		 */
		reduce : function(){
		}

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/PostView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/Post.js
////////////////////////////////////////
(function() {

    t2k.component.dialog.Post = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.dialog.Post',

        ctor: function(config) {
            // Delegate
            this._super(config);

            // parse configuration
            this.parseConfig() ;
            
            this.view = this.createNewView( t2k.component.dialog.PostView, copy( {
            	isOpposite: this.isOpposite,
            	type: this.type,
            	name: this.name,
            	skin: this.skin
	            },
	            this.cfg )
            ) ;

            this.startComposite2( { 
            	parent: this.view._content,
            	isOpposite: this.isOpposite,
            	type: this.type,
            	name: this.name
            });
            
        },
		
		/**
		 * setEnabled
		 * @param flag
		 */
		setEnabled : function(flag){
			this._super(flag);
			this.view.setEnabled(flag);
		},
		
		parseConfig: function() {
			
			var $data = jQuery( this.cfg.data ) ;

            this.name = $data.attr( 'name' ) ;
            this.type = $data.attr( 'type' ) ;
            this.isOpposite = $data.attr( 'opposite' ) == 'true' ;
            this.skin = $data.attr( 'skin' ) ;
			
		}

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/Post.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/DialogView.js
////////////////////////////////////////
(function() {

    var TEMPLATE = "<div class='dialog' id='{{id}}'>\
        	<div id='{{id}}_content' class='dialog_content'/>\
        </div>";

    var defaultConfig = {
        layout : 'inline',
        /** The mustache template to render. */
        template : TEMPLATE
    }; // End of defaultConfig.

    t2k.component.dialog.DialogView = t2k.component.CompositeView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
            
            if (config.useMax) {
            	var mw = this.cfg.maxSize ? this.cfg.maxSize.width : this.cfg.container.width() ;
            	var mh = this.cfg.maxSize ? this.cfg.maxSize.height : this.cfg.container.height() ;
                this._view.css('max-width', mw.toString() + 'px');
                this._view.css('max-height', mh.toString() + 'px');
            }
        },
    
	    /**
		 * reduce
		 */
		reduce : function(){
			this._super() ;
		},

        getReductionReport: function() {

            var percent = 1,
                belowRead = false,
                belowAbs = false
                ;
            
            var _elm = (this._view)[0];

            var overV = ( _elm.clientWidth < _elm.scrollWidth ) ;
            var overH = ( _elm.clientHeight < _elm.scrollHeight ) ;
            
            return { 
            	percent: percent,
            	belowRead: belowRead,
            	belowAbs: belowAbs,
            	overflowV: overV,
            	overflowH: overH,
            	overflow: overH || overV
            };
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/DialogView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/dialog/Dialog.js
////////////////////////////////////////
(function () {

    t2k.component.dialog.Dialog = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.dialog.Dialog',

        ctor:function (config) {
        	
            // Delegate
            this._super(config);
            
            // parse configuration
            this.parseConfig();

            this.view = this.createNewView(t2k.component.dialog.DialogView, copy({}, this.cfg));

            this.startComposite2( { parent:this.view._content } ) ;

        },
        
        /**
         * reduce
         */
        reduce : function(){
        	this._super() ;
//	         this.layout.canReduce = false ;
//	         this.layout.onRendered();
         },
         loose : function(){
        	 this.layout.onRendered();
         },
         compact : function(){
        	 this.layout.onRendered();
         },

        /**
         * setEnabled
         * @param flag
         */
        setEnabled:function (flag) {
            this._super(flag);
            this.view.setEnabled(flag);
        },

        parseConfig:function () {
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/dialog/Dialog.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/text/QuestionView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div class='question' id='{{id}}'>\
            <div id={{id}}_content></div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.text.QuestionView = t2k.component.CompositeView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/text/QuestionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/text/Question.js
////////////////////////////////////////
(function() {

    t2k.component.text.Question = t2k.component.Composite.subClass({
    	
    	/** The class' name (for debugging purpose). */
        name: 't2k.component.text.Question',

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.view = this.createNewView(t2k.component.text.QuestionView, this.cfg);

            this.startComposite2({parent: this.view.cfg.id + '_content'});
        },

        /**
         * setState
         * Set the question and its children to the specified state xml
         * @param state - {jQuery} State xml
         */
        setState:function (state) {
            this._super(state);
        },

        /**
         * getState
         * Get the question state xml
         * @return state - {jQuery} State xml
         */
        getState:function () {
            return this._super();
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/text/Question.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/text/TitleView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div class='title' id='{{id}}'>\
            <div id={{id}}_content></div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.text.TitleView = t2k.core.View.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/text/TitleView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/text/Title.js
////////////////////////////////////////
(function() {

    t2k.component.text.Title = t2k.component.Composite.subClass({
    	
    	/** The class' name (for debugging purpose). */
        name: 't2k.component.text.Title',

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.view = new t2k.component.text.TitleView(this.cfg);
            
            this.startComposite2({parent: this.view.cfg.id + '_content'});
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/text/Title.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textViewer/TextViewerConfig.js
////////////////////////////////////////


// toolbar config constant values
t2k.component.textViewer.TextViewerConstants = { 

		soundImgSrc					: 'assets/images/textviewer/SoundBtn_Default.png',
		soundImgSrc_mouseOver		: 'assets/images/textviewer/SoundBtn_Rollover.png',
		soundImgSrc_mousePress		: 'assets/images/textviewer/SoundBtn_Press.png',
		soundImgSrc_selected		: 'assets/images/textviewer/SoundBtn_Selected.png',
		soundImgSrc_selectedOver	: 'assets/images/textviewer/SoundBtn_SelectedRollover.png',
		
		narrationImgSrc				: 'assets/images/textviewer/NarrationBtn_Default.png',
		narrationImgSrc_mouseOver	: 'assets/images/textviewer/NarrationBtn_Rollover.png',
		narrationImgSrc_mouseDown	: 'assets/images/textviewer/NarrationBtn_Press.png',
		narrationImgSrc_stop		: 'assets/images/textviewer/NarrationBtn_Selected.png',
		narrationImgSrc_stopOver	: 'assets/images/textviewer/NarrationBtn_SelectedRollover.png',
		narrationAnimateBG			: 'assets/images/textviewer/NarrationAnimateBG.png',
		
		narrationImgHeight			: '26px',
		narrationImgWidth			: '40px',

		narrationBG_color			: '#FEF3BA',
		
		// ltr
		narrationImgPaddingLeft		: '0em', // must be em
		
		// rtl
		narrationImgPaddingRight	: '0.5em', // must be em

        mathFieldLineHeightEvenFactor: 0.9,
		lineHeightEvenFactor		: 1.27,
		lineHeightCompactFactor		: 1.27,
		lineHeightPxFactor			: 7,
		
		fontSizeToImgSizeFactor		: 1.18,
		
		textViewerMaxWidth			: 714, // must be 51rem. example: for PC this is 51 * 14(html/body font-size) = 714px
		
		sideBarWidth				: '2.5em',
		baloonTipTopFactor			: 10,
		baloonTipSafeZoneFactor		: 30,
		baloonTipArrowWidth			: 10,
		baloonTipArrowHeight		: 14,
		sequenceClass				: 'themable_player_sequenceHolder',
		minimumReadableFontSize		: ENV.behaviors.textViewerMinReadable,
		absoluteMinimumFontSize		: ENV.behaviors.textViewerMinReadable,
		absMinStrLen				: 10,
		fontSizeReductionFactor		: 2,
		reductionStepSize			: 1,
		
		minWidthForAspectRatioResize : {
			"en_US"	: 200,
			"iw_IL"	: 100,
			"fr_FR"	: 200,
			"nl_NL"	: 200
		},
		
		inlineSoundAspectRatio : 1.489, // aspectRatio = width / height
		
		inlineNarrationSize : {width:'1em', height:'1em'},
		
		// balloonTip
		balloonTipArrowHeight: 10,
		balloonTipFactor  : 5,
		
		balloonArrowSize : {
			width: 6, height: 10
		}

};

/**
 * the object that will be received by TextAreaViewer's @constructor
 */
t2k.component.textViewer.TextViewerParams = function(){
	this.id 				= "",
	this.width 				= "", // size + 'px'
	this.height 			= "", // size + 'px'
	this.initMarkup			= "", // markup
	this.style 				= "", // 
	this.parent 			= "", // parent Id
	this.parentIsObject		= "", // if parent is an object and not an id
	this.direction 			= "", // 'ltr' (default)/ 'rtl'
	this.mode 				= "", //
	this.useSideBar			= "",
	this.enableTextSelection = "",
	this.language			= "",
	this.baloonStyle		= "",
	this.lineHeightConfig	= "",   // 'compact' or 'keepEven'
	this.setMaxWidth		= "",	// size + 'px' or size only	
	this.fixNarrationPosition	= "",	// 'bottom' / non
	this.applyAbsoluteMinimum = "";
};

////////////////////////////////////////
// SRC End --> t2k/component/textViewer/TextViewerConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textViewer/TextViewerView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.textViewer.TextViewerView
     * @desc A textViewer View component class
     * @namespace t2k.component.textViewer
     * @extends t2k.component.BaseComponentView
     * @type {Object}
     */
    /**
     * Private: TEMPLATE
     * The textViewer's Mustache template.
     */
    var TEMPLATE =
        "<div class='textViewer {{style}} {{direction}}' id='{{id}}' \
              style='width:{{width}};height:{{height}}; direction:{{direction}}; text-align:{{textAlign}}'>\
            <div id='{{id}}_content' class='textViewer_content'>{{{initMarkup}}}</div>\
        </div>";

    /**
     * Private: multiNarrationTemplate
     * The textViewer's multi narration Mustache template.
     */
    var multiNarrationTemplate =
        "<div class='multiNarration'>\
            <div id='control'></div>\
            <div id='first'  class='narrationMediaPlayerButton'></div>\
            <div id='second' class='narrationMediaPlayerButton'></div>\
        </div>";

    /**
     * Private: balloonArrowTemplate
     * The textViewer's balloon Mustache template.
     */
    var balloonArrowTemplate =
        "<div class='balloonArrowWrapper {{position}}'>\
            <div class='arrow' />\
            <div class='arrowBG' />\
            <div class='arrowShadow' />\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the task's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.   

    /**
     * Private: constants
     * short hand to textViewer constants
     */
    var constants = t2k.component.textViewer.TextViewerConstants;

    t2k.component.textViewer.TextViewerView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor TextAreaViewer
         * @param config
         */
        ctor: function(config) {
              //if in config we got viewObject - use it don't create new text (d&d dropping event)
            if (config.viewObject) {

                this.cfg = config;
                this._view = this.cfg.viewObject;
                jQuery(this.cfg.parent).append(this.cfg.viewObject);
                this._view.show();
            } else {

                // prepare markup for Mustache
                this.cfg = config;
                config.initMarkup = this.prepareMarkup(config.initMarkup);

                // Delegate
                this._super(override(config, defaultConfig));

                /**
                 * @property ''
                 * @type {Boolean}
                 */
                this.overflow = false;

                // get and init text viewer members
                this.getMembers();
                this.initMembers();

                // init text viewer children (inlineSound, inlineImage, narration etc..)
                this.startManualComposite();
                this.setMaxWidthfromParent();

                this.checkMaxWidth();

                this.dispatchEvent('onTextViewerChildrenRendered', this);
            }
        },

        /**
         * onViewRendered
         * override with an empty function.
         * textViewerView will dispatch the 'onRendered' event himself.
         */
        onViewRendered : function() {
            if( this.cfg.autoplay ) {
             // this.narrate( function(){} ) ;
            }
        }, // end of onViewRendered

        /**
         *
         * @return {Boolean}
         */
        isOverflowing:function() {
            // var _elm = (this._view)[0];
            var _hasScrollBar = false;
            //            if ((_elm.clientHeight < _elm.scrollHeight) || (_elm.clientWidth < _elm.scrollWidth)) {
            //            fixed bug : calculation scrollHeight in IE9

            // 19/06/2013 12:41:32 :=) 
            // below written code should only work if the TV is in the SheardArea
            // TODO: check behave in shared (i dont have enough info)
            /*if ((jQuery(_elm).height() < jQuery(_elm).outerHeight()) || (_elm.clientWidth < _elm.scrollWidth)) {
                _hasScrollBar = true;
            }*/

            
            return _hasScrollBar;
        },

        /**
         * getMembers
         * configuration to members
         */
        getMembers : function() {

            /**
             * @property
             */
            this.width = this.cfg.width;
            /**
             * @property
             */
            this.height = this.cfg.height;
            /**
             * @property
             */
            this.initMarkup = this.cfg.initMarkup;
            /**
             * @property
             */
            this.style = this.cfg.style;
            /**
             * @property
             */
            this.parent = this.cfg.parent;
            /**
             * @property
             */
            this.direction = this.cfg.direction;
            /**
             * @property
             */
            this.mode = this.cfg.mode;
            /**
             * @property
             */
            this.useSideBar = this.cfg.useSideBar;
            /**
             * @property
             */
            this.enableTextSelection = this.cfg.enableTextSelection;
            /**
             * @property
             */
            this.language = this.cfg.language;
            /**
             * @property
             */
            this.parentIsObject = this.cfg.parentIsObject;
            /**
             * @property
             */
            this.balloonStyle = this.cfg.balloonStyle;
            /**
             * @property
             */
            this.lineHeightConfig = this.cfg.lineHeightConfig;
            /**
             * @property
             */
            this.setMaxWidth = this.cfg.setMaxWidth ? this.cfg.setMaxWidth : null;
            /**
             * @property
             */
            this.fixNarrationPosition = this.cfg.fixNarrationPosition;
            /**
             * @property
             */
            this.applyAbsoluteMinimum = this.cfg.applyAbsoluteMinimum;
            /**
             * @property
             */
            this.maxLineHeight = 0;
            /**
             * @property
             * @type {Array}
             */
            this.narrationIndicator = [];
            /**
             * @property
             */
            this.isMinimunReadable = false;
            /**
             * @property
             */
            this.isAbsoluteMinimun = false;
            /**
             * @property
             */
            this.additionLineHeight = this.cfg.additionLineHeight;
            /**
             * @property
             * @type {Number}
             */
            this.reductionStep = parseInt(!!this.cfg.reductionStep ? this.cfg.reductionStep : 0);

            if (!this.cfg.dummyMode && !!this.cfg.compiledLayoutRes.reduction){
                this.reductionStep = parseInt(this.cfg.compiledLayoutRes.reduction);
            }
            /**
             * @property
             * @type {Number}
             */
            this.reductionStepSize = constants.reductionStepSize;
            /**
             * @property
             * @type {Array}
             */
            this.textViewerChildren = [];
        },

        /**
         * initMembers
         * init text viewer members
         */
        initMembers : function() {

            this.minimumReadableFontSize = this.cfg.minimumReadableFontSize ? this.cfg.minimumReadableFontSize : constants.minimumReadableFontSize.px2int();
            // get current font size by a factor of initialization ...
            var tmpFontSize = this._view.css('font-size');
            if(tmpFontSize){
                this.fontSize = tmpFontSize.px2int() * ENV.behaviors.textViewerFontSizeInitializeFactor;
                this._view.css('font-size',  this.fontSize);

                this.maxLineHeight = this.fontSize + constants.lineHeightPxFactor + this.additionLineHeight;
                this.optimumFontSize = this.cfg.optimumFontSize || this.fontSize;
            }else{
                this.fontSize = this.cfg.optimumFontSize || 22;
                this._view.css('font-size',  this.fontSize);

                this.maxLineHeight = this.fontSize + constants.lineHeightPxFactor + this.additionLineHeight;
                this.optimumFontSize = this.cfg.optimumFontSize || this.fontSize;
            }


            // get reduction step and set font-size
            if (this.reductionStep > 0) { //if reductionStep > 0, calculate font-size according to it
                var reducedFontSize = this.calcFontSizeByReduction();
                this._view.css('font-size', reducedFontSize + 'px');
            }

            // get jQuery parent dom element
            this.$parent = this._view.parent();

            // set media player class
            if (!!ENV.behaviors.useExternalMediaPlayer){
               
                this.mediaPlayerClass = t2k.component.mediaPlayer.ExternalMediaPlayer;
            } else {
               
                this.mediaPlayerClass = t2k.component.mediaPlayer.MediaPlayer;
            }
        },

        /**
         * setLineHeight
         * keepEven or compact
         */
        setLineHeight : function() {

            var thi$ = this, compHeight, compTop, compFactorHeight, margin;

            if (this.lineHeightConfig == 'keepEven') {

                jQuery(this.textViewerChildren).each(function(index, child) {
                    if (child.name.indexOf('mathField') > -1){
                        compHeight = child.view._frame.height() * constants.lineHeightEvenFactor;
                    } else {
                        compHeight = child.view._view.height() * constants.lineHeightEvenFactor;
                    }

                    thi$.setMaxLineHeight(compHeight);
                });
                this._view.css('line-height', this.maxLineHeight + 'px');
            } else {

                jQuery(this.textViewerChildren).each(function(index, child) {
                    if (child.name.indexOf('mathField') > -1){
                        compHeight = child.view._frame.height();
                        compTop = child.view._frame.css('top').px2int();
                        compFactorHeight = compHeight * constants.lineHeightCompactFactor;
                        margin = Math.ceil(compFactorHeight - compHeight - compTop);
                        child.view._view.parent().css({'margin-top' : margin + 'px'});

                    } 
                });
            }
        },

        setMaxWidthfromParent: function(){
            if(this.setMaxWidth == null){
                this.setMaxWidth= this.parent.outerWidth();
            }
        },

        /**
         * checkMaxWidth
         */
        checkMaxWidth : function() {

            var mw = constants.textViewerMaxWidth,
                mh;

            if (this.cfg.useMax) {
                mw = this.cfg.maxSize ? this.cfg.maxSize.width : this.cfg.container.outerWidth();

                /*
                    mh = (this.cfg.maxSize ? this.cfg.maxSize.height : this.cfg.container.height())+'px';
                    this._view.css({'max-height': mh,'max-width': mw + 'px'});
                */

            } else {
                if (this.setMaxWidth > constants.minWidthForAspectRatioResize[ENV.locale]) {
                    mw = this.setMaxWidth;
                }else{
                    mw = constants.minWidthForAspectRatioResize[ENV.locale] || this.cfg.container.outerWidth()
                }
            }
            // Maximum size should not exceed the required GUI options ( 51rem for PC this is 714px )
            // todo: add case for tablet
            var newWidth = (mw > constants.textViewerMaxWidth) ? constants.textViewerMaxWidth : mw;

            this._view.css({'max-width': Math.ceil(newWidth) + 'px'});

            // TODO: liron: check behave in shared (i dont have enough info)
            if(this.isOverflowing()){
                this._view.addClass('overflow');
                this.overflow = true;
            }
        },

        /**
         * every child changes the line height param
         * @param val
         */
        setMaxLineHeight : function(val) {
            if (val > this.maxLineHeight) {
                this.maxLineHeight = val;
            }
        },

        /**
         * textViewerChildrenRendered
         * on textViewer children rendered
         */
        textViewerChildrenRendered : function() {
            this.setLineHeight();
            this.checkMaxWidth();
            this.dispatchEvent('onRendered');
        },

        /**
         * on a new child, view dispatch event to presenter, that adds the child to itself
         * and calls this function, to let view add the child also
         * @param child
         */
        addChild : function(child) {
            this.textViewerChildren.push(child);
        },

        /**
         * markup string manipulation for text viewer children
         * @param markup
         * @returns prepared markup
         */
        prepareMarkup : function(markup) {
            // init numOfChildren
            /**
             * @property
             * @type {Number}
             */
            this.numOfChildren = 0;
            //markup = markup.trim();
            markup = this.clearConfigLineBreak(markup);

            // <p> tag
            markup = this.prepareMarkup_pTag(markup);

            // textViewerNarration
            markup = this.prepareMarkup_textViewerNarration(markup);

            // prepare inline sound, inlineNarration, inlineImage
            markup = this.prepareMarkup_replace(markup, 'inlinesound', true);
            markup = this.prepareMarkup_replace(markup, 'inlinenarration', true);
            markup = this.prepareMarkup_replace(markup, 'inlineimage', true);
            markup = this.prepareMarkup_replace(markup, 'balloontip');
            markup = this.prepareMathFieldMarkup_replace(markup, 'mathfield');

            return markup;
        },

        /**
         * special string manipulation on textViewerNarration
         * @param markup
         * @return prepared markup
         */
        prepareMarkup_textViewerNarration : function(markup) {
            while (markup.toLowerCase().indexOf('<textviewernarration') != -1) {
                markup = markup.replace(/<textviewernarration/i, '<inlinenarration textViewerNarration="true"');
                markup = markup.replace(/<\/textviewernarration>/i, '</inlinenarration>');
            }
            return markup;
        },

        /**
         * generic method to replace the feeding markup to html markup. Mustache preparation
         * @param markup
         * @param tagName (inlineImage, inlineSound, narration etc..)
         * @param countChild {Boolean} on true, count this child
         * @return prepared markup
         */
        prepareMarkup_replace : function(markup, tagName, countChild) {

            var index;

            // find tagName, replace it with a div [tagName + 'Wrapper']
            while (markup.toLowerCase().indexOf('<' + tagName) != -1) {
                // special wrap on inline narration - get index
                if (tagName == 'inlinenarration') {
                    index = markup.indexOf('<' + tagName);
                }

                markup = markup.replace('<{0}'.format(tagName), '<div rel="{0}" class="{0}Wrapper {2}" id="{1}" '.format(tagName, genId(), this.cfg.direction));
                markup = markup.replace('</{0}>'.format(tagName), '</div>');

                // special wrap on inline narration - wrap with a span to prevent narration on single line
                if (tagName == 'inlinenarration') {
                    /* Save our fragment and remove it from markup */
                    var inlineNarrationRe = /<div rel="inlinenarration".+?div>/,
                        savedFrag = markup.substr(index).match(inlineNarrationRe)[0];
                    markup = markup.replace(savedFrag, '');

                    /* When the last item in text viewer is math field, we wrap it */
                    if (markup.substr(0, index).match(/<\/(inlinesound|inlineimage|balloontip|mathfield|subanswer)>\s*$/)) {
                        var insBefore = markup.substr(0, index).search(/<(inlinesound|inlineimage|balloontip|mathfield|subanswer)/);
                        markup = markup.
                            splice(index, 0, savedFrag + '</span>').
                            splice(insBefore, 0, '<span class="narrationSpecialWrapper">');
                    }
                    else {
                        /* Find insertion points before and after the last word,
                         * skipping tags and whitespace */
                        var insAfter = markup.substr(0, index).search(/(\s*<[^<>\s]*?>)*\s*$/),
                            insBefore = markup.substr(0, insAfter).search(/[^>\s]*$/);
                        markup = markup.
                            splice(insAfter, 0, savedFrag + '</span>').
                            splice(insBefore, 0, '<span class="narrationSpecialWrapper">');
                    }
                }

                // count this child (on children rendered)
                if (countChild) this.numOfChildren++;
            }
            return markup;
        },

        /**
         * prepareMathFieldMarkup_replace
         * @param markup
         * @param tagName
         * @param countChild
         * @return {String}
         */
        prepareMathFieldMarkup_replace:function (markup, tagName, countChild) {

            var thi$ = this, $child, div, arrMathFields, wrapper;

            markup = jQuery('<div/>').append(markup);

            arrMathFields = jQuery('mathfield', markup);

            if(arrMathFields.length){
                thi$.checkMathField = true;
            }

            arrMathFields.each(function (index, child) {
                $child = jQuery(child);

                //don't handle MathField inside of subAnswer, because subAnswer it's composite
                if (!$child.parent('subanswer').length) {
                    div = jQuery('<div/>');

                    div.html($child.html());

                    jQuery(child.attributes).each(function (index, attr) {
                        div.attr(attr.nodeName, attr.nodeValue);
                    });

                    div.attr({'rel':'mathField', 'class':'mathFieldWrapper ' + thi$.cfg.direction, 'id':genId()});

                    div.insertBefore($child);
                    $child.remove();
                }

            });

            wrapper = jQuery('<div/>').append(markup);
            return wrapper.html();
        },

        /**
         * p tag string manipulation that replace the feeding p tag with a div
         * @param markup
         * @return {String} prepared markup
         */
        prepareMarkup_pTag : function(markup) {

            // if p tag wasn't found, wrap the content with one
            if (markup.indexOf('<p') == -1) {
                // TODO: revert this change when XML data allow it
                // throw 'textViewer markup should have p tag: "' + markup + '"';
                markup = ['<p>', '</p>'].join(markup);
            }

            /**
             * This is magical feature of the DL, please test whenever you change the below line.
             * TODO use string manipulation instead of Jquery as it messes up the HTML
             */
            //fixed in the TextViewer.js : with textViewerTagName calculeted
            //TODO : check with CGT
            //markup += '</p>';

            var classes, $pTag,
                markupWrapper = jQuery('<wrapper/>'),
                $markup = jQuery(markup),
                newTag;

            markupWrapper.append($markup);

            markupWrapper.find('p').each(function(index, pTag){

                $pTag = jQuery(pTag);
                classes = $pTag.get(0).attributes;

                newTag = jQuery('<div/>' , {id : genId()}).addClass('textViewerParagraph').html($pTag.html());

                for (var i=0 ; i < classes.length ; i++){
                    if (classes[i].name != 'class'){
                        newTag.attr(classes[i].name, classes[i].value);
                    } else {
                        newTag.addClass(classes[i].value);
                    }
                }

                newTag.insertBefore($pTag);
                $pTag.remove();
            });
            return markupWrapper.html();

        },

        /**
         * remove line breaks from feeding
         * @param markup
         * @return {String} cleared markup
         */
        clearConfigLineBreak : function(markup) {
            // remove line breaks and tabs
            markup = markup.replace(/[\r\n\t]+/g, " ");
            return markup;
        },

        /**
         * startManualComposite
         * init text viewer's children (components and balloon tip)
         */
        startManualComposite : function() {
            // dispatch children sum to presenter
            this.dispatchEvent('childSum', this.numOfChildren);

            // narration needs a speacial dom manipulation before initialize
            this.setTextViewerNarrationDomPosition();

            // start components
            this.startInlineSound();
            this.startInlineNarration();
            this.startInlineImage();
            this.startBalloonTip();

	        this.mathFields = [];
            this.startMathField();
        },

        /**
         * setTextViewerNarrationDomPosition
         * narrztion speacial dom manipulation before initialize
         */
        setTextViewerNarrationDomPosition : function() {
            // reference
            var thi$ = this;

            this._view.find('div [textviewernarration=true]').each(function() {
                var narrationSpecialWrapper = thi$._view.find('.narrationSpecialWrapper');

                for (var i = 0; i < narrationSpecialWrapper.length; ++i) {
                    if (this.contains(narrationSpecialWrapper[i])) continue;
                    jQuery(narrationSpecialWrapper[0]).append(this);
                }
            });
        },

        /**
         * startInlineSound
         * get attributes and init media player component
         */
        startInlineSound : function() {
            // reference
            var thi$ = this;

            !this._content || this._content.find('div[rel=inlineSound]').each(function(index, child) {

                // get Data
                var $child = jQuery(child);
                var src = $child.attr('src');
                var tooltip = $child.attr('tooltip');

                // get wrapper's params
                var childFontSize = $child.css('font-size').px2int();
                var childHeight = '1em'; // set inline sound at same height as line
                // thi$.fontSizeToImgSize(childFontSize);
                var childWidth = constants.inlineSoundAspectRatio +'em'; // aspectRatio = width / height

                // set wrapper size
                $child.height(childHeight).width(childWidth);

                // init sound button
                var soundObject = new thi$.mediaPlayerClass(copy({}, {
                    parent: $child,
                    type: 'soundButton',
                    src: src,
                    onRendered : function() {
                        thi$.dispatchEvent('childRendered', thi$);
                    },

                    dummyMode: thi$.cfg.dummyMode
                }));
                // enable sound button
                soundObject.setEnabled(true);

                // resize sound button and set tooltip
                soundObject.view._content.height(childHeight).width(childWidth).attr('title', tooltip);

                // add child
                if (soundObject) thi$.dispatchEvent('addChild', {child : soundObject, view : thi$});
            });

        }, // inline sound end

        /**
         * startMathField
         * get attributes
         */
        startMathField : function() {
            // reference
            var thi$ = this, $child, mathFieldTag, mathField, childHTML;

	        function createMF(index, child) {
		        // get Data
		        $child = jQuery(child);

		        mathFieldTag = jQuery('<mathField/>');
		        mathFieldTag.attr('keyboardPreset', $child.attr('keyboardpreset'));
		        mathFieldTag.attr('type', $child.attr('type'));
		        mathFieldTag.attr('editMode', $child.attr('editmode'));
		        mathFieldTag.attr('maxHeight', $child.attr('maxheight'));
		        mathFieldTag.attr('fontLocale', $child.attr('fontlocale'));
		        mathFieldTag.attr('colorShapes', $child.attr('colorShapes'));
		        mathFieldTag.attr('italicVariables', $child.attr('italicVariables'));

		        childHTML = $child.html().trim();
		        $child.html('');

		        // init math field
		        mathField = new t2k.component.mathField.MathField (copy({}, {
			        parent: $child.attr('id'),
			        container : $child,
			        data : mathFieldTag.append(childHTML),
			        taskmode: thi$.cfg.taskmode,
			        onRendered : function() {
				        thi$.dispatchEvent('childRendered', thi$);
			        },
			        dontEnableBlowup : thi$.cfg.dontEnableBlowup
		        }));

		        if (mathField) {
			        mathField.view._view.css({'margin-top':'0px', 'margin-bottom':'0px'});
			        var mfSize = mathField.getSize(),
				        mewMfHeight = mfSize.height + mathField.view._frame.css('top').px2int();

			        mathField.view._view.height(mewMfHeight);
			        $child.css({'display':'inline-block'});

			        thi$.dispatchEvent('addChild', {child:mathField, view:thi$});
			        thi$.mathFields.push(mathField);
		        }
	        }

            !this._content || this._content.find('div[rel=mathField]').each(createMF);

            //add to TV div attribute mathfield=true in order to use it in css later (because there is no 'parent' selector in css now)
            thi$._view.attr('mathfield', true);
        },

        /**
         * startBalloonTip
         * get attributes and balloon tip events
         */
        startBalloonTip : function() {
            // reference
            var thi$ = this;

            !this._content || this._content.find('div[rel=balloontip]').each(function(index, child) {
                // get Data
                var $child = jQuery(child);
                var config = $($child.attr('markup'));
                
                // mouse down event (gui)
                $child.mousedown(function() {
                    $child.addClass('mouseDown');
                });

                // mouse up event (gui)
                $child.mouseup(function() {
                    $child.removeClass('mouseDown');
                });

                // mouse enter event - show balloon tip
                $child.mouseenter(function() {
                    var childId = $child.attr('id');
                    var balloonRelateTo = jQuery('.balloonWrapper').attr('relateToId');

                    if (childId != balloonRelateTo) {
                        thi$.showBalloonTip($child, config);
                    }
                });
            });

        }, // startBalloonTip end

        /**
         * startInlineImage
         * get attributes and init image viewer component
         */
        startInlineImage : function() {
            // reference
            var thi$ = this;

            !this._content || this._content.find('div[rel=inlineimage]').each(function(index, child) {
                // get Data
                var $child = jQuery(child);
                    src = $child.attr('src'),
                    tooltip = $child.attr('tooltip'),

                    // get wrapper's params
                    childFontSize = $child.css('font-size').px2int(),
                    childHeight = thi$.fontSizeToImgSize(childFontSize),
                    originalwidth = $child.attr('originalwidth') != undefined ? $child.attr('originalwidth').px2int() : childHeight,
                    originalHeight = $child.attr('originalheight') != undefined ? $child.attr('originalheight').px2int() : childHeight,
                    childWidth = (originalwidth * childHeight) / originalHeight;

                // set wrapper size and tooltip
                $child.height(childFontSize).attr('title', tooltip);

                // init image viewer
                var imageObject = new t2k.component.imageViewer.ImageViewer(copy({}, {
                    parent: $child,
                    src: src,
                    height: childHeight,
                    width: childWidth,
                    disableTumbnail: true,
                    onRendered : function() {
                        thi$.dispatchEvent('childRendered', thi$);
                    }
                }));

                if (imageObject && !!imageObject.view._view) thi$.dispatchEvent('addChild', {child : imageObject, view : thi$});
            });

        }, // inline image end

        /**
         * startInlineNarration
         * get attributes and init media player component with paragraph background
         */
        startInlineNarration : function() {
            // reference
            var thi$ = this;

            !this._content || this._content.find('div[rel=inlinenarration]').each(function(index, child) {

                var narrationElement = this;

                // get Data
                var $child = jQuery(child);
                var src = $child.attr('src');
                var tooltip = $child.attr('tooltip');
                var multiLanguage = $child.attr('multiLanguage') == 'true';
                // get textViewerNarration flag {Boolean}
                var textViewerNarration = !!($child.attr('textViewerNarration'));

                // get wrapper's params
                var childFontSize = $child.css('font-size').px2int();
                var childHeight = constants.inlineNarrationSize.height;
                var childWidth = constants.inlineNarrationSize.width;

                // set wrapper size
                $child.height(childHeight).width(childWidth);

                // init sound button
                var soundObject = new thi$.mediaPlayerClass(copy({}, {
                    parent: $child,
                    type: 'soundButton',
                    src: src,
                    onRendered : function() {
                        thi$.dispatchEvent('childRendered', thi$);
                    },

                    dummyMode: thi$.cfg.dummyMode
                }));
                // enable sound button
                soundObject.setEnabled(true);

                // register narration
                thi$.registerNarration(soundObject);

                // resize sound button and set tooltip
                soundObject.view._content.attr('title', tooltip);

                /**
                 * _fixThis function
                 * in case this is a mobile touch area return it's _content sibling
                 * @param _this
                 * @return {*}
                 * @private
                 */
                function _fixThis(_this) {
                    if (_this.className === "mobile-touch-area")
                        return jQuery(_this).siblings(".soundButton_content")[0];
                    return _this;
                }
                
                if( soundObject.bindEvent ) {
                    // add narration's events:
                    // mouse enter - if nar bg exists, show it. else, build it.
                    soundObject.bindEvent('mouseover', 'content', function() {
                        var $thisData = thi$.getEleData(_fixThis(this));
                        if (thi$.narrationBGexists($thisData)) thi$.showNarration($thisData, true);
	                    else {
	                        thi$.drawNarrationBG($thisData, true, textViewerNarration);
                        }
                    });
    
                    // mouse mousedown - toggle nar play
                    soundObject.bindEvent('mousedown', 'content', function() {
                        var $thisData = thi$.getEleData(_fixThis(this));
                        thi$.toggleNarrationIndicator($thisData, 'narPlay');
                        if (!!multiLanguage) thi$.showMultiNarrationBalloon($thisData, narrationElement, true);
                    });
    
                    // mouse leave - if nar doen't play, hide nar bg
                    soundObject.bindEvent('mouseout', 'content', function() {
                        var soundObj = _fixThis(this);
                        setTimeout(function () {
                            var $thisData = thi$.getEleData(soundObj);
                            if (!thi$.narrationIndicator[$thisData.id].narPlay)
                                thi$.showNarration($thisData, false);
                        }, 2);
                    });
    
                    // sound pause - toggle narPlay[false], and hide narration
                    soundObject.bindEvent('pause', 'audio', function() {
                        var $thisData = thi$.getEleData(jQuery(this).parent());
                        thi$.toggleNarrationIndicator($thisData, 'narPlay', true);
                        thi$.showNarration($thisData, false);
                    });
                } else {
                    
                    console.warn( "[DL][TextViewer] - inline SB can't bind events" ) ;
                    
                }
                
                if (soundObject) thi$.dispatchEvent('addChild', {child : soundObject, view : thi$});

                thi$.lastNarration = soundObject;

                // on fix narration position (mostly option composite),
                // append the narration structure to the $parent(option), and place a space holder instead
                if (!!thi$.fixNarrationPosition) {
                    thi$.$parent.css('position', 'relative');
                    jQuery('<div/>').addClass('narrationSpaceHolder').insertBefore(jQuery(this));
                    jQuery(this).addClass('textViewer fixNarrationPosition ' + this.direction).appendTo(thi$.$parent);
                }
            });


        },

        /**
         * removeAllBalloons
         */
        removeAllBalloons : function() {
            // remove all the balloons
            jQuery('.balloonWrapper').remove();
            jQuery('.balloontipWrapper').removeClass('arrow-top arrow-bottom');
        },

        /**
         * showBalloonTip
         * @param dataDomObj
         * @param config
         */
        showBalloonTip : function(dataDomObj, config) {
            // reference
            var thi$ = this;
            var balloonId = genId();

            thi$.removeAllBalloons();

            // build balloonTip elements
            var balloonWrapper = jQuery('<div/>')
                                    .addClass('balloonWrapper')
                                    .attr('id', balloonId)
                                    .attr('relateToId', dataDomObj.attr('id'));

            var parentDomObj = dataDomObj.closest('[class^="sequence_"]');
            dataDomObj.isShared = parentDomObj.hasClass('sequence_shared');

            if (dataDomObj.isShared) {
                dataDomObj.parentObj = parentDomObj.find('.sharedarea_content');
                balloonWrapper.appendTo(dataDomObj.parentObj);
            } else {
                dataDomObj.parentObj = this._view.parents('.task_content');
                balloonWrapper.insertBefore(dataDomObj.parentObj);
            }

            var balloonX = jQuery('<div></div>').addClass('x').appendTo(balloonWrapper);
            var balloonContent = jQuery('<div/>').addClass('balloonContent').appendTo(balloonWrapper);

            // balloon wrapper binds:
            balloonWrapper.click(function(e) {
                e.stopPropagation();
            });

            // balloon x binds:
            balloonX.mousedown(function() {
                balloonX.addClass('mouseDown');
            });

            balloonX.mouseup(function() {
                balloonX.removeClass('mouseDown');
            });

            balloonX.click(function() {
                thi$.activeBalloonId = null;
                // balloonWrapper.fadeOut('fast', function() {
                    thi$.removeAllBalloons();
                // });
            });

            // destroy balloon on document click
            jQuery(document).one('click', outsideCloseIB);
            function outsideCloseIB() {
                if($(event.currentTarget).hasClass('mediaPlayer') && $(event.currentTarget).parents('.balloonWrapper').length) {
                    jQuery(document).one('click', outsideCloseIB);
                }
                else {
                    balloonX.trigger('click');
                }
            }

            // var tmpData = jQuery(jQuery(config).get(0)).removeAttr("height").removeAttr("width");
            // init balloonTip content
            var balloonComponent = componentFactory.create(copy({
                data : config[0],//tmpData[0],
                parent: balloonContent,
	            container: dataDomObj.parentObj,
                enabled: true,
	            isBlowup: true,
	            useMax: true,
                onRendered: function() {
                    // set the balloonTip position
                    thi$.setBalloonTipPosition(dataDomObj, balloonWrapper);
                }
            }));

	        dataDomObj.parentObj = null;
        },

        /**
         * setBalloonTipPosition
         * calculate the balloon tip position: topLeft / topRight / bottomLeft / bottomRight
         * send the conclusions to the relevant functions
         * @param hotwordDomObj - the hot word element that triggers the balloon
         * @param balloonWrapper
         */
        setBalloonTipPosition: function(hotwordDomObj, balloonWrapper) {
            var thi$ = this;
            var $balloonTip = balloonWrapper;
            var $hotword = jQuery(hotwordDomObj);

            // set balloon info into an object for performance's efficiency
            var balloonInfo = {
                // get constant params
                $balloonTip              : $balloonTip,
                balloonTipFactor         : constants.balloonTipFactor,
                balloonTipSafeZoneFactor : constants.balloonTipSafeZoneFactor,
                balloonTipArrowWidth     : constants.balloonTipArrowWidth,
                balloonTipArrowHeight    : constants.balloonTipArrowHeight,
                // get balloonTip params
                balloonTipWidth          : $balloonTip.outerWidth(),
                balloonTipHeight         : $balloonTip.outerHeight(),
                // parent params
                isShared                 : hotwordDomObj.isShared,
                parentObj                : hotwordDomObj.parentObj,
                // get parent params 
                parentLeft         : hotwordDomObj.parentObj.offset().left,
                parentTop          : hotwordDomObj.parentObj.offset().top,
                parentWidth        : hotwordDomObj.parentObj.outerWidth(),
                // hotword params
                $hotword         : $hotword,
                hotwordHeight    : $hotword.outerHeight(),
                hotwordWidth     : $hotword.outerWidth(),
                hotwordLeft      : hotwordDomObj.isShared ? $hotword.offset().left - hotwordDomObj.parentObj.offset().left : $hotword.offset().left,
                hotwordTop       : $hotword.offset().top
            };

            this._setVerticalPositionBalloonTip(balloonInfo);
            this._setHorizontalPositionBalloonTip(balloonInfo);

            $balloonTip.fadeTo(250, 1);
        },

        /**
         * _setVerticalPositionBalloonTip
         * determine balloontip potision: top or buttom
         * @param balloonInfo
         */
        _setVerticalPositionBalloonTip : function(balloonInfo) {

            var balloonTopCalc,
                verticalClass = 'arrow-top';

            // set the balloonTip position - top
            if ((balloonInfo.hotwordTop - balloonInfo.balloonTipHeight - balloonInfo.balloonTipArrowHeight - balloonInfo.balloonTipFactor) > 0) {
                balloonTopCalc = balloonInfo.hotwordTop - balloonInfo.$balloonTip.offset().top - balloonInfo.balloonTipHeight - balloonInfo.balloonTipFactor;
            } else {//bottom
                balloonTopCalc = balloonInfo.hotwordTop - balloonInfo.$balloonTip.offset().top + balloonInfo.hotwordHeight + balloonInfo.balloonTipArrowHeight + balloonInfo.balloonTipFactor;
                verticalClass = 'arrow-bottom';
            }
            balloonInfo.$hotword.addClass(verticalClass);
            balloonInfo.$balloonTip.css('margin-top', parseInt(balloonTopCalc) + 'px');
        },

        /**
         * _checkPositionBalloonTip
         * check/set the balloonTip Horizontal position after calculation - According to task the position if necessary 
         * @param balloonInfo
         */
        _setHorizontalPositionBalloonTip : function(balloonInfo) {

            // balloonTip.maxWidth is always = Task.width
            var balloonCss = {'max-width': balloonInfo.parentWidth + 'px'},
                balloonLeft = balloonInfo.isShared ? 'auto' : balloonInfo.parentLeft;

            // balloonTip.width is larger than Task.width. 
            // it follows that: The horizontal position (left/right) is always = 0
            if (balloonInfo.parentWidth > balloonInfo.balloonTipWidth) {
                // centering $balloonTip by $hotword center
                balloonLeft = (balloonInfo.hotwordLeft + balloonInfo.hotwordWidth/2) - balloonInfo.balloonTipWidth/2 ;
               
                // if runs off to the right abroad Task
                if (balloonInfo.balloonTipWidth + balloonLeft > balloonInfo.parentWidth + balloonInfo.parentLeft) {
                    balloonLeft = balloonLeft - ((balloonInfo.balloonTipWidth + balloonLeft)-(balloonInfo.parentWidth + balloonInfo.parentLeft));
                }
                
                balloonLeft = balloonInfo.isShared ? balloonLeft : balloonLeft - balloonInfo.balloonTipFactor;

                if (this.cfg.direction == 'rtl' && !balloonInfo.isShared) {
                    balloonLeft = balloonLeft - jQuery('.sequence_shared').outerWidth();
                } 
                // if runs off to the left abroad parent
                balloonLeft = parseInt(balloonLeft < 0 ? balloonInfo.balloonTipFactor : balloonLeft);
            }

            balloonCss.left = balloonLeft + 'px';
            
            // step left, step right, is counted as an attempt to escape: execution on the place :)
            balloonInfo.$balloonTip.css(balloonCss); // Shooting !!!!!!!!!!!
        },

        /**
         * showMultiNarrationBalloon
         * @param narrationObject
         * @param dataElement
         * @param show {Boolean}
         */
        showMultiNarrationBalloon : function(narrationObject, dataElement, show) {
            var thi$ = this;

            if (show) {

                var firstLang = {}, secondLang = {}, $dataElement = jQuery(dataElement);
                // get first narration conf
                firstLang.src = $dataElement.attr('firstLangNarrationSrc');
                firstLang.text = $dataElement.attr('firstLangText');

                // get second narration conf
                secondLang.src = $dataElement.attr('secondLangNarrationSrc');
                secondLang.text = $dataElement.attr('secondLangText');

                // build multi narration element from template
                var multiEle = jQuery(multiNarrationTemplate);
                jQuery(dataElement).prepend(multiEle);

                /**
                 * set multiNarrationBalloon data object
                 * @type {Object}
                 */
                this.multiNarrationBalloonData = {
                    narrationObject : narrationObject,
                    firstLang : firstLang,
                    secondLang : secondLang,
                    multiEle: multiEle
                };

                // anumate multi narration balloon
                multiEle.animate({
                    width: '110px',
                    opacity: 1
                }, 500, function() {
                    // Animation complete.
                });

                // bind control and buttons events
                this.startMultiControl(multiEle.find('#control'));
                this.startMultiButton(multiEle.find('#first'), firstLang, true);
                this.startMultiButton(multiEle.find('#second'), secondLang, false);

            } else {
                // on show(false), animate multi narration balloon destruction
                this.multiNarrationBalloonData.multiEle.animate({
                    width: '34px',
                    opacity: 0
                }, 500, function() {
                    // Animation complete.
                    jQuery(this).remove();
                });

                // set multi narration destruction objects
                this.toggleNarrationIndicator(this.multiNarrationBalloonData.narrationObject, 'narPlay');
                this.multiNarrationBalloonData.narrationObject.ele.trigger('mouseout');
                this.multiNarrationBalloonData = null;
            }
        },

        /**
         * startMultiControl
         * @param control
         * bind click event to multi nattarion control (stop)
         */
        startMultiControl : function(control) {
            // reference
            var thi$ = this;
            // insert control element to multi narrztion balloon data
            this.multiNarrationBalloonData.controlElenemt = control;

            /**
             * @event mousedown
             * bind mousedown event on multi nattarion control
             */
            control.mousedown(function() {
                jQuery(this).addClass('playIcon');
                thi$.showMultiNarrationBalloon('', '', false);
            });
        },

        /**
         * startMultiButton
         * @param container
         * @param langObj
         * @param autoplay
         */
        startMultiButton : function(container, langObj, autoplay) {
            // reference
            var thi$ = this;
            // reset nextToPlay indicator
            this.multiNarrationBalloonData.nextToPlay = false;

            // init sound button
            var soundObject = new thi$.mediaPlayerClass(copy({}, {
                parent: container,
                type: 'soundButton',
                src: langObj.src,
                text: langObj.text,
                autoplay: autoplay,
                onRendered : function() {
                },

                dummyMode: thi$.cfg.dummyMode
            }));
            // enable sound button
            soundObject.setEnabled(true);

            // bind new events
            /**
             * @event mousedown
             * bind mousedown event on sound button
             */
                // on clicking the multi narration, set nextToPlay = true
            soundObject.bindEvent('mousedown', 'content', function() {
                thi$.multiNarrationBalloonData.nextToPlay = !!soundObject.view.isStopped();
            }, '');
            /**
             * @event pause
             * bind pause event on audio
             */
            soundObject.bindEvent('pause', 'audio', function() {
                // if the multi narration clicked, reset indicator
                if (thi$.multiNarrationBalloonData.nextToPlay) {
                    thi$.multiNarrationBalloonData.nextToPlay = false;
                    // else, trigger control mousedown
                    // logic: if nextToPlay, don't close the multi narration, because one of the narration
                    // on the multi narration is about to play.
                    // if !nextToPlay, close the multi narration, because the nextToPlay is not relate to this multi narration
                } else {
                    thi$.multiNarrationBalloonData.controlElenemt.trigger('mousedown');
                }
            }, '');
        },

        /**
         * fontSizeToImgSize
         * @param fontSize
         * @return int
         */
        fontSizeToImgSize : function(fontSize) {
            return (Math.ceil(fontSize * constants.fontSizeToImgSizeFactor));
        },

        /**
         * narrationBGexists
         * @param soundContainerData
         * @return {Boolean}
         */
        narrationBGexists : function(soundContainerData) {
            return !!this.narrationIndicator[soundContainerData.id] && !!this.narrationIndicator[soundContainerData.id].nar;
        },

        /**
         * toggleNarrationIndicator
         * @param soundContainerData
         * @param key
         * @param forceFalse - on true, force narrationIndicator to be false
         */
        toggleNarrationIndicator:function (soundContainerData, key, forceFalse) {
            // on fix narration postion, textViewer doesnt draw narration background, therefore there isn't narration indicator
            if (!!!this.fixNarrationPosition) {
                if (!!this.narrationIndicator[soundContainerData.id]) {
                    this.narrationIndicator[soundContainerData.id][key] = (forceFalse ? false : !this.narrationIndicator[soundContainerData.id][key]);
                }
            }
        },

        /**
         * show or hide narration background
         * @param soundContainerData
         * @param show
         */
        showNarration : function(soundContainerData, show) {
            // on fix narration postion, dont show narration background
            if (!!this.fixNarrationPosition) return;

            if (show) {
                this.narrationIndicator[soundContainerData.id].nar.show();
            } else {
                this.narrationIndicator[soundContainerData.id].nar.hide();
            }
        },

        /**
         * drawNarrationBG
         * @param soundContainerData
         * @param draw
         * @param textViewerNarration
         */
        drawNarrationBG : function(soundContainerData, draw, textViewerNarration) {

            // on fix narration postion, dont draw narration background
            if (!!this.fixNarrationPosition) return;

            var paragraphDiv;

            // select paragraph div by textViewerNarration flag
            // on false, select the paragraph div that wrap the sound element
            // on true, select the first paragraph div
            if (textViewerNarration) {
                paragraphDiv = this._content.find('div[class=textViewerParagraph]')[0];
            } else {
                paragraphDiv = jQuery(soundContainerData.ele).parents('.normal');
                if (!paragraphDiv.length) {
                    paragraphDiv = jQuery(soundContainerData.ele).parents('.textViewerParagraph');
                }
            }

            var paragraphDivData = this.getEleData(paragraphDiv);

            // draw 1st background
            var nar = {};
            // on textViewerNarration, the nar height will be the _content.height. else, set the paragraph div height
            nar.height = textViewerNarration ? this._content.height() : paragraphDivData.height;
            nar.width = textViewerNarration ? this._content.width() : paragraphDivData.width;
            var chckSoundContainerPosition = (this.cfg.direction == 'ltr') ? (soundContainerData.left + soundContainerData.width) : (soundContainerData.right + soundContainerData.width);
            if ( chckSoundContainerPosition <= paragraphDivData.width && (nar.height/this.fontSize) <= 2 ) {
                nar.width = (this.cfg.direction == 'ltr') ? (soundContainerData.right - paragraphDivData.left) : (paragraphDivData.right - soundContainerData.left);
            }
            //nar.ele = jQuery('<div/>', {width: nar.width + 'px', height: nar.height + 'px'}).addClass('narration').insertBefore(jQuery(paragraphDiv));
            if (textViewerNarration){
	            var tmpElem = document.createElement('div');
	            tmpElem.className = 'narration';
	            tmpElem.style = {width: nar.width + 'px', height: nar.height + 'px'};
	            paragraphDiv.parentNode.insertBefore(tmpElem, paragraphDiv);

                nar.ele = jQuery(tmpElem);
	            tmpElem = null;
            } else {
                // nar.ele = jQuery(paragraphDiv).addClass('narrationSpan');//, {width: nar.width + 'px', height: nar.height + 'px'}
                var styleObj = {
                    width: nar.width + 'px', 
                    height: nar.height + 'px',
                    top: 0+ 'px'
                };
                styleObj[this.cfg.direction == 'ltr'? 'left' : 'right'] = 0+ 'px';
                nar.ele = jQuery('<span/>').css(styleObj).addClass('narration').insertBefore(jQuery(paragraphDiv).find('.narrationSpecialWrapper'));
            }
            // register narration
            this.registerNarrationAdd(soundContainerData, paragraphDivData, nar.ele);
        },

        /**
         * register narration to narrationIndicator
         * @param soundObject
         */
        registerNarration : function(soundObject) {
            this.narrationIndicator[soundObject.view.cfg.id + '_content'] = {
                'soundObject' : soundObject
            };
        },

        /**
         * add params to narration indicator object
         * @param soundContainerData
         * @param paragraphDivData
         * @param nar
         */
        registerNarrationAdd : function(soundContainerData, paragraphDivData, nar) {
            this.narrationIndicator[soundContainerData.id] = {
                'soundContainerData' : soundContainerData,
                'paragraphDivData'     : paragraphDivData,
                'nar'                  : nar,
                'narShow'              : true,
                'narPlay'             : false
            };
        },

        /**
         * set element data to one object
         * @param ele
         * @return element data object
         */
        getEleData : function(ele) {
            var res = {};
            res.ele = jQuery(ele);
            res.height = res.ele.height();
            res.width = res.ele.width();
            res.top = res.ele.offset().top;
            res.bottom = res.top + res.height;
            res.left = res.ele.offset().left;
            res.right = res.left + res.width;
            res.id = res.ele.attr('id');
            return res;
        },

        /**
         * narrate
         * calls from presenter.
         * narrate the last narration, on done call the callback
         * @param callback
         */
        narrate : function(callback) {
            // ref
            var thi$ = this;

            // narrate only if there is 'lastNarration'
            // on false, there is no narration in current textViewer
            if (this.lastNarration){
                // bind one event for callback
                this.lastNarration.bindEvent('pause', 'audio', callback, 'one');

                // narrate after 2 sec.
                setTimeout(function() {
                    thi$.lastNarration.view._content.trigger('mouseover');
                    thi$.lastNarration.view._content.trigger('mousedown');
                }, 2000);
            }
        },

        /**
         * compact
         * on compact textViewer, set aspect ratio 2/3
         */
        compact: function() {
            this._super();
            if(this.checkMathField !== true){
                this.ratioResize('2/3');    //TODO: check for this function impact on subanswer sizing
            }
        },

        /**
         * ovveride
         * on loose text viewer, loose it's size
         */
        loose : function() {
            this._view.width('').height('');
        },

        /**
         * on reduction, set reduced font-size
         * @param val*
         */
        reduce : function(val) {
            var reducedFontSize = this.calcFontSizeByReduction(val);
            this._view.css('font-size', reducedFontSize + 'px');
            this.dispatchEvent('onRendered');
        },

        /**
         * spaceEaterAddWidth
         * @param addWidth
         */
        spaceEaterAddWidth : function(addWidth) {
            var width = this._view.outerWidth() + addWidth;
            this.looseHeight();
            this.setWidth(width);
        },

        /**
         * calc font size by reduction value, and apply abs. min when require
         * @param val
         * @return {Number} reduced font size
         */
        calcFontSizeByReduction : function(val) {
            if (!this.isMinimunReadable && this.optimumFontSize != undefined) {
                //incase of small optimum font size (image credit, image caption) don't perform reduction
                if (this.optimumFontSize < this.minimumReadableFontSize) {
                    this.dispatchEvent("cantReduce");
                    return null;
                }
                // if val == null set val = 1 in case this.cfg.reductionStep = 0
                var reductionValue = parseInt((this.cfg.reductionStep > 0) ? 0 : ((val != undefined && val > 0) ? val : 1));
                // add the val to the current reductionStep
                this.reductionStep = this.reductionStep + reductionValue;
                // calc font size by reductionStep
                this.setFontSize = (Math.floor((this.optimumFontSize - (this.reductionStep * this.reductionStepSize)) / 2)) * 2;
                // if fontSize is less then fontSizeMinReadable
                if (this.setFontSize <= this.minimumReadableFontSize) {
                    // set fontSize = minimumReadable (not less)
                    this.setFontSize = this.minimumReadableFontSize;
                    // min readable flag
                    this.isMinimunReadable = true;

                    this.dispatchEvent("cantReduce");

                    // get char sum and apply abs. min. on charSum > 20
                    var charSum = this._view.text().length;

                    // if absolute minimum if apply
                    if (!!this.applyAbsoluteMinimum && !this.isAbsoluteMinimum && charSum > 20) {
                        // set the markup for a number of chars + '...'
                        var absMinMarkup = this._view.text().trim().substring(0, constants.absMinStrLen) + '...';

                        this._view.html(absMinMarkup);

                        // set absoluteMinimum flag = true
                        this.isAbsoluteMinimum = true;
                        // let the textViewer's presenter know that you'r on absoluteMinimum
                        this.dispatchEvent("onAbsMin", this);
                    }
                }
                return this.setFontSize;
            }
        },

        /**
         *
         * @return {Object}
         */
        getReductionReport: function() {

            var percent = ( this.setFontSize == undefined ) ? 1 : this.setFontSize / this.optimumFontSize,
                belowRead = !!this.isMinimunReadable,
                belowAbs = !!this.isAbsoluteMinimum
                ;

            var _elm = (this._view)[0];
            var _hasScrollBar = false;

            var overV = ( _elm.clientWidth < _elm.scrollWidth ) ;
            var overH = ( _elm.clientHeight < _elm.scrollHeight ) ;

            return {
                percent: percent,
                belowRead: belowRead,
                belowAbs: belowAbs,
                overflowV: overV,
                overflowH: overH,
                overflow: overH || overV
            };
        },

        /**
         * ratioResize
         * resize textViewer by aspect ratio
         * @param ratio - string: 'x/y'
         */
        ratioResize: function(ratio) {
            var ratioWidth = parseInt(ratio.split('/')[0]);
            var ratioHeight = parseInt(ratio.split('/')[1]);

            var width = this._view.width();
            var height = this._view.height();

            if((width < constants.minWidthForAspectRatioResize[ENV.locale]) || (height == 0)) {
                return;
            }

            var totalArea = width * height;

            var unit = Math.ceil(Math.sqrt(totalArea / (ratioWidth * ratioHeight)));
            var ratioTextViewerWidth = unit * ratioWidth;

            // if the width is larger than the minimum width for aspect ratio resize, set it.
            ratioTextViewerWidth = ratioTextViewerWidth > constants.minWidthForAspectRatioResize[ENV.locale] ? ratioTextViewerWidth : constants.minWidthForAspectRatioResize[ENV.locale];
            this.setWidth(ratioTextViewerWidth);
        },

        /**
         *
         * @param size
         */
        resize : function(size){
            this.setWidth(Math.ceil(size.width));
        },

        /**
         * setWidth
         * @param val
         * @param overwriteLaydownSize- ignore the value in laydownsize and use the new value 
         */
        setWidth : function(val, overwriteLaydownSize) {
            // laydown size will be the the maximal width
            if (!!this.laydownSize && !overwriteLaydownSize)
                val = (val > this.laydownSize.width) ? this.laydownSize.width : val;

            if (val == 0) return;

            this._view.width(Math.ceil(val));
        },

        /**
         * spaceEatingAvailable
         * check if space eating is available
         * @return {Boolean}
         */
        spaceEatingAvailable : function() {
            return this.laydownSize.width > (Compat.fullOuterWidth(this._view));
        },

        /**
         * setHeight
         * @param val
         */
        setHeight : function(val) {
            val = val - (this._view.css('margin-top').px2int()) - (this._view.css('margin-bottom').px2int());
            this._view.height(val);
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/textViewer/TextViewerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textViewer/TextViewer.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.textViewer.TextViewer
     * @desc A textViewer Presenter component class
     * @namespace t2k.component.textViewer
     * @extends t2k.component.BaseComponent
     * @type {Object}
     */
    t2k.component.textViewer.TextViewer = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.textViewer.TextViewer',
        
        /**
         * text viewer - ctor
         * @param config
         */
        ctor: function(config) {
            // Delegate            	
            this._super(config);
            /**
             *
             * @type {Array}
             */
            this.textViewerChildren = [];
            
            this.initLayout();
            this.initView(); 
            this.addChildren();
        },
        
        /**
         * initLayout
         * initLayout params
         */
        initLayout : function(){
        	
        	if (!this.layout.onRendered){
            	this.layout.onRendered = function(){};
            }

            /**
             * @property
             * @type {Number}
             */
        	this.layout.numOfChildren	  = 0;
            /**
             * @property
             * @type {Number}
             */
        	this.layout.onRenderedCounter = 0;
            /**
             * @property
             * @type {Boolean}
             */
        	this.layout.firstRender 	  = true;
        },
        
        /**
         * initView
         * init view and register view presenter events
         */
        initView : function(){
        	
        	var thi$ = this;

            /**
             *
             * @type {Object}
             */
        	this.view = this.createNewView(t2k.component.textViewer.TextViewerView, (merge(this.prepareTextViewerConfiguration(), {
            	events:{
            		/**
            		 * onAbsMin
            		 * calls if textViewer reduced to abs. min.
            		 * abs. min. reduction is possible only on applyAbsoluteMinimum[configuration] flag true
            		 */
            		onAbsMin : function(){
            			thi$.cfg.onAbsMin();
            		},
            		
            		/**
            		 * childSum
            		 * calls when view finished parsing it's children.
            		 */
            		childSum : function(val){
            			thi$.layout.numOfChildren = val;
            		},
            		
            		/**
            		 * childRendered
            		 * calls on view's children render (one child at a time)
            		 */
            		childRendered : function(view){
            			thi$.layout.onRenderedCounter++;
            		},
            		
            		/**
            		 * onTextViewerChildrenRendered
            		 * view calls this event if it's a widower
            		 */
            		onTextViewerChildrenRendered : function(view){
            			thi$.textViewerChildrenRendered(view);
            		},
            		
            		/**
            		 * addChild
            		 * calls from view, to add the child to the presenter & view.
            		 * the child first pushed to textViewerChildren array, and later to this.children array
            		 */
            		addChild : function(args){
            			thi$.textViewerChildren.push(args.child);
            			args.view.addChild(args.child);
            		}
            	}
            })));       	
        },     
        
        /**
         * addChildren
         * adds textViewerChildren children to this.children
         */
        addChildren : function(){
        	// ref
        	var thi$ = this;
        	
        	jQuery(this.textViewerChildren).each(function(index, child){
        		thi$.add(child);
        	});
        },
        
        /**
         * this function calls from view's event on all children rendered.
         * @param view
         */
        textViewerChildrenRendered : function(view){
        	
        	view = view ? view : this.view;
        	
        	// on first (full) rendering, save the laydown size
        	if (this.layout.firstRender){
        		this.layout.laydownSize = view.laydownSize = view.getSize();
        		this.layout.firstRender = false;
        	}
        	
        	// call the view function for last actions and onRendered dispatch
        	view.textViewerChildrenRendered();
        },
        
        /**
         * prepareTextViewerConfiguration
         * @returns config
         */
        prepareTextViewerConfiguration : function(){            	
        	return _prepareTextViewerConfiguration(this.cfg);            	
        },

        /**
         *
         * @param val
         */
        reduce : function(val){
        	this._super(val);
        	this.writeCompiled('fontsize', this.view._view.css('font-size').px2int());
        },

        /**
         *
         * @param compiledElement
         */
        readCompiled_Private : function(compiledElement){
        	this.compiledLayoutRes.fontsize = compiledElement.attr('fontsize');
        },
        
        /**
         * calls from parent composite. view will narrate the last narration and will call the callback
         * @param callback
         */
		narrate : function(callback){
			this.view.narrate(callback) ;
			this.layout.onRendered();
		},
		
		/**
		 * setEnabled
		 * check autoPlay and narrate
		 * @param flag
		 */
		setEnabled : function(flag){
            // empty this.children
			var temp = this.children;
            this.children = [];
			this._super(flag);

            // set this.children
            this.children = temp;
			
			if( this.cfg.autoplay && !!!this.cfg.dummyMode && flag) {
	        	this.narrate(function(){});
			}
			
		},
		
		/**
		 * resize textViewer to aspect ratio
		 * @param ratio - aspect ratio:  Number/Number*
		 */
		ratioResize : function(ratio){
			// default aspect ratio
			ratio = ratio ? ratio : '2/3';
			this.view.ratioResize(ratio);
			this.layout.onRendered();
		},
		
		/**
		 * spaceEaterAddWidth
		 * @param widthAdd
		 */
		spaceEaterAddWidth : function(widthAdd){
			this.view.spaceEaterAddWidth(widthAdd);
		},
		
		/**
		 * spaceEatingAvailable
		 * @returns {Boolean}
		 */
		spaceEatingAvailable : function(){
			return this.view.spaceEatingAvailable();
		},

	    dispose : function() {
		    if (!!this.textViewerChildren) {
			    this.textViewerChildren.forEach(function (child) {
				    child.view.dispose();
				    child.dispose();
				    delete child;
			    });
			    this.textViewerChildren = null;
		    }

		    this._super();
	    }
		
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private:
     * Function: _prepareTextViewerConfiguration
     * Extract the text viewer configuration from the xml
     *
     * Parameter:
     *  param - {XML} taskXml The task's configuration XML.
     *  param - {ID} parent id
     *
     * Returns:
     *  {Object} t2k.component.textViewer.TextViewerParams that contains text viewer parameters.
     */
    function _prepareTextViewerConfiguration(cfg) {

    	// The result object.
    	var result;
    	var textViewerElement = cfg.data; 

    	if (textViewerElement){
	    	var textViewerMarkup = jQuery.xmlToString(cfg.data) || "",
                textViewerMarkupLenght = textViewerMarkup.length,
                tmp = (textViewerMarkup.substring(1,textViewerMarkup.indexOf('>'))).split(" "),
                textViewerTagName = (tmp[0].toString() != 'p') ? tmp[0].toString():"";

    		textViewerMarkup = textViewerMarkup.substring(
	    	textViewerMarkup.indexOf('>') + 1, textViewerMarkupLenght - textViewerTagName.length - 3);

	    	var textViewerParam = new t2k.component.textViewer.TextViewerParams();
	    	textViewerParam.id 					= genId();
            /**
             * @cfg {string} width The width of textViewer
             */
	    	textViewerParam.width 				= cfg.width ? cfg.width : '';
	    	textViewerParam.height 				= '';
            /**
             * @cfg {string} initMarkup
             */
	    	textViewerParam.initMarkup			= textViewerMarkup;
            /**
             * @cfg {string} style textView class name
             */
	    	textViewerParam.style 				= cfg.style || jQuery(textViewerElement).attr('style') || ENV.textViewer.style;
            /**
             * @cfg {Object} parent
             */
	    	textViewerParam.parent 				= cfg.parent;
            /**
             * @cfg {Boolean} parentIsObject
             */
	    	textViewerParam.parentIsObject		= false;
            /**
             * @cfg {String} direction
             */
	    	textViewerParam.direction 			= jQuery(textViewerElement).attr('direction') || ENV.contentDirection;
            /**
             * @cfg {String} textAlign
             */
	    	textViewerParam.textAlign 			= textViewerParam.direction == 'ltr' ? 'left' : 'right';
	    	// useSideBar: CR
            /**
             * @cfg {Boolean} useSideBar
             */
	    	textViewerParam.useSideBar			= eval(jQuery(textViewerElement).attr('useSideBar') || ENV.textViewer.useSideBar);
            /**
             * @cfg {Boolean} enableTextSelection
             */
	    	textViewerParam.enableTextSelection = jQuery(textViewerElement).attr('enableTextSelection') || ENV.textViewer.enableTextSelection;
            /**
             * @cfg {String} language
             */
	    	textViewerParam.language			= jQuery(textViewerElement).attr('language') || ENV.interfaceLanguage;
	    	//textViewerParam.baloonStyle			= jQuery(textViewerElement).attr('baloonStyle') || ENV.textViewer.baloonStyle;
            /**
             * @cfg {string} lineHeightConfig The line-height config of textViewer
             */
	    	textViewerParam.lineHeightConfig 	= cfg.lineHeightConfig || jQuery(textViewerElement).attr('lineHeightConfig') || ENV.textViewer.lineHeightConfig;
            /**
             * @cfg {String} setMaxWidth
             */
	    	textViewerParam.setMaxWidth		 	= jQuery(textViewerElement).attr('setMaxWidth') || cfg.setMaxWidth;
            /**
             * @cfg {string} fixNarrationPosition
             */
	    	textViewerParam.fixNarrationPosition= cfg.fixNarrationPosition || jQuery(textViewerElement).attr('fixNarrationPosition');
            /**
             * @cfg {XML} data
             */
	    	textViewerParam.data = cfg.data;
            /**
             * @cfg {Number} additionLineHeight
             */
	    	textViewerParam.additionLineHeight  = cfg.additionLineHeight || 0;
            /**
             * @cfg {string} applyAbsoluteMinimum
             */
	    	textViewerParam.applyAbsoluteMinimum= cfg.applyAbsoluteMinimum || jQuery(textViewerElement).attr('applyAbsoluteMinimum');
            /**
             * @cfg {Number} reductionStep
             */
	    	textViewerParam.reductionStep = cfg.reductionStep ? cfg.reductionStep : 0;
            /**
             * @cfg {Number} optimumFontSize
             */
	    	textViewerParam.optimumFontSize = cfg.optimumFontSize ? cfg.optimumFontSize : null;	    	
	    	
	        // set the result.
	    	result = textViewerParam;
	    } else {
	    	result = null;
	    }

    	return merge(result, cfg);

    } // End of prepareTextViewerConfiguration

})();
////////////////////////////////////////
// SRC End --> t2k/component/textViewer/TextViewer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subAnswer/SubAnswerConfig.js
////////////////////////////////////////
/**
 * SubAnswer component constants
 */
t2k.component.subAnswer.SubAnswerConstants = {
		dndBehaviour : {
			
			dragAndDrop : {
				startDraggingEvent : 'mousedown',
				droppingEvent : 'mouseup',
				draggingEnter : 'mouseenter',
				draggingLeave : 'mouseleave',
                mouseMove : 'mousemove'
			},
			
			clickAndDrop : {
				startDraggingEvent : 'click',
				droppingEvent : 'click',
				draggingEnter : 'mouseenter',
				draggingLeave : 'mouseleave',
                mouseMove : 'mousemove'
			},

            touchAndDrop : {
                startDraggingEvent : 'touchstart',
                droppingEvent : 'touchend',
                draggingEnter : 'touchmove',
                draggingLeave : 'touchend',
                mouseMove : 'touchmove'
            }
		},
			
		dndModes : {		
			
			dragAndCopy : {
				droppable : false,
				draggable : true,
				afterDrag : 'draggable,markSourceAsReusable',
				afterDrop : 'checkAndReturn',
                beforeDrop : ''
			},

			dragAndDisable : {
				droppable : false,
				draggable : true,
				afterDrag : 'disable',
				afterDrop : 'checkAndReturn',
                beforeDrop : ''
			},

			dragAndDropAndReplaceAndReturn : {
				droppable : true,
				draggable : false,
				afterDrag : 'dropabble,delete',
				afterDrop : 'draggable,dropabble,checkAndReturn',
                beforeDrop : ''
			},

            dragAndDropNoReplace : {
                droppable: true,
                draggable: false,
                afterDrag: 'dropabble,delete',
                afterDrop: 'draggable,dropabble,checkAndReturn',
                beforeDrop : 'checkIfDroppableNoReplace'
            },

            dragAndDropAndReplace : {
                droppable: true,
                draggable: true,
                afterDrag: 'dropabble,delete',
                afterDrop: 'draggable,dropabble,checkAndReturn',
                beforeDrop : ''
            },

            dragAndDropToMultiAnswer : {
                droppable: false,
                draggable: true,
                afterDrag: 'deleteSubAnswer',
                afterDrop: 'checkAndReturn',
                beforeDrop : ''
            }

		},

		ignoreChecking : {
			'capitalLetters' : function(value) { //Capital letters
				return value.toLowerCase();
			},
			'spacesBetweenTwoCharacters' : function(value) { //Spaces between two characters
				return value.replace(/\s/g, '');
			},
			'accents' : function(value) { //Accents
				var accentsMap = LocaleUtil.getAccentsMap();

				if(accentsMap) {
					accentsMap.forEach(function(item, index){
						if(item.accent && item.accent.length) {
							item.accent.forEach(function(letter){
								value = value.replace(new RegExp(letter, 'g'), item.replacement);
							})
						}
					});
				}
				return value;
			},
			'punctuationMarks' : function(value){ //Punctuation marks
				return value.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g, '')
			},
			'' : function(value) {
				return value;
			}

		},
		
		paddingFactor : 0.1,             // factor of div.subanswer padding
		heightWrapperExpansion  : 1,     // Expansion of div wrapper height
        lineHeightBorderExpansion  : 6,
		heightFactorWrite: 1.15,      
		lineHeightFactor: 0.66,
        timeoutAnimationSec : 200,
        timeoutFadeOutSec : 100,
		draggedObjectOffset : (ENV.behaviors.isTablet ? 30 : 20),
		dtpAppOffset: {top:120 , left: 60 },
		widthHeightExpansion : 2,
		hintOffsetBottom : 3,
		hintOffsetBottomWrite : 6,		
		widthHeightExpansionWrite: 7,
		appendCloneSelector: 'div.player',
		scrollableSelector: 'div.scroll_enabled',
		mathFieldHeight: '2.3em',
		additionalWidthFactor : 1.3
};
////////////////////////////////////////
// SRC End --> t2k/component/subAnswer/SubAnswerConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subAnswer/SubAnswerView.js
////////////////////////////////////////
var tempFnc, tempFnc2;

(function() {
    /**
     * @class t2k.component.subAnswer.SubAnswerView
     * @desc A subAnswer View class
     * @namespace t2k.component.subAnswer
     * @extends t2k.component.BaseComponentView
     * @type {Object}
     */

    var TEMPLATE =
        "<div class='subAnswer' id='{{id}}' >\
        	<div class='subAnswer_content_wrap'>\
        		{{#checkable}}" +
        		"<div class='status_icon'></div>\
        		<div class='subAnswer_content' id={{id}}_content></div>\
        		{{/checkable}}" +
        		"{{^checkable}}" +
        			"<div class='subAnswer_content' id={{id}}_content></div>" +
        		"{{/checkable}}" +
        	"</div>\
        </div>";

    /**
     * @private
     * @name defaultConfig
     * @desc Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.
    
    // constants from SubAnswerConstants
	var constants = t2k.component.subAnswer.SubAnswerConstants;

    t2k.component.subAnswer.SubAnswerView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @desc constructor, see superclass documentation
         */
        ctor: function(config) {
            // Delegate.        	
            this._super(override(config, defaultConfig));

            /**
             * @property
             * @type {*}
             */
            this.insertBefore = this.cfg.insertBefore;

            /**
             * @property
             * @type {*}
             */
            this._content = this._view.find('.subAnswer_content');

            /**
             * @property
             * @type {Object}
             */
            this.hintObj = {};   //hint object

            /**
             * @desc draggable clone of subAnswer content
             * @type {*}
             */
            this.draggedElement = null;

            /**
             *
             * @type {Number}
             */
            this.childReductionStep = 0;

            /**
             *
             * @type {Number}
             */
            this.childOptimumFontSize = 0;
            
            if(!!this.cfg.registerEvents){
            	this.bindDNDEvents(this.cfg.registerEvents);            	
            }

            /**
             *
             * @type {String}
             */
             this.draggElementClass = ((this.cfg.taskmode == "matching" || this.cfg.taskmode == "sorting" ||
                                        this.cfg.taskmode == "sequencing") ? 'inDragMtq' : 'inDrag');

            /**
             * When animating, user should not be able to catch and drag the image.
             * Default browser behaviour is confusing in this case.
             */
            this.draggElementClass += ' not_draggable';
	        dndManager.draggElementClass = this.draggElementClass;

            var thi$ = this;

            /**
             * @desc document mouse move handler
             */

            this.mmFunctionHandler = function (event) {

	            tempFnc = setTimeout(function () {
		            clearTimeout(tempFnc);
		            thi$.mouseMoveHandler(event);
	            }, 20);


	            clearTimeout(tempFnc2);

            };

            /**
             * @desc document key down handler, prevent viewport scrolling while dragging
             * @param event
             */
            this.keyDownHandler = function (event) {
                cancelEvent(event);
            };

            dndManager.inDragObjectView = null;
            dndManager.isOverBank = false;

	        globalEvents.add({
		        fnc: function(){
			        thi$._initHint();
		        }
	        });

        },
        
        /**
         * @name setEnabled
         * @param flag
         */
        setEnabled : function(flag){
        	this._super(flag);

        	// children's setEnabled
            this.children.forEach(function(child) {
            	child.setEnabled(flag);
            });

            if(!flag) {
                this.markAsNotDraggable();
                this.markAsNotDroppable();
            } else {
	            var thi$ = this;

	            if(thi$.cfg.taskViewDomElement) { //scroll task with draggable object
		            thi$.taskView = thi$.cfg.taskViewDomElement;
		            thi$.bankView = thi$.taskView.find('.mtqBank');
		            thi$.scrollableDiv = jQuery(constants.scrollableSelector);
	            }
            }
        },

        /**
         * @name render
         * @param element
         * @param template
         * @param context
         */
        render : function(element, template, context) {
        	if (!!context.insertBefore){
        		var subAnswerHtml = Mustache.to_html(template, context);
        		jQuery(subAnswerHtml).insertBefore(context.insertBefore);
        		
        	} else if (!!context.insertAfter ){
        		var subAnswerHtml = Mustache.to_html(template, context);
        		jQuery(subAnswerHtml).insertAfter (context.insertAfter );

        	} else {
        		this._super(element, template, context);
        	}
        }, // End of render

        /**
		 * @name _initMarkupForEmptySA
		 * @desc markup initialization
		 */
        _initMarkupForEmptySA : function(){
            if(!this._content.html()){
                return;
            }

			if(this._content.html().length == 0){
				var divTagElement = jQuery('<div/>').css('display','inline-block');
				this._content.append(divTagElement);
			}
		},

        /**
         * @namne setStyleByChild
         * @param childName
         */
        setStyleByChild : function(childName) {
            this._view.addClass(childName);
        },

        /**
         * @name getElementSize
         * @return {'width': Int, 'height': Int}
         */
        getElementSize:function () {
           return this.getSize();
        },

	    getInnerSize: function() {
		    if (this.children.length && this.children[0].adjustContentStyle) { //only for MF child
			    this.children[0].adjustContentStyle();
		    }

		    if (this.children.length) {
			    return this.children[0].getSize();
		    } else {
			    return null;
		    }
	    },
        /**
         * @name setElementSize
         * @param elementSizes
         */
         setElementSize: function(elementSizes){
            this._view.height(elementSizes.height);
            this._view.width(elementSizes.width);
            this._content.height(elementSizes.height);
            this._content.width(elementSizes.width);

            var thisFontSize = parseInt(this._view.css('font-size').replace('px','') );
            var divWrapper = Perf.select('#' + this.cfg.id + ' div.subAnswer_content_wrap');
            divWrapper.height(elementSizes.height);

        	this._view.css('line-height', elementSizes.height - constants.lineHeightBorderExpansion + 'px');
        },
        /**
         * @name resetElementSize
         */
        resetElementSize : function() {
            this._view.height('').width('');
            this._view.css('line-height', '');
            this._content.width('').height('');
            this._content.parent().width('').height('');
        },
        /**
         * @name resetTile
         * @desc override - this component has different resetTile logic
         */
        resetTile : function(){
            this.resetElementSize();
        },
        /**
         * @name looseWidth
         * @desc override - this component has different looseWidth logic
         */
        looseWidth :function () {
            this._view.width('');
            this._content.width('');
            this._content.parent().width('');
        },
        /**
         * @name looseHeight
         * @desc override - this component has different looseHeight logic
         */
        looseHeight : function(){
            this._view.height('');
            this._view.css('line-height', '');
            this._content.height('');
            this._content.parent().height('');
        },
        /**
         * @name setWidth
         * @desc override - this component has different setWidth logic
         * @param val {Number}
         */
        setWidth : function(val){
            var contentWrap = this._view.find('.subAnswer_content_wrap');
            contentWrap.width( Math.ceil(val) );
            this._content.width(val);
        },
        /**
         * @desc override - this component has different setHeight logic
         * @param val {Number}
         */
        setHeight : function(val){
            var contentWrap = this._view.find('.subAnswer_content_wrap');
            contentWrap.height(val);
            this._content.height(val);
        },

        /**
         * @desc loose override - this component has different loose logic
         */
        loose:function () {
            this._view.css({'display':'inline-block', 'vertical-align':'top'});
        },

        /**
         * @name getSize
         * @returns size {'width': Int, 'height': Int}
         */
        getSize : function(){
	        if (this.children.length && this.children[0].adjustContentStyle) { //only for MF child
		        this.children[0].adjustContentStyle();
	        }

	        var height = Compat.actualHeight(this._content);
	        var width = Compat.actualWidth(this._content);
	        return {'width':width, 'height':height};

        },

        /**
         * @desc adjust subAnswer height, padding and margin according to the font-size
         */
        setStyle : function(subAnswerSize){
            var thisFontSize = parseInt(this._view.css('font-size').replace('px', ''));
            var divWrapper = Perf.select('#' + this.cfg.id + ' div.subAnswer_content_wrap');

            if (!!subAnswerSize) {
                this._view.width(subAnswerSize.width);
                this._content.width(subAnswerSize.width);
                this._view.height(subAnswerSize.height);
                this._content.height(subAnswerSize.height);

                var divHeight = Math.floor(((subAnswerSize.height - thisFontSize) / 2 ) + thisFontSize) + constants.heightWrapperExpansion;
                divWrapper.height(divHeight);
                this._view.css('line-height', subAnswerSize.height + 'px');

            } else if (!this.cfg.parent.hasClass('cell')) {

	            var subAnswerHeight =
		            (!!this._content.children().length && (this._view.hasClass('texteditor') || this._view.hasClass('mathfield'))) ?
			            this._content.children().first().outerHeight(true) + constants.heightWrapperExpansion :
			            this._content.outerHeight(true);

	            var divHeight = Math.floor(((subAnswerHeight - thisFontSize) / 2 ) + thisFontSize);
	            divWrapper.height(divHeight);

                this._content.height(subAnswerHeight);
                this._view.css('line-height', subAnswerHeight + 'px');
            }

            if (this.cfg.mode != 'write') {
                this._content.addClass('shadow');
            }

        },
    	
    	/**
    	 * @desc replace subAnswer child with in dragg object
         * @param sourceElement
    	 */
    	replaceChild : function(sourceElement, sourceView) {

    		// get & empty content element
    		var subanswer_content = this._content;
			subanswer_content.html('');

			//set the cloned content element a new id
            var subanswer_content_id = subanswer_content.attr('id');

		    if (!sourceElement && !!dndManager.inDragObject) {
			    sourceElement = dndManager.inDragObject;
		    }

            //source element to create child -
            //in case of dragged object exists - use it
            //otherwise use bank source element
            var viewOfSourceElement = (sourceView ? sourceView : sourceElement.children[0].view._view.clone());

		    this.childReductionStep = sourceElement.children.length ?
			    sourceElement.children[0].view.reductionStep : sourceElement.cfg.reductionStep;
		    this.childOptimumFontSize = sourceElement.children.length ?
			    sourceElement.children[0].view.setFontSize : sourceElement.cfg.setFontSize;

		    var xmlSource = sourceElement.children.length ?
			                sourceElement.children[0].view.cfg.data : sourceElement.cfg.data.children[0];

            this.dispatchEvent('createChildren', {'xml' : xmlSource ,
	        'subanswer_content_id' : subanswer_content_id, 'width' : '', 'container' : this._content,
	        'childReductionStep' : this.childReductionStep, 'childOptimumFontSize' : this.childOptimumFontSize,
	        'viewOfSourceElement' : viewOfSourceElement, 'taskmode' : sourceElement.cfg.taskmode});
        },

    	/**
    	 * @desc remove subAnswer content
    	 */
    	 removeContent : function(){
            if (this.cfg.mode != 'write' && !!this.cfg.mode) {
                //DOM manipulations cancel touch javascript events
                //this._content.html('');
                dndManager.insertIntoRecycleBin(this._content.children());

                this._initMarkupForEmptySA();
            } else { //remove text editor markup
                if (this.children[0]) {
                    this.children[0].removeContent();
                }
            }
    	},
    	/**
    	 * @desc replace html content of subAnswer child with given parameter
    	 * @param htmlContent
    	 */
    	replaceContent : function(htmlContent){
    		if(this.cfg.mode != 'write' && !!this.cfg.mode){
        		this._content.html(htmlContent);
        		this._initMarkupForEmptySA();    			
    		} else { //replace text editor markup
    			if(this.children[0]){
    				this.children[0].replaceContent(htmlContent);	
    			}    			
    		}    		
    	},
    	/**
    	 * @desc get subAnswer value
    	 */
    	getValue : function(){
    		if(this.cfg.mode != 'write' && !!this.cfg.mode){
        		return jQuery.trim(this._content.text());
    		} else if(this.children[0]) {    			
    			return this.children[0].getValue();
    		} else {
    			return '';
    		}
    	},
        /**
         * @desc get subAnswer markUp value
         */
        getMarkUpValue : function(){
            if(this.cfg.mode != 'write' && !!this.cfg.mode){
        		return this._content.html();
    		} else if(this.children[0]) {
    			return this.children[0].getMarkUpValue();
    		} else {
    			return '';
    		}
        },

        /////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////// HINT //////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /**
         * @desc subAnswer hint initiation
         * @method
         */
        _initHint : function(){

	        if(!this.cfg) {
		        return;
	        }

        	var elHint = this.cfg.elHint;
        	if(elHint.text() != ''){
                Perf.select('#' + this.cfg.id + '_hint', 1).remove();  //remove old hint
        		
	        	var hintPosition = elHint.attr('position');
	        	if(hintPosition == 'undefined' || hintPosition == null){
	        		hintPosition = 'bottom';
	        	}
	        	
	        	this.hintObj.position = hintPosition;
	        	this.hintObj.textShort = '';
	        	
	        	//prepend div hint tag to the subAnswer tag        	
	        	this.subAnswerHint = jQuery('<div/>').attr('id',this.cfg.id + '_hint').addClass('hint');
	        	if(hintPosition == 'top'){
	        		this.subAnswerHint.prependTo(this._view);
	        	} else {
	        		this.subAnswerHint.appendTo(this._view);
	        	}          	
	        	
	        	this.subAnswerHint.text(elHint.text());       //set div hint tag html with the source html
	        	this.hintObj.textOriginal = this.subAnswerHint.text();
	        	
	        	this.subAnswerHint.addClass(ENV.contentDirection);   //append ltr/rtl class according to the environment direction
	        	
	        	var subAnswerWidth = Compat.fullOuterWidth(this._view);
	        	this.hintObj.hintWidth = this.subAnswerHint.outerWidth(true);
	        	
	        	var thi$ = this;
	        	
	        	if(this.hintObj.hintWidth > subAnswerWidth){        		
	        		var hintLength = this.subAnswerHint.text().length;    				
	        		var charWidth = (this.hintObj.hintWidth / hintLength);	        		
	        		var charsCount = Math.floor(subAnswerWidth / charWidth);        		
	        		var sofix = '...';	        	
	        		
	        		var shortText = (this.subAnswerHint.text().slice(0, charsCount - sofix.length));
	        		
	        		this.hintObj.textShort = shortText + sofix;        		
	        		this.subAnswerHint.width(subAnswerWidth).text(this.hintObj.textShort);        		
	        		
	        		this.hintBindAnimation(subAnswerWidth);        		    		
	        	}
	        	
	        	this.hintObj.hintHeight = parseInt(this.subAnswerHint.height());    //get the height of the hint tag
	        	if(hintPosition == 'top'){
	        		this.subAnswerHint.css('top', '-' + (this.hintObj.hintHeight) + 'px');   //set the top of the div hint tag according to his height	
	        	} else {

			        //in case of hint inside sub-answer add it's height
			        var viewHeight = this._view.height();
	        		this.subAnswerHint.css('top', (this._content.height() + constants.hintOffsetBottom) + 'px');

			        //add hint height to sub-answer height
			        this._view.height(viewHeight + this.hintObj.hintHeight);

	        	}
	        	
        	}
        },
        /**
         * @desc bind hover animation to the hint object (expand to its original width, reduce to the subAnswer width)
         * @param subAnswerWidth
         */
        hintBindAnimation : function(subAnswerWidth) {
        	var thi$ = this;        	
        	
        	this.subAnswerHint.hover(function() {
        		if((dndManager.inDragObject == null) && (thi$.subAnswerHint.text() != thi$.hintObj.textOriginal) ){
        			jQuery(this).css('z-index', '100').text(thi$.hintObj.textOriginal);
        			if(!jQuery(this).is(':animated')){
        				jQuery(this).stop().animate({width : thi$.hintObj.hintWidth}, 600, 'swing');	
        			}        			
        		}
        			        		
    		}, function() {
    			if((dndManager.inDragObject == null) && (thi$.subAnswerHint.text() != thi$.hintObj.textShort)){    				  
    				if(!jQuery(this).is(':animated')){ 					
        				jQuery(this).stop().animate({width: subAnswerWidth}, 600, 'swing', function(){    					
        					jQuery(this).text(thi$.hintObj.textShort);    					
        					jQuery(this).css('z-index', '0');
        				});
    				} 
    			}	
    		});
        },        
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////// DRAG AND DROP /////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////

        /**
         * @name mouseMoveHandler
         * @param event
         */
        mouseMoveHandler:function (event) {


            event.preventDefault();

            if(!!dndManager.animated()) {
                return false;
            }

            var thi$ = this, pageX = 0, pageY = 0;

	        //touches: A list of information for every finger currently touching the screen
            //changedTouches: A list of information for every finger involved in the event
            //When I lift a finger, it will be removed from touches, targetTouches and will appear in changedTouches since it’s what caused the event
            //Removing my last finger will leave touches and targetTouches empty, and changedTouches will contain information for the last finger
            if(!!event.pageX) {
                pageX = event.pageX;
            } else if(!!event.originalEvent && !!event.originalEvent.touches && !!event.originalEvent.touches[0]) {
                pageX =  event.originalEvent.touches[0].pageX;
            } else if(!!event.originalEvent && !!event.originalEvent.changedTouches && !!event.originalEvent.changedTouches[0]) {
                pageX = event.originalEvent.changedTouches[0].pageX;
            }

            if(!!event.pageY) {
                pageY = event.pageY;
            } else if(!!event.originalEvent && !!event.originalEvent.touches && !!event.originalEvent.touches[0]) {
                pageY =  event.originalEvent.touches[0].pageY;
            } else if(!!event.originalEvent && !!event.originalEvent.changedTouches && !!event.originalEvent.changedTouches[0]) {
                pageY = event.originalEvent.changedTouches[0].pageY;
            }

            if (!!thi$.draggedElement) {

	            var cantMoveDragged = false,
		            taskViewTop = thi$.taskView ? thi$.taskView.offset().top : 0,
		            taskViewLeft = thi$.taskView ? thi$.taskView.offset().left : 0,
		            draggedObjectHeight = thi$.draggedElement.height(),
		            draggedObjectWidth = thi$.draggedElement.width(),
		            taskViewHeight = thi$.taskView ? thi$.taskView.height() : 0,
		            taskViewWidth = thi$.taskView ? thi$.taskView.width() : 0;

	            if (thi$.taskView) {
		            //prevent dragging after top of the answer
		            if (pageY < taskViewTop) {
			            cantMoveDragged = true;
		            }

		            //prevent dragging below bottom of the answer
		            if (((pageY + draggedObjectHeight) - (taskViewTop + taskViewHeight)) > (draggedObjectHeight / 2) ) {
			            cantMoveDragged = true;
		            }

		            if(ENV.contentDirection != "rtl") { //ltr content direction
			            //prevent dragging over left border of the task
			            if (pageX < taskViewLeft) {
				            cantMoveDragged = true;
			            }

			            //prevent dragging over right border of the task
			            if ((pageX - draggedObjectWidth) > (taskViewWidth - taskViewLeft)) {
				            cantMoveDragged = true;
			            }
		            } else {  //rtl content direction

			            //prevent dragging over left border of the task
			            if (pageX < draggedObjectWidth) {
				            cantMoveDragged = true;
			            }

						//prevent dragging over right border of the task
			            if((pageX - constants.draggedObjectOffset) > (taskViewLeft + taskViewWidth)) {
				            cantMoveDragged = true;
			            }

		            }

	            }

	            if(!cantMoveDragged) {
	                //place dragged div near mouse position
	                thi$.draggedElement.css({ 'top':pageY - constants.draggedObjectOffset,
		                                      'left':pageX - constants.draggedObjectOffset });

		            var screenY = (event.screenY || event.originalEvent.changedTouches[0].screenY);

		            thi$.prevDELTA = !!thi$.DELTA ? thi$.DELTA : 0;
		            thi$.DELTA = (thi$.Y - screenY);

		            var change = (thi$.DELTA * 1) + thi$.marginTop;

		            if (thi$.taskView) {

			            var answerInViewPort = Compat.elementInViewport(thi$.taskView.get(0), thi$.scrollableDiv.get(0));
			            var oldScrollTop = thi$.scrollableDiv.get(0).scrollTop, newScrollTop = 0;

			            if ((thi$.DELTA > 0) && (answerInViewPort.inTop == false)) { //answer top in not in view port
//				            console.log('scrolling up', change, ' delta=', thi$.DELTA);
				            if(thi$.prevDELTA < 0) { //switching scroll direction
					            thi$.scrollableDiv.stop();
				            }

				            newScrollTop = oldScrollTop - Math.abs(change); //scrolling up
				            thi$.scrollableDiv.css('overflow', 'hidden');
				            //thi$.scrollableDiv.get(0).scrollTop = newScrollTop; //scrolling up
				            thi$.scrollableDiv.animate({'scrollTop' : newScrollTop}, 100);

				            thi$.scrollableDiv.css('overflow', 'auto');
			            } //answer bottom in not in view port
			            else if ((thi$.DELTA < 0) && (!answerInViewPort.inBottom)) {
//				            console.log('scrolling down', change, ' delta=', thi$.DELTA);
				            if(thi$.prevDELTA > 0) { //switching scroll direction
					            thi$.scrollableDiv.stop();
				            }

				            newScrollTop = oldScrollTop + Math.abs(change); //scrolling down
			                thi$.scrollableDiv.css('overflow', 'hidden');
			                //thi$.scrollableDiv.get(0).scrollTop = newScrollTop; //scrolling down
				            thi$.scrollableDiv.animate({'scrollTop' : newScrollTop}, 100);
			                thi$.scrollableDiv.css('overflow', 'auto');
			            }
		            }

		            thi$.prevDraggedPosition = {'top' : pageY, 'left' : pageX};

	            } else {
		            event.stopImmediatePropagation();
		            event.stopPropagation();
		            thi$.scrollableDiv.stop();

		            if(thi$.prevDraggedPosition) {
			            thi$.draggedElement.css(thi$.prevDraggedPosition);
		            }

		            return false;
	            }

                //in case dragged object is over multiSubAnswer object
                if (dndManager.overObject && dndManager.overObject.obj && (dndManager.overObject.obj.dndContainer == 'multiSubAnswer') && (dndManager.inDragObject.dndContainer != "bank")) {

                    if ((dndManager.overObject.left <= pageX && dndManager.overObject.right >= pageX)
                        && (dndManager.overObject.top <= pageY && dndManager.overObject.bottom >= pageY)) {
                        dndManager.overObject.obj.view.removePlaceHolder();
                        dndManager.overObject = null;
                    }

                }

                //if there is no current over element - check if now dragger element is over,
                //otherwise check for mouse leave over element
                var subAnswersDomArray = thi$.getSubAnswersDomArray();

                if (!dndManager.overObject) { //currently there is no over SubAnswer - check if mouse now over some subAnswer
                    thi$.checkMouseEnter(subAnswersDomArray, pageY, pageX, event);
                } else {  //check for mouse leave over element
                    thi$.checkMouseLeave(subAnswersDomArray, pageY, pageX, event);
                }
            }
        },

        /**
         * @name startDrag
         * @desc Creates dragged element, places it by the mouse location, binds mousemove and keydown events on the document, binds dropping event
         * @param event
         */
        startDrag : function(event, answerId) {
	        var pageX, pageY;

	        if((!event.pageY && !event.originalEvent) && event.data) {
		        event.pageX =  event.data.pageX;
		        event.pageY =  event.data.pageY;
		        event.screenX =  event.data.screenX;
		        event.screenY =  event.data.screenY;
	        }

            event.preventDefault();

            //create dragged element from current content clone
            this.draggedElement = this._content.clone();

            //put clone of the subAnswer child into dndManager
            dndManager.inDragObjectView = this._content.children().first().clone();
            dndManager.inDragObjectView.css('vertical-align', '');

            var fontSize = this.cfg.optimumFontSize || parseInt(this._content.css('font-size')), thi$ = this;

            //console.log('left: ' + event.pageY + ' top: ' + event.pageX + ' dndManager.overObject: ' + dndManager.overObject);
            pageX = (event.pageX ? event.pageX : (event.originalEvent ? event.originalEvent.touches[0].screenX : 0));
            pageY = (event.pageY ? event.pageY : (event.originalEvent ? event.originalEvent.touches[0].screenY : 0));

            //place dragged element according mouse position and set it's style
            this.draggedElement.attr('id', genId()).removeClass().addClass(this.draggElementClass).css(
                {   left:pageX - constants.draggedObjectOffset,
	                top:pageY - constants.draggedObjectOffset,
                    width: Compat.fullOuterWidth(this._content),
	                height:this._content.outerHeight(true),
	                'font-size':fontSize}).appendTo(jQuery(constants.appendCloneSelector))
	            .attr('answerId', answerId ? answerId : -1);

            jQuery(document).bind("mousemove", this.mmFunctionHandler);

            jQuery(document).bind('keydown', this.keyDownHandler);

	        if (this.taskView && this.taskView.length) {
		        this.Y = (  event.screenY ||
			               (event.originalEvent && event.originalEvent.changedTouches[0].screenY) ||
			               (event.pageY + document.body.scrollTop)
			             );
		        this.marginTop = this.taskView.css('margin-top').px2int();
	        }

            this.markAsEmpty();

            this.bindDroppingEvent(this.cfg.dndBehaviour.droppingEvent);

        },

        /**
         * @name bindDroppingEvent
         * @desc bind dropping event to the current dragged element
         * @param eventType 'mouseup'/'click'
         */
        bindDroppingEvent : function(eventType){ //droppingEvent : event type 'mouseup'/'click'	
        	var thi$ = this;

	        function fncDropping(e) {

		        // Keeps the rest of the handlers from being executed and prevents the event from bubbling up the DOM tree.
		        e.stopImmediatePropagation();

		        if(!!ENV.behaviors.isTablet) {
			        e.stopPropagation();
			        e.preventDefault();
		        }

		        if (!dndManager.inDragObject) return;

		        var draggAnswerId = dndManager.inDragObject.answerId;

		        //dragged object is over dropped zone - do dropping and return to bank in case it's needed
		        if(!!dndManager.overObject && dndManager.overObject.obj.isEnabled()) {

			        (dndManager.overObject.obj.dndContainer !== 'bank') &&
			        dndManager.overObject.obj.droppingEvent(); //trigger dropping event of the current over subAnswer

			        //only after dropping event finished completely perform return option to bank (wait to callstack to empty)
			        function cancelDrag() {
				        var isReturnOptionToBank = false, overObjectDnDContainer = '';

				        try {
					        overObjectDnDContainer = dndManager.overObject.obj.dndContainer;
				        } catch(e) {
					        overObjectDnDContainer = '';
				        }

				        if(overObjectDnDContainer === 'bank'){  //dragged element is over bank
					        isReturnOptionToBank = true;
				        } else if ((!dndManager.afterDrop()) && (thi$.cfg.mode == 'dragAndDisable')){
					        isReturnOptionToBank = true;
				        }

				        if (isReturnOptionToBank) {
					        thi$.cancelDrag(true);
				        } else {
					        var isReturnToTheSource = false;

					        if (!dndManager.afterDrop() && (!dndManager.readyToDrop()) &&
						        (dndManager.inDragObject && dndManager.inDragObject.dndContainer != 'bank')) {
						        isReturnToTheSource = true;
					        }

					        thi$.cancelDrag(isReturnToTheSource);
				        }

			        }

			        setTimeout(cancelDrag, 0);

		        } else {

			        //if drop doesn't happened - return dragged element to the bank
			        setTimeout(function () {
				        if ((dndManager.inDragObject && dndManager.inDragObject.dndContainer == 'bank') && !dndManager.afterDrop()) {
					        thi$.dispatchEvent('returnOptionToBankEvent', {'draggAnswerId':draggAnswerId});
				        }
			        }, 0);

			        //remove draggable object
			        setTimeout(function() {
				        thi$.cancelDrag(!dndManager.afterDrop());
			        } , 100);
		        }

		        if (!!dndManager.isOverBank && !dndManager.overObject && !dndManager.afterDrop()) {
			        thi$.dispatchEvent('returnOptionToBankEvent', {'draggAnswerId':draggAnswerId});
		        }

		        if(!!ENV.behaviors.isTablet) {
			        return false;
		        }

	        }

		    jQuery(document).one(eventType, fncDropping);
            jQuery(thi$.draggedElement).on(eventType, fncDropping);
        	
        },

        /**
         * @desc cancel dragg - unbind mousemove event, remove dragged element, over element, in dragg object and set readyToDrop = false
         * @param returnToSource
         */
        cancelDrag : function(returnToSource){

            jQuery(document).unbind('mousemove', this.mmFunctionHandler)
	                        .unbind('touchmove', this.mmFunctionHandler)
                            .unbind('keydown',   this.keyDownHandler);

            if (!!returnToSource) {
                this.removeDragElem();	 	//move dragged element to the source and then remove it
            } else {
                this.fadeDragElem();     	//fade out dragged element in to the subAnswer
            }

            dndManager.overObject = null;     	//clear  current over Element (subAnswer)
        },
        /**
         * @desc on mousemove check if mouse cursor is over one of the subAnswers, if true - trigger mouseenter event of this subAnswer
         * @param subAnswersDomArray
         * @param y - mouse position
         * @param x - mouse position
         */
        checkMouseEnter : function(subAnswersDomArray, y, x, event){

            dndManager.readyToDrop(false);
            dndManager.isOverBank = false;
	        dndManager.overObject = null;

            //if there is no inDragObject - return
            if(!!!dndManager.inDragObject){
                return;
            }

        	// checking for 'over' position of dragging element
        	// if true - trigger mouseenter 
        	var thi$ = this;

	        var draggObjWidth = dndManager.inDragObject.view._view.width();
	        var draggObjHeight = dndManager.inDragObject.view._view.height();

	        var left_offset = x + draggObjWidth;
	        var right_offset = x - draggObjWidth;
	        var top_offset = y;
	        var bottom_offset = y + draggObjHeight;

	        var saBankDomArray = _.filter(subAnswersDomArray, function(saObj) {return saObj.obj.cfg.dndContainer == 'bank'});

	        var overSaInBank = _.filter(saBankDomArray, function(saObj) {
		        return (saObj.left <= left_offset &&
			            saObj.right >= right_offset &&
			            saObj.top <= top_offset &&
			            saObj.bottom <= bottom_offset)});

	        if (overSaInBank.length) { //dragged element is over bank - return it to correct bank option
		        var sourceAnswerId = dndManager.inDragObject.answerId; //in drag element source id
		        //correct sab-answer inside bank
		        var tmpArr = _.filter(saBankDomArray, function (saObj) {
			        return saObj.obj.answerId == sourceAnswerId
		        });

		        if (tmpArr.length) {
			        dndManager.isOverBank = true;
			        dndManager.overObject = tmpArr[0];
			        dndManager.readyToDrop(true);
			        dndManager.afterDrop(false);
			        !!dndManager.overObject.obj && dndManager.overObject.obj.draggingEnter(event);
			        return;
		        }
	        }

	        var saAreaDomArray = _.filter(subAnswersDomArray, function (saObj) {
		        return saObj.obj.cfg.dndContainer != 'bank'
	        });
	        var overSaInArea = _.filter(saAreaDomArray, function (saObj) {
		        return ((saObj.left <= x) && (x <= saObj.right) &&
			            (saObj.top <= y) && (y <= saObj.bottom))
	        });

	        if(overSaInArea.length) {
		        dndManager.isOverBank = false;
		        dndManager.overObject = overSaInArea[0];

		        //if dragged element is over subAnswer inside multiSubAnswer - we need to get the multiSubAnswerObject in order to mark
		        //multiSubanswer as droppable + mark insertion point
		        if (dndManager.overObject.obj.dndContainer != 'multiSubAnswer' && dndManager.overObject.obj.droppable == false && !!dndManager.overObject.obj.cfg.ownerObject) {
			        var current_over_obj_id = dndManager.overObject.obj.cfg.ownerObject.view.cfg.id;
			        dndManager.overObject = thi$.getSubAnswerByDomId(current_over_obj_id, subAnswersDomArray);
		        }

		        if (!!dndManager.overObject.obj) {
			        if (dndManager.overObject.obj.setOverElement) {  //if over element has setOverElement function, call it
				        dndManager.overObject.obj.setOverElement(dndManager.overObject.obj);
			        }

			        if (dndManager.overObject.obj.setMousePosition) { //if over element has setMousePosition function, call it
				        dndManager.overObject.obj.setMousePosition(x, y);
			        }

			        dndManager.readyToDrop(true);

			        dndManager.overObject.obj.draggingEnter(event);
		        }

		        return;
	        }
        },
        /**
         * @desc getSubAnswerByDomId find subAnswer element by its DOM id
         * @param DomId
         * @param arrObj
         */
        getSubAnswerByDomId : function(DomId, arrObj){
            var subAnswerElement = null;
        	arrObj.forEach(function(arrElm){
        		if(arrElm.obj.view.cfg.id == DomId){
        			subAnswerElement = arrElm;
                    return false;
        		}
        	});
            return subAnswerElement;
        },
        /**
         * @desc getSubAnswerById find subAnswer element by its answerId attribute
         * @param answerId
         * @param arrObj
         */
        getSubAnswerById : function(answerId, arrObj){        	
        	arrObj.forEach(function(arrElm){        		
        		if(arrElm.obj.answerId == answerId){
        			return arrElm;
        		}
        	});
        },
        /**
         * @desc getSubAnswerByIdAndContainer find subAnswer element by its answerId attribute and container
         * @param answerId
         * @param dndContainer
         */
        getSubAnswerByIdAndContainer : function(answerId, dndContainer){
        	var sAObject = null;
        	var arrObj = this.getSubAnswersDomArray();
        	arrObj.forEach(function(arrElm){        		
        		if(arrElm.obj.answerId == answerId && arrElm.obj.dndContainer == dndContainer){
        			sAObject = arrElm.jquery;
        		}
        	});
        	return sAObject;
        },
        
        /**
         * @desc on mousemove check if mouse leaved one of the subAnswers, if true trigger mouseleave
         * @param subAnswersDomArray
         * @param y
         * @param x
         */
        checkMouseLeave : function(subAnswersDomArray, y, x, event){
        	var thi$ = this;

            if ((dndManager.overObject.left > x || dndManager.overObject.right < x) || (dndManager.overObject.top > y) || dndManager.overObject.bottom < y){
                dndManager.overObject.obj.draggingLeave(event);
                dndManager.overObject = null;
            }
        },
        /**
         * @desc bind array of all subAnswers (object + jquery reference + position)
         * @returns {Array}
         */
        getSubAnswersDomArray : function(){
        	
        	var sAnswersArray = [];    
        	
        	for (var elemId in dndManager.answerAreaItems){
        		sAnswersArray.push(initSAElement(elemId, dndManager.answerAreaItems[elemId]));
        	}
        	
        	for (var elemId in dndManager.bankItems){
        		sAnswersArray.push(initSAElement(elemId, dndManager.bankItems[elemId]));
        	}        	      	

        	return sAnswersArray;
        	
        },

        /**
         * @name removeDragElem
         * @desc Return dragged element to the bank (with animation) and then remove it.
         */
        removeDragElem : function() {
            if (!this.draggedElement || !dndManager.inDragObject) return;

            var containerToReturnTo = (dndManager.isOverBank) ? 'bank' : dndManager.inDragObject.dndContainer;

            var returnAnswerId = (['mtq', 'bank'].indexOf(containerToReturnTo) >= 0) ? dndManager.inDragObject.answerId : dndManager.inDragObject.initAnswerId;

            var elemToDrop = this.getSubAnswerByIdAndContainer(returnAnswerId, containerToReturnTo, this.getSubAnswersDomArray());

            var isDoDrop = (containerToReturnTo == 'bank') ? false : !dndManager.afterDrop();

            var dropAnswerId = dndManager.inDragObject.answerId;
            var isDoDropToOwnerObject = false;
            var ownerObject = null;

            //not found element to return - return to it self
            if((elemToDrop == null) && (dndManager.inDragObject.dndContainer != 'bank')){
                var initAnswerId = jQuery(this.cfg.data).attr('answerId');
                elemToDrop = this.getSubAnswerByIdAndContainer(initAnswerId, containerToReturnTo, this.getSubAnswersDomArray());
                dndManager.overObject = elemToDrop;
            } else if (elemToDrop == null) {
                elemToDrop = this._view;
            }

            if((elemToDrop == null) && (dndManager.inDragObject.cfg.ownerObject)){  //in case of multiAnswer parent, return subAnswer to it
                elemToDrop = dndManager.inDragObject.cfg.ownerObject.view._view;
                ownerObject = dndManager.inDragObject.cfg.ownerObject;
                isDoDropToOwnerObject = true;
            }

            if ((dndManager.inDragObject) && (dndManager.inDragObject.children.length > 0)) {
                this.childReductionStep = dndManager.inDragObject.children[0].view.reductionStep;
                this.childOptimumFontSize = dndManager.inDragObject.children[0].view.optimumFontSize;
            }

            var thi$ = this;

            /**
             * When there is no element, animateTo is likely meaningless.
             */
            var animateTo = elemToDrop? {
                left: elemToDrop.offset().left,
                top: elemToDrop.offset().top
            }: {left: 0, top: 0};

            // Animation started, prevent dragging other objects. */
            dndManager.animated(true);

	        function endOfAnimation() {

		        thi$.markAsNotDroppable();

		        if (!!ownerObject && !!isDoDropToOwnerObject) { //mtq
			        ownerObject.dispatchEvent('doDroppingEvent', {'dropAnswerId' : dropAnswerId});
		        } else if (!!elemToDrop && !!isDoDrop) {
			        //perform dropping event
			        thi$.dispatchEvent('doDroppingEvent', {'dropAnswerId' : dropAnswerId});
		        } else  {
			        thi$.dispatchEvent('returnOptionToBankEvent', {'draggAnswerId': dropAnswerId});
		        }

		        setTimeout(function() {
			        clearDnDManagerDrag(thi$);

			        if (thi$.draggedElement) {
				        jQuery(document.getElementsByClassName(this.draggElementClass)).remove();
				        thi$.draggedElement.remove();
				        thi$.draggedElement = null;
			        }

			        // Animation ended, resume dragging other objects. */
			        dndManager.animated(false);
		        }, 10);

	        };

            this.draggedElement.animate(animateTo, constants.timeoutAnimationSec, endOfAnimation);

        },

        /**
         * @name fadeDragElem
         * @desc Fade out dragged element into the subAnswer (answer area), and then remove it.
         */
        fadeDragElem : function() {
	        if (!this.draggedElement) {
		        this.draggedElement = jQuery(document.getElementsByClassName(this.draggElementClass));
	        }

            if (!this.draggedElement) return;

            var thi$ = this;

            // Animation started, prevent dragging other objects. */
            dndManager.animated(true);

            this.draggedElement.fadeOut(constants.timeoutFadeOutSec, 'linear', function() { fncEndOfAnimation(); });

            function fncEndOfAnimation() {
                clearDnDManagerDrag(thi$);

                if (thi$.draggedElement) {
                    thi$.draggedElement.remove();
                    thi$.draggedElement = null;
                }

                // Animation ended, resume dragging other objects. */
                dndManager.animated(false);
            }

        },

    	/**
         * @name bindDNDEvents
    	 * @desc bind all events from events map
    	 * @param dndEvents
    	 */
    	bindDNDEvents : function(dndEvents){    		
    		var thi$ = this;   	
    		
    		dndEvents = jQuery.unique( dndEvents );

            var lastEvent = '';
		    function bindEvents(index, dndEvent) {

			    function handleEvent(event, data) {
				    event.preventDefault();

				    if(!!dndManager.animated()){
					    return false;
				    }

				    //prevent mouseUp double firing
				    if ((event.type == 'mouseup') && (lastEvent == event.type)) {
					    lastEvent = (event.type);
					    return false;
				    }

				    if(!!data) {
					    event.data = data;
				    }

				    thi$.dispatchEvent('catchEvent', event, data);

				    lastEvent = (event.type);
			    }

			    thi$._view.bind(dndEvent, handleEvent);
		    }

            jQuery.each(dndEvents, bindEvents);
    	},
        /**
         * @name markAsDraggable
         * @desc mark subAnswer as draggable object
         */
    	markAsDraggable : function(){
    		this._content.removeClass('not_droppable').addClass('draggable');
    	},
        /**
         * @name markAsNotDraggable
         * @desc mark subAnswer as not draggable object
         */
    	markAsNotDraggable: function(){
    		this._content.removeClass('draggable');
    	},
        /**
         * @name markAsDroppable
         * @desc mark subAnswer as droppable object
         */
    	markAsDroppable : function(){    	
    		if(this.cfg.dndContainer == 'bank'){ //mark all bank as droppable zone
    			var parentElem = this._view.parent().parent();
    			parentElem.removeClass('not_droppable').addClass('droppable');
    		} else {
    			this._content.removeClass('not_droppable').addClass('droppable');
    		}
    	},
        /**
         * @name markAsNotDroppable
         * @desc mark subAnswer as not droppable object
         */
    	markAsNotDroppable : function(){  
    		if(this.cfg.dndContainer == 'bank'){ //mark all bank as droppable zone
    			var parentElem = this._view.parent().parent();
    			parentElem.removeClass('droppable').addClass('not_droppable');
    		} else {
    			this._content.removeClass('droppable').addClass('not_droppable');
    		}	
    	},
        /**
         * @name markAsEnable
         * @desc mark subAnswer as enabled object
         * @param removeReusable
         */
    	markAsEnable : function(removeReusable){
    		var thi$ = this;

	        if (!!removeReusable) {
		        thi$._content.removeClass('disabled');
		        thi$._content.removeClass('reusable');
	        } else {
		        thi$._content.removeClass('disabled');
		        thi$._content.removeClass('reusable');
	        }

    	},
        /**
         * @name markAsDisable
         * @desc mark subAnswer object as disabled object
         */
    	markAsDisable : function(){
    		this._content.addClass('disabled');
    	},
        /**
         * @name markAsReusable
         * @desc mark subAnswer as reusable object
         */
    	markAsReusable : function(){
    		this._content.addClass('reusable');
    	},
        /**
         * @name removeAllMarks
         * @desc remove all marks from subAnswer object
         */
    	removeAllMarks : function() {
    		if(this.cfg.dndContainer == 'bank'){ //mark all bank as not droppable zone
    			var parentElem = this._view.parent().parent();
    			parentElem.removeClass('draggable').removeClass('droppable').removeClass('not_droppable');    			
    		} else {
    			this._content.removeClass('draggable').removeClass('droppable').removeClass('not_droppable').removeClass('full').removeClass('disabled');
    			this._view.removeClass('wrong').removeClass('correct').removeClass('partlyCorrect').removeClass('system_correct');
    		}     		    		   	
    	},
        /**
         * @name markAsFull
         * @desc mark subAnswer as full (has content - child)
         */
    	markAsFull : function() {
    		this._content.addClass('full');    		
    	},
        /**
         * @name markAsEmpty
         * @desc mark subAnswer as empty (without content - child)
         */
    	markAsEmpty : function() {
    		this._content.removeClass('full');    		
    	},
        /**
         * @name markAsCorrect
         */
		 markAsCorrect: function() {
		     this._view.removeClass('wrong').removeClass('partlyCorrect');
		     this._view.addClass('correct');
		     this.cfg.state = 'correct';       
		 },
        /**
         * @name markAsPartiallyCorrect
         */
		 markAsPartiallyCorrect : function() {
			 this._view.removeClass('wrong');
		     this._view.addClass('partlyCorrect');
		     this.cfg.state = 'partlyCorrect';      			 
		 },
        /**
         * @name markAsSystemCorrect
         */
		 markAsSystemCorrect : function() {
	        if (this.cfg.state != 'correct') {
		        this._view.removeClass('correct').addClass('system_correct');
	        } else {
		        this.markAsCorrect();
	        }
		 },
        /**
         * @name markAsWrong
         */
         markAsWrong: function() {
	        this.markAsFull(); //for empty sub-answers
	        this._view.removeClass('correct');
	        this._view.addClass('wrong');
	        this.cfg.state = 'wrong';
         },
        /**
         * @name isMarkedAsCorrect
         */
         isMarkedAsCorrect: function() {
             return this._view.hasClass('correct');
         },
        /**
         * @name isMarkedAsCorrect
         */
         isMarkedAsSystemCorrect: function() {
            return this._view.hasClass('system_correct');
         },
        /**
         * @name isMarkedAsWrong
         */
        isMarkedAsWrong : function() {
            return this._view.hasClass('wrong');
        },
        /**
         * @name isMarkedAspartiallyCorrect
         */
        isMarkedAspartiallyCorrect : function() {
            return this._view.hasClass('partlyCorrect');
        }
    });

 // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 // Private Functions.
 // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    /**
     * @name cancelEvent
     * @param e
     * @return {Boolean}
     */
    function cancelEvent(e) {
        e = e ? e : window.event;
        if (e.stopPropagation)
            e.stopPropagation();
        if (e.preventDefault)
            e.preventDefault();
        e.cancelBubble = true;
        e.cancel = true;
        e.returnValue = false;
        return false;
    }

    /**
     * @name initSAElement
     * @param elemId
     * @param elemObj
     * @return {Object}
     */
    function initSAElement(elemId, elemObj){
    	var sAnswerObj = {};
		sAnswerObj.id = elemId;
		sAnswerObj.obj = elemObj;
		sAnswerObj.jquery = Perf.select('#' + elemId);

	    try {
		    sAnswerObj.left = sAnswerObj.jquery.offset().left;
		    sAnswerObj.top = sAnswerObj.jquery.offset().top;
		    sAnswerObj.right = sAnswerObj.left + sAnswerObj.jquery.width();
		    sAnswerObj.bottom = sAnswerObj.top + sAnswerObj.jquery.height();

	    } catch (e) {
		    dndManager.removeSubAnswer(elemId, true);
	    }

		return sAnswerObj;
    }

    /**
     * @name clearDnDManagerDrag*
     */
    function clearDnDManagerDrag(thi$){
		dndManager.inDragObject = null;
		dndManager.readyToDrop(false);
    	dndManager.afterDrop(false);
        dndManager.inDragObjectView = null;
	    //cancel all animations
	    thi$.scrollableDiv && thi$.scrollableDiv.stop(true, true);
    }
})();
////////////////////////////////////////
// SRC End --> t2k/component/subAnswer/SubAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subAnswer/SubAnswer.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.subAnswer.SubAnswer
     * @desc A subAnswer class
     * @namespace t2k.component.subAnswer
     * @extends t2k.component.Composite
     * @type {Object}
     */

    var constants = t2k.component.subAnswer.SubAnswerConstants;

    t2k.component.subAnswer.SubAnswer = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.subAnswer.SubAnswer',

        /**
         * @name ctor
         * @param config
         * @desc constructor
         */
        ctor: function(config) {

            var newConfig;

            // if (special configuration), get configuration from special configuratoin
            if (config.specialConfiguration){
                newConfig = copy({}, config.specialConfiguration);
                newConfig.parent = config.parent;
                newConfig.data = config.data;
                newConfig.container = config.container;
                newConfig.insertBefore = config.insertBefore;
                newConfig.showMFEmptyIcon = config.showMFEmptyIcon || config.specialConfiguration.showMFEmptyIcon;
                newConfig.dummyMode = config.dummyMode;

                delete newConfig.onRendered;
                newConfig.onRendered = config.onRendered;

            } else {
                newConfig = copy({}, config);
            }
            // Delegate
            var thi$ = this;

            this._super(newConfig);

            this.initParams();

            this.initView();

            // Create the answers objects : (correct, partiallyCorrect, incorrectPredicted)
            override(this.cfg, prepareConfiguration(this.cfg.data));

            this.startComposite2({
                fontColor : thi$.cfg.fontColor,
                style : thi$.childStyle,
                maxChar : this.fieldsSize,
                widthEm : this.fieldsWidth,
                reductionStep : thi$.cfg.reductionStep,
                optimumFontSize : thi$.cfg.optimumFontSize,
                setFontSize : thi$.cfg.setFontSize,
                lineHeightConfig : thi$.cfg.lineHeightConfig || 'keepEven',
                showMFEmptyIcon : thi$.cfg.showMFEmptyIcon,
                parent: this.view.cfg.id + '_content',
                setAnswer : function(flag) {
                    thi$.containsAnswer = flag;
                },
                firstKeyDown : thi$.cfg.firstKeyDown,
                dontEnableBlowup : true,
                minimumReadable : 0.3,
                maxReduction_minReadable : true,
	            taskmode : thi$.cfg.taskmode,
                onAbsMin : function(){},
                dummyMode : this.cfg.dummyMode,
                viewObject:  (dndManager.inDragObject &&  dndManager.inDragObject.children.length )? (dndManager.inDragObject.children[0].view._view).clone() : null
            });

            var childName = '';

            if(this.children.length > 0) {
                childName = this.children[0].name.split('.');
                childName = childName[childName.length-1].toLowerCase();
            }

            // check disabled space eating (override)
        	// in child component is imageViewer, disable spaceEating (layouter)
        	this.layout.disableSpaceEating = function(){
            	return (childName == 'imageviewer');
            };

            this.view._initHint();
            this.view._initMarkupForEmptySA();
            this.view.setStyleByChild(childName);
            this.initFullSubAnswer();

        },

        /**
         * @name initParams
         * @desc parameters initialization
         */
        initParams : function() {

	        var $data = jQuery(this.cfg.data);

            this.hint = $data.find('hint');   //hint tag

            /**
             * @desc subAnswer answerId MUST be unique per task
             * @type {Number}
             */
            this.answerId = $data.attr('answerId') || $data.children('answerId').text() || 0;

            /**
             * @const
             * @desc subAnswer answerId MUST be unique per task
             * @type {Number}
             */
            this.initAnswerId = $data.attr('answerId') || $data.children('answerId').text() || 0;

            /**
             *@desc id the sub answer related to this bank item - relevant only for bank subanswer
             *
             */
             if(!!$data.attr('originalid')){
                this.originalid = $data.attr('originalid');
             }

            /**
             * @property
             * @type {Boolean}
             */
            this.caseSensitive = $data.find('check caseSensitive').text() === "true";

            /**
             * @property
             * @type {Boolean}
             */
            this.punctuationMarks = $data.find('check punctuationMarks').text()  === "true";

            /**
             * @property
             * @type {String}
             */
            this.sampleMatchMode = $data.find('sampleMatchMode').text() || null;

            /**
             * @property
             * @type {Boolean}
             */
            this.resetIncorrect = this.cfg.resetIncorrect;  // resetIncorrect flag

	        this.checkAnswerOnState = this.cfg.checkAnswerOnState;

            /**
             * @property
             * @type {String}
             */
            this.dndMode = this.cfg.mode;

            /**
             * @property
             * @type {String}
             * @desc ()
             */
            this.dndContainer = this.cfg.dndContainer;

            /**
             * @property
             * @type {String}
             */
            this.childStyle = this.cfg.style;

            /**
             * @property
             * @type {String}
             */
            this.fieldsSize = this.cfg.fieldsSize;  //chars number of subAnswer child component
             /**
             * @property
             * @type {int} em
             */

            this.fieldsWidth = this.cfg.fieldsWidth;

            /**
             * @property
             * @type {Boolean}
             */
            this.droppable;

            /**
             * @property
             * @type {Boolean}
             */
            this.draggable;

            this.afterDrag;
            this.afterDrop;
            this.beforeDrop;
            this.eventsMap = [];

            this.state;
            this.correct = 'false';
        },

        /**
         * @name setMyState
         * @desc override - set state of component
         * @param state
         */
        setMyState : function(state) {
            this.state = state;

            if (!!state) {
                var thi$ = this, $state = jQuery(state);

	            this.answerId = $state.children('answerId').text().trim();
	            this.setEnabled($state.attr('enabled') === 'true');
	            this.setAnswer($state.children('isAnswer').text() === 'true');

	            if(    (["write", "dragAndDropToMultiAnswer"].indexOf(this.cfg.mode) < 0)
		            && (this.dndContainer != "bank")){ //not child of hidden multi subanswer or writable
	                this.reset();
	            }

	            //set answerId and enabled flag after reset
                this.answerId = $state.children('answerId').text().trim();
	            this.setEnabled($state.attr('enabled') === 'true');

                if (this.answerId != 'undefined') {
                    this.containsAnswer = ($state.children('isAnswer').text() === 'true');

                    if (this.isAnswer()) { //there is an answer in this subAnswer
                        // dragged object bank source option - get, parse and send to factory
                        var sourceElement = dndManager.getBankItem(this.answerId);

	                    if(!sourceElement || !sourceElement.children.length) {
		                    sourceElement = dndManager.getItem(this.answerId);
	                    }

	                    if (sourceElement && sourceElement.children.length &&
		                    ["write", "dragAndDropToMultiAnswer"].indexOf(this.cfg.mode) < 0) { //not child of hidden multi subanswer or writable
		                    this.view.replaceChild(sourceElement); //remove subAnswer child and replace it with new one (source of the dragged object)
		                    dndManager.afterDrop(true);    //set after drop flag - true
	                    }

	                    thi$.setAnswer(thi$.children.length > 0);  //mark this subAnswer as answered after drop

                        if (typeof thi$.cfg.firstKeyDown == 'function') { //check for function existance
	                        thi$.cfg.firstKeyDown();    //trigger progress event of the task
                        }

                        this.applyAfterDrop(this.answerId, this.isEnabled() && this.cfg.bankMode == 'dragAndCopy');
                    }

	                if(!this.checkAnswerOnState) { //checking is handled not by state
		                thi$.view.removeAllMarks();

		                if(!thi$.isEmpty()) {
			                thi$.markAsFull();
		                }

	                    //apply checking marks
		                if ($state.children('correct').text() === 'true') thi$.markAsCorrect();
		                if ($state.children('wrong').text() === 'true') thi$.markAsWrong();
		                if ($state.children('systemCorrect').text() === 'true') thi$.markAsSystemCorrect();
		                if ($state.children('partiallyCorrect').text() === 'true') thi$.markAsPartiallyCorrect();
	                }
                    if ($state.children('lockSubanswerBankState').text() === 'true') thi$.lockSubanswerBankState = true;

                }

	            $state = null;

            }
        },

        /**
         * @name addMyState
         * @desc returns component state
         * @return {Object}
         */
        addMyState : function() {
	        var state = jQuery('<state/>').append(jQuery('<answerId/>').text(this.answerId));

	        if (this.dndContainer != 'bank') {
			    state.append(jQuery('<isAnswer/>').text(this.isAnswer()));
	        }

	        state.append(jQuery('<id/>').text(this.view.cfg.id))
		         .append(jQuery('<correct/>').text(this.isMarkedAsCorrect() || false))
		         .append(jQuery('<systemCorrect/>').text(this.isMarkedAsSystemCorrect() || false))
		         .append(jQuery('<wrong/>').text(this.isMarkedAsWrong() || false))
		         .append(jQuery('<partiallyCorrect/>').text(this.ispartiallyCorrect() || false))
                 .append(jQuery('<lockSubanswerBankState/>').text(this.lockSubanswerBankState || false));

	        if(this.cfg.mode == "dragAndDropToMultiAnswer") { //multi subanswer hidden - add state of sab answer child
		        //create children state
		        var childState, childrenState = Perf.create('children');  //children state;

		        this.children.forEach(function(child, index) {
			        var childState = jQuery(child.cfg.data);
			        if (childState) {
				        childState.attr('index', index);
				        state.append(childrenState.append(childState.clone()));
				        state.append(childState.clone());
			        }
		        });
	        }

            return state;
        },

        /**
         * @name setEnabled
         * @param flag {Boolean}
         * @param removeReusable
         */
        setEnabled: function(flag, removeReusable) {

	        this._super(flag);

	        if (this.cfg.mode !== "write") {
		        this.manageSALists();
	        }

            if(!this.lockSubanswerBankState){
                if (flag) {

	                if (this.cfg.mode !== "write") {
		                //empty sub-answer or inside multi sub-answer
		                if (!this.isAnswer() || (this.dndMode == "dragAndDropToMultiAnswer")) {
			                this.analizeDNDMode(this.dndMode);
		                }

		                this.manageDND();
	                }

                    this.view.markAsEnable(removeReusable || false);
                } else {
                    this.view.markAsDisable();
                }
	        }
        },
        resetBankLockState: function(){
            this.lockSubanswerBankState = false;
        },

        /**
         * @name getSize
         */
        getSize : function() {
          return this.view.getSize();
        },

        /**
         * @name initView
         * @desc view initialization, in case task in dndMode init all related events and fill dnd parameters
         */
        initView : function() {
            var thi$ = this;

            //set subanswer size
            if( this.cfg.fieldsSizeMode =="manual"){
                var maxVal = 0 ;
                var isMathfield;
                jQuery(this.cfg.data).find('ans_option').each(function(index, ansOptionElement){
                    var answerWidth = 0;
                    var widthEm = jQuery(ansOptionElement).attr('widthem');
                    if(widthEm && widthEm.length){
                        answerWidth = parseInt(widthEm);
                    }else{
                        answerWidth = jQuery(ansOptionElement).text().length;
                    }
                    if(answerWidth > maxVal){
                        maxVal = answerWidth;
                        isMathfield = widthEm && widthEm.length;

                    }
                });

                this.fieldsSize = maxVal * (isMathfield ? constants.additionalWidthFactor : 1 );
                this.fieldsWidth = maxVal * (isMathfield ? constants.additionalWidthFactor : 1 );;
            }

            // check if DND functionality is allowed on this component
            if (this.dndMode && this.dndMode != 'write') {

                // analyze DND mode
                this.analizeDNDMode(this.dndMode);

                var selectedDNDBehaviour = (ENV.behaviors.dragAndDropBehaviorTablets ? ENV.behaviors.dragAndDropBehaviorTablets : ENV.dragAndDropBehavior);

                this.dndBehaviour = this.analizeDNDBehaviour(selectedDNDBehaviour);
                this.dndEventsNames = this.registerDNDEventsNames();

	            function analizeEvent(event) {
		            var eventMeaning = thi$.eventsMap[event.type];  //event meaning translation by the event type

		            if ((thi$.dndBehaviour.startDraggingEvent == thi$.dndBehaviour.droppingEvent) //in case of equal event types
			            && ((thi$.eventsMap[event.type] == 'droppingEvent') || (thi$.eventsMap[event.type] == 'startDraggingEvent'))) {
			            eventMeaning = (dndManager.inDragObject) ? 'droppingEvent' : 'startDraggingEvent';
		            }

		            if (event.type === "touchend") { //can be droppingEvent on over element or draggingLeave - 2 special cases

			            if (!dndManager.overObject) {
				            thi$.view.mouseMoveHandler(event);  //check if mouse over some subAnswer
			            }

			            if (!!dndManager.overObject) {  //droppingEvent
				            event.preventDefault();
				            dndManager.overObject.obj.droppingEvent(event);
				            /* if (dndManager.afterDrop()) {  //after drop remove draggable object
				             thi$.view.cancelDrag(false);
				             } else if (dndManager.overObject.obj.dndContainer == "bank") { //over bank
				             dndManager.overObject.obj.draggingLeave(event);
				             thi$.view.draggedElement.touchend(); //TODO: check it
				             thi$.view.cancelDrag(true);
				             }

				             } else if (!!thi$.view.draggedElement) { //draggingLeave
				             thi$.view.draggedElement.touchend();
				             }*/
				            return false;
			            }
		            }

		            //cloze subAnswer prevent drop to it self when subanswer is full
		            if (thi$.dndContainer != 'bank' && thi$.containsAnswer && eventMeaning == 'draggingEnter') {
			            if (dndManager.inDragObject) {
				            if (dndManager.inDragObject.dndContainer != 'bank') {
					            if (dndManager.inDragObject.answerId == thi$.answerId) {
						            return false;
					            }
				            }
			            }
		            }

		            switch (eventMeaning) {
			            case 'startDraggingEvent' :
				            thi$.startDraggingEvent(event);
				            break;
			            case 'draggingEnter' :
				            thi$.draggingEnter(event);
				            break;
			            case 'draggingLeave' :
				            thi$.draggingLeave(event);
				            break;
			            case 'droppingEvent' :
				            thi$.droppingEvent(event);
				            break;
		            }
	            }

                this.view = this.createNewView(t2k.component.subAnswer.SubAnswerView, override(copy(this.cfg, {elHint: this.hint}), {

                    registerEvents : this.dndEventsNames,
                    dndBehaviour : this.dndBehaviour,

                    events : {
                        catchEvent : analizeEvent,

                        doDroppingEvent:function (config) {
	                        setTimeout(function() {
                                var event = jQuery.Event(thi$.dndBehaviour.droppingEvent);
                                thi$.droppingEvent(event, config.dropAnswerId);
	                        }, 0)
                        },

                        returnOptionToBankEvent : function(config) {
	                        enableBankOption(config.draggAnswerId, true);
	                        thi$.answerId = thi$.initAnswerId;  //return initial answerId
                        },

	                    createChildren:function (config) {
		                   thi$.createChildren(config);
	                    }
                    }
                }));

            } else {  //not dndMode
                this.view = this.createNewView(t2k.component.subAnswer.SubAnswerView, copy(this.cfg, {elHint: this.hint}));
            }

            if (!!this.cfg.content_css) {  //apply some css to content div
                this.view._content.css(this.cfg.content_css);
            }
	    },

	    createChildren: function(config) {
		    //remove children
		    this.removeChildren();

		    var newComponent = componentFactory.create({data:config.xml,
			    parent:config.subanswer_content_id,

			    setAnswer:function (flag) {
				    this.containsAnswer = flag;
			    },
			    fontColor:this.cfg.fontColor,
			    style:this.childStyle,
			    width:config.width,
			    maxChar:this.cfg.fieldsSize,
                width: this.cfg.fieldsWidth,
			    container:config.container,
			    reductionStep:config.childReductionStep,
			    optimumFontSize:config.childOptimumFontSize,
			    lineHeightConfig:this.cfg.lineHeightConfig || 'keepEven',
			    dontEnableBlowup:true,
			    applyAbsoluteMinimum:false,
			    minimumReadable:0.3,
			    maxReduction_minReadable:true,
			    onRendered:function () {
			    },
			    onAbsMin:function () {
			    },
			    viewObject:config.viewOfSourceElement,
			    taskmode:config.taskmode
		    });

		    if (newComponent) {
			    this.add(newComponent);
			    newComponent.setEnabled(true);
			    this.setAnswer(true);
		    }
	    },

        /**
         * @name getElementSize
         */
        getElementSize : function() {
            return this.view.getElementSize();
        },

        /**
         * @name setElementSize
         * @param elementSizes
         */
        setElementSize : function(elementSizes) {
            this.view.setElementSize(elementSizes);
        },

        /**
         * @name resetElementSize
         */
        resetElementSize : function() {
            this.view.resetElementSize();
        },

        /**
         * @name analizeDNDMode
         * @param dndMode
         */
        analizeDNDMode : function(dndMode) {
            var dndModeConfig = t2k.component.subAnswer.SubAnswerConstants.dndModes[dndMode];  //clickAndDrop or dragAndDrop

            if (dndModeConfig) {
                this.droppable = dndModeConfig.droppable;
                this.draggable = dndModeConfig.draggable;
                this.afterDrag = dndModeConfig.afterDrag;
                this.afterDrop = dndModeConfig.afterDrop;
                this.beforeDrop = dndModeConfig.beforeDrop;
            }

        },
        /**
         * @name analizeDNDBehaviour
         * @desc usually it's dragAndDrop. In case of tablet PC may be clickAndDrop
         * @param dndBehaviour
         */
        analizeDNDBehaviour :function(dndBehaviour) {
            var dndBehavioursConfig = t2k.component.subAnswer.SubAnswerConstants.dndBehaviour[dndBehaviour]; //event mapping object of the current behavior
            return dndBehavioursConfig;
        },

        /**
         * @name manageDND
         */
        manageDND : function() {
            // if the component is draggable add to DNDManager draggables
            if (!!this.draggable) {
                dndManager.addDraggable(this.view.cfg.id, this);
            } else {
                dndManager.removeDraggable(this.view.cfg.id);
            }

            // if the component is droppables add to DNDManager droppables
            if (!!this.droppable) {
                dndManager.addDroppable(this.view.cfg.id, this);
            } else {
                dndManager.removeDroppable(this.view.cfg.id);
            }
        },
        /**
         * @name manageSALists
         */
        manageSALists : function() {
	        dndManager.addItem(this.view.cfg.id, this);

            if (this.dndContainer == 'bank') {
                dndManager.addBankItem(this.view.cfg.id, this);
            } else {
                dndManager.addAnswerAreaItem(this.view.cfg.id, this);
            }
        },

        /**
         * @name registerDNDEventsNames
         * @desc run through DND Behaviour map, check if event handler exists in the class and add it to events map, returns dndEventsArray
         * @returns {Array}
         */
        registerDNDEventsNames : function() {
            var thi$ = this;
            var dndEventsArray = [];
            for (var dndEvent in this.dndBehaviour) {  // loop the array and check for double values
                //if (jQuery.inArray(dndEvent, thi$.eventsMap) == -1) { //check for event existence in the events map array
                    dndEventsArray.push(this.dndBehaviour[dndEvent]);
                    thi$.eventsMap[this.dndBehaviour[dndEvent]] = dndEvent;
                //}
            }
            return dndEventsArray;
        },

        /**
         * @name draggingEnter
         * @param event
         * @desc 2 cases: 1. if inDragObject == true - check if i'm droppable (yes - handleCanDrop || no - handleCantDrop)
         *             else {
         *                     check if i'm draggable (yes - handleCanDrag || no - handleCantDrag)
         *                     (mostly - handleCantDrag will do nothing)
         *             }
         */
        draggingEnter : function(event) {
            //console.log('id:' + this.view.cfg.id + ' this.droppable: ' + this.droppable + ' this.draggable:' + this.draggable);
            if (dndManager.isInDragMode()) {
                var isReplaceEnable = true;

                if ((this.dndMode == 'dragAndDropNoReplace') && (this.isAnswer()) && (dndManager.inDragObject.dndContainer != 'bank')) {
                    isReplaceEnable = false;
                }

                dndManager.readyToDrop(false);

                if (this.droppable && isReplaceEnable) {
                    dndManager.readyToDrop(true);
                    this.view.markAsDroppable();
                } else {
                    if ((this.cfg.dndContainer != 'bank') && (dndManager.inDragObject.view.cfg.id != this.view.cfg.id)) { //bank is always droppable
                        this.view.markAsNotDroppable();
                    } else {
                        this.view.markAsDroppable();	//draggable object is over his source - allow to drop
                    }
                }

            } else {
                if (this.draggable && !!this.isEnabled()) { //handleCanDrag
                    this.view.markAsDraggable();
                } else { //handleCantDrag
                    this.view.markAsNotDraggable();
                }
            }
        },
        /**
         * @name draggingLeave
         * @desc 2 cases: 1. leave without dropping (reverse mouseEnter)
         *          2. leave after dropping
         *
         *          remove all dragging related css styles
         */
        draggingLeave : function(event) {
            if (!!this.isEnabled()) {
                if (this.dndContainer != 'bank' && dndManager.isInDragMode()) {
                    if (!this.isEmpty()) {
                        this.view.removeAllMarks();
                        this.markAsFull();
                    } else {
                        this.view.markAsNotDraggable();
                        this.view.markAsNotDroppable();
                        this.markAsEmpty();
                    }
                } else if (this.dndContainer != 'bank' && this.isEmpty()) {
                    this.view.removeAllMarks();
                } else if (this.dndContainer == 'bank') {
                    this.view.markAsNotDraggable();
                    this.view.markAsNotDroppable();
                }
            }
        },
        /**
         * @name applyAfterDragg
         * @desc applying after dragg parameters for subAnswer
         */
        applyAfterDragg : function(isEnableBank) {

            this.draggable = false;
            this.droppable = false;

            if (this.afterDrag) {
                var thi$ = this;

                var afterDragParams = this.afterDrag.split(',');
                for (var param in afterDragParams) {
                    switch (afterDragParams[param]) {
                        case 'draggable' :
                            thi$.draggable = true;
                            break;
                        case 'dropabble' :
                            thi$.droppable = true;
                            break;
                        case 'markSourceAsReusable' :
                            thi$.view.markAsReusable();
                            break;
                        case 'delete' :  //delete content
                            thi$.deleteSubAnswerChild(isEnableBank);
                            break;
                        case 'deleteSubAnswer' :
                            thi$.deleteSubAnswer(isEnableBank);
                            break;
                        case 'disable' :
                            thi$.setEnabled(false);
                            this.lockSubanswerBankState = true;
                            break;
                    }
                }
            }


            this.manageDND();

        },

        /**
         * @name startDraggingEvent
         * @desc  handling of the dragging event, creating draggable element and call applyAfterDragg method
         * @param event
         */
        startDraggingEvent : function(event) {
            if (!!dndManager.canDrag(this.view.cfg.id) && !!this.isEnabled()) {
                dndManager.startDrag(this.view.cfg.id);
                dndManager.afterDrop(false);
                dndManager.readyToDrop(false);

                this.view.startDrag(event, this.answerId);

                this.applyAfterDragg(false);

            }
        },
        /**
         * @name droppingBySystemEvent
         * @param dropAnswerId
         * @desc performing dropping event programmatic
         */
        droppingBySystemEvent : function(dropAnswerId) {
            // dragged object bank source option - get, parse and send to factory
            var draggSourceElement = dndManager.getItem(dropAnswerId);

	        if (!draggSourceElement || (draggSourceElement && !draggSourceElement.children.length)) {
		        draggSourceElement = dndManager.getBankItem(dropAnswerId);
	        }

            if (!!draggSourceElement && !!draggSourceElement.children.length) {
	            this.view.replaceChild(draggSourceElement);        //replace subAnswer child

	            dndManager.afterDrop(true);     //set after drop flag - true

	            this.setAnswer(this.children.length > 0);  //mark this subAnswer as answered after drop

	            if (typeof this.cfg.firstKeyDown == 'function') { //check for function existence
		            this.cfg.firstKeyDown();    //trigger progress event of the task
	            }

	            this.applyAfterDrop(dropAnswerId, false);

	            (this.cfg.IsBank !== true) && dndManager.afterDrop(false);
            }
        },
        /**
         * @name checkIfDroppableNoReplace
         * @desc perform check for no replace between subAnswers allowed or only drop from bank
         */
        checkIfDroppableNoReplace : function() {
            var IsDroppableNow = true;

            if (this.isAnswer() && (dndManager.inDragObject.dndContainer != 'bank')) {
                IsDroppableNow = false;
            }

            return IsDroppableNow;
        },

        /**
         * @name droppingEvent
         * @desc handling of the dropping event: clear subAnswer child and create new one from the dndManager.inDragObject
         * mark this subAnswer as answered, fire afterDrop event*
         */
        droppingEvent:function (event, dropAnswerId) {

	        var IsBank = this.cfg.IsBank;
	        if (typeof IsBank == 'undefined') {
		        IsBank = true;
	        }

	        if (!!dropAnswerId) {

		        this.droppingBySystemEvent(dropAnswerId);

	        } else if (!!dndManager.canDrop(this.view.cfg.id) && !!this.isEnabled()) {

		        var isDroppableNow = true;
		        var beforeDropParams = this.beforeDrop.split(',');
		        for (var param in beforeDropParams) {
			        switch (beforeDropParams[param]) {
				        case 'checkIfDroppableNoReplace' : //check if subAnswer is full and then set this SA in bank enable
					        isDroppableNow = this.checkIfDroppableNoReplace();
					        break;
			        }
		        }

		        if (!isDroppableNow) {
			        dndManager.readyToDrop(false);
			        return;
		        }

		        // dragged object bank source option - get, parse and send to factory
		        var draggSourceElement = dndManager.getBankItem(dndManager.inDragObject.answerId);
		        var replaceContentElement = null;

		        if (!IsBank) {
			        if (!!!draggSourceElement) {
				        draggSourceElement = dndManager.getAnswerAreaItemByInitAnswerId(dndManager.inDragObject.initAnswerId);
			        }

			        replaceContentElement = dndManager.getItem(dndManager.inDragObject.answerId);
		        }

		        if (!!!replaceContentElement) {
			        replaceContentElement = draggSourceElement;
		        }

		        var enableBankAfterDrop = false, thi$ = this, currentAnswerId = dndManager.inDragObject.answerId;

		        if (draggSourceElement) {
			        if ((this.answerId != currentAnswerId) && (this.cfg.bankMode == 'dragAndDisable') && (!!this.containsAnswer)) {
				        enableBankAfterDrop = true;
			        }

			        //move current answer into source dragg subAnswer (switch between subAnswers in case there is no bank)
			        if ((this.dndMode == 'dragAndDropAndReplace') && (draggSourceElement.dndContainer != "bank") && (this.isAnswer())) {
				        draggSourceElement.droppingBySystemEvent(this.answerId, true);
			        }
		        }

		        function replaceContentAndSetAnswer() {
			        if(dndManager.afterDrop()) { //prevent double dropping
				        return false;
			        }

			        //remove subAnswer child and replace it with new one (source of the dragged object)
			        thi$.view.replaceChild(replaceContentElement, dndManager.inDragObjectView);

			        dndManager.afterDrop(true);    //set after drop flag - true

			        thi$.setAnswer(thi$.children.length > 0);  //mark this subAnswer as answered after drop

			        if (typeof thi$.cfg.firstKeyDown == 'function') { //check for function existence
				        thi$.cfg.firstKeyDown();    //trigger progress event of the task
			        }

			        thi$.applyAfterDrop(currentAnswerId, enableBankAfterDrop && thi$.cfg.bankMode != 'dragAndCopy');
		        }

		        setTimeout(replaceContentAndSetAnswer, 0);


	        }

        },
        /**
         * @name deleteSubAnswer
         * @desc delete this subAnswer content and children, if isEnableBank = true - enable bank option
         * @param isEnableBank (true / false;)
         */
        deleteSubAnswerChild : function(isEnableBank) {
            this.view.removeContent();
            this.children.length = 0;
            this.view.children.length = 0;

            if (isEnableBank) {
                enableBankOption(this.answerId, true);
            }

            this.setAnswer(false);

            if (typeof this.cfg.firstKeyDown == 'function') { //check for function existance
                this.cfg.firstKeyDown();    //trigger progress event of the task
            }

            this.answerId = this.initAnswerId;

        },
        /**
         * @name deleteSubAnswer
         * @desc delete this subAnswer
         */
        deleteSubAnswer : function() {

            dndManager.removeSubAnswer(this.view.cfg.id, false);

            this.children.length = 0;
            this.view.children.length = 0;

            //DOM manipulations cancel touch events
            //this.view.dispose();
            dndManager.insertIntoRecycleBin(this.view._view);

            //remove this child from the ownerObject children
            if (this.cfg.ownerObject) {
                this.cfg.ownerObject.removeChild(this);
	        }

        },
        /**
         * @name setCorrect
         * @desc sets this subAnswer correct property
         * @param type ('true' / 'false')
         */
        setCorrect : function(type) {
            this.correct = type;
        },
        /**
         * @name getCorrect
         * @desc  returns this subAnswer correct
         * @returns {String}
         */
        getCorrect : function() {
            return this.correct;
        },
        /**
         * @name getCorrectAnswer
         * @desc returns first correct answer
         * @returns {String}
         */
        getCorrectAnswer : function() {
            var correctAnswer = '';

            if(this.dndMode == 'write' && !!this.cfg.answers.showAnswer) {
                return '<showAnswer>' + this.cfg.answers.showAnswer + '</showAnswer>';
            }

            jQuery(this.cfg.answers.correct).each(function(index, objAnswer) {
                if (objAnswer.checkType == 'value') {
                    correctAnswer = objAnswer.answer;
                    return false;
                }
            });

            return correctAnswer;
        },
        /**
         * @name isAnswer
         * @desc returns boolean, true if this subAnswer contains answer atherwize, returns false
         * @return {Boolean}
         */
        isAnswer : function() {
            return !!this.containsAnswer;
        },

        /**
         * @name isCorrect
         * @desc return true if current answer is correct
         * @returns boolean
         */
        isCorrect : function(returnCheckValue) {
            if (this.cfg.mode != 'write') { //check correct answer by answerId
                var IsCorrectAnswer = false,
                checkValue,
                thi$ = this;

                jQuery.each(this.cfg.answers.correct, function(index, objCorrectAnswer) {
                    var strCorrectAnswer = objCorrectAnswer.answer;
                    var checkType = objCorrectAnswer.checkType;
                    IsCorrectAnswer = ( (thi$.answerId == jQuery.trim(strCorrectAnswer)) && thi$.containsAnswer ? true : false);
                    if (IsCorrectAnswer) {
                        checkValue = thi$.answerId;
                        return false;
                    }
                });
                if(returnCheckValue){
                    return {IsCorrectAnswer: IsCorrectAnswer, checkValue: checkValue}
                }
                return IsCorrectAnswer;

            } else {
                var IsCorrectAnswer = this.parseAnswers(this.cfg.answers.correct, returnCheckValue);
                return IsCorrectAnswer;
            }
        },
        /**
         * @name ispartiallyCorrect
         * @returns {Boolean}
         */
        ispartiallyCorrect : function(returnCheckValue) {
            var IsCorrectAnswer = false,
            saValue = this.getValue(),
            checkValue='';

            if (this.cfg.mode == 'write') {
                jQuery.each(this.cfg.answers.partiallyCorrect, function(index, value) {
                    IsCorrectAnswer = (saValue == value.answer);
                    if (IsCorrectAnswer) {
                        checkValue = value.answer;
                        return false;
                    }
                });
            }
            if(returnCheckValue){
                return{ IsCorrectAnswer: IsCorrectAnswer, checkValue : checkValue}
            }

            return IsCorrectAnswer;
        },
        /**
         * @name isIncorrectPredicted
         * @returns {Boolean}
         */
        isIncorrectPredicted : function(returnCheckValue) {
            var IsIncorrectPredictedAnswer = this.parseAnswers(this.cfg.answers.incorrectPredicted, returnCheckValue);
            return IsIncorrectPredictedAnswer;
        },
        /**
         * @name parseAnswers
         * @param arrAnswers (correct / partiallyCorrect, incorrectPredicted)
         */
        parseAnswers : function(arrAnswers, returnCheckValue) {
            var thi$ = this;
            var IsCorrectAnswer = false;
            var subAnswerValue = '';
            jQuery.each(arrAnswers, function(index, objCorrectAnswer) {
                var strCorrectAnswer = objCorrectAnswer.answer;
                var checkType = objCorrectAnswer.checkType;
                var saValue = '', saMaValue = '', saCorrectness = '';

                switch (checkType) {
                    case 'value' :
                        saValue = jQuery.trim(thi$.getValue());
                        break;
                    case 'markupValue' : case 'markUp'  :
                        saValue = jQuery.trim(thi$.getMarkUpValue());

                        //"<four/>".replace(/<(\w+)\/>/g, "<$1></$1>")  ==> "<four></four>"
                        saValue = saValue.replace(/<(\w+)\/>/g, "<$1></$1>").replace(/\s+/g,'').toLowerCase();
                        strCorrectAnswer = strCorrectAnswer.replace(/<(\w+)\/>/g, "<$1></$1>").replace(/\s+/g,'').toLowerCase();
                        
                        /////////////////////////////////////////////////////////////////////////////
                        /////////////////////////////////////////////////////////////////////////////
                        saValue = saValue.replace(/minusSign/gi, "minus");
                        strCorrectAnswer = strCorrectAnswer.replace(/minusSign/gi, "minus");
                        /////////////////////////////////////////////////////////////////////////////

                        break;
                    case 'correctness' :
                        saValue = jQuery.trim(thi$.getCorrectness());
                        break;
                    case 'rule' :
                        saValue = jQuery.trim(thi$.getValue());
                        saMaValue = jQuery.trim(thi$.getMarkUpValue());
                        saCorrectness = jQuery.trim(thi$.getCorrectness());

                        var rule = replaceAll(strCorrectAnswer, "value", saValue);
                        rule = replaceAll(rule, "markupValue", saMaValue);
                        rule = replaceAll(rule, "correctness", saCorrectness);

                        rule = replaceAll(rule, "bigger", ">");
                        rule = replaceAll(rule, "smaller", "<");
                        rule = replaceAll(rule, "AND", "&&");
                        rule = replaceAll(rule, "OR", "||");

                        ////////////////////////////////////////////////////////
                        // set all numbers to 15 digit decimal
                        ////////////////////////////////////////////////////////
                        rule = rule.replace( /\d+\.?\d*/g, function( num ) {
                        	var fixed = ( 1 * num ).toFixed( 15 ) ;
                        	return fixed
                        } ) ;
                        ////////////////////////////////////////////////////////
                        
                        try {
                            IsCorrectAnswer = eval( rule );
                        } catch(e) {
                            IsCorrectAnswer = false;
                        }

                        if (IsCorrectAnswer) {
                            return false;
                        }
                        break;
                }

                //don't performe case sencitive and punctuation checking for Math Field markUp
                //[IE9]if (thi$.children[0].__proto__.name.indexOf('mathField') < 0) {
                if (Object.getPrototypeOf(thi$.children[0]).name.indexOf('mathField') < 0) {
                    if (!!thi$.caseSensitive) {
                        saValue = saValue.toLowerCase();
                        strCorrectAnswer = strCorrectAnswer.toLowerCase();
                    }

                    if (!!(thi$.punctuationMarks)) { //remove punctuation marks
                        saValue = saValue.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g, '');
                        strCorrectAnswer = strCorrectAnswer.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g, '');
                    }

	                //ignore checking
	                if(!!thi$.cfg.ignoreChecking && thi$.cfg.ignoreChecking.length) {
		                thi$.cfg.ignoreChecking.forEach(function(item, index){
							if(typeof constants.ignoreChecking[item] == "function") {
								var fnc = constants.ignoreChecking[item];
								saValue = fnc(saValue);
								strCorrectAnswer = fnc(strCorrectAnswer);
							}
		                });
	                }
                }

                IsCorrectAnswer = (saValue == strCorrectAnswer);
                if (IsCorrectAnswer) {
                    subAnswerValue = saValue
                    return false;
                }
            });
            if(returnCheckValue){
                return {IsCorrectAnswer : IsCorrectAnswer , checkValue : subAnswerValue};
                
            }
            return IsCorrectAnswer;
        },
        /**
         * @name getCorrectness
         * @desc returns subAnswer correctness
         * @return {Boolean}
         */
        getCorrectness : function() {

            if(this.children[0].view.calculate) {
                return this.children[0].view.calculate.correctness();
            }

            return null;

        },
        /**
         * @name markAsCorrect
         * @desc mark subAnswer as correct
         */
        markAsCorrect: function() {
            if (this.dndContainer != 'bank' && this.dndMode == 'write') {
                this.view.markAsFull();
            }
            this.view.markAsCorrect();
        },
        /**
         * @name markAspartiallyCorrect
         */
        markAsPartiallyCorrect : function() {
            if (this.dndContainer != 'bank' && this.dndMode == 'write') {
                this.view.markAsFull();
            }
            this.view.markAsPartiallyCorrect();
        },
        /**
         * @name setSystemAnswer
         * @param correctAnswerId
         */
        setSystemAnswer : function(correctAnswerId) {
            dndManager.afterDrop(true);
            var currentAnswer = this.answerId;
            var isEnableBank = false;

            if (correctAnswerId != currentAnswer) {
                this.view.removeAllMarks();

                if (this.dndContainer != 'bank') {
                    this.view.markAsFull();
                }

	            var sourceElement = dndManager.getItem(correctAnswerId);

                if (sourceElement && (["dragAndDropToMultiAnswer"].indexOf(this.cfg.mode) < 0)) { //not if child of hidden multi subanswer
                    this.view.replaceChild(sourceElement); //remove subAnswer child and replace it with correct answer
                }
            }

            this.applyAfterDrop(correctAnswerId, isEnableBank);
            this.disableBankOption(correctAnswerId);
        },
         /**
         * @name onShowAnswer
         * @desc set correct answer and mark subAnswer as system
         */
        onShowAnswer : function() {
            if (!this.isCorrect()) {
                this.setSystemAnswer(this.getCorrectAnswer());
                this.view.markAsSystemCorrect();
            } else {
	            this.markAsCorrect();
            }
        },

        /**
         * @name markAsSystemCorrect
         * @desc fill subAnswer with the correct answer and mark as correct
         */
        markAsSystemCorrect : function() {
            //check for task mode, if 'write' then put string value, else put correct bank option
            if (this.dndMode) {

                this.setAnswer(this.children.length > 0);  //mark this subAnswer as answered after drop

                if (typeof this.cfg.firstKeyDown == 'function') { //check for function existence
                    this.cfg.firstKeyDown();    //trigger progress event of the task
                }

                if (this.dndMode == 'write') {
                    this.view.removeAllMarks();

                    if (this.dndContainer != 'bank') {
                        this.view.markAsFull();
                    }
                    this.view.replaceContent(this.getCorrectAnswer());

                } else {

                    this.setSystemAnswer(this.getCorrectAnswer());

                }

                this.view.markAsSystemCorrect();
            }
        },
        /**
         * @name applyAfterDrop
         * @desc apply after dropping actions according to the configuration
         */
        applyAfterDrop : function(correctAnswerId, isBankEnabled) {
            var thi$ = this;

            if (dndManager.afterDrop()) { //mouseLeave after dropping

                thi$.analizeDNDMode(thi$.dndMode);    //init draggable/droppable

                thi$.draggable = false;
                thi$.droppable = false;


                if(!!!thi$.afterDrop){
                    return;
                }

                var afterDropParams = thi$.afterDrop.split(',');
                var param;
                for (param in afterDropParams) {
                    switch (afterDropParams[param]) {
                        case 'draggable' :
                            thi$.draggable = true;
                            break;
                        case 'dropabble' :
                            thi$.droppable = true;
                            break;
                        case 'checkAndReturn' : //check if subAnswer is full and then set this SA in bank enable
                            if (this.isAnswer()) {
                                if (!!isBankEnabled) {
                                    enableBankOption(thi$.cfg.bankMode == 'dragAndDropNoReplace' ? correctAnswerId : thi$.answerId, false);
                                } else {
                                    thi$.disableBankOption((thi$.cfg.bankMode == 'dragAndDropNoReplace' || thi$.cfg.bankMode == "dragAndDisable") ? correctAnswerId : thi$.answerId, true);
                                }

                                this.view.removeAllMarks();

                                if (this.dndContainer != 'bank') {
                                    this.view.markAsFull();
                                }
                            }
                            break;
                    }
                }

                thi$.answerId = correctAnswerId;

                thi$.manageDND();
            }
        },
        /**
         * @name isMarkedAsCorrect
         */
        isMarkedAsCorrect: function() {
            return this.view.isMarkedAsCorrect();
        },
        /**
         * @name isMarkedAsSystemCorrect
         */
        isMarkedAsSystemCorrect: function() {
            return this.view.isMarkedAsSystemCorrect();
        },
        /**
         * @name isMarkedAsWrong
         */
        isMarkedAsWrong : function() {
            return this.view.isMarkedAsWrong();
        },
        /**
         * @name isMarkedAspartiallyCorrect
         */
        isMarkedAspartiallyCorrect : function() {
            return this.view.isMarkedAspartiallyCorrect();
        },
        /**
         * @name markAsWrong
         */
        markAsWrong: function() {
            if (this.dndContainer != 'bank' && this.dndMode == 'write') {
                this.view.markAsFull();
            }
            this.view.markAsWrong();
        },
        /**
         * @name markAsFull
         */
        markAsFull : function() {
            this.view.markAsFull();
        },
        /**
         * @name markAsEmpty
         */
        markAsEmpty : function() {
            this.view.markAsEmpty();
        },
        /**
         * @name initFullSubAnswer
         * @desc in case of subAnswer initiation with child and dndMode set it's style as full and containsAnswer = true
         */
        initFullSubAnswer : function() {
            if (this.children.length > 0 && !!this.dndMode) {
                if (this.dndMode != 'write') {
                    this.markAsFull();
                    this.setAnswer(true);
                }
            }
        },

        /**
         * @name disableBankOption
         * @param currAnswerId
         */
        disableBankOption : function(currAnswerId) {
            var bankSourceSA = dndManager.getBankItem(currAnswerId);

            if (bankSourceSA) {
                bankSourceSA.analizeDNDMode(bankSourceSA.dndMode);
                bankSourceSA.manageDND();

                if (bankSourceSA.cfg.mode == "dragAndCopy") {
                    bankSourceSA.view.markAsReusable();
                } else {
                    //bankSourceSA.view.markAsDisable();
                    bankSourceSA.setEnabled(false);
                    bankSourceSA.lockSubanswerBankState = true;
                }
            }
        },
        /**
         * reset function
         * check resetIncorrect parameter if true - reset subAnswer, if false - do nothing
         */
        reset : function() {
            //in write mode - enable texteditor and reset firstKeyDown flag
            if (this.cfg.mode == 'write' && this.children[0]) {

                if(this.children[0].view.setFirstKeyPressed) {
                    this.children[0].view.setFirstKeyPressed(false);
                }

                this.children[0].setEnabled(true);
            }

            this.view.removeAllMarks();

            if (!!(this.resetIncorrect)) {
	            if(this.cfg.mode != "write") {
	                this.applyAfterDragg(true);
	                this.answerId = this.initAnswerId;
	            } else {
		            this.view.removeContent();
	            }
            }

            if ((this.cfg.mode != 'write') && !this.isEmpty()) {
               dndManager.afterDrop(true);
               this.applyAfterDrop(this.answerId, this.resetIncorrect);
            }
        },
        
        /**
         * @name setAnswer
         * @param flag
         */
        setAnswer : function(flag) {
            this.containsAnswer = flag;  //mark this subAnswer as answered
        },
        /**
         * @name triggerDraggingEvent
         * @desc creates dragging event and returns dragged element, used for sample math
         */
        triggerDraggingEvent : function() {
            var event = jQuery.Event(this.dndBehaviour.startDraggingEvent);

            this.startDraggingEvent(event);

            return this.view.draggedElement;
        }

    });

    /**
     * @method
     * @name addBehavior
     * @desc add checkable behavior
     */
    t2k.component.subAnswer.SubAnswer.addBehavior(t2k.behavior.checkable, {

        /**
         * @name getValue
         * @desc returns subAnswer value
         * @returns String
         */
        getValue : function() {
            return this.view.getValue();
        },

        getOriginalBankId: function(){
            if(this.originalid){
                return this.originalid;
            }
            return false;
        },

        /**
         * @name getMarkUpValue
         * @desc returns subAnswer markUp
         * @returns String
         */
        getMarkUpValue : function() {
            return this.view.getMarkUpValue();
        },

        /**
         * @name setLocalFeedback
         * @param feedbackType
         */
        setLocalFeedback : function(feedbackType) {
            switch (feedbackType) {
                case 'correct' :
                    this.markAsCorrect();
                    break;
                case 'incorrect' :
                    this.markAsWrong();
                    break;
                case 'full' :
                    this.markAsFull();
                    break;
                case 'partiallyCorrect' :
                    this.markAsPartiallyCorrect();
                    break;
                case 'predictedIncorrect' :
                    this.markAsWrong();
                    break;
                case 'systemCorrect' :
                    this.view.markAsSystemCorrect();
                    break;
            }
        },
        /**
         * @name runCheck
         */
        runCheck : function() {

            var checkResult = {};

            checkResult.expected = 1;

            checkResult.empty = this.isEmpty() ? 1 : 0;

            if (this.isCorrect()) {
                checkResult.correct = 1;
                this.setLocalFeedback('correct');
            } else if (this.ispartiallyCorrect()) {
                checkResult.partiallyCorrect = 1;
                this.setLocalFeedback('partiallyCorrect');
            } else if (this.isIncorrectPredicted()) {
                checkResult.incorrectPredicted = 1;
                this.setLocalFeedback('predictedIncorrect');
            } else {
                checkResult.incorrect = 1;
                this.setLocalFeedback('incorrect');
            }

            if (this.view.children.length == 0) { //subAnswer is not empty
                this.setLocalFeedback('full');
            }

            this.setEnabled(false);

            return checkResult;
        },
        /**
         * @name isEmpty
         */
        isEmpty: function() {
            // We have this to handle legacy code isAnswer() which actually means "contains with answer"
            return !this.isAnswer();
        },
        /**
         * @name resetOnTryAgain
         */
        resetOnTryAgain : function() {
            if (!this.isMarkedAsCorrect()) {
                if (!!this.cfg.taskmode && this.cfg.taskmode == "matching") {
                    this.setEnabled(true);
                    this.reset();
                } else {
                    this.reset();
                    this.setEnabled(true);
                }

            } else {
                this.disableBankOption(this.answerId);
            }
        },
        /**
         * @name markOnShowAnswer
         */
        markOnShowAnswer : function() {
            if (!child.isCorrect()) {
                child.markAsSystemCorrect();
            }
            child.setEnabled(false);
        },
        setSpecificFeedback : function(message){

            this.view.setSpecificFeedback(message, 'subAnswer');
        }

    });
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~   
    /**
     * @name prepareOConfiguration
     * @desc Private function, Extract the answers values from the xml
     * @param {XML} saXml The subAnswer configuration XML.
     * @return {Object} that contains answers values: correct, partially correct, incorrect and predicted.
     */
    function prepareConfiguration(saXml) {
        // The result object.
        var result = {
            answers : {
                showAnswer : null,
                correct: [],
                partiallyCorrect: [],
                incorrectPredicted: []
            }
        };

        //Iterate the XML with answers options.
        var arrNodes = saXml.childNodes,
			i,
			child,
			innerChild,
			node,
			strXML;

        for (i = 0; i < arrNodes.length; i++) {
            node = arrNodes[i];

            if (node.nodeType == 1) {
                switch (node.nodeName.toLowerCase()) {
                    case 'check' :
                        child = Compat.getFirstChildType1(node);
                        while (child) {
                            switch (child.nodeName.toLowerCase()) {
                                case "showanswer" :
                                    strXML = '';
                                    innerChild = Compat.getFirstChildType1(child);

                                    while (innerChild) {
                                        if (innerChild.nodeType == 1) {
                                            strXML += jQuery.xmlToString(innerChild);
                                        }
                                        innerChild = innerChild.nextSibling;
                                    }

                                    result.answers.showAnswer = strXML || '';
                                    break;
                                case "correct" :
									loadAnswersArray(Compat.getChildren2(child), result.answers.correct);
                                    break;

                                case "partiallycorrect" :
                                    loadAnswersArray(Compat.getChildren2(child), result.answers.partiallyCorrect);
                                    break;
                                case "incorrectpredicted" :
                                    loadAnswersArray(Compat.getChildren2(child), result.answers.incorrectPredicted);
                                    break;
                            }
                            child = child.nextElementSibling;
                        }
                        break;

                    case "showanswer" :
                        result.answers.showAnswer = jQuery.xmlToString(node.firstElementChild) || '';
                        break;
                    case "correct" :
						loadAnswersArray(jQuery(node).children(), result.answers.correct);
                        break;
                    case "partiallycorrect" :
                        loadAnswersArray(jQuery(node).children(), result.answers.partiallyCorrect);
                        break;
                    case "incorrectpredicted" :
                        loadAnswersArray(jQuery(node).children(), result.answers.incorrectPredicted);
                        break;
                }
            }
        }

        // Return the result.
        return result;
    } // End of prepareConfiguration
    /**
     * @name enableBankOption
     */
    function enableBankOption(currAnswerId, removeReusable) {
        var bankSourceSA = dndManager.getBankItem(currAnswerId);
        if (bankSourceSA) {
            bankSourceSA.analizeDNDMode(bankSourceSA.dndMode);
            bankSourceSA.manageDND();
            bankSourceSA.lockSubanswerBankState = false;
            bankSourceSA.setEnabled(true, removeReusable);
        }
    }

    /**
     * @name releaseBankOption
     * @param currAnswerId
     */
    function releaseBankOption(currAnswerId) {
        var bankSourceSA = dndManager.getBankItem(currAnswerId);

        if (bankSourceSA) {
            if (bankSourceSA.cfg.mode == "dragAndCopy") {
                bankSourceSA.analizeDNDMode(bankSourceSA.dndMode);
                bankSourceSA.manageDND();
                bankSourceSA.view.markAsReusable();
            } else {
                bankSourceSA.draggable = false;
                bankSourceSA.droppable = false;
                bankSourceSA.setEnabled(false);
            }
        }
    }

    /**
     * @name replaceAll
     * @param source
     * @param stringToFind
     * @param stringToReplace
     * @return {String}
     */
    function replaceAll(source, stringToFind, stringToReplace) {
        var temp = source;
        var index = temp.indexOf(stringToFind);
        while (index != -1) {
            temp = temp.replace(stringToFind, stringToReplace);
            index = temp.indexOf(stringToFind);
        }
        return temp;
    }

    /**
     * @name loadAnswersArray
     * @param arrayElements
     * @param arrayResult
     */
    function loadAnswersArray(arrayElements, arrayResult) {
        var answer, checkType;

        jQuery(arrayElements).each(function (index, elXml) {
            answer = jQuery.trim(elXml.innerHTML || elXml.textContent || elXml.text);
            if(!answer.length) {
                var strXML = '';
                var innerChild = elXml.firstElementChild || elXml;

                while (innerChild) {
                    if (innerChild.nodeType == 1) {
                        strXML += jQuery.xmlToString(innerChild);
                    }
                    innerChild = innerChild.nextSibling;
                }
                answer = strXML;
            }

            checkType = jQuery.trim(jQuery(elXml).attr("checkType")) || 'value';
            if (checkType.toLowerCase() == "markup") {
                checkType = "markupValue"
            }

            //trim spaces between tags
            if (checkType.toLowerCase() == "markupvalue") {
                answer = answer.replace(/>\s</g, '><');
                //remove <enter> tag
                answer = answer.replace(/<enter>|<\/enter>/gi, '')
            }

            arrayResult.push({'answer':answer, 'checkType':checkType});
        });
    }

})();
////////////////////////////////////////
// SRC End --> t2k/component/subAnswer/SubAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subAnswer/MultiSubAnswerConfig.js
////////////////////////////////////////
/**
 * MultiSubAnswer component constants
 */
t2k.component.subAnswer.MultiSubAnswerConstants = {
    dndBehaviour:{

        dragAndDrop:{
            startDraggingEvent:'mousedown',
            droppingEvent:'mouseup',
            draggingEnter:'mouseenter',
            draggingLeave:'mouseleave'
        },

        clickAndDrop:{
            startDraggingEvent:'click',
            droppingEvent:'click',
            draggingEnter:'mouseenter',
            draggingLeave:'mouseleave'
        },

        touchAndDrop:{
            startDraggingEvent:'touchstart',
            droppingEvent:'touchend',
            draggingEnter:'touchenter',
            draggingLeave:'touchend'
        }
    },
    
    dndModes : {
        dragAndDropAndInsert : {
            droppable : true,
            draggable : false,
            afterDrag : 'childDelete',
            afterDrop : 'dropabble,removePlaceHolder',
            beforeDrop : 'checkIfDroppable'
        }
    },

	sideMarginOfSubAnswer: 1,     //rem
    paddingOfMultiAnswer: 1,    //rem
    BottomPaddingOfSubAnswer: 1,  //rem
	paddingOfSubAnswer : 1,       //rem
    VerticalBottomPaddingOfSubAnswer : 1, //rem
	borderOfMultiSubAnswer : 2,  //px
	scrollableSelector: 'div.scroll_enabled'
};
////////////////////////////////////////
// SRC End --> t2k/component/subAnswer/MultiSubAnswerConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subAnswer/MultiSubAnswerView.js
////////////////////////////////////////
(function() {
    var TEMPLATE = "<div id='{{id}}' class='multiSubAnswer{{^IsPlaceholders}} noplaceholders{{/IsPlaceholders}}\
                        {{#IsBank}} withbank{{/IsBank}}{{^IsBank}} nobank{{/IsBank}}'>\
                        <div id='{{id}}_content' class='multiSubAnswer_content' />\
                    </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

	var constants = t2k.component.subAnswer.MultiSubAnswerConstants;

    /*
     * @class MultiSubAnswerView
     */
    t2k.component.subAnswer.MultiSubAnswerView = t2k.component.BaseComponentView.subClass({

        /*
         * @constructor
         * @param config - {Object} configuration
         */
        ctor: function(config) {
            
            this._super(override({}, config, defaultConfig));

             if(!!this.cfg.registerEvents){
            	this.bindDNDEvents(this.cfg.registerEvents);
            }

	        this.remSize = jQuery('body').css('font-size').px2int();

        },
//        /**
//         * override
//         */
//        compact : function (){
//            // don't compact my view
//        },

        /**
         * applyHorizontalStyle
         * @param size
         */
        applyHorizontalStyle : function(size) {
            if (size) {
                this._view.width(size.width);
                this._view.height(size.height);
            }
        },

        /**
         * applyVerticalStyle
         * @param size
         */
        applyVerticalStyle : function(size) {
            if (size) {
                this._view.width(size.width);
                this._view.height(size.height);
            }
        },

        /**
         * set size (width + height)
         * @param elementWidth integer
         * @param elementHeight integer
         */
        setSize : function(numOfAnswers, elementWidth, elementHeight, verticalLayout){

            var topPadding = (parseInt(this._view.css('padding-top')));
            var sidePadding = (parseInt(this._view.css('padding-left'))), width, height;

            if (verticalLayout){
                // vertical
	            width = elementWidth + sidePadding * 2;
                this._view.width(width);
	            height = topPadding * 2 + (elementHeight + (this.remSize * constants.VerticalBottomPaddingOfSubAnswer)) * numOfAnswers
		                 - (this.remSize * constants.VerticalBottomPaddingOfSubAnswer);
                this._view.height(height);
            } else {
                //horizontal
	            width = (elementWidth * numOfAnswers) + (sidePadding  * 2) + (this.remSize * numOfAnswers);
                this._view.width(width);
	            height = elementHeight + (constants.BottomPaddingOfSubAnswer * this.remSize) + topPadding;
                this._view.height(height);
            }

	        return {'width' : width, 'height' : height}
        },
        /**
         *  setWidth
          * @param elementWidth
         */
        setWidth : function(elementWidth){
            this._view.width(elementWidth);
        },
        /**
    	 * bind all events from events map
    	 * @param dndEvents
    	 */
    	bindDNDEvents : function(dndEvents){
    		var thi$ = this;

            dndEvents = jQuery.unique( dndEvents );

            var lastEvent = '';

	        function bindEvents(index, dndEvent) {
		        thi$._view.bind(dndEvent, function (event) {
			        event.preventDefault();

			        //prevent any event during animation
			        if (!!dndManager.animated()) {
				        return false;
			        }

			        //prevent mouseUp double firing
			        if ((event.type == 'mouseup') && (lastEvent == event.type)) {
				        lastEvent = (event.type);
				        return;
			        }

			        thi$.dispatchEvent('catchEvent', event);

			        lastEvent = (event.type);

		        });
	        }

	        jQuery.each(dndEvents, bindEvents);
    	},
        /**
         * markAsEnable
         */
        markAsEnable : function(){
            this._view.removeClass('disabled');
    	},
        /**
         * markAsDisable
         */
    	markAsDisable : function(){
    		this._view.addClass('disabled');
    	},
        /**
         * markAsDraggable
         */
    	markAsDraggable : function(){
    		this._view.removeClass('not_droppable').addClass('draggable');
    	},
        /**
         * markAsNotDraggable
         */
    	markAsNotDraggable: function(){
    		this._view.removeClass('draggable');
    	},
        /**
         * markAsDroppable
         */
    	markAsDroppable : function(){
    		this._view.removeClass('not_droppable').addClass('droppable');
    	},
        /**
         * markAsNotDroppable
         */
    	markAsNotDroppable : function(){
    		this._view.removeClass('droppable').addClass('not_droppable');
    	},

	    setVerticalPlaceHolder:function (clientY, lastChildIndex, positionOfLastChild, elementSizes, thi$){
			//check if we over subAnswer then put placeholder after it
		    jQuery(this.children).each(function(index, child) {
			    if (child._view.offset().top < clientY) {
				    lastChildIndex = (index + 1);
				    positionOfLastChild = (constants.paddingOfSubAnswer * this.remSize) +
					    lastChildIndex * (elementSizes.height + parseInt(child._view.css('margin-bottom')));
				    thi$.dispatchEvent('setLastChildIndex', {'lastChildIndex' : lastChildIndex});
			    }
		    });

		    if (positionOfLastChild == 0 && this.children.length > 0) {//mouse cursor is over top of the element - insert element in top
			    lastChildIndex = 0;
			    positionOfLastChild = parseInt(this._view.css('padding-top')) / 2;

			    thi$.dispatchEvent('setLastChildIndex', {'lastChildIndex' : lastChildIndex});

		    } else if (positionOfLastChild == 0) {
			    positionOfLastChild = (this.children.length == 0) ? (constants.paddingOfSubAnswer * this.remSize) :
				    ((this.children.length) * (elementSizes.height + parseInt(jQuery(this.children).get(0)._view.css('margin-bottom'))));

		    }

		    return jQuery('<div></div>').attr('id', this.cfg.id + '_placeholder').css({'width' : elementSizes.width, 'height' : 2,   //horizontal
			    'backgroundColor' : '#FF9933', 'position' : 'absolute', 'top' : ((elementSizes.height + 14) * lastChildIndex) + 7});
	    },

	    setHorizontalPlaceHolder:function (lastChildIndex, clientX, positionOfLastChild, elementSizes, thi$){
		    lastChildIndex = (ENV.contentDirection == 'ltr' ? 0 : thi$.children.length);

		    function calcPositionOfLastChild() {
			    return lastChildIndex * (elementSizes.width) + 3;
		    }

		    positionOfLastChild = (ENV.contentDirection == 'ltr' ? 0 : calcPositionOfLastChild());

			//check if we over subAnswer then put placeholder after it
		    jQuery(this.children).each(function(index, child) {
			    switch (ENV.contentDirection) {
				    case 'ltr' :
					    if (child._view.offset().left < clientX) {
						    lastChildIndex = (index + 1);
						    positionOfLastChild = calcPositionOfLastChild();
					    }
					    break;
				    case 'rtl' :
				    {
					    if (child._view.offset().left + child._view.width() < (clientX)) {
						    var diff = (clientX - (child._view.offset().left + child._view.width()));
						    lastChildIndex = thi$.children.length - Math.ceil(diff / (child._view.width() + (child._view.css('margin-left').px2int() / 2)));
						    positionOfLastChild = calcPositionOfLastChild();
					    }
				    }
			    }

			    thi$.dispatchEvent('setLastChildIndex', {'lastChildIndex' : lastChildIndex});

		    });

		    if (positionOfLastChild == 0 && this.children.length > 0) {//mouse cursor is over top of the element - insert element in top
			    lastChildIndex = 0;

			    positionOfLastChild = parseInt(this._view.css('padding-top')) / 2;

			    thi$.dispatchEvent('setLastChildIndex', {'lastChildIndex' : lastChildIndex});

		    } else if (positionOfLastChild == 0) {

			    switch(ENV.contentDirection) {
				    case 'ltr' : {
					    positionOfLastChild = (this.children.length == 0) ? (constants.paddingOfSubAnswer * this.remSize) :
						    ((this.children.length) * (elementSizes.height + parseInt(jQuery(this.children).get(0)._view.css('margin-bottom'))));
					    break;
				    }
				    case 'rtl' : {
					    positionOfLastChild = (this.children.length) * (elementSizes.height + parseInt(jQuery(this.children).get(0)._view.css('margin-bottom')));
						break;
				    }
			    }

		    }

		    var ph_left = 0;
		    switch(ENV.contentDirection) {
			    case 'ltr' : {
				    ph_left = ((elementSizes.width + 14) * lastChildIndex) + 7;
				    break;
			    }
			    case 'rtl' : {
				    ph_left = thi$._content.width() - ((elementSizes.width + 14) * lastChildIndex) + 21;
				    break;
			    }
		    }

		    return jQuery('<div></div>').attr('id', this.cfg.id + '_placeholder').css({'width' : 2, 'height' : elementSizes.height,   //horizontal
			    'backgroundColor' : '#FF9933', 'position' : 'absolute', 'top' : 14,
			    left: ph_left});
	    }, /**
	     * creates div that indicaites current dropping position
	     * @param elementSizes
	     * @param clientX
	     * @param clientY
	     */
	    createPlaceHolder : function(elementSizes, clientX, clientY, overElement, verticalLayout) {
		    //view SubAnswer placeholder
		    var positionOfLastChild = 0, lastChildIndex = 0, ph;

            if (!!verticalLayout) {
	            ph = this.setVerticalPlaceHolder(clientY, lastChildIndex, positionOfLastChild, elementSizes, this);
            } else {
	            ph = this.setHorizontalPlaceHolder(lastChildIndex, clientX, positionOfLastChild, elementSizes, this);
            }
            
            this._view.append(ph);

		    delete ph;
        },
        /**
         * remove placeholder div (find it by id)
         */
        removePlaceHolder : function() {
            jQuery('[id=' + '"' + this.cfg.id + '_placeholder' + '"]').removeNative();
        }
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/subAnswer/MultiSubAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subAnswer/MultiSubAnswer.js
////////////////////////////////////////
(function() {

    var constants = t2k.component.subAnswer.MultiSubAnswerConstants;

    /*
     * MultiSubAnswer - collection of subAnswers
     */
    t2k.component.subAnswer.MultiSubAnswer = t2k.component.Composite.subClass({

        name: 't2k.component.subAnswer.MultiSubAnswer',

        /*
         * @constructor
         * @param config - {Object} configuration
         */
        ctor: function(config) {
             // Delegate
        	var thi$ = this;
            
            // call base class ctor
            this._super(config);

            this.initParams();

            this.initView();

            copy(this.cfg, prepareConfiguration(this.cfg.data));

            // start composite functionality
            this.startComposite2(copy({
                parent: this.view.cfg.id + '_content',
                dndContainer : 'mtq',
                mode : this.cfg.dndModes.subAnswer,
                IsBank : this.cfg.IsBank,
                bankMode : this.cfg.bankMode,
                resetIncorrect : this.cfg.resetIncorrect,
                ownerObject : this,
	            taskViewDomElement : this.cfg.taskViewDomElement
            }, this.cfg));

            if ((!!!this.cfg.IsPlaceholders) && (!!this.cfg.IsBank)) {
                this.children.forEach(function(child) {
                    child.view._content.css('float', ENV.contentDirection == "ltr" ? "left" : "right");
                });
            }

        },
        /**
         * initView
        */
        initView : function(){
            //ref.
            var thi$ = this;

	        if (this.cfg.dndModes.multiSubAnswer) {
		        // init view
		        this.view = this.createNewView(t2k.component.subAnswer.MultiSubAnswerView, override(this.cfg, {

			        registerEvents : this.dndEventsNames,

			        events : {
				        //catching DOM events and translating it to dnd behavior
				        catchEvent : function(event) {
					        var eventMeaning = thi$.eventsMap[event.type];  //event meaning translation by the event type

					        if ((thi$.dndBehaviour.startDraggingEvent == thi$.dndBehaviour.droppingEvent) //in case of equal event types
						        && ((thi$.eventsMap[event.type] == 'droppingEvent') || (thi$.eventsMap[event.type] == 'startDraggingEvent'))) {
						        eventMeaning = (dndManager.inDragObject) ? 'droppingEvent' : 'startDraggingEvent';
					        }

					        switch (eventMeaning) {
						        case 'startDraggingEvent' :
							        thi$.startDraggingEvent(event);
							        break;
						        case 'draggingEnter' :
							        thi$.draggingEnter(event);
							        break;
						        case 'draggingLeave' :
							        thi$.draggingLeave(event);
							        break;
						        case 'droppingEvent' :
							        thi$.droppingEvent(event);
							        break;
					        }
				        },
				        //create dropping event and do drop
				        doDroppingEvent : function(config) {
					        var event = jQuery.Event(getEventName(thi$, 'droppingEvent'));
					        thi$.droppingEvent(event, config.dropAnswerId);
				        },
				        //set lastChild Index
				        setLastChildIndex : function(config) {
					        thi$.lastChildIndex = config.lastChildIndex;
				        }

			        }

		        }));
	        } else {

		        this.view = this.createNewView(t2k.component.subAnswer.MultiSubAnswerView, this.cfg);

	        }

        },

        /**
         * initParams - class parameters initialization
         */
        initParams : function(){
	        /**Start Drag And Drop**/
	        if (this.cfg.dndModes.multiSubAnswer) {
		        this.dndMode = this.cfg.dndModes.multiSubAnswer;
		        this.dndContainer = 'multiSubAnswer';
		        this.droppable;
		        this.draggable;
		        this.afterDrag;
		        this.afterDrop;
		        this.beforeDrop;
		        this.eventsMap = [];
		        this.clientX = 0;
		        this.clientY = 0;

		        this.analizeDNDMode(this.dndMode);
		        var selectedDNDBehaviour = (ENV.behaviors.dragAndDropBehaviorTablets ? ENV.behaviors.dragAndDropBehaviorTablets : ENV.dragAndDropBehavior);
		        this.dndBehaviour = this.analizeDNDBehaviour(selectedDNDBehaviour);
		        this.dndEventsNames = this.registerDNDEventsNames();
	        }
	        /**End Drag And Drop**/


            this.elementSizes;
            this.numOfAnswers = 0;
            this.overElement;
            this.lastChildIndex;  //index of child to insert new child after
            this.lastCreatedChild;
            this.childReductionStep = 0;
            this.childOptimumFontSize = 0;

            // init vertical layout - true
            this.layout.verticalLayout = true;

	        this.remSize = jQuery('.player').css('font-size').px2int();
        },

        /**
         * setEnabled
         * @param flag
         */
        setEnabled: function(flag) {
            this._super(flag);

	        if (flag) {
		        if (this.cfg.dndModes.multiSubAnswer) {
			        this.analizeDNDMode(this.dndMode);
			        this.manageDND();
			        this.manageSALists();
			        this.view.bindDNDEvents(this.cfg.registerEvents);
		        }
		        this.view.markAsEnable();
	        } else {
		        this.view.markAsDisable();
	        }
        },

	    addMyState:function () {
		    var state = jQuery('<state/>');
		    return state;
	    },

	    /**
	     * @name setMyState
	     * @desc override - set state of component
	     * @param state
	     */
	    setMyState : function(state) {
		    this.state = state;

		    if (!!state) {
			    var thi$ = this;

			    this.setEnabled(jQuery(state).attr('enabled') === 'true');

			    //in hidden multi sub answer need to create children from state
			    var arrChildren = state.find('subanswer'), thi$ = this;

			    if (!this.cfg.IsPlaceholders && arrChildren.length) {

				    if(!this.cfg.IsBank) { //remove all children
					    var oldChildren = this.children.slice(0);
				    }

				    //remove children
				    this.children = [];
				    this.view.children = [];

				    thi$.lastChildIndex = 0;
				    jQuery(arrChildren).each(function (index, item) {
					    //remove prev child from dndManager lists
					    dndManager.removeSubAnswer(jQuery(item).children("id").text(), true);
					    thi$.createChild(item);
					    thi$.lastChildIndex += 1;
				    });

				    jQuery(oldChildren).each(function (index, item) {
					    thi$.remove(item);
					    item.view.dispose();
				    });
			    }
		    }
		 },

        /**
         * getMaxCountOfExpectedCorrects
         * return max length of correct answers sets
         */
        getMaxCountOfExpectedCorrects : function() {
            var countOfAnswers = 0;

            jQuery.each(this.cfg.answers.correct, function(index, objCorrectAnswer) {
                var arrCorrectAnswers = objCorrectAnswer.split(',');
                if (arrCorrectAnswers.length > countOfAnswers) {
                    countOfAnswers = arrCorrectAnswers.length;
                }
            });

            return countOfAnswers;
        },
        /**
         * set component size
         */
        setSize : function(numOfAnswers, elementSizes) {

            this.elementSizes = elementSizes;
            this.numOfAnswers = numOfAnswers;
            var elementWidth = elementSizes.width;
            var elementHeight = elementSizes.height; //numOfAnswers *

	        this.containerSize = this.view.setSize(numOfAnswers, elementWidth, elementHeight, this.layout.verticalLayout);
        },
       
        /**
         * applyHorizontalStyle
         */
        applyHorizontalStyle : function() {
            this.layout.verticalLayout = false;
            this.view.applyHorizontalStyle(this.horizontalSize);
        },

        /**
         * getHorizontalSize
         * calculates component horizontal size
         */
        getHorizontalSize : function(layoutStatus) {
            // different size calculation for visable or hidden multiSubAnswer
            this.horizontalSize = this.cfg.IsPlaceholders ? this.getVisibleHorizontalSize(layoutStatus) : this.getHiddenHorizontalSize(layoutStatus);
            return this.horizontalSize;
        },
        
        /**
         * getVisibleHorizontalSize
         */
        getVisibleHorizontalSize : function() {

	        var compositeWidth = this.view.cfg.parent.parents('.task_wrapper_internal').width(),
		        widthCounter = 0,
		        compositeHeight = 0,
		        numOfLines = 1,
		        elementsMap = {};

	        var domChildren = this.view._content.children(), numOfChildren = domChildren.length;

	        for (var index = 0; index < numOfChildren; index++) {

		        var childId = jQuery(domChildren[index]).attr('id');
		        if (!childId) continue;

		        var childIndex = this.getChildIndexById(childId);
		        var item = {};

		        var childSize = this.children[childIndex].getSize();

		        item.index = index;
		        item.width = childSize.width + (constants.paddingOfSubAnswer * this.remSize);
		        item.height = childSize.height + (constants.paddingOfSubAnswer * this.remSize);

		        widthCounter += item.width;

		        if (index == 0) {
			        compositeHeight += item.height;
		        }

		        if (widthCounter >= compositeWidth) {
			        // increace num of lines
			        numOfLines++;
			        compositeWidth = widthCounter - item.width;
			        widthCounter = 0;
			        compositeHeight += item.height;
		        }

		        if (!elementsMap[numOfLines]) {
			        elementsMap[numOfLines] = 0;
		        }

		        elementsMap[numOfLines]++;
	        }

	        // manual 'squeezeComposite'
	        // only if there is more than one line in the bank
	        if (numOfLines > 1) {
		        // calc optimum number of children per line
		        var optimumNumChildrenPerLine = Math.round(numOfChildren / numOfLines);

		        // calc the composite width
		        compositeWidth = 0;
		        for(var i = 0; i<optimumNumChildrenPerLine; i++) {
			        compositeWidth += this.children[i].getSize().width + (constants.paddingOfSubAnswer * this.remSize);
		        }

	        } else {
		        for(var i = 0; i<this.children.length; i++) {
			        compositeWidth += this.children[i].getSize().width + (constants.paddingOfSubAnswer * this.remSize);
		        }
	        }

	        return {'width' : compositeWidth, 'height' : compositeHeight};
        },
        
        /**
         * getHiddenHorizontalSize
         */
        getHiddenHorizontalSize : function() {
            this.horizontalSize = {'width' : 0, 'height' : 0 };

            this.horizontalSize.width =  (this.elementSizes.width + (constants.sideMarginOfSubAnswer * this.remSize)) * this.numOfAnswers +
                                         ((constants.paddingOfMultiAnswer * this.remSize * 2) - (constants.sideMarginOfSubAnswer * this.remSize))  +
                                          constants.borderOfMultiSubAnswer * 2;
            this.horizontalSize.height = (this.elementSizes.height + (constants.paddingOfMultiAnswer * this.remSize * 2)
	                                      + (constants.borderOfMultiSubAnswer * 2));

            return this.horizontalSize;
        },
        
        /**
         * getVerticalSize
         * calculates component Vertical size
         */
        getVerticalSize : function() {
            // different size calculation for visable or hidden multiSubAnswer
            this.verticalSize = this.cfg.IsPlaceholders ? this.getVisibleVerticalSize() : this.getHiddenVerticalSize();
            return this.verticalSize;
        },

        applyVerticalSize : function(){
            this.layout.verticalLayout = true;
            this.view.applyVerticalSize(this.verticalSize);
        },

        setVerticalLayout : function(){
            if (!this.layout.verticalLayout){
                this.layout.verticalLayout = true;
                this.view._view.css({'width' : '', 'height' : ''}).removeClass('horizontal');
            }

        },

        /**
         * getVisibleVerticalSize
         */
        getVisibleVerticalSize : function(){

            var child = this.children[0];
            var childSize = child.getSize();
            
            var size = {'width' : 0, 'height' : 0};

            var heightAddition = child.view._view.css('marginTop').px2int() +  child.view._view.css('marginBottom').px2int();

            size.width = childSize.width;
            size.height = (heightAddition * (this.children.length - 1)) + (childSize.width * this.children.length);
            return size;

        },
        
        /**
         * getHiddenVerticalSize
         */
        getHiddenVerticalSize : function() {
            this.verticalSize = {'width' : 0, 'height' : 0 };
            this.verticalSize.width = this.containerSize.width;
            this.verticalSize.height = this.containerSize.height;
            return this.verticalSize;
        },

        /************** Drag And Drop ************************/
        /**
         * analizeDNDMode
         * @param dndMode
         */
        analizeDNDMode : function(dndMode) {
            var dndModeConfig = constants.dndModes[dndMode];  //clickAndDrop or dragAndDrop

            if (dndModeConfig) {
                this.droppable = dndModeConfig.droppable;
                this.draggable = dndModeConfig.draggable;
                this.afterDrag = dndModeConfig.afterDrag;
                this.afterDrop = dndModeConfig.afterDrop;
                this.beforeDrop = dndModeConfig.beforeDrop || '';
            }

        },
        /**
         * analizeDNDBehaviour
         * usually it's dragAndDrop. In case of tablet PC may be clickAndDrop
         * @param dndBehaviour
         */
        analizeDNDBehaviour :function(dndBehaviour) {
            var dndBehavioursConfig = t2k.component.subAnswer.MultiSubAnswerConstants.dndBehaviour[dndBehaviour]; //event mapping object of the current behavior
            return dndBehavioursConfig;
        },

        /**
         * manageDND
         */
        manageDND : function() {
            // if the component is draggable add to DNDManager draggables
            if (!!this.draggable) {
                dndManager.addDraggable(this.view.cfg.id, this);
            } else {
                dndManager.removeDraggable(this.view.cfg.id);
            }

            // if the component is droppables add to DNDManager droppables
            if (!!this.droppable) {
                dndManager.addDroppable(this.view.cfg.id, this);
            } else {
                dndManager.removeDroppable(this.view.cfg.id);
            }
        },
        /**
         * manageSALists
         */
        manageSALists : function() {
            if (this.dndContainer == 'bank') {
                dndManager.addBankItem(this.view.cfg.id, this);
            } else {
                dndManager.addAnswerAreaItem(this.view.cfg.id, this);
            }
        },

        /**
         * registerDNDEventsNames
         * run through DND Behaviour map, check if event handler exists in the class and add it to events map
         * @returns dndEventsArray
         */
        registerDNDEventsNames : function() {
            var thi$ = this;
            var dndEventsArray = [];
            for (var dndEvent in this.dndBehaviour) {  // loop the array and check for double values
                if (jQuery.inArray(dndEvent, thi$.eventsMap) == -1) { //check for event existence in the events map array
                    dndEventsArray.push(this.dndBehaviour[dndEvent]);
                    thi$.eventsMap[this.dndBehaviour[dndEvent]] = dndEvent;
                }
            }
            return dndEventsArray;
        },

        /**
         * handling of the dragging event
         * @param event
         */
        startDraggingEvent : function(event) {
            dndManager.afterDrop(false);
        },
        /**
         * draggingEnter
         * @param event
         */
        draggingEnter : function(event) {

            if (dndManager.isInDragMode()) {

                if (this.children.length >= this.numOfAnswers) {
                    this.droppable = false;
                    dndManager.readyToDrop(false);
                    this.manageDND();
                }

                if (this.droppable) {
                    dndManager.readyToDrop(true);
                    this.view.markAsDroppable();
                    this.view.createPlaceHolder(this.elementSizes, this.clientX, this.clientY, dndManager.overObject, this.layout.verticalLayout);
                } else {
                    dndManager.readyToDrop(false);
                    this.view.markAsNotDroppable();
                }

            } else {
                if (this.draggable && !!this.isEnabled()) { //handleCanDrag
                    this.view.markAsDraggable();
                } else { //handleCantDrag
                    this.view.markAsNotDraggable();
                }
            }
        },
        /**
         * setOverElement
         * @param overElement
         */
        setOverElement : function(overElement) {
            this.overElement = overElement;
        },
        /**
         * setMousePosition
         * @param clientX
         * @param clientY
         */
        setMousePosition : function(clientX, clientY) {
            this.clientX = clientX;
            this.clientY = clientY;
        },
        /**
         * draggingLeave
         * @param event
         *  remove all dragging related css styles
         */
        draggingLeave : function(event) {
            if (!!this.isEnabled()) {
                this.overElement = null;
                dndManager.overObject = null;
                this.view.markAsNotDroppable();
                this.view.removePlaceHolder();
            }
        },
        /**
         * applyAfterDragg function
         */
        applyAfterDragg : function() {
            this.draggable = false;
            this.droppable = false;

            if (this.afterDrag) {
                var thi$ = this;

                var afterDragParams = this.afterDrag.split(',');
                for (var param in afterDragParams) {
                    switch (afterDragParams[param]) {
                        case 'draggable' :
                            thi$.draggable = true;
                            break;
                        case 'dropabble' :
                            thi$.droppable = true;
                            break;
                        case 'disable' :
                            thi$.setEnabled(false);
                            break;
                        case 'childDelete' :
                            //check if children length now less then count of answer make this MSA dropable
                            if (thi$.children.length <= thi$.numOfAnswers) {
                                this.droppable = true;
                                dndManager.readyToDrop(true);
                            }

                            break;
                    }
                }
            }

            this.manageDND();
        },

        /**
         * addChild function
         * @param child object
         */
        addChild:function (child) {

            if (!!!child) {
                return;
            }

            var xml = child.cfg.data;

            var childReductionStep = 0, childOptimumFontSize = 0;
            if (child.children.length > 0) {
                childReductionStep = child.children[0].view.reductionStep;
                childOptimumFontSize = child.children[0].view.optimumFontSize;
            }

            if (xml) {
                this.createChild(xml, child, childReductionStep, childOptimumFontSize); //create new subAnswer child (source of the dragged object)
            }
        },

        /**
         * perform dropping event
         * @param dropAnswerId
         */
        droppingBySystemEvent : function(dropAnswerId) {
            var draggSourceElement = dndManager.getBankItem(dropAnswerId);

            if (!!!draggSourceElement) {
                draggSourceElement = dndManager.getItem(dropAnswerId);
            }

            var sourceElement = (draggSourceElement ? draggSourceElement : dndManager.inDragObject);

            if(!!!draggSourceElement && !!!dndManager.inDragObject) {
                return;
            }

            var xml = (draggSourceElement ? draggSourceElement.cfg.data : dndManager.inDragObject.cfg.data);

            var childReductionStep = 0, childOptimumFontSize = 0;
            if (sourceElement.children.length > 0) {
                childReductionStep = sourceElement.children[0].view.reductionStep;
                childOptimumFontSize = sourceElement.children[0].view.optimumFontSize;
            }

            if (xml) {
                this.createChild(xml, draggSourceElement, childReductionStep, childOptimumFontSize); //create new subAnswer child (source of the dragged object)

                dndManager.afterDrop(true);     //set after drop flag - true

                this.applyAfterDrop(dropAnswerId, false);
            }
        },

        /**
         * droppingEvent
         * handling of the dropping event: create new subAnswer child
         * @param event
         * @param dropAnswerId
         */
        droppingEvent : function(event, dropAnswerId) {
            if (!this.isEnabled()) {
                return;
            }

            var isDroppableNow = true;

            if (!!this.beforeDrop) {
                var beforeDropParams = this.beforeDrop.split(',');
                for (var param in beforeDropParams) {
                    switch (beforeDropParams[param]) {
                        case 'checkIfDroppable' : //check multiSubAnswer full
                            isDroppableNow = (this.children.length < this.numOfAnswers);
                            break;
                    }
                }
            }

            if (!isDroppableNow) {
                dndManager.readyToDrop(false);
                return;
            }

            if (!!dropAnswerId) {  //simulate dropping event

                this.droppingBySystemEvent(dropAnswerId);

            } else if (!!dndManager.canDrop(this.view.cfg.id) && !!this.isEnabled() && !dndManager.dropStarted) {

	            dndManager.dropStarted = true;

                // dragged object bank source option - get, parse and send to factory
                var draggSourceElement = dndManager.getBankItem(dndManager.inDragObject.answerId);

                if (!this.cfg.IsBank) {
                    if (!!!draggSourceElement) {
                        draggSourceElement = dndManager.getItem(dndManager.inDragObject.answerId);
                    }
                }

                var sourceElement = (draggSourceElement ? draggSourceElement : dndManager.inDragObject);

                var xml = sourceElement.cfg.data;

	            //check for child xml inside subAnswer xml
	            if(xml.children.length == 0 && sourceElement.children.length) {
		            jQuery(xml).append(sourceElement.children[0].cfg.data);
	            }

                if (sourceElement.children.length > 0) {
                    this.childReductionStep = sourceElement.children[0].view.reductionStep;
                    this.childOptimumFontSize = sourceElement.children[0].view.optimumFontSize;
                } else {
                    this.childReductionStep = this.children[0].children[0].cfg.reductionStep;
                    this.childOptimumFontSize = this.children[0].children[0].cfg.optimumFontSize;
                }

                if (xml) {
                    this.createChild(xml, null, this.childReductionStep, this.childOptimumFontSize); //create new subAnswer child (source of the dragged object)
                    dndManager.afterDrop(true);    //set after drop flag - true
                }

                this.applyAfterDrop(dndManager.inDragObject.answerId, this.cfg.bankMode != 'dragAndCopy');
                this.view.markAsNotDroppable();

	            setTimeout(function() {
		            dndManager.dropStarted = false;
	            }, 0)
            }

        },
        /**
         * create subAnswer child
         * @param xml
         */
        createChild : function(xml, draggSourceElement, childReductionStep, childOptimumFontSize) {

            var lastChildIndex = this.lastChildIndex || 0;

            var insertBefore, insertAfter;

            if((lastChildIndex == 0) && (this.children.length > 0)){
                insertBefore = this.children[0].view._view;
            } else if((lastChildIndex > 0) && (this.children.length > 0) && (this.children.length > lastChildIndex)) {
                if(this.children[lastChildIndex]){
                    insertBefore = this.children[lastChildIndex].view._view;
                } else {
                    insertBefore = this.children[0].view._view;
                }

            } else {
               insertBefore = null;
               insertAfter = null;
            }

            //create subAnswer child
            var newChild = componentFactory.create({data: xml, parent: this.view._content.attr('id'),
                checkable : true,
                dndContainer : 'mtq',
                mode : 'dragAndDropToMultiAnswer',
                IsBank : this.cfg.IsBank,
                bankMode : this.cfg.bankMode,
	            taskmode: this.cfg.taskmode,
                firstKeyDown: this.cfg.firstKeyDown,
                resetIncorrect : this.cfg.resetIncorrect,
	            taskViewDomElement : this.cfg.taskViewDomElement,
                ownerObject : this,
                insertAfter: insertAfter,
                insertBefore : insertBefore,
                reductionStep : childReductionStep,
                optimumFontSize : childOptimumFontSize,
                content_css : {'float' : ENV.contentDirection == "ltr" ? "left" : "right"},
                onRendered : function() {},
                applyAbsoluteMinimum: true,
                onAbsMin : function(){}
            });

            if (newChild) {
                this.insert(newChild, lastChildIndex);
            } else {
                // log something
            }

            newChild.setEnabled(true);
            newChild.view.setElementSize(this.elementSizes);
            newChild.setAnswer(true);  //mark this subAnswer as answered after drop

            if (typeof newChild.cfg.firstKeyDown == 'function') { //check for function existence
                newChild.cfg.firstKeyDown();    //trigger progress event of the task
            }

            this.lastCreatedChild = newChild;

        },
        /**
         * remove wanted child from the children array
         * @param child
         */
        removeChild : function(child) {

            if (child) {
                //DOM manipulations cancel touch events
                //child.view.dispose();
                dndManager.insertIntoRecycleBin(child.view._view);

                this.remove(child);
                this.applyAfterDragg();
            }
        },
        /**
         * applyAfterDrop function
         */
        applyAfterDrop : function() {
            var thi$ = this;

            if (dndManager.afterDrop()) { //mouseLeave after dropping

                thi$.analizeDNDMode(thi$.dndMode);    //init draggable/droppable

                thi$.draggable = false;
                thi$.droppable = false;

                dndManager.overObject = null;
                dndManager.readyToDrop(false);

                var afterDropParams = thi$.afterDrop.split(',');
                for (var param in afterDropParams) {
                    switch (afterDropParams[param]) {
                        case 'draggable' :
                            thi$.draggable = true;
                            break;
                        case 'dropabble' :
                            thi$.droppable = true;
                            break;
                        case 'removePlaceHolder' :
                            thi$.view.removePlaceHolder();
                            break;
                    }
                }

                thi$.manageDND();
            }
        }

    });

    // Add checkable behavior to MultiSubAnswer
    t2k.component.subAnswer.MultiSubAnswer.addBehavior(t2k.behavior.checkable, {
        /*
         * isEmpty - Are we empty or we have at least 1 filled subAnswer
         */
        isEmpty: function() {
            var returnVal = true;

            jQuery.each(this.children, function(index, child) {
                if (!child.isEmpty()) {
                    returnVal = false;
                    return false;
                }
            });

            return returnVal;
        },

        /**
         * checkForPartOfSequence
         * @param index
         * @param checkResult
         * @param nextCorrectAnswer
         */
        checkForPartOfSequence : function(index, checkResult, prevCorrectAnswer, firstCorrectAnswer) {

            var prev_child = this.children[index - 1],
                first_child = this.children[index - 2],
                i;

            if (prev_child && first_child && (prev_child.answerId == prevCorrectAnswer) && (first_child.answerId == firstCorrectAnswer)) {
                prev_child.setEnabled(false);
                prev_child.state = 'partiallyCorrect';
                first_child.setEnabled(false);
                first_child.state = 'partiallyCorrect';
                return true;
            }
            return false;


        },
        /**
         * runCheck perform check for all subAnswer components according to the task mode
         */
        runCheck : function() {

            var checkResult = { correct: 0,
                partiallyCorrect: 0,
                predictedIncorrect: 0,
                incorrect: 0,
                expected: 0,
                checked: 0,
                empty: 0 };

            var thi$ = this;

            if (this.cfg.taskmode == 'sequencing') {  //check for correct answers in the specific order (order of set of correct answers)
                jQuery.each(thi$.cfg.answers.correct, function(index, objCorrectAnswer) {
                    var arrCorrectAnswers = objCorrectAnswer.split(',');

                    checkResult.expected = arrCorrectAnswers.length;

                    var child, index, iscorrectSequence, answer_index;

                    for (index = 0; index < thi$.children.length; index++) {
                        child = thi$.children[index];

                        if (!!child) {
                            checkResult.empty += child.isEmpty() ? 1 : 0;

                            if ((index < arrCorrectAnswers.length) && child.answerId == arrCorrectAnswers[index]) {
                                child.state = 'correct';
                            } else {
                                //check for part of sequence
                                //if answer isn't correct find index of this answer in correct answers set of 3 elements
                                answer_index = arrCorrectAnswers.indexOf(child.answerId);
                                if ((index >= 0) && (index - 2 >= 0)) {
                                    iscorrectSequence = thi$.checkForPartOfSequence(index, checkResult, arrCorrectAnswers[answer_index - 1], arrCorrectAnswers[answer_index - 2]);
                                } else {
                                    iscorrectSequence = false;
                                }

                                if (iscorrectSequence) {
                                    child.state = 'partiallyCorrect';
                                } else {
                                    child.state = 'incorrect';
                                }
                            }

                            child.setEnabled(false);
                        }
                    }

                    //set check result values and apply local feedback
                    for (var i = 0; i < thi$.children.length; i++) {
                        checkResult[thi$.children[i].state] ++;
                        thi$.children[i].setLocalFeedback(thi$.children[i].state);
                    };

                });


            } else {

                jQuery.each(thi$.cfg.answers.correct, function(index, objCorrectAnswer) {
                    var arrCorrectAnswers = objCorrectAnswer.split(',');

                    checkResult.expected = arrCorrectAnswers.length;

                    thi$.children.forEach(function(child) {
                        checkResult.empty += child.isEmpty() ? 1 : 0;

                        var IsCorrectAnswer = false;
                        var answerIndex = jQuery.inArray(child.answerId, arrCorrectAnswers);
                        IsCorrectAnswer = ((answerIndex > -1) && !child.isEmpty());

                        if (IsCorrectAnswer) {
                            arrCorrectAnswers.splice(answerIndex, 1);
                            checkResult.correct += 1;
                            child.setLocalFeedback('correct');
                        } else {
                            checkResult.incorrect += 1;
                            child.setLocalFeedback('incorrect');
                        }

                        if (child.view.children.length == 0) { //subAnswer is not empty
                            child.setLocalFeedback('full');
                        }

                        child.setEnabled(false);

                    });
                });
            }

            if (checkResult.empty == 0) {
                checkResult.empty = checkResult.expected - thi$.children.length;
            }

            return checkResult;
        },

	    reset: function() {
		    var copy_children = this.children.slice();

		    copy_children.forEach(function(child) {
			    child.reset();
		    });

		    delete copy_children;
	    },

        /**
         * reset all wrong children after pressing 'try again'
         */
        resetOnTryAgain : function() {

            var copy_children = this.children.slice();

            copy_children.forEach(function(child) {
                child.resetOnTryAgain();
            });

            delete copy_children;
        },
        /**
         * deleteWrongAnswers - remove wrong subAnswers after show answer
         */
        deleteWrongAnswers : function() {

            jQuery(this.children).each(function(index, child) {  //remove wrong subAnswers
                if (!child.isMarkedAsSystemCorrect() && !child.isMarkedAsCorrect()) {
                    child.deleteSubAnswer();
                }
            });

            //TODO: check for it
            if (this.children.length > this.cfg.answers.correct[0].split(',').length) {
                var child = (this.children[this.children.length - 1]);
                child.deleteSubAnswer();
            }

        },

        /**
         * onShowAnswer - after pressing show answer: set correct answer and mark as system answer
         */
        onShowAnswer : function() {
            var thi$ = this;

            if (this.cfg.taskmode == 'sequencing') {  //check for correct answers in the specific order (order of set of correct answers)

                thi$.lastChildIndex = 0;

                //get correct index children order based on set of correct answers
                //order children array based on this index

                var index_array = [], child, child_index, child_obj;

                jQuery.each(thi$.cfg.answers.correct, function(answersCount, objCorrectAnswer) {
                    var arrCorrectAnswers = objCorrectAnswer.split(',');

                    //remove distracted options
                    jQuery(thi$.children).each(function(index, child){
                        if(jQuery.inArray(child.answerId, arrCorrectAnswers) == -1) {
                            child.view.dispose();
                            thi$.remove(child);
                        }
                    });

                    //add missing answers
                    jQuery.each(arrCorrectAnswers, function (index, correctAnswerId) {
                        child_obj = thi$.findChildByAnswer(correctAnswerId);
                        if (!!!child_obj) { //this subanswer not found in the children - add it
                            thi$.droppingBySystemEvent(correctAnswerId);
                        }
                    });

                    //get correct index children order based on set of correct answers
                    jQuery.each(arrCorrectAnswers, function (index, correctAnswerId) {
                        child_obj = thi$.findChildByAnswer(correctAnswerId);

                        if(!!!child_obj) { //this subanswer not found in
                            child_index = -1
                        } else {
                            child_index = thi$.children.indexOf(child_obj);
                        }

                        if(child_index >=0) {
                            index_array.push(child_index);
                        }
                    });

                    //find missing indexes
                    thi$.orderChildren(index_array);
                });


                thi$.children.forEach(function (child) {
                    if (!child.isMarkedAsCorrect()) {
                        child.markAsSystemCorrect();
                        child.setEnabled(false);
                    }
                });

            } else if (!!!this.cfg.IsPlaceholders) {  //hidden template - keep correct answers, remove wrong and add missed

                jQuery.each(thi$.cfg.answers.correct, function (index, objCorrectAnswer) {
                    var arrCorrectAnswers = objCorrectAnswer.split(',');

                    arrCorrectAnswers.forEach(function (correctAnswerId) {
                        var child = thi$.findChildByAnswer(correctAnswerId);

                        if (!child) {
                            thi$.droppingBySystemEvent(correctAnswerId);
                            thi$.lastCreatedChild.setLocalFeedback('systemCorrect');
                            thi$.lastCreatedChild.setEnabled(false);
                        } else {
                            child.setLocalFeedback('correct');
                            child.setEnabled(false);
                        }

                    });

                });


            } else {

                jQuery.each(thi$.cfg.answers.correct, function(index, objCorrectAnswer) {
                    var arrCorrectAnswers = objCorrectAnswer.split(',');

	                var arrWrongChildren = [];

	                thi$.children.forEach(function(child) {
		                var IsCorrectAnswer = false;
		                var answerIndex = jQuery.inArray(child.answerId, arrCorrectAnswers);
		                IsCorrectAnswer = ((answerIndex > -1) && !child.isEmpty());

		                if (IsCorrectAnswer) {
			                arrCorrectAnswers.splice(answerIndex, 1);
			                child.setLocalFeedback('correct');
		                } else {
			                arrWrongChildren.push(child);
		                }
	                });

	                arrWrongChildren.forEach(function (child, i) {
		                child.setSystemAnswer(arrCorrectAnswers[0]);
		                arrCorrectAnswers.splice(0, 1);
		                child.setLocalFeedback('systemCorrect');
	                });
                });
            }

        },
        /**
         * findChildByAnswer
         * @param answerId
         */
        findChildByAnswer : function(answerId) {

            var correctChild;

            this.children.forEach(function(child) {
                if (child.answerId == answerId) {
                    correctChild = child;
                    return false;
                }
            });

            return correctChild;
        }

    })

})();
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/**
 * Private:
 * Function: prepareConfiguration
 * Extract the answers values from the xml
 *
 * Parameter:
 *  param - {XML} mSaXml The Multi subAnswer configuration XML.
 *
 * Returns:
 *  {Object} that contains answers values
 */
function prepareConfiguration(mSaXml) {
    // The result object.
    var result = {
        answers : {
            correct: []
        }
    };

    //Iterate the XML 'correct' options.
    jQuery(mSaXml).find("correct").find("set").each(function(index, elXml) {
        var answer = jQuery.trim(jQuery(elXml).text());
        result.answers.correct.push(answer);
    });

    // Return the result.
    return result;
} // End of prepareConfiguration

function getEventName(thi$, eventName) {
    var eventName;
    for (var key in thi$.eventsMap) {
        if (thi$.eventsMap[key] == eventName) {
            eventName = key;
        }
    }
    return eventName;
}
////////////////////////////////////////
// SRC End --> t2k/component/subAnswer/MultiSubAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subQuestion/SubQuestionView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div class='subQuestion' id='{{id}}'>\
        <div id={{id}}_content></div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.subQuestion.SubQuestionView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        },
        
        /**
         * compact
         * do nothing
         */
        compact : function(){
        	// don't compact me
        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/subQuestion/SubQuestionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/subQuestion/SubQuestion.js
////////////////////////////////////////
(function() {

    t2k.component.subQuestion.SubQuestion = t2k.component.Composite.subClass({
    	
    	/** The class' name (for debugging purpose). */
        name: 't2k.component.subQuestion.SubQuestion',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: {
            compact: [
                {spaceEater: 'textOnly'}
            ]
        },

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.view = this.createNewView(t2k.component.subQuestion.SubQuestionView, this.cfg);
            this.startComposite2({parent: this.view.cfg.id + '_content'});
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/subQuestion/SubQuestion.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/balloon/BalloonView.js
////////////////////////////////////////
(function () {

    var TEMPLATE =
        "<div id='{{id}}' class='balloon_popup hidden'>\
        	<div id='{{id}}_balloon_icon' class='balloon_icon hidden'><span id='correct'>8</span><span id='part'>5</span><span id='wrong'>></span></div>\
        	<div id='{{id}}_content' class='balloon_popup_content'></div>\
        	<div id='{{id}}_balloon_arrow' class='balloon_arrow'></div>\
        	<div id='{{id}}_balloon_close' class='balloon_close'>\
			    $\
			    <span class='mobile-touch-area'></span>\
        	</div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template:TEMPLATE,
        layout:'inline'
    }; // End of defaultConfig.

    t2k.component.balloon.BalloonView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.balloon.BalloonView',

        /**
         * 2d0 - complete doc
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            var thi$ = this;

            this._balloon_close.add(this._balloon_icon).click(function () {
                thi$.dispatchEvent('onClose');
            });
            /*
            if(ENV.behaviors.isTablet)(
	            this.balloon_popup.click(function () {
	            	thi$.dispatchEvent('onClose');})
        	);*/
        },

        removeContent:function () {
            this._content.html('').width('');
        },

        reset:function () {
            this._view.css('left', 0).removeClass('hidden').css('opacity', 0.01).width('');
        },

        show:function (cfg) {
            var thi$ = this,
                balloon = this._view,
                arrow = this._balloon_arrow,
                content = this._content,
                btn = this.cfg.btn = cfg.btn,
                balloonIcon = this._balloon_icon,
                constraint = this.cfg.constraint = jQuery(cfg.constraint),
                viewport = this.cfg.viewport = jQuery(cfg.viewport),
                icon = this.cfg.icon = cfg.icon,
                dir = this.cfg.open = cfg.open || 'bottom';

            //if allready has button, unwrap and set as not active
            if (this.current) {
                this._view.stop();
                this.current.removeClass('active').unwrap();
                this.current = null;
            }

            //wrap balloon with temp container and set active
            this.current = this.cfg.btn.addClass('active').wrap('<span class="balloon_wrapper" />');

            if (icon) balloonIcon.attr('class', 'balloon_icon').addClass(icon);
            else balloonIcon.addClass('hidden');

            //set content max width
            content.addClass(icon ? 'max_width_icon' : 'max_width');

            //hide close button
            if (cfg.close === false) this._balloon_close.addClass('hidden');

            //position content to center
            var top = content.position().top,
                content_height = content.height(),
                balloon_height = balloon.outerHeight(),
                margin_top = ((balloon_height - content_height) / 2) - top - 1;

            // set balloon view for pc
            //ENV.behaviors.setBalloonView || content.css('margin-top', margin_top + 'px');

            //position arrow
            arrow.removeClass('top bottom')
	             .addClass(dir)
	             .css((ENV.contentDirection == 'ltr' ? 'left' : 'right'), btn.offset().left);

            //calc arrow offset to position balloon
            var offset = calcOffset.call(this);

			positionBalloon.call(this, offset, function (pos) {

                // fix balloon content width
                //var contentWidth = ENV.behaviors.isIE ? content.outerWidth()-4 : content.outerWidth(); //var contentWidth = getBallonContentWidth.call(thi$);
                //content.outerWidth(contentWidth);

                dir = thi$.cfg.open = calcAdjastedDirection.call(thi$, viewport, pos);

                arrow.removeClass('top bottom')
	                 .addClass(dir)
	                 .css((ENV.contentDirection == 'ltr' ? 'left' : 'right'), btn.offset().left);

                offset = calcOffset.call(thi$, getOverflow.call(thi$, pos));

                if (hasOverflow.call(thi$, pos)) {
                    var diff = getOverflow.call(thi$, pos),
                        left = parseInt(arrow.css((ENV.contentDirection == 'ltr' ? 'left' : 'right')));

                    offset = calcOffset.call(thi$, diff);

                    //fix rtl bug
                    if (ENV.contentDirection == 'rtl') {
                        offset.left = offset.left - 2;
                        diff = diff - 2;
                    }

                    positionBalloon.call(thi$, offset);
                    arrow.css((ENV.contentDirection == 'ltr' ? 'left' : 'right'), Math.max(5, (ENV.contentDirection == 'ltr' ? left - diff : left + diff)));
                }
                else {
                    positionBalloon.call(thi$, offset);
                }

                var currTop = parseInt(thi$._view.css('top')),
                    diffTmp = 15,
                    animationTop = thi$.cfg.defaultAnimationTop = currTop + (dir == 'top' ? diffTmp : -(diffTmp));

                // hack for demo ! balloon need a small refactor
                var iconWidth = thi$._balloon_icon.width() + thi$._balloon_icon.css('margin-right').px2int() + thi$._balloon_icon.css('margin-left').px2int();
                var viewWidth = thi$._view.width();
                var contentMargins = thi$._content.css('margin-right').px2int() + thi$._content.css('margin-left').px2int() + 1;
                var maxContentWidth = viewWidth - iconWidth - contentMargins;

                // set balloon view for android
                !ENV.behaviors.setBalloonView || thi$._content.css({
                    'margin-top'    : 0,
                    'width'         : (maxContentWidth-4)
                });

                thi$._view.css({
                    'opacity':0,
                    'top':animationTop
                }).animate({
                        'opacity':1,
                        'top':currTop
                    }, ENV.behaviors.balloonButtonAnimateDuration);
            });

        },

        setNewWidth:function (maxTaskWidth) {
            var thi$ = this,
//                iconWidth = thi$._balloon_icon.outerWidth(true),
//                iconWidth =  (0.75 + 1.5) * ENV.REM,
            	iconWidth =  thi$._balloon_icon.css('font-size').px2int() + thi$._balloon_icon.css('margin-left').px2int() + thi$._balloon_icon.css('margin-right').px2int(),
                closeiconWidth = 18, // this is left / right coordinate + fontSize form css.
//                twoSidesBorder = this._view.css('border-width').px2int() * 2,
                twoSidesBorder =  2, //this is hardCoded 2 cause IE doesn't get the borderWidth
                contentMargins = thi$._content.css('margin-right').px2int() + thi$._content.css('margin-left').px2int(),
//                tmpWidth = ENV.behaviors.isIE ? newWidth + 4 : newWidth;
            // setting it always to max_width - according to task
                tmpWidth = this._view.css('max-width').px2int();
            	tmpWidth = (tmpWidth < maxTaskWidth) ? tmpWidth : maxTaskWidth;
            	
            	var maxContentWidth = tmpWidth - iconWidth - contentMargins - twoSidesBorder - closeiconWidth;
            	
                this._view.width(tmpWidth);

                thi$._content.width(maxContentWidth);
        },


        close:function () {
        	
            var thi$ = this;

            this._view.animate({
                'opacity':0,
                'top':this.cfg.defaultAnimationTop
            }, ENV.behaviors.balloonButtonAnimateDuration, function () {
                thi$._view.addClass('hidden');
                thi$._content.html('');

                //if allready has button, unwrap and set as not active
                if (thi$.current) thi$.current.removeClass('active').unwrap();
                thi$.current = null;
            });
        }
    });

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Private Functions.
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    function calcOffset(diff) {
	    var arrow = this._balloon_arrow,
		    left = (parseInt(arrow.css((ENV.contentDirection == 'ltr' ? 'left' : 'right'))) + arrow.width() / 2) * (ENV.contentDirection == 'ltr' ? -1 : 1),
		    top = (arrow.height() + 8) * (this.cfg.open == 'top' ? -1 : 1);

	    if (diff) left += diff;

	    return {left:left, top:top};
    }

    function calcAdjastedDirection(viewport, pos) {
        var balloon = this._view,
            height  = balloon.outerHeight(),
            balloon_bottom_dot  = this.cfg.btn.offset().top + this.cfg.btn.outerHeight() + height;

        return (ENV.behaviors.fixBalloonTop) ? 'top' : 
            ( ( balloon_bottom_dot > viewport.height() && this.cfg.btn.offset().top > height) ? 
                'top' : 'bottom');
    }

    function positionBalloon(offset, callback) {
        var position_cfg = {
            of:getCorrectBtn(this.cfg.btn),
            my:(ENV.contentDirection == 'ltr' ? 'left' : 'right') + ' ' + (this.cfg.open == 'top' ? 'bottom' : 'top'),
            at:'center ' + this.cfg.open,
            collision:'none none',
            using:callback
        }; 
        position_cfg.offset = ENV.contentDirection == 'ltr' ? offset.left + ' ' + offset.top : 'auto ' + offset.top;

        if (ENV.contentDirection == 'rtl') {
            this._view.css({'left':jQuery(this.cfg.btn).offset().left - this._view.outerWidth(), 'top':offset.top})
        }
        
        this._view
            .appendTo(this.cfg.btn.parent())
            .position(position_cfg);
    }

    function getBallonContentWidth() {
        var balloon = this._view,
            balloonIcon = this._balloon_icon,
            content = this._content,
            close = this._balloon_close;
        return balloon.width() -
            balloonIcon.width() - parseInt(balloonIcon.css('marginLeft')) - parseInt(balloonIcon.css('marginRight')) -
            parseInt(content.css('marginLeft')) - parseInt(content.css('marginRight'));
    }

    function hasOverflow(pos) {
        if (ENV.contentDirection == 'ltr') return pos.left < 0;
        else return this.cfg.constraint.width() < (pos.left + this._view.width());
    }

    function getOverflow(pos) {
        if (ENV.contentDirection == 'ltr') return 0 - pos.left;
        else return (pos.left + this._view.width() - this.cfg.constraint.width()) * -1;
    }

    function checkTopOverflow(currTop) {
        var viewportTop = 0;
    }

    function getCorrectBtn(btn) {
        return btn.find(':last-child').html() == '' ? btn.find(':first-child') : btn.find(':last-child');
    }
})();


////////////////////////////////////////
// SRC End --> t2k/component/balloon/BalloonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/balloon/Balloon.js
////////////////////////////////////////
(function () {

    t2k.component.balloon.Balloon = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.balloon.Balloon',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef:{
            init:[
//                {setBalloonSizeByChild:null},
                {showView:null},
                {setEnabled : true}

            ],
            compact:[

            ],
            loose:[

            ],
            reduce:[

            ]
        },

        ctor:function (config) {
            var thi$ = this;

            // Delegate
            this._super(config);
            // Create the view

            this.view = this.createNewView(t2k.component.balloon.BalloonView, copy(this.cfg, {
                events:{
                    onClose:function () {
                        thi$.close();
                    }
                }
            }));


        },

        show:function (cfg) {

            this.cfg = cfg;
            var cfgCopy = copy({}, cfg), thi$ = this;
            this.cfgCopy = cfgCopy;

            if (!cfgCopy.icon) this.cfg.icon = null;
            this.cfg = copy(cfgCopy, this.cfg);

            this.view.removeContent();
            this.view.reset();

            // 2d0: fix configuration - we're deleting the view template now
            delete this.cfg.template;

            this.layout.layoutSequenceCounter = 0;

            //init the composite properties to start over
            this.layout.onRenderedCounter = 0;
            this.children = [];
            this.layout.setLayoutSequence('init');
            //ends here

            //set the width of view._content , view._view according to task width
            var taskWidth = cfg.btn.parents('.task_wrapper_internal').width();
            this.view.setNewWidth(taskWidth);

            // init balloon component,
            // and show balloon on component render.
            var balloonComponent = this.startComposite2(override(this.cfg, {
                data:jQuery(this.cfg.data),
                setSrcAtStart : this.cfg.setSrcAtStart,
                parent:this.view._content,
                parentType:'balloon',
                dontEnableBlowup:true,
                container:this.view._content,
	            isBlowup: true,
                autoplay : false // this.cfg.autoplay - disable auto narration !!! up to CGT support
            }));

        },


        initCompositeLayouter:function () {
            this.cfg.data = jQuery('<data/>').attr('numOfChildren', 1);
            this._super();

        },

        showView:function () {
            this.view.show(this.cfgCopy);
            this.opened = true;
            this.compositeRenderComplete();
        },
//
//        setBalloonSizeByChild:function () {
//            var child = this.children[0];
//            //set the width of view._content , view._view according to image width
//            this.view.setNewWidth(child.view._view.width(), false);
//            this.compositeRenderComplete();
//
//        },

        close:function () {
            this.view.close();
            this.opened = false;
        },

        isOpened:function () {
            return this.opened;
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/balloon/Balloon.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/definition/DefinitionView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div class='definition' id='{{id}}'>\
            <div id='{{id}}_content'></div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.definition.DefinitionView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

	        this.maxSize = {'width' : 0, 'height' : 0}; //for mtqMathLayout
        },
        
        /**
         * getSize
         * override
         * @returns size
         */
        getSize:function () {
            //in case of empty definition return zero size
            if (this.children.length == 0) {
                return {'width':0, 'height':0};
            } else {

	            if(this.maxSize && this.maxSize.height > 0) {
		            return this.maxSize;
	            } else {
	                return this.children[0].getSize();
	            }

            }
        }
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/definition/DefinitionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/definition/Definition.js
////////////////////////////////////////
(function() {

    t2k.component.definition.Definition = t2k.component.Composite.subClass({

    	/** The class' name (for debugging purpose). */
        name: 't2k.component.definition.Definition',

        ctor: function(config) {
            // Delegate
            this._super(config);

            this.view = this.createNewView(t2k.component.definition.DefinitionView, this.cfg);
            this.startComposite2(copy({parent: this.view.cfg.id + '_content'}, config));
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();
////////////////////////////////////////
// SRC End --> t2k/component/definition/Definition.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqAreaView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqAreaView
     * @desc A MTQArea View class
     * @namespace t2k.component.mtq
     * @extends t2k.component.BaseComponentView
     */
    var TEMPLATE =
        "<div id='{{id}}' class='mtqArea vertical'>\
            <div id={{id}}_content></div>\
        </div>";

	var areaInnerPadding = 21;

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.mtq.MtqAreaView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        },
        
        /**
         * applyHorizontalStyle
         * @param size {width, height}
         */
        applyHorizontalStyle : function(size) {
	        this._view.find('.spacer').remove();
            this._view.css({'width' : size.areaWidth + areaInnerPadding}).removeClass('vertical').addClass('horizontal');
        },

        /**
         * applyVerticalStyle
         * @param size {width, height}
         */
        applyVerticalStyle : function(size) {
	        this._view.find('.spacer').remove();
            this._view.css('width', size.areaWidth).removeClass('horizontal').addClass('vertical');
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqAreaView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqArea.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqArea
     * @desc A MTQ Area class
     * @namespace t2k.component.mtq
     * @extends t2k.component.Composite
     */
    t2k.component.mtq.MtqArea = t2k.component.Composite.subClass({

        name: 't2k.component.mtq.MtqArea',

        ctor: function(config) {
            // Delegate
            this._super(config);

            /**
             * Calculate DnD modes mode
             * @type {Object}
             */
            this.dndModes = calcDndModes(config);

            /**
             * check if random required
             * @type {Boolean}
             */
            this.IsRandom = !!this.cfg.IsRandom;

	        //in case of no bank randomize with flip of children
	        if (!this.cfg.dummyMode && !this.cfg.IsBank) {
		        // always random on first run
		        var firstRun = true, childrenCount = this.cfg.data.children.length;

		        while (this.allCorrect(firstRun) && childrenCount--){
			        this.xmlRandomize(this.cfg.mode == 'matching');
			        // on second run etc.. check.
			        firstRun = false;
		        }
	        }

            /**
             * MtqAreaView
             * @type {Object}
             */
            this.view = this.createNewView(t2k.component.mtq.MtqAreaView, this.cfg);

            // start composite
            this.startComposite2({
                parent:this.view.cfg.id + '_content',
                mode:this.cfg.mode,
                dndModes:this.dndModes,
                IsPlaceholders:this.cfg.IsPlaceholders,
                bankMode:this.cfg.bankMode,
                IsBank:this.cfg.IsBank,
                resetIncorrect:this.cfg.resetIncorrect,
                firstKeyDown:this.cfg.firstKeyDown,
                checkable:true,
                insertBefore:config.insertBefore,
                reductionStep:config.reductionStep,
                optimumFontSize:config.optimumFontSize,
	            taskViewDomElement:config.taskViewDomElement
            });

	        if (this.IsRandom && (this.cfg.mode != 'sequencing')) {
		        this.view.domRandomize();
	        }

        },
        
        /**
         * allCorrect
         * check if cgf.data (xml) set by correct sunAnswers
         * @param firstRun {Boolean}
         * @returns {Boolean}
         */
        allCorrect : function(firstRun){
        	
        	// on first run - all answers are correct
        	if (firstRun) return true;
        	// on second run etc.. check only the sorting mode (the rest is surely !allCorrect)
        	if (this.cfg.mode != 'sorting') return false;
        	
        	var $mSA, allCorrect = true;
        	// check sorting correctness
        	jQuery(this.cfg.data).find('multiSubAnswer').each(function(index, mSA){
        		$mSA = jQuery(mSA);
        		// get correct set array
        		var correctSetArray = $mSA.find('correct set').text().split(',');
        		
        		// loop subAnswers and check
        		$mSA.find('subAnswer').each(function(index, subAnswer){
        			var subAnswerId = jQuery(subAnswer).attr('answerId');
        			if (jQuery.inArray(subAnswerId, correctSetArray) == -1){
        				allCorrect = false;
        				return false;
        			}
        		});
        		
        		// exit each on false
        		if (!allCorrect){
        			return false;
        		}
        		
        	});
        	
        	// return value
        	return allCorrect;
        },

	    /**
	     * xmlRandomizeChildren
	     * random flip children in modes matching and sorting
	     */
	    xmlRandomizeChildren: function() {
			var xmlData = this.cfg.data, childrenCollection = xmlData.children, i, flipArray = [], placeHolder, target0, target1;

		    // init random idx
		    this.getRandomIdx(childrenCollection.length);

		    for (i = 0 ; i < childrenCollection.length / 2 ; i++) {
			    flipArray[i] = [ this.getRandomIdx(), this.getRandomIdx() ];
			    placeHolder = Compat.createNodeNextTo(this.cfg.data, 'placeHolder', true); //jQuery('<placeHolder/>') ---> IE9 fix
			    target0 = jQuery(childrenCollection[flipArray[i][0]]);
			    target1 = jQuery(childrenCollection[flipArray[i][1]]);

			    placeHolder.insertBefore(target0);
			    target0.insertBefore(target1);
			    target1.insertBefore(placeHolder);
			    placeHolder.remove();
		    }

	    },

        /**
         * xmlRandomize
         * randomize xml according to the mtq task mode - flip subAnswers or subAnswers children
         * @param flipChildren
         */
        xmlRandomize : function(flipChildren){

            var $xml = jQuery(this.cfg.data);

            var mtqAreaSubAnswersArray = $xml.children().find('subAnswer');
            var subAnswerSum = mtqAreaSubAnswersArray.length;

	        if(subAnswerSum === 0) {
		        return;
	        }

            // init random idx
            this.getRandomIdx(subAnswerSum);

            // reduce subAnswerSum to even number
            // 'flip array' [length = subAnswerSum / 2]
            // each index: [this.getRandomIdx(), this.getRandomIdx() ]

            var flipArray = [], placeHolder, target0, target1, i;

            if (!flipChildren) {  //flip subAnswers

                for (i = 0 ; i < subAnswerSum / 2 ; i++) {
                    flipArray[i] = [ this.getRandomIdx(), this.getRandomIdx() ];
                    placeHolder = Compat.createNodeNextTo(this.cfg.data, 'placeHolder', true); //jQuery('<placeHolder/>') ---> IE9 fix
                    target0 = jQuery(mtqAreaSubAnswersArray[flipArray[i][0]]);
                    target1 = jQuery(mtqAreaSubAnswersArray[flipArray[i][1]]);

                    placeHolder.insertBefore(target0);
                    target0.insertBefore(target1);
                    target1.insertBefore(placeHolder);
                    placeHolder.remove();
                }

            } else { //flip subAnswers children

                for (i = 0; i < subAnswerSum / 2; i++) {
                    flipArray[i] = [ this.getRandomIdx(), this.getRandomIdx() ];
                    placeHolder = Compat.createNodeNextTo(this.cfg.data, 'placeHolder', true); //jQuery('<placeHolder/>') ---> IE9 fix

                    // get target and subanswer answerId of 0 & 1
                    target0 = this.getSAchild(mtqAreaSubAnswersArray[flipArray[i][0]]);
                    var target0_answerId = jQuery(mtqAreaSubAnswersArray[flipArray[i][0]]).attr('answerId');

                    target1 = this.getSAchild(mtqAreaSubAnswersArray[flipArray[i][1]]);
                    var target1_answerId = jQuery(mtqAreaSubAnswersArray[flipArray[i][1]]).attr('answerId');

                    // flip xml
                    placeHolder.insertBefore(target0);
                    target0.insertBefore(target1);
                    target1.insertBefore(placeHolder);

                    // flip answerId
                    jQuery(mtqAreaSubAnswersArray[flipArray[i][0]]).attr('answerId', target1_answerId);
                    jQuery(mtqAreaSubAnswersArray[flipArray[i][1]]).attr('answerId', target0_answerId);

                    // remove place holder
                    placeHolder.remove();
                }
            }
        },

        /**
         * getSAchild
         * @param subAnswerObj
         * @return {Object}
         */
        getSAchild:function (subAnswerObj) {
            // retChild will be the subAnswer child, (not the correct tag)
            var retChild = jQuery(subAnswerObj).children('textviewer,imageviewer,mediaplayer,mathfield');
            if (retChild.length) return retChild;
            throw 'error on mtqArea getSAchild';
        },

        /**
         * getRandomIdx
         * @param val
         * @return {Number}
         */
        getRandomIdx : function(val){

            // if val, create the dummy array and return.
            if (typeof val == "number") {
                this.randomDummyArray = [];
                var i;

                for (i = 0; i < val; i++) {
                    this.randomDummyArray[i] = true;
                }

                return;
            }

            this.randomDummyArray = this.randomDummyArray || [];

            // init randomIdx with  available = false, to get in the while
            var randomIdx = {idx : 0, available : false}, count = 0;

            while (!randomIdx.available && count < this.randomDummyArray.length) {
                randomIdx.idx = Math.floor(Math.random() * this.randomDummyArray.length);
                randomIdx.available = this.randomDummyArray[randomIdx.idx];
                count++;
            }

            this.randomDummyArray[randomIdx.idx] = false;

            return randomIdx.idx;
        },

        /**
         * setEnabled
         * @param flag {Boolean}
         */
        setEnabled : function(flag){
            this._super(flag);

            this.children.forEach(function(child) {
                child.setEnabled(flag);
            });
        },

        /**
         * setMyState - override
         * set state of component
         * @param state {XML}
         */
        setMyState : function(state){

            if(state.length > 0){
                this.setEnabled(jQuery(state).attr('enabled') === 'true');

                var thi$ = this;

                //reverse current random order of bank subAnswers
                jQuery(this.view.xmlRandomRevert).children().each(function(index, line){

                    var firstElement = thi$.view.children[parseInt(jQuery(line).attr('firstindex'))];
                    var secondElement = thi$.view.children[parseInt(jQuery(line).attr('secondindex'))];

                    try {
                        if(jQuery.trim(jQuery(line).attr('action')) == 'insertBefore'){
                            firstElement._view.insertBefore(secondElement._view);
                        } else {
                            firstElement._view.insertAfter(secondElement._view);
                        }

                    } catch(e){
                        // do nothing
                    }

                });

                //apply reverse random order of bank subAnswers from state
                jQuery(state).find('randominsert').children().each(function(index, line){

                    var firstElement = thi$.view.children[parseInt(jQuery(line).attr('firstindex'))];
                    var secondElement = thi$.view.children[parseInt(jQuery(line).attr('secondindex'))];

                    try {
                        if(jQuery.trim(jQuery(line).attr('action')) == 'insertBefore'){
                            firstElement._view.insertBefore(secondElement._view);
                        } else {
                            firstElement._view.insertAfter(secondElement._view);
                        }

                    } catch(e){
                    }

                });
            }
        },

        /**
         * addMyState - override
         * get state of component
         * @return state
         */
        addMyState : function(){
            var state = jQuery('<state/>')
                .append(this.view.xmlRanDomInsert);
            return state;
        },

        /**
         * changeSize
         * @param bankElement
         */
        changeSize : function (bankElement){
            this.view.setWidth(bankElement);  // TODO: refactor on MTQ layouter
        },

        /**
         * getSqueezedSizes returns all possible sizes of the component based on current size
         * @return {Array}
         */
        getSqueezedSizes : function(parentWidth){

            var arrPermutations = [], areaWidth = 0, areaHeight = 0,
                childHeightMargin = 21, childWidthMargin = 0;

            // get vertical width
            var width = parentWidth + 1, size;

            while (width) {
                size = this.simulateSizeByWidth(width - 1);
                areaWidth = 0; areaHeight = 0;

                if (!size) {
                    width = null;
                } else {


                    //size than we got from simulateSizeByWidth function is neto without child margins
                    areaWidth = childWidthMargin * this.children.length;
                    areaHeight = childHeightMargin * this.children.length;

                    areaWidth += size.width;
                    areaHeight += size.height;

                    arrPermutations.push({'areaWidth' : areaWidth, 'areaHeight' : areaHeight, 'vertical' : true, 'layoutStatus' : this.layoutStatus});
                    width = size.width;
                }
            }

            return arrPermutations.slice();  //return cloned copy of array
        },

        /**
         * getHiddenHorizontalSize
         * @return {Array}
         */
        getHiddenHorizontalSize : function() {
	        var compositeWidth = this.cfg.parent.width(),
		        widthCounter = 0,
		        compositeHeight = 0,
		        numOfLines = 1,
		        elementsMap = {};

	        var domChildren = this.view._content.children(), numOfChildren = domChildren.length;

	        for (var index = 0; index < numOfChildren; index++) {

		        var childId = jQuery(domChildren[index]).attr('id');
		        if (!childId) continue;

		        var childIndex = this.getChildIndexById(childId);
		        var item = {};

		        var childSize = this.children[childIndex].getHorizontalSize();

		        item.index = index;
		        item.width = childSize.width;
		        item.height = childSize.height;

		        widthCounter += item.width;

		        if (index == 0) {
			        compositeHeight += item.height;
		        }

		        if (widthCounter > compositeWidth) {
			        // increace num of lines
			        numOfLines++;
			        compositeWidth = widthCounter - item.width;
			        widthCounter = 0;
			        compositeHeight += item.height;
		        }

		        if (!elementsMap[numOfLines]) {
			        elementsMap[numOfLines] = 0;
		        }

		        elementsMap[numOfLines]++;
	        }

	        // manual 'squeezeComposite'
	        // only if there is more than one line in the area

	        if (numOfLines > 1) {
		        // calc optimum number of children per line
		        var optimumNumChildrenPerLine = Math.round(numOfChildren / numOfLines);

		        // calc the composite width
		        compositeWidth = (this.children[childIndex].getHorizontalSize().width + 1) * optimumNumChildrenPerLine;

	        } else {
		        compositeWidth = (this.children[childIndex].getHorizontalSize().width);
	        }

	        return {'areaWidth' : compositeWidth, 'areaHeight' : compositeHeight};
        },

        /**
         * getHorizontalSize
         * @return {Object}
         */
        getHorizontalSize : function(parentWidth) {

            if(!this.cfg.IsPlaceholders) {
                return this.getHiddenHorizontalSize();
            }

            var compositeWidth = parentWidth || this.cfg.parent.width(),
                widthCounter = 0,
                compositeHeight = 0,
                numOfLines = 1,
	            childMargin = 21,
                elementsMap = {},
	            childObj = null,
	            childSize = null;

            var domChildren = this.view._content.children('.mtqSubQuestion'), numOfChildren = domChildren.length;

            for (var index = 0; index < numOfChildren; index++) {

                var childId = jQuery(domChildren[index]).attr('id');
                if (!childId) continue;

                var childIndex = this.getChildIndexById(childId);
                var item = {};

	            childObj = this.children[childIndex];
	            childSize = childObj.getHorizontalSize();

                item.index = index;
                item.width = childSize.width;
                item.height = childSize.height;

                widthCounter += item.width;

                if (index == 0) {
                    compositeHeight += item.height;
                }

                if (widthCounter > compositeWidth) {
                    // increace num of lines
                    numOfLines++;
                    compositeWidth = widthCounter - item.width;
                    widthCounter = 0;
                    compositeHeight += item.height;
                }

                if (!elementsMap[numOfLines]) {
                    elementsMap[numOfLines] = 0;
                }

                elementsMap[numOfLines]++;
            }

	        // manual 'squeezeComposite'
	        // only if there is more than one line in the area
	        if (numOfLines > 1) {
		        // calc optimum number of children per line
		        var optimumNumChildrenPerLine = Math.round(numOfChildren / numOfLines);

		        // calc the composite width
		        compositeWidth = 0;
		        for(var i = 0; i<optimumNumChildrenPerLine; i++) {
			        compositeWidth += this.children[i].getHorizontalSize().width + childMargin;
		        }

		        compositeWidth -= childMargin;
	        } else {
		        compositeWidth = 0;
		        for(var i = 0; i<this.children.length; i++) {
			        compositeWidth += this.children[i].getHorizontalSize().width + childMargin;
		        }
		        compositeWidth -= childMargin;
	        }

            var bordersWidth = (this.view._view.css("borderLeftWidth").px2int() + this.view._view.css("borderRightWidth").px2int());

            compositeWidth += bordersWidth;

            return {'areaWidth' : compositeWidth, 'areaHeight' : compositeHeight};
        },

        /**
         * setVerticalLayout
         */
        setVerticalLayout : function(){
            this._super();
            this.view._view.css({'width' : '', 'height' : ''}).removeClass('horizontal').removeClass('vertical');
        },

        /**
         * applyHorizontalStyle
         * @param size {width, height}
         */
        applyHorizontalStyle : function(size) {
            this.view.applyHorizontalStyle(size);

            this.children.forEach(function(child) {
                if (child.applyHorizontalStyle) {
                    child.applyHorizontalStyle();
                }
            });
        },

        /**
         * applyVerticalStyle
         * @param size
         */
        applyVerticalStyle : function(size) {
	        if(size.layoutStatus && (size.layoutStatus != this.layoutStatus)) {
		        !!this[size.layoutStatus] && this[size.layoutStatus]();
	        }

            this.view.applyVerticalStyle(size);
            this.children.forEach(function(child) {
                if (child.applyVerticalStyle) {
                    child.applyVerticalStyle();
                }
            });
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /*
     * calcDndMode - calculate subAnswer/multiSubAnswer DnD mode by the specified config
     * @param config - {Object} configuration
     */
    function calcDndModes(config) {
        // Consts
        var modes = {
            dragAndDropNoReplace: 'dragAndDropNoReplace',
            dragAndDropAndReplace: 'dragAndDropAndReplace',
            dragAndDropToMultiAnswer: 'dragAndDropToMultiAnswer',
            dragAndDropAndInsert: 'dragAndDropAndInsert'
        };

        var subAnswerDndMode = null;
        var multiSubAnswerDndMode = null;
        var dndModes = null;

        switch (config.mode) {
            case 'matching' :
                // Set mode for bank / no bank
                subAnswerDndMode = (config.IsBank) ? modes.dragAndDropNoReplace : modes.dragAndDropAndReplace;
                break;
            case 'sorting' :
            case 'sequencing' :
                // Set mode for hidden / visible
                if (config.IsPlaceholders) {
                    // Set mode for bank / no bank
                    subAnswerDndMode = (config.IsBank) ? modes.dragAndDropNoReplace : modes.dragAndDropAndReplace;

                } else { // (!config.IsPlaceholders)
                    subAnswerDndMode = modes.dragAndDropToMultiAnswer;
                    multiSubAnswerDndMode = modes.dragAndDropAndInsert;
                }

                break;
        }

        dndModes = {
            subAnswer: subAnswerDndMode,
            multiSubAnswer: multiSubAnswerDndMode
        };

        return dndModes;
    }

})();

////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqArea.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqSubQuestionView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqSubQuestionView
     * @desc A MtqSubQuestion View class
     * @namespace t2k.component.mtq
     * @extends t2k.component.BaseComponentView
     */
    var TEMPLATE =
        "<div id='{{id}}' class='mtqSubQuestion' >\
            <div id='{{id}}_content' class='mtqSubQuestion_content'></div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    t2k.component.mtq.MtqSubQuestionView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(override({}, config, defaultConfig));
        },

         /**
         * applyHorizontalStyle
         * @param size {width, height}
         */
        applyHorizontalStyle : function(size) {
            this.verticalLayout = false;
            this._view.css({'width' : size.width, 'display' : 'inline-block'}).removeClass('vertical').addClass('horizontal');
        },

	    applyVerticalStyle : function(size) {
		    this.verticalLayout = true;
		    this._view.css({'width' : size.width, 'display' : 'inline-block'}).removeClass('horizontal').addClass('vertical');

	    }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqSubQuestionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqSubQuestion.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqSubQuestion
     * @desc A MTQSubQuestion class
     * @namespace t2k.component.mtq
     * @extends t2k.component.Composite
     */
    t2k.component.mtq.MtqSubQuestion = t2k.component.Composite.subClass({

    	/** The class' name (for debugging purpose). */
        name: 't2k.component.mtq.MtqSubQuestion',

        ctor: function(config) {
            // Delegate
            this._super(config);

	        this.horizontalSize = null;
	        this.verticalSize = null;

            this.view = this.createNewView(t2k.component.mtq.MtqSubQuestionView, this.cfg);

            this.startComposite2(copy({
                parent: this.view.cfg.id + '_content',
                dndContainer : 'mtq',
                mode : this.cfg.dndModes.subAnswer,
                taskmode : this.cfg.mode,
                IsBank : this.cfg.IsBank,
                bankMode : this.cfg.bankMode
            }, config));

            /**
             * @property
             * @type {String}
             */
            this.layoutStatus = 'loose';
        },
        
        /**
         * returns component horizontal size {'width' : Int, 'height' : Int}
         * @return {Object}
         */
        getHorizontalSize : function() {
            var horizontalSize = {'width' : 0, 'height' : 0};

            var childrenMap = [], childSize;

            jQuery(this.children).each(function(index, child) {

                if (child.name.toLowerCase().indexOf('definition') >= 0) {
                    childSize = child.getSize(false);
                    if (childSize) {
                        childSize.name = 'definition';
                        childrenMap.push(childSize);
                    }
                } else {
                    // subAnswer only
                    childSize = child.getSize();
                    if (childSize) {
                        childSize.name = 'subAnswer';
                        childrenMap.push(childSize);
                    }
                }

            });

            var definitionHSize = {'width' : 0, 'height' : 0};
            var subAnswerHSize = {'width' : 0, 'height' : 0};
	        var widthAddition = 30; //2*14 - margins + 2*1 borders
	        var heightAddition = 21; //bottom margin
	        var definitionCompactWidthAddition = 21; //right-margin 21px from css

            if (this.layoutStatus == 'loose') {  // get loose horizontal size

                childrenMap.forEach(function(child) {
                    if (child.name == 'definition') { // get definition size
                        definitionHSize.width = child.width;
                        definitionHSize.height = child.height;
                    } else {
                        subAnswerHSize.width = child.width;
                        subAnswerHSize.height = child.height;
                    }
                });
                
                horizontalSize.width = (definitionHSize.width > subAnswerHSize.width ? definitionHSize.width : subAnswerHSize.width) + widthAddition;
                horizontalSize.height =  definitionHSize.height + subAnswerHSize.height + heightAddition;

            } else { // get compact horizontal size

                childrenMap.forEach(function(child) {
                    if (child.name == 'definition') { // get definition size
                        definitionHSize.width = child.width + definitionCompactWidthAddition;
                        definitionHSize.height = child.height;
                    } else {
                        subAnswerHSize.width = child.width;
                        subAnswerHSize.height = child.height;
                    }
                });

                horizontalSize.width = definitionHSize.width + subAnswerHSize.width + widthAddition;
                horizontalSize.height = (definitionHSize.height > subAnswerHSize.height ? definitionHSize.height : subAnswerHSize.height) + heightAddition;
            }

	        this.horizontalSize = horizontalSize;
            return this.horizontalSize;
        },

        /**
         * returns component vertical size {'width' : Int, 'height' : Int}
         * @return {Object}
         */
        getVerticalSize : function() {
            var verticalSize = {'width' : 0, 'height' : 0};

            var childrenMap = [], childSize;

            jQuery(this.children).each(function(index, child){

                if (child.name.toLowerCase().indexOf('definition') >= 0) {
                    childSize = child.getSize(true);
                    if (childSize) {
                        childSize.name = 'definition';
                        childrenMap.push(childSize);
                    }
                } else {
                    // multiSubAnswer only
                    childSize = child.getSize();
                    if (childSize) {
                        childSize.name = 'subAnswer';
                        childrenMap.push(childSize);
                    }
                }

            });

            var definitionVSize = {'width' : 0, 'height' : 0};
            var subAnswerVSize = {'width' : 0, 'height' : 0};
            var widthAddition, heightAddition;

            if (this.layoutStatus == 'loose') {  // get loose horizontal size
                childrenMap.forEach(function(child) {
                    if (child.name == 'definition') { // get definition size
                        definitionVSize.width = child.width;
                        definitionVSize.height += child.height;
                    } else {
                        subAnswerVSize.width = child.width;
                        subAnswerVSize.height = child.height;
                    }
                });

                heightAddition = 21;
                widthAddition = 21;

                //in loose state definitions are in the top and in the bottom of the multiSubAnswer
                verticalSize.width = (definitionVSize.width > subAnswerVSize.width ? definitionVSize.width : subAnswerVSize.width) + widthAddition;
                verticalSize.height = definitionVSize.height + subAnswerVSize.height + heightAddition;

            } else { // get compact horizontal size

                childrenMap.forEach(function(child) {
                    if (child.name == 'definition') { // get definition size
                        definitionVSize.width = child.width + 21;
                        definitionVSize.height += child.height;
                    } else {
                        subAnswerVSize.width = child.width;
                        subAnswerVSize.height = child.height;
                    }
                });

                heightAddition = 21;
                widthAddition = 30;

                verticalSize.width = definitionVSize.width + subAnswerVSize.width + widthAddition;
                verticalSize.height = (definitionVSize.height > subAnswerVSize.height ? definitionVSize.height : subAnswerVSize.height) + heightAddition;
            }

            this.verticalSize = verticalSize;

            return this.verticalSize;
        },

	    applyHorizontalStyle: function() {
		    this.view.applyHorizontalStyle(this.horizontalSize);
	    },

	    applyVerticalStyle: function() {
		    this.view.applyVerticalStyle(this.verticalSize);
	    }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqSubQuestion.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqMultiSubQuestionView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqMultiSubQuestionView
     * @desc A MtqMultiSubQuestion View class
     * @namespace t2k.component.mtq
     * @extends t2k.component.BaseComponentView
     */
    var template = "<div id='{{id}}' class='mtqMultiSubQuestion'>\
                        <div id='{{id}}_content' class='mtqMultiSubQuestion_content' />\
                    </div>";
    
    /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
        layout: 'inline',
        /** The mustache template to render. */
        template: template
    }; // End of defaultConfig.

    t2k.component.mtq.MtqMultiSubQuestionView = t2k.component.BaseComponentView.subClass({

        /*
         * @constructor
         * @param config - {Object} configuration
         */
        ctor: function(config) {
            this._super(override({}, config, defaultConfig));
            this.verticalLayout = true;
        },

        /**
         * in case of hidden template - put definitions on the top of the multiSubAnswer
         * @param layoutStatus
         */
        adjustDefinitionStyle : function(layoutStatus) {
            if (!this.verticalLayout && !this.cfg.IsPlaceholders) {
                if (layoutStatus == 'loose') {
                    if (this._content.children('.definition').length > 1) {
                        //put definitions on top of the multiSubAnswer
                        this._content.children('.definition').css({'width' : '', 'display': 'block'});  //

                        //put last definition on the right side of the multiSubAnswer
                        if(ENV.contentDirection == "ltr"){
                            this._content.children('.definition').last().css({'right': '14px', 'position' : 'absolute', 'top' : 0});
                            
                        }else{
                            this._content.children('.definition').last().css({'left': '14px', 'position' : 'absolute', 'top' : 0});
                            
                        }
                        

                    }
                } else { //place definitions on both sides of the multiSubAnswer
                    if(ENV.contentDirection == "ltr"){
                        this._content.children('.definition').css({'display': 'inline-block', 'right': '', 'position' : '', 'top' : ''});
                            
                        }else{
                            this._content.children('.definition').css({'display': 'inline-block', 'left': '', 'position' : '', 'top' : ''});
                            
                        }
                }
            } else {
	            (layoutStatus == 'loose') && this._content.children('.definition').css({'display': 'block'});
            }

        },

        /**
         * applyHorizontalStyle
         * @param size {width, height}
         */
        applyHorizontalStyle : function(size) {
            this.verticalLayout = false;
	        //add this view inner padding to the width
	        var widthAddition = 14;
            this._view.css({'width' : size.width + widthAddition, 'display' : 'inline-block'}).removeClass('vertical').addClass('horizontal');
        },

        /**
         * applyVerticalStyle
         * @param size {width, height}
         */
        applyVerticalStyle : function(size) {
            this.verticalLayout = true;
	        var widthAddition = 28;
	        this._view.css({'width' : size.width + widthAddition, 'display' : 'inline-block'}).removeClass('horizontal').addClass('vertical');
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqMultiSubQuestionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqMultiSubQuestion.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqMultiSubQuestion
     * @desc Collection of MTQ definitions and subAnswers
     * @namespace t2k.component.mtq
     * @extends t2k.component.Composite
     */
    t2k.component.mtq.MtqMultiSubQuestion = t2k.component.Composite.subClass({

        name: 't2k.component.mtq.MtqMultiSubQuestion',

        /*
         * @constructor
         * @param config - {Object} configuration
         */
        ctor: function(config) {
            // delegate 
            this._super(config);

            /**
             * @property
             * @type {Object}
             */
            this.view = this.createNewView(t2k.component.mtq.MtqMultiSubQuestionView, config);

            // start composite functionality
            this.startComposite2(copy({
                parent: this.view.cfg.id + '_content',
                mode: this.cfg.dndModes.multiSubAnswer,
                taskmode : this.cfg.mode,
                dndContainer : 'mtq',
                dndModes: this.dndModes,
                IsPlaceholders : this.cfg.IsPlaceholders,
                IsBank : this.cfg.IsBank,
                bankMode : this.cfg.bankMode,
	            taskViewDomElement : this.cfg.taskViewDomElement
            }, config));

            /**
             * @property
             * @type {String}
             */
            this.layoutStatus = 'loose';
	        this.view._view.css('display', 'block');
            this.view.adjustDefinitionStyle(this.layoutStatus);
	        this.remSize = jQuery('body').css('font-size').px2int();

        }, // end of ctor

        /**
         * compact
         */
        compact : function(){
            this._super();
	        this.view._view.css('display', 'block');
            this.view.adjustDefinitionStyle(this.layoutStatus);
        },
        
        /**
         * loose
         */
        loose : function(){
            this._super();
	        this.view._view.css('display', 'block');
            this.view.adjustDefinitionStyle(this.layoutStatus);
        },

        /**
         * applyHorizontalStyle
         *
         */
        applyHorizontalStyle : function() {
            this.view.applyHorizontalStyle(this.getHorizontalSize());
            this.view.adjustDefinitionStyle(this.layoutStatus);

            this.children.forEach(function(child) {
                if (child.applyHorizontalStyle) {
                    child.applyHorizontalStyle();
                }
            });
        },

        /**
         * applyVerticalStyle
         */
        applyVerticalStyle : function() {
            this.view.applyVerticalStyle(this.getVerticalSize());
            this.view.adjustDefinitionStyle(this.layoutStatus);

            this.children.forEach(function(child) {
                if (child.applyVerticalStyle) {
                    child.applyVerticalStyle();
                }
            });
        },

        /**
         * setVerticalLayout
         */
        setVerticalLayout : function(){
            this._super();
            this.view._view.css({'width' : '', 'height' : ''}).removeClass('horizontal');
        },

        /**
         * returns component horizontal size {'width' : Int, 'height' : Int}
         * @return {Object}
         */
        getHorizontalSize : function(){

            var horizontalSize = {'width' : 0, 'height' : 0};

            var childrenMap = [], childSize;

            jQuery(this.children).each(function(index, child){

                if (child.name.toLowerCase().indexOf('definition') >= 0) {
                    childSize = child.getSize();
                    if (childSize) {
                        childSize.name = 'definition';
                        childrenMap.push(childSize);
                    }
                } else if (child.getHorizontalSize) {
                    // multiSubAnswer only
                    childSize = child.getHorizontalSize();
                    if (childSize) {
                        childSize.name = 'multiSubAnswer';
                        childrenMap.push(childSize);
                    }
                }

            });

            var definitionHSize = {'width' : 0, 'height' : 0};
            var multiSubAnswerHSize = {'width' : 0, 'height' : 0};
            var marginAddition = 2 * this.remSize, paddingAddition = this.remSize;

            if (this.layoutStatus == 'loose') {  // get loose horizontal size

                childrenMap.forEach(function(child) {
                    if (child.name == 'definition') { // get definition size
                        definitionHSize.width += child.width;
                        definitionHSize.height = child.height;
                    } else {
                        multiSubAnswerHSize.width += child.width;
                        multiSubAnswerHSize.height = child.height;
                    }
                });
                
                //in loose state definitions are above the multiSubAnswer, first on the left edge and second is in the right edge
                horizontalSize.width = (definitionHSize.width > multiSubAnswerHSize.width ?
	                definitionHSize.width : multiSubAnswerHSize.width) +
	                (this.cfg.IsPlaceholders ? 0 : paddingAddition * 2);
                horizontalSize.height = definitionHSize.height + multiSubAnswerHSize.height + ((childrenMap.length) * marginAddition);

            } else { // get compact horizontal size

                childrenMap.forEach(function(child) {
                    if (child.name == 'definition') { // get definition size
                        definitionHSize.width += child.width + marginAddition;
                        definitionHSize.height = child.height;
                    } else {
                        multiSubAnswerHSize.width += child.width;
                        multiSubAnswerHSize.height = child.height;
                    }
                });

                //in compact state definitions are on both sides of the multiSubAnswer, first in the left and the second is in the right
                horizontalSize.width = definitionHSize.width + multiSubAnswerHSize.width;
                horizontalSize.height = (definitionHSize.height > multiSubAnswerHSize.height ? definitionHSize.height : multiSubAnswerHSize.height) + marginAddition;

            }

            this.horizontalSize = horizontalSize;
            return this.horizontalSize;
        },
        /**
         * returns component vertical size {'width' : Int, 'height' : Int}
         * @return {Object}
         */
        getVerticalSize : function(includeFullOuterSize) {
            var verticalSize = {'width' : 0, 'height' : 0};

            var childrenMap = [], childSize, definitionsCount = 0;

            jQuery(this.children).each(function(index, child){

                if (child.name.toLowerCase().indexOf('definition') >= 0) {
	                definitionsCount ++;
                    childSize = child.getSize();
                    if (childSize) {
                        childSize.name = 'definition';
                        childrenMap.push(childSize);
                    }
                } else if (child.getVerticalSize) {
                    // multiSubAnswer only
                    childSize = child.getVerticalSize();
                    if (childSize) {
                        childSize.name = 'multiSubAnswer';
                        childrenMap.push(childSize);
                    }
                }

            });

            var definitionVSize = {'width' : 0, 'height' : 0};
            var multiSubAnswerVSize = {'width' : 0, 'height' : 0};

            childrenMap.forEach(function(child) {
                if (child.name == 'definition') { // get vertical size
                    definitionVSize.width = child.width;
                    definitionVSize.height += child.height + 21;
                } else {
                    multiSubAnswerVSize.width = child.width;
                    multiSubAnswerVSize.height = child.height;
                }
            });

            //in loose state definitions are in the top and in the bottom of the multiSubAnswer
            verticalSize.width = (definitionVSize.width > multiSubAnswerVSize.width ? definitionVSize.width : multiSubAnswerVSize.width) +
            (includeFullOuterSize ? (this.remSize * 2) : 0);
            verticalSize.height = definitionVSize.height + multiSubAnswerVSize.height;

            this.verticalSize = verticalSize;
            return this.verticalSize;
        }

    });
    
})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqMultiSubQuestion.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/bank/BankConfig.js
////////////////////////////////////////

// Bank constant values
t2k.component.bank.BankConstants = {
	
		minOffsetTop  : 70,
		minOffsetBottom  : 50,
		scrollableSelector : 'div.sequence_content_scrollable',
		parentSelector : 'div.sequence_body',
		bankAppendToElement : 'div.player',
		maxWidthFactor : 3,
		bankPaddingReadOnly : 25,
		scrollBarWidth : 17,
        marginTop : 28,
        minViewportHeight: 150 //px

};


////////////////////////////////////////
// SRC End --> t2k/component/bank/BankConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/bank/BankView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.bank.BankView
     * @desc A bank view class
     * @namespace t2k.component.bank
     * @extends t2k.component.BaseComponentView
     */

    var TEMPLATE =
        "<div id='{{id}}' class='bank not_selectable'>\
        	<div id='{{id}}_content' class='bank_content'></div>\
        </div>";

    var TEMPLATE_READONLY =
        "<div id='{{id}}' class='bank_readonly not_selectable'>\
        	<div id='{{id}}_content' class='bank_content'></div>\
        </div>";

    /**
     * @name defaultConfig
     * @desc private, Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
        layout: 'tile',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    var defaultConfigReadOnly = {
        layout: 'tile',
        /** The mustache template to render. */
        template: TEMPLATE_READONLY
    };

    //copy all constants from BankConstants
    var constants = t2k.component.bank.BankConstants;

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Class Declaration
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    t2k.component.bank.BankView = t2k.component.BaseComponentView.subClass({
        /**
         * @constructor
         * @desc see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, (config.bankMode == 'readOnly' ? defaultConfigReadOnly : defaultConfig)));

            /**
             * @property
             * @desc The bank's view parent, jquery object
             * @type {Object}
             */
            this._parent = this._view.parent();

            /**
             * @property
             * @type {Object}
             * @desc log of actions to make random movement (insertBefore/insertAfter) of children
             */
            this.xmlRanDomInsert;

            /**
             * @property
             * @type {Object}
             * @desc log of actions in order to revert random movement of children (return to feeding order)
             */
            this.xmlRandomRevert;
        },

        /**
         * @name setEnabled
         * @param flag
         */
        setEnabled : function(flag) {
            this._super(flag);
            this.initScroll(flag);
        },

        /**
         * @name initScroll
         * @desc listen to the scroll event of scrollable div, in order to slide bank element up/down
         */
        initScroll : function(flag) {

            // ref
            var thi$ = this;

            var beSideComponent = thi$.cfg.getComponentBeSideToBank();
            var beSideElement = beSideComponent.view._view;
            var divWithScroll = jQuery(constants.scrollableSelector);  //div element with scrollbars

            var offset_top = 0;
            var bankWrapperDiv = null;
            var bankOffsetLeft = 0;

            //handler for scroll event on scrollable div
            function fncScrollHandler(e) {
		        var bankOuterWidth = thi$._view.outerWidth();
		        var bankOuterHeight = thi$._view.outerHeight();

	            if (!!thi$.isEnabled()) {

		            var div_scrollTop = (jQuery(this).scrollTop());
		            offset_top = (div_scrollTop - beSideElement.offset().top + constants.minOffsetTop);

		            bankWrapperDiv = jQuery(document.getElementById('bankWrapper' + thi$.cfg.id));

		            if (beSideElement.offset().top < constants.minOffsetTop) {  //bank element is near beside component - make bank position fixed
			            // create a div that append to the body
			            if (!bankWrapperDiv.length) {
				            if ((bankOffsetLeft == 0)) {
					            bankOffsetLeft = thi$._view.offset().left;
				            }

				            bankWrapperDiv = Perf.create("div").attr('id', 'bankWrapper' + thi$.cfg.id).css({'position':'fixed', 'top':constants.minOffsetTop + 'px',
					            'left':bankOffsetLeft + 'px', 'width':bankOuterWidth + 'px', 'height':'10px', 'zIndex':4}).appendTo(jQuery(constants.bankAppendToElement));

				            thi$._view.css({position:'absolute', top:0, left:0});
				            bankWrapperDiv.append(thi$._view);

			            } else if(bankWrapperDiv.children().length == 0) {
				            thi$._view.css({position:'absolute', top:0, left:''});
				            bankWrapperDiv.css({'position':'fixed', 'top':constants.minOffsetTop + 'px',
					            'left':bankOffsetLeft + 'px', 'width':bankOuterWidth + 'px', 'height':'10px', 'zIndex':4});
				            bankWrapperDiv.append(thi$._view);
			            }

		            } else if (beSideElement.offset().top >= constants.minOffsetTop) {

			            if (bankWrapperDiv.length > 0) {
				            var dv = thi$._view.detach();
				            thi$.cfg.parent.append(dv);
				            bankWrapperDiv = null; dv = null;
			            }

			            //set absolute position to the bank when scroll got to the top of the beside component
			            thi$._view.css({position:'absolute', top:0, left:'',
				            'width':bankOuterWidth + 'px', 'height':bankOuterHeight + 'px'});
		            }

		            //set absolute position when gets to the bottom of the beside component
		            if (beSideElement.offset().top + (beSideElement.height() - bankOuterHeight) <= constants.minOffsetBottom) {

			            if (bankWrapperDiv && bankWrapperDiv.length > 0) {
				            var dv = thi$._view.detach();
				            thi$.cfg.parent.append(dv);
				            bankWrapperDiv = null; dv = null;
			            }

			            thi$._view.css({position:'absolute', top:(beSideElement.height() - bankOuterHeight) + 'px', left:'',
				            'width':bankOuterWidth + 'px', 'height':bankOuterHeight + 'px'});
		            }
	            }
            }

	        // unbind scroll (prevent duplication)
            divWithScroll.unbind('scroll', fncScrollHandler);

            //don't scroll disabled bank
            if(!flag){
                return;
            }
            
            divWithScroll.scroll(fncScrollHandler);
        },

        /**
         * @name getElementSize
         * @desc return subAnswer width and height
         * @return {Object}
         */
        getElementSize: function() {
          if(this.children.length == 0) {
              return null;
          }

          var childSize = this.children[0].getSize();

          return childSize;
        },

        /**
         * @name adjustBankStyle
         * @param adjustChildren {Boolean}
         * @desc chech bank width vs taskWidth, set bank width max(0.33 * taskWidth),
         * check bankHeight vs. viewport Height
         * on adjustChildren = true, adjust childen style for correct alignment
         */
        adjustBankStyle : function(adjustChildren) {

            var sidesPadding = (parseInt(this._view.css('padding-right')) + parseInt(this._view.css('padding-left')));

            if (this.children.length > 0) {
                this.bankWidth = this.children[0]._view.outerWidth(false);

                this.bankWidth += (this.cfg.bankMode == "readOnly" ? constants.bankPaddingReadOnly : sidesPadding);

                if(this._view.css('overflow-y') == 'auto') {
                    this.bankWidth += constants.scrollBarWidth;
                }

            } else {
                this.bankWidth = Compat.fullOuterWidth(this._view);
            }

            this._view.width(this.bankWidth);
            this.bankHeight = this._view.outerHeight(true);

            //Maximum width of the bank
            var parentDiv = this._view.parent(), vpDiv = this._view.parents(constants.parentSelector);

            var vpWidth = jQuery(parentDiv).innerWidth();
            var vpHeight = jQuery(parentDiv).innerHeight() - constants.marginTop;

            if (this.bankHeight > vpHeight && vpHeight >= constants.minViewportHeight ) {
                var tmp = Math.ceil(this.bankHeight / vpHeight);
                var newWidth = (this.bankWidth * tmp) - ((tmp - 1) * (sidesPadding / 2));

                //check if the new width is smaller then one third of the working area's width
                var maxWidth = Math.floor(vpWidth / constants.maxWidthFactor);

                this._view.find('.spacer').remove();

                if (maxWidth < newWidth) {
                    newWidth = this.bankWidth + constants.scrollBarWidth;
                    this._content.height(vpHeight - constants.marginTop);
                    this._view.css('overflow-y', 'auto');
                }

                this.bankWidth = newWidth;
                this._view.width(this.bankWidth);
            }

            this.bankHeight = this._view.outerHeight(true);

            this._view.css('direction', this.direction);
        },

        /**
         * @name markAsEnable
         * @param removeReusable
         */
        markAsEnable : function(removeReusable) {
            this._view.removeClass('disabled');

        },

        /**
         * @name markAsDisable
         */
        markAsDisable : function() {
            this._view.addClass('disabled');

            var bankWrapperDiv = document.getElementById('bankWrapper' + this.cfg.id);
            if (!!bankWrapperDiv) {
                this._view.css({top : '', left : ''});
	            var dv = this._view.detach();
	            this.cfg.parent.append(dv);

	            bankWrapperDiv.parentNode.removeChild(bankWrapperDiv);
	            dv = null; bankWrapperDiv = null;
            }

        },

        /**
         * @name markAsActive
         * @param flag {Boolean}
         */
        markAsActive : function(flag) {
            if (!!flag) {
                this._view.removeClass('disabled');
            } else {
                this._view.addClass('disabled');
            }

        }

    });

})();

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//Private Functions.
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
////////////////////////////////////////
// SRC End --> t2k/component/bank/BankView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/bank/Bank.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.bank.Bank
     * @desc A bank class
     * @namespace t2k.component.bank
     * @extends t2k.component.Composite
     */
    t2k.component.bank.Bank = t2k.component.Composite.subClass({
    	
    	/** The class' name (for debugging purpose). */
        name: 't2k.component.bank.Bank',

        /**
         * @desc Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: 'tileSequence',

        /**
         * @name ctor
         * @param config
         * @desc constructor
         */
        ctor: function(config) {
        	// Delegate
        	this._super(config);

            /**
             * @property
             * @desc The bank's mode (readOnly, dragAndDisable, dragAndCopy)
             * @type {String}
             */
        	this.mode = this.cfg.bankMode;

            /**
             * @property
             * @type {Boolean}
             */
            this.IsBankRandom = this.cfg.IsBankRandom;

            this.initView();

            // add to special configuration.
            // special configuration is a configuration for subAnswer,
            // that init by closeAnswer or mtqAnswer
            this.addToSpecialConfiguration({
                parent:this.view.cfg.id + '_content',
                data: this.cfg.data,
                dndContainer:'bank',
                mode:this.mode,
                taskmode:this.cfg.mode,
                checkable:false,
	            taskViewDomElement:this.cfg.taskViewDomElement
            });

            // start composite
            this.startComposite2({
                parent:this.view.cfg.id + '_content',
                data: this.cfg.data,
                style:this.cfg.style,
                fontColor:this.cfg.fontColor,
                reductionStep:this.cfg.reductionStep,
                optimumFontSize:this.cfg.optimumFontSize});

            if(this.IsBankRandom){  //don't apply randomize
                this.view.domRandomize();
            }

            if (!!!this.cfg.type)  //if bank type is mtq - don't apply style manipulations
                var thi$ = this;
		        window['globalEvents'].add({
			        fnc:function () {
				        (!!thi$) && (!!thi$.view) && thi$.view.adjustBankStyle(thi$.mode);
			        }
		        });

        },

        /**
         * @name initView
         * @desc bank view initiation
         */
        initView : function(){
            /**
             * @desc bank view
             * @type {Object}
             */
             this.view = this.createNewView(t2k.component.bank.BankView,copy(this.cfg, {bankMode: this.mode}));
        },

        /**
         * @name setEnabled
         * @param flag {Boolean}
         */
        setEnabled: function(flag){
        	
        	if(!flag){
        		this.view.markAsDisable();
        	} else {
        		this.view.markAsEnable();
        	}

            jQuery(this.children).each(function(i, child) {
			   	child.setEnabled(true);
		    });

        	this._super(flag);
        },
        
        resetBankLockState: function () {
             jQuery(this.children).each(function(i, child) {
                child.resetBankLockState();
            });
            
        },

        /**
         * @name setMyState
         * @desc override, set state of component
         * @param flag {Boolean}
         */
        setMyState : function(state){

            if(state.length > 0){
                this.setEnabled(jQuery(state).attr('enabled') === 'true');
                
                var thi$ = this;

                //reverse current random order of bank subAnswers
                jQuery(this.view.xmlRandomRevert).children().each(function(index, line){

                    var firstElement = thi$.view.children[parseInt(jQuery(line).attr('firstindex'))];
                    var secondElement = thi$.view.children[parseInt(jQuery(line).attr('secondindex'))];

                    try {
                        if(jQuery.trim(jQuery(line).attr('action')) == 'insertBefore'){
                            firstElement._view.insertBefore(secondElement._view);
                        } else {
                            firstElement._view.insertAfter(secondElement._view);
                        }

                    } catch(e){
                        // do nothing
                    }

                });

                //apply reverse random order of bank subAnswers from state
                jQuery(state).find('randominsert').children().each(function(index, line){

                    var firstElement = thi$.view.children[parseInt(jQuery(line).attr('firstindex'))];
                    var secondElement = thi$.view.children[parseInt(jQuery(line).attr('secondindex'))];

                    try {
                        if(jQuery.trim(jQuery(line).attr('action')) == 'insertBefore'){
                            firstElement._view.insertBefore(secondElement._view);
                        } else {
                            firstElement._view.insertAfter(secondElement._view);
                        }

                    } catch(e){
                    }

                });
            }
        },

        /**
         * @name addMyState
         * @desc override, returns state of the bank component
         * @return Object
         */
        addMyState : function(){
           var state = jQuery('<state/>')
                .append(this.view.xmlRanDomInsert);
           return state;
        },

        /**
         * @name getElementSize
         * @desc returns bank subAnswer size (width, height)
         * @return Object
         */
        getElementSize: function(){
        	return this.view.getElementSize();
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();
////////////////////////////////////////
// SRC End --> t2k/component/bank/Bank.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqBankView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqBankView
     * @desc A MTQ bank view class
     * @namespace t2k.component.mtq
     * @extends t2k.component.bank.BankView
     */
     var TEMPLATE =
        "<div id='{{id}}' class='mtqBank vertical not_selectable'>\
        	<div id='{{id}}_content' class='mtqBank_content'></div>\
        </div>";
     /**
     * Private: defaultConfig
     * Hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	layout: 'tile',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.
    
    t2k.component.mtq.MtqBankView = t2k.component.bank.BankView.subClass({
         /** The class' name (for debugging purpose). */
        name: 't2k.component.mtq.MtqBankView',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            config = override(config, defaultConfig);
            this._super(config);
        },
        /**
         * initScroll
         * listen to the scroll event of scrollable div, in order to slide bank element up/down
         */
        initScroll : function(flag) {
            
        }
    })
        
})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqBankView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mtq/MtqBank.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mtq.MtqBank
     * @desc A MTQ Bank class
     * @namespace t2k.component.mtq
     * @extends t2k.component.bank.Bank
     */
    var bankMargin = 21;

    t2k.component.mtq.MtqBank = t2k.component.bank.Bank.subClass({

    	/** The class' name (for debugging purpose). */
        name: 't2k.component.mtq.MtqBank',

        /**
         * @name layoutSequenceDef
         * @desc Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         * @member
         * @type Object
         */
        layoutSequenceDef: 'tileSequence',

        ctor: function(config) {
            config.type = 'mtqBank';
            this._super(config);
        },

        /**
         * initView
         */
        initView : function(){
            this.view = this.createNewView(t2k.component.mtq.MtqBankView, copy(this.cfg, {bankMode: this.mode}));
        },
        
        /**
         * setVerticalLayout
         */
        setVerticalLayout : function(){
            var sideObjectWidth = parseInt(Compat.fullOuterWidth(this.cfg.getComponentBeSideToBank().view._view));
            
        	var parentWidth = this.view.cfg.parent.width();

            var remainderWidth = (parentWidth - sideObjectWidth);
            var size = this.simulateSizeByWidth(remainderWidth);

            this.view._view.find('.spacer').remove();
            this.view.setWidth(size ? size.width - (bankMargin * 2) : '');
            this.view._view.css({'height' : ''}).removeClass('horizontal').addClass('vertical');
        },

        /**
         * returns component horizontal size {'width' : Int, 'height' : Int}
         * @return {Object}
         */
        getHorizontalSize : function(parentWidth) {

	        var compositeWidth = parentWidth || this.cfg.parent.width(),
		        widthCounter = 0,
		        compositeHeight = 0,
		        numOfLines = 1,
		        childMargin = 21,
		        elementsMap = {},
		        childObj = null,
		        childSize = null;

	        var domChildren = this.view._content.children(), numOfChildren = domChildren.length;

	        for (var index = 0; index < numOfChildren; index++) {

		        var childId = jQuery(domChildren[index]).attr('id');
		        if (!childId) continue;

		        var childIndex = this.getChildIndexById(childId);
		        var item = {};

		        childObj = this.children[childIndex];
		        childSize = childObj.getSize();

		        item.index = index;
		        item.width = childSize.width;
		        item.height = childSize.height;

		        widthCounter += item.width;

		        if (index == 0) {
			        compositeHeight += item.height;
		        }

		        if (widthCounter > compositeWidth) {
			        // increace num of lines
			        numOfLines++;
			        compositeWidth = widthCounter - item.width;
			        widthCounter = 0;
			        compositeHeight += item.height;
		        }

		        if (!elementsMap[numOfLines]) {
			        elementsMap[numOfLines] = 0;
		        }

		        elementsMap[numOfLines]++;
	        }

	        // manual 'squeezeComposite'
	        // only if there is more than one line in the bank
	        if (numOfLines > 1) {
		        // calc optimum number of children per line
		        var optimumNumChildrenPerLine = Math.ceil(numOfChildren / numOfLines);

		        // calc the composite width
		        compositeWidth = (this.children[childIndex].getSize().width + childMargin) * optimumNumChildrenPerLine - childMargin;

	        } else {
		        compositeWidth = (this.children[childIndex].getSize().width + childMargin) * numOfChildren - childMargin;
	        }

	        var bordersWidth = (this.view._view.css("borderLeftWidth").px2int() + this.view._view.css("borderRightWidth").px2int());

	        compositeWidth += bordersWidth;

	        return {'bankWidth' : compositeWidth, 'bankHeight' : compositeHeight};
        },
        /**
         * applyVerticalStyle
         * @param size
         */
        applyVerticalStyle : function(size) {
            this.view._view.find('.spacer').remove();
            this.view._view.removeClass('horizontal').addClass('vertical');
            this.view.setWidth(size.bankWidth - bankMargin);
        },

        /**
         * applyHorizontalStyle
         * @param size
         */
        applyHorizontalStyle: function(size) {
            this.view._view.find('.spacer').remove();
            this.view._view.removeClass('vertical').addClass('horizontal');
            this.view.setWidth(size.bankWidth - (this.view._view.hasClass('compact') ? 0 : bankMargin));
        }
    })

})();
////////////////////////////////////////
// SRC End --> t2k/component/mtq/MtqBank.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/cloze/ClozeConfig.js
////////////////////////////////////////

// Cloze constant values
t2k.component.cloze.ClozeConstants = {	
	clozeSpacing : 30,
	childWidthReduction: 0,
    'errorClass' : 'masc_error',
    'errorText' : 'ERROR : width of the cloze task is not wide enough to contain the bank component'

};


////////////////////////////////////////
// SRC End --> t2k/component/cloze/ClozeConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/cloze/ClozeArea.js
////////////////////////////////////////
(function () {
    /**
     * @class t2k.component.cloze.ClozeArea
     * @desc A cloze area class
     * @namespace t2k.component.cloze
     * @extends t2k.component.Composite
     * @type {Object}
     */
    t2k.component.cloze.ClozeArea = t2k.component.Composite.subClass({
        /**
         * The class' name (for debugging purpose)
         * @member name
         * @type String
         */
        name:'t2k.component.cloze.ClozeArea',

        /**
         * @name ctor
         * @param config
         */
        ctor:function (config) {
            // Delegate
            this._super(config);

            /**
             * Cloze area View
             * @property
             * @type Object
             */
            this.view = this.createNewView(t2k.component.cloze.ClozeAreaView, this.cfg);

            // get cloze dnd mode
            var modeData = analyzeClozeDNDMode(this.cfg.specialConfiguration.mode);

            // add members to special configuration
            // these configuration will latter initialize cloze's subAnswers
            this.addToSpecialConfiguration({dndContainer:'cloze', mode : modeData, bankMode : this.cfg.bankMode, checkable : true, showMFEmptyIcon : true});

            // start composite
            this.startComposite2({parent:this.view.cfg.id + '_content'});

            /**
             * @desc array of all subAnswers in cloze area
             * @type {children}
             */
            this.subAnswersArray = this.getChildrenRec(this.children, 'subanswer');
        },

        /**
         * @name getChildrenRec
         * @param childrenArray
         * @param childName
         * @returns {Array}
         * @desc array of children with wanted class name only
         */
        getChildrenRec:function (childrenArray, childName) {
            // if (!children) stop rec
            if (!childrenArray) return null;

            var name, childrenReducedArray = [], childRec, thi$ = this;
            // loop children
            jQuery(childrenArray).each(function (index, child) {
                // get class's last name
                name = child.name.split('.');
                name = name[name.length - 1].toLowerCase();
                // if option was found, push
                if (name == childName) {
                    childrenReducedArray.push(child);
                } else {
                    // rec child children
                    childRec = thi$.getChildrenRec(child.children, childName);
                    // and push results
                    jQuery(childRec).each(function (index, child) {
                        childrenReducedArray.push(child);
                    });
                }
            });

            return childrenReducedArray;
        },

        /**
         * @name setMyState
         * @desc set state of component
         * @param state {Object}
         */
        setMyState:function (state) {
            if (state.length > 0) {
                this.setEnabled(jQuery(state).attr('enabled') === 'true');
            }
        },

        /**
         * @name addMyState
         * @desc return state of component
         * @return state {Object}
         */
        addMyState:function () {
            var state = jQuery('<state/>');
            return state;
        },

        /**
         * @name changeSize
         * @param bankWidth
         * @param bankHeight
         */
        changeSize : function(bankWidth, bankHeight) {
            this.view.changeSize(bankWidth, bankHeight);
        },

        /**
         * @name evenSubAnswers
         * @desc calls from clozeAnswer method
         * @param subAnswerSize {Object}
         */
        evenSubAnswers:function (subAnswerSize) {
            this.subAnswersArray.forEach(function (subAnswer) {

                if (subAnswer.view.setStyle) {
                    subAnswer.view.setStyle(subAnswerSize);
                }

            });
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * @name analyzeClozeDNDMode
     * @param mode
     * @return {String}
     * @desc return cloze area mode (write, dragAndDropAndReplaceAndReturn) accordingly to the task mode (write, dragAndDisable, dragAndCopy)
     */
    function analyzeClozeDNDMode(mode){
    	switch(mode){
    		case 'write' :
    			mode = 'write';
    			break;
    		case 'dragAndDisable' :
    			mode = 'dragAndDropAndReplaceAndReturn';
    			break;
    		case 'dragAndCopy' :
    			mode = 'dragAndDropAndReplaceAndReturn';
    			break;
    		default : mode = 'write';
    	}

    	return mode;
    }

})();
////////////////////////////////////////
// SRC End --> t2k/component/cloze/ClozeArea.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/cloze/ClozeAreaView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.cloze.ClozeAreaView
     * @desc A cloze area view class
     * @namespace t2k.component.cloze
     * @extends t2k.component.BaseComponentView
     * @type {Object}
     */

    var TEMPLATE =
        "<div id='{{id}}' class='clozeArea {{mode}}'>\
            <div id={{id}}_content></div>\
        </div>";

    /**
     * @name defaultConfig
     * @desc Hold sensible defaults for the cloze area view to use.
     */
    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    var constants = t2k.component.cloze.ClozeConstants;

    t2k.component.cloze.ClozeAreaView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor
         * @desc see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

	        //set min-width according to max width of sub-answer
	        if(!!this.cfg.fieldsSize) {
		        this._view.css('min-width', this.cfg.fieldsSize + 'em');
	        }
        },

        /**
         * @name changeSize
         * @desc calls from clozeAnswer method, to change clozeArea's size accordingly to the bank width and height
         * @param bankWidth
         * @param bankHeight
         */
        changeSize : function(bankWidth, bankHeight) {

            var newWidth = (this.cfg.parent.width() - bankWidth - constants.clozeSpacing);
	        var minWidth = this._view.css('min-width').px2int();

		        //check if there is enough width to contain bank and beside component
            if ((newWidth + bankWidth > this.cfg.parent.width()) || (newWidth < bankWidth) || (newWidth < minWidth)) {
            	
            	var thi$ = this ;
            	
                function onNoSpaceReloadRejection() {
                	//ERROR
                	var mascDiv = Perf.create("div").css({'width' : thi$.cfg.parent.width(), height : thi$.cfg.parent.height()})
                	.addClass(constants.errorClass).html(constants.errorText);
                	thi$.cfg.parent.append(mascDiv);
	                ENV.host.playParams.config.afterCollapse = true;
                };

	            if (!ENV.host.playParams.config.afterCollapse) {
		            ENV.host.reload({
			            forceCollapsedShared:true,
			            reloadInitiator:"ClozeAreaView"
		            }, onNoSpaceReloadRejection);
	            }

	            //onNoSpaceReloadRejection();

            } else {
                this.width = newWidth;
                this._view.width(this.width);

                if (this._view.height() < bankHeight) {
                    this._view.height(bankHeight);
                }
            }
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/cloze/ClozeAreaView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/cloze/ClozeView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.cloze.ClozeView
     * @desc A cloze component class
     * @namespace t2k.component.cloze
     * @extends t2k.component.textViewer.TextViewerView
     * @type {Object}
     */

    var TEMPLATE = "";

    /**
     * @name defaultConfig
     * @desc Private, hold sensible defaults for the question's view to use.
     */
    var defaultConfig = {
    	 layout: 'tile',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.
    
    var constants = t2k.component.cloze.ClozeConstants;

    t2k.component.cloze.ClozeView = t2k.component.textViewer.TextViewerView.subClass({    	
        /** The class' name (for debugging purpose). */
        name: 't2k.component.cloze.ClozeView',

        /**
         * @name ctor
         * @desc class constructor
         */
        ctor: function(config) {
            // Delegate.        	
        	this._super(copy(config, defaultConfig));
	        this.children = new Array();  //subAnswers components array
        	
        },

        /**
         * @name startManualComposite
         * @desc override super class method, increment manual composite, to handle subAnswer's creation
         */
        startManualComposite : function(){
        	this._super();        	
        	this._createSubAnswers();
        },
               
        /**
         * @name _createSubAnswers
         * @desc dispatchEvent onClozeViewReady in order to create cloze component children (subAnswers)
         */
        _createSubAnswers:function () {
            var thi$ = this;
            this.dispatchEvent("onBeforeClozeRebuild");

            var clozeFontColor = this._view.css('color');

            //create all subAnswer components
            this._view.find('subanswer').each(function (index, value) {
                thi$.dispatchEvent("onClozeViewReady", copy({'answerCfg':value, 'insertBefore':this, 'reductionStep':thi$.reductionStep,
                    'optimumFontSize':thi$.optimumFontSize, 'fieldsSize':thi$.cfg.fieldsSize, 'fieldsWidth':thi$.cfg.fieldsWidth,
                    'style':thi$._view.attr('class'), 'fontColor':clozeFontColor}, thi$));

                jQuery(value).remove();  //remove the source xml  <subAnswer> tag

            });
        },

	    /**
	     * on a new child, view dispatch event to presenter, that adds the child to itself
	     * and calls this function, to let view add the child also
	     * @param child
	     */
	    addChild : function(child) {
		    this.textViewerChildren.push(child);
	    },

	    setLineHeight: function() {
		    this._super();

		    //set line-height according to subAnswers height
		    var thi$ = this, compHeight, compFactorHeight, margin;

		    if (this.lineHeightConfig == 'keepEven') {

			    jQuery(this.children).each(function (index, child) {
				    compHeight = child.view._view.height();
				    thi$.setMaxLineHeight((compHeight * t2k.component.textViewer.TextViewerConstants.lineHeightEvenFactor) / 2);
			    });
			    this._view.css('line-height', this.maxLineHeight + 'px');

		    } else {

			    jQuery(this.children).each(function (index, child) {
				    compHeight = child.view._view.height();
				    compFactorHeight = compHeight * t2k.component.textViewer.TextViewerConstants.lineHeightCompactFactor;
				    child.view._view.parent().css('margin-top', (compFactorHeight - compHeight) + 'px');
			    });
		    }
	    }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/cloze/ClozeView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/cloze/Cloze.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.cloze.Cloze
     * @desc A cloze component class
     * @namespace t2k.component.cloze
     * @extends t2k.component.textViewer.TextViewer
     * @type {Object}
     */
    t2k.component.cloze.Cloze = t2k.component.textViewer.TextViewer.subClass({
    	
    	/** The class' name (for debugging purpose). */
        name: 't2k.component.cloze.Cloze',

        /**
         * @desc Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: 'tileSequence',

        /**
         * @name ctor
         * @param config
         */
        ctor: function(config) {

            // init cloze members
            this.initMembers(config);

            // Delegate
            var clzCfg = override(config, this.prepareConfiguration(config));
        	this._super(clzCfg);

        },

        /**
         * @name initMembers
         * @param config
         */
        initMembers:function (config){

            /**
             * @property
             * @desc The cloze component mode (write, dragAndDropAndReplaceAndReturn)
             * @type {String}
             */
            this.mode = config.specialConfiguration.mode;

            /**
             * @property
             * @desc longest answer option
             * @type {Object}
             */
            this.fieldsSize = config.specialConfiguration.fieldsSize;

            this.fieldsWidth = config.specialConfiguration.fieldsWidth;

            // get data from special configuration
            config.lineHeightConfig = config.specialConfiguration.lineHeightConfig;
            config.additionLineHeight = config.specialConfiguration.additionLineHeight;
            config.optimumFontSize = config.specialConfiguration.optimumFontSize;
            config.bankMode = config.specialConfiguration.bankMode;
	        config.ignoreChecking = config.specialConfiguration.ignoreChecking;

            this.children = new Array();  //subAnswers components array
        },

        /**
         * @name initView
         * @desc Cloze component view initiation
         */
        initView : function(){   
        	var thi$ = this;
            /**
             * @desc cloze component view
             * @type {Object}
             */
        	this.view = this.createNewView(t2k.component.cloze.ClozeView,merge(copy(this.prepareTextViewerConfiguration(this.cfg), this.cfg), {
        		events:{
            		onAbsMin : function(){
            			thi$.cfg.onAbsMin();
            		},
            		
            		childSum : function(val){
            			thi$.layout.numOfChildren = val;
            		},
            		
            		childRendered : function(view){
            			thi$.layout.onRenderedCounter++;
            		},
            		
            		onTextViewerChildrenRendered : function(view){
			            view.children = thi$.children;
			            thi$.textViewerChildrenRendered(view);
            		}
            	}
        	}));
        },

        /**
         * @name reduce
         * @param val
         */
        reduce:function (val) {

            this._super(val);

            if (this.children == 0) {
                this.layout.canReduce = false;
                this.layout.onRendered();
                return;
            }

            this.children.forEach(function (child) {
                child.reduce();
            });
        },

        /**
         * @name setEnabled
         * @desc dispatch flag to children (as a composite)
         * @param flag {Boolean}
         */
        setEnabled : function(flag){        	 
        	this._super(flag);        	
        	
        	this.children.forEach(function(child) {
                 child.setEnabled(flag);
            });
        },

        /**
         * @name setMyState
         * @desc set state of component
         * @param state
         */
        setMyState : function(state){

            // ref
            var thi$ = this;

            jQuery(state).children().each(function(index, childState) {
               thi$.children[index].setState(childState);
            });
        },

        /**
         * @name addMyState
         * @desc override, returns state of the bank component
         * @return Object
         */
        addMyState : function(){
           var state = jQuery('<state>');
            
           jQuery(this.children).each(function(index, child) {
                state.append(child.getState());
           });
            
           return state;
        },

        /**
         * @name prepareConfiguration
         * @param config
         * @return {Object}
         */
        prepareConfiguration : function(config){
        	var result;
            var thi$ = this;

            result = {
                events:{
                    // This event is called when the view completes its construction. subAns
                    onClozeViewReady:function (config) {

                        // build data for subAnswers from special configuration
                        var newConfig =  override(config, {
                            data: config.answerCfg,
                            mode:thi$.mode,
                            bankMode:thi$.cfg.bankMode,
                            checkable:true,
                            insertBefore:config.insertBefore,
                            style:config.style,
                            fontColor:config.fontColor,
                            reductionStep:config.reductionStep,
                            optimumFontSize:config.optimumFontSize,
                            dummyMode : thi$.cfg.dummyMode,
	                        ignoreChecking : thi$.cfg.ignoreChecking,
                            fieldsSizeMode: thi$.cfg.specialConfiguration.fieldsSizeMode, 
                            fieldsSize: thi$.cfg.specialConfiguration.fieldsSize,
                            fieldsWidth : thi$.cfg.specialConfiguration.fieldsWidth,
                            fieldsType: thi$.cfg.specialConfiguration.fieldsType,
                            firstKeyDown: thi$.cfg.specialConfiguration.firstKeyDown,
                            getBankElement: thi$.cfg.specialConfiguration.getBankElement,
                            getComponentBeSideToBank: thi$.cfg.specialConfiguration.getComponentBeSideToBank,
                            getSubAnswerWidth: thi$.cfg.specialConfiguration.getSubAnswerWidth,
                            resetIncorrect: thi$.cfg.specialConfiguration.resetIncorrect,
                            taskmode: thi$.cfg.specialConfiguration.taskmode,
                            showMFEmptyIcon : thi$.cfg.specialConfiguration.showMFEmptyIcon,
                            onRendered : function(){}});

                        var newComponent = componentFactory.create(newConfig);

                        // add subAnswer component to subAnswers array
                        if (newComponent) {
                            thi$.children.push(newComponent);
                        }
                    },

                    onBeforeClozeRebuild:function () {
                        reset(thi$);
                    }

                }
            };
        	return result;
        }
       
    });

 // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 // Private Functions.
 // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    /**
     * @name reset
     * @desc private function, reset of cloze component
     * @param thi$
     */
    function reset(thi$) {
	    thi$.children.forEach(function (subAnswer) {
		    dndManager.removeSubAnswer(subAnswer.view.cfg.id, true);
	    });

	    thi$.children = new Array();  //delete all subAnswers
    }
    
})();
////////////////////////////////////////
// SRC End --> t2k/component/cloze/Cloze.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/group/GroupView.js
////////////////////////////////////////
(function() {

    var TEMPLATE = "<div class='group {{type}} {{SharedLayout}}' id='{{id}}'>\
        	<div id='{{id}}_content' class='group_content {{type}} {{SharedLayout}}'></div>\
        </div>";

    /**
     * Private: defaultConfig Hold sensible defaults for the question's view to
     * use.
     */
    var defaultConfig = {
        layout : 'inline',
        /** The mustache template to render. */
        template : TEMPLATE
    }; // End of defaultConfig.

    t2k.component.group.GroupView = t2k.core.View.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/group/GroupView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/group/Group.js
////////////////////////////////////////
(function() {

    t2k.component.group.Group = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.group.Group',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: {
            init: [
                {layoutGroup: null}
            ]
        },

        ctor: function(config) {
            // Delegate
            this._super(config);
            
            this.view = this.createNewView(t2k.component.group.GroupView, copy(this.cfg , {}));

            this.startComposite2( copy( { 	parent: this.view.cfg.id + '_content',
            								container: this.view._content,
            								useMax: !!this.cfg.useMax,
            								dontEnableBlowup: !!this.cfg.dontEnableBlowup
            								
            							}, config));


        },
        
        /**
         * layoutGroup
         */
        layoutGroup : function(){
        	
        	var maxHeight = this.cfg.parent.height();
        	var actualHeight = this.view._content.height();
        	
        	if (actualHeight == 0){
        		jQuery(this.children).each(function(index, child){
        			actualHeight += child.view._view.outerHeight();
        		});
        	}
        	
        	if ((actualHeight > maxHeight) && this.reductionAvailable()){
        		this.reduce();
        	} else {
        		this.compositeRenderComplete() ;
        	}
        
        }
        
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/group/Group.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/sharedarea/SharedAreaView.js
////////////////////////////////////////
(function() {

    var TEMPLATE = "<div class='sharedarea {{cssType}} {{orientation}}' id='{{id}}'>\
        	<div id='{{id}}_content' class='sharedarea_content {{cssType}} {{orientation}}'></div>\
        </div>";

    /**
     * Private: defaultConfig Hold sensible defaults for the question's view to
     * use.
     */
    var defaultConfig = {
        layout : 'inline',
        /** The mustache template to render. */
        template : TEMPLATE
    }; // End of defaultConfig.

    t2k.component.sharedarea.SharedAreaView = t2k.core.View.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor : function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
            
        },
        
        updateStyles: function() {
        	
            if( this.getComponentOverflow() ) {
            	this._view.addClass( 'overflow' ) ;
            }
            
        },
        
        getComponentOverflow: function() {
        	
        	

        	var componentView = this.children[0];
        	
        	var sharedViewClientHeight = this._view[0].clientHeight ;
        	var sharedViewScrollHeight = this._view[0].scrollHeight ;
        	var compViewClientHeight = componentView._view[0].clientHeight ;
        	var compViewScrollHeight = componentView._view[0].scrollHeight ;
        	
        	var over =  compViewScrollHeight > compViewClientHeight
				    	||
				    	compViewClientHeight > sharedViewScrollHeight
				    	||
				    	sharedViewScrollHeight > sharedViewClientHeight
				        ;
        	
        	return over ;
        },
        
        getViewSize: function() {
        	var size = { width: this._view.width(), height: this._view.height() };
        	return size;
        },

        getContentSize: function() {
        	
            var componentView = this.children[0];

            var sharedViewClientWidth = this._view[0].clientWidth ;
            var sharedViewScrollWidth = this._view[0].scrollWidth ;
            var sharedViewClientHeight = this._view[0].clientHeight ;
            var sharedViewScrollHeight = this._view[0].scrollHeight ;
            
            var size = { width: sharedViewClientWidth, height: sharedViewClientHeight } ;
            
            if( componentView._view ) {
            	
            	var compViewClientWidth = componentView._view[0].clientWidth ;
            	var compViewScrollWidth = componentView._view[0].scrollWidth ;
            	
            	var compViewClientHeight = componentView._view[0].clientHeight ;
            	var compViewScrollHeight = componentView._view[0].scrollHeight ;
            	
            	size = { width: compViewClientWidth, height: compViewClientHeight };
            	
            	if( compViewScrollWidth > compViewClientWidth ){
            		size.width = compViewScrollWidth ;
            	} else if( compViewClientWidth > sharedViewScrollWidth ) {
            		size.width = compViewClientWidth ;
            	} else if( sharedViewScrollWidth > sharedViewClientWidth ) {
            		size.width = sharedViewScrollWidth ;
            	}
            	
            	if( compViewScrollHeight > compViewClientHeight ){
            		size.height = compViewScrollHeight ;
            	} else if( compViewClientHeight > sharedViewScrollHeight ) {
            		size.height = compViewClientHeight ;
            	} else if( sharedViewScrollHeight > sharedViewClientHeight ) {
            		size.height = sharedViewScrollHeight ;
            	}
            	
            }
        	
            return size;
        }

    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/sharedarea/SharedAreaView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/sharedarea/SharedArea.js
////////////////////////////////////////
(function() {

    t2k.component.sharedarea.SharedArea = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.sharedarea.SharedArea',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef: {
            init: [
                {layoutSharedArea: null},
                {onDone: null}
            ]
        },

        ctor: function(config) {
            // Delegate
            this._super(config);
            
            this.view = this.createNewView(t2k.component.sharedarea.SharedAreaView, copy(this.cfg , {cssType: 'type_' + config.type}));

            var maxSize = { width: this.view._content.width(), height: this.view._content.height() } ;
            this.cfg.maxSize = maxSize ;
            
            var reductionStopper = 0 ;
            
            var useMax = true ;

            switch( config.type ) {

	        	case 'tre_applet' :
	        	case 'interactive_swf' :
	        		reductionStopper = 0.75 ;
	        		break ;

	        	case 'text' :
	        	case 'dialog' :
	        		useMax = this.cfg.isCollapse ;
	        		break ;

                case 'image' :
                case 'applet' :
                case 'media' :
	        		break ;
	        		
	        	default :
	        		console.warn( 'shared type --> '+ config.type + ' is not supported. check component used in shared area' ) ;
	        		break ;

            }

            this.startComposite2( copy( { 	parent: this.view.cfg.id + '_content',
            								container: this.view._content,
            								reductionStopper: reductionStopper,
            								useMax: useMax,
            								maxSize: maxSize
            								
            							}, config));


        },
        
        onDone: function() {
        	this.view.updateStyles() ;
        },
        
        /**
         * layoutSharedArea
         */
        layoutSharedArea : function(){

        	var maxHeight = this.cfg.maxSize.height;
        	var actualHeight = this.view._content.height();
        	
        	if (actualHeight == 0){
        		jQuery(this.children).each(function(index, child){
        			actualHeight += child.view._view.outerHeight();
        		});
        	}
        	
        	if ((actualHeight > maxHeight) && this.reductionAvailable()){
        		this.reduce();
        	}
        	else {
        		this.compositeRenderComplete();
        	}
        
        },

        getViewSize: function() {
        	return this.view.getViewSize() ;
        },
        
        getContentSize: function() {
        	return this.view.getContentSize() ;
        },
        
        getType: function() {
        	return this.cfg.type ;
        },

        getReductionReport:function(){
            //there is only one child in shared
            return this.children[0].getReductionReport();
        },
        getState: function(){

            //dont collect shared children state when its collapsed mode without Clicking on collapse
            if(this.cfg.isCollapse && !this.collapseClicked && this.initialState){
                return this.initialState;
            }
            //get shared area current state
            return this._super();
        },
        setState: function(state){

            if(this.cfg.isCollapse){
                //in shared area collapsed we will save the initial state , for possible future use 
                //( if no one opened the shared area the initial state will be sent )
                this.initialState = state;

            }
            //set the state
            this._super(state);
        }
        
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();

////////////////////////////////////////
// SRC End --> t2k/component/sharedarea/SharedArea.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/AnswerView.js
////////////////////////////////////////
(function() {
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	// TODO: style as css !!
    var TEMPLATE =
        "<div class='answer' id='{{id}}'>\
            <div id={{id}}_content class='answer_content' style='position:relative;'></div>\
        </div>";

    var defaultConfig = {
    	 layout: 'inline',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.AnswerView
     * The view for the answer part of tasks.
     */
    t2k.component.answer.AnswerView = t2k.component.BaseComponentView.subClass({

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        } // End of ctor

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/answer/AnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/Answer.js
////////////////////////////////////////
(function () {
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//  add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.Answer
     * The answer part of tasks.
     */
    t2k.component.answer.Answer = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.Answer',

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor:function (config) {

            var thi$ = this;
            // Delegate.
            this._super(config);

            this.interactable = true;
            this.isAssessmentStateDone = false;

            // Init progress configuration.
            this.defaultProgressConfig = {
                buttonModes:{
                    currMode:"progress"
                },
                allowDefaultInstruction:false,
                allowDefaultFeedback:false,
                allowDefaultHint:false,
                allowDefaultAutocheck:false,
                multipleAttempts: false
            };

            thi$.cfg.eventsManager.registerEvent('onAnswerCheck', function(){
               thi$.onCheck();
            });

            thi$.cfg.eventsManager.registerEvent('onAnswerTryAgain', function(){
                thi$.onTryAgain();
            });

            thi$.cfg.eventsManager.registerEvent('onAnswerShowAnswer', function(){
               thi$.onShowAnswer();
            });

            thi$.cfg.eventsManager.registerEvent('progress', function(){
               thi$.onProgress();
            });
            
            if( ENV.viewMode.showMyAnswerButton ) {
				thi$.cfg.eventsManager.registerEvent('onMyAnswerShow', function(){
					thi$.onShowMyAnswer();
				});
				thi$.cfg.eventsManager.registerEvent('onMyAnswerHide', function(){
					thi$.onHideMyAnswer();
				});
            }
            
            // Assessment
            if( /*AssessmentENV.isNotAssessmentModeTest*/ENV.viewMode.showCorrectAnswerButton ) {
				thi$.cfg.eventsManager.registerEvent('onCorrectAnswerShow', function(){
					thi$.onShowCorrectAnswer();
				});
				thi$.cfg.eventsManager.registerEvent('onCorrectAnswerHide', function(){
					thi$.onHideCorrectAnswer();
				});
            }

        }, // End of ctor
        
        isCheckable: function() {
        	return false ;
        },
        
        updateProgressData: function( progressData ) {
        	this.progressData = $.extend( {}, progressData ) ;
        },
        
        setInteractable: function(flag) {
            this.interactable = flag;
        },

        isInteractable: function() {
            return this.interactable;
        },

        setAutoCheck: function(flag){
            this.autocheck = flag;
        },

        onCheck: function(){
            // TODO: documentation
        },

        onTryAgain: function(){

        },

        onShowAnswer: function(ignoreProgress){
	        if(!ignoreProgress) {
		        this.cfg.eventsManager.dispatchEvent('setProgressProgress');
	        }
        },

         onProgress: function(){

        },
        
        getAsyncState: function( callback ) {
        	
        	StateUtil.collectState( this, callback ) ;
        	
        },
        
        onShowCorrectAnswer: function(){
        	
        	var thi$ = this ;
        	
        	this.getAsyncState( function( state ) {
        		
        		thi$.currentState = state ;
        		thi$.onShowAnswer( true ) ;
        		
			} ) ;
    		
        },
        
        onHideCorrectAnswer: function(){
	        this.setInteractable(true);
	        this.reset(true);
	        this.setState( this.currentState ) ;
        },
        
        onShowMyAnswer: function(){
        	if( this.hasFinalAttemptState ) {
        		this.setState( this.finalAttemptState ) ;
    	        this.setInteractable(true);
        	}
        },
        
        onHideMyAnswer: function(){
	        this.setInteractable(true);
	        this.onShowAnswer( true ) ;
        },
        
        storeFinalAttemptState: function( state ) {
        	this.hasFinalAttemptState = true ;
        	this.finalAttemptState = state ;
        },
        
        setDefaultProgressConfig: function(defaultProgressConfig) {
            this.defaultProgressConfig = override(this.defaultProgressConfig, defaultProgressConfig);
        },

        /**
         * setState
         * Return the answer to specified state
         * @param state - {jQuery} State xml
         */
        setState:function (state) {
        	this._super(state);

	        this.setInteractable(state.children('interactable').text() === "true");
	        this.cfg.enabled = (jQuery(state).attr('enabled') === 'true');

	        this.cfg.checkAnswerOnState = false;
	        var sha1 = state.children('sha1') && state.children('sha1').text().trim();

	        if(sha1 && sha1 != this.cfg.sha1) {
//		        this.cfg.checkAnswerOnState = true;
	        }

			if((this.cfg.checkAnswerOnState && !this.isInteractable())
			  || ENV.viewMode.checkAnswerOnState ) { /*AssessmentENV.isNotAssessmentModeTest*/
				this.onCheck();
			}
        },

//        /**
//         * getState
//         * Return answer state xml
//         * @return state - {jQuery} State xml
//         */
//        getState:function () {
//            return this._super();
//        },

	    addMyState : function() {
		    var state = jQuery('<state/>')
			    .append(jQuery('<interactable/>').text(this.interactable))
			    .append(jQuery('<sha1/>').text(this.cfg.sha1));

		    return state;
	    },

        setEnabled:function (flag) {
            this._super(flag);
        },

        //assessment
        isAssessable:function(){
            //default
            return false
        },

        assessmentScore:function(){
          //stub for now
            return 0;
        },
        
        getAssessmentMaxScore: function() {
        	return this.progressData.points ;
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/Answer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/OpqAnswerView.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the opq's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the opq's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.OpqAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        },
        
        /**
		 * onViewRendered
		 * override with an empty function.
		 * textViewerView will dispatch the 'onRendered' event himself.
		 */
		onViewRendered : function(){
		} // end of onViewRendered
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/answer/OpqAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/OpqAnswer.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.opq.OpqTask
     * The open-question task.
     */
    t2k.component.answer.OpqAnswer = t2k.component.answer.Answer.subClass({
        /** The class' name (for debugging purpose). */
        name:'t2k.component.answer.OpqAnswer',

        /**
         * Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         */
        layoutSequenceDef:{
            init:[
                {setProgressionReadyByFirstKeyDown:null}
            ]
        },

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The task's configuration.
         */
        ctor:function (config) {
            // Delegate
            this._super(config);

            this.setDefaultProgressConfig({allowDefaultInstruction:true, allowDefaultHint:true});

            // Create the opq view.
            this.view = this.createNewView(t2k.component.answer.OpqAnswerView, this.cfg);

            //default value is init
            this.progressType = jQuery(this.cfg.progressData).children("type").first().text() || "input";

            //Create the answer composite.
            this.startComposite2({parent:this.view.cfg.id + '_content'});
        },

        /**
         * getEditableComponentRec
         * @param childrenArray
         * @returns option array
         */
        getEditableComponentRec:function (childrenArray) {
            // if (!children) stop rec
            if (!childrenArray) return null;

            var name, editableComponentsArray = [], ret, thi$ = this;
            // loop children
            jQuery(childrenArray).each(function (index, child) {
                // get class's last name
                name = child.name.split('.');
                name = name[name.length - 1].toLowerCase();

                // if option was found, push
                if (name == 'mathfield' || name == 'texteditor' || name == 'minitexteditor') {
                    editableComponentsArray.push(child);
                } else {
                    // rec child children
                    var editableComponentRec = thi$.getEditableComponentRec(child.children);
                    // and push results
                    jQuery(editableComponentRec).each(function (index, child) {
                        editableComponentsArray.push(child);
                    });
                }
            });

            return editableComponentsArray;
        },

        setProgressionReadyByFirstKeyDown:function() {

            var thi$ = this;

            if (this.progressType == 'input' && !this.cfg.dummyMode) {

                // rec this.children and get TE and MF comp.

                // get editableComponentsArray
                this.editableComponentsArray = this.getEditableComponentRec(this.children);
                // set firstKeyDown function on each comp.
                jQuery(this.editableComponentsArray).each(function (index, child) {
                    child.setFirstKeyDownFunction(function () {
                        if (thi$.isEnabled() && (this.getValue ? this.getValue().length : true)) {
                            thi$.cfg.eventsManager.dispatchEvent('setProgressReady');
                        } else {
	                        thi$.cfg.eventsManager.dispatchEvent('setProgressUnready');
                        }
                    });
                });
            }

            this.compositeRenderComplete();
        },

        /**
         * setEnabled - override
         * @param flag
         */
        setEnabled:function (flag) {
            this._super(flag);

            if (flag && this.progressType == 'init') {
                this.cfg.eventsManager.dispatchEvent('setProgressReady');
            }
        }
    });

})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/OpqAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/QuestionOnlyAnswerView.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the opq's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the opq's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.QuestionOnlyAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
            
        }
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/answer/QuestionOnlyAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/QuestionOnlyAnswer.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.opq.OpqTask
     * The open-question task.
     */
    t2k.component.answer.QuestionOnlyAnswer = t2k.component.answer.Answer.subClass({
        /** The class' name (for debugging purpose). */
		name: 't2k.component.answer.QuestionOnlyAnswer',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The task's configuration.
         */
        ctor: function(config) {
            // Delegate
            this._super(config);

            // Create the opq view.
            this.view = this.createNewView(t2k.component.answer.QuestionOnlyAnswerView, this.cfg);
          },
          
          //override
          setEnabled: function(flag) {
              this._super( flag ) ;
              
              if(flag){
              	this.cfg.eventsManager.dispatchEvent('setProgressReady');
              }
          },
          
          compact : function(){
        	  this.layout.onRendered();
          },
          
          
          loose : function(){
        	  this.layout.onRendered();
          },
          
          
          reduce : function(){
        	  this.layout.canReduce = false;
              this.layout.onRendered();

          }
          
          
    	});

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/QuestionOnlyAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/BaseClozeAnswerConfig.js
////////////////////////////////////////
// Cloze Answer constant values
t2k.component.answer.BaseClozeAnswerConstants = {
    lineHeightMFExpansion:'0.1em',
    lineHeightMFSecondLevelExpansion:'0.1em',
    lineHeightWithHintExpansion:30,
    lineHeightNoHintExpansion:20,
    mathfieldWidthFactor : 1.3,
    clozeObjectClassName:'t2k.component.cloze.ClozeArea',
    viewObjectClassName:'t2k.component.answer.BaseClozeAnswerView',
	bankObjectClassName:'t2k.component.bank.Bank',
    'errorClass':'masc_error',
    'errorText':'ERROR : width of the cloze task is not wide enough to contain the bank component'
};


////////////////////////////////////////
// SRC End --> t2k/component/answer/BaseClozeAnswerConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/BaseClozeAnswerView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.BaseClozeAnswerView
     * @desc A cloze task view
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.AnswerView
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * @singleton
     * @name defaultConfig
     * @desc Hold sensible defaults for the cloze's view to use.
     * @type {Object}
     */
    var defaultConfig = {
        /** The default layout used by the cloze's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.BaseClozeAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @desc see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }
       
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/BaseClozeAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/BaseClozeAnswer.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.BaseClozeAnswer
     * @desc A base cloze task class
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.Answer
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    var constants = t2k.component.answer.BaseClozeAnswerConstants;

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    t2k.component.answer.BaseClozeAnswer = t2k.component.answer.Answer.subClass({
        /**
         * The class' name (for debugging purpose)
         * @member name
         * @type String
         */
        name: 't2k.component.answer.BaseClozeAnswer',

        /**
         * @name ctor
         * @desc Class constructor
         * @constructor
         * @param config - {Object} The task's configuration
        */
        ctor: function(config) {
            // Delegate        	
            this._super(config);

            this.initMembers();

	        this.setViewClass();

            this.view = this.createNewView(this.viewClass, this.cfg);

            var newConfig = this.prepareConfiguration(this.cfg);
            newConfig.specialConfiguration = copy({},newConfig);

            //call composite method - create children
            this.startComposite2(newConfig);

	        var thi$ = this;
	        window['globalEvents'].add({
		        fnc:function () {
			        thi$.changeSizeClozeArea.call(thi$);
		        }
	        })
        },

	    setViewClass: function() {
		  this.viewClass = t2k.component.answer.BaseClozeAnswerView;
	    },

        /**
         * @name initMembers
         * @desc Initiation of all class members
         */
        initMembers : function() {

	        this.checkable = this.cfg.data.attributes.getNamedItem('checkable')  ? //if this task is checkable
		        (this.cfg.data.attributes.getNamedItem('checkable').value === "true") : false;

            this.progressType = jQuery(this.cfg.progressData).children('type').text() || 'init'; // init / oneCompletion / fullCompletion

            this.setDefaultProgressConfig({
                buttonModes: {
                    currMode: (this.checkable ? "check" : "progress")
                },
                allowDefaultInstruction:this.checkable,
                allowDefaultFeedback:this.checkable,
                allowDefaultHint:this.checkable,
                allowDefaultAutocheck:this.checkable,
                multipleAttempts: this.checkable,
	            progressType: this.progressType
            });

            this.mode = jQuery(this.cfg.modeData).text() || 'write';  //cloze task modes : write / dragAndDisable / dragAndCopy
            this.bankMode = getBankMode(this.mode);  //dragAndCopy / dragAndDisable

	        var dataResetIncorrect = jQuery(this.cfg.progressData).find('resetIncorrect').text();
            this.resetIncorrect = dataResetIncorrect.length ? (dataResetIncorrect === "true") : true;  //true / false

            this.showAnswer = jQuery(this.cfg.progressData).find('showAnswer').text() || true;  //true / false
            this.fieldsSizeMode = getFieldsSizeMode(this); //manual / maxBank / maxAnswer / maxBankAndAnswer

            var fieldsSizesObj = getFieldsSize(this);
            this.fieldsSize = fieldsSizesObj.fieldsSize;                 //number of characters for TE
            this.fieldsWidth = fieldsSizesObj.fieldsWidth;

            var objDependency = getMutualDependency(this.cfg);
            this.mutualDependency = objDependency.dependencyArray;           //array of mutual dependency rules
            this.dependencyAnswerIds = objDependency.dependencyAnswerIds;    //array of subAnswers Id, that taking part in mutual dependency rules

            this.fieldsType = (getFieldsType(this.cfg)); //textOnly fields or text and MF

            this.subAnswerWidth = 0;
            this.reductionStep = 0;
            this.reductionStepSize = t2k.component.textViewer.TextViewerConstants.reductionStepSize;
            this.isMinimunReadable = false;


            this.subAnswersArray = []; //array of all subAnswers in task
        },

        /**
         * @name initMembersAfterRendered
         * @desc calls on first rendered only after all components are in place, init members like bank, cloze etc..
         */
        initMembersAfterRendered : function(){

            /**
             * @member clozeArea
             * @type Object
             */
            this.clozeArea = _getChildByClass(this, constants.clozeObjectClassName);   //cloze area member

            /**
             * @member bankElement
             * @type Object
             */
            this.bankElement = _getChildByClass(this, constants.bankObjectClassName);  //bank member

            /**
             * @member subAnswersArray
             * @type {Array}
             */
            this.subAnswersArray = this.getChildrenRec(this.children, 'subanswer');    //array of all subAnswers in task

            /**
             * @member optimumFontSize
             * @type {Number}
             */
            this.optimumFontSize = this.optimumFontSize || parseInt((this.clozeArea.view._view).css('font-size'));  //optimum font size of the task

            this.compositeRenderComplete();
        },

        /**
         * @name setEnabled
         * @desc setEnabled of cloze task + reset dndManager*
         * @param flag {Boolean}
         */
        setEnabled: function(flag) {
            if (flag) {
                dndManager.reset();  //reset dndManager when task is enabled
            }

            this._super(flag);

            if (flag && this.progressType == 'init' && !ENV.viewMode.preventEmptyAnswer ) {
                this.cfg.eventsManager.dispatchEvent('setProgressReady');
            }
        },

        /**
         * @name compact
         * @desc Dynamic layout method override, do nothing - just rendered
         */
        compact : function() {
            this.layout.onRendered();
        },

        /**
         * @name loose
         * @desc Dynamic layout method override, resize all subAnswers
         */
        loose : function() {
            if(this.bankElement) {
                this.bankElement.looseChildrenHeight();
                this.bankElement.looseChildrenWidth();

                var maxSize = this.bankElement.getChildrenMaxSize();
                this.bankElement.resizeChildren(maxSize);
                this.bankElement.view.adjustBankStyle(true);

                if (this.mode != "write") {
                    this.subAnswersArray.forEach(function (element) {
                        if (element.dndContainer != 'bank')
                            element.resetElementSize();
                    });

                    this.clozeArea.evenSubAnswers(maxSize);
                }

            }

            this.layout.onRendered();
        },

        /**
         * @name prepareConfiguration
         * @desc firstKeyDown is a callback that calls by subAnswer children on the first real keyDown
         the current function check if the task is enable before the button activation
         * @param config
         * @returns cloze task config
         */
        prepareConfiguration : function(config) {

            var thi$ = this;

            //in case of hints or MF's in task we need to add missing height to TV line-height
            //MF can be in to maxHeight configurations : basic or secondLevel
            var fontSize = this.view._view.css('font-size').px2int();

            var _additionLineHeight = constants.lineHeightNoHintExpansion;

	        switch(this.fieldsType){
		        case 'textAndMathfield' : {
			        _additionLineHeight = constants.lineHeightMFExpansion.em2int() * fontSize;
			        break;
	        }

		        case   'textAndMathfieldSecondLevel' : {
			        _additionLineHeight = constants.lineHeightMFSecondLevelExpansion.em2int() * fontSize;
			        break;
		        }
	        }

	        //checkingExcludes
	        var ignorecheckingList = [], ignorechecking = [], checking_type = '';
	        config.progressData.children.forEach(function(item, index){
		        if(item.tagName.toLowerCase() === "ignorechecking") {
			        ignorecheckingList = item.children;
			        return false;
		        }
	        });

	        ignorecheckingList.forEach(function(item, index) {
		        checking_type = item.getAttribute('type');
		        checking_type.length && ignorechecking.push(checking_type);
	        });

	        var result = { parent:this.view.cfg.id + '_content',
		        mode:this.mode,
		        bankMode:this.bankMode,
		        IsBankRandom: true,
                fieldsSizeMode : this.fieldsSizeMode,
		        fieldsSize:this.fieldsSize,
                fieldsWidth: this.fieldsWidth,
		        resetIncorrect:this.resetIncorrect,
		        reductionStep:this.reductionStep,
		        optimumFontSize:this.optimumFontSize,
		        fieldsType:this.fieldsType,
		        additionLineHeight:_additionLineHeight,
		        lineHeightConfig:'keepEven',
		        ignoreChecking: ignorechecking,

                getComponentBeSideToBank : function() {
                    return  _getChildByClass(thi$, constants.clozeObjectClassName);
                },

                getBankElement : function() {
                    return  _getChildByClass(thi$, constants.bankObjectClassName);
                },

                getSubAnswerWidth : function() {
                    return thi$.subAnswerWidth;
                },

                firstKeyDown : function() {
                    if (thi$.isEnabled()) {
                    	
                    	var progType = thi$.progressType ;
                    	
                    	if( ENV.viewMode.preventEmptyAnswer ) {
                    		progType = "oneCompletion" ;
                    	}
                    	
                        switch (progType) {
                            case 'fullCompletion':
                            { //progress type is fullCompletion - check that all subAnswers is answered
                                var asnwersSum = 0;
                                thi$.subAnswersArray.forEach(function(subAnswer) {
                                    asnwersSum = asnwersSum + (subAnswer.isEmpty() || subAnswer.dndContainer == 'bank' ? 0 : 1);
	                                subAnswer = null;
                                });

                                if (asnwersSum == thi$.subAnswersArray.length) {  //check if answers count is equal to the subAnswers count
                                    thi$.cfg.eventsManager.dispatchEvent('setProgressReady');
                                } else {
                                    thi$.cfg.eventsManager.dispatchEvent('setProgressUnready');
                                }
                                break;
                            }
                            case 'oneCompletion' :
                            {
                                var asnwersSum = 0;
	                            thi$.subAnswersArray.forEach(function(subAnswer) {
                                    asnwersSum = asnwersSum + (subAnswer.isEmpty() || subAnswer.dndContainer == 'bank' ? 0 : 1);
		                            subAnswer = null;
                                });

                                if (asnwersSum > 0) {
                                    thi$.cfg.eventsManager.dispatchEvent('setProgressReady');
                                } else {
                                    thi$.cfg.eventsManager.dispatchEvent('setProgressUnready');
                                }
                                break;
                            }

                            default:
                                thi$.cfg.eventsManager.dispatchEvent('setProgressReady');
                        }
                    }
                }
            };

            return result;
        },

	    /**
	     * @name setState
	     * @desc override - set state of answer
	     * @param state
	     */
	    setState : function(state) {
		    dndManager.reset();

		    if(this.mode !== 'write') {
			    //insert all sub-answers into dndManager array
			    this.subAnswersArray.forEach(function(subAnswer) {
				    subAnswer.manageSALists();
			    });


			    if(this.bankElement && this.bankElement.children ){
				    this.bankElement.children.forEach(function(bankItem){
					    bankItem.manageSALists();
				    });
			    }
		    }

		    this._super(state);
	    },

        /**
         * @desc change cloze area size according to bank size
         */
        changeSizeClozeArea : function() {
            if (this.bankElement && this.bankElement.view) {  //Check the existence of bank
	            this.bankElement.view.adjustBankStyle(this.bankElement.mode);

	            var bankSize = this.bankElement.view.getSize();
                this.clozeArea.changeSize(bankSize.width, bankSize.height);
            }
        },

        /**
         * @name checkForBankOverFlowWidth
         * @desc Check if there no available space for the bank - throw layout error
         */
        checkForBankOverFlowWidth : function(){

            var reduce = false, $tableContent, clozeAreaWidth, tableContentWidth;

            if (!this.cfg.dummyMode){

                this.view._view.find('.clozeArea .table_content').each(function(index, tableContent){
                    $tableContent = jQuery(tableContent);
                    clozeAreaWidth = $tableContent.parents('.clozeArea').width();
                    tableContentWidth = $tableContent.width();

                    if (tableContentWidth > clozeAreaWidth){
                        reduce = true;
                    }
                });
            }

            //check if bank can be reduced - doesn't include MF in secondLevel
            //if not don't reduce all task - but put red screen - layout error
            //if after reduction total width of table + bank is wider than task width - layout error
            if (reduce && this.layout.canReduce){
                this.reduce();
            } else {

                if (!this.cfg.dummyMode && reduce) {
                    //display layout error
                    console.error(constants.errorText);
                    if (reduce) {
                        var mascDiv = Perf.create("div").css({'width':this.cfg.parent.width(), height:this.cfg.parent.height()})
                            .addClass(constants.errorClass).html(constants.errorText);
                        this.cfg.parent.append(mascDiv);
                    }
                }

                this.compositeRenderComplete();
            }
        },

        /**
         * @name evenSubAnswers
         * @desc Resize all task subAnswers by max size
         */
        evenSubAnswers : function () {
            if (this.bankElement && this.mode != "write") {  //Check the existence of bank
                var maxSize = this.bankElement.getChildrenMaxSize();

                this.clozeArea.evenSubAnswers(maxSize);  //adjust the width of the cloze component
            } else {
                this.clozeArea.evenSubAnswers(null);
            }

            this.compositeRenderComplete();

        },

        /**
         * @name adjustHeight
         * @desc in case of bank existence - adjusting cloze height according to the bank height
         */
        adjustHeight : function() {
            if (this.bankElement) {  //Check the existence of bank
                if (this.clozeArea.view._view.height() < this.bankElement.view._view.height()){
                    this.clozeArea.view.setHeight(this.bankElement.view.bankHeight);
                }
            }
        },

        /**
         * @method looseSubAnswerSize
         * @desc Layouter function - reset size of all cloze area subAnswers
         */
        looseSubAnswerSize : function(){
            if(this.mode != "write") {
                this.subAnswersArray.forEach(function (element) {
                    if (element.dndContainer != 'bank')
                        element.resetElementSize();
                });
            }

            this.compositeRenderComplete();
        },

        /**
         * @name compactBank
         * @desc Layouter function for the bank compact
         */
        compactBank : function(){
            if (this.bankElement){
                this.layout.onRenderedCounter++;

                this.bankElement.looseComposite();
                this.bankElement.compactChildren();
                this.bankElement.view.adjustBankStyle(false);

            } else {
                this.compositeRenderComplete();
            }
        },

        /**
         * @name checkSubAnswer
         * @desc parse dependencyAnswerIds array if id is found in array - return false. else - return true
         * @param subAnswerId
         * @returns {Boolean}
         */
        checkSubAnswer : function (subAnswerId) {
            var notFoundFlag = true;
            this.dependencyAnswerIds.forEach(function(answerId) {
                if (eval(answerId) == eval(subAnswerId)) {
                    notFoundFlag = false;
                    return false;
                }
            });
            return notFoundFlag;
        },

        /**
         * @name onCheck
         * @desc fires after check button pressed, must be present in all checkable tasks
         */
        onCheck: function() {
            var cfg = this.cfg;
            var thi$ = this;

            //loop through dependency rules
            this.mutualDependency.forEach(function(objDependency) {  //rule : [5] = [7]
                var evalRule = '';
                var checkType = objDependency.checkType;

                evalRule = objDependency.rule.replace(/\[(\d)\]/g,
                    function(str, p1, p2, offset) {
                        return (((checkType == 'value') ? 'findSubAnswerValueById' : 'findSubAnswerMarkUpValueById') + '(thi$, ' + str + ')');
                    });
                evalRule = evalRule.replace(/\[/g, '').replace(/\]/g, '').replace(/=+/g, '==');
                evalRule = evalRule.replace(/bigger/g, ">");
                evalRule = evalRule.replace(/smaller/g, "<");
                evalRule = evalRule.replace(/AND/g, "&&");
                evalRule = evalRule.replace(/OR/g, "||");

                var ruleIsTrue = false;
                try {
                    ruleIsTrue = eval(evalRule);
                } catch (e) {
                    console.log(e);
                }

                if (ruleIsTrue) { //mark all subAnswers in rule as correct
                    objDependency.Ids.forEach(function(answerId) {
                        var subAnswer = findSubAnswerById(thi$, answerId);
                        //subAnswer.markAsCorrect();   //When dependency check is defined, local feedback on sub-answers should not appear
                        subAnswer.view.markAsDisable();
                        subAnswer.setCorrect('true');
                        subAnswer.setEnabled(false);
                    });

                } else { //mark all subAnswers in rule as incorrect
                    objDependency.Ids.forEach(function(answerId) {
                        var subAnswer = findSubAnswerById(thi$, answerId);
                        //subAnswer.markAsWrong();   //When dependency check is defined, local feedback on sub-answers should not appear
                        subAnswer.view.markAsDisable();
                        subAnswer.setCorrect('false');
                        subAnswer.setEnabled(false);
                    });
                }
            });

            // Iterate the subAnswers and mark correct and wrong ones.
            this.subAnswersArray.forEach(function(subAnswer) {
                if (thi$.checkSubAnswer(subAnswer.answerId)) {
                    var checkCorrectness = subAnswer.isCorrect(true);                    
                    if (checkCorrectness.IsCorrectAnswer) {
                        subAnswer.markAsCorrect();
                        subAnswer.setCorrect('true');
                        var insideAnswerValue = subAnswer.dndMode =="write" ? checkCorrectness.checkValue : subAnswer.initAnswerId;

                        var sfValue = thi$.getSpecificFeedbackValue(subAnswer.initAnswerId, 'correct', insideAnswerValue );
                        if(sfValue){
                            subAnswer.setSpecificFeedback(sfValue);
                        }
                    } else {
                        subAnswer.setCorrect('false');
                        if (subAnswer.view.children.length > 0) { //subAnswer is not empty
                            checkCorrectness = subAnswer.ispartiallyCorrect(true)
                            if (checkCorrectness.IsCorrectAnswer) {
                                subAnswer.markAsPartiallyCorrect();
                                subAnswer.setCorrect('part');
                                var sfValue = thi$.getSpecificFeedbackValue(subAnswer.initAnswerId, 'partially', checkCorrectness.checkValue );
                                if(sfValue){
                                    subAnswer.setSpecificFeedback(sfValue);                            
                                }
                            } else {
                                checkCorrectness = subAnswer.isIncorrectPredicted(true)
                                if (checkCorrectness.IsCorrectAnswer) {
                                    subAnswer.markAsWrong();
                                    var sfValue = thi$.getSpecificFeedbackValue(subAnswer.initAnswerId, 'wrong', checkCorrectness.checkValue );
                                    if(sfValue){
                                        subAnswer.setSpecificFeedback(sfValue);                            
                                    }
                                } else {
                                    subAnswer.markAsWrong();
                                    var insideAnswerValue;
                                    if(subAnswer.dndMode =="write"){
                                        insideAnswerValue = subAnswer.getValue();
                                    }else{
                                        //incorrect answer with d&d- we need to find the id that the bank item answerd is related to

                                        answer = thi$.subAnswersArray.filter(function(item){
                                                return item.getOriginalBankId() == subAnswer.answerId;
                                            });
                                        if(answer.length){
                                            //get the original subanswer id of that answered bank item
                                            insideAnswerValue = answer[0].initAnswerId;                                        
                                        }else{
                                            // we couldn't find item in answer to match the bank- it means we need the bank id itself ( it is not duplicated subanswer)
                                            insideAnswerValue =subAnswer.answerId
                                        }

                                    }
                                    var sfValue = thi$.getSpecificFeedbackValue(subAnswer.initAnswerId, 'wrong',insideAnswerValue);
                                    if(sfValue){
                                        subAnswer.setSpecificFeedback(sfValue);                            
                                    }
                                }
                                
                            }
                        } else { //empty subAnswer
                            //subAnswer.reset() ;
                            subAnswer.markAsFull();
                            subAnswer.markAsWrong();
                            var sfValue = thi$.getSpecificFeedbackValue(subAnswer.initAnswerId, 'wrong', 'default' );
                            if(sfValue){
                                subAnswer.setSpecificFeedback(sfValue);                            
                            }
                        }
                    }
                }
                subAnswer.setEnabled(false);

            });


            if (this.bankElement) {
                this.bankElement.setEnabled(false);
            }

            this.countCorrect = countAnswers(this.subAnswersArray, 'true');
            this.countInCorrect = countAnswers(this.subAnswersArray, 'false');
            this.countPartCorrent = countAnswers(this.subAnswersArray, 'part');

            // see if we're all correct, allow progress
            if ((!ENV.viewMode.showTaskScore) && (this.countCorrect == this.subAnswersArray.length && this.countInCorrect == 0)) {
                this.cfg.eventsManager.dispatchEvent('setProgressDone');
            } else {
                var msgType = null;

	            if (this.countCorrect == this.subAnswersArray.length) {
		            msgType = t2k.util.FeedbackUtils.TYPE_ALL_CORRECT;
	           } else if( this.subAnswersArray.length ==1 && this.countPartCorrent ==1){
                    msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT;
               }else if (this.countCorrect == 0) {
		            msgType = t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT;
	            }
	            else {
		            msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT;
	            }

                var msgData = FeedbackService.createMessage(msgType), scoreData;
	            if(ENV.viewMode.showTaskScore) {
		            scoreData = {'correctRatio' : (this.countCorrect / this.subAnswersArray.length)};
	            }

                this.cfg.eventsManager.dispatchEvent('setProgressProgress', [msgData, scoreData]);
            }
        },
        getSpecificFeedbackValue : function(checkbleElementId , checkingType, checkbleElementValue ){
            var feedbackValue ;
            try{
                feedbackValue = this.progressData.specificFeedbackMessages[checkbleElementId][checkingType][checkbleElementValue]
                if(feedbackValue == undefined){
                    feedbackValue = this.progressData.specificFeedbackMessages[checkbleElementId][checkingType]['default'];
                }
                if(feedbackValue == undefined){
                    feedbackValue = this.progressData.specificFeedbackMessages['default'][checkingType]['default'];
                }
            }catch(error){
                try{
                    feedbackValue = this.progressData.specificFeedbackMessages['default'][checkingType]['default'];
                }
                catch(error){
                    return false;                    
                }
            }
            return feedbackValue;

        },
        
        logicCheckOnly: function() {
            var cfg = this.cfg;
            var thi$ = this;

            //loop through dependency rules
            this.mutualDependency.forEach(function(objDependency) {  //rule : [5] = [7]
                var evalRule = '';
                var checkType = objDependency.checkType;

                evalRule = objDependency.rule.replace(/\[(\d)\]/g,
                    function(str, p1, p2, offset) {
                        return (((checkType == 'value') ? 'findSubAnswerValueById' : 'findSubAnswerMarkUpValueById') + '(thi$, ' + str + ')');
                    });
                evalRule = evalRule.replace(/\[/g, '').replace(/\]/g, '').replace(/=+/g, '==');
                evalRule = evalRule.replace(/bigger/g, ">");
                evalRule = evalRule.replace(/smaller/g, "<");
                evalRule = evalRule.replace(/AND/g, "&&");
                evalRule = evalRule.replace(/OR/g, "||");

                var ruleIsTrue = false;
                try {
                    ruleIsTrue = eval(evalRule);
                } catch (e) {
                    console.log(e);
                }

                if (ruleIsTrue) { //mark all subAnswers in rule as correct
                    objDependency.Ids.forEach(function(answerId) {
                        var subAnswer = findSubAnswerById(thi$, answerId);
                        //subAnswer.markAsCorrect();   //When dependency check is defined, local feedback on sub-answers should not appear
//                        subAnswer.view.markAsDisable();
                        subAnswer.setCorrect('true');
//                        subAnswer.setEnabled(false);
                    });

                } else { //mark all subAnswers in rule as incorrect
                    objDependency.Ids.forEach(function(answerId) {
                        var subAnswer = findSubAnswerById(thi$, answerId);
                        //subAnswer.markAsWrong();   //When dependency check is defined, local feedback on sub-answers should not appear
//                        subAnswer.view.markAsDisable();
                        subAnswer.setCorrect('false');
//                        subAnswer.setEnabled(false);
                    });
                }
            });

            // Iterate the subAnswers and mark correct and wrong ones.
            this.subAnswersArray.forEach(function(subAnswer) {
                if (thi$.checkSubAnswer(subAnswer.answerId)) {
                    if (subAnswer.isCorrect()) {
//                        subAnswer.markAsCorrect();
                        subAnswer.setCorrect('true');
                    } else {
                        subAnswer.setCorrect('false');
                        if (subAnswer.view.children.length > 0) { //subAnswer is not empty
                            if (subAnswer.ispartiallyCorrect()) {
//                                subAnswer.markAsPartiallyCorrect();
                            } else if (subAnswer.isIncorrectPredicted()) {
//                                subAnswer.markAsWrong();
                            } else {
//                                subAnswer.markAsWrong();
                            }
                        } else { //empty subAnswer
                            //subAnswer.reset() ;
//                            subAnswer.markAsFull();
//                            subAnswer.markAsWrong();
                        }
                    }
                }
//                subAnswer.setEnabled(false);

            });


//            if (this.bankElement) {
//                this.bankElement.setEnabled(false);
//            }

            this.countCorrect = countAnswers(this.subAnswersArray, 'true');
            this.countInCorrect = countAnswers(this.subAnswersArray, 'false');

            // see if we're all correct, allow progress
//            if ((!ENV.viewMode.showTaskScore) && (this.countCorrect == this.subAnswersArray.length && this.countInCorrect == 0)) {
//                this.cfg.eventsManager.dispatchEvent('setProgressDone');
//            } else {
//                var msgType = this.countCorrect == 0 ?
//                    t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT
//                    :
//                    t2k.util.FeedbackUtils.TYPE_PART_CORRECT;
//
//                var msgData = FeedbackService.createMessage(msgType), scoreData;
//	            if(ENV.viewMode.showTaskScore) {
//		            scoreData = {'correctRatio' : (this.countCorrect / this.subAnswersArray.length)};
//	            }
//
//                this.cfg.eventsManager.dispatchEvent('setProgressProgress', [msgData, scoreData]);
//            }
            
            // stupid bollean descision 
            var isCorrect = this.countCorrect == this.subAnswersArray.length && this.countInCorrect == 0 ;
            
            return isCorrect ;
        },
        
        assessmentScore:function() {
        	///////////////////////////////////////////////////
        	// support MC only, not MMC
        	///////////////////////////////////////////////////
        	
        	var maxScore = this.getAssessmentMaxScore() ;
        	
        	var isCorrect = this.logicCheckOnly() ;
        	
        	return isCorrect ? maxScore : 0 ;
        },
        
        /**
         * @name onTryAgain
         * @desc fires after Try Again button is pressed
         */
        onTryAgain: function() {
            this.reset();
            this.cfg.eventsManager.dispatchEvent('setProgressProgress');
        },

        /**
         * @name onShowAnswer
         * @desc fires after Show Answer is pressed
         */
        onShowAnswer: function(ignoreProgress) {

            // Iterate the subAnswers and fill with correct bank options.
	        var subAnswer, l = this.subAnswersArray.length;

	        for (var i = 0; i < l; i++) {
		        subAnswer = this.subAnswersArray[i];
		        if (!subAnswer.isCorrect() && !!subAnswer.cfg.answers.correct) {
			        subAnswer.markAsSystemCorrect();
		        }
		        subAnswer.setEnabled(false);
	        }

	        this._super(ignoreProgress);
        },

        /**
         * @name reset
         * @desc run reset and disable on all subAnswers
         */
        reset: function() {
            if (this.bankElement) {
                this.bankElement.setEnabled(true);
                this.bankElement.view.markAsActive(true);
            }

            this.subAnswersArray.forEach(function(subAnswer) {
                if (!subAnswer.isMarkedAsCorrect()) {
                    subAnswer.reset();
                    subAnswer.setEnabled(true);
                } else {
                    subAnswer.disableBankOption(subAnswer.getCorrectAnswer());
                }
                subAnswer.removeSpecificFeedback();
            });


        }, // End of reset

        /**
         * @name getChildrenRec
         * @desc returns array of children with wanted class name only
         * @param childrenArray
         * @param childName
         * @returns Array
         */
        getChildrenRec:function (childrenArray, childName) {
            // if (!children) stop rec
            if (!childrenArray) return null;

            var name, childrenReducedArray = [], childRec, thi$ = this;
            // loop children
            jQuery(childrenArray).each(function (index, child) {
                // get class's last name
                name = child.name.split('.');
                name = name[name.length - 1].toLowerCase();
                // if option was found, push
                if ((name == childName) && (!!child.cfg.checkable)) {
                    childrenReducedArray.push(child);
                } else {
                    // rec child children
                    childRec = thi$.getChildrenRec(child.children, childName);
                    // and push results
                    jQuery(childRec).each(function (index, child) {
                        if (!!child.cfg.checkable) {
                            childrenReducedArray.push(child);
                        }

                    });
                }
            });

            return childrenReducedArray;
        }
    });


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    /**
     * @desc private function, Returns child based on class name
     * @method
     * @name _getChildByClass
     * @param thi$ {Object}
     * @param className {String}
     * @return Object
     */
    function _getChildByClass(thi$, className) {
        var element;
        thi$.children.forEach(function(child) {
            if (Object.getPrototypeOf(child).name === className) {
                element = child;
            }
        });
        return element;
    }

    /**
     * @name findSubAnswerById
     * @desc private function, find subAnswer object value by specific answerId attribute
     * @param thi$
     * @param answerId
     * @return {String}
     */
    function findSubAnswerValueById(thi$, answerId) {
        var result = '';

        thi$.subAnswersArray.forEach(function(subAnswer) {
            if (subAnswer.answerId == answerId) {
                result = eval(subAnswer.getValue());
                return false;
            }
        });

        return result;
    }

    /**
     * @name findSubAnswerMarkUpValueById
     * @desc private function, find subAnswer object markup value by specific answerId attribute
     * @param thi$
     * @param answerId
     * @return {String}
     */
    function findSubAnswerMarkUpValueById(thi$, answerId) {
        var result = '';

        thi$.subAnswersArray.forEach(function(subAnswer) {
            if (subAnswer.answerId == answerId) {
                result = (subAnswer.getMarkUpValue());
                return false;
            }
        });

        return result;
    }

    /**
     * @name findSubAnswerById
     * @desc private function, finds subAnswer object by specific answerId attribute (answerId is unique per task)
     * @param thi$
     * @param answerId
     * @return Object
     */
    function findSubAnswerById(thi$, answerId) {
        var obj = null;

        thi$.subAnswersArray.forEach(function(subAnswer) {
            if (subAnswer.answerId == answerId) {
                obj = subAnswer;
                return false;
            }
        });

        return obj;
    }

    /**
     * @name getFieldsSizeMode
     * @desc private function, if fieldsSize is not manual - find correct fieldsSize type (maxBank, maxBankAndAnswer) according to task mode
     * @return String
     * @param thi$ Class
     */
    function getFieldsSizeMode(thi$) {
        var fieldsSize = jQuery(thi$.cfg.fields_sizeData).text();  //manual

        if (thi$.mode != 'write') {
            fieldsSize = 'maxBank';
        }
        else if (!fieldsSize) {
            fieldsSize = 'maxBankAndAnswer';
        }

        return fieldsSize;
    }

    /**
     * @name getFieldsSize
     * @desc private function, switch on fieldsSizeMode to find subAnswer size by the longest answer option
     * @return returnObj Object {'fieldsSize' : 0, fieldsWidth : em}
     * @param thi$ Class
     */
    function getFieldsSize(thi$) {
        var returnObj = {'fieldsSize' : 0};

        switch (thi$.fieldsSizeMode) {
            case 'manual' :  //will override fieldSize Mode. And it's means that I'm looking for a specific mode for each component
                break;
            case 'maxBank' :
                var maxBankOption = calcMaxBankOption(thi$.cfg);
                returnObj.fieldsSize = maxBankOption.optionLen;
                returnObj.fieldsWidth = maxBankOption.optionWidth;
                
                // add 30% to subanswer size if ist from type mathfield 
                if(maxBankOption.isMathfield){
                    returnObj.fieldsSize = returnObj.fieldsSize * constants.mathfieldWidthFactor;
                    returnObj.fieldsWidth = returnObj.fieldsWidth * constants.mathfieldWidthFactor;
                }
                returnObj.ignoreSizeOnMathfield = maxBankOption.ignoreSizeOnMathfield;

                break;
            case 'maxAnswer' :
                var maxAnswerOption = calcMaxAnswer(thi$.cfg, thi$.mode);
                returnObj.fieldsSize = maxAnswerOption.optionLen;
                returnObj.fieldsWidth = maxAnswerOption.optionWidth;
                // add 30% to subanswer size if ist from type mathfield 
                if(maxAnswerOption.isMathfield){
                    returnObj.fieldsSize = returnObj.fieldsSize * constants.mathfieldWidthFactor;
                    returnObj.fieldsWidth = returnObj.fieldsWidth * constants.mathfieldWidthFactor;
                }
                returnObj.ignoreSizeOnMathfield = maxAnswerOption.ignoreSizeOnMathfield;

                break;
            case 'maxBankAndAnswer' :
                var maxAnswerOption = calcMaxAnswer(thi$.cfg, thi$.mode);
                var maxBankOption = calcMaxBankOption(thi$.cfg);

                returnObj.fieldsWidth = (maxAnswerOption.optionWidth > maxBankOption.optionWidth) ? maxAnswerOption.optionWidth : maxBankOption.optionWidth;
                returnObj.fieldsSize =  (maxAnswerOption.optionWidth > maxBankOption.optionWidth) ? maxAnswerOption.optionLen : maxBankOption.optionLen;
                // add 30% to subanswer size if ist from type mathfield 
                if(maxAnswerOption.isMathfield){
                    returnObj.fieldsSize = returnObj.fieldsSize * constants.mathfieldWidthFactor;
                    returnObj.fieldsWidth = returnObj.fieldsWidth * constants.mathfieldWidthFactor;
                }
                returnObj.ignoreSizeOnMathfield = maxAnswerOption.ignoreSizeOnMathfield;
                break;
        }

        //ignoreSizeOnMathfield - backward support for old content with mathfield but without widthEM- 
        //we dont want to set a size, but send null, to allow the  mathfiled have flexible width  

        if(returnObj.ignoreSizeOnMathfield){
            returnObj.fieldsWidth = null;
        }

        return returnObj;
    }


    /**
     * @name calcMaxBankOption
     * @desc private function, loops through bank answers options and find the longest one
     * @param cfg
     * @return {Object}
     */
    function calcMaxBankOption(cfg) {
        var fontSize = parseInt(cfg.parent.css('font-size'));
        var maxBankOption = {optionLen : 0, optionText : '', optionWidth : 0};
        var ignoreSizeOnMathfield = false;

        jQuery(cfg.data).find('bank subAnswer').each(function(index, subAnswerElement) { //loop throw bank subAnswers in order to find max long option

            var answerObject = {optionText : '', optionLen: 0, optionWidth: 0};;
            
            var optionElem = jQuery(subAnswerElement).find('mathfield');
            if(!optionElem.length){
                optionElem =  jQuery(subAnswerElement).find('textviewer');
                answerObject.optionText = optionElem.text().trim();
                answerObject.optionLen = answerObject.optionText.length;
                answerObject.optionWidth = answerObject.optionLen * fontSize;
                answerObject.isMathfield = false;
            }else{
                var widthEM = optionElem.attr('widthEM');
                answerObject.optionLen = parseInt(widthEM);
                answerObject.optionWidth = widthEM * fontSize;
                answerObject.isMathfield = true;
                if((widthEM === undefined || widthEM === "") && answerObject.isMathfield){
                    ignoreSizeOnMathfield = true;

                }
            }

            if (answerObject.optionWidth > maxBankOption.optionWidth) {
                maxBankOption = answerObject;
            }
        });
        maxBankOption.optionWidth = maxBankOption.optionWidth / fontSize;
        maxBankOption.ignoreSizeOnMathfield =  ignoreSizeOnMathfield ;

        return maxBankOption;
    }

    /**
     * @name calcMaxAnswer function
     * @param cfg
     * @param mode - cloze task modes : write / dragAndDisable / dragAndCopy
     * @desc private function, exp. loops through all answers options and find the longest one
     */
    function calcMaxAnswer(cfg, mode) {
        var maxAnswer = {optionLen : 0, optionText : '', optionWidth: 0};
        var ansArray = [];
        var fontSize = parseInt(cfg.parent.css('font-size'));
        var ignoreSizeOnMathfield = false;

        jQuery(cfg.data).find('correct ans_option').each(function(index, correctElem) {
            if (typeof jQuery(correctElem).text() != 'undefined') {
	            var checkType = jQuery(correctElem).attr('checkType') || 'value';
	            var answerObject = {optionWidth: 0, optionLen: 0, optionText: ''};

	            if (mode != 'write') {
		            var answerId = parseInt(jQuery(correctElem).text());
		            answerObject.optionText = jQuery.trim(jQuery(cfg.data).find('bank').find('subAnswer[answerId="' + answerId + '"]').text());
	            } else if (checkType == 'value' || checkType == 'markupValue') {
		            answerObject.optionText = jQuery(correctElem).text().trim();
	            }
                var widthEM = jQuery(correctElem).attr('widthEM');
	            if (widthEM !== undefined && widthEM !== "") {
		            answerObject.width = widthEM * fontSize;
		            answerObject.optionLen = parseInt(widthEM);
		            answerObject.isMathfield = true;
	            } else if(!!answerObject.optionText) {
		            answerObject.width = answerObject.optionText.length * fontSize;
		            answerObject.optionLen = answerObject.optionText.length;
		            answerObject.isMathfield = false;
	           }
               if((widthEM === undefined || widthEM === "") && checkType == 'markupValue'){
                    ignoreSizeOnMathfield = true;
               }

                ansArray.push(answerObject);
            }
        });

        jQuery(cfg.data).find('partiallyCorrect ans_option').each(function(index, optionElem) {
	        var checkType = jQuery(optionElem).attr('checkType') || 'value';
	        var answerObject = {optionWidth: 0, optionLen: 0, optionText: ''};
	        if (checkType == 'value' || checkType == 'markupValue') {
		        answerObject.optionText = jQuery(optionElem).text().trim();
	        }

            var widthEM = jQuery(optionElem).attr('widthEM');

	        if (widthEM !== undefined && widthEM !== "") {
		        answerObject.width = widthEM * fontSize;
		        answerObject.optionLen = parseInt(widthEM);
		        answerObject.isMathfield = true;
	        } else if (!!answerObject.optionText) {
		        answerObject.width = answerObject.optionText.length * fontSize;
		        answerObject.isMathfield = false;
	        }
            if((widthEM === undefined || widthEM === "") && checkType == 'markupValue'){
                ignoreSizeOnMathfield = true;
            }
	        ansArray.push(answerObject);
        });

        jQuery(cfg.data).find('incorrectPredicted ans_option').each(function(index, optionElem) {
	        var checkType = jQuery(optionElem).attr('checkType') || 'value';
	        var answerObject = {optionWidth: 0, optionLen: 0, optionText: ''};
	        if (checkType == 'value' || checkType == 'markupValue') {
		        answerObject.optionText = jQuery(optionElem).text().trim();
	        }

            var widthEM = jQuery(optionElem).attr('widthEM');
	        if (widthEM !== undefined && widthEM !== "") {
		        answerObject.width = (widthEM * fontSize);
		        answerObject.optionLen = parseInt(widthEM);
		        answerObject.isMathfield = true;
	        } else if (!!answerObject.optionText) {
		        answerObject.width = answerObject.optionText.length * fontSize;
		        answerObject.isMathfield = false;
	        }
            if((widthEM === undefined || widthEM === "") && checkType == 'markupValue'){
                ignoreSizeOnMathfield = true;
            }

            ansArray.push(answerObject);
        });

        ansArray.forEach(function(subAnswer) {
            if (subAnswer.width > maxAnswer.optionWidth) {
                maxAnswer.optionText = subAnswer.optionText;
                maxAnswer.optionLen = subAnswer.optionText.length;
                maxAnswer.optionWidth = subAnswer.width;
                maxAnswer.isMathfield= subAnswer.isMathfield;
            }
        });

        maxAnswer.optionWidth = (maxAnswer.optionWidth / fontSize);
        maxAnswer.ignoreSizeOnMathfield = ignoreSizeOnMathfield;
        return maxAnswer;
    }

    /**
     * @name getMutualDependency function
     * @desc private function, loops through mutual dependency in order to find all rules and subAnswer Ids inside it
     * @param cfg
     * @return {Object}
     */
    function getMutualDependency(cfg) {
        var result = {
            dependencyArray : [
                {'checkType': '', 'rule': '', 'Ids' : []}
            ],
            dependencyAnswerIds : []
        };

        jQuery(cfg.data).children('mutualDependency').find('option').each(function(index, optionElem) {
            var checkType = jQuery(optionElem).attr('checkType') || 'value';
            var optionText = jQuery(optionElem).text();
            var arrIds = [];
            var arrTmp = optionText.match(/(\[)\d(\])/g);

            arrTmp.forEach(function(value) {
                arrIds.push(parseInt(value.replace(/\[/g, '').replace(/\]/g, '')));
            });

            result.dependencyAnswerIds = result.dependencyAnswerIds.concat(arrIds);

            result.dependencyArray.push({'checkType': checkType, 'rule': jQuery.trim(optionText), 'Ids' : arrIds });
        });

        return result;
    }

    /**
     * @name countAnswers
     * @desc private function, calculates sum of correct / incorrect / partlyCorrect answers according to the type parameter
     * @param arrSubAnswers
     * @param type correct / incorrect / partlyCorrect
     * @return {Int}
     */
    function countAnswers(arrSubAnswers, type) {
        var result = 0;

        arrSubAnswers.forEach(function(subAnswer) {
            if (subAnswer.getCorrect() == type) {
                result++;
            }
        });
        return result;
    }

    /**
     * @name getFieldsType
     * @param cfg
     * @return {String}
     * @desc private function, check if this is textOnly or textAndMathfield type of subAnswers children inside the task
     */
    function getFieldsType(cfg) {
        var fieldsType = 'textOnly', mfMaxHeight, mfChild, mfAutoComma;

        jQuery(cfg.data).find('clozearea').find('subAnswer').each(function (index, subAnswer) {
	        if (jQuery(subAnswer).children('mathfield').length > 0) {
		        fieldsType = 'textAndMathfield';

		        mfChild = jQuery(subAnswer).children('mathfield');

		        mfAutoComma = mfChild.attr('autoComma');
		        if(!mfAutoComma) {
			        mfChild.attr('autoComma', true);
		        }

		        mfMaxHeight = (mfChild.attr('maxHeight') || '').toLowerCase();

		        if (mfMaxHeight == 'dynamic') {
			        mfMaxHeight = 'secondlevel';
			        mfChild.attr('maxHeight', 'secondLevel');
		        }

		        if (mfMaxHeight == 'secondlevel') {
			        fieldsType = 'textAndMathfieldSecondLevel';
		        }
	        }
        });

        jQuery(cfg.data).find('bank').find('subAnswer').each(function (index, subAnswer) {
            if (jQuery(subAnswer).children('mathfield').length > 0) {
                fieldsType = 'textAndMathfield';
                if ((jQuery(subAnswer).children('mathfield').attr('maxHeight') || '').toLowerCase() == 'secondlevel') {
                    fieldsType = 'textAndMathfieldSecondLevel';
                }

                return false;
            }
        });

        return fieldsType;
    }

    /**
     * @name getBankMode
     * @desc private function get BankMode accordingly to the task mode
     * @param taskMode
     * @return {String}
     */
    var getBankMode = function (taskMode) {
        var mode = null;

        switch (taskMode) {
            case 'write' :
                mode = 'readOnly';
                break;
            case 'dragAndDisable' :
                mode = 'dragAndDisable';
                break;
            case 'dragAndCopy' :
                mode = 'dragAndCopy';
                break;
            default :
                mode = 'readOnly';
        }

        return mode;
    }

})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/BaseClozeAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/ClozeAnswerConfig.js
////////////////////////////////////////
// Cloze Answer constant values
t2k.component.answer.ClozeAnswerConstants = {
    lineHeightMFExpansion:'1.3em',
    lineHeightMFSecondLevelExpansion:'3.3em',
    lineHeightWithHintExpansion:30,
    lineHeightNoHintExpansion:20,
    clozeObjectClassName:'t2k.component.cloze.ClozeArea',
    bankObjectClassName:'t2k.component.bank.Bank',
    'errorClass':'masc_error',
    'errorText':'ERROR : width of the cloze task is not wide enough to contain the bank component'
};


////////////////////////////////////////
// SRC End --> t2k/component/answer/ClozeAnswerConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/ClozeAnswerView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.ClozeAnswerView
     * @desc A cloze task view
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.AnswerView
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * @singleton
     * @name defaultConfig
     * @desc Hold sensible defaults for the cloze's view to use.
     * @type {Object}
     */
    var defaultConfig = {
        /** The default layout used by the cloze's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.ClozeAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @desc see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/ClozeAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/ClozeAnswer.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.ClozeAnswer
     * @desc A cloze task class
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.BaseClozeAnswer
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	var constants = t2k.component.answer.ClozeAnswerConstants;
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    t2k.component.answer.ClozeAnswer = t2k.component.answer.BaseClozeAnswer.subClass({
        /**
         * The class' name (for debugging purpose)
         * @type String
         */
        name: 't2k.component.answer.ClozeAnswer',

        /**
         * @name layoutSequenceDef
         * @desc Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         * @type Object
         */
        layoutSequenceDef: {
            init: [
                {initMembersAfterRendered: null},
                {looseSubAnswerSize: null},
                {evenSubAnswers: null},
                {checkForBankOverFlowWidth: null}
            ],
            reduce: [
                {compactBank: null},
                {looseSubAnswerSize: null},
                {evenSubAnswers: null},
                {checkForBankOverFlowWidth: null}
            ]
        },

        /**
         * @name ctor
         * @desc Class constructor
         * @constructor
         * @param config - {Object} The task's configuration
        */
        ctor: function(config) {
            // Delegate        	
            this._super(config);
        },

	    setViewClass: function() {
		    this.viewClass = t2k.component.answer.ClozeAnswerView;
	    }

    });


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/ClozeAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/ShortAnswerAnswerView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.ShortAnswerAnswerView
     * @desc A cloze task view
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.AnswerView
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * @singleton
     * @name defaultConfig
     * @desc Hold sensible defaults for the task view to use.
     * @type {Object}
     */
    var defaultConfig = {
        /** The default layout used by the task view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.ShortAnswerAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @desc see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        }
       
    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/ShortAnswerAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/ShortAnswerAnswer.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.ShortAnswerAnswer
     * @desc A cloze task class
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.BaseClozeAnswer
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	var constants = t2k.component.answer.ClozeAnswerConstants;
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    t2k.component.answer.ShortAnswerAnswer = t2k.component.answer.BaseClozeAnswer.subClass({
        /**
         * The class' name (for debugging purpose)
         * @type String
         */
        name: 't2k.component.answer.ShortAnswerAnswer',

        /**
         * @name layoutSequenceDef
         * @desc Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         * @type Object
         */
        layoutSequenceDef: {
            init: [
                {initMembersAfterRendered: null},
                {looseSubAnswerSize: null},
                {evenSubAnswers: null},
                {checkForBankOverFlowWidth: null}
            ],
            reduce: [
                {compactBank: null},
                {looseSubAnswerSize: null},
                {evenSubAnswers: null},
                {checkForBankOverFlowWidth: null}
            ]
        },

        /**
         * @name ctor
         * @desc Class constructor
         * @constructor
         * @param config - {Object} The task's configuration
        */
        ctor: function(config) {
            // Delegate        	
            this._super(config);
        },

	    setViewClass: function() {
		    this.viewClass = t2k.component.answer.ShortAnswerAnswerView;
	    }

    });


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/ShortAnswerAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/MtqAnswerView.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.MtqAnswerView
     * @desc A MTQ task view
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.AnswerView
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the mtq's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the mtq's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.MtqAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @desc see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        },

        /**
         * @name destroy
         * @desc remove task DOM
         */
        destroy : function(){
        	this._content.html('');
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/MtqAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/MtqAnswer.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.answer.MtqAnswer
     * @desc A MTQ task class
     * @namespace t2k.component.answer
     * @extends t2k.component.answer.Answer
     */
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    /**
     * Class: t2k.component.answer.MtqAnswer
     * The open-question task.
     */
    t2k.component.answer.MtqAnswer = t2k.component.answer.Answer.subClass({
        /** The class' name (for debugging purpose). */
        name: 't2k.component.answer.MtqAnswer',

        /**
         * @name layoutSequenceDef
         * @desc Layout sequence handlers' definition.
         * Valid sections are: init, reduce, loose, compact
         * @member
         * @type Object
         */
        layoutSequenceDef: {
            init: [
                {getMtqCheckablesComponents: null},
                {tileSubAnswers: null},
                {getDefinitionsArray: null},
                {setMaxDefinitionsWidth: true},
                {setMaxDefinitionsHeight: null},
                {MtqMathLayout: null}
            ],
            compact: [
                {tileSubAnswers: null},
                {getDefinitionsArray: null},
                {setMaxDefinitionsWidth: false},
                {setMaxDefinitionsHeight: null},
                {mtqAreaChildrenSqueezeComposite: null},
                {MtqMathLayout: null}
            ],
            loose: [
                {tileSubAnswers: null},
                {getDefinitionsArray: null},
                {setMaxDefinitionsWidth: true},
                {setMaxDefinitionsHeight: null},
                {MtqMathLayout: null}
            ],
            reduce: [
                {tileSubAnswers: null},
                {getDefinitionsArray: null},
                {setMaxDefinitionsWidth: true},
                {setMaxDefinitionsHeight: null}
            ]
        },

        /**
         * @name ctor
         * @desc Class constructor
         * @constructor
         * @param config - {Object} The task's configuration
         */
        ctor: function(config) {
            // Delegate
            this._super(config);

            this.setDefaultProgressConfig({
                buttonModes: {
                    currMode: "check"
                },
                allowDefaultInstruction:true,
                allowDefaultFeedback:true,
                allowDefaultHint:true,
                multipleAttempts: true
            });

            //init params
            this.initParams();

            // Create the mtq view.
            this.view = this.createNewView(t2k.component.answer.MtqAnswerView, this.cfg);

            this.build();
        },

        /**
         * @method
         */
        initParams : function() {

            /**
             * mtq task modes : matching / sorting / sequence
             * @type {String}
             */
            this.mode = jQuery(this.cfg.modeData).text();

            /**
             * IsPlaceholders (true / false)
             * @type {Boolean}
             */
            this.IsPlaceholders = (jQuery(this.cfg.placeholdersData).text() === 'true');

            /**
             * IsBank (true / false)
             * @type {Boolean}
             */
            this.IsBank = (jQuery(this.cfg.bankData).text() === 'true');

            /**
             * IsBankRandom (true / false)
             * @type {Boolean}
             */
            this.IsBankRandom = true;

	        this.IsRandom = (jQuery(this.cfg.bankrandomData).text() === 'true');

            /**
             * bankMode (dragAndCopy / dragAndDisable)
             * @type {String}
             */
            this.bankMode = jQuery(this.cfg.bankmodeData).text();

            /**
             *
             * @type {String}
             */
            this.progressType = jQuery(this.cfg.progressData).find("type").text() || 'init';

            //TODO: configure resetIncorrect by table modes
            /**
             * resetIncorrect
             * @type {Boolean}
             */
            var resetIncorrectText = jQuery(this.cfg.progressData).find('resetIncorrect').text();
	        resetIncorrectText = (resetIncorrectText === '' ? 'true' : resetIncorrectText);
            this.resetIncorrect = (!this.IsBank) ? false : (resetIncorrectText === 'true');

            //TODO: configure resetAllAnswers by table modes
            this.resetAllAnswers = true;

            this.mistakeFactor = jQuery(this.cfg.mistakefactorData).text() || 0;

            /**
             * reductionStep
             * @type {Number}
             */
            this.reductionStep = 0;
            /**
             * subAnswersArray
             * @type {Array}
             */
            this.subAnswersArray = null;
            /**
             * maxSubAnswerSizes
             * @type {*}
             */
            this.maxSubAnswerSizes = null;
            /**
             * definitionsArray
             * @type {Array}
             */
            this.definitionsArray = null;

            /**
             * checkingMode
             * @type {String} ( advanced / generic)
             */
            this.checkingMode = $(this.cfg.data).attr("checkingMode");

        },
        /**
         * @name setState
         * @desc override - set state of answer
         * @param state
         */
        setState : function(state) {
	        if (state && state.attr('enabled') === "true") {
		        dndManager.reset();

		        this.subAnswersArray = this.getChildrenRec(this.children, 'subanswer');    //array of all subAnswers in task

		        //insert all sub-answers into dndManager array
		        this.subAnswersArray.forEach(function (subAnswer) {
			        subAnswer.manageSALists();
		        });
	        }

	        this._super(state);
        },
        /**
         * @name build
         * @desc builds view + creates children + adjusting width and height and line height
         */
        build : function () {
            // Create the answer composite.
            this.startComposite2(this.prepareConfiguration(this.cfg));
        },
        /**
         * @name getMtqCheckablesComponents
         * @desc getMtqCheckablesComponents runs after onRendered
         */
        getMtqCheckablesComponents : function(){
            this.subAnswersArray = this.getChildrenRec(this.children, 'subanswer');
            this.mtqArea = this.getChildrenByClass('t2k.component.mtq.MtqArea')[0];
            this.bankElement = this.getChildrenByClass('t2k.component.mtq.MtqBank')[0];
            
            this.checkableArray = this.getCheckablesComponents();
            this.compositeRenderComplete();
        },
        /**
         * @name mtqAreaChildrenSqueezeComposite
         * @desc mtqAreaChildrenSqueezeComposite runs after onRendered
         */
        mtqAreaChildrenSqueezeComposite : function(){
            this.mtqArea.squeezeComposite(false);
            this.compositeRenderComplete();
        },

        /**
         * @name setEnabled
         * @param flag
         */
        setEnabled: function(flag) {
            if (flag) {
                dndManager.reset();
            }

            this._super(flag);

            if (flag) {
                this.performSampleMatch();   //perform sample match only after task is set enable
            }

            if (flag && this.progressType == 'init') {
                this.cfg.eventsManager.dispatchEvent('setProgressReady');
            }
        },

        /**
         * prepareConfiguration
         * prepare startComposite configuration
         * @param config
         * @returns mtq task config
         */
        prepareConfiguration : function(config) {

            var thi$ = this;

            return { 
            	parent: this.view.cfg.id + '_content', 
            	mode: this.mode, 
            	resetIncorrect : this.resetIncorrect, 
            	IsPlaceholders : this.IsPlaceholders,
                reductionStep : this.reductionStep, 
                optimumFontSize : this.optimumFontSize,
                bankMode : this.bankMode, 
                IsBank : this.IsBank, 
                IsBankRandom : this.IsBankRandom,
	            IsRandom : this.IsRandom,
	            data: this.cfg.data,
	            taskViewDomElement : this.view._view.parent().parent(),
	            checkAnswerOnState: this.cfg.checkAnswerOnState,

                // return component that appears beside to bank in this task
                getComponentBeSideToBank : function() {
                    return thi$.getChildrenByClass('t2k.component.mtq.MtqArea')[0];
                },

                // firstKeyDown is a callback that calls by children on the first real keyDown
                firstKeyDown : function() {
                    //the current function check if the task is enable before the button activation
                    thi$.progressHandlerAnswer();
                }
            };

        },

        /**
         * progressHandlerAnswer
         * check if the task is enable before the button activation
         */
        progressHandlerAnswer : function() {
            if (this.isEnabled()) {

                var asnwersSum = 0, thi$ = this;

                switch (this.progressType) {

                    case 'fullCompletion':
                    { //progress type is fullCompletion - check that all children is answered
                        this.checkableArray.forEach(function(child) {
                            asnwersSum = asnwersSum + (thi$.IsPlaceholders ? (child.isEmpty() ? 0 : 1) : child.children.length);
                        });

                        if (asnwersSum >= this.countOfAnswers) {  //check if answers count is equal to the childrens count
                            this.cfg.eventsManager.dispatchEvent('setProgressReady');
                        } else {
                            this.cfg.eventsManager.dispatchEvent('setProgressUnready');
                        }
                        break;
                    }
                    case 'oneCompletion' :
                    {
                        this.checkableArray.forEach(function(child) {
                            asnwersSum = asnwersSum + (thi$.IsPlaceholders ? (child.isEmpty() ? 0 : 1) : child.children.length);
                        });

                        if (asnwersSum > 0) {
                            this.cfg.eventsManager.dispatchEvent('setProgressReady');
                        } else {
                            this.cfg.eventsManager.dispatchEvent('setProgressUnready');
                        }
                        break;
                    }

                    default:
                        this.cfg.eventsManager.dispatchEvent('setProgressReady');
                }
            }
        },

        /**
         * adjustHeight
         * in case of bank existence - adjusting mtq height according to it
         */
        adjustHeight : function() {
            if (this.bankElement) {  //Check the existence of bank
                this.mtqArea.view.setHeight(this.bankElement.view._view.outerHeight(true));
            }
        },
        /**
         * resetSubAnswerSizes
         */
        resetSubAnswerSizes : function() {
            this.subAnswersArray.forEach(function(subAnswer) {
                if (subAnswer.view.resetElementSize) {
                    subAnswer.view.resetElementSize();
                }
            });
        },

        /**
         * get array of checkable components based of task mode
         */
        getCheckablesComponents : function() {

            var arrComponents = [];

            var childArray = [];

            var thi$ = this;

            if (this.mtqArea) {
                this.mtqArea.children.forEach(function(child) {
                    childArray = child.getChildrenByClass((thi$.mode == 'matching') ? 't2k.component.subAnswer.SubAnswer' : 't2k.component.subAnswer.MultiSubAnswer');

                    jQuery.merge(arrComponents, childArray);
                });
            }

            return arrComponents;

        },
        /**
         * loop through multiSubAnswers in order to find max length of correct answers array
         */
        getMultiSubAnswersExpectedCorrects : function() {
            var countOfAnswers = 0;
            var childCountOfAnswers = 0;

            this.checkableArray.forEach(function(child) {
                if (child.getMaxCountOfExpectedCorrects) {
                    childCountOfAnswers = child.getMaxCountOfExpectedCorrects();
                    if (childCountOfAnswers > countOfAnswers) {
                        countOfAnswers = childCountOfAnswers;
                    }
                }
            });

            return countOfAnswers;
        },
        
        /**
         * sets size of hidden multiSubAnswers
         */
        setMultiSubAnswersSize : function(countOfAnswersWithMistake) {
            var elementSizes =  this.getSubAnswerSize();

            this.checkableArray.forEach(function(child) {
                child.setSize(countOfAnswersWithMistake, elementSizes);
            });
        },

        /**
         * onCheck function - fires after check button pressed
         */
        onCheck: function() {
            var prop = null;

            var checkResult = {};
            var childCheck = {};

            // Iterate the checkable array and count correct and wrong ones.
            this.checkableArray.forEach(function(child) {
                childCheck = child.check();
                for (prop in childCheck) {
                    if (!checkResult.hasOwnProperty(prop)) {
                        checkResult[prop] = 0;
                    }
                    checkResult[prop] += childCheck[prop];
                }
            });

            if (this.bankElement) {
                jQuery(this.bankElement.children).each(function(i, subAnswer) {
                    subAnswer.setEnabled(false);
                });
                this.bankElement.view.markAsActive(false);
            }

            // see if we're all correct, allow progress
            if (checkResult.correct == checkResult.expected && checkResult.incorrect == 0) {

                this.cfg.eventsManager.dispatchEvent('setProgressDone');

            } else {
                var msgType = '';

                switch (this.checkingMode){

                    case 'advanced' :
                        //advanced partially correct feedback : 
                        if (this.mode == 'sequencing' && (checkResult.partiallyCorrect > 0)) {
                            if (Math.floor((checkResult.correct / checkResult.expected) * 100) > 80) {
                                msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT_MORE_80_PERCENT;
                            } else{
                                msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT_LESS_80_PERCENT;
                            }
                        } else if ((checkResult.empty > 0) && (checkResult.correct > 0) && (checkResult.incorrect > checkResult.empty)) {
                            msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT_PART_MISSING;
                        } else if ((checkResult.empty > 0) && (checkResult.correct > 0) && (checkResult.incorrect === checkResult.empty)) {
                            msgType = t2k.util.FeedbackUtils.TYPE_ALL_CORRECT_PART_MISSING;
                        } else if (checkResult.correct === 0) {
                            msgType = t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT;
                        } else if (Math.floor((checkResult.correct / checkResult.expected) * 100) > 80) {
                            msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT_MORE_80_PERCENT;
                        } else if (Math.floor((checkResult.correct / checkResult.expected) * 100) <= 80) {
                            msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT_LESS_80_PERCENT;
                        } else {
                            msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT;
                        }
                        break;

                    case 'generic' :
                        // only 3 feedback types: all correct, all incorrect, partially correct
                        if (checkResult.correct === 0) {
                            msgType = t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT;
                        } else {
                            msgType = t2k.util.FeedbackUtils.TYPE_PART_CORRECT;
                        }
                }

                var msgData = FeedbackService.createMessage(msgType);
                this.cfg.eventsManager.dispatchEvent('setProgressProgress', msgData);
            }
        },
        /**
         * onTryAgain function - fires after Try Again button is pressed
         */
        onTryAgain: function() {
            this.reset();
            this.cfg.eventsManager.dispatchEvent('setProgressProgress');
        },
        /**
         * onShowAnswer function - fires after Show Answer is pressed
         */
        onShowAnswer: function(ignoreProgress) {

            jQuery(this.checkableArray).each(function(i, child) {
                child.onShowAnswer();
            });


            if (!!!this.IsPlaceholders) { //in case of hidden template without bank
                jQuery(this.checkableArray).each(function(i, child) {
                    child.deleteWrongAnswers();
                });
            }

            if (this.bankElement) {
                jQuery(this.bankElement.children).each(function(i, subAnswer) {
                    subAnswer.setEnabled(false);
                });
                this.bankElement.view.markAsActive(false);
            }

	        this._super(ignoreProgress);
        },
        /**
         * reset function
         * run reset and disable on all children
         */
        reset: function(resetAll) {

            if (this.bankElement) {
                this.bankElement.resetBankLockState();
                this.bankElement.setEnabled(true);
                this.bankElement.view.markAsActive(true);
            }

            jQuery(this.checkableArray).each(function(i, child) {
                !!resetAll ? child.reset() : child.resetOnTryAgain();
            });

        }, // End of reset
        /**
         * performSampleMatch
         */
        performSampleMatch : function() {
            var thi$ = this;

            if (this.IsBank) {  //do animation
                if (this.mode == 'matching') {
                    this.recursiveAnimation(jQuery.extend([], this.checkableArray));  //checkableArray holds subAnswer objects
                } else {   //checkableArray holds multiSubAnswer objects

                    var subAnswersArray = [];

                    this.checkableArray.forEach(function(element) {
                        jQuery.merge(subAnswersArray, element.children);
                    });

                    thi$.recursiveAnimation(subAnswersArray);
                }
            } else {
                if (this.mode == 'matching') {
                    this.doSampleMatch(jQuery.extend([], this.checkableArray));
                } else { //checkableArray holds multiSubAnswer objects
                    var subAnswersArray = [];

                    this.checkableArray.forEach(function(element) {
                        jQuery.merge(subAnswersArray, element.children);
                    });

                    this.doSampleMatch(jQuery.extend([], subAnswersArray));
                }
            }

        },
        /**
         * doSampleMatch - perform sample match without animation
         * @param arrOfElements
         */
        doSampleMatch : function(arrOfElements){
            var thi$ = this;

            arrOfElements.forEach(function(element) {
                if (element.sampleMatchMode && element.getCorrectAnswer) {
                    var correctAnswer = element.getCorrectAnswer();

                    var elementAnswerId = element.answerId;
                    element.view.dispatchEvent('doDroppingEvent', {'dropAnswerId' : correctAnswer});

                    if (!this.IsBank) {
                        var answerSubAnswer = thi$.findSubAnswerByAnswer(correctAnswer);  //find subAnswer that holds current correct answer
                        answerSubAnswer.view.dispatchEvent('doDroppingEvent', {'dropAnswerId' : elementAnswerId});

                        if(thi$.mode == 'matching'){
                            answerSubAnswer.answerId = elementAnswerId;  //subAnswer is already exists
                        } else {
                            answerSubAnswer.initAnswerId = elementAnswerId;  //subAnswer is created
                        }

                        answerSubAnswer.draggable = true;
                        answerSubAnswer.manageDND();
                    }

                    if (element.sampleMatchMode == 'static') {  //in case of static sample match set subAnswer not draggable and not droppable
                        setObjectDisabled(element);
                    }
                }
            });
        },

        /**
         * recursiveAnimation
         * do dragging, animate and then dropping event of all subAnswers with sample match
         * @param arrOfElements
         */
        recursiveAnimation : function(arrOfElements) {

            if(arrOfElements.length == 0){
                return;
            }

            var thi$ = this;
            var draggedElement;

            var child = arrOfElements[0];

            if (child.sampleMatchMode && child.getCorrectAnswer) {
                var correctAnswer = child.getCorrectAnswer();

                var answerSubAnswer = thi$.findSubAnswerByAnswer(correctAnswer);  //find subAnswer that holds current correct answer

                if (answerSubAnswer) {
                    draggedElement = answerSubAnswer.triggerDraggingEvent();      //trigger start dragg event of subAnswer that holds correct answer

                    if (draggedElement) {

                        draggedElement.css({top: answerSubAnswer.view._view.offset().top, left: answerSubAnswer.view._view.offset().left});
                        Perf.select('body')[0].style.cursor = 'none';

                        //animation started
                        dndManager.animated(true);
                        draggedElement.animate({top: child.view._view.offset().top, left: child.view._view.offset().left}, 500, 'swing', function() {

                            //animation ended
                            dndManager.animated(false);

                            //do dropping event
                            var childAnswerId = child.answerId;
                            child.view.dispatchEvent('doDroppingEvent', {'dropAnswerId' : correctAnswer});  //after animation ends do dropping correct answer

                            if(!thi$.IsBank){
                               answerSubAnswer.view.dispatchEvent('doDroppingEvent', {'dropAnswerId' : childAnswerId});
                            }

                            draggedElement.remove();
                            draggedElement = null;

                            if (child.draggedElement) {
                                child.draggedElement.remove();
                                child.draggedElement = null;
                            }

                            dndManager.inDragObject = null; //clean dndManager in dragg object
                            dndManager.readyToDrop(false);
                            dndManager.afterDrop(false);
                            dndManager.overObject = null;

                            if (child.sampleMatchMode == 'static') {  //in case of static sample match set subAnswer not draggable and not droppable
                               setObjectDisabled(child);
                            }

                            arrOfElements.splice(0, 1);              //remove this subAnswer from array
                            thi$.recursiveAnimation(arrOfElements);  //call recursion function

                            Perf.select('body')[0].style.cursor = 'auto';

                        });

                    }
                }
            } else {
                 arrOfElements.splice(0, 1);              //remove this subAnswer from array
                 thi$.recursiveAnimation(arrOfElements);  //call recursion function
            }

        },

        /**
         * findSubAnswerByAnswer
         * @param answerId
         */
        findSubAnswerByAnswer : function(answerId) {

            var correctChild = null;

            this.subAnswersArray.forEach(function(child) {
                if (child.answerId == answerId) {
                    correctChild = child;
                    return false;
                }
            });

            return correctChild;
        },
        /**
         * getDefinitionsArray
         */
        getDefinitionsArray : function(){
	        //set mtqarea max-width
	        var maxWidth = this.view._view.parent().width();

	        !!this.mtqArea && this.mtqArea.setMaxWidth(maxWidth);

            this.definitionsArray = this.getChildrenRec(this.children, 'definition');

            this.layout.resetRenderedCounter();

            this.definitionsArray.forEach(function(definition) {
	            definition.setMaxWidth(maxWidth);
	            definition.view.maxSize = {'width' : 0, 'height' : 0};
                definition.compactChildren();
            });

            this.compositeRenderComplete();
        },
        /**
         * setMaxDefinitionsWidth
         */
        setMaxDefinitionsWidth : function(tileWithSubAnswers) {
	        if(this.mode === "sequencing") {
		        this.compositeRenderComplete();
		        return;
	        }

            var elementSizes = {'width': 0, 'height' : 0};
            var maxSizes = {'width': 0, 'height' : 0};

            var thi$ = this;

            this.definitionsArray.forEach(function(definition) {
                elementSizes = definition.getSize(false);
                maxSizes.width = (elementSizes.width > maxSizes.width) ? elementSizes.width : maxSizes.width;
            });

            if (!!tileWithSubAnswers && (thi$.maxSubAnswerSizes.width > maxSizes.width)) {
                maxSizes.width = thi$.maxSubAnswerSizes.width;
            }

	        this.definitionsArray.forEach(function(definition) {
		        definition.view.maxSize.width = maxSizes.width;
		        definition.view.maxSize.height = 0;
	        });

	        var thi$ = this;
	        var applyWidth = function() {
	            if ((maxSizes.width > 0) && (thi$.mode != 'sequencing')) {  //don't tile definitions on hidden template in sequencing
		            thi$.definitionsArray.forEach(function(definition) {
	                    definition.setWidth(maxSizes.width, true); // true- because we want to ovverride the laydown size of the text viewer
	                    definition.looseHeight();
	                });
	            }
	        }

	        if(thi$.setMaxDefinitionsWidthFuncIndex > -1) {
		        delete globalEvents.events[thi$.setMaxDefinitionsWidthFuncIndex];
	        }

	        globalEvents.add({
		        fnc: function(){
			        applyWidth();
		        }
	        });

	        thi$.setMaxDefinitionsWidthFuncIndex = globalEvents.events.length - 1;

            this.compositeRenderComplete();
        },
        /**
         * setMaxDefinitionsHeight
         */
        setMaxDefinitionsHeight : function() {
	        if(this.mode === "sequencing") {
		        this.compositeRenderComplete();
		        return;
	        }

            var elementSizes = {'width': 0, 'height' : 0};
            var maxSizes = {'width': 0, 'height' : 0};

            this.definitionsArray.forEach(function(definition) {
                elementSizes = definition.getSize(false);
                maxSizes.height = (elementSizes.height > maxSizes.height) ? elementSizes.height : maxSizes.height;
            });

	        this.definitionsArray.forEach(function(definition) {
		        definition.view.maxSize.height = maxSizes.height;
	        });

	        var thi$ = this;
	        var applyHeight = function() {
		        if (maxSizes.height > 0) {
			        thi$.definitionsArray.forEach(function(definition) {
				        definition.setHeight(maxSizes.height);
			        });
		        }
	        }

	        if(thi$.setMaxDefinitionsHeightFuncIndex > -1) {
		        delete globalEvents.events[thi$.setMaxDefinitionsHeightFuncIndex];
	        }

	        globalEvents.add({
		        fnc: function(){
			        applyHeight();
		        }
	        });

	        thi$.setMaxDefinitionsHeightFuncIndex = globalEvents.events.length - 1;

            this.compositeRenderComplete();
        },

        /**
         * getSubAnswerSize - loop subAnswers array in order to find max subAnswer size
         */
        getSubAnswerSize : function() {
            var maxSizes = {'width': 0, 'height' : 0};
            var elementSizes = {'width': 0, 'height' : 0};

            this.subAnswersArray.forEach(function(element) {
                elementSizes = element.getElementSize();
                maxSizes.width = (elementSizes.width > maxSizes.width) ? elementSizes.width : maxSizes.width;
                maxSizes.height = (elementSizes.height > maxSizes.height) ? elementSizes.height : maxSizes.height;
            });

            return maxSizes;
        },
        /**
         * tileSubAnswers_resetTile - reset tile of subAnswers
         */
        tileSubAnswers_resetTile : function(){
            this.subAnswersArray.forEach(function(element) {
                if (element.dndContainer != 'bank')
                    element.resetElementSize();
            });
        },

        /**
         * tileSubAnswers - tile all subAnswers components according to max subAnswer size
         */
        tileSubAnswers : function() {
            this.tileSubAnswers_resetTile();
            this.maxSubAnswerSizes = this.getSubAnswerSize();

            var thi$ = this;
            this.subAnswersArray.forEach(function(element) {
                if (element.dndContainer != 'bank')
                    element.setElementSize(thi$.maxSubAnswerSizes);
            });

            if (this.mode != 'matching' && !!this.IsPlaceholders) {  //in case of multiSubAnswer we have to set his width according to the subAnswers width
                this.checkableArray.forEach(function(child) {
                    child.setWidth(thi$.maxSubAnswerSizes.width);
                });
            }

            if (!this.IsPlaceholders) { //calculate hidden multiSubAnswer size
                var countOfAnswersWithMistake = this.getMultiSubAnswersExpectedCorrects() + parseInt(this.mistakeFactor);
                this.setMultiSubAnswersSize(countOfAnswersWithMistake);

                this.countOfAnswers = (countOfAnswersWithMistake - parseInt(this.mistakeFactor));
            } else {
                this.countOfAnswers = this.checkableArray.length;
            }

            this.compositeRenderComplete();
        },

        /**
         * mtq Math layouting method, calculates all possible sizes of components
         * in both vertical and horizontal types and choozes min height
         */
        MtqMathLayout : function() {

            var mtqAreaHeight = this.mtqArea.view._view.outerHeight(true);
            var mtqBankHeight = (this.bankElement ? this.bankElement.view._view.outerHeight(true) +
                t2k.component.bank.BankConstants.marginTop : 0);

            var parentWidth = this.view.cfg.parent.parents('.task_wrapper_internal').width();

            var arrPermutations = [];

            var mtqAreaChildrenCount = this.mtqArea.children.length;

            if (mtqAreaChildrenCount > 0) {

	            arrPermutations = jQuery.merge(arrPermutations, this.mtqArea.getSqueezedSizes(parentWidth));  //get all squeezed sizes of mtqArea (vertical)

	            var mtqAreaHorizontalSize = this.mtqArea.getHorizontalSize(parentWidth); // get mtqArea's horizontal size

                // validate mtqAreaHorizontalSize and push to arrPermutations
                if (mtqAreaHorizontalSize && mtqAreaHorizontalSize.areaWidth > 0) {
                    mtqAreaHorizontalSize.vertical = false;
                    if (mtqAreaHorizontalSize.areaWidth <= parentWidth) {
                        arrPermutations.push(mtqAreaHorizontalSize);
                    }
                }

                if (this.bankElement) {
                    var bankSqueezedSize, thi$ = this, child_index = -1;
                    
                    jQuery(arrPermutations).each(function(index, child) {
                        var remainderWidth = parentWidth - child.areaWidth;
                        var marginFactor = 21;

                        // get bank size vertical | horizontal
                        if (!!child.vertical) {
                            //get bank simulated size based on remainder width
                            bankSqueezedSize = thi$.bankElement.simulateSizeByWidth(remainderWidth - marginFactor);
                            // if bank width is larger than remainderWidth, bankSqueezedSize will get null
                        } else {
                            // on horizontal calculete size
                            bankSqueezedSize = thi$.bankElement.simulateSizeByWidth(parentWidth);
                        }

                        // validate bankSize
                        if (!!bankSqueezedSize) {
                            child.bankWidth = bankSqueezedSize.width;
                            child.bankHeight = bankSqueezedSize.height;
                        }

                        if (!!!child.bankHeight) {
                            child_index = (jQuery.inArray(child, arrPermutations));

                            if (child_index > -1) {
                                arrPermutations.splice(child_index, 1);  //remove element from the permutations array
                            }
                        }
                    });
                }else{
                     jQuery(arrPermutations).each(function(index, child) {
                        child.bankWidth = 0;
                        child.bankHeight = 0;
                     });

                }

                // *************************************
                // ***** fully arrPermutations END *****
                // *************************************

                //loop through the permutations array in order to find minimal [ mtq area combined with bank ] height
                var newAreaHeight = 0, minHeight = 0, minHeightIndex = -1, bankMargin = 21;

                jQuery(arrPermutations).each(function(index, child) {

                    // set newAreaHeight by vertical/horizontal
                    if (!!arrPermutations[index].vertical) {
                        // on vertical, newAreaHeight will be the larger height (bank || mtqArea)
                        newAreaHeight = (child.areaHeight > child.bankHeight) ? child.areaHeight : child.bankHeight;
                    } else {
                        // on horizontal, newAreaHeight will be the totalHeight (bank + mtqArea)
                        newAreaHeight = child.areaHeight + child.bankHeight + bankMargin;
                    }

                    // get arrPermutations min Height of mtqArea combined with bank
                    // on first run
                    if ((minHeightIndex == -1) || (newAreaHeight < minHeight)) {
                        minHeightIndex = index;
                        minHeight = newAreaHeight;
                    }

                });

                //check if after all calculations we got smaller height
                if (minHeight > 0) { //found smaller height
                    // get best permutation
                    var prmElement = arrPermutations[minHeightIndex];

	                var thi$ = this;

	                var applyMtqLayout = function() {
		                if (!!prmElement.vertical) {  //apply vertical layout
			                thi$.mtqArea.applyVerticalStyle(prmElement);
		                } else { //apply horizontal layout
			                thi$.mtqArea.applyHorizontalStyle(prmElement);
		                }

		                if (thi$.bankElement) {  //apply new bank width according to the optimal permutation
			                if (!!prmElement.vertical) {  //apply vertical layout
				                thi$.bankElement.applyVerticalStyle(prmElement);
			                } else {
				                thi$.bankElement.applyHorizontalStyle(prmElement);
			                }
		                }
	                };

	                if(thi$.mtqLayoutFuncIndex > -1) {
		                delete globalEvents.events[thi$.mtqLayoutFuncIndex];
	                }

	                globalEvents.add({
		                fnc: function(){
			                applyMtqLayout();
		                }
	                });

	                thi$.mtqLayoutFuncIndex = globalEvents.events.length - 1;

                }
            }

            this.compositeRenderComplete();
        },

        /**
         * getChildrenRec
         * @param childrenArray
         * @param childName
         * @returns children with wanted class name only array
         */
        getChildrenRec: function(childrenArray, childName){
            // if (!children) stop rec
            if (!childrenArray) return null;

            var name, childrenReducedArray = [], childRec, thi$ = this;
            // loop children
            jQuery(childrenArray).each(function(index, child) {
                // get class's last name
                name = child.name.split('.');
                name = name[name.length - 1].toLowerCase();
                // if option was found, push
                if (name == childName) {
                    childrenReducedArray.push(child);
                } else {
                    // rec child children
                    childRec = thi$.getChildrenRec(child.children, childName);
                    // and push results
                    jQuery(childRec).each(function(index, child) {
                        childrenReducedArray.push(child);
                    });
                }
            });

            return childrenReducedArray;
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    function setObjectDisabled(objectElement) {
        objectElement.draggable = false;
        objectElement.droppable = false;
        objectElement.manageDND();
        objectElement.setEnabled(false);
    }
})();
////////////////////////////////////////
// SRC End --> t2k/component/answer/MtqAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/McAnswerView.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the mc's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the mc's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.McAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
        },
        /**
		 * onViewRendered
		 * override with an empty function.
		 * textViewerView will dispatch the 'onRendered' event himself.
		 */
		onViewRendered : function(){
		} // end of onViewRendered
		
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/answer/McAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/McAnswer.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.answer.McAnswer
     * The multi-choice task.
     */
	t2k.component.answer.McAnswer = t2k.component.answer.Answer.subClass({
        /** The class' name (for debugging purpose). */
        name: 't2k.component.answer.McAnswer',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The task's configuration.
         */
        ctor: function(config) {
            // Delegate
            this._super(config);

            // Closure refs.
            var thi$ = this;
            var cfg = this.cfg;

            this.setDefaultProgressConfig({
                buttonModes: {
                    currMode: "check"
                },
                allowDefaultInstruction:true,
                allowDefaultFeedback:true,
                allowDefaultHint:true,
                allowDefaultAutocheck:false,
                multipleAttempts: true
            });
            //currently autocheck should be disabled (also in Progress)
            this.cfg.autocheck = false;
            
            this.tryAgainMode = false;
            
            this.currentCorrect = 0 ;

            this.cfg.lastSelected = this.cfg.currSelected = -1;

	        this.checkingMode = $(this.cfg.data).attr("checkingMode");
            
            // Create the view.
            this.view = this.createNewView(t2k.component.answer.McAnswerView, cfg);
            
            // Create the options.
            override(cfg, prepareOptionsConfiguration(cfg.data, {
            	autocheck: this.cfg.autocheck,
                parent: thi$.view,
                events: {
                    onSelect: function(index) {
                        thi$.optionSelect(index);
                    }
                }
            }));

            this.mcType = this.cfg.type = this.cfg.isMmc ? 'mmc' : 'mc';

            // start composite
            this.startComposite2(override(this.cfg, {parent: this.view.cfg.id + '_content', mode: 'mc'}));

            // get optionArray 
            this.optionArray = this.getOptionRec(this.children);
            
            // configure options and register option event - onSelect
            jQuery(this.optionArray).each(function(index, child){
            	
            	// config option
            	child.setIndex(index);
            	child.setType(thi$.mcType);
            	
            	// register onSelect event
            	child.view.registerEvent('onSelect', function(index){
            		thi$.optionSelect(index);
            	});
            });
            
        },
        /**
         * getOptionRec
         * @param childrenArray
         * @returns option array
         */
        getOptionRec: function(childrenArray){
        	// if (!children) stop rec
        	if (!childrenArray) return null;
        	
        	var name, optionArray = [], ret, thi$ = this;
        	// loop children
        	jQuery(childrenArray).each(function(index, child){
        		// get class's last name
        		name = child.name.split('.');
        		name = name[name.length-1].toLowerCase();
        		// if option was found, push
        		if (name == 'option'){
        			optionArray.push(child);
        		} else {
        			// rec child children
        			var optionRec = thi$.getOptionRec(child.children);
        			// and push results
        			jQuery(optionRec).each(function(index, child){
        				optionArray.push(child);
        			});
        		}
        	});
        	
        	return optionArray;
        },
        
		/**
		 * onCheck
		 */
		onCheck: function() {
			var cfg = this.cfg;
            var numCorrect = 0;
            var numIncorrect = 0;
            var thi$ = this;
            var selectedList = [] ;
            
            this.setInteractable(false);
            // Iterate the options and match the correct selection.

			this.optionArray.forEach(function(option, i) {
	            var isEnabled = (option.isSelected() && !thi$.cfg.checkAnswerOnState) ||
		            (thi$.cfg.autocheck || (!ENV.viewMode.readOnly && ENV.viewMode.isAssessment));

                if (option.isSelected()) {
                    if (option.isCorrect) {
                        option.markAsCorrect();
                        numCorrect++;
                    } else {
                        numIncorrect++;
                        option.markAsWrong();
                    }
                    selectedList.push( thi$.cfg.optionsConfig[i].name ) ;

                    var specificFeedbackValue;
                    try {
                       specificFeedbackValue = thi$.progressData.specificFeedbackMessages[option.cfg.data.id][option.isCorrect ? 'correct' : 'wrong'][option.cfg.data.id];
                    }catch(error){
                        specificFeedbackValue = undefined;
                    }
                    if(specificFeedbackValue !== undefined){
                        option.setSpecificFeedback(specificFeedbackValue, 'option');
                    }
                }
                option.setEnabled( isEnabled ) ;
            });
            
            this.currentCorrect = numCorrect ;
            
            var fbUtil = t2k.util.FeedbackUtils ;
            var msgType ;
            var msgData ;
            var scoreData ;
            
            // see if we're all correct, allow progress
            if ( numCorrect == cfg.numCorrect && numIncorrect == 0 ) {
	            msgType = fbUtil.TYPE_ALL_CORRECT;
	            msgData = FeedbackService.createMessage(msgType);
	            
	            if(ENV.viewMode.showTaskScore) {
		            scoreData = {
		            		correctRatio: (numCorrect / cfg.numCorrect)
		            } ;
	            }
	            
	            this.cfg.eventsManager.dispatchEvent('setProgressDone', [ msgData, scoreData ]);
	            // if we're autocheck, don't forget to deactivate the options.
	            if (thi$.cfg.autocheck) {
		            jQuery(this.optionArray).each(function (i, option) {
			            option.setEnabled(false);
		            });
	            }
            } else {

            	var noneCorrect = numCorrect == 0 ;            	
            	var correctPercent = 100 * numCorrect / cfg.numCorrect ;
            	
            	msgType = fbUtil.TYPE_ALL_INCORRECT ;

            	if( this.cfg.isMmc ) {

		            switch (this.checkingMode){

			            case 'advanced' :

                            if(noneCorrect){
                                //all incorrect
                                msgType = fbUtil.TYPE_ALL_INCORRECT ;

                            }else if((numIncorrect == 0) && (numCorrect < cfg.numCorrect)){
                                //all correct + missing                                
                                msgType = fbUtil.TYPE_ALL_CORRECT_PART_MISSING;
                            }else if((correctPercent < 80) && (numCorrect + numIncorrect == cfg.numCorrect)){
                                //less than 80% correct  + Number of items composing the correct answer is met 
                                 msgType = fbUtil.TYPE_PART_CORRECT_LESS_80_PERCENT ;

                            }else if((correctPercent >= 80) &&  (numCorrect + numIncorrect == cfg.numCorrect)){
                                 //more than 80% correct  + Number of items composing the correct answer is met
                                msgType = fbUtil.TYPE_PART_CORRECT_MORE_80_PERCENT ;
                            }else if((numCorrect > 0) && (numIncorrect > 0) && (numCorrect < cfg.numCorrect)){
                                //part correct + missing     
                                msgType = fbUtil.TYPE_PART_CORRECT_PART_MISSING;

                            }else if((numCorrect == cfg.numCorrect) && (numIncorrect > 0)){ 
                                //all correct + wrong                                
                                msgType = fbUtil.TYPE_ALL_CORRECT_PART_INCORRECT
                            }
                           
				            break;
			            case 'generic' :
				            if (noneCorrect) {
					            msgType = fbUtil.TYPE_ALL_INCORRECT;
				            }
				            else {
					            msgType = fbUtil.TYPE_PART_CORRECT;
				            }
				            break;

            	    }
	            }

            	var predictedFeedback;
            	var sortedSelectedList = selectedList.sort() ;
            	if( sortedSelectedList.length > 1 ) {
            		predictedFeedback = this.cfg.predictedCombinations[ selectedList.join( "," ) ] ;
            	} else {
            		predictedFeedback = sortedSelectedList[0] ;
            	} 

	            msgData = FeedbackService.createMessage( msgType, null, predictedFeedback );

	            if(ENV.viewMode.showTaskScore) {
		            scoreData = {'correctRatio' : (numCorrect / cfg.numCorrect)};
	            }

                thi$.cfg.eventsManager.dispatchEvent('setProgressProgress', [msgData, scoreData]);
            }
		},
		
		/**
		 * onTryAgain
		 */
		onTryAgain: function() {
			this.reset() ;
			this.setInteractable(true);
            this.cfg.eventsManager.dispatchEvent('setProgressProgress');

			if( 	!this.cfg.autocheck &&
					this.cfg.isMmc &&
					this.currentCorrect > 0 ) {
                this.cfg.eventsManager.dispatchEvent('setProgressReady');
			}
		},
		
		/**
		 * onShowAnswer
		 */
		onShowAnswer: function(ignoreProgress) {
			
			var cfg = this.cfg;
            var thi$ = this;
            // Iterate the options and match the correct selection.
            jQuery(this.optionArray).each(function(i, option) {
                if (option.isCorrect) {
                    option.markAsSystemCorrect();
                	option.setEnabled(true);
                } else {
					option.reset() ;
                	option.setEnabled(false);
                }
            });

			this._super(ignoreProgress);
		},
		
		/**
		 * reset
		 */
        reset: function() {
        	var thi$ = this ;
            var cfg = this.cfg;
            jQuery(this.optionArray).each(function(i, option) {
                option.setEnabled(true);
                if (!option.isMarkedAsCorrect()) {
                    option.reset();
                }
            });
        }, // End of reset
        
        /**
         * optionSelect handler
         * @param index
         */
        optionSelect: function(index) {
            // Closure refs.
            var cfg = this.cfg;
			if ( !this.isInteractable() || !this.optionArray[index].isEnabled()) return;
			
            var optionsSelected = 0;

            jQuery(this.optionArray).each(function(i, option) {
                if (option.isMarkedAsCorrect()){
	                return;
                };

                if (i == index) {
                    option.setSelected(!option.isSelected());
                } else {
                    if (!cfg.isMmc) option.setSelected(false);
                }
                if (option.isSelected()) {
                    optionsSelected++;
                    cfg.lastSelected = cfg.currSelected;
                    cfg.currSelected = option.cfg.index;
                }
            });

			var allSelected = ( optionsSelected + this.currentCorrect ) == this.optionArray.length ;

	        var allCorrectSelected = (this.currentCorrect == this.cfg.numCorrect);
			
            if ((allCorrectSelected && this.cfg.isMmc)  //in mmc mode all correct options is selected
	            || (optionsSelected && ( !allSelected || this.cfg.autocheck)) ) {
                this.cfg.eventsManager.dispatchEvent('setProgressReady');
            } else {
                this.cfg.eventsManager.dispatchEvent('setProgressUnready');
            }
        },


        //assessment

        //assessment

        isAssessable:function() {
            return true
        },

        assessmentScore:function() {
        	///////////////////////////////////////////////////
        	// support MC only, not MMC
        	///////////////////////////////////////////////////
        	
        	var maxScore = this.getAssessmentMaxScore() ;
            var numCorrect = 0;
            var numIncorrect = 0;
            
        	jQuery(this.optionArray).each(function(i, option) {
                if (option.isSelected()) {
                    if (option.isCorrect) {
                        numCorrect++;
                    } else {
                        numIncorrect++;
                    }
                }
            });
        	
            return ( numCorrect == 1 ) ? maxScore : 0 ;
        	///////////////////////////////////////////////////
        	

        	///////////////////////////////////////////////////
            // old assessment code - supporting options weight
        	///////////////////////////////////////////////////
//            var calculatedScore = 0 ;
//            
//            jQuery (this.optionArray ).each( function( i, option ) {
//            	
//                if( option.isSelected() ) {
//                    
//                	var optWeight = option.cfg.optionsConfig[i].weight ;
//                	calculatedScore += ( optWeight / 100 ) * maxScore ;
//                    
//                }
//                
//            });
//            
//            // normalize value to 0 --> maxScore
//            calculatedScore = Math.min( calculatedScore, maxScore ) ;
//            calculatedScore = Math.max( calculatedScore, 0 ) ;
//            
//            // round
//            calculatedScore = Math.round( calculatedScore ) ;
//            
//            return calculatedScore ? calculatedScore : 0 ;
        	///////////////////////////////////////////////////
        },
        /**
         * allCorrectAnswersSelected
         * @returns {Boolean}
         */
        allCorrectAnswersSelected: function() {
            var result = true;
            // Closure ref.
            var cfg = this.cfg;
            jQuery(this.optionArray).each(function(i, option) {
                if (option.isCorrect && !option.isMarkedAsCorrect()) {
                    result = false;
                }
            });
            return result;
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private:
     * Function: prepareOptionsConfiguration
     * Extract the options configuration from the xml and find out if this task is MC or MMC. If none of the options is
     * marked as the right answer an error is thrown.
     *
     * Parameter:
     *  param - {XML} taskXml The task's configuration XML.
     *  optSupplConfig - {Object} Supplemental configuration that is common for all options.
     *
     * Returns:
     *  {Object} that contains two values: optionsConfig, isMmc (boolean), isRandom (boolean), isAutocheck (boolean).
     */
	// TODO: clear 
    function prepareOptionsConfiguration(taskXml, optSupplConfig) {
        // The result object.
        var result = {
            optionsConfig: [],
            predictedCombinations: {},
            isMmc: false,
            isRandom: false,
            numCorrect: 0
        };

        // Get the options element.
        var jqXml = jQuery(taskXml).find("options");
        result.isRandom = jqXml.attr("random") === "true";
        
        // Count correct answers.
        var correctAnswersCount = 0;
        
        var isAssessment = ENV.viewMode.isAssessment ;
        
        // Iterate the XML 'option' elements.
	    function iterateOption(index, optionXml) {
		    // Extract the option's values from the option XML.
		    var jqOptionXml = jQuery(optionXml);
		    var optName = jqOptionXml.attr("id") ;
		    optName = optName ? optName : index+1 ;
		    // Create option configuration.
		    var cfg = {
			    name: optName,
			    data: optionXml,
			    autocheck: optSupplConfig.autocheck ? 'autocheck' : '',
			    correct: jqOptionXml.attr("correct") === "true",
			    origIndex: index
		    };

		    if( isAssessment ) {
			    cfg.weight = jqOptionXml.attr("weight") * 1 ;
		    }

		    // Add the supplemental configuration values.
		    copy(cfg, optSupplConfig);
		    // Push the configuration to the result object.
		    result.optionsConfig.push(cfg);
		    // Check for correct answer and increment the count.
		    if (cfg.correct) correctAnswersCount++;
	    }
        jqXml.find("option").each(iterateOption);

        // Validate.
        if (correctAnswersCount == 0) throw "No correct answers";

	    var taskType = taskXml.getAttribute('type');

	    if (taskType) {
		    result.isMmc = (taskType === 'mmc');
	    } else { // Set the MMC flag.
		    if (correctAnswersCount > 1) result.isMmc = true;
	    }

        result.numCorrect = correctAnswersCount;
        
        var predictedXML = jQuery( taskXml ).find("predicted") ;
        if( predictedXML.length > 0 ) {
	        jQuery( predictedXML ).find("combination").each(function(index, combinationXml) {
	        	var jCombXml = jQuery(combinationXml);
	        	var options =  jCombXml.attr("options").split( ',' ) ;
	        	var name = jCombXml.attr("feedbackName") ;
	        	options.sort() ;
	        	result.predictedCombinations[ options.join( ',' ) ] = name ; 
	        } ) ;
	    }
        // Return the result.
        return result;
    } // End of prepareOptionsConfiguration


})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/McAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/AppletAnswerView.js
////////////////////////////////////////
(function() {

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Singleton, Private Members.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	/**
	 * Private: defaultConfig Hold sensible defaults for the mc's view to use.
	 */
	// var defaultConfig = {
	// /** The default layout used by the mc's view */
	// layout: 'inline'
	// }; // End of defaultConfig.
	t2k.component.answer.AppletAnswerView = t2k.component.answer.AnswerView
			.subClass({

				/**
				 * @constructor
				 * @see superclass documentation
				 */
				ctor : function(config) {
					// Delegate.
					this._super(config);
				},
				/**
				 * onViewRendered override with an empty function.
				 * textViewerView will dispatch the 'onRendered' event himself.
				 */
				onViewRendered : function() {
				} // end of onViewRendered

			});

})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/AppletAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/AppletAnswer.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.answer.AppletAnswer
     * The multi-choice task.
     */
	t2k.component.answer.AppletAnswer = t2k.component.answer.Answer.subClass({
        /** The class' name (for debugging purpose). */
        name: 't2k.component.answer.AppletAnswer',
        
        firstTimeEnabled: false,

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The task's configuration.
         */
        ctor: function(config) {
            // Delegate
            this._super(config);

            // Closure refs.
            var thi$ = this;
            var cfg = this.cfg;
            
        	var isCheckable = this.isCheckable() ;
            
            this.setDefaultProgressConfig({
                buttonModes: {
                    currMode: isCheckable ? "check" : "progress"
                },
                allowDefaultInstruction:true,
                allowDefaultFeedback:true,
                allowDefaultHint:true,
                allowDefaultAutocheck:false,
                multipleAttempts: true
            });
            
            this.tryAgainMode = false;
            
            this.currentCorrect = 0 ;

            
            // Create the view.
            this.view = this.createNewView(t2k.component.answer.AppletAnswerView, cfg);
            
            override(cfg, {
            	autocheck: this.cfg.autocheck,
                parent: this.view
            });
           
            // start composite
            this.startComposite2(override(this.cfg, {parent: this.view.cfg.id + '_content', dontEnableBlowup : true}));

            // get optionArray 
            this.applet = this.getAppletRec(this.children);
            
        },
        
        isCheckable: function() {
        	return $(this.cfg.data).attr( "checkable" ) === "true" ;
        },
        
        onReadyToBeChecked:function(){
        	this.cfg.eventsManager.dispatchEvent('setProgressReady');
        },
        /**
         * getOptionRec
         * @param childrenArray
         * @returns option array
         */
        getAppletRec: function(childrenArray){
        	// if (!children) stop rec
        	if (!childrenArray) return null;
        	
        	var name, applet, ret, thi$ = this;
        	// loop children
        	jQuery(childrenArray).each(function(index, child){
        		// get class's last name
        		name = child.name.split('.');
        		name = name[name.length-1].toLowerCase();
        		// if option was found, push
        		if (name == 'applet'){
        			applet = child;
        		}
        	});
        	
        	return applet;
        },
        
		/**
		 * onCheck
		 */
		onCheck: function() {
			var cfg = this.cfg;
            var thi$ = this;
            
            this.setInteractable(false);
            
           	this.applet.check( function( result ) {

                var fbUtil = t2k.util.FeedbackUtils ;
                var msgType ;
                var msgData ;
                var eventType;
                
                if(result == "correct"){
                	msgType = fbUtil.TYPE_ALL_CORRECT ;
                	eventType = "setProgressDone";
                }
                else if(result == "partly"){
                	msgType = fbUtil.TYPE_PART_CORRECT ;
                	eventType = "setProgressProgress";
                }
                else{
                	msgType = fbUtil.TYPE_ALL_INCORRECT ;
                	eventType = "setProgressProgress";
                }
                
            	msgData = FeedbackService.createMessage( msgType ) ;
            	thi$.cfg.eventsManager.dispatchEvent( eventType, msgData ) ;
            	
           	} ) ;
        	//correct / wrong / partly
            
		},
		
		/**
		 * onTryAgain
		 */
		onTryAgain: function() {
			this.setInteractable(true);
            this.cfg.eventsManager.dispatchEvent('setProgressProgress');
			this.cfg.eventsManager.dispatchEvent('setProgressReady');
            
            this.applet.tryAgain();
		},
		
		/**
		 * onShowAnswer
		 */
		onShowAnswer: function(ignoreProgress) {

			var cfg = this.cfg;
            var thi$ = this;
			this._super(ignoreProgress);
            this.applet.showAnswer();

		},
		
        setEnabled: function(flag) {
             this._super(flag);
             
             if(flag == true && this.firstTimeEnabled == false){
                 this.onReadyToBeChecked();
                 firstTimeEnabled = true;
             }
        },

        isAssessable:function() {
            return true;
        },

        assessmentScore:function() {
            
        },
        
        // don't reduce me 
        reductionAvailable : function() {
            return false;
        }

    });



})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/AppletAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/StatementAnswerView.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the Statement's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the Statement's view */
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.component.answer.StatementAnswerView = t2k.component.answer.AnswerView.subClass({

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));
            
        }
    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/answer/StatementAnswerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/answer/StatementAnswer.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.component.answer.StatementAnswer
     * The open-question task.
     */
    t2k.component.answer.StatementAnswer = t2k.component.answer.Answer.subClass({
        /** The class' name (for debugging purpose). */
        name:'t2k.component.answer.StatementAnswer',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The task's configuration.
         */
        ctor:function (config) {
            // Delegate
            this._super(config);

            // Create the opq view.
            this.view = this.createNewView(t2k.component.answer.StatementAnswerView, this.cfg);
        },

        //override
        setEnabled:function (flag) {
            this._super(flag);

            // set progress = ready on flag = true
            if (flag) {
                this.cfg.eventsManager.dispatchEvent('setProgressReady');
            }
        },

        getState:function () {
            // create xml
            var state = this._super();
            // collect all text editor state from view

            return state;
        },

        setState:function (state) {
            this._super(state);
            // set state for all state items
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/component/answer/StatementAnswer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textEditor/TextEditorConfig.js
////////////////////////////////////////
// toolbar objects
t2k.component.textarea.TextEditorViewToolbarConfig = {
		
	student : {
		
		fontSize 	: [],
		undo  		: [],
		redo  		: [],
		bold 		: [],
		italic 		: [],
		underline 	: [],
		lists 		: [],
		aligns 		: [],
		indents 	: [],
		//dirs 		: [],
		marker		: [],
		setColor	: []
		
	},
	
	marker : {
		
		marker		: []
	
	},
	
	studentMath : {
		
		fontSize 	: [],
		undo  		: [],
		redo  		: [],
		bold 		: [],
		italic 		: [],
		underline 	: [],
		lists 		: [],
		aligns 		: [],
		indents 	: [],
		//dirs 		: [],
		marker		: [],
		setColor	: [],
		mf			: []
		
	},
    studentMath1 : {

    		fontSize 	: [],
    		undo  		: [],
    		redo  		: [],
    		bold 		: [],
    		italic 		: [],
    		underline 	: [],
    		lists 		: [],
    		aligns 		: [],
    		indents 	: [],
    		//dirs 		: [],
    		marker		: [],
    		setColor	: []
//	,
//    		mf			: []

    	},

	onlyMath : {
		mf			: []
	}
		
};

// opacity values
t2k.component.textarea.TextEditorViewOpacity = { 

		hide : "hide",
		fade : "0.99",
		show : "1",
		
		opacityDuration : 200
			
};


// styles attributes config for exec command
t2k.component.textarea.TextEditorViewStylesAttr = { 
		font		: "fontName",
		color		: "foreColor",
		size		: "fontSize",		
		bold   		: "bold",
		italic 		: "italic",
		underline 	: "underline"
		
};

// TextEditor constant values
t2k.component.textarea.TextEditorViewConstants = { 

		// overflow space at right / left
		spacer					: 10,
		constantTriangleTop 	: 1,
		constantTriangleSpace 	: 7,
		constantTriangleBGSpace	: 8,
		tasksHolderClass		: ".player_content",
		panelClass				: "themable_widget_ta_toolbar_panel",
		themableClass			: "themable_widget",
		themableClass_ta		: "themable_widget_ta",
		toolbarClass			: "themable_widget_ta_toolbar",
		widthHeightExpansion	: 8,
		maxTextAreaWidth		: 714, // must be 51rem. example: 51 * 14(html/body font-size) = 714
		minTextAreaWidth		: 294,
		widthRefrence			: 0.9,
		fontAspectRatio			: 1.2,
		defaultCssClass			: 'style1',
		textEditorCssClass		: 'css/textEditor.css',
		mathFieldCssClass		: 'css/mathField.css',
        fontsCss                : 'css/fonts.css'
};

// mode object
t2k.component.textarea.TextEditorViewModes = { 

		letter : {
			displayMaxChar 		: "1",
			charLimit 			: true,
			scrollBar		 	: false,
			keyScroll      		: false,
			enableEnter 		: false,
			displayToolbar		: false,
			width				: "fixByStyle",
			height				: "fixByStyle"
		},
		
		word : {
			displayMaxChar 		: "22",
			minDisplayMaxChar 	: "2",
			maxDisplayMaxChar 	: "45",
			charLimit 			: true,
			scrollBar		 	: false,
			keyScroll      		: false,
			enableEnter 		: false,
			displayToolbar		: false,
			width				: "fixByStyle",
			height				: "fixByStyle"
		},
		
		sentence : {
			displayMaxChar 		: "45",
			charLimit 			: false,
			scrollBar		 	: false,
			keyScroll      		: true,
			enableEnter 		: false,
			displayToolbar		: false,
			width				: null,
			height				: "fixByStyle"
		},
		
		paragraph : {
			displayMaxChar 		: "150",
			charLimit 			: false,
			scrollBar		 	: true,
			keyScroll      		: false,
			enableEnter 		: true,
			displayToolbar		: true,
			width				: null,
			height				: null
		},
		
		fullText : {
			displayMaxChar 		: "500",
			charLimit 			: false,
			scrollBar		 	: true,
			keyScroll      		: false,
			enableEnter 		: true,
			displayToolbar		: true,
			width				: null,
			height				: null
		}
			
};
////////////////////////////////////////
// SRC End --> t2k/component/textEditor/TextEditorConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textEditor/TextEditorView.js
////////////////////////////////////////
/**
 * TextAreaParams
 * the object that will be received by TextArea's @constructor
 */

t2k.component.textarea.TextEditorViewParams = function() {
    this.id                 = "";
    this.width              = "";  // size + 'px'
    this.height             = "";  // size + 'px'
    this.initText           = "";  // markup
    this.setClass           = "";  // css
    this.parentId           = "";
    this.maxChar            = "";
    this.direction          = "";  // 'ltr' (default)/ 'rtl'
    this.keyUpFunction      = "";  // todo: remove
    this.toolBarPreset      = "";  // TextAreaToolbarConfig
    this.mode               = "";  // t2k.component.textarea.TextEditorViewModes
    this.enableCharLimit    = "";  // optional, mode override
    this.enableScrollbar    = "";  // optional, mode override
    this.enableKeyscroll    = "";  // optional, mode override
    this.enableToolbar      = "";  // optional, mode override
    this.firstKeyDown       = "";  // callback
    this.setClass           = "";  // callback
};


(function() {

    /**
     * Private: TEMPLATE
     * The Mustache template used by the tasks's view.
     * 2d0 - Implement Roman's way of managing templates.
     */
    var TEMPLATE = "";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the task's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.


    t2k.component.textarea.TextEditorView = t2k.component.BaseComponentView.subClass({

        /**
         * @constructor TextArea
         * @param TextAreaParams
         */
        ctor: function(config) {
            // Delegate.
            this._super(override(config, defaultConfig));
            var TextAreaParams = config;

            /**
             * @constructor TextArea
             * @param id
             * @param width
             * @param height
             * @param initText
             * @param setClass
             * @param parentId
             * @param maxChar
             * @param direction - must be "rtl" or "ltr"
             * @param keyUpFunction
             * @param toolBarPreset - must be "studentToolbar" or "teacherToolbar" or any other toolbar name that appears at TextAreaConfig.js
             */

                // data members
            this.id              = TextAreaParams.id;
            this.width           = TextAreaParams.width;
            this.maxWidth        = TextAreaParams.maxWidth;
            this.height          = TextAreaParams.height;
            this.maxChar         = TextAreaParams.maxChar;
            this.initText        = TextAreaParams.initText;
            this.setClass        = TextAreaParams.setClass;
            this.setAnswer       = TextAreaParams.setAnswer;
            this.parentId        = TextAreaParams.parentId;
            this.keyUpFunction   = TextAreaParams.keyUpFunction;
            this.toolBarPreset   = TextAreaParams.toolBarPreset;
            this.firstKeyDown    = TextAreaParams.firstKeyDown;
            this.removeContent   = this._removeContent;
            this._firstKeyPressed = false;
            this._ctrlDown       = false ;
            this._toolbarOpacityMode;
            this._iframeDoc;
            this._bodyElement;
            this._toolbarElement;
            this._enable;
            this._Range;

            this.isMinimunReadable = false;
            this.isAbsoluteMinimun = false;
            this.reductionStepSize = t2k.component.textViewer.TextViewerConstants.reductionStepSize;
            this.reductionStep   = 0;
            this.optimumFontSize = TextAreaParams.optimumFontSize;
            this.setFontSize = TextAreaParams.setFontSize;
            this.fontColor = TextAreaParams.fontColor;

            // browser params
            this._browser = this._getBrowserType();

            // mode params
            this._displayMaxChar;
            this._enableCharLimit = TextAreaParams.enableCharLimit || '';
            this._enableScrollbar = TextAreaParams.enableScrollbar;
            this._enableKeyscroll = TextAreaParams.enableKeyscroll;
            this._enableEnter     = true; // default
            this._enableToolbar   = TextAreaParams.enableToolbar;
            this._mode            = TextAreaParams.mode;

            //current style according to the css class this.setClass
            this.style = null;

            // set mode params by mode
            this._setModeParams();

            // default direction: ltr
            if (!TextAreaParams.direction) {
                TextAreaParams.direction = "ltr";
            }
            this.direction  = TextAreaParams.direction;

            this._undoIndex = 0;
            this._undoArray = [];

            this._clipboard = null;
            this._undoMode  = false;

            // get and set the control toolbar
            this.textAreaControls = this._textAreaControlsHashCreate();
            this.textAreaTollBarZone = this._setTextAreaToolBar(this.textAreaControls);



            // create textarea iframe
            this.textAreaIframe  = this._createTextAreaIframe();

            // create textarea outer div, append it the toolbar and iframe and appent the div to the parent
            this._buildTextAreaOuterDiv();

            // creates toolbar's triangle
            this._buildTollbarTriangle();

            // hide toolbar
            this._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide);

            // set iframe design mode
            this._setTextAreaDesignMode();

            // set initText, direction, keyUp handle, maxChar handle exc..
            this._initTextArea();

            // default textarea behavior - disable
            this.enable(false);

            // set undo disable
            this._enableControl("undo","no");

            // set Init Style
            this._setInitStyle("onInitTA");

            this._initUndo();

            // set & check height & width for 'paragraph' or 'fullText' modes
            this._setAndCheckTextareaSizes();
        },

	    resetBody:function (TextArea) {
		    !!TextArea._iframeDoc.activeElement && TextArea._iframeDoc.activeElement.blur();

		    var bodyElementParent = TextArea._bodyElement.parent(),
			    bodyElement = TextArea._bodyElement.detach();

		    bodyElementParent.append(bodyElement);
		    bodyElement = null;
		    bodyElementParent = null;
	    },

	    onBodyClick: function(flag) {

		    var TextArea = this;

		    function onClickBody(e){

			    if(!!ENV.behaviors.isTablet) {
				    var $target = jQuery(e.target);
				    if (($target.parents('#body_texteditor').length == 0) &&
					    ($target.parents(".themable_widget_ta_toolbar").length == 0)) {
					    TextArea.resetBody(TextArea);
				    }
				    $target = null;
			    }

			    if (TextArea._toolbarOpacityMode > 0 && TextArea._toolbarOpacityMode < 1 && !TextArea._holdToolbarDisplay){
				    TextArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide); //hide toolbar on focusOut
				    TextArea._removePanel();
				    TextArea._iframeDoc && TextArea._iframeDoc.getSelection() && TextArea._iframeDoc.getSelection().removeAllRanges();  //cancel selection
			    }


		    }

		    var eventName = !!ENV.behaviors.isTablet ? 'touchstart' : 'click';
		    
		    jQuery('body').unbind(eventName, onClickBody);

		    if(flag) {
		    	
			    jQuery('body').bind(eventName, onClickBody);
			
				if( ENV.behaviors.fireUIEvents ) {
					ENV.host.onUIEvent( "blur" ) ;
				}
		    }

	    },

        //override - set state of component
        setMyState : function(state){
            this.state = state;

            this.setEnabled(jQuery(state).attr('enabled') === 'true');

            this.replaceContent(jQuery(state).children('initText').text());

        },

        //override - get state of component
        addMyState : function(state){
            var state = jQuery('<state/>')
                .append(jQuery('<initText/>').text(this.getMarkUpValue()));

            return state;
        },

	    remove : function() {
		    this._view.removeNative();
		    this._bodyElement.removeNative();
		    this._toolbarElement.removeNative();
		    jQuery(this.textAreaIframe).removeNative();
		    jQuery(this.textAreaTollBarZone).removeNative();
		    jQuery('#' + this.id + 'outerDiv').removeNative();
	    },

        // public functions:
        /**
         * calcFontSizeByReduction
         * @param val - reduction value (if null - set 1)
         */
        calcFontSizeByReduction : function(val){

            if (!this.isMinimunReadable && this.optimumFontSize != undefined && this.reductionStep > 0){
                // if val == null set val = 1
                var reductionValue = (val != undefined && val > 0) ? val : 1;
                // add the val to the current reductionStep
                this.reductionStep = this.reductionStep + reductionValue;
                // calc font size by reductionStep
                this.setFontSize = this.optimumFontSize - (this.reductionStep * this.reductionStepSize);
                // if fontSize is less then fontSizeMinReadable
                if (this.setFontSize < t2k.component.textViewer.TextViewerConstants.minimumReadableFontSize){
                    // set fontSize = minimumReadable (not less)
                    this.setFontSize = parseInt(t2k.component.textViewer.TextViewerConstants.minimumReadableFontSize);
                    // min readable flag
                    this.isMinimunReadable = true;
                    // if absolute minimum if apply
                    if (!!this.applyAbsoluteMinimum && !this.isAbsoluteMinimum){
                        // set the markup for a number of chars + '...'
                        this.initMarkup = jQuery('#' + this.id).text().substring(0,t2k.component.textViewer.TextViewerConstants.absMinStrLen) + '...';
                        // set absoluteMinimum flag = true
                        this.isAbsoluteMinimum = true;
                        // let the textViewer's presenter know that you'r on absoluteMinimum
                        this.dispatchEvent("onAbsMin", this);
                    }
                }
            }
        },
        /**
         * reduce
         * start reduction
         * @param val - reduction value (if null - set 1)
         */
        reduce:function (val) {
            this.dispatchEvent('cantReduce');
            this.dispatchEvent('onRendered');
        },

        setFirstKeyDownFunction : function(fnc){
            this.firstKeyDown = fnc;
        },

        /**
         * setKeyUpFunction
         * set new external function for textarea keyup
         *
         * @param newKeyUpFunction
         */
        setKeyUpFunction : function(newKeyUpFunction){
            var iframe = this.textAreaIframe,
                iframeDoc = this._iframeDoc;

            jQuery(this._bodyElement).attr("keyUpFunction", newKeyUpFunction);
        },


        _eliminateForcedBR : function(){
            console.log('**********************************************************************')
            console.log('_eliminateForcedBR : that there needs to be done ? ');
            console.log('**********************************************************************')
        },
        _rebuildTextViewer : function(){
            console.log('**********************************************************************')
            console.log('_rebuildTextViewer : that there needs to be done ? ');
            console.log('**********************************************************************')
        },

        _removeContent : function(){
            jQuery(this._bodyElement).html('');
        },

        /**
         * getContent -
         * @returns textarea content HTML markup string
         */
        getContent : function(){
//            var iframe = this.textAreaIframe;
//            var iframeDoc = this._iframeDoc;
            var bodyHTML = jQuery(this._bodyElement).html(),
                bodyDir  = jQuery(this._bodyElement).css("direction" ),
                bodyLineSpacing = jQuery(this._bodyElement).css("line-height" ),
                span = jQuery("<div/>")
                    .css({
                        "direction":    bodyDir,
                        "line-height":  bodyLineSpacing
                    })
                    .html(bodyHTML ),
                div  = jQuery("<div/>").append(span);

            return jQuery(div).html();
        },

        /**
         * replaceContent
         * @param htmlContent
         */
        replaceContent : function(htmlContent){
            jQuery('body', jQuery('#' + this.textAreaIframe.id)[0].contentDocument).html(htmlContent);

        },

        /**
         * getValue function
         * @returns texteditor text
         */
        getValue : function(){
            return jQuery('body', jQuery('#' + this.textAreaIframe.id)[0].contentDocument).text().trim();
        },

        /**
         * getMarkUpValue function
         * @returns texteditor html
         */
        getMarkUpValue : function(){
            return jQuery('body', jQuery('#' + this.textAreaIframe.id)[0].contentDocument).html();
        },

        /**
         * getNumChar -
         *
         * @returns textarea's number of chars; text length only (not html length)
         */
        getNumChar : function(){
//            var iframe = this.textAreaIframe;
//            var iframeDoc = this._iframeDoc;
            return jQuery(this._bodyElement).text().length;
        },

        setFirstKeyPressed : function(flag){
            this._firstKeyPressed = flag;
        },

        /**
         * enable -
         * enable or disable textarea
         *
         * @param enabled - boolean value
         */
        enable : function(enabled){

            this._enable = enabled;

//            var iframe = this.textAreaIframe;
//            var iframeDoc = this._iframeDoc;

            var attrArray = ["keydown", "mouseup", "mousedown", "click", "mouseenter", "mouseleave", "select", "focus"];

            // enabled or disabled accomplish by binding blur function to focus events
            if (enabled) {

                for (var i=0 ; i < attrArray.length ; i++){
                    jQuery(this._bodyElement).unbind(attrArray[i]);
                }

            } else {

                for (var i=0 ; i < attrArray.length ; i++){
                    ENV.behaviors.isIE || jQuery(this._bodyElement).bind(attrArray[i],function(){
                        this.blur();
                    });
                }

                // on disable mode, hide toolbar
                this._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide);
            }

	        this.onBodyClick(enabled);
        },

        // private variables

        /**
         * _textArea_toolbarControlsHash -
         * master hash for toolbar's controls.
         * the toolbar's preset that delivers to textArea will get this hash arguments according to preset's controls.
         */
        _textArea_toolbarControlsHash : {

            bold : {
                command : "bold",
                tags : [ "b", "strong" ],
                setActiveToolbar: true
            },

            italic : {
                command : "italic",
                tags : [ "i", "em" ],
                setActiveToolbar: true
            },

            underline : {
                command : "underline",
                tags : [ "u" ],
                setActiveToolbar: true
            },

            undo : {
                handler : "_undo",
                on2on   : true,
                startAsDisable : true
            },

            redo : {
                handler : "_redo",
                on2on   : true,
                startAsDisable : true
            },

            fontSize : {
                title : "fontSize",
                select : '<select>  <option value="default">-</option>  <option value="14">14</option>  <option value="16">16</option>  <option value="18">18</options> <option value="20">20</option>  <option value="22">22</options> <option value="24">24</option>  <option value="26">26</options></select>    ',
                tags : [ "font" ],
                initValueDisplay : "16",
                dropDown: true,
                handler: "_fontSize",
                dropDownElements : ["14","16","18","20","22","24","26"]
            },

            lists : {
                dropDown: true,
                handler: "_insertLists",
                tags : [ "ul", "ol" ],
                dropDownElements : ["squareList", "discList", "numberList"]
            },
            // lists dropdown
            squareList : {
                tag : "UL",
                icon : "square",
                execCmdStr : "insertUnorderedList"
            },
            // lists dropdown
            discList : {
                tag : "UL",
                icon : "disc",
                execCmdStr : "insertUnorderedList"
            },
            // lists dropdown
            numberList : {
                tag : "OL",
                icon : null,
                execCmdStr : "insertOrderedList"
            },

            aligns : {
                dropDown: true,
                handler: "_aligns",
                dropDownElements : ["justifyLeft", "justifyCenter", "justifyRight"]

            },
            // aligns dropdown
            justifyLeft :{
                tag : null,
                icon : null,
                execCmdStr : "justifyLeft"
            },
            // aligns dropdown
            justifyCenter :{
                tag : null,
                icon : null,
                execCmdStr : "justifyCenter"
            },
            // aligns dropdown
            justifyRight :{
                tag : null,
                icon : null,
                execCmdStr : "justifyRight"
            },

            indents : {
                dropDown: true,
                handler: "_indents",
                dropDownElements : ["indent", "outdent"]
            },
            // indents dropdown
            indent : {
                tag : null,
                icon : null,
                execCmdStr : "indent"
            },
            // indents dropdown
            outdent : {
                tag : null,
                icon : null,
                execCmdStr : "outdent"
            },

            dirs : {
                dropDown: true,
                handler: "_dirs",
                dropDownElements : ["dirRightToLeft", "dirLeftToRight"]
            },
            // dirs dropdown
            dirRightToLeft : {
                tag : "rtl",
                icon : null,
                execCmdStr : null
            },
            // dirs dropdown
            dirLeftToRight : {
                tag : "ltr",
                icon : null,
                execCmdStr : null
            },

            marker : {
                command : "backColor",
                tags : [ "font" ],
                setActiveToolbar: true,
                args : "yellow",
                tags : ["span"]
            },

            setColor : {
                dropDown: true,
                handler: "_setColor",
                /* Chrome needs this color to be different from #000, hence 000001. Do not change. */
                colorArray : ["#ffffff","#000001","#2F6028","#004E98","#7A4179","#9C4941","#AB1707","#504A1F","#9F5C1C"],
                colorColumns : "3",
                initValueDisplay : " "
            },

            mf : {
                handler: "_displayMF",
                on2on   : true
            }
        }, 

        // private functions:

        /**
         *
         */
        _getBrowserType : function(){
            var ret = 'OTHERS';
            var browser = navigator.userAgent;

            if (browser.indexOf('Safari') != -1){
                ret = 'SAFARI';
            }

            if (browser.indexOf('Chrome') != -1){
                ret = 'CHROME';
            }

            if (browser.indexOf('MSIE') != -1){
                ret = 'IE';
            }
            return ret;
        },

        /**
         * setUnselectable
         * if the browser is IE, set 'unselectable' on.
         * @param element
         */
        _setUnselectable : function(element){
            if (this._browser == 'IE'){
                jQuery(element).attr("unselectable","on");
            }
        },

        /**
         * _displayMF -
         * mockup (writes 'math field' on the ta. will handle after the mf dev.)
         */
        _displayMF : function(){

            var thi$ = this;

            var placeHolderId = genId();
            this._replaceSelectionWith('<div style="display: inline-block" id="' + placeHolderId + '" ></div>');

            var mfPlaceHolder = this._bodyElement.find('#' + placeHolderId);

            var mfData = jQuery('<mathField/>').attr({
                keyboardPreset:'fullMathField',
                type:'singleLine',
                editMode:'on',
                autoComma:'true',
                validate:'false',
                devMode:'false',
                maxHeight:'dynamic',
	            showMFEmptyIcon: true
            });

	        function onRenderedMF() {
		        !!thi$._iframeDoc.activeElement && thi$._iframeDoc.activeElement.blur();

		        if (ENV.behaviors.isIpad) {
		            document.activeElement.blur();
			        document.body.blur();
		        }
	        }

	        function onStartEditMF() {
		        if (ENV.behaviors.isTablet) {
			        !!thi$._iframeDoc.activeElement && thi$._iframeDoc.activeElement.blur();
			        thi$._bodyElement.blur();
			        if(ENV.behaviors.isIpad) {
				        jQuery('body').trigger('touchstart');
			        }
		        }

		        thi$._iframeDoc.designMode = 'off';
		        thi$.mfInEditMode = true;
		        thi$._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide);
	        }

	        function onEndEditMF() {
	            thi$._iframeDoc.designMode = 'on';

		        thi$.mfInEditMode = false;
		        thi$._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.show);
	        }

            this.mathField = [];
	        this.mathField[0] = new t2k.component.mathField.MathField({
		        parent : mfPlaceHolder,
		        data   : mfData,
		        container : this._bodyElement,
		        targetDocument : this._iframeDoc,
		        onRendered : onRenderedMF,
		        onStartEdit : onStartEditMF,
		        onEndEdit : onEndEditMF //TODO : open toolbar
	        });

            this.mathField[0].setEnabled(true);
        },

        /**
         * _beep
         * play the beep
         */
        _beep : function(){
            SOUND.beep();
        },

        /**
         * _setAndCheckTextareaSizes -
         * checks the width & height params for right capacity, only for 'paragraph' or 'fullText' modes.
         * check min width = 296px and output 'console.log' for exceptions
         * set max width = 714px
         * output 'console.log' msg for error
         * (params use by constant)
         */
        _setAndCheckTextareaSizes : function(){

            var obj_outerDiv = jQuery('#' + this.id + 'outerDiv'),
                textareaWidth = obj_outerDiv.outerWidth(),
                textareaHeight = obj_outerDiv.outerHeight();

            //set actual textarea width in px
            if(this.width == '100%'){
                this.width = textareaWidth;
                obj_outerDiv.width(this.width);
            }

            //set actual textarea height in px
            if(this.height == '100%'){
                this.height = textareaHeight;
            }   obj_outerDiv.height(this.height);

            // max & min width issue
            if (this._mode == 'sentence' || this._mode == 'paragraph' || this._mode == 'fullText'){
                // set max width case the width is greater then the max width
                if (textareaWidth > t2k.component.textarea.TextEditorViewConstants.maxTextAreaWidth){
                    this.width = t2k.component.textarea.TextEditorViewConstants.maxTextAreaWidth + 'px';
                    obj_outerDiv.width(this.width);
                }

                if (textareaWidth < t2k.component.textarea.TextEditorViewConstants.minTextAreaWidth){
                    // TODO: compile error
                    // console.log("ERROR - TextArea Width is under " + t2k.component.textarea.TextEditorViewConstants.minTextAreaWidth + "px, on id [" + this.id + "]");
                }
            }

            if (this._mode == 'paragraph' || this._mode == 'fullText'){

                var displayMaxChar  = this._displayMaxChar,
                    letterWidth     = Math.floor(this.style.size * t2k.component.textarea.TextEditorViewConstants.widthRefrence),
                    letterHeight    = Math.floor(t2k.component.textarea.TextEditorViewConstants.fontAspectRatio * letterWidth),
                    currLettersInOneLine = Math.floor(textareaWidth / letterWidth),
                    linesRequire    = Math.ceil(displayMaxChar / currLettersInOneLine),
                    heightRequire   = (linesRequire * letterHeight) + t2k.component.textarea.TextEditorViewConstants.widthHeightExpansion;

                this.height = heightRequire + 'px';
                obj_outerDiv.height(this.height);

                jQuery(this.textAreaIframe).height('100%');

                // if height is greater then the required height, set heightRequire as the textarea height. else - output console.log(or compile error)
                /*if (textareaHeight > heightRequire){
                 this.height = heightRequire + 'px';
                 } else {
                 // TODO: compile error
                 // console.log("ERROR - TextArea Height is too short, on id [" + this.id + "]");
                 }*/
            }

             // set width & height to body element to support Ipad ( otherwise text ovelaps body area out of the iframe)
            var bodyPaddingAdditionY = parseInt(this._bodyElement.css('padding-bottom')) + 
                                                parseInt(this._bodyElement.css('padding-top'));

            var bodyPaddingAdditionX = parseInt(this._bodyElement.css('padding-left')) + 
                                                parseInt(this._bodyElement.css('padding-right'));

            this._bodyElement.width(obj_outerDiv.width()- bodyPaddingAdditionX);
            this._bodyElement.height(obj_outerDiv.height()- bodyPaddingAdditionY);
        },
        /**
         * _getStyleClass -
         * find css class rules based on css class name
         * @param document, className - current textEditor class name
         */
        _getStyleClass : function (document, className) {

            var styleSheet = null,
                rule = null,
                rules;

            jQuery.each(document.context.styleSheets, function(i, styleObj){
                if(styleObj.href && styleObj.href.match(/textEditor.css$/)){
                    styleSheet =  styleObj;
                }
            });

            // Check if browser uses [rules] - cssStyleRule object
            if (styleSheet && styleSheet.rules){
                rules = styleSheet.rules;
            }

            // Check if browser uses [cssRules]
            if (styleSheet && styleSheet.cssRules){
                rules = styleSheet.cssRules;
            }

            // Check if browser supports css rules
            if (rules){
                // Loop rules in css stylesheet
                jQuery.each(rules, function(i, ruleObj){
                    if(ruleObj.selectorText == className){
                        rule = ruleObj;
                    }
                });
            }

            return rule;
        },
        /**
         * _setModeParams
         * set the mode params by mode
         */
        _setModeParams : function(){

            var currMode = t2k.component.textarea.TextEditorViewModes[this._mode];

            this._displayMaxChar = currMode.displayMaxChar;
            if (this._displayMaxChar == null || this._displayMaxChar == 'undefined'){
                this._displayMaxChar = '';
            }

            if (this.maxChar){
                this._displayMaxChar = this.maxChar;
            }

            // set maxChar 'word' mode
            if (this._mode == "word"){
                if(parseInt(this.maxChar) > parseInt(currMode.maxDisplayMaxChar)) {
                    this._displayMaxChar = currMode.maxDisplayMaxChar;
                } else {
                    if(parseInt(this.maxChar) < parseInt(currMode.minDisplayMaxChar)) {
                        this._displayMaxChar = currMode.minDisplayMaxChar;
                    }
                }
            }


            /**
             * TODO: there are potentially many more bugs here related to automatic type casting.
             * In JavaScript, (false == '') is true, so please use === operator.  -- Mark V.
             */
            if (typeof this._enableCharLimit != 'boolean') {
                // this._enableCharLimit = currMode.charLimit;
                this._enableCharLimit = parseInt(this._displayMaxChar) > 0 ? true : currMode.charLimit;
            }

            this.maxChar = this._enableCharLimit? parseInt(this._displayMaxChar): 5000;


            if ((this._enableScrollbar != true && this._enableScrollbar != false)
                || (this._enableScrollbar == '' && this._enableScrollbar != true && this._enableScrollbar != false) ){

                this._enableScrollbar = currMode.scrollBar;
            }

            if ((this._enableKeyscroll != true && this._enableKeyscroll != false) || this._enableKeyscroll ==''){
                this._enableKeyscroll = currMode.keyScroll;
            }

            this._enableEnter = currMode.enableEnter;

            // set _enableToolbar
            if (this._enableToolbar == 'false' || this._enableToolbar == 'true'){
                this._enableToolbar = eval(this._enableToolbar);
            } else {
                this._enableToolbar = currMode.displayToolbar;
            }

            // set currStyle by constructor
            var currStyle = this.setClass;

            // if the constructor doesn't provide any style, use the default style
            if (currStyle == null || currStyle == ''){
                currStyle = t2k.component.textarea.TextEditorViewConstants.defaultCssClass;
            }

            var cssRule = this._getStyleClass(jQuery('document'), '.ta .' +currStyle);
            if(cssRule){
                this._ruleToStyle(cssRule);
            }


            // if currMode.width is "fixByStyle", set width by 'displayMaxChar'
            // on 'word' mode, set with with 'widthRefrence' to reducr 'word' width
            if (currMode.width){
                if (this._mode == "word"){
                    this.width = (this.style.size * t2k.component.textarea.TextEditorViewConstants.widthRefrence * this._displayMaxChar) + "px";
                } else {
                    this.width = (this.style.size * currMode.displayMaxChar) + t2k.component.textarea.TextEditorViewConstants.widthHeightExpansion + "px";
                }
            }

            if (currMode.height){
                this.height = (Math.floor(t2k.component.textarea.TextEditorViewConstants.fontAspectRatio * this.style.size)) + t2k.component.textarea.TextEditorViewConstants.widthHeightExpansion + "px";
            }

// set maxChar = 350 for sentence to avoid forced enter
if (this._mode == "sentence" && this._enableCharLimit !== true){
    this.maxChar = 350;
}

            // set maxChar = 1 for 'letter' mode
            if (this._mode == "letter"){
                this.maxChar = 1;
            }

            // 'letter' mode exception - init text should be one letter or less
            if (this._enableCharLimit == true){
                var initTextTempDiv = jQuery("<div></div>").html(this.initText ),
                    initTextStr = jQuery(initTextTempDiv).text() ;

                if (initTextStr.length > this.maxChar){
                    this.initText = initTextStr.substring(0, this.maxChar);
                }
            }

            // set default for toolBarPreset
	        if (ENV.behaviors.isTablet) {
		        this.toolBarPreset = 'onlyMath';
	        } else if (this.toolBarPreset == '' || this.toolBarPreset == null || this.toolBarPreset == 'undefined') {
		        this.toolBarPreset = 'student';
	        }

	        if(this.width.px2int() > this.maxWidth) { //TE width is larger then container width
		        this.maxWidth = this.width.px2int();
	        }

        },
        /**
         * _ruleToStyle -
         * get the cssRule object and set this.style according to it
         *
         * @param body - cssRule element
         */
        _ruleToStyle : function(cssRule)
        {
            this.style =  {
                bold        : cssRule.style.fontWeight == 'bold',
                italic      : cssRule.style.fontStyle == 'italic',
                underline   : cssRule.style.textDecoration == 'underline',

                font        : cssRule.style.fontFamily || $(document).find("html").css('font-family'),
                size        : (typeof this.setFontSize != 'undefined') ? this.setFontSize : cssRule.style.fontSize
            };

            if(this.style.size != '' && this.style.size != null)
                this.style.size = parseInt(this.style.size);  //remove px
            else
                this.style.size = this.optimumFontSize || 22;

            if(this.fontColor){
                this.style.color = this.fontColor;
            }

            if(this.style.font == null){
                this.style.font = '';
            }
        },

        /**
         * _setInitStyle -
         * get the textArea style, implenet style's arguments by execCommand(execCmd()), and set selected controls
         *
         * @param status - on init, _setInitStyle gets status = "onInitTA", for style implementation of initText markup
         */
        _setInitStyle : function(status){
            // get textArea style
            var style = this.setClass;

            if (style){

                var iframe = this.textAreaIframe;
                var iframeDoc = this._iframeDoc;
                var body = jQuery(iframeDoc).contents().find("body").get(0);

                var bodyHTML = jQuery(body).html().replace(/^\s+|\s+$/, '');
                var currElement = this._getSelectedElement();

                // checks if the textArea has content if full TA
                if (bodyHTML != '' && bodyHTML != '<br>' && bodyHTML != '<P>&nbsp;</P>'){

                    // if there is no content, and init apply
                    if (status == "onInitTA"){
                        this._setInitStyleOnInitTaForInitText();
                    }

                } else {    // if empty

                    // set default color selection
                    jQuery("#" + this.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color","#000000");

                    // TextAreaStylesAttr is a convertor object that converts a style argument to execCommand argument
                    var stylesExecCmdStr = t2k.component.textarea.TextEditorViewStylesAttr;

                    // loop the textArea style
                    for (var styleItem in this.style){

                        // if the selected styleItem is false, do nothing
                        if (!this.style[styleItem] || typeof this.style[styleItem] == 'undefined'){
                            continue;
                        }

                        // execute the styleItem
                        this._execCmd(stylesExecCmdStr[styleItem], this.style[styleItem], true);

                        // set the relevant control at selected mode
                        jQuery("#" + this.id + "ToolBar").find("." + styleItem).attr("class", styleItem + "-selected").attr("active","yes");

                        // toolbar's display - correct size selection
                        if (styleItem == "size") {
                            jQuery("#" + this.id + "ToolBar").find(".fontSizeDisplay").html(this.style[styleItem]);
                        }

                        // toolbar's display - correct color selection
                        if (styleItem == "color"){
                            jQuery("#" + this.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color",this.style[styleItem]);
                        }
                    }

                }
            }
        },

        /**
         * _setInitStyleOnInitTaForInitText -
         * calls only once, at init.
         * textArea style implementation for initText.
         * write the relevant markup and 'psate' it to the textArea's body
         */
        _setInitStyleOnInitTaForInitText : function(){
            // get textArea style
            var style = this.setClass;

            // get style object, and style to eceCommand convertor object
            var stylesExecCmdStr = t2k.component.textarea.TextEditorViewStylesAttr;
            var startMarkup, endMarkup;

            if (style){

                // set default color selection
                jQuery("#" + this.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color","#000000");

                // check for font tag requirement

                if (this.style.font || this.style.size || this.style.color){

                    // write font tag full markup
                    startMarkup = "<font class='font-t2k' ";
                    endMarkup   = "</font>";

                    if (this.style.font){
                        startMarkup += "face=" + this.style.font + " ";
                        this._bodyElement.css('font-family', this.style.font);
                    }

                    if (this.style.size){
                        startMarkup += "style='font-size:" + this.style.size + "px' ";
                        this._bodyElement.css('font-size', this.style.size + "px'");
                    }

                    if (this.style.color){
                        startMarkup += "color='" + this.style.color + "' ";
                        this._bodyElement.css('color', this.style.color);
                    }

                    startMarkup += ">";
                }

                // check for b / i / u  tags requirement
                if (this.style.bold){
                    startMarkup += "<b class='b-t2k'>";
                    endMarkup = "</b>" + endMarkup;
                }

                if (this.style.italic){
                    startMarkup += "<i class='i-t2k'>";
                    endMarkup = "</i>" + endMarkup;
                }

                if (this.style.underline){
                    startMarkup += "<u class='u-t2k'>";
                    endMarkup = "</u>" + endMarkup;
                }

                // place the markup
//                var iframe = this.textAreaIframe;
                var iframeDoc = this._iframeDoc,
                    body = jQuery(iframeDoc).contents().find("body").get(0 ),
                    bodyHTML = jQuery(body).html(),
                    newBodyHtml = startMarkup + bodyHTML + endMarkup;

                jQuery(body).html(newBodyHtml);
            }
        },

        // Recover style for the body element
        setBodyStyle : function(){
            var tmpObjStyle = {};

            if (this.style.font){
                tmpObjStyle['font-family'] = this.style.font;
            }
            if (this.style.size){
                tmpObjStyle['font-size'] = this.style.size + 'px';
            }
            if (this.style.color){
                tmpObjStyle['color'] = this.style.color;
            }

            if (this._enableKeyscroll){
                tmpObjStyle = jQuery.extend(tmpObjStyle, {
                    'white-space':'nowrap',
                    'width':this.width -8,
                    'unicode-bidi':'embed',
                    'padding-right':'2px',
                    'padding-left':'2px'
                });
            }

            jQuery(this._bodyElement).css(tmpObjStyle);

        },

        /**
         * _createTextAreaIframe -
         * creates textarea iframe
         *
         * @returns iframe element
         */
        _createTextAreaIframe : function(){

            var iframe = document.createElement('iframe');

            jQuery(iframe)
                .attr({
                    'id' : this.id + 'Iframe',
                    'frameborder' : '0'
                })
                .css({
                    'width' : this.width,
                    'max-width' : this.maxWidth
                });

            // fix for cross-domain policy in IE
            /*iframe.src = location.href.replace('index.html', 'dummy.html#' + document.domain);*/
            //$(iframe).html("<script>window.document.domain = '" + window.location.host + "'</script>");

            return iframe;
        },

        /**
         * _setTextAreaDesignMode -
         * sets the textarea iframe for designMode on
         */
        _setTextAreaDesignMode : function(){

            var iframe = this.textAreaIframe;
            try {
                var iframeDoc = iframe.contentWindow.document;
            }
            catch (xxx) {
                var iframeDoc = iframe.document;
            }

            // set iframeDoc as a member
            this._iframeDoc = iframeDoc;

            try {
                iframeDoc.designMode = 'on';
            } catch (error) {
                jQuery(iframeDoc).focus(function(){
                    iframeDoc.designMode();
                });
            }


        },

        /**
         * _setTextAreaToolBar -
         * gets the toolbar hash and set the textarea toolbar as:
         * <div toolbar> <ul> <li control 1> <div control 1></div> </li> <li control 2> <div control 1></div> </li> ... </ul> </div>
         *
         * @param textAreaControls
         * @returns div element - toolbar
         */
        _setTextAreaToolBar : function (textAreaControls) {

            //set ref for the object (events has their own 'this')
            var textArea = this,
                controlDivElement,
                controlHTML,
            // build toolbar container as div element
                toolBarDiv = jQuery("<div id='" + textArea.id + "ToolBar'></div>");

            // prevents selected area inside the toolbar
            jQuery(toolBarDiv).dblclick(function(e){
                e.preventDefault();
            });

            // set toolbar element as a member
            this._toolbarElement = toolBarDiv;

            // exit if do not need toolbar
            if(!this._enableScrollbar){
                return toolBarDiv;
            }

            // set toolbar class for themable css
            jQuery(toolBarDiv).addClass(t2k.component.textarea.TextEditorViewConstants.toolbarClass);

            // append ul tag to toolbar
            jQuery(toolBarDiv).append(jQuery("<ul></ul>"));

            toolBarDiv.width(0);

            // loop the toolbar's hash and build the controls
            for (var controlName in textAreaControls) {
                
                toolBarDiv.width(toolBarDiv.width() + 42);
                // get tooltip from LanguageUtil object
                var tooltip = LanguageUtil.getString("textarea.tooltips." + controlName);

                // *************** build and configure the control as a div element ******************** //

                // set tooltip as a title, "rel" attr (controlName)
                controlDivElement = jQuery("<div></div>").attr("title",tooltip).attr("rel", controlName);
                textArea._setUnselectable(controlDivElement);

                /**
                 * controlDivElement - mouseUp
                 * set the control's mouseUp appropriate behavior
                 */
                jQuery(controlDivElement).mouseup(function(i){

                    // the control may set as disable on runtime. in that case, do nothing
                    if (jQuery(this).attr("enable") != "no"){

                        // thisRel is the control's name
                        var thisRel = jQuery(this).attr("rel");

                        if (textAreaControls[thisRel].setActiveToolbar){
                            var activeAttr = jQuery(this).attr("active");
                            // toggle activeAttr (sample: if bold fired, it's active mode as well as it's display should toggle)
                            if (activeAttr == "yes"){
                                activeAttr = "no";
                                jQuery(this).attr("class",thisRel);
                            } else {
                                activeAttr = "yes";
                                jQuery(this).attr("class",thisRel+"-selected");
                            }
                            jQuery(this).attr("active", activeAttr);
                        }

                        // on2on situation happens at controls like undo/redo. when enable it's always on (not selected)
                        if (textAreaControls[thisRel].on2on){
                            jQuery(this).attr("class",thisRel);
                        }

                        // and now handle the click for textArea manipulations
                        textArea._toolbarClick(this, textAreaControls[thisRel]);
                    }
                });

                /**
                 * controlDivElement - mouseDown
                 * set the control's mouseDown behavior (usually "press" class only)
                 */
                jQuery(controlDivElement).mousedown(function(){

                    // mouseDown will remove the Panel (dropDown)
                    textArea._removePanel();

                    if (jQuery(this).attr("enable") != "no"){
                        var thisRel = jQuery(this).attr("rel");
                        jQuery(this).attr("class", thisRel+"-press");
                    }
                });

                /**
                 * controlDivElement - mouseOver
                 * set the control's mouseOver behavior (usually "-over" class only)
                 */
                jQuery(controlDivElement).mouseover(function(){

                    var thisPressClass = jQuery(this).attr("rel") + "-press";

                    if ((jQuery(this).attr("class") != thisPressClass) && (jQuery(this).attr("enable") != "no")){
                        var controlElementClass = jQuery(this).attr("class");
                        jQuery(this).attr("class", controlElementClass+"-over");
                    }
                });

                /**
                 * controlDivElement - mouseOver
                 * set the control's mouseOver behavior
                 * (deletes the "-over" from class name; rel-over to rel; rel-selected-over to rel-selected)
                 */
                jQuery(controlDivElement).mouseout(function(){
                    if (jQuery(this).attr("enable") != "no"){
                        var controlElementClass = jQuery(this).attr("class");
                        jQuery(this).attr("class", controlElementClass.replace("-over",""));
                    }
                });

                /**
                 * controlDivElement - double click
                 * cancel toolbar selection on double click
                 */
                jQuery(controlDivElement).dblclick(function(e){
                    this.onselectstart = function(){
                        return false;
                    };
                });

                // build the control

                // if control should start at disabe mode
                if (textAreaControls[controlName].startAsDisable){
                    controlHTML = jQuery("<li></li>").append(controlDivElement.addClass(controlName + "-disable"));
                    jQuery(controlDivElement).attr("enable","no");

                } else {
                    controlHTML = jQuery("<li></li>").append(controlDivElement.addClass(controlName));
                }

                // set toolbar button init value where needed (fontSize and fontColor mostly)
                try {
                    if (textAreaControls[controlName].initValueDisplay){
                        var cell = jQuery("<td></td>").html(textAreaControls[controlName].initValueDisplay);
                        textArea._setUnselectable(cell);
                        var line  = jQuery("<tr></tr>").append(cell);
                        var table = jQuery("<table></table>").attr("class", controlName + "Display").append(line);
                        textArea._setUnselectable(table);
                        jQuery(controlDivElement).append(table);
                    }
                } catch(e) {
                    // do nothing (means that the control has no initValueDisplay)
                }

                // append the control (div) to the ul element
                jQuery("ul", toolBarDiv).append(controlHTML);
            }

            /**
             * toolBarDiv - mouseEnter
             * set max toolbar opacity
             */
            toolBarDiv.mouseenter(function(){
                textArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.show);
            });

            /**
             * toolBarDiv - mouseLeave
             * set low toolbar opacity
             */
            toolBarDiv.mouseleave(function(){
                textArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.fade);
            });

            return toolBarDiv.get(0);
        },

        /**
         * _buildTextAreaOuterDiv -
         * create textarea outer div, append it the toolbar and iframe and appent the div to the parent
         */
        _buildTextAreaOuterDiv : function(){
            // create textarea outer div
            var outerDiv = document.createElement('div');
            jQuery(outerDiv)
                .attr({
                    'id': this.id + 'outerDiv',
                    'class': 'ta '+t2k.component.textarea.TextEditorViewConstants.themableClass +' '
                                  +t2k.component.textarea.TextEditorViewConstants.themableClass_ta
                })
                .css({
                    "position":"relative",
                    'max-width':this.maxWidth+'px',
                    'height': (parseInt(this.height) + 1)+'px'
                });

            if (this._mode == "sentence"  || this._mode == "paragraph" || this._mode == "fullText"){
                $(outerDiv).css('width', this.maxWidth);
            }



            // set toolbar zone position absolute
            jQuery(this.textAreaTollBarZone).css("position", "absolute");

            // append it to the outerDiv
            jQuery(outerDiv).append(jQuery(this.textAreaTollBarZone));
            jQuery(outerDiv).append(jQuery(this.textAreaIframe));

            // append div to parent
            jQuery("#" + this.parentId).append(outerDiv);
            jQuery("#" + this.id + "Iframe").height(this.height);
        },

        /**
         * _buildTollbarTriangle -
         * build the toolbar triangle as two divs (one on the other)
         * the first div is for the outline, and the second is for the inner color of the triangle.
         * the triangle appends to the outerDiv.
         */
        _buildTollbarTriangle : function(){
            var outerDiv = jQuery("#" + this.id + "outerDiv");
            var outerDivWidth = outerDiv.outerWidth();

            // constant values that position the triangle on the left / right side of outerDiv
            var constantTop = t2k.component.textarea.TextEditorViewConstants.constantTriangleTop;
            var constantSpaceTriangle = t2k.component.textarea.TextEditorViewConstants.constantTriangleSpace;
            var constantSpaceTriangleBG = t2k.component.textarea.TextEditorViewConstants.constantTriangleBGSpace;

            // set the divs and append them
            var taTriangleDivShadow = Perf.create("div").addClass("arrow-down-shadow").css("position", "absolute").hide();
            var taTriangleDivBG     = Perf.create("div").addClass("arrow-down-BG").css("position", "absolute").hide();
            var taTriangleDiv       = Perf.create("div").addClass("arrow-down").css("position", "absolute").hide();

            outerDiv.append(taTriangleDivShadow).append(taTriangleDivBG).append(taTriangleDiv);

            // constant's calibration according to textArea direction
            if (this.direction == "ltr"){
                constantSpaceTriangle = "-" + constantSpaceTriangle;
                constantSpaceTriangleBG = "-" + constantSpaceTriangleBG;
            } else {
                constantSpaceTriangle = outerDivWidth - constantSpaceTriangle;
                constantSpaceTriangleBG = outerDivWidth - constantSpaceTriangleBG;
            }

            // spacer's execution :)
            jQuery(taTriangleDivShadow).css("top", constantTop + "px").css("left", constantSpaceTriangleBG + "px");
            jQuery(taTriangleDivBG).css("top", constantTop + "px").css("left", constantSpaceTriangleBG + "px");
            jQuery(taTriangleDiv).css("top",constantTop + "px").css("left",constantSpaceTriangle + "px");

            jQuery(taTriangleDivShadow).show();
            jQuery(taTriangleDivBG).show();
            jQuery(taTriangleDiv).show();
        },

        /**
         * _setToolbarPotision -
         * set the toolbar position according to textArea direction and screen position
         */
        _setToolbarPotision : function(){

            if (!this._enable) {return;}

            var outerDiv = jQuery("#" + this.id + "outerDiv"),
                outerDivWidth = outerDiv.outerWidth();

            var toolbar = jQuery(this._toolbarElement),
                toolbarWidth = toolbar.width();

            // if the toolbar is shorter than outerDiv, set toolbar position by direction
            if ((outerDivWidth + (t2k.component.textarea.TextEditorViewConstants.spacer * 2)) > toolbarWidth){
                this._setToolbarPosition_byDirection();
                return;
            }

            // if toolbar will overflow on right, set toolbar position right align with screen
            if (this._toolbarOverFlowOnRight()){
                this._setToolbarPosition_rightAlign();
                return;
            }

            // if toolbar will overflow on left, set toolbar position left align with screen
            if (this._toolbarOverFlowOnLeft()){
                this._setToolbarPosition_leftAlign();
                return;
            }

            // if all the above if false, set the toolbar position align center with outerDiv
            this._setToolbarPosition_centerAlign();
        },

        /**
         * _setToolbarPosition_byDirection -
         * set toolbar align with outerDiv according to textArea direction
         */
        _setToolbarPosition_byDirection : function(){
            if (this.direction == "ltr"){
                this._setToolbarPosition_leftAlign_toTextArea();
            } else {
                this._setToolbarPosition_rightAlign_toTextArea();
            }

        },

        /**
         * _toolbarOverFlowOnRight
         * checks if the toolbar will overflow on the right side of the screen
         *
         * @returns {Boolean}  true for overflow
         */
        _toolbarOverFlowOnRight : function(){
            var ret = true;
            var outerDiv = jQuery("#" + this.id + "outerDiv");
            var outerDivWidth = outerDiv.outerWidth();
            var outerDivLeft = outerDiv.offset().left;

            var toolbar = jQuery(this._toolbarElement);
            var toolbarWidth = toolbar.width();

            var task = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass);
            var taskWidth = task.width();
            var taskLeft = task.offset().left;
            var expectedTaskRight = taskLeft + taskWidth;

            var toolbarSideOverflow = (toolbarWidth - outerDivWidth) / 2;

            var expectedToolbarRight = outerDivLeft + outerDivWidth + toolbarSideOverflow;

            if (expectedToolbarRight < expectedTaskRight){
                ret = false;
            }

            return ret;
        },

        /**
         * _toolbarOverFlowOnLeft
         * checks if the toolbar will overflow on the left side of the screen
         *
         * @returns {Boolean}  true for overflow
         */
        _toolbarOverFlowOnLeft : function(){
            var ret = true;
            var outerDiv = jQuery("#" + this.id + "outerDiv");
            var outerDivWidth = outerDiv.outerWidth();
            var outerDivLeft = outerDiv.offset().left;

            var toolbar = jQuery(this._toolbarElement);
            var toolbarWidth = toolbar.width();

            var task = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass);
            var taskWidth = task.width();
            var taskLeft = task.offset().left;
            var expectedTaskRight = taskLeft + taskWidth;

            var toolbarSideOverflow = (toolbarWidth - outerDivWidth) / 2;

            var expectedToolbarLeft = outerDivLeft - toolbarSideOverflow;

            if (expectedToolbarLeft > taskLeft){
                ret = false;
            }
            return ret;
        },

        /**
         * _setToolbarPosition_leftAlign -
         * set toolbar align left with screen
         */
        _setToolbarPosition_leftAlign : function(){
            var toolbar = jQuery(this._toolbarElement);
            var task = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass);
            var taskLeft = task.offset().left;
            
            toolbar.offset({left:taskLeft});
        },

        /**
         * _setToolbarPosition_rightAlign -
         * set toolbar align right with screen
         */
        _setToolbarPosition_rightAlign : function(){

            var toolbar = jQuery(this._toolbarElement);
            var toolbarWidth = toolbar.width();
            var taskWidth = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass).width();
            var setToolbarLeft = taskWidth - toolbarWidth;
            
            toolbar.offset({left:setToolbarLeft});
        },

        /**
         * _setToolbarPosition_centerAlign -
         * set the toolbar align center with outerDiv
         */
        _setToolbarPosition_centerAlign : function(){

            var outerDiv = jQuery("#" + this.id + "outerDiv");
            var outerDivWidth = outerDiv.outerWidth();
            var outerDivLeft = outerDiv.offset().left ;
            var toolbar = jQuery(this._toolbarElement);
            var toolbarWidth = toolbar.width();
            var taskWidth = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass).width();
            var toolbarSideOverflow = (toolbarWidth - outerDivWidth) / 2;
            var expectedToolbarLeft = outerDivLeft - toolbarSideOverflow;

            toolbar.offset({left:expectedToolbarLeft});
        },

        /**
         * _setToolbarPosition_leftAlign_toTextArea -
         * set the toolbar align left with outerDiv
         */
        _setToolbarPosition_leftAlign_toTextArea : function(){

            var outerDiv = jQuery("#" + this.id + "outerDiv");
            var outerDivLeft = outerDiv.offset().left;

            var toolbar = jQuery(this._toolbarElement);

            // t2k.component.textarea.TextEditorViewConstants.spacer = the gui space between the outerDiv and the toolbar
            var expectedToolbarLeft = outerDivLeft - t2k.component.textarea.TextEditorViewConstants.spacer;

            if (expectedToolbarLeft < 0){
                expectedToolbarLeft = 0;
            }

            toolbar.offset({left:expectedToolbarLeft});
        },

        /**
         * _setToolbarPosition_rightAlign_toTextArea -
         * set the toolbar align right with outerDiv
         */
        _setToolbarPosition_rightAlign_toTextArea : function(){

            var outerDiv = jQuery("#" + this.id + "outerDiv");
            var outerDivWidth = outerDiv.outerWidth();
            var outerDivLeft = outerDiv.offset().left;

            var toolbar = jQuery(this.textAreaTollBarZone);
            var toolbarWidth = toolbar.width();

            var taskWidth = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass).width();
            var taskLeft = jQuery(t2k.component.textarea.TextEditorViewConstants.tasksHolderClass).offset().left;
            var taskRight = taskWidth + taskLeft;

            var expectedToolbarLeft = (outerDivLeft + outerDivWidth + t2k.component.textarea.TextEditorViewConstants.spacer) - toolbarWidth ;

            var expectedToolbarRight = expectedToolbarLeft + toolbarWidth ;

            if (expectedToolbarRight > taskRight){
                this._setToolbarPosition_rightAlign();
            } else {
                toolbar.offset({left: expectedToolbarLeft});
            }
        },

        /**
         * _setToolbarOpacity -
         * set toolbar opacity (hide, fade, show), for one toolbar appearence at sequence.
         * on "hide" there will no fadeTo
         *
         * @param value (hide, fade, show)
         */
        _setToolbarOpacity : function(value){

            this._toolbarOpacityMode = value;
            var toolbar = jQuery("#" + this.id + "ToolBar");
            var triangle = jQuery("#" + this.id + "outerDiv").find(".arrow-down");
            var triangleBG = jQuery("#" + this.id + "outerDiv").find(".arrow-down-BG");
            var triangleShadow = jQuery("#" + this.id + "outerDiv").find(".arrow-down-shadow");

            if (value == "hide"){
                toolbar.hide();
                triangle.hide();
                triangleBG.hide();
                triangleShadow.hide();
            } else {
                // handles the this._enableToolbar issue
                if (this._enable && this._enableToolbar) {

                    // t2k.component.textarea.TextEditorViewOpacity.opacityDuration = TextAreaOpacity object from TextAreaConfig.js
                    toolbar.fadeTo(t2k.component.textarea.TextEditorViewOpacity.opacityDuration, value);
                    triangle.fadeTo(t2k.component.textarea.TextEditorViewOpacity.opacityDuration, value);
                    triangleBG.fadeTo(t2k.component.textarea.TextEditorViewOpacity.opacityDuration, value);
                    triangleShadow.fadeTo(t2k.component.textarea.TextEditorViewOpacity.opacityDuration, value);
                }
            }
        },

        /**
         * _innocentKeyDown -
         * check if 'innocent key' down (pressed)
         * innocent key is a key that doesn't increase the ta char's sum
         * the range beween 32-41 (33,34,35,36,37,38,39,40) is the arrows, home, end, pgUp, pgDn.
         * 46 & 46 are insert and delete
         * 8 is backspace
         *
         * @param keyCode
         *
         * @returns true or false (is innocent down - returns true)
         */
        _innocentKeyDown : function(keyCode){

            var ret = false;

            if ((keyCode > 32 && keyCode < 41) || keyCode == 45 || keyCode == 46 || keyCode == 8){
                ret = true;
            }

            return ret;
        },

        /**
         * _initTextArea -
         * set initText, direction, keyUp handle, maxChar handle exc..
         */
        _initTextArea : function() {

            var iframe          = this.textAreaIframe,
                iframeDoc       = this._iframeDoc,
                maxChar         = this.maxChar,
                TextArea        = this,
                isMaxChar       = false,
                setInitStyle    = false,
                tempTextAreaHtml;
            var langFilePath = LocaleUtil.getStyleFilePath() ;

            iframe._ta_obj = this;  // save ref to self

            // set initHTML that will inject to textArea iframe
            var initHTML = "<!DOCTYPE html><html style='overflow: hidden;'><head><link type=text/css rel=stylesheet href=css/style.css />" +
                "<link type=text/css rel=stylesheet href=" + t2k.component.textarea.TextEditorViewConstants.fontsCss + " />" +
                "<link type=text/css rel=stylesheet href=" + t2k.component.textarea.TextEditorViewConstants.textEditorCssClass + " />" +
                "<link type=text/css rel=stylesheet href=" + t2k.component.textarea.TextEditorViewConstants.mathFieldCssClass + " />" +
                "<link rel='stylesheet' type='text/css' href="+ langFilePath +" />" +
                "</head>" +
                "<body id='body_texteditor' spellcheck='false' class='texteditor " + this.setClass + "' style='direction: " + this.direction + ";' keyUpFunction='" + this.keyUpFunction + "'>" +
                this.initText + "</body></html>";

            // inject html to the iframe
            iframeDoc.open();
            iframeDoc.write(initHTML);
            iframeDoc.close();
            
            var thi$ = this,
                bodyElement_inlineStyle = {"overflow-x":"hidden"};// set overflow-x for all browsers

            // set body as a member
            this._bodyElement = jQuery('body', jQuery('#' + this.textAreaIframe.id)[0].contentDocument);

            if (this._browser == 'IE'){
                bodyElement_inlineStyle["display"] = "inline-block";
            }

            // set body CSS according to the current style
            if (this.style){

                if (this.style.font){
                    jQuery(this._bodyElement).css("p","font-family:" + this.style.font);
                    merge(bodyElement_inlineStyle, {
                        'font-family':this.style.font,
                        'font':this.style.font
                    });
                } else {
                    bodyElement_inlineStyle["font-family"] = this.style.font;
                }
                if (this.style.size){
                    bodyElement_inlineStyle["font-size"] = this.style.size + 'px';
                }
                if (this.style.color){
                    bodyElement_inlineStyle["color"] = this.style.color;
                }
            }

            /**
             * iframeDoc - mouseDown
             * remove panel (dropdown)
             * and blur all others text Editors
             */
            function mouseDownIframeDoc(e){
	            if(!!TextArea.mfInEditMode) {
		            return;
	            }

	            var $target = jQuery(e.target);

	            if(TextArea.mathField && $target.parents('.mathField').length) { //mouse down on math field prevent default behavior
		            e.preventDefault();
		            return false;
	            }

	            // remove panel
	            TextArea._removePanel();

	            // find body element
	            var body = TextArea.cfg.parent.parents('body');

	            // clear selection on the body element
	            Compat.clearSelection(window);

	            // for each iframe, blur its body
	            body.find('iframe').each(function() {
		            if (typeof(this._ta_obj) != "undefined" && TextArea.textAreaIframe.id != this.id) {
			            var localTextArea = this._ta_obj;

			            if (localTextArea._toolbarOpacityMode > 0 && localTextArea._toolbarOpacityMode < 1 && !localTextArea._holdToolbarDisplay){
				            localTextArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide);
				            localTextArea._removePanel();
				            localTextArea._iframeDoc.getSelection().removeAllRanges();  //cancel selection
			            }
		            }
		            /* jQuery(this).parent('ta').length && */
		            ENV.behaviors.isIE || jQuery(this).contents().find('body').blur();
	            });
            }
            jQuery(iframeDoc).mousedown(mouseDownIframeDoc);

            /**
             * iframeDoc - mouseUp
             * fade toolbar and set selected controls
             */
            function mouseUpIframeDoc(e){

	            if(!!TextArea.mfInEditMode) {
		            return;
	            }

	            var $target = jQuery(e.target);

	            //mouse up on math field prevent default behavior pr MF is in edit mode
	            if(TextArea.mathField && $target.parents('.mathField').length) {
		            TextArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide);
		            e.stopImmediatePropagation();
		            e.preventDefault();
					return false;
	            } else {
					// clear toolbar from other textEditors, but not from this textArea !
		            TextArea._holdToolbarDisplay = true;
		            TextArea._bodyElement.trigger('click');  //jQuery('body').trigger('click');
		            TextArea._holdToolbarDisplay = false;

		            if (iframeDoc.selection){
			            TextArea.range = iframeDoc.selection.createRange();
		            }

		            var selectedElement = TextArea._getSelectedElement();

		            //if there is math field inside selectedElement
		            //disable toolbar
		            var selectedHTML = TextArea._getSelectedHtml();
		            if(selectedHTML.search('class="mathField') > -1) {
			            TextArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.hide);
		            } else {
			            TextArea._setToolbarOpacity(t2k.component.textarea.TextEditorViewOpacity.fade);
			            TextArea._set_selected_controls(selectedElement, TextArea.textAreaControls);
			            TextArea._setInitStyle();
			            TextArea._setToolbarPotision();
		            }
	            }
            }
            jQuery(iframeDoc).mouseup(mouseUpIframeDoc);

	        if (!!ENV.behaviors.isIpad) {
		        var action, now, lastTouch, delta;


		        function preventFreezeOnDoubleTouch(event) {
			        if(!!TextArea.mfInEditMode) {
				        return;
			        }

			        now = new Date().getTime();
			        lastTouch = jQuery(this).data('lastTouch') || (now + 1); //the first time this will make delta a negative number
			        delta = now - lastTouch;
			        clearTimeout(action);

			        if (delta > 750) {
				        jQuery(this).data('lastTouch', 2);

				        // the second touchend event happened. Here is where we invoke the double tap code
				        var e = jQuery.Event("keyup");
				        e.which = 13; //enter releases textarea freeze
				        e.keyCode = 13;
				        jQuery(iframeDoc).trigger(e, [{'preventDefaultEnter' : true}]);

			        } else {
				        jQuery(this).data('lastTouch', now);
				        action = setTimeout(function (e) {
					        clearTimeout(action);   // clear the timeout
				        }, 750, [event]);
			        }
			        jQuery(this).data('lastTouch', now);
		        }

		        jQuery(iframeDoc).bind('touchend', preventFreezeOnDoubleTouch);

		        jQuery(iframeDoc).doubletap(function(event){
//			        console.log('doubletap');

			        event.preventDefault();
			        event.stopImmediatePropagation();
			        event.stopPropagation();
			        return false;
		        });

		        jQuery(iframeDoc).taphold(function(event){
//			        console.log('taphold');

			        event.preventDefault();
			        event.stopImmediatePropagation();
			        event.stopPropagation();

			        return false;
		        });

	        }

            /**
             * iframeDoc keyDown
             * handle undo/redo hotkeys and start handle maxChar issue
             */
            function documentKeyDown(e){
	            if(!!TextArea.mfInEditMode) {
		            return;
	            }

	            TextArea._bodyElement.focus();

	            var selection = TextArea._iframeDoc.getSelection();

	            if (!selection || !selection.anchorNode) {
		            return; // in case we dont have an anchore node
	            }

	            TextArea.lastSelection = selection;

	            if(e.keyCode == 8) {
		            //special case MF backspace removal
		            if(jQuery(selection.anchorNode).children().last().hasClass('mathField')) {
			            jQuery(selection.anchorNode).children().last().removeNative();
		            }

		            if(jQuery(selection.anchorNode).children().last().children().last().hasClass('mathField')) {
			            jQuery(selection.anchorNode).children().last().children().last().removeNative();
		            }


		            e.stopPropagation();
	            }

	            // handle space in keyScroll
	            if (e.keyCode == 32 && TextArea._enableKeyscroll == true && TextArea._browser == 'IE'){
		            e.preventDefault();
	            }

	            // if enter is disabled - prevent default, and run forest run :)
	            if (e.keyCode == 13 && TextArea._enableEnter == false) {
		            e.preventDefault();
		            TextArea._beep();
		            return;
	            }

	            if(typeof TextArea.setAnswer == 'function' && e.keyCode == 17 ){
		            TextArea._ctrlDown = false;
		            cancelDefault(e);
		            return;
	            } else if (e.keyCode == 17){ // ctrl down will save it's state at this._ctrlDown
		            TextArea._ctrlDown = true;
		            return;
	            }

	            // ctrl+z (undo) down: trigger undo
	            if (e.ctrlKey && e.keyCode == 90){
		            e.preventDefault();
		            jQuery("#" + TextArea.id + "ToolBar").find("div[rel=undo]").trigger("mousedown").trigger("mouseup");
		            return;
	            }

	            // ctrl+y (redo) down : trigger redo
	            if (e.ctrlKey && e.keyCode == 89){
		            e.preventDefault();
		            jQuery("#" + TextArea.id + "ToolBar").find("div[rel=redo]").trigger("mousedown").trigger("mouseup");
		            return;
	            }

	            // disable space(32) and tab(9) at 'letter' mode
	            if ((TextArea._mode == 'letter' && e.keyCode == 32) || (TextArea._mode == 'letter' && e.keyCode == 9)){
		            e.preventDefault();
		            return;
	            }

	            // disable 'capsLock' (20) or 'alt' (18) or 'shift' (16)
	            if (e.keyCode == 20 || e.keyCode == 18 || e.keyCode == 16){
		            e.preventDefault();
		            return;
	            }

	            // remove panel (dropDown)
	            TextArea._removePanel();

	            // save the textArea inner html. if maxChar, "keyUp" will replace the inner html to tempTextAreaHtml
	            tempTextAreaHtml = jQuery(iframeDoc).contents().find("body").html();
	            /**
	             * Unicode has the zero-width characters.
	             * Letter mode in fashion they are considered as symbols , maxChar = 1 so ..... DREADFUL AND TERRIBLE BUG
	             * U+200B zero width space
	             * U+200C zero width non-joiner Unicode code point
	             * U+200D zero width joiner Unicode code point
	             * U+FEFF zero width no-break space Unicode code point
	             * and more ...
	             * To remove them from a string in JavaScript, we can use a simple regular expression:
	             */
	            var tmp = jQuery(iframeDoc).text();
	            tmp = tmp.replace(/[\u200B-\u200D\uFEFF]/g, '');
	            var textAreaCharsLength = thi$._mode == "letter" ? jQuery.trim(tmp).length : tmp.length;
	            if (textAreaCharsLength < maxChar){
		            isMaxChar = false;
	            }

	            var containsMF = false;
	            if(thi$.mathField && thi$.mathField.length) {
		            containsMF = true;
	            }

	            // if maxChar is true, allow only ctrl, and keys that doesn't increase the char num (innocent)
	            if (!containsMF && (textAreaCharsLength >= maxChar) && (isMaxChar == false) && (maxChar != '')){

		            // only if ctrl is down and nothing is selected, allow only innocent chars. else, set isMaxChar = true
		            // and continue the handle with keyUp
		            if (!e.ctrlKey && TextArea._getSelectedHtml() == ''){

			            // if the keDown is not innocent (one that will increase the char num)
			            if (!TextArea._innocentKeyDown(e.keyCode)){
				            e.preventDefault();
				            TextArea._beep();
				            return;
			            }

		            } else {
			            isMaxChar = true;
		            }

            }
            }
            jQuery(iframeDoc).keydown(documentKeyDown);

            /**
             * iframeDoc paste -
             * check max char on paste
             */
            jQuery(iframeDoc).bind('paste', function(e) {

	            if(!!TextArea.mfInEditMode) {
		            return;
	            }

                //* Process browser events, then update pasted text. *//
                window.setTimeout(function(e) {

                    var pastedHtmlCleaning = function(elem) {
                        if (elem.style && elem.style.fontSize) {
                            if (thi$._textArea_toolbarControlsHash.fontSize.dropDownElements.indexOf(parseInt(elem.style.fontSize)) == -1 ) {
                                elem.style.fontSize = '';
                                if ( elem.attributes && elem.attributes['style'] && (elem.attributes['style'].value == '') ) {
                                    elem.removeAttribute('style');
                                }
                            }  
                        }
                    }

                    var pastedHtmlSizeLimit = function(elem, n) {
                        
                        if ( thi$.pastedLength > n ) {
                            TextArea._beep();
                            return;
                        }

                        var $elem = $(elem);
                        if ($elem[0] && $elem[0].childNodes) {
                            $.each($elem[0].childNodes, function(index, child) {
                                if (child && child.nodeType === 3) {// TEXT_NODE
                                    thi$.pastedLength += child.nodeValue ? child.nodeValue.length : 0;
                                    // cut off excess
                                    if (thi$.pastedLength > n) {
                                        child.nodeValue = child.nodeValue.substring(0, child.nodeValue.length-(thi$.pastedLength - n));
                                    }
                                } else if(child && child.nodeType === 1) {// ELEMENT_NODE
                                    pastedHtmlCleaning(child);
                                    (thi$.pastedLength < n) || pastedHtmlSizeLimit(child, n);
                                } else {
                                    /*  
                                        ATTRIBUTE_NODE = 2;
                                        CDATA_SECTION_NODE = 4;
                                        ENTITY_REFERENCE_NODE = 5;
                                        ENTITY_NODE = 6;
                                        PROCESSING_INSTRUCTION_NODE = 7;
                                        COMMENT_NODE = 8;
                                        DOCUMENT_NODE = 9;
                                        DOCUMENT_TYPE_NODE = 10;
                                        DOCUMENT_FRAGMENT_NODE = 11;
                                        NOTATION_NODE = 12;
                                    */
                                    child && child.remove();
                                }
                            })
                        }
                    }

                    var PastedTxt = jQuery(iframeDoc).text(),
                        pastedHtml = jQuery(iframeDoc.body).html(),
                        maxVal = parseInt(thi$.maxChar,10);
                    thi$.pastedLength = 0;

                    if(!!pastedHtml) {
                        var $allListElements = $('<div />').html(pastedHtml);
                        $.each($allListElements , function(index, value) {
                            pastedHtmlSizeLimit(this,maxVal);
                        });
                        // apply html to ta
                        thi$._bodyElement.html( $allListElements.html() );
                    }
                    // set carret position to end
                    thi$._bodyElement.attr('contenteditable','true');
                    thi$.setCaretPositionEnd( thi$._bodyElement[0] , thi$._bodyElement.context.getSelection());

                    thi$.setBodyStyle();

                }, 0);

	            //textEditor is part of progression
	            if(typeof TextArea.setAnswer == 'function'){

		            var textAreaCharsLength = jQuery(iframeDoc).text().length;
		            //check for deleting all content
		            TextArea.setAnswer.call(TextArea, !(textAreaCharsLength == 0));

		            if(TextArea.firstKeyDown && TextArea.firstKeyDown.call()){
			            TextArea.firstKeyDown.call(TextArea);
		            }
	            }
            });
            
            // TODO: duplicate
                    
            /**
             * iframeDoc selectstart -
             * check max char on paste
             */  
            jQuery(iframeDoc).bind('selectstart', function(){
                 //* Process browser events, then update pasted text. *//
	            var checkTextLength = true;

	            if(thi$.mathField && !!thi$.mathField.length) {
		            checkTextLength = false;
	            }

	            if(checkTextLength) { //don't cut text if text editor contains a math field
	                window.setTimeout(function(e) {

	                    var PastedTxt = thi$._bodyElement.text().trim(),
	                        maxVal = parseInt(thi$.maxChar,10);

	                    if (PastedTxt.length > maxVal){
	                        TextArea._beep();

	                        PastedTxt = PastedTxt.substring(0, maxVal);
	                        thi$._bodyElement.text( PastedTxt );
	                    }

	                    thi$.setBodyStyle();

	                }, 0);
	            }

            });

            /**
             * iframeDoc keyUp -
             * finish handle the hotkeys
             * finish handle maxChar issue
             * fire constructor's keyUpFunction
             * set selected controls
             * disable redo if textArea is at "undoMode" (means that undo pressed, and redo is enable)
             */
            function documentKeyUp(e, data){

	            if(!!TextArea.mfInEditMode) {
		            return false;
	            }

	            if(e.keyCode == 8) {
		            e.stopPropagation();
	            }

	            TextArea.setBodyStyle();

	            //don't fire hot keys if textEditor is part of cloze
	            if(typeof TextArea.setAnswer != 'function'){
		            // handle space in keyScroll
		            if (e.keyCode == 32 && TextArea._enableKeyscroll == true && TextArea._browser == 'IE'){
			            e.preventDefault();
			            TextArea._replaceSelectionWith("&nbsp;");
		            }
		            // ctrl up
		            if (e.keyCode == 17) {
			            TextArea._ctrlDown = false;
			            return;
		            }

		            // ctrl+z (undo) up
		            if (e.ctrlKey && e.keyCode == 90){
			            return;
		            }

		            // ctrl+y (undo) up
		            if (e.ctrlKey && e.keyCode == 89){
			            return;
		            }

		            // ctrl+u (underline) up - safari only
		            if (e.ctrlKey && e.keyCode == 85 && TextArea._browser == 'SAFARI'){
			            TextArea._execCmd('underline', '');
			            return;
		            }

		            // ctrl + u indication
		            if (e.ctrlKey && e.keyCode == 85){
			            TextArea._toggleControl(TextArea._toolbarElement.find('div[rel=underline]'));
			            return;
		            }
		            // ctrl + i indication
		            if (e.ctrlKey && e.keyCode == 73){
			            TextArea._toggleControl(TextArea._toolbarElement.find('div[rel=italic]'));
			            return;
		            }

		            // ctrl + b indication
		            if (e.ctrlKey && e.keyCode == 66){
			            TextArea._toggleControl(TextArea._toolbarElement.find('div[rel=bold]'));
			            return;
		            }

		            // enter pressed
		             if (e.keyCode == 13){
		                TextArea._execCmd('fontname', TextArea.style.font);

			             if(data && data.preventDefaultEnter) {
				            //
			             } else {
				             TextArea._iframeDoc.execCommand("insertHtml", false, "<br>");
			             }

		             }
	            }


	            // disable redo at undoMode
	            if (TextArea._undoMode){
		            TextArea._resetUndo();
		            TextArea._enableControl("redo","no");
	            }

	            // disable 'capsLock' (20) or 'alt' (18) or 'shift' (16)
	            if (e.keyCode == 20 || e.keyCode == 18 || e.keyCode == 16){
		            e.preventDefault();
		            return;
	            }

	            //progress task based on input value
	            if (!TextArea._innocentKeyDown(e.keyCode) || e.keyCode == 8 || e.keyCode == 46){
		            TextArea.setAnswer && TextArea.setAnswer.call(TextArea, true);
		            TextArea.firstKeyDown && TextArea.firstKeyDown.call(TextArea);

		            (!TextArea._firstKeyPressed) && (TextArea._firstKeyPressed = true);
	            }

	            TextArea._pushUndo(iframeDoc);

	            var textAreaCharsLength = TextArea.getValue().length;
	            // check for maxChar (the key can be 'del' or 'backspace' or arrows...)
	            if (textAreaCharsLength <= maxChar){
		            isMaxChar=false;
	            }

	            // if maxChar replace textArea inner html to tempTextAreaHtml (that saved at keyDown)
	            if ((isMaxChar == true) && (e.keyCode != 8 && e.keyCode !== 46)) {
		            jQuery(iframeDoc).contents().find("body").html(tempTextAreaHtml);
		            TextArea._beep();
		            isMaxChar = false;
	            }

	            TextArea._setInitStyle();

	            // fire keyUpFunction
	            var keyUpFunction = jQuery(iframeDoc).contents().find("body").attr("keyUpFunction");

	            if(keyUpFunction){
		            eval(keyUpFunction);
	            }

	            // set selected controls
	            var selectedElement = TextArea._getSelectedElement();
	            TextArea._set_selected_controls(selectedElement, TextArea.textAreaControls);
            }
            jQuery(iframeDoc).keyup(documentKeyUp);


            // hack for the buggy ie9
            if (this._browser == 'IE'){
                if (this._mode == 'paragraph' || this._mode == 'fullText'){
                    merge(bodyElement_inlineStyle, {
                        'overflow-x': '',
                        'margin': 0
                    });

                    jQuery(iframe).width(jQuery(iframe).width() - 10);
                    jQuery(iframe).height(jQuery(iframe).height() - 10);

                    jQuery(iframe).parent().css("text-align","right");
                }
            }

            // on paragraph || fullText only - this._enableScrollbar case - hide/show scroll
            if(this._mode == "paragraph" || this._mode == "fullText"){

                if (this._enableScrollbar){
                    if(!ENV.behaviors.isIE){
                        jQuery(iframeDoc).find("html").css("overflow-y","auto");
                    }
                } else {
                    if (this._browser == 'IE'){
                        bodyElement_inlineStyle["overflow"] = "hidden";
                    }
                }

            }

            // letter mode exception - set center alignment for the iframe
            if (this._mode == "letter"){
                bodyElement_inlineStyle["text-align"] = "center";
            } else if(this._mode == 'word' || this._mode == 'sentence') {
                bodyElement_inlineStyle["padding"] = "2px 4px";
            } else {
                if(ENV.behaviors.isIE){
                    bodyElement_inlineStyle["padding"] = "0px";
                }else{
                    bodyElement_inlineStyle["padding"] = "6px";
                }
            }

//            if (this._mode == 'word' || this._mode == "letter" || this._mode == 'sentence'){
//                jQuery(iframe).css("margin-top","2px");
//            }

            // keyscroll issue
            if (this._enableKeyscroll){
                this.maxChar = "300";
            } else {
                // if keyScroll is disables, force line breakes (that's cancel the h. scroll)
                bodyElement_inlineStyle["word-wrap"]= "break-word";
            }

            jQuery(this._bodyElement).css(bodyElement_inlineStyle);

        },

        /**
         * _toggleControl
         */
        _toggleControl : function(controlElement){

            var controlName = controlElement.attr('rel');
            var controlActive = controlElement.attr('active');
            var controlClass = controlElement.attr('class');

            if (controlActive == 'yes'){
                controlElement.attr('active','no').attr('class', controlClass.replace('-selected',''));
            } else {
                controlElement.attr('active','yes').attr('class', controlClass + '-selected');
            }
        },

        /**
         * _toolbarClick
         * toolbar click handle
         *
         * @param f
         * @param controlElement
         */
        _toolbarClick : function(fullControl, controlElement){

            var b, controlArguments;
            if(!!controlElement) {
                b = controlElement.exec;
                controlArguments = controlElement.args || [];
            }

            // thisRel is the control's name
            var thisRel = jQuery(fullControl).attr("rel");

            if (!controlElement.dropDown){
                this._removePanel();
            }

            if (controlElement.handler && this[controlElement.handler]) {
                this[controlElement.handler](controlElement);
            }

            // marker control issue
            if (controlElement.command == "backColor"){

                var activeButton = jQuery("#" + this.id + "ToolBar").find(".marker").attr("active");
                var bgColor = controlArguments;

                if (activeButton == "no"){
                    bgColor = "white";
                }

                if (this._getSelectedHtml() == '' && this._browser != 'IE'){

                    // append 'markerTest' SPAN to the ta
                    this._replaceSelectionWith('<span style="background-color: '+bgColor+';" id="markerTest">&nbsp;</span>');
                    var maerkerEle = jQuery(this._bodyElement).find("#markerTest");

                    // finds the selection & range
                    var iframeRange = null;
                    var iframe = this.textAreaIframe;
                    var iframeDoc = this._iframeDoc;
                    var iframeContentWindow = iframe.contentWindow;

                    var iframeRange, iframeSelection;

                    if (iframeContentWindow.getSelection){
                        iframeRange = iframeContentWindow.getSelection().getRangeAt();
                        iframeSelection = iframeContentWindow.getSelection();
                    } else {
                        this.range.select();
                        iframeRange = iframeDoc.selection.createRange();
                        iframeSelection = iframeDoc.selection;
                    }

                    // removes curr ranges
                    iframeSelection.removeAllRanges();

                    // get the span element
                    var srcObj = iframeDoc.getElementById("markerTest");

                    // creates new range for the span selection
                    if (iframeDoc.createRange){
                        var rangeObj = iframeDoc.createRange();
                        rangeObj.selectNode(srcObj);
                        iframeSelection.addRange(rangeObj);
                    }

                    // removes the 'markerTest' id
                    jQuery(srcObj).removeAttr("id");

                } else {
                    this._execCmd("backColor", bgColor);
                }

            } else if (controlElement.command) {
                this._execCmd(controlElement.command, true, controlArguments);
            }

            //this._clearHTML();

            if (thisRel != "undo" && thisRel != "redo"){
                // console.log("pushUndo in toolbarClick")
                this._pushUndo();
            }

        },

        /**
         * exeCmd
         * execute control command
         *
         * @param controlCommand
         * @param controlArguments
         * @param dontFocus do not attempt to set focus on the iframe.
         */
        _execCmd : function(controlCommand, controlArguments, dontFocus) {

            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;
            var iframeContentWindow = iframe.contentWindow;

            if (!dontFocus) {
                (ENV.behaviors.isIE? this._bodyElement: iframe.contentWindow).focus();
            }

            if(controlCommand == 'fontSize') {
                var selectionHTML = this._getSelectedHtml();
                var selectionRange = this._getSelectionRange();

                /**
                 * This is only done to disable creation of additional CSS rules.
                 */
                try {
                    iframeDoc.execCommand("styleWithCSS", 0, false);
                }
                catch (notUsed) {
                    try {
                        iframeDoc.execCommand("useCSS", 0, true);
                    }
                    catch (notUsed) {
                    }
                }

                while (selectionHTML.indexOf('font-size') != -1){

                    var fontSizeIndex = selectionHTML.indexOf('font-size');
                    var xIndex = fontSizeIndex + 11;

                    while (selectionHTML.charAt(xIndex) != 'x'){
                        xIndex++;
                    }

                    selectionHTML = selectionHTML.substring(0, fontSizeIndex) + selectionHTML.substring(xIndex+1);
                    selectionHTML = selectionHTML.replace('style=""','').replace('style="; "','');
                }

                //iframeDoc.execCommand("delete", false, false);
                var pasteHTML = '<span style="font-size: ' + controlArguments + 'px"></span>';
                if(selectionHTML){
                    pasteHTML = '<span style="font-size: ' + controlArguments + 'px">' + selectionHTML + '</span>';
                }

                this._replaceSelectionWith(pasteHTML, !selectionHTML.length);

            } else {

                if(!!this.mathField) {
                    this.mathField.forEach(function(mfObject){
                        mfObject.view._view.addClass('readwrite');
                    });
                }


                /**
                 * This is only done to disable creation of additional CSS rules.
                 */
                try {
                    iframeDoc.execCommand("styleWithCSS", 0, false);
                }
                catch (notUsed) {
                    try {
                        iframeDoc.execCommand("useCSS", 0, true);
                    }
                    catch (notUsed) {
                    }
                }

                controlArguments = controlArguments || false;

                try {
                    iframeDoc.execCommand(controlCommand, false, controlArguments);
                }
                catch (error) {
                    // console.error("id: " + this.id + "; cmd: " + controlCommand + "; args: " + controlArguments+"; error: " + error.message);
                }


                if (!!this.mathField) {
                    this.mathField.forEach(function (mfObject) {
                        mfObject.view._view.removeClass('readwrite');
                    });
                }

            }

            if (!dontFocus) {
                (ENV.behaviors.isIE? this._bodyElement: iframe.contentWindow).focus();
            }
        },

        /**
         * _textAreaControlsHashCreate -
         * base hash for different toolbar creation
         * build the textarea controls (as hash) by preset
         *
         * @returns textAreaControlsHash
         */
        _textAreaControlsHashCreate : function(){

            // init two toolbar preset objects. (same for now)
            var toolbar = eval('t2k.component.textarea.TextEditorViewToolbarConfig.' + this.toolBarPreset);
            var toolbarPreset = this._cloneObj(toolbar);

            // place the full object in the preset object
            for (var controlName in toolbar){
                toolbar[controlName] = this._textArea_toolbarControlsHash[controlName];
            }

            // place the preset new arguments
            for (var cName in toolbarPreset){
                if (toolbarPreset[cName].length > 0){
                    toolbar[cName][toolbarPreset[cName][0]] = toolbarPreset[cName][1];
                }
            }

            return toolbar;
        },

        /**
         * _cloneObj -
         * clone an object
         *
         * @param oldObject
         * @returns newObject
         */
        _cloneObj : function(oldObject){
            var newObject = jQuery.extend(true, {}, oldObject);
            return (newObject);
        },

        /**
         * _set_selected_controls -
         * inds out all the srcElement tags and set active the relevant control at the toolbar
         *
         * @param srcElement
         * @param textAreaControls
         */
        _set_selected_controls : function(srcElement, textAreaControls) {

            var toolbar = this.textAreaTollBarZone;

            // set default values for fontSize and fontColor
            var styleDefaultFontSize = this.style.size;
            jQuery("#" + this.id + "ToolBar").find(".fontSizeDisplay").html(styleDefaultFontSize);
            jQuery("#" + this.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color","none");

            var controlName, analyzedElement, controlElement, controlObj, controlTagName;
            var fontFace = null;
            var fontSize = null;
            var color  = null;
            var bold = false;
            var italic = false;
            var underline = false;

            var setColor  = true;
            var setFontSize = true;
            var setMarker = true;

            try {
                // looping the toolbar controls | set the toolbar's controls view not selected
                for (controlName in textAreaControls) {
                    controlObj = textAreaControls[controlName];

                    // set the control view not selected
                    var controlElement = jQuery("#" + this.id + "ToolBar").find("div[rel='" + controlName + "']");
                    var currRel = jQuery(controlElement).attr("rel");
                    jQuery(controlElement).attr("class",currRel);
                    jQuery(controlElement).attr("active","no");
                }


                // looping the toolbar controls
                for (controlName in textAreaControls) {
                    controlObj = textAreaControls[controlName];

                    // set the control view not selected
                    var controlElement = jQuery("#" + this.id + "ToolBar").find("div[rel='" + controlName + "']");
                    var currRel = jQuery(controlElement).attr("rel");

                    // check for disabled buttons view
                    if (jQuery(controlElement).attr("enable") == "no"){
                        jQuery(controlElement).attr("class", currRel + "-disable");
                    }


                    if (!controlObj.tags) {
                        continue;
                    }

                    analyzedElement = srcElement;

                    do {
                        if (analyzedElement.nodeType != 1) {
                            continue;
                        }
                        markupTagName = analyzedElement.nodeName.toLowerCase();

                        if (jQuery.inArray(markupTagName, controlObj.tags) < 0) {
                            continue;
                        }

                        // marker indication

                        var backColor = jQuery(analyzedElement).css("background-color");
                        // console.log("backColor: " + backColor)

                        if (setMarker){
                            if (backColor == "yellow" || backColor == "rgb(255, 255, 0)"){
                                // console.log('backColorYellow')
                                jQuery("#" + this.id + "ToolBar").find("div[rel=marker]").attr("class","marker-selected");
                                jQuery("#" + this.id + "ToolBar").find("div[rel=marker]").attr("active","yes");
                                setMarker = false;
                            } else {
                                if (backColor == "white" || backColor == "rgb(255, 255, 255)"){
                                    setMarker = false;
                                }
                            }
                        }

                        // color indication

                        var color = jQuery(analyzedElement).attr("color");

                        if (color == null || !color || color==''){
                            color = jQuery(analyzedElement).css("color");
                        }

                        if (color != null && color != '' && setColor){
                            jQuery("#" + this.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color",color.toLowerCase());
                            setColor = false;
                        }

                        // bold by font-weight
                        if (jQuery(analyzedElement).css("font-weight") == "bold"){
                            bold = true;
                            jQuery("#" + this.id + "ToolBar").find("div[rel=bold]").attr("class","bold-selected");
                            jQuery("#" + this.id + "ToolBar").find("div[rel=bold]").attr("active","yes");
                        }

                        // italic by font-style
                        if (jQuery(analyzedElement).css("font-style") == "italic"){
                            italic = true;
                            jQuery("#" + this.id + "ToolBar").find("div[rel=italic]").attr("class","italic-selected");
                            jQuery("#" + this.id + "ToolBar").find("div[rel=italic]").attr("active","yes");
                        }

                        if (markupTagName == "ul"){
                            var listType = jQuery(analyzedElement).css("list-style-type");
                            jQuery("#" + this.id + "ToolBar").find("div[rel=lists]").attr("listType",listType + "List");
                        }

                        if (markupTagName == "ol"){
                            jQuery("#" + this.id + "ToolBar").find("div[rel=lists]").attr("listType","numberList");
                        }

                        // if srcElement tagName is 'font', sets the fontFace and fontSize
                        if (markupTagName == "span" || markupTagName == "font"){
                            fontSize = jQuery(analyzedElement).css("font-size").replace('px','');

                            if (fontSize && setFontSize){
                                jQuery("#" + this.id + "ToolBar").find(".fontSizeDisplay").html(fontSize);
                                setFontSize = false;
                            }
                        }

                        // get the active markup for style analyzer
                        switch (markupTagName){
                            case "b" :
                            case "strong":
                                bold      = true;
                                jQuery(controlElement).attr("class",currRel+"-selected");
                                jQuery(controlElement).attr("active","yes");
                                break;
                            case "i" :
                                italic    = true;
                                jQuery(controlElement).attr("class",currRel+"-selected");
                                jQuery(controlElement).attr("active","yes");
                                break;
                            case "u" :
                                underline = true;
                                jQuery(controlElement).attr("class",currRel+"-selected");
                                jQuery(controlElement).attr("active","yes");
                        }

                        if (currRel == "lists"){
                            listsElement = jQuery("#" + this.id + "ToolBar").find("div[rel=lists]");
                            jQuery(listsElement).attr("class","lists-selected");
                            jQuery(listsElement).attr("active","yes");
                        }

                        // looping the DOM, from selection to body
                    } while (analyzedElement = analyzedElement.parentNode);
                }
            } catch (error) {
                //console.log("setSelectedControls: failed looping toolbar, error = [" + error.markupTagNameessage + "]");
            }
        },

        /**
         * _indent -
         * set the indent by the direction
         *
         * @param controlElement
         */
        _indent : function(controlElement){

            this._execCmd('indent');

            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;

            jQuery(iframeDoc).find("blockquote").removeAttr("class");

            if (this.direction=='rtl') {
                jQuery(iframeDoc).find("blockquote").css("margin","0px");
                jQuery(iframeDoc).find("blockquote").css("margin-right","40px");
            }
        },

        /**
         * _undo -
         * display the saved html from undoArray by undoIndex--
         */
        _undo : function() {
            // console.log("undo start this._undoIndex: " + this._undoIndex)
            this._undoIndex --;

            if (this._undoArray[this._undoIndex] == false && this._undoArray[this._undoIndex] != ''){
                this._undoIndex ++;
                // console.log("undo return false this._undoIndex: " + this._undoIndex)
            } else {
                // console.log("undo OK this._undoIndex: " + this._undoIndex)
                this._undoMode = true;

                var iframe = this.textAreaIframe;
                var iframeDoc = this._iframeDoc;
                jQuery(iframeDoc).contents().find("body").html(this._undoArray[this._undoIndex]);

                // set redo enable
                this._enableControl("redo","yes");

                if (this._undoIndex == 0) {
                    // set undo disable
                    this._enableControl("undo","no");
                }
            }
        },

        /**
         * _redo -
         * display the saved html from undoArray by undoIndex++
         */
        _redo : function() {

            // console.log("redo start this._undoIndex: " + this._undoIndex)
            this._undoIndex++;

            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;
            jQuery(this._bodyElement).html(this._undoArray[this._undoIndex]);

            // set undo enable
            this._enableControl("undo","yes");

            if (this._undoArray.length == parseInt(this._undoIndex)+1) {
                // set redo disable
                this._enableControl("redo","no");
            }

            //  console.log("redo end this._undoIndex: " + this._undoIndex)
        },

        /**
         * _pushUndo -
         * push the current html to undoArray
         *
         * @param iframeDoc
         */
        _pushUndo : function(iframeDoc) {

            //  console.log("_pushUndo START: " + this._undoIndex)

            if (!iframeDoc) {
                var iframe = document.getElementById(this.id+"Iframe");
                var iframeDoc = iframe.contentWindow.document;
            }

            var currHTML = jQuery(iframeDoc).contents().find("body").html();

            if (currHTML == this._undoArray[this._undoIndex]){
                return false ;
            }

            this._undoIndex++ ;
            this._undoArray[this._undoIndex] = currHTML;

            if (this._undoIndex > 100) {
                this._undoArray[this._undoIndex-100] = false;
            }

            // set undo enable
            this._enableControl("undo","yes");

            // console.log("_pushUndo END: " + this._undoIndex)
        },

        /**
         * _initUndo -
         * set final init html body markup as #0 index of this._undoIndex
         */
        _initUndo : function(){

            this._undoIndex = 0 ;

            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;
            this._undoArray[this._undoIndex] = jQuery(this._bodyElement).html();

            this._enableControl("undo","no");
            this._enableControl("redo","no");
        },

        /**
         * _enableControl -
         * set enable or disable toolbars controls - view and functionality
         *
         * @param controlRel (controlName)
         * @param enable     (yes/no)
         */
        _enableControl : function(controlRel, enable){

            var className = controlRel;

            if (enable == "no"){
                className += "-disable";
            }

            jQuery(this.textAreaTollBarZone).find("div[rel='"+controlRel+"']").attr("class",className).attr("enable",enable);
        },

        /**
         * _resetUndo -
         * delete nodes from undoArray from the current undoIndex positon
         */
        _resetUndo : function(){
            while (this._undoArray.length > this._undoIndex + 1){
                this._undoArray.pop();
            }

            this._undoMode = false;
        },

        /**
         * _setDirection -
         * set the TA's body dir, and handle the indend margin issue
         *
         * @param controlElement
         */
        _setDirection : function (controlElement) {

            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;
            jQuery(this._bodyElement).css("direction",controlElement.dir);

            if (controlElement.dir=="rtl") {
                jQuery(this._bodyElement).find("blockquote").css("margin","0 40px 0 0");
            } else {
                jQuery(this._bodyElement).find("blockquote").css("margin","0 0 0 40px");
            }
        },

        /**
         * _getSelectedHtml -
         * find the selected html by range
         *
         * @return selectedHTML
         */
        _getSelectedHtml : function() {

            var selectedHTML = null;
            var iframe = document.getElementById(this.id+"Iframe");
            var iframeContentWindow = iframe.contentWindow;
            var selectionRange = this._getSelectionRange();

            if (selectionRange) {
                // get selected content and clone it to div element

                if (this._browser != 'IE') {
                    var tempDivEle = document.createElement("div");
                    tempDivEle.appendChild(selectionRange.cloneContents());
                    selectedHTML = tempDivEle.innerHTML;
                } else {
                    selectedHTML = selectionRange.htmlText;
                }
            }

            // selectedHTML is the innerHTML of the cloned div
            return selectedHTML;
        },

        /**
         * _getSelectionRange -
         * a range is a pointer to the specific selection
         *
         * @return iframeRange
         */
        _getSelectionRange : function(){

            var iframeRange = null;
            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;
            var iframeContentWindow = iframe.contentWindow;

            //if (iframeContentWindow.getSelection) {
            if (this._browser != 'IE'){
                if(iframeContentWindow.getSelection().rangeCount > 0)
                    iframeRange = iframeContentWindow.getSelection().getRangeAt();
                else
                    iframeRange = iframeDoc.createRange();
            } else {
                iframeRange = iframeDoc.selection.createRange();
            }

            return iframeRange;
        },

        /**
         * _replaceSelectionWith -
         * delete the current selection and paste "htmlToReplace" instead
         *
         * @param htmlToReplace
         * @return true/false
         */
        _replaceSelectionWith : function(htmlToReplace, caretBeforeClosingTag){
            var selectionRange = this._getSelectionRange();

            var iframe = document.getElementById(this.id + "Iframe");
            var iframeContentWindow = iframe.contentWindow;
            var iframeDoc = this._iframeDoc;
            var ret = true;

            if (selectionRange) {

                // removeFormat will prevent a broken markup after removing the current selection
                // this._execCmd("removeFormat");

                // selection case
                if (this._browser != 'IE') {

                    if (caretBeforeClosingTag) {
                        try {
                            var wrapper = jQuery(htmlToReplace)[0];
                            selectionRange.insertNode(selectionRange.createContextualFragment("&#8203;"));
                            selectionRange.surroundContents(wrapper);
                            // selectionRange.setStart(wrapper, 0);
                            // selectionRange.setEnd(wrapper, 1);

                            var selection = iframeContentWindow.getSelection();
                            selection.selectAllChildren(wrapper);
                            selection.collapseToEnd();
                            // selection.deleteFromDocument(wrapper);
                            // selection.removeAllRanges();
                            // selection.addRange(selectionRange);
                        }
                        catch (xxx) {
                            // do nothing
                        }
                    }
                    else {
                        selectionRange.deleteContents();
                        // selectionRange.selectNodeContents(this._bodyElement[0]);
                        try {
                            selectionRange.insertNode(selectionRange.createContextualFragment(htmlToReplace));

                            var selection = iframeContentWindow.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(selectionRange);
                        }
                        catch (xxx) {
                            // do nothing
                        }
                    }

                    // non selection case
                }
                else {
                    // MSIE (9) support
                    var iframeRange;

                    if (iframeContentWindow.getSelection().rangeCount) {
                        iframeRange = iframeContentWindow.getSelection().getRangeAt(0);
                    }
                    else {
                        iframeRange = iframeDoc.createRange();
                    }

                    if (caretBeforeClosingTag) {
                        try {
                            var sp = iframeDoc.createTextNode("\u200b");
                            var wr = Compat.importNodeToDocument(iframeDoc, jQuery(htmlToReplace)[0], 1);
                            /**
                             * This fails with "DOM Exception: WRONG_DOCUMENT_ERR (4)"
                             * when not using importNodeToDocument() hack
                             */
                            iframeRange.insertNode(sp);
                            iframeRange.surroundContents(wr);

                            var sel = iframeContentWindow.getSelection();
                            sel.selectAllChildren(wr);
                            sel.collapseToEnd();
                        }
                        catch (xxx) {
                            // do nothing
                        }
                    }
                    else {
                        // this._execCmd("delete");
                        selectionRange.pasteHTML(htmlToReplace);
                    }
                }
            }
            else {
                ret = false;
            }

            return ret;
        },

        /**
         * _createPanel -
         * drop dowm menu creation
         *
         * @param controlLeft
         * @param controlTop
         * @param panelHTML
         */
        _createPanel : function(controlLeft, panelHTML, relateToToolbarBotton){
            var TextArea = this;
            var toolbar = jQuery(this.textAreaTollBarZone);
            var toolbarHeight = toolbar.height();
            var toolbarTop = toolbar.offset().top;
            var dropDownTop = parseInt(toolbarHeight) + parseInt(toolbarTop);

            var shadow = jQuery("<div></div>").addClass("dropDownUpperShadow").width("100%").css("background-repeat","repeat-x");

            var panel = jQuery("<div></div>").attr("id", this.id + "_panel").attr("relateTo" ,relateToToolbarBotton);
            this._setUnselectable(panel);
            jQuery(panel).addClass(t2k.component.textarea.TextEditorViewConstants.panelClass).hide().append(shadow).append(panelHTML);

            jQuery("#" + this.id + "outerDiv").append(panel);

            jQuery(panel).fadeIn(100);

            if (relateToToolbarBotton == "setColor"){
                var panelWidth = "40";
                jQuery(panel).width((panelWidth*3) + 2);
                controlLeft -= (panelWidth * 2);
            }

            jQuery(panel).offset({left: controlLeft});
            jQuery(panel).css({top: "4px"});

            jQuery(panel).mouseover(function(){
                TextArea._setToolbarOpacity('show');
            });

            jQuery(panel).mouseout(function(){
                TextArea._setToolbarOpacity('fade');
            });
        },

        /**
         * _setListByType -
         * set the "lists" control by icon selection
         *
         * @param icon - square or disc
         * @parag tag  - UL or OL
         * @param execCmdStr - str for execCmd
         */
        _setListByType : function(icon, tag, execCmdStr){

            var selectionRange = this._getSelectionRange();
            var currElement = this._getSelectedElement();

            while (currElement.tagName!= tag && currElement.tagName!="BODY"){
                currElement = currElement.parentNode;
            }

            if (currElement.tagName == "BODY"){
                this._execCmd(execCmdStr);
                currElement = this._getSelectedElement();

                while (currElement.tagName != tag && currElement.tagName != "BODY"){
                    currElement = currElement.parentNode;
                }
            }

            if (icon != 'null'){
                jQuery(currElement).css("list-style-type", icon);
            } else {
                jQuery(currElement).removeAttr("style");
            }

            var currSize = jQuery(this._toolbarElement).find("div[rel='fontSize']").text();
            var currColor = jQuery(this._toolbarElement).find("div[rel='setColor']").find("td").css("background-color");

            if(currColor.indexOf('rgb') == 0){
                currColor = rgb2hex(currColor);
            }

            var fontSize = currSize + 'px';

            jQuery(currElement).css("font-size",fontSize);
            jQuery(currElement).css("color",currColor);

            jQuery(currElement).attr("setFontSize",fontSize);
            jQuery(currElement).attr("setColor",currColor);
        },

        /**
         * _removeListByType -
         * when list is on, and the same list type is fired by the controls,
         * the function will call execCmd with the same list type.
         *
         * @param icon
         * @param tag
         * @param execCmdStr
         */
        _removeListByType : function(icon, tag, execCmdStr){
            this._execCmd(execCmdStr);
        },

        /**
         * _removePanel -
         * fade out current panel
         */
        _removePanel : function(){
            var relateTo = jQuery("#" + this.id + "_panel").attr("relateto");
            jQuery("#" + this.id + "outerDiv").find("." + t2k.component.textarea.TextEditorViewConstants.panelClass).fadeOut(100).remove();
            jQuery("#"+this.id+"ToolBar [rel='"+relateTo+"']").attr("class",relateTo);
        },

        /**
         * _getSelectedElement -
         * get selected element by range
         *
         * @return returnElement
         */
        _getSelectedElement : function(){
            var iframe = document.getElementById(this.id + "Iframe");
            var iframeContentWindow = iframe.contentWindow;
            var returnElement, selection, selectionRange;

            // if the user marked some text
            if (iframeContentWindow.getSelection){
                try {
                    selection = iframeContentWindow.getSelection();
                    selectionRange = selection.getRangeAt(0);
                    returnElement = selectionRange.commonAncestorContainer;
                } catch (error) {
                    //console.log("_getSelectedElement: failed to create range by selection, error = [" + error.message + "]");
                    returnElement = false;
                }
                // text is not marked
            } else {
                try {
                    selection = iframeContentWindow.document.selection;
                    selectionRange = selection.createRange();
                    returnElement = selectionRange.parentElement();
                } catch (error) {
                    //console.log("_getSelectedElement: failed to create range, error = [" + error.message + "]");
                    returnElement = false;
                }
            }
            return returnElement;
        },

        /**
         * _clearHTML -
         * HTML markup cleaner -
         * removes the "Apple-style-span" class
         */
        _clearHTML : function() {
            return;
            // console.log("_clearHTML");

            var iframe = this.textAreaIframe;
            var iframeDoc = this._iframeDoc;
            var bodyHTML = jQuery(iframeDoc).contents();

            bodyHTML.find("font").each(function(){
                if (jQuery(this).attr("class") == "Apple-style-span"){
                    jQuery(this).removeAttr("class");
                }
            });

            bodyHTML.find("span").each(function(){
                // Chrome related issue - adds this class automatically
                if (jQuery(this).attr("class") == "Apple-style-span"){
                    jQuery(this).removeAttr("class");
                }
            });

            bodyHTML.find("font").each(function(){
                if (jQuery(this).text() == ''){
                    jQuery(this).remove();
                }
            });

            bodyHTML.find("div").each(function(){
                if (jQuery(this).text() == ''){
                    jQuery(this).remove();
                }
            });

            bodyHTML.find("span").each(function(){
                if (jQuery(this).text() == ''){
                    jQuery(this).remove();
                }
            });

            bodyHTML.find("ul").each(function(){
                var setFontSize = jQuery(this).attr("setFontSize");
                var setColor = jQuery(this).attr("setColor");

                jQuery(this).css("font-size", setFontSize);
                jQuery(this).css("color", setColor);
            });

        },

        /**
         * _setColor
         * diaplays the color drop down menu and sets the new color
         *
         * @param controlElement
         */
        _setColor : function(controlElement){

            var TextArea = this;
            var colorsArray = controlElement.colorArray,
                colorColumns = controlElement.colorColumns,
                control = jQuery("#" + this.id + "ToolBar [rel=setColor]").parent(),
	            controlLeft = jQuery(control).offset().left,
	            controlTop  = jQuery(control).offset().top;

            // get the color drop down menu HTML and display it
            var dropDownToolbarHTML = this._setColorHTMLdropDown(colorsArray,colorColumns);

            this._createPanel(controlLeft, dropDownToolbarHTML, "setColor");

            // set the drop down menu onClick event
	        function onClickColorPicker() {
		        TextArea._execCmd("foreColor", jQuery(this).attr("title"));
		        TextArea._removePanel();
		        var selectedColor = jQuery(this).attr("title");
		        jQuery("#" + TextArea.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color", selectedColor);
	        }
            jQuery(".colorPicker").click(onClickColorPicker);

            if (this._browser == 'IE'){

                var whiteCell = jQuery(".colorPicker[title='#ffffff']");
                jQuery(whiteCell).css("outline-color", "none").css("outline-width", "0px");

                var whiteCellHeight = jQuery(whiteCell).height();
                var whiteCellWidth = jQuery(whiteCell).width();

                var divElement = jQuery('<div/>').width(whiteCellWidth+2).height(whiteCellHeight+2).css('border','1px solid #ccc').appendTo(whiteCell);
                jQuery(divElement).css('background-position','0 -12000px;').css('margin-left','-1px').css('margin-top','-1px');

                this._setUnselectable(divElement);
            }

            var currColor = jQuery("#" + this.id + "ToolBar").find(".setColorDisplay").find("td").css("background-color");

            jQuery(".colorPicker").each(function(){
                if (jQuery(this).css('background-color').toLowerCase() == currColor.toLowerCase()){
                    jQuery(this).attr('class','currentColorPicker');
                }
            });
        },

        /**
         * _setColorHTMLdropDown -
         * builds the color drop down menu HTML by colorsArray and colorColumns
         *
         * @param colorsArray
         * @param colorColumns
         * @returns color drop down menu HTML markup
         */
        _setColorHTMLdropDown : function(colorsArray,colorColumns){

	        var TextArea = this;

	        var colorsArraySum = colorsArray.length;
	        var rows = Math.ceil(colorsArraySum / colorColumns);

	        // drop down HTML table
	        var table = jQuery("<table></table>").attr("cellspacing", "0").attr("cellpadding", "0");
	        TextArea._setUnselectable(table);
	        for (var lineIndex = 0; lineIndex < rows; lineIndex++) {

		        var line = jQuery("<tr></tr>");

		        for (var cellIndex = 0; cellIndex < colorColumns; cellIndex++) {
			        if (((lineIndex * colorColumns) + cellIndex) < colorsArraySum) {
				        var cell = jQuery("<td></td>");
				        var color = colorsArray[(lineIndex * colorColumns) + cellIndex];
				        var button = jQuery("<a href='#'></a>").addClass("colorPicker").css("background-color", color).attr("title", color);
				        TextArea._setUnselectable(button);

				        if (color == "#ffffff") {
					        jQuery(button).css("outline", "1px solid #ccc").css("outline-offset", "-3px");
				        }

				        cell.append(button);
				        line.append(cell);
			        }
		        }
		        table.append(line);
	        }

	        var div = jQuery("<div></div>").append(table);
	        return jQuery(div).html();
        },

        /**
         * _insertLists -
         * calls when hit "lists" control.
         * create panel (dropdown) and set it's buttons behavior
         *
         * @param controlElement
         */
        _insertLists : function(controlElement){

	        var TextArea = this, control = jQuery("#" + this.id + "ToolBar [rel=lists]");

	        var controlLeft = jQuery(control).offset().left;

	        var listType = null;

	        if (jQuery(control).attr("active") == "yes") {
		        listType = jQuery(control).attr("listType");
	        }

            // get panel html
            var dropDownToolbarHTML = this._setButtonsDropDownMenuHtml(controlElement.dropDownElements);

            // create panel
            this._createPanel(controlLeft, dropDownToolbarHTML, "lists");

            // set panel button's behavior
            TextArea._setUnselectable("#" + this.id + "_panel");
            jQuery("#" + this.id + "_panel").find("div").each(function(){

                if (jQuery(this).attr("execCmdStr")) {

                    var icon     = jQuery(this).attr("icon") ;
                    var tag      = jQuery(this).attr("tag") ;
                    var execCmdStr = jQuery(this).attr("execCmdStr") ;
                    var rel      = jQuery(this).attr("rel") ;


                    if (rel == listType){
                        jQuery(this).attr("class", rel + "-selected");
                    }

                    TextArea._setUnselectable(this);

                    jQuery(this).css("cursor","pointer");

                    jQuery(this).mousedown(function(){
                        jQuery(this).attr("class", rel + "-press");
                    });

                    jQuery(this).mouseover(function(){
                        var thisClass = jQuery(this).attr("class");
                        jQuery(this).attr("class", thisClass + "-over");
                    });

                    jQuery(this).mouseout(function(){
                        var thisClass = jQuery(this).attr("class");
                        jQuery(this).attr("class", thisClass.replace("-over",""));
                    });

                    jQuery(this).mouseup(function(){

                        if (rel == listType){
                            TextArea._removeListByType(icon, tag, execCmdStr);
                        } else {
                            TextArea._setListByType(icon, tag, execCmdStr);
                        }
                        TextArea._pushUndo();
                        TextArea._removePanel();
                    });
                }
            });
        },

        /**
         * _setButtonsDropDownMenuHtml
         * common function for all the dropDown's
         * get buttons array and return full html markup
         *
         * @param buttonsArray
         * @returns html
         */
        _setButtonsDropDownMenuHtml : function(buttonsArray){

            var DropDownMenuHtml = jQuery("<div></div>"), buttonTag, buttonExecCmdStr, buttonIcon, tooltip, buttonDiv;
            this._setUnselectable(DropDownMenuHtml);

	        for (var i = 0; i < buttonsArray.length; i++) {
		        buttonTag = this._textArea_toolbarControlsHash[buttonsArray[i]].tag;
		        buttonExecCmdStr = this._textArea_toolbarControlsHash[buttonsArray[i]].execCmdStr;
		        buttonIcon = this._textArea_toolbarControlsHash[buttonsArray[i]].icon;
		        tooltip = LanguageUtil.getString("textarea.tooltips." + buttonsArray[i]);

		        buttonDiv = jQuery("<div></div>").attr("title", tooltip).attr("class", buttonsArray[i]);
		        this._setUnselectable(buttonDiv);
		        jQuery(buttonDiv).attr("tag", buttonTag).attr("execCmdStr", buttonExecCmdStr).attr("icon", buttonIcon).attr("rel", buttonsArray[i]);
		        jQuery(DropDownMenuHtml).append(buttonDiv);
	        }

            return jQuery(DropDownMenuHtml).html();
        },

        /**
         * _setTextDropDownMenuHtml
         * create dropdown html markup for text dropDown
         *
         * @param textArray
         * @returns html
         */
        _setTextDropDownMenuHtml : function(textArray){

	        var DropDownMenuHtml = jQuery("<div></div>"), buttonTag, buttonExecCmdStr;

	        for (var i = 0; i < textArray.length; i++) {

		        buttonTag = textArray[i];
		        buttonExecCmdStr = "fontSize";
		        var tooltip = LanguageUtil.getString("textarea.tooltips." + textArray["fontSize" + i]);

		        var buttonDiv = jQuery("<div></div>").attr("class", "fontSize").attr("rel", "fontSize").attr("tag", textArray[i]).attr("execCmdStr", buttonExecCmdStr).html(parseInt(textArray[i]));
		        this._setUnselectable(buttonDiv);
		        jQuery(DropDownMenuHtml).append(buttonDiv);
	        }

            return jQuery(DropDownMenuHtml).html();
        },

        /**
         * _aligns -
         * calls when hit "_aligns" control.
         *
         * @param controlElement
         */
        _aligns : function(controlElement){
            this.handleToolbarDropDownMenuItem(controlElement,"aligns");
        },

        /**
         * handleToolbarDropDownMenuItem -
         * calls when hit some of the dropDown menu item control.
         * create panel (dropdown) and set it's buttons behavior
         *
         * @param controlElement
         * @param menuItemName
         */
        handleToolbarDropDownMenuItem : function(controlElement, menuItemName){

            var TextArea = this ;

            var control = jQuery("#" + this.id + "ToolBar [rel = " + menuItemName + "]").parent();
            var controlLeft = jQuery(control).offset().left;

            // get dropdown html
            var dropDownToolbarHTML = this._setButtonsDropDownMenuHtml(controlElement.dropDownElements);

            // create dropdown
            this._createPanel(controlLeft, dropDownToolbarHTML, menuItemName);

            // go over each drop button in panel
            jQuery("#" + this.id + "_panel").find("div").each(function(){

                if (jQuery(this).attr("execCmdStr")) {

                    var rel = jQuery(this).attr("rel");

                    jQuery(this).css("cursor","pointer");

                    jQuery(this).mousedown(function(){
                        jQuery(this).attr("class", rel + "-press");
                    });

                    jQuery(this).mouseover(function(){
                        var thisClass = jQuery(this).attr("class");
                        jQuery(this).attr("class", thisClass + "-over");
                    });

                    jQuery(this).mouseout(function(){
                        var thisClass = jQuery(this).attr("class") ;
                        jQuery(this).attr("class", thisClass.replace("-over",""));
                    });

                    jQuery(this).mouseup(function(){
                        TextArea._execCmd(jQuery(this).attr("execCmdStr"));
                        TextArea._pushUndo();
                        TextArea._removePanel();
                    });
                }
            });

        },

        /**
         * _indents -
         * calls when hit "_indents" control.
         *
         * @param controlElement
         */
        _indents : function(controlElement){

            // set right display direction for indent & outdent (it's changes between 'ltr' and 'rtl')
            if(this.direction == 'ltr'){
                // toggle the execCommand of indent and outdent
                this._textArea_toolbarControlsHash['indent'].execCmdStr = 'outdent';
                this._textArea_toolbarControlsHash['outdent'].execCmdStr = 'indent';

                // toggle the tooltip of indent and outdent
                var indentTooltip  = LanguageUtil.strings.textarea.tooltips.indent;
                var outdentTooltip = LanguageUtil.strings.textarea.tooltips.outdent;

                LanguageUtil.strings.textarea.tooltips.outdent = indentTooltip;
                LanguageUtil.strings.textarea.tooltips.indent  = outdentTooltip;

                // toggle the display order of indent and outdent
                this._textArea_toolbarControlsHash['indents'].dropDownElements = ["outdent" ,"indent"];
            }

            this.handleToolbarDropDownMenuItem(controlElement,"indents");
        },

        /**
        * SET CURSOR POSITION TO END
        * calls on Paste event.
        *
        * @params : 
        * targetEl = element with contenteditable true
        * selection = document.getSelection()
        */
        setCaretPositionEnd : function (targetEl, selection) {
            var range = document.createRange();

            range.selectNodeContents(targetEl);//Select the entire contents of the element with the range 
            range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start 
            selection.removeAllRanges();//remove any selections already made 
            selection.addRange(range); 
            targetEl && $(targetEl).focus();
        },

        setCursor : function(el,st,end) {
            // console.log("setCursor")
            if (el.setSelectionRange){
                // console.log("setCursor #1 IF")
                el.focus();
                el.setSelectionRange(st,end);
            } else {

                if(el.createTextRange) {
                    // console.log("setCursor #2 IF")
                    var range=el.createTextRange();
                    range.collapse(true);
                    range.moveEnd('character',end);
                    range.moveStart('character',st);
                    range.select();

                } else {
                    // console.log("noLand")
                }
            }
        },

        /**
         * _fontSize -
         * calls when hit "_fontSize" control.
         * create panel (dropdown) and set it's buttons behavior
         *
         * @param controlElement
         */
        _fontSize : function(controlElement){

            var TextArea = this ;

	        var control = jQuery("#" + this.id + "ToolBar [rel=fontSize]").parent();
            var controlLeft = jQuery(control).offset().left;

            if(controlElement.dropDownElements.indexOf((TextArea.style.size).toString()) == -1){  //check if current font size is exists in the font sizes drop down deff
                controlElement.dropDownElements.push((TextArea.style.size).toString());  //insert new font size in to the font sizes array
                controlElement.dropDownElements.sort();                     //sort the font-sizes array
            }

            // get fontSize drop down html
            var dropDownToolbarHTML = this._setTextDropDownMenuHtml(controlElement.dropDownElements);

            // create fontSize panel
            this._createPanel(controlLeft, dropDownToolbarHTML,"dirs");

            jQuery("#" + this.id + "_panel").find("div").each(function(){

                if (jQuery(this).attr("tag")){

                    var rel = jQuery(this).attr("rel");

                    jQuery(this).css("cursor","pointer");

	                function onMouseDown(){
		                jQuery(this).attr("class", rel + "-press");
	                }
                    jQuery(this).mousedown(onMouseDown);

	                function onMouseOver(){
		                var thisClass = jQuery(this).attr("class");
		                jQuery(this).attr("class", thisClass + "-over");
	                }
                    jQuery(this).mouseover(onMouseOver);

	                function onMouseOut(){
		                var thisClass = jQuery(this).attr("class");
		                jQuery(this).attr("class", thisClass.replace("-over", ""));
	                }
                    jQuery(this).mouseout(onMouseOut);

	                function onMouseUp(){
		                TextArea._execCmd("fontSize", jQuery(this).attr("tag"));
		                TextArea._removePanel();
		                var fontSizeSelected = jQuery(this).attr("tag");
		                jQuery("#" + TextArea.id + "ToolBar").find(".fontSizeDisplay").html(fontSizeSelected);
		                jQuery("#" + TextArea.id + "ToolBar [rel=fontSize]").attr("class", "fontSize");
	                }
                    jQuery(this).mouseup(onMouseUp);
                }
            });

	        delete control;
        }
    });
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
    //Function to convert hex format to a rgb color
    function rgb2hex(rgb){
        // make sure that the variable is not in hex ​​format
        if(!rgb.match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/)){
            rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            rgb = "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
        }

        function hex(x) {
            var hexDigits = ["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];
            return isNaN(x) ? "00" : hexDigits[(x - x % 16) / 16] + hexDigits[x % 16];
        }

        return rgb;

    }

    function cancelDefault(e) {
        if (e && e.preventDefault) { e.preventDefault(); }
        if (window.event) { window.event.returnValue =
            false; }
        return false;
    }
})();
////////////////////////////////////////
// SRC End --> t2k/component/textEditor/TextEditorView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textEditor/TextEditor.js
////////////////////////////////////////
(function() {

	t2k.component.textarea.TextEditor = t2k.component.BaseComponent.subClass({
		name: 't2k.component.textarea.TextEditor',

            ctor: function(config) {
                // Delegate
                this._super(config);
                this.configuration = prepareTextEditorConfiguration(config);
                this.configuration.setFontSize = (!!!this.configuration.setFontSize ? this.configuration.optimumFontSize : this.configuration.setFontSize) || 22;
                this.view = this.createNewView(t2k.component.textarea.TextEditorView, this.configuration);
            },
            
            // override 
            setEnabled: function(flag) {
            	//if (flag){
            		this.view.enable(flag);
            	//}
            },

            setMyState : function(state){
                this.view.setMyState(state);
            },

            addMyState : function(){
                var state = this._super();
                return this.view.addMyState(state);
            },

            reduce : function(){
                if (this.configuration.setFontSize > 18) {
                    this.configuration.setFontSize = this.configuration.setFontSize - 1;
                    this.view.remove();
                    // add firstKeyDown to configuration
                    this.view = this.createNewView(t2k.component.textarea.TextEditorView, override(this.configuration, {firstKeyDown: this.view.firstKeyDown}));
                } else {
                    this.layout.canReduce = false;
                    this.layout.onRendered();
                }
            },

        setFirstKeyDownFunction : function(fnc){
            this.view.setFirstKeyDownFunction(fnc);
        }
            
        });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	
function prepareTextEditorConfiguration(config) {
    	
    	// The result object.    
    	var result, textEditorMarkup = '';
    	var textEditorElement = config.data;    

    	if (textEditorElement){

            var container = config.container ? config.container : Perf.select('#' + config.parent).parents('.task_container');

    		// it text editor have init markup
    		if (textEditorElement.textContent || textEditorElement.nodeValue) {
    			textEditorMarkup = jQuery.xmlToString(textEditorElement) || "";
    			textEditorMarkup = textEditorMarkup.substring(textEditorMarkup.indexOf('>') + 1,
                    textEditorMarkup.length - 'textEditor'.length - 3);
    		}

    		var textEditorParam = new t2k.component.textarea.TextEditorViewParams();
    		
    		textEditorParam.id 					= genId();    			
    		textEditorParam.reductionStep 		= config.reductionStep ? config.reductionStep : 0;
    		textEditorParam.optimumFontSize 	= config.optimumFontSize ? config.optimumFontSize : null;
    		textEditorParam.fontColor			= config.fontColor ? config.fontColor : null;
    		textEditorParam.setAnswer			= config.setAnswer;     // function of subAnswer that marks it as answered
    		textEditorParam.width 				= jQuery(textEditorElement).attr('width') || ( (config.widthEm ? (config.widthEm + 'em') : '100%'));
            textEditorParam.maxWidth            = container.width();//limit the maximum size by container
    		textEditorParam.height 				= jQuery(textEditorElement).attr('height') || '';
    		textEditorParam.setClass 			= jQuery(textEditorElement).attr('style') || 'style1';  // CSS ! :)
    		textEditorParam.parentId 			= config.parent;
    		textEditorParam.parent	 			= Perf.select('#' + config.parent);
    		textEditorParam.firstKeyDown 		= config.firstKeyDown;
    		textEditorParam.keyDown 			= config.keyDown;
    		textEditorParam.maxChar 			=  config.maxChar || jQuery(textEditorElement).attr('maxChar');
    		textEditorParam.direction 			= jQuery(textEditorElement).attr('direction') || ENV.contentDirection; 
    		textEditorParam.toolBarPreset 		= jQuery(textEditorElement).attr('toolBarPreset');  // TextAreaToolbarConfig
    		textEditorParam.mode 				= jQuery(textEditorElement).attr('mode');  // t2k.component.textarea.TextAreaModes
    		textEditorParam.enableCharLimit 	= jQuery(textEditorElement).attr('enableCharLimit'); // optional, mode override
    		textEditorParam.enableScrollbar 	= jQuery(textEditorElement).attr('enableScrollbar'); // optional, mode override
            textEditorParam.enableKeyscroll 	= jQuery(textEditorElement).attr('enableKeyscroll') == "true";  // optional, mode override
    		textEditorParam.enableToolbar	 	= jQuery(textEditorElement).attr('enableToolbar');  // optional, mode override    		
    		
    		// text editor state

    		textEditorParam.initText = jQuery.trim(textEditorMarkup);
    		
    		// set the result.
    		result = textEditorParam;
    	} else {
    		result = null;
    	}
    	return result;
    	
    } // End of preparetextEditorConfiguration


})();

////////////////////////////////////////
// SRC End --> t2k/component/textEditor/TextEditor.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textEditor/MiniTextEditorView.js
////////////////////////////////////////
/**
 * TextAreaParams
 * the object that will be received by TextArea's @constructor
 */

t2k.component.textarea.TextEditorViewParams = function() {
    this.id 				= "";
    this.width 				= "";  // size + 'px'
    this.height 			= "";  // size + 'px'
    this.initText 			= "";  // markup
    this.setClass 			= "";  // css
    this.parentId 			= "";
    this.maxChar 			= "";
    this.direction 			= "";  // 'ltr' (default)/ 'rtl'
    this.keyUpFunction 		= "";  // todo: remove
    this.mode 				= "";  // t2k.component.textarea.TextEditorViewModes
    this.enableCharLimit 	= "";  // optional, mode override
    this.enableScrollbar 	= "";  // optional, mode override
    this.enableKeyscroll 	= "";  // optional, mode override
    this.firstKeyDown 		= "";  // callback
};


(function() {

    /**
     * Private: TEMPLATE
     * The Mustache template used by the textEditor view.
     */
    var TEMPLATE = "<div class='miniTextEditor' id='{{id}}'>\
				    		{{#multiLine}}<textarea id='{{id}}_te'></textarea>{{/multiLine}}\
					    	{{^multiLine}}<input id='{{id}}_te' type='text' value='' size='10'>{{/multiLine}}\
			        </div>";

    t2k.component.textarea.MiniTextEditorView = t2k.component.BaseComponentView.subClass({

        /**
         * ctor function
         * @param config
         */
        ctor: function(config) {
            // Delegate.
            this._super(override(config, {
                template: TEMPLATE,
                layout: 'inline',
                multiLine: (config.mode == 'sentence' || config.mode == 'paragraph' || config.mode == 'fullText')
            }));

            this.initMembers(config);

            // set mode params by mode
            this._setModeParams();

            // set initText, direction, keyUp handle, maxChar handle exc..
            this._initTextArea();

            // set Init Style
            this._setInitStyleOnInitTaForInitText();

            // set & check height & width for 'paragraph' or 'fullText' modes
            this._setAndCheckTextareaSizes();
        },

        /**
         * initMembers function
         * @param config
         */
        initMembers : function(config) {
            var TextAreaParams = config;

            // data members
            this.id = TextAreaParams.id;
            this.width = TextAreaParams.width;
            this.maxWidth = TextAreaParams.maxWidth;
            this.height = TextAreaParams.height;
            this.maxChar = TextAreaParams.maxChar;
            this.initText = TextAreaParams.initText;
            this.setAnswer = TextAreaParams.setAnswer;
            this.parentId = TextAreaParams.parentId;
            this.keyUpFunction = TextAreaParams.keyUpFunction;
            this.firstKeyDown = TextAreaParams.firstKeyDown;
            this.removeContent = this._removeContent;
            this._firstKeyPressed = false;
            this._teElement = this._view.children().first();
            this._enable = true;

            this.isMinimunReadable = false;
            this.isAbsoluteMinimun = false;
            this.reductionStepSize = t2k.component.textViewer.TextViewerConstants.reductionStepSize;
            this.reductionStep = (!!this.cfg.reductionStep ? this.cfg.reductionStep : 0);

            if (!this.cfg.dummyMode && !!this.cfg.compiledLayoutRes.reduction){
                this.reductionStep = this.cfg.compiledLayoutRes.reduction;
            }

            this.optimumFontSize = TextAreaParams.optimumFontSize;
            this.setFontSize = TextAreaParams.setFontSize;
            this.fontColor = TextAreaParams.fontColor;

            // get reduction step and set font-size
            if (this.reductionStep > 0) { //if reductionStep > 0, calculate font-size according to it
                var reducedFontSize = this.calcFontSizeByReduction();
                this._view.css('font-size', reducedFontSize + 'px');
            }

            // mode params
            this._displayMaxChar;
            this._enableCharLimit = eval(TextAreaParams.enableCharLimit);
            this._enableScrollbar = TextAreaParams.enableScrollbar;
            this._enableKeyscroll = TextAreaParams.enableKeyscroll;
            this._enableEnter	  = true; // default
            this._mode			  = TextAreaParams.mode;

            //current style according to the css clas
            this.style = null;

            // default direction: ltr
            if (!TextAreaParams.direction) {
                TextAreaParams.direction = "ltr";
            }

            this.direction  = TextAreaParams.direction;

        },

        /**
         * override - set state of component
         * @param state
         */
        setMyState:function (state) {
            this.state = state;
            this.setEnabled(jQuery(state).attr('enabled') === 'true');
            this.replaceContent(jQuery(state).children('initText').text());
        },

        /**
         * override - get state of component
         * @param state
         * @return {*}
         */
        addMyState : function(state){
            var thi$ = this;
            var state = jQuery('<state/>')
                .append(jQuery('<initText/>').text(thi$.getMarkUpValue()));

            return state;
        },

        /**
         * reduce
         * start reduction
         * @param val - reduction value (if null - set 1)
         */
        reduce:function (val) {
            var reducedFontSize = this.calcFontSizeByReduction(val);

            this._view.css('font-size', reducedFontSize + 'px');
            this.dispatchEvent('cantReduce');
            this.dispatchEvent('onRendered');
        },

        /**
         * calcFontSizeByReduction
         * @param val - reduction value (if null - set 1)
         */
        calcFontSizeByReduction : function(val){

            if (this.optimumFontSize != undefined){
                // if val == null set val = 1
                var reductionValue = (val != undefined && val > 0) ? val : 1;
                // add the val to the current reductionStep
                this.reductionStep = this.reductionStep + reductionValue;
                // calc font size by reductionStep
                this.setFontSize = this.optimumFontSize - (this.reductionStep * this.reductionStepSize);
                // if fontSize is less then fontSizeMinReadable
                if (this.setFontSize < t2k.component.textViewer.TextViewerConstants.minimumReadableFontSize){
                    // set fontSize = minimumReadable (not less)
                    this.setFontSize = parseInt(t2k.component.textViewer.TextViewerConstants.minimumReadableFontSize);
                    // min readable flag
                    this.isMinimunReadable = true;
                }
            }
        },

        /**
         * enable -
         * enable or disable textarea
         *
         * @param enabled - boolean value
         */
        enable : function(enabled){
            this._enable = enabled;
            this._teElement.get(0).disabled = !!!enabled;

            //force blur event on input field in order to close soft keyboard of the tablet
            if (!!!enabled) {
                this._teElement.blur();
                this._teElement.focusout();
            }
        },

        /**
         * setFirstKeyDownFunction
         * @param fnc
         */
        setFirstKeyDownFunction : function(fnc){
            this.firstKeyDown = fnc;
        },

        /**
         * _removeContent
         * @private
         */
        _removeContent : function(){
            this._teElement.val('');
        },

        /**
         * replaceContent
         * @param htmlContent
         */
        replaceContent : function(htmlContent){
            var tempSpan = $('<span/>').append(htmlContent);
            this._teElement.val( tempSpan.text() );
        },

        /**
         * getValue function
         * @returns texteditor text
         */
        getValue : function(){
            return this._teElement.val().trim();
        },

        /**
         * getMarkUpValue function
         * @returns texteditor html
         */
        getMarkUpValue : function(){
            return this._teElement.val().trim();
        },

        /**
         * setFirstKeyPressed
         * @param flag
         */
        setFirstKeyPressed : function(flag){
            this._firstKeyPressed = flag;
        },

        /**
         * _beep
         * play the beep
         */
        _beep : function(){
            SOUND.beep();
        },

        /**
         * _setAndCheckTextareaSizes -
         * checks the width & height params for right capacity, only for 'paragraph' or 'fullText' modes.
         * chech min width = 296px and output 'console.log' for exceptions
         * set max width = 720px
         * output 'console.log' msg for error
         * (params use by constant)
         */
        _setAndCheckTextareaSizes : function(){

            var textareaWidth = this._teElement.width();
            var textareaHeight = this._teElement.height();

            if(this.width == '100%'){
                this.width = textareaWidth;  //set actual textarea width in px
            }

            if(this.height == '100%'){
                this.height = textareaHeight;  //set actual textarea width in px
            }

            // max & min width issue
            if (this._mode == 'sentence' || this._mode == 'paragraph' || this._mode == 'fullText'){
                // set max width case the width is greater then the max width
                if (textareaWidth > t2k.component.textarea.TextEditorViewConstants.maxTextAreaWidth){
                    this.width = t2k.component.textarea.TextEditorViewConstants.maxTextAreaWidth + 'px';
                }
            }

            if (this._mode == 'paragraph' || this._mode == 'fullText'){
                var displayMaxChar = this._displayMaxChar;

                var letterWidth  = Math.floor(this.style.size * t2k.component.textarea.TextEditorViewConstants.widthRefrence);
                var letterHeight = Math.floor(t2k.component.textarea.TextEditorViewConstants.fontAspectRatio * letterWidth);

                var currLettersInOneLine = Math.floor(textareaWidth / letterWidth);
                var linesRequire = Math.ceil(displayMaxChar / currLettersInOneLine);
                var heightRequire = (linesRequire * letterHeight) + t2k.component.textarea.TextEditorViewConstants.widthHeightExpansion;

                this.height = heightRequire + 'px';
            }

            this._teElement.width(this.width);
            this._teElement.height(this.height);

	        this._view.width(this.width);
	        this._view.height(this.height);
        },

        /**
         * _getStyleClass -
         * find css class rules based on css class name
         * @param document, className - current textEditor class name
         */
        _getStyleClass : function (document, className) {

            var styleSheet = null;
            var rule = null;
            jQuery.each(document.context.styleSheets, function(i, styleObj){
                if(!!styleObj.href && !!styleObj.href.match(/textEditor.css$/)){
                    styleSheet =  styleObj;
                }
            });

            // Check if browser uses [rules] - cssStyleRule object
            var rules;
            if (styleSheet && styleSheet.rules){
                rules = styleSheet.rules;
            }

            // Check if browser uses [cssRules]
            if (styleSheet && styleSheet.cssRules){
                rules = styleSheet.cssRules;
            }

            // Check if browser supports css rules
            if (rules){
                // Loop rules in css stylesheet
                jQuery.each(rules, function(i, ruleObj){
                    if(ruleObj.selectorText == className){
                        rule = ruleObj;
                    }
                });
            }

            return rule;
        },

        /**
         * _setModeParams
         * set the mode params by mode
         */
        _setModeParams : function(){

            var currMode = t2k.component.textarea.TextEditorViewModes[this._mode];

            this._displayMaxChar = currMode.displayMaxChar;
            if (this._displayMaxChar == null || this._displayMaxChar == 'undefined'){
                this._displayMaxChar = '';
            }

            if (this.maxChar){
                this._displayMaxChar = this.maxChar;
            }

            // set maxChar 'word' mode
            if (this._mode == "word"){
                if(parseInt(this.maxChar) > parseInt(currMode.maxDisplayMaxChar)) {
                    this._displayMaxChar = currMode.maxDisplayMaxChar;
                } else {
                    if(parseInt(this.maxChar) < parseInt(currMode.minDisplayMaxChar)) {
                        this._displayMaxChar = currMode.minDisplayMaxChar;
                    }
                }
            }

            /**
             * TODO: there are potentially many more bugs here related to automatic type casting.
             * In JavaScript, (false == '') is true, so please use === operator.  -- Mark V.
             */
            if (typeof this._enableCharLimit != 'boolean') {
                this._enableCharLimit = currMode.charLimit;
            }

            this.maxChar = this._enableCharLimit? parseInt(this._displayMaxChar): 5000;

            if(!!this.maxChar) {
                this._teElement.attr('maxlength', this.maxChar);
            }

            if ((this._enableScrollbar != true && this._enableScrollbar != false) || (this._enableScrollbar == '' && this._enableScrollbar != true && this._enableScrollbar != false) ){
                this._enableScrollbar = currMode.scrollBar;
            }

            if ((this._enableKeyscroll != true && this._enableKeyscroll != false) || this._enableKeyscroll ==''){
                this._enableKeyscroll = currMode.keyScroll;
            }

            this._enableEnter = currMode.enableEnter;

            // set currStyle by constructor
            var currStyle = this.setClass;

            // if the constructor doesn't provide any style, use the default style
            if (currStyle == null || currStyle == ''){
                currStyle = t2k.component.textarea.TextEditorViewConstants.defaultCssClass;
            }

            var cssRule = this._getStyleClass(jQuery('document'), '.ta .' +currStyle);
            if(cssRule){
                this._ruleToStyle(cssRule);
            }

            // if currMode.width is "fixByStyle", set width by 'displayMaxChar'
            // on 'word' mode, set with with 'widthRefrence' to reducr 'word' width
            if (currMode.width){
                if (this._mode == "word"){
                    this.width = (this.style.size * t2k.component.textarea.TextEditorViewConstants.widthRefrence * this._displayMaxChar) + "px";
                } else {
                    this.width = (this.style.size * currMode.displayMaxChar) + t2k.component.textarea.TextEditorViewConstants.widthHeightExpansion + "px";
                }
            }

            if (currMode.height){
                this.height = (Math.floor(t2k.component.textarea.TextEditorViewConstants.fontAspectRatio * this.style.size)) + t2k.component.textarea.TextEditorViewConstants.widthHeightExpansion + "px";
            }

            // set maxChar = 350 for sentence to avoid forced enter
            if (this._mode == "sentence"){
                this.maxChar = 350;
            }

            // set maxChar = 1 for 'letter' mode
            if (this._mode == "letter"){
                this.maxChar = 1;
            }

            // 'letter' mode exception - init text should be one letter or less
            if (this._enableCharLimit == true){
                var initTextTempDiv = jQuery("<div></div>").html(this.initText);
                var initTextStr = jQuery(initTextTempDiv).text() ;

                if (initTextStr.length > this.maxChar){
                    this.initText = initTextStr.substring(0, this.maxChar);
                }
            }

        },

        /**
         * _setInitStyleOnInitTaForInitText -
         * calls only once, at init.
         * textArea style implementation for initText.
         * write the relevant markup and 'psate' it to the textArea's body
         */
        _setInitStyleOnInitTaForInitText : function(){
            // get textArea style
            var style = this.setClass;

            if (style){

                // check for font tag requirement
                if (this.style.font || this.style.size || this.style.color){

                    if (this.style.font){
                        this._teElement.css('font-family', this.style.font);
                    }

                    if (this.style.size){
                        this._teElement.css('font-size', this.style.size + "px'");
                    }

                    if (this.style.color){
                        this._teElement.css('color', this.style.color);
                    }

                }
            }
        },

        // Recover style for the body element
        setTeElementStyle : function(){
            var tmpObjStyle = {};

            if (this.style.font){
                tmpObjStyle['font-family'] = this.style.font;
            }
            if (this.style.size){
                tmpObjStyle['font-size'] = this.style.size + 'px';
            }
            if (this.style.color){
                tmpObjStyle['color'] = this.style.color;
            }

            this._teElement.css(tmpObjStyle);

        },

        /**
         * _innocentKeyDown -
         * check if 'innocent key' down (pressed)
         * innocent key is a key that doesn't increase the ta char's sum
         * the range beween 32-41 (33,34,35,36,37,38,39,40) is the arrows, home, end, pgUp, pgDn.
         * 46 & 46 are insert and delete
         * 8 is backspace
         *
         * @param keyCode
         *
         * @returns true or false (is innocent down - returns true)
         */
        _innocentKeyDown : function(keyCode){

            var ret = false;

            if ((keyCode > 32 && keyCode < 41) || keyCode == 45 || keyCode == 46 || keyCode == 8 || keyCode == 13){
                ret = true;
            }

            return ret;
        },

        /**
         * _initTextArea -
         * set initText, direction, keyUp handle, maxChar handle exc..
         */
        _initTextArea : function() {

            var maxChar = parseInt(this.maxChar),
                isMaxChar = false,
                setInitStyle = false,
                tempTextAreaText,
                thi$ = this,
                bodyElement_inlineStyle = {"overflow-x":"hidden"};// set overflow-x for all browsers

            if (ENV.behaviors.isIE){
                bodyElement_inlineStyle["display"] = "inline-block";
            }

            // set body CSS according to the current style
            if (this.style){

                if (this.style.font){
                    this._teElement.css("font-family", this.style.font);

                    merge(bodyElement_inlineStyle, {
                        'font-family':this.style.font,
                        'font':this.style.font
                    });

                } else {
                    bodyElement_inlineStyle["font-family"] = this.style.font;
                }
                if (this.style.size){
                    bodyElement_inlineStyle["font-size"] = this.style.size + 'px';
                }
                if (this.style.color){
                    bodyElement_inlineStyle["color"] = this.style.color;
                }
            }

            // on scroll control, scrollTo visible position, on focus
            if (ENV.behaviors.scrollControl) {
                this.inFocus = false;
                this.scrollTop = 0;

                this._teElement.bind('focus', function (e) {  //bind it to keypress in order to get this work on android 3
                    if (!thi$.inFocus) {
                        thi$.scrollTop = (ScrollControl.getMarginTop() - ScrollControl.Y + 190);
                        ScrollControl.forceScrollTop(thi$.scrollTop);
                    }

//                    console.log('_teElement focus' + document.activeElement.getAttribute('id'))
                    thi$.inFocus = true;
                });

                this._teElement.bind('blur focusout', function (e) {
                    thi$.inFocus = false;
                });
            } else {
	            this.inFocus = false;
	            this.scrollTop = 0;

	            this._teElement.bind('focus', function (e) {
		            if (!thi$.inFocus) {
                        window.scrollTo(0,0);
			            //scroll to top of texteditor
		            }

		            thi$.inFocus = true;
	            });

	            this._teElement.bind('blur focusout', function (e) {
		            thi$.inFocus = false;
	            });

            }

            /**
             * this._teElement keyDown
             * handle undo/redo hotkeys and start handle maxChar issue
             */
            this._teElement.keydown(function(e){

                var keyCode = (e.keyCode ? e.keyCode : e.which);

                // if enter is disabled - prevent default
                if (keyCode == 13 && thi$._enableEnter == false) {
                    thi$._teElement.blur();
                    thi$._teElement.focusout();
                    thi$._beep();

                    cancelDefault(e);
                    return false;
                }

                // handle space in keyScroll
                if (keyCode == 32 && thi$._enableKeyscroll == true && ENV.behaviors.isIE){
                    cancelDefault(e);
                    return false;
                }

                if(typeof thi$.setAnswer == 'function' && keyCode == 17 ){
                    thi$._ctrlDown = false;
                    cancelDefault(e);
                    return false;
                } else if (keyCode == 17){ // ctrl down will save it's state at this._ctrlDown
                    thi$._ctrlDown = true;
                    return false;
                }

                // disable space(32) and tab(9) at 'letter' mode
                if ((thi$._mode == 'letter' && keyCode == 32) || (thi$._mode == 'letter' && keyCode == 9)){
                    cancelDefault(e);
                    return false;
                }

                // disable 'capsLock' (20) or 'alt' (18) or 'shift' (16)
                if (keyCode == 20 || keyCode == 18 || keyCode == 16){
                    cancelDefault(e);
                    return false;
                }

                // save the textArea inner html. if maxChar, "keyUp" will replace the inner html to tempTextAreaText
                tempTextAreaText = thi$.getMarkUpValue();
                var textAreaCharsLength = thi$.getValue().length;
                thi$.cancelInput = false;

                // if inserted text length is larger the maxchar allowed - prevent keydown event and beep
                if (textAreaCharsLength > maxChar) {
                    // only if ctrl is down and nothing is selected, allow only innocent chars. else, set isMaxChar = true
                    // and continue the handle with keyUp
                    if (!e.ctrlKey && thi$._getSelectedValue() == '') {
                        // if the keDown is not innocent (one that will increase the char num)
                        if (!thi$._innocentKeyDown(keyCode)) {
//                            console.log('textAreaCharsLength=' + textAreaCharsLength + ' maxChar=' + maxChar + ' keyCode=' + keyCode + ' e.button=' + e.button);
                            thi$.cancelInput = true;
                            cancelDefault(e);
                            thi$._beep();
                            return false;
                        }

                    } else {
                        isMaxChar = true;
                    }
                }

            });
            
            /**
             * this._teElement paste -
             * check max char on paste
             */
            this._teElement.bind('paste', function(e) {

                //* Process browser events, then update pasted text. *//
                window.setTimeout(function(e) {
                	
                    var PastedTxt = thi$.getValue(),
                        maxVal = parseInt(thi$.maxChar,10);

                    if (PastedTxt.length > maxVal){
                        thi$._beep();
                    }

                    PastedTxt = PastedTxt.substring(0, maxVal);
                    thi$._teElement.val( PastedTxt );

                    thi$.setTeElementStyle();

                }, 0);
            });
            
            // TODO: duplicate
                    
            /**
             * this._teElement selectstart -
             * check max char on paste
             */
            this._teElement.bind('selectstart', function(){
            	 //* Process browser events, then update pasted text. *//
                window.setTimeout(function(e) {

                    var PastedTxt = thi$._teElement.val(),
                        maxVal = parseInt(thi$.maxChar,10);

                    if (PastedTxt.length > maxVal){
                        PastedTxt = PastedTxt.substring(0, maxVal);
                        thi$._teElement.val('');
                        thi$._beep();
                    }

                    thi$.setTeElementStyle();

                }, 0);
            });

            /**
             * this._teElement keyUp -
             * finish handle the hotkeys
             * finish handle maxChar issue
             * fire constructor's keyUpFunction
             * set selected controls
             * disable redo if textArea is at "undoMode" (means that undo pressed, and redo is enable)
             */

            this._teElement.keyup(function(e){
                var keyCode = (e.keyCode ? e.keyCode : e.which);

                thi$.setTeElementStyle();

                if(thi$.cancelInput) {
                    return;
                }

                // first key down issue -
                // on the first key down, call
                if (!thi$._firstKeyPressed && (!thi$._innocentKeyDown(keyCode) || keyCode == 8)){
	                thi$.setAnswer && thi$.setAnswer.call(thi$, true);

	                thi$.firstKeyDown && thi$.firstKeyDown.call(thi$);

                    thi$._firstKeyPressed = true;
                }

                //textEditor is part of progression
                if(typeof thi$.setAnswer == 'function' && !!thi$._firstKeyPressed){
                    var textAreaCharsLength = thi$.getValue().length;
                    //check for deleting all content
                    if(textAreaCharsLength == 0){
                        thi$.setAnswer.call(thi$, false);
                    } else {
                        thi$.setAnswer.call(thi$, true);
                    }

                    if(thi$.firstKeyDown){
                        thi$.firstKeyDown.call(thi$);
                    }
                }

                thi$._setInitStyleOnInitTaForInitText();

                // fire keyUpFunction
                var keyUpFunction = thi$._teElement.attr("keyUpFunction");

                if(keyUpFunction){
                    eval(keyUpFunction);
                }
            });

            // letter mode exception - set center alignment for the iframe
            if (this._mode == "letter"){
                bodyElement_inlineStyle["text-align"] = "center";
            }

            // keyscroll issue
            if (this._enableKeyscroll){
                this.maxChar = "300";
            } else {
                // if keyScroll is disables, force line breakes (that's cancel the h. scroll)
                bodyElement_inlineStyle["word-wrap"]= "break-word";
            }

            this._teElement.css(bodyElement_inlineStyle);

        },

        /**
         * _ruleToStyle -
         * get the cssRule object and set this.style according to it
         *
         * @param body - cssRule element
         */
        _ruleToStyle : function(cssRule)
        {
            this.style =  {
                bold 		: cssRule.style.fontWeight == 'bold',
                italic 		: cssRule.style.fontStyle == 'italic',
                underline 	: cssRule.style.textDecoration == 'underline',

                font      	:  cssRule.style.fontFamily,
                size 		: (typeof this.setFontSize != 'undefined') ? this.setFontSize : cssRule.style.fontSize,
                color		: cssRule.style.color
            };

            if(this.style.size != '' && this.style.size != null)
                this.style.size = parseInt(this.style.size);  //remove px
            else
                this.style.size = this.optimumFontSize || 22;

            if(this.fontColor){
                this.style.color = this.fontColor;
            } else if(this.style.color != '' && this.style.color != null)
                this.style.color = rgb2hex(this.style.color);  //convert color in rgb format to hex format
            else
                this.style.color = '#000000';

            if(this.style.font == null){
                this.style.font = '';
            }
        },

        /**
         * _getSelectedValue -
         * find the selected html by range
         *
         * @return selectedHTML
         */
        _getSelectedValue : function() {
            var selectedText = (this._teElement.val()).substring(this._teElement.get(0).selectionStart, this._teElement.get(0).selectionEnd);
            return selectedText;
        },

        /**
         * _replaceSelectionWith -
         * delete the current selection and paste "textToReplace" instead
         *
         * @param textToReplace
         * @return true/false
         */
        _replaceSelectionWith : function(textToReplace){
            var len = this._teElement.get(0).value.length;
            var start = this._teElement.get(0).selectionStart;
            var end = this._teElement.get(0).selectionEnd;
            var selection = this._teElement.get(0).value.substring(start, end);

            var ret = true;

            if (!!selection) {
                this._teElement.get(0).value.substring(0, start) + textToReplace + this._teElement.get(0).value.substring(end, len);
            } else {
                ret = false;
            }

            return ret;
        },

        /**
         * _setDirection -
         * set the TA's body dir, and handle the indend margin issue
         *
         * @param controlElement
         */
        _setDirection : function (controlElement) {

            this._teElement.css("direction",controlElement.dir);

        }
    });
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    /**
     * rgb2hex Function to convert hex format to a rgb color
     * @param rgb
     * @return {String}
     */
    function rgb2hex(rgb){
        rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        return "#" +
            ("0" + parseInt(rgb[1],10).toString(16)).slice(-2) +
            ("0" + parseInt(rgb[2],10).toString(16)).slice(-2) +
            ("0" + parseInt(rgb[3],10).toString(16)).slice(-2);
    }

    /**
     * cancelDefault
     * @param e
     */
    function cancelDefault(e) {
        if (!e)
            e = window.event;

        if (e.preventDefault) {
            e.preventDefault();
        }

        e.returnValue = false;
    }
})();
////////////////////////////////////////
// SRC End --> t2k/component/textEditor/MiniTextEditorView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/textEditor/MiniTextEditor.js
////////////////////////////////////////
(function() {

	t2k.component.textarea.MiniTextEditor = t2k.component.BaseComponent.subClass({
		name: 't2k.component.textarea.MiniTextEditor',

        /**
         * ctor
         * @param config
         */
        ctor:function (config) {
            // Delegate
            this._super(config);
            this.configuration = prepareTextEditorConfiguration(config);
            this.configuration.setFontSize = (!!!this.configuration.setFontSize ? this.configuration.optimumFontSize : this.configuration.setFontSize) || 22;
            this.view = this.createNewView(t2k.component.textarea.MiniTextEditorView, this.configuration);
        },

        /**
         * setEnabled
         * @param flag
         */
        setEnabled:function (flag) {
            //if (flag){
            this.view.enable(flag);
            //}
        },

        /**
         * setMyState
         * @param state
         */
        setMyState:function (state) {
            this.view.setMyState(state);
        },

        /**
         * addMyState
         * @return {*}
         */
        addMyState:function () {
            var state = this._super();
            return this.view.addMyState(state);
        },

        /**
         * reduce
         * @param val
         */
        reduce:function (val) {
            this.view.reduce(val);
        },

        /**
         * setFirstKeyDownFunction
         * @param fnc
         */
        setFirstKeyDownFunction:function (fnc) {
            this.view.setFirstKeyDownFunction(fnc);
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	
function prepareTextEditorConfiguration(config) {
    	
    	// The result object.    
    	var result, textEditorMarkup = '';
    	var textEditorElement = config.data;    

    	if (textEditorElement){

            var container = config.container ? config.container : Perf.select('#' + config.parent).parents('.task_container');

    		// it text editor have init markup
    		if (textEditorElement.textContent || textEditorElement.nodeValue) {
    			textEditorMarkup = jQuery.xmlToString(textEditorElement);
    			textEditorMarkup = textEditorMarkup.substring(textEditorMarkup.indexOf('>') + 1,
                    textEditorMarkup.length - 'textEditor'.length - 3);
    		}

    		var textEditorParam = new t2k.component.textarea.TextEditorViewParams();
    		
    		textEditorParam.id 					= genId();    			
    		textEditorParam.reductionStep 		= config.reductionStep ? config.reductionStep : 0;
    		textEditorParam.optimumFontSize 	= config.optimumFontSize ? config.optimumFontSize : null;
    		textEditorParam.fontColor			= config.fontColor ? config.fontColor : null;
    		textEditorParam.setAnswer			= config.setAnswer;     // function of subAnswer that marks it as answered 
    		textEditorParam.width 				= jQuery(textEditorElement).attr('width') || '100%';
            textEditorParam.maxWidth            = container.width();//limit the maximum size by container
    		textEditorParam.height 				= jQuery(textEditorElement).attr('height') || '';
    		textEditorParam.setClass 			= jQuery(textEditorElement).attr('style') || 'style1';  // CSS ! :)
    		textEditorParam.parentId 			= config.parent;
    		textEditorParam.parent	 			= Perf.select('#' + config.parent);
    		textEditorParam.firstKeyDown 		= config.firstKeyDown;
    		textEditorParam.keyDown 			= config.keyDown;
    		textEditorParam.maxChar 			= jQuery(textEditorElement).attr('maxChar') || config.maxChar;
    		textEditorParam.direction 			= jQuery(textEditorElement).attr('direction') || ENV.contentDirection; 
    		textEditorParam.toolBarPreset 		= jQuery(textEditorElement).attr('toolBarPreset');  // TextAreaToolbarConfig
    		textEditorParam.mode 				= jQuery(textEditorElement).attr('mode');  // t2k.component.textarea.TextAreaModes
    		textEditorParam.enableCharLimit 	= jQuery(textEditorElement).attr('enableCharLimit'); // optional, mode override
    		textEditorParam.enableScrollbar 	= jQuery(textEditorElement).attr('enableScrollbar'); // optional, mode override
            textEditorParam.enableKeyscroll 	= jQuery(textEditorElement).attr('enableKeyscroll') == "true";  // optional, mode override

    		// text editor state
    		
    		textEditorParam.initText = jQuery.trim(textEditorMarkup);
    		
    		// set the result.
    		result = textEditorParam;
    	} else {
    		result = null;
    	}
    	return result;
    	
    } // End of preparetextEditorConfiguration


})();

////////////////////////////////////////
// SRC End --> t2k/component/textEditor/MiniTextEditor.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mathField/MathFieldLocaleConfig.js
////////////////////////////////////////
(function () {
	t2k.component.mathField.MathFieldLocaleConfig = {
		fullMathField:{
			fr_FR:[
				{
					key:{name:'angle_geometry'},
					action:'replace',
					tabIndex:1,
					boxIndex:0,
					lineIndex:0,
					keyIndex:0
				},
				{
					key:{name:'euro'},
					action:'replace',
					tabIndex:0,
					boxIndex:4,
					lineIndex:3,
					keyIndex:0
				}

			],
			nl_NL:[
				{
					key:{name:'euro'},
					action:'replace',
					tabIndex:0,
					boxIndex:4,
					lineIndex:3,
					keyIndex:0
				},
				{
					key:{name:'ratio'},
					action:'remove',
					tabIndex:0,
					boxIndex:1,
					lineIndex:2,
					keyIndex:1
				}
			]
		},
		contentEditorMathField:{
			fr_FR:[
				{
					key:{name:'angle_geometry'},
					action:'replace',
					tabIndex:1,
					boxIndex:2,
					lineIndex:1,
					keyIndex:0
				},
				{
					key:{name:'euro'},
					action:'replace',
					tabIndex:1,
					boxIndex:0,
					lineIndex:1,
					keyIndex:0
				}

			],
			en_US: [
				{
					key:{name:'angle_geometry'},
					action:'remove',
					tabIndex:1,
					boxIndex:0,
					lineIndex:2
				},
				{
					key:{name:'dollar'},
					action:'replace',
					tabIndex:1,
					boxIndex:0,
					lineIndex:1,
					keyIndex:0
				}
			],
			nl_NL:[
				{
					key:{name:'euro'},
					action:'replace',
					tabIndex:0,
					boxIndex:4,
					lineIndex:3,
					keyIndex:0
				},
				{
					key:{name:'ratio'},
					action:'remove',
					tabIndex:0,
					boxIndex:1,
					lineIndex:2,
					keyIndex:1
				}
			]
		}
	};
})();
////////////////////////////////////////
// SRC End --> t2k/component/mathField/MathFieldLocaleConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mathField/MathFieldConfig.js
////////////////////////////////////////
(function () {

    /**
     * MathField Config
     */
    t2k.component.mathField.MathFieldConfig = {

        /**
         * keyboardGroupControls
         * this object contains control groups,
         * so MF would be able to disable a group of controls
         */
        keyboardGroupControls:{

            digits:'zero,one,two,three,four,five,six,seven,eight,nine',

            thousandsSeparator:'comma,space',

            geometryStructures:'segment,rayRight,rayBoth,angle_geometry',

            minusSign:'minusSign',

            operators:'plus,minus,multiplication,multiplicationX,multiplicationDot,division,minusSign',

            relations:'equal,notEqual,smaller,bigger,smallerEqual,biggerEqual,approximately,similarity,congruence',

            grouping:'leftParenthesis,rightParenthesis,leftSquareBracket,rightSquareBracket',

            divisionAndProportion:'percent,point,remainder',

            remainder:'remainder',

            longDivision:'longDivision',

            absolute:'absolute',

            shapes:'triangleShape,doodleShape,squareShape,diamondShape,circleShape,ellipseShape',

            capitalLetters:'capitalA,capitalB,capitalC,capitalD,capitalE,capitalF,capitalG,capitalH,capitalI,capitalJ,capitalK,capitalL,capitalM,capitalN,capitalO,capitalP,capitalQ,capitalR,capitalS,capitalT,capitalU,capitalV,capitalW,capitalX,capitalY,capitalZ,small',

            smallLetters:'smallA,smallB,smallC,smallD,smallE,smallF,smallG,smallH,smallI,smallJ,smallK,smallL,smallM,smallN,smallO,smallP,smallQ,smallR,smallS,smallT,smallU,smallV,smallW,smallX,smallY,smallZ,caps',

            geometrySigns:'angle,triangle,pi,parallel,orthogonal,degree',

            units:'celsius,fahrenheit,dollar,euro,cent',

            system:'arrowLeft,arrowUp,arrowRight,arrowDown,del,backspace'

        },

        correctnessValidationMathString:[
            '==', '>', '<', '!=', '<=', '>='
        ],

        validationGroup:{

            zero:'digits',
            one:'digits',
            two:'digits',
            three:'digits',
            four:'digits',
            five:'digits',
            six:'digits',
            seven:'digits',
            eight:'digits',
            nine:'digits',

            plus:'operators',
            minus:'operators',
            multiplication:'operators',
            multiplicationX:'operators',
            multiplicationDot:'operators',
            division:'operators',
            ratio:'operators',
            minusSign:'minusSign',

            equal:'relations',
            notEqual:'relations',
            smaller:'relations',
            bigger:'relations',
            smallerEqual:'relations',
            biggerEqual:'relations',
            approximately:'relations',
            similarity:'relations',
            congruence:'relations',

            leftParenthesis:'openingParenthesis',
            leftSquareBracket:'openingSquareParenthesis',

            rightParenthesis:'closingParenthesis',
            rightSquareBracket:'closingSquareParenthesis',

            point:'decimalPoint',

            comma:'thousandsComma',
	        space:'thousandsComma',

            percent:'percent',

            remainder:'remainder',

            absolute:'absolute',

            triangleShape:'variables',
            doodleShape:'variables',
            squareShape:'variables',
            diamondShape:'variables',
            circleShape:'variables',
            ellipseShape:'variables',
            capitalA:'variables',
            capitalB:'variables',
            capitalC:'variables',
            capitalD:'variables',
            capitalE:'variables',
            capitalF:'variables',
            capitalG:'variables',
            capitalH:'variables',
            capitalI:'variables',
            capitalJ:'variables',
            capitalK:'variables',
            capitalL:'variables',
            capitalM:'variables',
            capitalN:'variables',
            capitalO:'variables',
            capitalP:'variables',
            capitalQ:'variables',
            capitalR:'variables',
            capitalS:'variables',
            capitalT:'variables',
            capitalU:'variables',
            capitalV:'variables',
            capitalW:'variables',
            capitalX:'variables',
            capitalY:'variables',
            capitalZ:'variables',
            smallA:'variables',
            smallB:'variables',
            smallC:'variables',
            smallD:'variables',
            smallE:'variables',
            smallF:'variables',
            smallG:'variables',
            smallH:'variables',
            smallI:'variables',
            smallJ:'variables',
            smallK:'variables',
            smallL:'variables',
            smallM:'variables',
            smallN:'variables',
            smallO:'variables',
            smallP:'variables',
            smallQ:'variables',
            smallR:'variables',
            smallS:'variables',
            smallT:'variables',
            smallU:'variables',
            smallV:'variables',
            smallW:'variables',
            smallX:'variables',
            smallY:'variables',
            smallZ:'variables'
        },

        validationConstrains:{

            digits:{
                symbols:{
                    openingParenthesis:false,
                    openingSquareParenthesis:false,
                    absolute:false,
                    minusSign:false
                }
            },

            operators:{
                symbols:{
                    operators:false,
                    minusSign:false,
                    relations:false,
                    closingParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false
                },

                structures:{
                    power:false,
                    remainder:false
                },

                logic:{
                    first:false,
                    last:false
                }
            },

            minusSign:{
                symbols:{
                    operators:false,
                    relations:false,
                    closingParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    minusSign:false
                },

                structures:{
                    power:false,
                    remainder:false
                },

                logic:{
                    last:false
                }
            },

            relations:{
                symbols:{
                    operators:false,
                    relations:false,
                    closingParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false
                },

                structures:{
                    power:false,
                    remainder:false
                },

                logic:{
                    first:false,
                    last:false
                }
            },

            openingParenthesis:{
                symbols:{
                    operators:false,
                    relations:false,
                    closingParenthesis:false,
                    openingSquareParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false
                },

                structures:{
                    power:false,
                    remainder:false
                },

                logic:{
                    last:false
                }
            },

            closingParenthesis:{
                symbols:{
                    digits:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    remainder:false,
                    fraction:false
                },

                logic:{
                    first:false
                }

            },

            openingSquareParenthesis:{
                symbols:{
                    operators:false,
                    relations:false,
                    closingParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false
                },

                structures:{
                    power:false,
                    remainder:false
                },

                logic:{
                    last:false
                }
            },

            closingSquareParenthesis:{
                symbols:{
                    digits:false,
                    closingParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    remainder:false,
                    fraction:false
                },

                logic:{
                    first:false
                }
            },

            decimalPoint:{
                symbols:{
                    operators:false,
                    relations:false,
                    openingParenthesis:false,
                    closingParenthesis:false,
                    openingSquareParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    power:false,
                    fraction:false,
                    remainder:false
                },

                logic:{
                    first:false,
                    last:false
                }

            },

            thousandsComma:{
                symbols:{
                    operators:false,
                    relations:false,
                    openingParenthesis:false,
                    closingParenthesis:false,
                    openingSquareParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    power:false,
                    fraction:false,
                    remainder:false
                },

                logic:{
                    first:false,
                    last:false
                }

            },

            power:{
                symbols:{
                    digits:false,
                    openingParenthesis:false,
                    openingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    minusSign:false,
                    absolute:false
                },

                structures:{
                    power: false,
                    fraction:false,
                    remainder:false
                },

                logic:{
                    first:false
                }
            },

            fraction:{
                symbols:{
                    digits:false,
                    openingParenthesis:false,
                    openingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    power:false,
                    fraction:false,
                    remainder:false
                }
            },

            percent:{
                symbols:{
                    digits:false,
                    openingParenthesis:false,
                    openingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    power:false,
                    fraction:false,
                    remainder:false
                },

                logic:{
                    first:false
                }
            },

            remainder:{
                symbols:{
                    digits:false,
                    operators:false,
                    minusSign:false,
                    relations:false,
                    openingParenthesis:false,
                    closingParenthesis:false,
                    openingSquareParenthesis:false,
                    closingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false
                },

                structures:{
                    power:false,
                    fraction:false,
                    remainder:false
                },

                logic:{
                    first:false
                }
            },

            variables:{
                symbols:{
                    digits:false,
                    openingParenthesis:false,
                    openingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    fraction:false
                }

            },

            absolute:{
                symbols:{
                    digits:false,
                    openingParenthesis:false,
                    openingSquareParenthesis:false,
                    decimalPoint:false,
                    thousandsComma:false,
                    percent:false,
                    variables:false,
                    absolute:false,
                    minusSign:false
                },

                structures:{
                    fraction:false,
                    remainder:false
                }
            }

        },


//        PROTOTYPE:
//        digits : {
//                symbols : {
//                    digits              : true,
//                    operators           : true,
//                    minusSign           : true,
//                    relations           : true,
//                    openingParenthesis  : true,
//                    closingParenthesis  : true,
//                    decimalPoint        : true,
//                    thousandsComma      : true,
//                    percent             : true,
//                    variables           : true
//                },
//
//                structures : {
//                    power               : true,
//                    fraction            : true,
//                    remainder           : true
//                },
//
//                logic : {
//                    first               : true,
//                    last                : true
//                }
//            }

        appendType:{
            'before':0,
            'after':1,
            'intoLast':2,
            'intoFirst':3
        },

        maxHeight:{
            defaultValue:'basic',
            basic:'0.8em',
            dynamic:'0.8em',
            firstLevel:'1em',
            secondLevel:'2em',
            thirdLevel:'3em',
            fourthLevel:'4em'
        },

        /**
         * mathTypeKeyboardDisable
         * this object contains a structure [key], and groups controls [value],
         * so MF would be able to disable group of controls by the structure value
         */
        mathTypeKeyboard:{

            fraction:{
                enable:false,
                groups:['geometryStructures', 'relations', 'remainder', 'longDivision'],
                charLimit:false,
                minChar:1
            },

            segment:{
                enable:true,
                groups:['capitalLetters', 'smallLetters', 'system'],
                charLimit:2,
                minChar:2
            },

            rayBoth:{
                enable:true,
                groups:['capitalLetters', 'smallLetters', 'system'],
                charLimit:2,
                minChar:2
            },

            rayRight:{
                enable:true,
                groups:['capitalLetters', 'smallLetters', 'system'],
                charLimit:2,
                minChar:2
            },

	        angle_geometry: {
		        enable:true,
		        groups:['capitalLetters', 'smallLetters', 'system'],
		        charLimit:3,
		        minChar:1
	        },

            power:{
                enable:false,
                groups:['geometryStructures', 'remainder', 'longDivision', 'relations'],
                charLimit:false,
                minChar:1
            },

            remainder:{
                enable:true,
                groups:['digits', 'system'],
                charLimit:false,
                minChar:1
            },

            longDivision:{
                enable:true,
                groups:['digits', 'system'],
                charLimit:false,
                minChar:1
            },

            absolute:{
                enable:false,
                groups:['geometryStructures', 'remainder', 'percent', 'relations'],
                charLimit:false,
                minChar:1
            },

            mathFieldCompletion:true,

            completion:{

                A:{
                    enable:false,
                    groups:[],
                    charLimit:false,
                    minChar:1
                },

                E:{
                    enable:false,
                    groups:['relations'],
                    charLimit:false,
                    minChar:1
                },

                O:{
                    enable:true,
                    groups:['operators', 'system'],
                    charLimit:1,
                    minChar:1
                },

                D:{
                    enable:true,
                    groups:['digits', 'system'],
                    charLimit:1,
                    minChar:1
                },

                W:{
                    enable:true,
                    groups:['digits', 'thousandsSeparator', 'capitalLetters', 'smallLetters', 'system'],
                    charLimit:false,
                    minChar:1
                },

                Q:{
                    enable:true,
                    groups:['relations', 'system'],
                    charLimit:1,
                    minChar:1
                }

            }

        },

        /**
         * prototypeControlsHash -
         * master hash for keyboard's controls.
         * the keyboard's preset that delivers to MF will get this hash arguments according to preset's controls.
         */
        prototypeControlsHash:{

            zero:{
                type:"number",
                insertFnc:"insertSymbol('zero');",
                symbol:"0"
            },

            one:{
                type:"number",
                insertFnc:"insertSymbol('one');",
                symbol:"1"
            },

            two:{
                type:"number",
                insertFnc:"insertSymbol('two');",
                symbol:"2"
            },

            three:{
                type:"number",
                insertFnc:"insertSymbol('three');",
                symbol:"3"
            },

            four:{
                type:"number",
                insertFnc:"insertSymbol('four');",
                symbol:"4"
            },

            five:{
                type:"number",
                insertFnc:"insertSymbol('five');",
                symbol:"5"
            },

            six:{
                type:"number",
                insertFnc:"insertSymbol('six');",
                symbol:"6"
            },

            seven:{
                type:"number",
                insertFnc:"insertSymbol('seven');",
                symbol:"7"
            },

            eight:{
                type:"number",
                insertFnc:"insertSymbol('eight');",
                symbol:"8"
            },

            nine:{
                type:"number",
                insertFnc:"insertSymbol('nine');",
                symbol:"9"
            },

            pi:{
                type:"number",
                insertFnc:"insertSymbol('pi');",
                symbol:"\u2020",
                mathValue:3.14  //3.141592653589793
            },

            triangleShape:{
                type:"shape",
                insertFnc:"insertSymbol('triangleShape');",
                symbol:"\u2018"
            },

            doodleShape:{
                type:"shape",
                insertFnc:"insertSymbol('doodleShape');",
                symbol:"\u2015"
            },

            squareShape:{
                type:"shape",
                insertFnc:"insertSymbol('squareShape');",
                symbol:"\u2016"
            },

            diamondShape:{
                type:"shape",
                insertFnc:"insertSymbol('diamondShape');",
                symbol:"\u00b0"
            },

            circleShape:{
                type:"shape",
                insertFnc:"insertSymbol('circleShape');",
                symbol:"\u2017"
            },

            ellipseShape:{
                type:"shape",
                insertFnc:"insertSymbol('ellipseShape');",
                symbol:"\u2019"
            },

            minusSign:{
                type:"number",
                insertFnc:"insertSymbol('minusSign');",
                symbol:"\u2012",
                keyboardSymbol:"\u2003",
                mathValue:"-"
            },

            plus:{
                type:"operator",
                insertFnc:"insertSymbol('plus');",
                symbol:"+"
            },

            minus:{
                type:"operator",
                insertFnc:"insertSymbol('minus');",
                symbol:"-"
            },

            multiplication:{
                type:"operator",
                insertFnc:"insertSymbol('multiplicationX');",
                symbol:"\u00D7",
                mathValue:'*'
            },
            multiplicationX:{
                type:"operator",
                insertFnc:"insertSymbol('multiplicationX');",
                symbol:"\u00D7",
                mathValue:'*'
            },

            multiplicationDot:{
                type:"operator",
                insertFnc:"insertSymbol('multiplicationDot');",
                symbol:"\u22C5",
                mathValue:'*'
            },

            division:{
                type:"operator",
                insertFnc:"insertSymbol('division');",
                symbol:"\u00F7",
                mathValue:'/'
            },

            ratio:{
                type:"operator",
                insertFnc:"insertSymbol('ratio');",
                symbol:":",
                mathValue:'/'
            },

            equal:{
                type:"operator",
                insertFnc:"insertSymbol('equal');",
                symbol:"=",
                mathValue:'=='
            },

            bigger:{
                type:"operator",
                insertFnc:"insertSymbol('bigger');",
                symbol:">"
            },

            smaller:{
                type:"operator",
                insertFnc:"insertSymbol('smaller');",
                symbol:"<"
            },

            notEqual:{
                type:"operator",
                insertFnc:"insertSymbol('notEqual');",
                symbol:"\u2260",
                mathValue:'!='
            },

            biggerEqual:{
                type:"operator",
                insertFnc:"insertSymbol('biggerEqual');",
                symbol:"\u2265",
                mathValue:'>='
            },

            smallerEqual:{
                type:"operator",
                insertFnc:"insertSymbol('smallerEqual');",
                symbol:"\u2264",
                mathValue:'<='
            },

            approximately:{
                type:"operator",
                insertFnc:"insertSymbol('approximately');",
                symbol:"\u2248",
                mathValue:'~'
            },

            congruence:{
                type:"operator",
                insertFnc:"insertSymbol('congruence');",
                symbol:"\u2245"
            },

            similarity:{
                type:"operator",
                insertFnc:"insertSymbol('similarity');",
                symbol:"\u007E"
            },

            orthogonal:{
                type:"operator",
                insertFnc:"insertSymbol('orthogonal');",
                symbol:"\u22A5"
            },

            parallel:{
                type:"operator",
                insertFnc:"insertSymbol('parallel');",
                symbol:"\u2225"
            },

            comma:{
                type:"sign",
                insertFnc:"insertSymbol('comma');",
                symbol:",",
	            keyboardSymbol:",",
	            keyboardSymbol_fr:"\u2010",
                mathValue:''
            },

		    space: {
			    type:"sign",
			    insertFnc:"insertSymbol('space');",
			    symbol:" ",
			    keyboardSymbol_fr:","
		    },

            point:{
                type:"sign",
                insertFnc:"insertSymbol('point');",
                symbol:".",
	            keyboardSymbol_fr: "\u002E"
            },

            percent:{
                type:"sign",
                insertFnc:"insertSymbol('percent');",
                symbol:"%",
                mathValue:""
            },

            leftParenthesis:{
                type:"sign",
                insertFnc:"insertSymbol('leftParenthesis');",
                symbol:"("
            },

            rightParenthesis:{
                type:"sign",
                insertFnc:"insertSymbol('rightParenthesis');",
                symbol:")"
            },

            leftSquareBracket:{
                type:"sign",
                insertFnc:"insertSymbol('leftSquareBracket');",
                symbol:"[",
                mathValue:"("
            },

            rightSquareBracket:{
                type:"sign",
                insertFnc:"insertSymbol('rightSquareBracket');",
                symbol:"]",
                mathValue:")"
            },

            completion:{
                type:"completion",
                symbol:"",
                mathValue:""
            },

            fraction:{
                type:"fraction",
                insertFnc:"_insertFraction();",
                symbol:"F",
                keyboardSymbol:"\u2001"
            },

            geometry:{
                type:"geometry",
                insertFnc:"_insertGeometry('normal');",
                symbol:"G"

            },

            rayLeft:{
                type:"geometry",
                insertFnc:"_insertGeometry('leftArrow');",
                symbol:"RL"
            },

            rayRight:{
                type:"geometry",
                insertFnc:"_insertGeometry('rightArrow');",
                symbol:"\u00B8",
	            keyboardSymbol:"\u2009"
            },

            rayBoth:{
                type:"geometry",
                insertFnc:"_insertGeometry('bothArrow');",
                symbol:"\u00BA",
	            keyboardSymbol:"\u200A"
            },

            segment:{
                type:"geometry",
                insertFnc:"_insertGeometry('segment');",
                symbol:"\u00B9",
	            keyboardSymbol:"\u2008"
            },

	        angle_geometry: {
		        type:"geometry",
		        insertFnc:"_insertGeometry('angle_geometry');",
		        symbol:"\u2220",
		        keyboardSymbol:"\u2220"
	        },

            triangle:{
                type:"triangle",
                insertFnc:"_insertTriangle('triangle');",
                symbol:"\u25B3"
            },

            angle:{
                type:"triangle",
                insertFnc:"_insertTriangle('angle');",
                symbol:"\u2220"
            },

            degree:{
                type:"letter",
                insertFnc:"insertSymbol('degree');",
                symbol:"\u00B0"
            },

            power:{
                type:"power",
                insertFnc:"_insertPower();",
                symbol:"P",
                keyboardSymbol:"\u2000"
            },

            longDivision:{
                type:"longDivision",
                insertFnc:"_insertLongDivision();",
                symbol:"L",
	            keyboardSymbol:'\u2002'
            },

            remainder:{
                type:"remainder",
                insertFnc:"_insertRemainder();",
                symbol:"R",
	            keyboardSymbol_nl:"r"
            },

            absolute:{
                type:"absolute",
                insertFnc:"",
                keyboardSymbol:"\u2249"
            },

            showFraction:{
                type:"showFraction",
                insertFnc:"_drawFraction();",
                symbol:"D"
            },

            celsius:{
                type:"number",
                insertFnc:"insertSymbol('celsius');",
                symbol:"\u2103"
            },

            fahrenheit:{
                type:"number",
                insertFnc:"insertSymbol('fahrenheit');",
                symbol:"\u2109"
            },

            dollar:{
                type:"nu",
                insertFnc:"insertSymbol('dollar');",
                symbol:"$"
            },

	        euro: {
		        type:"number",
		        insertFnc:"insertSymbol('euro');",
		        symbol:"€"
	        },

            cent:{
                type:"number",
                insertFnc:"insertSymbol('cent');",
                symbol:"\u00a2"
            },

            questionMark:{
                type:"number",
                insertFnc:"insertSymbol('questionMark');",
                symbol:"?"
            },

            underscore:{
                type:"number",
                insertFnc:"insertSymbol('underscore');",
                symbol:"_"
            },

            capitalA:{
                type:"letter",
                insertFnc:"insertSymbol('capitalA');",
                symbol:"A"
            },

            capitalB:{
                type:"letter",
                insertFnc:"insertSymbol('capitalB');",
                symbol:"B"
            },

            capitalC:{
                type:"letter",
                insertFnc:"insertSymbol('capitalC');",
                symbol:"C"
            },

            capitalD:{
                type:"letter",
                insertFnc:"insertSymbol('capitalD');",
                symbol:"D"
            },

            capitalE:{
                type:"letter",
                insertFnc:"insertSymbol('capitalE');",
                symbol:"E"
            },

            capitalF:{
                type:"letter",
                insertFnc:"insertSymbol('capitalF');",
                symbol:"F"
            },

            capitalG:{
                type:"letter",
                insertFnc:"insertSymbol('capitalG');",
                symbol:"G"
            },

            capitalH:{
                type:"letter",
                insertFnc:"insertSymbol('capitalH');",
                symbol:"H"
            },

            capitalI:{
                type:"letter",
                insertFnc:"insertSymbol('capitalI');",
                symbol:"I"
            },

            capitalJ:{
                type:"letter",
                insertFnc:"insertSymbol('capitalJ');",
                symbol:"J"
            },

            capitalK:{
                type:"letter",
                insertFnc:"insertSymbol('capitalK');",
                symbol:"K"
            },

            capitalL:{
                type:"letter",
                insertFnc:"insertSymbol('capitalL');",
                symbol:"L"
            },

            capitalM:{
                type:"letter",
                insertFnc:"insertSymbol('capitalM');",
                symbol:"M"
            },

            capitalN:{
                type:"letter",
                insertFnc:"insertSymbol('capitalN');",
                symbol:"N"
            },

            capitalO:{
                type:"letter",
                insertFnc:"insertSymbol('capitalO');",
                symbol:"O"
            },

            capitalP:{
                type:"letter",
                insertFnc:"insertSymbol('capitalP');",
                symbol:"P"
            },

            capitalQ:{
                type:"letter",
                insertFnc:"insertSymbol('capitalQ');",
                symbol:"Q"
            },

            capitalR:{
                type:"letter",
                insertFnc:"insertSymbol('capitalR');",
                symbol:"R"
            },

            capitalS:{
                type:"letter",
                insertFnc:"insertSymbol('capitalS');",
                symbol:"S"
            },

            capitalT:{
                type:"letter",
                insertFnc:"insertSymbol('capitalT');",
                symbol:"T"
            },

            capitalU:{
                type:"letter",
                insertFnc:"insertSymbol('capitalU');",
                symbol:"U"
            },

            capitalV:{
                type:"letter",
                insertFnc:"insertSymbol('capitalV');",
                symbol:"V"
            },

            capitalW:{
                type:"letter",
                insertFnc:"insertSymbol('capitalW');",
                symbol:"W"
            },

            capitalX:{
                type:"letter",
                insertFnc:"insertSymbol('capitalX');",
                symbol:"X"
            },

            capitalY:{
                type:"letter",
                insertFnc:"insertSymbol('capitalY');",
                symbol:"Y"
            },

            capitalZ:{
                type:"letter",
                insertFnc:"insertSymbol('capitalZ');",
                symbol:"Z"
            },

            smallA:{
                type:"letter",
                insertFnc:"insertSymbol('smallA');",
                symbol:"a"
            },

            smallB:{
                type:"letter",
                insertFnc:"insertSymbol('smallB');",
                symbol:"b"
            },

            smallC:{
                type:"letter",
                insertFnc:"insertSymbol('smallC');",
                symbol:"c"
            },

            smallD:{
                type:"letter",
                insertFnc:"insertSymbol('smallD');",
                symbol:"d"
            },

            smallE:{
                type:"letter",
                insertFnc:"insertSymbol('smallE');",
                symbol:"e"
            },

            smallF:{
                type:"letter",
                insertFnc:"insertSymbol('smallF');",
                symbol:"f"
            },

            smallG:{
                type:"letter",
                insertFnc:"insertSymbol('smallG');",
                symbol:"g"
            },

            smallH:{
                type:"letter",
                insertFnc:"insertSymbol('smallH');",
                symbol:"h"
            },

            smallI:{
                type:"letter",
                insertFnc:"insertSymbol('smallI');",
                symbol:"i"
            },

            smallJ:{
                type:"letter",
                insertFnc:"insertSymbol('smallJ');",
                symbol:"j"
            },

            smallK:{
                type:"letter",
                insertFnc:"insertSymbol('smallK');",
                symbol:"k"
            },

            smallL:{
                type:"letter",
                insertFnc:"insertSymbol('smallL');",
                symbol:"l"
            },

            smallM:{
                type:"letter",
                insertFnc:"insertSymbol('smallM');",
                symbol:"m"
            },

            smallN:{
                type:"letter",
                insertFnc:"insertSymbol('smallN');",
                symbol:"n"
            },

            smallO:{
                type:"letter",
                insertFnc:"insertSymbol('smallO');",
                symbol:"o"
            },

            smallP:{
                type:"letter",
                insertFnc:"insertSymbol('smallP');",
                symbol:"p"
            },

            smallQ:{
                type:"letter",
                insertFnc:"insertSymbol('smallQ');",
                symbol:"q"
            },

            smallR:{
                type:"letter",
                insertFnc:"insertSymbol('smallR');",
                symbol:"r"
            },

            smallS:{
                type:"letter",
                insertFnc:"insertSymbol('smallS');",
                symbol:"s"
            },

            smallT:{
                type:"letter",
                insertFnc:"insertSymbol('smallT');",
                symbol:"t"
            },

            smallU:{
                type:"letter",
                insertFnc:"insertSymbol('smallU');",
                symbol:"u"
            },

            smallV:{
                type:"letter",
                insertFnc:"insertSymbol('smallV');",
                symbol:"v"
            },

            smallW:{
                type:"letter",
                insertFnc:"insertSymbol('smallW');",
                symbol:"w"
            },

            smallX:{
                type:"letter",
                insertFnc:"insertSymbol('smallX');",
                symbol:"x"
            },

            smallY:{
                type:"letter",
                insertFnc:"insertSymbol('smallY');",
                symbol:"y"
            },

            smallZ:{
                type:"letter",
                insertFnc:"insertSymbol('smallZ');",
                symbol:"z"
            },

            small:{
                type:"",
                insertFnc:"",
                symbol:"small"
            },

            caps:{
                type:"",
                insertFnc:"",
                symbol:"caps"
            },

            none:{
                type:"",
                insertFnc:"",
                symbol:""
            },

            // enter:{
            //  type:"",
            //  insertFnc:"_insertBR();",
            //  symbol:""
            // },

            arrowLeft:{
                type:"",
                insertFnc:"",
                symbol:"←"
            },

            arrowUp:{
                type:"",
                insertFnc:"",
                symbol:"↑"
            },

            arrowRight:{
                type:"",
                insertFnc:"",
                symbol:"→"
            },

            arrowDown:{
                type:"",
                insertFnc:"",
                symbol:"↓"
            },

            del:{
                type:"",
                insertFnc:"",
                symbol:"del"
            },

            backspace:{
                type:"",
                insertFnc:"",
                symbol:"⇤"
            }

        },

        symbolsHash:{}, // initialized later

        keyboardPresets:{
             "fullMathField":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Basic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'comma'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationDot'
                                                },
                                                {
                                                    name:'multiplicationX'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'division'
                                                },
                                                {
                                                    name:'ratio'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'power'
                                                },
                                                {
                                                    name:'longDivision'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'percent'
                                                },
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'remainder'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'congruence'
                                                },
                                                {
                                                    name:'similarity'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'celsius'
                                                },
                                                {
                                                    name:'fahrenheit'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'dollar'
                                                },
                                                {
                                                    name:'cent'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'triangleShape'
                                                },
                                                {
                                                    name:'questionMark'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'squareShape'
                                                },
                                                {
                                                    name:'doodleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ellipseShape'
                                                },
                                                {
                                                    name:'circleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'underscore'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines: [
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'backspace',
                                                    keyWidth: 2
                                                },
                                                {
                                                    name: 'del'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowUp'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowLeft'
                                                },
                                                {
                                                    name: 'arrowDown'
                                                },
                                                {
                                                    name: 'arrowRight'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'Geometry',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'angle'
                                                },
                                                {
                                                    name:'triangle'
                                                },
                                                {
                                                    name:'pi'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'parallel'
                                                },
                                                {
                                                    name:'orthogonal'
                                                },
                                                {
                                                    name:'degree'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'segment'
                                                },
                                                {
                                                    name:'rayRight'
                                                },
                                                {
                                                    name:'rayBoth'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines: [
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'backspace',
                                                    keyWidth: 2
                                                },
                                                {
                                                    name: 'del'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowUp'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowLeft'
                                                },
                                                {
                                                    name: 'arrowDown'
                                                },
                                                {
                                                    name: 'arrowRight'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'abc',                            
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smallA'
                                                },
                                                {
                                                    name:'smallB'
                                                },
                                                {
                                                    name:'smallC'
                                                },
                                                {
                                                    name:'smallD'
                                                },
                                                {
                                                    name:'smallE'
                                                },
                                                {
                                                    name:'smallF'
                                                },
                                                {
                                                    name:'smallG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallH'
                                                },
                                                {
                                                    name:'smallI'
                                                },
                                                {
                                                    name:'smallJ'
                                                },
                                                {
                                                    name:'smallK'
                                                },
                                                {
                                                    name:'smallL'
                                                },
                                                {
                                                    name:'smallM'
                                                },
                                                {
                                                    name:'smallN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallO'
                                                },
                                                {
                                                    name:'smallP'
                                                },
                                                {
                                                    name:'smallQ'
                                                },
                                                {
                                                    name:'smallR'
                                                },
                                                {
                                                    name:'smallS'
                                                },
                                                {
                                                    name:'smallT'
                                                },
                                                {
                                                    name:'smallU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallV'
                                                },
                                                {
                                                    name:'smallW'
                                                },
                                                {
                                                    name:'smallX'
                                                },
                                                {
                                                    name:'smallY'
                                                },
                                                {
                                                    name:'smallZ'
                                                },
                                                {
                                                    name:'caps',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['abc']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines: [
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'backspace',
                                                    keyWidth: 2
                                                },
                                                {
                                                    name: 'del'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowUp'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowLeft'
                                                },
                                                {
                                                    name: 'arrowDown'
                                                },
                                                {
                                                    name: 'arrowRight'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'ABC',
                            classes:'hidden',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                },
                                                {
                                                    name:'capitalM'
                                                },
                                                {
                                                    name:'capitalN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                },
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'small',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['ABC']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines: [
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'backspace',
                                                    keyWidth: 2
                                                },
                                                {
                                                    name: 'del'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowUp'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowLeft'
                                                },
                                                {
                                                    name: 'arrowDown'
                                                },
                                                {
                                                    name: 'arrowRight'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },                        
                        {
                            name:'Qwerty',
	                        tabletOnly : true,
                            boxes:[
                                {
                                    lines:[
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalU'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                }
                                            ]
                                        },
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                },
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                }
                                            ]
                                        },
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalN'
                                                },
                                                {
                                                    name:'capitalM'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines: [
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'backspace',
                                                    keyWidth: 2
                                                },
                                                {
                                                    name: 'del'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowUp'
                                                }
                                            ]
                                        },
                                        {
                                            align: 'center',
                                            keys: [
                                                {
                                                    name: 'arrowLeft'
                                                },
                                                {
                                                    name: 'arrowDown'
                                                },
                                                {
                                                    name: 'arrowRight'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
                    comma:{
                      charCodes:[188],
	                  key_fr:'point'
                    },
	                space:{
		              charCodes:[32],
		              key_fr:'comma'
	                },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },

            "contentEditorMathField":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Basic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationDot'
                                                },
                                                {
                                                    name:'multiplicationX'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'power'
                                                },
                                                {
                                                    name:'longDivision'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'percent'
                                                },
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'remainder'
                                                },
	                                            {
		                                            name:'point'
	                                            }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[

                                                {
                                                    name:'congruence'
                                                },
                                                {
                                                    name:'similarity'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
	                                    {
		                                    keys:[
			                                    {
				                                    name:'comma'
			                                    }
		                                    ]
	                                    }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'Signs',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'celsius'
                                                },
                                                {
                                                    name:'fahrenheit'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'dollar'
                                                },
                                                {
                                                    name:'cent'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'degree'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'triangleShape'
                                                },
                                                {
                                                    name:'questionMark'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'squareShape'
                                                },
                                                {
                                                    name:'doodleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ellipseShape'
                                                },
                                                {
                                                    name:'circleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'underscore'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'orthogonal'
                                                },
                                                {
                                                    name:'parallel'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'angle'
                                                },
                                                {
                                                    name:'triangle'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'pi'
                                                },
                                                {
                                                    name:'segment'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'rayRight'
                                                },
                                                {
                                                    name:'rayBoth'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'abc',                            
                            boxes:[
                                {
                                    lines:[
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'smallQ'
                                                },
                                                {
                                                    name:'smallW'
                                                },
                                                {
                                                    name:'smallE'
                                                },
                                                {
                                                    name:'smallR'
                                                },
                                                {
                                                    name:'smallT'
                                                },
                                                {
                                                    name:'smallY'
                                                },
                                                {
                                                    name:'smallU'
                                                },
                                                {
                                                    name:'smallI'
                                                },
                                                {
                                                    name:'smallO'
                                                },
                                                {
                                                    name:'smallP'
                                                }
                                            ]
                                        },
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'smallA'
                                                },
                                                {
                                                    name:'smallS'
                                                },
                                                {
                                                    name:'smallD'
                                                },
                                                {
                                                    name:'smallF'
                                                },
                                                {
                                                    name:'smallG'
                                                },
                                                {
                                                    name:'smallH'
                                                },
                                                {
                                                    name:'smallJ'
                                                },
                                                {
                                                    name:'smallK'
                                                },
                                                {
                                                    name:'smallL'
                                                }
                                            ]
                                        },
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'smallZ'
                                                },
                                                {
                                                    name:'smallX'
                                                },
                                                {
                                                    name:'smallC'
                                                },
                                                {
                                                    name:'smallV'
                                                },
                                                {
                                                    name:'smallB'
                                                },
                                                {
                                                    name:'smallN'
                                                },
                                                {
                                                    name:'smallM'
                                                },
                                                {
                                                    name:'caps',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['abc']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'ABC',
                            classes:'hidden',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalU'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                }
                                            ]
                                        },
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                },
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                }
                                            ]
                                        },
                                        {
                                            align:'center',
                                            keys:[
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalN'
                                                },
                                                {
                                                    name:'capitalM'
                                                },
                                                {
                                                    name:'small',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['ABC']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
	                comma:{
		                charCodes:[188],
		                key_fr:'point'
	                },
	                space:{
		                charCodes:[32],
		                key_fr:'comma'
	                },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },
            
            "basicMidSchool":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Basic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationDot'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'power'

                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        }

                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'none',
                                                    keyWidth:2
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'percent'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
	                },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
                    // enter:{
                    //  charCodes:[13]
                    // },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },
            "algebraicMidSchool":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Algebraic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationDot'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'power'

                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        }

                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'none',
                                                    keyWidth:2
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'percent'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'squareShape'
                                                },
                                                {
                                                    name:'doodleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ellipseShape'
                                                },
                                                {
                                                    name:'circleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'triangleShape'
                                                },
                                                {
                                                    name:'questionMark'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'underscore'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'ABC',
                            classes:'hidden',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                },
                                                {
                                                    name:'capitalM'
                                                },
                                                {
                                                    name:'capitalN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                },
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'small',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['ABC']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'abc',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smallA'
                                                },
                                                {
                                                    name:'smallB'
                                                },
                                                {
                                                    name:'smallC'
                                                },
                                                {
                                                    name:'smallD'
                                                },
                                                {
                                                    name:'smallE'
                                                },
                                                {
                                                    name:'smallF'
                                                },
                                                {
                                                    name:'smallG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallH'
                                                },
                                                {
                                                    name:'smallI'
                                                },
                                                {
                                                    name:'smallJ'
                                                },
                                                {
                                                    name:'smallK'
                                                },
                                                {
                                                    name:'smallL'
                                                },
                                                {
                                                    name:'smallM'
                                                },
                                                {
                                                    name:'smallN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallO'
                                                },
                                                {
                                                    name:'smallP'
                                                },
                                                {
                                                    name:'smallQ'
                                                },
                                                {
                                                    name:'smallR'
                                                },
                                                {
                                                    name:'smallS'
                                                },
                                                {
                                                    name:'smallT'
                                                },
                                                {
                                                    name:'smallU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallV'
                                                },
                                                {
                                                    name:'smallW'
                                                },
                                                {
                                                    name:'smallX'
                                                },
                                                {
                                                    name:'smallY'
                                                },
                                                {
                                                    name:'smallZ'
                                                },
                                                {
                                                    name:'caps',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['abc']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
//                    enter:{
//                        charCodes:[13]
//                    },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },
            "geometricMidSchool":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Geometric',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationDot'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'power'

                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        }

                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[

                                                {
                                                    name:'congruence'
                                                },
                                                {
                                                    name:'similarity'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'none',
                                                    keyWidth:2
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'percent'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[

                                                {
                                                    name:'pi'
                                                },
                                                {
                                                    name:'degree'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'celsius'
                                                },
                                                {
                                                    name:'fahrenheit'
                                                }
                                            ]
                                        }
                                    ]
                                }


                            ]
                        },
                        {
                            name:'ABC',
                            classes:'hidden',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'orthogonal'
                                                },
                                                {
                                                    name:'parallel'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'angle'
                                                },
                                                {
                                                    name:'triangle'
                                                }
                                            ]
                                        },

                                        {
                                            keys:[
                                                {
                                                    name:'segment'
                                                },
                                                {
                                                    name:'rayRight'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'rayBoth'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                },
                                                {
                                                    name:'capitalM'
                                                },
                                                {
                                                    name:'capitalN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                },
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'small',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['ABC']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'abc',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'orthogonal'
                                                },
                                                {
                                                    name:'parallel'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'angle'
                                                },
                                                {
                                                    name:'triangle'
                                                }
                                            ]
                                        },

                                        {
                                            keys:[
                                                {
                                                    name:'segment'
                                                },
                                                {
                                                    name:'rayRight'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'rayBoth'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smallA'
                                                },
                                                {
                                                    name:'smallB'
                                                },
                                                {
                                                    name:'smallC'
                                                },
                                                {
                                                    name:'smallD'
                                                },
                                                {
                                                    name:'smallE'
                                                },
                                                {
                                                    name:'smallF'
                                                },
                                                {
                                                    name:'smallG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallH'
                                                },
                                                {
                                                    name:'smallI'
                                                },
                                                {
                                                    name:'smallJ'
                                                },
                                                {
                                                    name:'smallK'
                                                },
                                                {
                                                    name:'smallL'
                                                },
                                                {
                                                    name:'smallM'
                                                },
                                                {
                                                    name:'smallN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallO'
                                                },
                                                {
                                                    name:'smallP'
                                                },
                                                {
                                                    name:'smallQ'
                                                },
                                                {
                                                    name:'smallR'
                                                },
                                                {
                                                    name:'smallS'
                                                },
                                                {
                                                    name:'smallT'
                                                },
                                                {
                                                    name:'smallU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallV'
                                                },
                                                {
                                                    name:'smallW'
                                                },
                                                {
                                                    name:'smallX'
                                                },
                                                {
                                                    name:'smallY'
                                                },
                                                {
                                                    name:'smallZ'
                                                },
                                                {
                                                    name:'caps',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['abc']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
//                    enter:{
//                        charCodes:[13]
//                    },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },

            "basicMidSchoolX":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Basic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationX'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'power'

                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        }

                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'none',
                                                    keyWidth:2
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'percent'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
//                    enter:{
//                        charCodes:[13]
//                    },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },
            "algebraicMidSchoolX":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Algebraic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationX'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'power'

                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        }

                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'none',
                                                    keyWidth:2
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'percent'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'squareShape'
                                                },
                                                {
                                                    name:'doodleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ellipseShape'
                                                },
                                                {
                                                    name:'circleShape'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'triangleShape'
                                                },
                                                {
                                                    name:'questionMark'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'underscore'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'ABC',
                            classes:'hidden',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                },
                                                {
                                                    name:'capitalM'
                                                },
                                                {
                                                    name:'capitalN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                },
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'small',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['ABC']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'abc',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smallA'
                                                },
                                                {
                                                    name:'smallB'
                                                },
                                                {
                                                    name:'smallC'
                                                },
                                                {
                                                    name:'smallD'
                                                },
                                                {
                                                    name:'smallE'
                                                },
                                                {
                                                    name:'smallF'
                                                },
                                                {
                                                    name:'smallG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallH'
                                                },
                                                {
                                                    name:'smallI'
                                                },
                                                {
                                                    name:'smallJ'
                                                },
                                                {
                                                    name:'smallK'
                                                },
                                                {
                                                    name:'smallL'
                                                },
                                                {
                                                    name:'smallM'
                                                },
                                                {
                                                    name:'smallN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallO'
                                                },
                                                {
                                                    name:'smallP'
                                                },
                                                {
                                                    name:'smallQ'
                                                },
                                                {
                                                    name:'smallR'
                                                },
                                                {
                                                    name:'smallS'
                                                },
                                                {
                                                    name:'smallT'
                                                },
                                                {
                                                    name:'smallU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallV'
                                                },
                                                {
                                                    name:'smallW'
                                                },
                                                {
                                                    name:'smallX'
                                                },
                                                {
                                                    name:'smallY'
                                                },
                                                {
                                                    name:'smallZ'
                                                },
                                                {
                                                    name:'caps',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['abc']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
//                    enter:{
//                        charCodes:[13]
//                    },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },
            "geometricMidSchoolX":{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Geometric',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'minusSign'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'plus'
                                                },
                                                {
                                                    name:'minus'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'multiplicationX'
                                                },
                                                {
                                                    name:'division'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'equal',
                                                    keyWidth:2
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'fraction'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'power'

                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'absolute'
                                                }
                                            ]
                                        }

                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smaller'
                                                },
                                                {
                                                    name:'bigger'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallerEqual'
                                                },
                                                {
                                                    name:'biggerEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'approximately'
                                                },
                                                {
                                                    name:'notEqual'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[

                                                {
                                                    name:'congruence'
                                                },
                                                {
                                                    name:'similarity'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'leftParenthesis'
                                                },
                                                {
                                                    name:'rightParenthesis'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'leftSquareBracket'
                                                },
                                                {
                                                    name:'rightSquareBracket'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'none',
                                                    keyWidth:2
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'ratio'
                                                },
                                                {
                                                    name:'percent'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[

                                                {
                                                    name:'pi'
                                                },
                                                {
                                                    name:'degree'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'celsius'
                                                },
                                                {
                                                    name:'fahrenheit'
                                                }
                                            ]
                                        }
                                    ]
                                }


                            ]
                        },
                        {
                            name:'ABC',
                            classes:'hidden',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'orthogonal'
                                                },
                                                {
                                                    name:'parallel'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'angle'
                                                },
                                                {
                                                    name:'triangle'
                                                }
                                            ]
                                        },

                                        {
                                            keys:[
                                                {
                                                    name:'segment'
                                                },
                                                {
                                                    name:'rayRight'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'rayBoth'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'capitalA'
                                                },
                                                {
                                                    name:'capitalB'
                                                },
                                                {
                                                    name:'capitalC'
                                                },
                                                {
                                                    name:'capitalD'
                                                },
                                                {
                                                    name:'capitalE'
                                                },
                                                {
                                                    name:'capitalF'
                                                },
                                                {
                                                    name:'capitalG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalH'
                                                },
                                                {
                                                    name:'capitalI'
                                                },
                                                {
                                                    name:'capitalJ'
                                                },
                                                {
                                                    name:'capitalK'
                                                },
                                                {
                                                    name:'capitalL'
                                                },
                                                {
                                                    name:'capitalM'
                                                },
                                                {
                                                    name:'capitalN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalO'
                                                },
                                                {
                                                    name:'capitalP'
                                                },
                                                {
                                                    name:'capitalQ'
                                                },
                                                {
                                                    name:'capitalR'
                                                },
                                                {
                                                    name:'capitalS'
                                                },
                                                {
                                                    name:'capitalT'
                                                },
                                                {
                                                    name:'capitalU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'capitalV'
                                                },
                                                {
                                                    name:'capitalW'
                                                },
                                                {
                                                    name:'capitalX'
                                                },
                                                {
                                                    name:'capitalY'
                                                },
                                                {
                                                    name:'capitalZ'
                                                },
                                                {
                                                    name:'small',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['abc']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['ABC']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            name:'abc',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'orthogonal'
                                                },
                                                {
                                                    name:'parallel'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'angle'
                                                },
                                                {
                                                    name:'triangle'
                                                }
                                            ]
                                        },

                                        {
                                            keys:[
                                                {
                                                    name:'segment'
                                                },
                                                {
                                                    name:'rayRight'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'rayBoth'
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'smallA'
                                                },
                                                {
                                                    name:'smallB'
                                                },
                                                {
                                                    name:'smallC'
                                                },
                                                {
                                                    name:'smallD'
                                                },
                                                {
                                                    name:'smallE'
                                                },
                                                {
                                                    name:'smallF'
                                                },
                                                {
                                                    name:'smallG'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallH'
                                                },
                                                {
                                                    name:'smallI'
                                                },
                                                {
                                                    name:'smallJ'
                                                },
                                                {
                                                    name:'smallK'
                                                },
                                                {
                                                    name:'smallL'
                                                },
                                                {
                                                    name:'smallM'
                                                },
                                                {
                                                    name:'smallN'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallO'
                                                },
                                                {
                                                    name:'smallP'
                                                },
                                                {
                                                    name:'smallQ'
                                                },
                                                {
                                                    name:'smallR'
                                                },
                                                {
                                                    name:'smallS'
                                                },
                                                {
                                                    name:'smallT'
                                                },
                                                {
                                                    name:'smallU'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'smallV'
                                                },
                                                {
                                                    name:'smallW'
                                                },
                                                {
                                                    name:'smallX'
                                                },
                                                {
                                                    name:'smallY'
                                                },
                                                {
                                                    name:'smallZ'
                                                },
                                                {
                                                    name:'caps',
                                                    keyWidth:2,
                                                    keyboardActions:[
                                                        {
                                                            actionName:'changeToTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'showTab',
                                                            actionArgs:['ABC']
                                                        },
                                                        {
                                                            actionName:'hideTab',
                                                            actionArgs:['abc']
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    plus:{
                        charCodes:[43]
                    },
                    minus:{
                        charCodes:[45]
                    },
                    division:{
                        charCodes:[58]
                    },
                    multiplication:{
                        charCodes:[42]
                    },
                    equal:{
                        charCodes:[61]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    },
                    percent:{
                        charCodes:[37]
                    },
                    leftParenthesis:{
                        charCodes:[40]
                    },
                    rightParenthesis:{
                        charCodes:[41]
                    },
                    leftSquareBracket:{
                        charCodes:[91]
                    },
                    rightSquareBracket:{
                        charCodes:[93]
                    },
                    smaller:{
                        charCodes:[60]
                    },
                    bigger:{
                        charCodes:[62]
                    },
                    questionMark:{
                        charCodes:[63]
                    },
                    underscore:{
                        charCodes:[95]
                    },
                    dollar:{
                        charCodes:[36]
                    },

                    capitalA:{
                        charCodes:[65]
                    },
                    capitalB:{
                        charCodes:[66]
                    },
                    capitalC:{
                        charCodes:[67]
                    },
                    capitalD:{
                        charCodes:[68]
                    },
                    capitalE:{
                        charCodes:[69]
                    },
                    capitalF:{
                        charCodes:[70]
                    },
                    capitalG:{
                        charCodes:[71]
                    },
                    capitalH:{
                        charCodes:[72]
                    },
                    capitalI:{
                        charCodes:[73]
                    },
                    capitalJ:{
                        charCodes:[74]
                    },
                    capitalK:{
                        charCodes:[75]
                    },
                    capitalL:{
                        charCodes:[76]
                    },
                    capitalM:{
                        charCodes:[77]
                    },
                    capitalN:{
                        charCodes:[78]
                    },
                    capitalO:{
                        charCodes:[79]
                    },
                    capitalP:{
                        charCodes:[80]
                    },
                    capitalQ:{
                        charCodes:[81]
                    },
                    capitalR:{
                        charCodes:[82]
                    },
                    capitalS:{
                        charCodes:[83]
                    },
                    capitalT:{
                        charCodes:[84]
                    },
                    capitalU:{
                        charCodes:[85]
                    },
                    capitalV:{
                        charCodes:[86]
                    },
                    capitalW:{
                        charCodes:[87]
                    },
                    capitalX:{
                        charCodes:[88]
                    },
                    capitalY:{
                        charCodes:[89]
                    },
                    capitalZ:{
                        charCodes:[90]
                    },
                    smallA:{
                        charCodes:[97]
                    },
                    smallB:{
                        charCodes:[98]
                    },
                    smallC:{
                        charCodes:[99]
                    },
                    smallD:{
                        charCodes:[100]
                    },
                    smallE:{
                        charCodes:[101]
                    },
                    smallF:{
                        charCodes:[102]
                    },
                    smallG:{
                        charCodes:[103]
                    },
                    smallH:{
                        charCodes:[104]
                    },
                    smallI:{
                        charCodes:[105]
                    },
                    smallJ:{
                        charCodes:[106]
                    },
                    smallK:{
                        charCodes:[107]
                    },
                    smallL:{
                        charCodes:[108]
                    },
                    smallM:{
                        charCodes:[109]
                    },
                    smallN:{
                        charCodes:[110]
                    },
                    smallO:{
                        charCodes:[111]
                    },
                    smallP:{
                        charCodes:[112]
                    },
                    smallQ:{
                        charCodes:[113]
                    },
                    smallR:{
                        charCodes:[114]
                    },
                    smallS:{
                        charCodes:[115]
                    },
                    smallT:{
                        charCodes:[116]
                    },
                    smallU:{
                        charCodes:[117]
                    },
                    smallV:{
                        charCodes:[118]
                    },
                    smallW:{
                        charCodes:[119]
                    },
                    smallX:{
                        charCodes:[120]
                    },
                    smallY:{
                        charCodes:[121]
                    },
                    smallZ:{
                        charCodes:[122]
                    },
                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    }


                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
//                    enter:{
//                        charCodes:[13]
//                    },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            },

            numPad:{
                virtualKeys:{
                    tabs:[
                        {
                            name:'Basic',
                            boxes:[
                                {
                                    lines:[
                                        {
                                            keys:[
                                                {
                                                    name:'seven'
                                                },
                                                {
                                                    name:'eight'
                                                },
                                                {
                                                    name:'nine'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'four'
                                                },
                                                {
                                                    name:'five'
                                                },
                                                {
                                                    name:'six'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'one'
                                                },
                                                {
                                                    name:'two'
                                                },
                                                {
                                                    name:'three'
                                                }
                                            ]
                                        },
                                        {
                                            keys:[
                                                {
                                                    name:'zero'
                                                },
                                                {
                                                    name:'point'
                                                },
                                                {
                                                    name:'comma'
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                deviceKeys:{

                    zero:{
                        charCodes:[48]
                    },
                    one:{
                        charCodes:[49]
                    },
                    two:{
                        charCodes:[50]
                    },
                    three:{
                        charCodes:[51]
                    },
                    four:{
                        charCodes:[52]
                    },
                    five:{
                        charCodes:[53]
                    },
                    six:{
                        charCodes:[54]
                    },
                    seven:{
                        charCodes:[55]
                    },
                    eight:{
                        charCodes:[56]
                    },
                    nine:{
                        charCodes:[57]
                    },
                    comma:{
                        charCodes:[44]
                    },
                    point:{
                        charCodes:[46]
                    }
                },
                deviceSpecialKeys:{

                    backspace:{
                        charCodes:[8]
                    },
                    del:{
                        charCodes:[46]
                    },
//                    enter:{
//                        charCodes:[13]
//                    },
                    arrowLeft:{
                        charCodes:[37]
                    },
                    arrowUp:{
                        charCodes:[38]
                    },
                    arrowRight:{
                        charCodes:[39]
                    },
                    arrowDown:{
                        charCodes:[40]
                    }

                }
            }
        },

        mfStyle:{

            margin:{
                right:20,
                left:0,
                top:0,
                buttom:0,
                factor:5
            }

        },

        classes:{
            symbol:'symbol',
            focus:'focus',
            blur:'blur',
            mathField:'mathField',
            structure:'structure',
            completion:'completion',
            readOnly:'readOnly'
        },

        reduction:{

            minFontSize:18,
            viewPortClass:'task_container'
        },

        keyboardStyle:{
            spaceFromMathField:4 // px
        },

        mpsWrapperStyle:{
            padding:{
                top:2,
                bottom:2,
                right:2,
                left:2
            },

            border:{
                width:1
            }

        },

        frameStyle:{
            padding:{
                top:1,
                bottom:1,
                right:1,
                left:1
            },

            border:{
                width:2
            },

            size:{
                minWidth:1  //em
            }
        },

        caret:{
            width:2  //px
        },

        blowUp:{
            heightAddition:20,  //px
            widthAddition:70  //px
        }
    };

    var prototypeControlsHash = t2k.component.mathField.MathFieldConfig.prototypeControlsHash;

	var thi$ = t2k.component.mathField.MathFieldConfig;

    // init virtual keyboard symbols
	thi$.initVirtualKeyboardSymbols = (function (fontLocale) {
        var mappingLocales = {
            'fr': 'fr_FR',
            'nl': 'nl_NL',
            'usa': 'en_US',
            'he': 'he_IL'
        };

        var keyboardPresets = t2k.component.mathField.MathFieldConfig.keyboardPresets;
		var localesConfig = t2k.component.mathField.MathFieldLocaleConfig;
        var preset, tabs, tab,boxes, box, lines, line, keys, key, localeConfig,localeSymbol;
		var locale = fontLocale || ENV.locale.split('_')[0];

        for ( preset in keyboardPresets ) {
            tabs = keyboardPresets[preset].virtualKeys.tabs;
	        localeConfig = !!localesConfig[preset] && localesConfig[preset][mappingLocales[fontLocale] || ENV.locale];

	        if(localeConfig && localeConfig.length) {
		        var i, item, arr_keys;
		        for(i = 0; i < localeConfig.length; i++) {
			        item = localeConfig[i];
			        if(tabs[item.tabIndex] &&
				       tabs[item.tabIndex].boxes[item.boxIndex] &&
				       tabs[item.tabIndex].boxes[item.boxIndex].lines[item.lineIndex]) {
				        arr_keys = tabs[item.tabIndex].boxes[item.boxIndex].lines[item.lineIndex].keys;

				        switch(item.action) {
					        case "add" : {
                                var found = false;

                                for (var j = 0; j < arr_keys.length; ++j) {
                                    if (arr_keys[j].name === item.key.name) {
    						          found = true;
                                    }
                                }

                                if (!found) arr_keys.push(item.key);
						        break;
					        }
					        case "remove" : {
                                var found = false;

                                for (var j = 0; j < arr_keys.length; ++j) {
                                    if (arr_keys[j].name === item.key.name) {
                                      found = true;
                                    }
                                }

                                if (found) {
						          arr_keys.splice(item.keyIndex, 1);
                                }
						        break;
					        }
					        case "replace" : {
                                if (arr_keys[item.keyIndex].name !== item.key.name) {
						          arr_keys[item.keyIndex] = item.key;
                                }
					        }
				        }

			        }
		        }
	        }

	        for (tab in tabs) {
		        //scip tablet only tab
		        if (!!tabs[tab].tabletOnly && !ENV.behaviors.isTablet) {
			        var index = tabs.indexOf(tabs[tab]);
			        tabs.splice(index, 1);
			        continue;
		        }

		        boxes = tabs[tab].boxes;
		        for (box in boxes) {
			        lines = boxes[box].lines;
			        for (line in lines) {
				        keys = lines[line].keys;
				        for (key in keys) {
					        if (prototypeControlsHash[keys[key].name])
					            localeSymbol = prototypeControlsHash[keys[key].name]['keyboardSymbol_' + locale];

						        keys[key].symbol = localeSymbol ? localeSymbol :
							        	           prototypeControlsHash[keys[key].name].keyboardSymbol ?
							                       prototypeControlsHash[keys[key].name].keyboardSymbol :
							                       prototypeControlsHash[keys[key].name].symbol;
				        }
			        }
		        }
	        }
        }
    });

    // init symbols hash
    (function initSymbolsHash () {
        var symbolsHash = t2k.component.mathField.MathFieldConfig.symbolsHash;
        var controlName;
        var control;
        for ( controlName in prototypeControlsHash ) {
            control = prototypeControlsHash[controlName];
            symbolsHash[control.symbol] = control;
        }
    }) ();


	(function createSymbolToKey() {

		thi$.symbolToKey = {};
		thi$.lowerCaseKeyToKey = {};

		var symbol;
		for (var key in thi$.prototypeControlsHash) {
			symbol = thi$.prototypeControlsHash[key].symbol;
			thi$.symbolToKey[symbol] = key;
		}

		for (var key in thi$.prototypeControlsHash) {
			thi$.lowerCaseKeyToKey[key.toLowerCase()] = key;
		}
	})();
}) ();
////////////////////////////////////////
// SRC End --> t2k/component/mathField/MathFieldConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mathField/MathFieldView.js
////////////////////////////////////////
(function () {
    /**
     * @class t2k.component.mathField.MathFieldView
     * @desc A MathField View class
     * @namespace t2k.component.mathField
     * @extends t2k.component.BaseComponentView
     * @type {Object}
     */
    var constants = t2k.component.mathField.MathFieldConfig;

    var templates = {
        mathFieldContainer:"\
            <div id='{{id}}' class='mathField ltr {{fontLocale}} {{^editMode}} readOnly {{/editMode}} {{#colorShapes}}colorShapes {{/colorShapes}} \
            {{#italicVariables}}italicVariables {{/italicVariables}} {{#showMFEmptyIcon}} empty {{/showMFEmptyIcon}}' >\
        		<div id='{{id}}_frame' class='frame'><div class='mf_icon'>123</div></div>\
        		<div id='{{id}}_masc' class='masc' />\
	        	<div id='{{id}}_blowupContainer' class='blowupContainer hide' >\
		        	<div class='x' />\
	        	</div>\
	        	<div id='{{id}}_blowup' class='blowup' >\
		        	<div id='{{id}}_blowupZoom' class='blowupZoom' />\
	        	</div>\
                <div id='{{id}}_content' class='mathField_content' >\
                    {{>mps}}\
                </div>\
               <input type='text' id='{{id}}_input' size='1' class='mathField_input' />\
            </div>\
             {{#devMode}}" +
            "<input type='button' id='{{id}}_button' value='xml' class='mathField_button' />" +
            "<input type='button' id='{{id}}_button_value' value='value' class='mathField_button_value' />" +
            "<input type='button' id='{{id}}_button_value' value='correctness' class='mathField_button_correctness' />" +
            "<input type='button' id='{{id}}_button_value' value='reduction' class='mathField_button_reduction' />" +
            "{{/devMode}}\
        ",
        symbol:"<div class='{{type}} {{symbol}}' validationGroup='{{validationGroup}}'>{{value}}</div>",
        caret:"<div class='caret'></div>",
        mps:"<div class='mpsAnchor'></div><div class='mpsContent' id='{{id}}'><div class='mpsLasso'></div></div>",
        completion:"<div class='completion {{structureClass}}' validationGroup='completion'>\
	        			<div class='mpsAnchor'/><div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>\
	        		</div>",
        absolute:"<div class='absolute {{structureClass}}' validationGroup='absolute'>\
        	           <div class='mpsAnchor'/><div class='icon left'>|</div><div class='mpsContent' id='{{id}}'><div class='mpsLasso'></div></div><div class='icon right'>|</div>\
        	      </div>",

        // delete
        mpsWidthFrame:"<div class='mpsAnchor'/><div class='mpsFrame' /><div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>",

        power:"<div class='power {{structureClass}}' validationGroup='power'>{{>mps}}</div>",

        //mpsContent with mpsStructureWrapper attribute equal true - is readOnly, it's only use is to wrap the structure content
        fraction:"\
            <div class='fraction {{structureClass}}' validationGroup='fraction'>\
                <div class='mpsAnchor'></div>\
                <div class='mpsContent' id='{{id}}' mpsStructureWrapper='true'>\
                    <div class='numerator'>\
                        <div class='mpsAnchor'></div><div class='mpsContent' id='{{id1}}'><div class='mpsLasso'></div></div>\
                    </div>\
                    <div class='mpsLasso fractionBar'></div>\
                    <div class='denominator'>\
                        <div class='mpsAnchor'></div><div class='mpsContent' id='{{id2}}'><div class='mpsLasso'></div></div>\
                    </div>\
                </div>\
            </div>\
        ",
        longDivision_us:"\
            <div class='longDivision us {{structureClass}}' validationGroup='longDivision'>\
                <div class='mpsAnchor'/>\
                <div class='mpsContent' id='{{id}}' mpsStructureWrapper='true'>\
                    <div class='divided'>\
                        <div class='mpsContent ' id='{{id2}}'><div class='mpsLasso'/></div>\
                    </div>\
                    <div class='mpsLasso icon'><svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='6px' height='21px' viewBox='0 0 6 21' enable-background='new 0 0 6 21' xml:space='preserve'><path fill='#333333' d='M4,9.5C4,15.099,1.892,19,0,19v2c3.42,0,6-4.944,6-11.5C6,5.459,5.018,2.036,3.465,0H0 C1.892,0,4,3.901,4,9.5z'/></svg></div>\
                    <div class='divider'>\
                      <div class='mpsContent' id='{{id1}}'><div class='mpsLasso'/></div>\
                    </div>\
                </div>\
            </div>\
            ",
        longDivision_nl:"\
            <div class='longDivision us {{structureClass}}' validationGroup='longDivision'>\
                <div class='mpsAnchor'/>\
                <div class='mpsContent' id='{{id}}' mpsStructureWrapper='true'>\
                    <div class='divided'>\
                        <div class='mpsContent ' id='{{id2}}'><div class='mpsLasso'/></div>\
                    </div>\
                    <div class='mpsLasso icon'><svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='6px' height='21px' viewBox='0 0 6 21' enable-background='new 0 0 6 21' xml:space='preserve'><path fill='#333333' d='M4,9.5C4,15.099,1.892,19,0,19v2c3.42,0,6-4.944,6-11.5C6,5.459,5.018,2.036,3.465,0H0 C1.892,0,4,3.901,4,9.5z'/></svg></div>\
                    <div class='divider'>\
                      <div class='mpsContent' id='{{id1}}'><div class='mpsLasso'/></div>\
                    </div>\
                </div>\
            </div>\
            ",
        longDivision_sg:"\
            <div class='longDivision sg {{structureClass}}' validationGroup='longDivision'>\
                <div class='mpsAnchor'/>\
                <div class='mpsContent' id='{{id}}' mpsStructureWrapper='true'>\
                    <div class='divided'>\
                       <div class='mpsContent ' id='{{id2}}'><div class='mpsLasso'/></div>\
                    </div>\
                    <div class='mpsLasso icon'><svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='2px' height='21px' viewBox='0 0 2 21' enable-background='new 0 0 2 21' xml:space='preserve'><rect fill='#333333' width='2' height='21'/></div>\
                    <div class='divider'>\
                       <div class='mpsContent' id='{{id1}}'><div class='mpsLasso'/></div>\
                    </div>\
                </div>\
            </div>\
            ",
        longDivision_il:"\
            <div class='longDivision il {{structureClass}}' validationGroup='longDivision'>\
                <div class='mpsAnchor'/>\
                <div class='mpsContent' id='{{id}}' mpsStructureWrapper='true'>\
                    <div class='divider'>\
                       <div class='mpsContent' id='{{id1}}'><div class='mpsLasso'/></div>\
                    </div>\
                    <div class='mpsLasso icon'><svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='2px' height='21px' viewBox='0 0 2 21' enable-background='new 0 0 2 21' xml:space='preserve'><rect fill='#333333' width='2' height='21'/></div>\
                    <div class='divided'>\
                       <div class='mpsContent ' id='{{id2}}'><div class='mpsLasso'/></div>\
                    </div>\
                </div>\
            </div>\
            ",
        longDivision_fr:"\
            <div class='longDivision fr {{structureClass}}' validationGroup='longDivision'>\
                <div class='mpsAnchor'/>\
                <div class='mpsContent' id='{{id}}' mpsStructureWrapper='true'>\
                    <div class='divider'>\
                       <div class='mpsContent' id='{{id1}}'><div class='mpsLasso'/></div>\
                    </div>\
                    <div class='mpsLasso icon'><svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='2px' height='21px' viewBox='0 0 2 21' enable-background='new 0 0 2 21' xml:space='preserve'><rect fill='#333333' width='2' height='21'/></div>\
                    <div class='divided'>\
                       <div class='mpsContent ' id='{{id2}}'><div class='mpsLasso'/></div>\
                    </div>\
                </div>\
            </div>\
            ",
        remainder_us:"\
			<div class='remainder us {{structureClass}}' validationGroup='remainder'>\
				<div class='mpsAnchor'/>\
				<div class='icon'>R</div>\
                <div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>\
			</div>\
			",
	    remainder_fr:"\
			<div class='remainder us {{structureClass}}' validationGroup='remainder'>\
				<div class='mpsAnchor'/>\
				<div class='icon'>R</div>\
                <div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>\
			</div>\
			",
        remainder_sg:"\
			<div class='remainder sg {{structureClass}}' validationGroup='remainder'>\
				<div class='mpsAnchor'/>\
				<div class='icon'>R</div>\
                <div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>\
			</div>\
			",
        remainder_il:"\
			<div class='remainder il {{structureClass}}' validationGroup='remainder'>\
				<div class='mpsAnchor'/>\
				<div class='icon'>(</div>\
                <div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>)\
			</div>\
			",
	    remainder_nl:"\
			<div class='remainder us {{structureClass}}' validationGroup='remainder'>\
				<div class='mpsAnchor'/>\
				<div class='icon'>rest</div>\
                <div class='mpsContent' id='{{id}}'><div class='mpsLasso'/></div>\
			</div>\
		",
        segment:"\
			<div class='geometry segment {{structureClass}}' validationGroup='geometry'>\
				<div class='mpsAnchor'/>\
				<div class='mpsContent' id='{{id}}'><div class='mpsLasso'/>\
				</div>\
				<div class='icon'>{{icon}}</div>\
			</div>\
			",

        rayBoth:"\
			<div class='geometry rayBoth {{structureClass}}' validationGroup='geometry'>\
				<div class='mpsAnchor'/>\
				<div class='mpsContent' id='{{id}}'><div class='mpsLasso'/>\
				</div>\
				<div class='icon'>{{icon}}</div>\
			</div>\
			",

        rayRight:"\
			<div class='geometry rayRight {{structureClass}}' validationGroup='geometry'>\
				<div class='mpsAnchor'/>\
				<div class='mpsContent' id='{{id}}'><div class='mpsLasso'/>\
				</div>\
				<div class='icon'>{{icon}}</div>\
			</div>\
			",

	    angle_geometry:"\
			<div class='geometry angle_geometry {{structureClass}}' validationGroup='geometry'>\
				<div class='mpsAnchor'/>\
				<div class='mpsContent' id='{{id}}'><div class='mpsLasso'/>\
				</div>\
				<div class='icon'>{{icon}}</div>\
			</div>\
			",


        mobiletemplate : "<div class='mobileEdit'><div class='editBtn'>Edit</div><input type='text' class='editMobile' /></div>"

    };

    /**
     * MathField View
     */
    t2k.component.mathField.MathFieldView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.mathField.MathFieldView',

        /**
         * constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            this.initMembers(config);

            /**
             * @property
             * @type {Boolean}
             */
            this.keyBoardOpen = false;

            // Render view template
            this._super(override(config, {
                template:templates.mathFieldContainer,
                partials:{
                    mps:templates.mps
                },
                fontLocale:this.fontLocale,
                devMode:this.devMode,
                colorShapes:this.colorShapes,
                italicVariables:this.italicVariables,
                showMFEmptyIcon:(this.showMFEmptyIcon && this.editMode),
                editMode:this.editMode,
                completionMode:this.completionMode
            }));

            this.checkShortHandElements();
            this.initEvents();
            this.initView();

	        var isTaskWithContainers = ['sorting', 'matching', 'sequencing', 'mc'].indexOf(this.cfg.taskmode) > -1;
	        if ((!this.cfg.viewObject) && (!isTaskWithContainers)) { //not from drag and drop and in MTQ, MC
		        if (window['globalEvents']) {  //there is no global events in CGS, check for global variable existence
			        var thi$ = this;
			        window['globalEvents'].add({
				        fnc:function () {
					        (!!thi$._view) && thi$.adjustContentStyle();
				        }
			        });
		        } else {
			        this.adjustContentStyle();
		        }
	        }

	        if(ENV.behaviors.isTablet) {
		        this._input.attr('disabled', '');
		        this._input.hide();
	        }

            //if on phone gap adding edit btn
            //todo: need to repalce with useExternalKeyboard
            if( !! ENV.behaviors.useExternalMediaPlayer && !ENV.behaviors.overrideMathNativeKeyboard){
                this.renderMobileTemplate()
            }
        },

	    //override - set state of component
	    setMyState:function (state) {
		    this.state = state;

		    var markUp = '', $state = jQuery(state);

		    if ($state.length) {
			    if ($state.children('markUp').length == 0) {
				    markUp = state[0].innerHTML;
			    } else {
				    markUp = $state.children('markUp').text();
			    }

			    this.setEnabled($state.attr('enabled') === 'true');
			    this.replaceContent('<markUp>' + markUp + '</markUp>');
			    this.adjustContentStyle();
		    }

		    $state = null;
	    },

	    //override - get state of component
	    addMyState:function (state) {
			return Perf.create('state')
					.append(Perf.create('markUp')
					.text(this.getMarkUpValue()));

	    },

        renderMobileTemplate:function(){
            this._view.append($(templates.mobiletemplate));
            // add the style to the btn
            var self = this;
            var btnStyle = {"position":"absolute","font-size": "15px","width": "33px","height": "22px","padding": "0 2px","background":"white"},
            mobileEditStyle = {"display": "inline-block", "position":"relative"},
            inputStyle ={"position":"absolute","top":"0px","left":"0px","border":0, "width":"30px","color": "white","outline": "0","z-index":1000,"background": "transparent"};
            
            this._view.find(".mobileEdit")
            .css(mobileEditStyle)
            .children()
            .first()
            .css(btnStyle)
            .next()
            .css(inputStyle)
            .on("click", function(e){
                var that = $(this);
                that.val("z");
                that.prev().hide();
                self.startEdit();
                self.placeCaretAtEnd();
                
            })
            .on("blur",function(e){
                if(self.editMode){
                    this.focus();
                }else{
                    this.val("");
                    this.prev().show();
                }
            });
            this._view.on("blur",function(){
                if(self.editMode && !$(this).find(".editMobile").is(":focus")){
                    this.find(".editMobile").val("")
                    .prev().show();
                    self.endEdit();
                }else{
                    this.find(".editMobile").val("")
                    .prev().show();
                }
            })


        },

        /**
         * initMembers
         * Init members
         */
        initMembers:function (config) {

            /**
             * @property
             * @type {Object}
             */
            this.keyboard = null;

            // set config.parent
            if (typeof config.parent != "object") {
                config.parent = Perf.select('#' + config.parent);
            }

            /**
             * get mathField's completionType
             * this param set a completionType for all MF.
             * this is not really a completion mode. just keyboard limitation.
             * @type {String}
             */
            this.mathFieldCompletionType = jQuery(config.data).attr('completionType');
            this.mathFieldCompletionType = !!this.mathFieldCompletionType ? this.mathFieldCompletionType : null;
            /**
             *
             * @type {Boolean}
             */
            this.colorShapes = jQuery(config.data).attr('colorShapes') == 'true';
            /**
             *
             * @type {Boolean}
             */
            this.italicVariables = jQuery(config.data).attr('italicVariables') == 'true';


            this.maxHeight = {
                stringValue: jQuery(config.data).attr('maxHeight')
                    || constants.maxHeight.defaultValue
            };

            this.container = (config.container && config.container.length)?
                config.container:
                config.parent.parents('.task_container');


            /**
             *
             * @type {Object}
             */
            this.viewPort = config.parent.parents('.' + constants.reduction.viewPortClass);

            //in case of parent is iframe MF view port should be the iframe body
            if (this.viewPort.length == 0) {
                this.viewPort = config.parent.parents('body');
            }
            /**
             *
             * @type {Boolean}
             */
            this.enableBlowup = false;
             /**
             *
             * @type {Boolean}
             * prevents blowup in subanswer
             */

            this.dontEnableBlowup = config.dontEnableBlowup
            /**
             *
             * @type {Boolean}
             */
            this.setMarkUp = false;
            /**
             *
             * @type {Number}
             */
            this.reductionStep = (!!config.reductionStep ? config.reductionStep : 0);
            /**
             *
             * @type {Number}
             */
            this.reductionStepSize = 2;
            /**
             *
             * @type {Number}
             */
            this.fontSize = this.originalFontSize = config.parent.css('font-size').px2int();
            /**
             *
             * @type {Boolean}
             */
            this.devMode = jQuery(config.data).attr('devMode') === 'true';
            /**
             *
             * @type {Boolean}
             */
            this.showMFEmptyIcon = (jQuery(config.data).attr('showMFEmptyIcon') === 'true') || config.showMFEmptyIcon;
            /**
             *
             * @type {Number}
             */
            this.id = config.id;
            /**
             *
             * @type {Boolean}
             */
            this.editMode = jQuery(config.data).attr('editMode') === 'on';
            /**
             *
             * @type {Boolean}
             */
            this.completionMode = jQuery(config.data).attr('editMode') === 'completion';
            /**
             *
             * @type {Boolean}
             */
            this.autoComma = !!(jQuery(config.data).attr('autoComma') === 'true');
            /**
             *
             * @type {Boolean}
             */
            this.activeValidation = !!(jQuery(config.data).attr('validate') === 'true');
			// var presetName = jQuery(config.data).attr("keyboardPreset") || 'defaultKeyboard';
	        var presetName = jQuery(config.data).attr("keyboardPreset") || 'fullMathField';

	        if (constants.keyboardPresets.hasOwnProperty(presetName)) {
		        this.keyboardPreset = constants.keyboardPresets[presetName];
	        } else {
			// this.keyboardPreset = constants.keyboardPresets['defaultKeyboard'];
		        this.keyboardPreset = constants.keyboardPresets['fullMathField'];
	        }
            /**
             *
             * @type {*}
             */
            this.fontLocale = jQuery(config.data).attr("fontLocale") || ( ENV.locale ).toLowerCase().split('_')[1];

            var configWidth = config.widthEm || jQuery(config.data).attr('width') ||  '';    //em

            //create new closer objects
            /**
             *
             * @type {Object}
             */
            this.mpsWrapping = copy({}, this.mpsWrapping);
            /**
             *
             * @type {Object}
             */
            this.validation = copy({}, this.validation);
            /**
             *
             * @type {Object}
             */
            this.selection = copy({}, this.selection);
            /**
             *
             * @type {Object}
             */
            this.initMarkup = copy({}, this.initMarkup);
            /**
             *
             * @type {Object}
             */
            this.calculate = copy({}, this.calculate);

            this.mpsWrapping.collection = [];
            this.mpsWrapping.thi$$ = this;
            this.validation.thi$$ = this;
            this.selection.thi$$ = this;
            this.initMarkup.thi$$ = this;
            this.calculate.thi$$ = this;

            /**
             *
             * @type {Object}
             */
            this.widthMode = {
                'fixedWidth':(configWidth == '') ? false : true,
                'width':(configWidth == '') ? (this.container.width() / this.fontSize) : configWidth
            };

            /**
             *
             * @type {Document}
             */
            this.targetDocument = jQuery(!!config.targetDocument ? config.targetDocument : document);

            /**
             *
             * @type {Int}
             */
            this.parentFontSize = config.parent.css('font-size').px2int();

	        //init virtual keyboard symbols only one time
	        constants.initVirtualKeyboardSymbols(this.fontLocale);

        },

        /**
         * getSize
         * override
         * @returns size
         */
        getSize:function () {
			var blowUpHeight = Compat.actualHeight(this._blowup);

	        if(blowUpHeight > 1) {
		        return {'width': Compat.actualWidth(this._blowup), 'height': blowUpHeight };
	        } else {
                return {'width': Compat.actualWidth(this._content), 'height': Compat.actualHeight(this._frame) };
	        }
        },

	    getWidthEM:function () {
		    var widthPX = Compat.actualWidth(this._content),
			    fontSize = this.fontSize;

		    return Math.ceil(widthPX / fontSize);
	    },

	    getWidthPX:function () {
		    var widthPX = Compat.actualWidth(this._content) + 1;

		    return Math.ceil(widthPX);
	    },

	    getHeightPX: function() {
		    var frameHeight = Compat.actualHeight(this._frame),
			    frameOriginalHeight = this._frame.css('min-height').px2int(), //frame original height
			    mfHeight = 0;

		    if (frameHeight > frameOriginalHeight) {
			    mfHeight = frameHeight;
		    } else {
			    mfHeight = this._view.outerHeight(false);
		    }

		    return mfHeight;
	    },

	    removeContent:function () {
		    this.initMarkup.remove();

		    if(!this.initFrameSize) {
			    this._frame.width(this._content.width() + constants.frameStyle.padding.left + constants.frameStyle.padding.right);
			    this._frame.height(this._content.height() + constants.frameStyle.padding.top + constants.frameStyle.padding.bottom);
		    } else {
			    this._frame.css(this.initFrameSize);
		    }

		    this.alignFrame(true);

	    },

	    setFontSize: function(fontSize) {
		    this.fontSize = fontSize;
		    this._view.css('font-size', this.fontSize);
	    },

        /**
         * checkWidthVsContainer
         */
        checkWidthVsContainer:function () {

            if(this.editMode || this.completionMode) {
                return;
            }

            var containerWidth = this.container.width();

            if (this.widthMode.fixedWidth) {

                var mfWidth = this.fontSize * this.widthMode.width;
                var deltaWidth = mfWidth - containerWidth;

                if (deltaWidth > 0) {
                    var virtualReduction = this.virtualReduction(containerWidth, mfWidth, this.fontSize);
	                this.setFontSize(virtualReduction.reducedFontSize);

                    mfWidth = this.fontSize * this.widthMode.width;
                    this._frame.width(mfWidth);

                    if (virtualReduction.blowup) this.createBlowup(virtualReduction.blowup);
                }

            } else {

                var mfWidth = this._content.width();

                var deltaWidth = mfWidth - containerWidth;

                if (deltaWidth > 0) {

                    this.widthMode.width = Math.ceil(mfWidth / this.originalFontSize);    //em

                    var virtualReduction = this.virtualReduction(containerWidth, mfWidth, this.fontSize);
	                this.setFontSize(virtualReduction.reducedFontSize);

                    mfWidth = Math.floor((this.fontSize * this.widthMode.width) / this.originalFontSize);
                    this._frame.width(mfWidth);

                    if (virtualReduction.blowup) this.createBlowup(virtualReduction.blowup);
                }
            }
        },

        /**
         * checkShortHandElements
         * in case of MF parent is iframe, there is a need for manual variable assignment
         */
        checkShortHandElements:function () {

            if (!!!this._content) {

                var thi$ = this;

                // Keep reference to the view's DOM element.
                this._view = this.cfg.parent.find('#' + this.cfg.id + '.mathField');

                // Keep reference to all DOM elements with id suffix.
                jQuery(this._view).find('[id^=' + this.cfg.id + '_]').each(function (index, elem) {
                    thi$[jQuery(elem).attr('id').substring(thi$.cfg.id.length)] = jQuery(elem);
                });

            }
        },


        /**
         * createBlowup
         * @param virtualReduction true/false
         */
        createBlowup:function (virtualReduction) {
            var thi$ = this;
            this.enableBlowup = true;
            this._view.addClass('blowup');
            this.alignFrame();
            this.showMasc(true);

            this._content.css('padding', constants.blowUp.heightAddition / 2);

            // align blowup div
	        this._blowup.show().css({
		        'top':this._content.position().top,
		        'left':this._content.position().left,
		        'width':this._content.width() + constants.blowUp.heightAddition,
		        'height':this._content.height() + constants.blowUp.heightAddition}).click(function () {
			        thi$.showBlowup(true, virtualReduction);
		        });

            this._view.css('top', this._content.position().top);

            this.dispatchEvent("cantReduce");

        },

        /**
         * showBlowup
         * @param flag
         * @param virtualReduction
         */
        showBlowup:function (flag, virtualReduction) {

            var thi$ = this;

	        if (flag) {

		        //check if blow up is already shown
		        if(!this._blowupContainer.hasClass('hide')) {
			        return false;
		        }

                var viewPortWidth = this.viewPort.width(), playerWidth = jQuery('.player').width();

		        var blowupFontSize = (virtualReduction ?
			        this.virtualReduction(viewPortWidth, (this.originalFontSize * this.widthMode.width), this.originalFontSize).reducedFontSize :
			        this.originalFontSize);

		        if (blowupFontSize < constants.reduction.minFontSize) {
			        blowupFontSize = constants.reduction.minFontSize;
		        } else if (blowupFontSize > this.originalFontSize) {
			        blowupFontSize = this.originalFontSize;
		        }

		        var clonedContent = jQuery('<div class="mathField" />');
		        clonedContent.append(this._content.clone());
		        clonedContent.css('font-size', blowupFontSize + 'px');

		        var newMfWidth = (virtualReduction ?
			        (blowupFontSize * this.widthMode.width) :
			        (this._view.width() * this.originalFontSize) / this.parentFontSize) + constants.blowUp.widthAddition;

		        this._blowupContainer.find('.mathField').remove();

                clonedContent.appendTo(this._blowupContainer);

var showParent = this._blowupContainer.closest('[class^="sequence_"]'),
    isShared = showParent.hasClass('sequence_shared'),
    blowUpTop,
    blowUpLeft,
    tmpParent;

if (isShared) {
    tmpParent = showParent.find('.sharedarea_content');
} else {
    tmpParent = this._blowupContainer.parents('.task');
}

this._blowupContainer.appendTo(tmpParent);
blowUpTop = this._blowup.offset().top - tmpParent.offset().top;
blowUpLeft = this._blowup.offset().left - tmpParent.offset().left;


                this._blowupContainer.css({ 'font-size': blowupFontSize + 'px',
                                            'position': 'absolute',
	                                        'left' : blowUpLeft  + 'px',
                                            'top' : blowUpTop + 'px',
	                                        'width' : newMfWidth + 'px',
                                            'max-width':tmpParent.outerWidth() + 'px'}).removeClass('hide');


                this._blowupContainer.find('.x').click(function () {
                    thi$.showBlowup(false, false);
                });


	        } else {
                this._blowupContainer.find('.mathField').remove();
                this._blowupContainer.addClass('hide');
	        }

        },

        /**
         * virtualReduction
         * @param containerWidth
         * @param mfWidth
         * @param fontSize
         */
        virtualReduction:function (containerWidth, mfWidth, fontSize) {

            var reductionPrecent = containerWidth / mfWidth;
            var ret = {};

                ret.reducedFontSize = Math.floor(fontSize * reductionPrecent);
                ret.blowup = ret.reducedFontSize < constants.reduction.minFontSize;

            if(this.dontEnableBlowup  && ret.blowup){
                ret.reducedFontSize = constants.reduction.minFontSize;
                ret.blowup = false;                
            }

	        return ret;
        },

        /**
         * getValue
         * returns MF calculated value
         */
        getValue:function () {
            return this.calculate.value();
        },

        /**
         * getMarkUpValue
         * returns MF markUp value
         */
        getMarkUpValue:function () {
            return this.calculate.markupValue();
        },

        /**
         * replaceContent
         * @param markup
         * replaces MF content with htnl markUp parameter
         */
        replaceContent:function (markup) {
            this._frame.removeClass("not_valid");
            this.initMarkup.remove();

            this.setMarkUp = true;
	        this.lastStructureRemovedFlag = false;
            this.initMarkup.start(markup);
        },

        //calculate class
        calculate:{

            /**
             * getFinalMathString
             * translates math field markUp into the math string (for javascript eval)
             */
            getFinalMathString:function () {

                var markupValue = this.markupValue();
                markupValue = this.handleRemainderMarkupValue(markupValue);

                if (!markupValue) return null;

                return this.getMathString(markupValue);
            },

            /**
             * value
             * calcultates value of the math field data
             */
            value:function () {

                var finalMathString = this.getFinalMathString();
                if (finalMathString == null) return null;

                // send it to this.thi$$.validate.validateCalculationCorrectness (check for: =, >, <, !=, <=, >=, ~~)
                // if true, return null
                if (this.thi$$.validation.validateCalculationCorrectness(finalMathString)) {
                    return null;
                }

                var returnValue = null;

	            try {
		            returnValue = eval(finalMathString);
		            returnValue = 1 * returnValue.toFixed(15); //fix precision bug
	            } catch (e) {

	            }

                return returnValue;
            },

            /**
             * correctness
             * returns correctness of the math field data
             */
            correctness:function () {

                var finalMathString = this.getFinalMathString();
                if (finalMathString == null) return null;

                // send it to this.thi$$.validate.validateCalculationCorrectness (check for: ==, >, <, !=, <=, >=)
                // if true, eval
                if (!this.thi$$.validation.validateCalculationCorrectness(finalMathString)) {
                    return null;
                }

                var returnValue = null;

                try {
                    returnValue = eval(finalMathString);
                } catch (e) {

                }

                return returnValue;
            },

            /**
             * elementValidationGroup get element - extract it's tagName and it's validation group
             * @param $element
             */
            elementValidationGroup:function ($element) {
                var elementTag = $element.get(0).tagName.toLowerCase();

                elementTag = constants.lowerCaseKeyToKey[elementTag];

                return constants.validationGroup[elementTag];
            },

            /**
             * wrapMarkupValue
             * @param markupValue
             * @param tagName
             * wrap wanted tag as 'power', 'percent' in order to translate it to mathString later
             */
            wrapMarkupValue:function (markupValue, tagName) {

                markupValue = jQuery(markupValue);

                var startIndex, endIndex;

                var $child, thi$ = this, startElement = null, prevElement = null, validationGroup;
                var tagWrapper = jQuery('<' + tagName + 'Wrapper/>');

                markupValue.each(function (index, child) {

                    if (!!!child) {
                        return false;
                    }

                    $child = jQuery(child);

                    if (child.tagName.toLowerCase() == tagName) {

                        endIndex = index;

                        prevElement = $child.prev();

                        if (prevElement.length == 0) {
                            return false;
                        }

                        validationGroup = thi$.elementValidationGroup(prevElement);

                        switch (thi$.analyzePrevChild(prevElement)) {

                            case 'digit':
                                startIndex = endIndex - 1;
                                startElement = prevElement;

                                if (startElement.prev().length == 0) {
                                    break;
                                }

                                validationGroup = thi$.elementValidationGroup(startElement.prev());

                                while (startElement.prev() && (validationGroup == 'digits' || validationGroup == 'decimalPoint' || validationGroup == 'thousandsComma' )) {
                                    startIndex--;
                                    startElement = startElement.prev();

                                    if (startElement.prev().length == 0) {
                                        break;
                                    }
                                    validationGroup = thi$.elementValidationGroup(startElement.prev());
                                }

                                break;

                            case 'structure':
                                startElement = prevElement;
                                startIndex = endIndex - 1;
                                break;

                            case 'parenthesis':

                                startIndex = endIndex - 1;
                                startElement = prevElement;
                                var parenthesisCounter = 1;

                                while (parenthesisCounter > 0) {

                                    startIndex--;
                                    startElement = startElement.prev();

                                    validationGroup = thi$.elementValidationGroup(startElement);

                                    if ((validationGroup == 'closingParenthesis') || (validationGroup == 'closingSquareParenthesis')) parenthesisCounter++;
                                    else if ((validationGroup == 'openingParenthesis') || (validationGroup == 'openingSquareParenthesis')) parenthesisCounter--;

                                }

                                break;
                            case 'operator':
                                return false;


                            default:
                                throw('mathField ERROR on wrapMarkupValue - wrong analysis');

                        }

                        if (startElement.length > 0) {
                            tagWrapper.append(markupValue.splice(startIndex, (endIndex + 1 - startIndex)));
                            markupValue.splice(startIndex, 0, tagWrapper.get(0));

                            tagWrapper = jQuery('<' + tagName + 'Wrapper/>');
                        }
                    }

                });

                return markupValue;
            },

            /**
             * analyzePrevChild
             * @param prevChild
             * returns element type ('structure', 'parenthesis', 'digit')
             */
            analyzePrevChild:function (prevChild) {
                var prevChildTag = prevChild.get(0).tagName.toLowerCase();

                prevChildTag = constants.lowerCaseKeyToKey[prevChildTag];

                var validationGroup = constants.validationGroup[prevChildTag];

                if (prevChild.hasClass('structure'))
                    return 'structure';

                if (validationGroup == 'closingParenthesis')
                    return 'parenthesis';
                if(validationGroup == 'operators')
                    return 'operator';

                return 'digit';
            },

            /**
             * getMathString
             * @param markupValue
             * returns math string (for javascript eval) after markUp translations
             */
            getMathString:function (markupValue) {
                var powerCount = 0, percentCount = 0, fractionCount = 0;

                jQuery(markupValue).each(function (index, child) {
                    switch (child.tagName.toLowerCase()) {
                        case 'power' :
                            powerCount++;
                            break;
                        case 'percent' :
                            percentCount++;
                            break;
                        case 'fraction':
                            fractionCount++;
                            break;
                    }
                });

                if (powerCount > 0) {
                    markupValue = this.wrapMarkupValue(markupValue, 'power');
                }

                if (percentCount > 0) {
                    markupValue = this.wrapMarkupValue(markupValue, 'percent');
                }
                if (fractionCount > 0){
                    markupValue = this.wrapMarkupValue(markupValue, 'fraction');
                }

                var $child, tagName, mathString = '', mathValue, thi$ = this, lastTagName = '';

                jQuery(markupValue).each(function (index, child) {

                    $child = jQuery(child);
                    tagName = constants.lowerCaseKeyToKey[child.tagName.toLowerCase()];

                    if (!!!tagName) {
                        tagName = child.tagName.toLowerCase();
                    }

                    switch (tagName) {
                        case 'fractionwrapper':
                            
                            var fractionMathString = '', numbers = '';
                            jQuery($child.children()).each(function(i, fractionChild){
                                var fractionTagName = constants.lowerCaseKeyToKey[fractionChild.tagName.toLowerCase()];
                                
                                if(fractionTagName == 'fraction'){

                                    var numeratorMarkupValue = jQuery(fractionChild).children('numerator').children();
                                    var denominatorMarkupValue = jQuery(fractionChild).children('denominator').children();

                                    var numeratorMathString = thi$.getMathString(numeratorMarkupValue);
                                    var denominatorMathString = thi$.getMathString(denominatorMarkupValue);

                                    fractionMathString = '((' + numeratorMathString + ')/(' + denominatorMathString + '))';

                                }else{

                                    numbers += thi$.getMathString(fractionChild);
                                }

                            });
                            
                            mathString += "(" + numbers + "+" + fractionMathString + ")";
                               

                        break;

                        case 'fraction':

                            var fractionMathString = '';

                            var numeratorMarkupValue = $child.children('numerator').children();
                            var denominatorMarkupValue = $child.children('denominator').children();

                            var numeratorMathString = thi$.getMathString(numeratorMarkupValue);
                            var denominatorMathString = thi$.getMathString(denominatorMarkupValue);

                            fractionMathString = '((' + numeratorMathString + ')/(' + denominatorMathString + '))';
                            if((constants.validationGroup[lastTagName] =='digits')){
                                mathString += "+";
                            }
                            mathString += fractionMathString;

                            break;

                        case 'longDivision':

                            var longDivisionMathString = '';

                            var dividedMarkupValue = $child.children('divided').children();
                            var dividerMarkupValue = $child.children('divider').children();

                            var dividedMathString = thi$.getMathString(dividedMarkupValue);
                            var dividerMathString = thi$.getMathString(dividerMarkupValue);

                            longDivisionMathString = '((' + dividedMathString + ')/(' + dividerMathString + '))';
                            mathString += longDivisionMathString;

                            break;

                        case 'powerwrapper':
                            // 1. get 'power' mathString
                            // remove power tag
                            // 2. get X mathString (remaining markup)
                            // 3. Math.pow(eval(x), eval(power))
                            // mathString += '(' + pow + ')';
                            var powerValue = $child.children('power').children();
                            $child.children('power').remove();
                            var raisedToPowerValue = $child.children();

                            var powerMathString = thi$.getMathString(powerValue);
                            var raisedToPowerMathString = thi$.getMathString(raisedToPowerValue);

                            mathString += 'Math.pow(eval(' + raisedToPowerMathString + '), eval(' + powerMathString + '))';

                            break;

                        case 'percentwrapper':
                            // 1. get 'percent' mathString
                            // remove percent tag
                            // 2. get percent value
                            // 3. (eval(percent value) / 100)
                            // mathString += '(' + (eval(percent value) / 100) + ')';
                            $child.children('percent').remove();
                            var percentValue = $child.children();
                            $child.remove();

                            var percentMathString = thi$.getMathString(percentValue);
                            mathString += '((' + percentMathString + ') / 100)';

                            break;

                        case 'completion' :
                            var completionValue = $child.children();
                            $child.remove();

                            mathString += thi$.getMathString(completionValue);
                            break;

                        case 'absolute' :
                            var absoluteValue = $child.children();
                            $child.remove();

                            mathString += 'Math.abs(' + thi$.getMathString(absoluteValue) + ')';
                            break;

                        //When pi follows a number, a decimal number, a fraction or a powered number/expression, a multiplication operator will be added before it
                        // in the calculation process.
                        case 'pi' :
                            var piValue = constants.prototypeControlsHash['pi'].mathValue;

                            // if prev tagName is a fraction | power | digits,
                            // calculate * pi
                            if ((lastTagName == 'fraction') || (lastTagName == 'powerwrapper') || (constants.validationGroup[lastTagName] == "digits")) {
                                mathString += '*';
                            }

                            mathString += piValue;

                            break;
                       
                        default:
                            mathValue = (constants.prototypeControlsHash[tagName].mathValue != undefined) ? constants.prototypeControlsHash[tagName].mathValue : constants.prototypeControlsHash[tagName].symbol;
                            mathString += mathValue;
                    }

                    // save last tag name
                    lastTagName = tagName;

                });
                
                return mathString;

            },

            /**
             * markupValue
             * returns markUp html
             */
            markupValue:function () {

                var markupValue = jQuery('<markupValue/>');
                var domChildrenArray = this.thi$$._content.children('.mpsContent').children();

                this.parseMarkupValue(domChildrenArray, markupValue);
                return (jQuery(markupValue).html());

            },

            /**
             * parseMarkupValue
             * @param domChildrenArray
             * @param markupContainer
             * parses divs array with data and apends it to the wanted markUp container
             */
            parseMarkupValue:function (domChildrenArray, markupContainer) {

                var $child, key, thi$ = this, structureName;

                jQuery(domChildrenArray).each(function (index, child) {

                    $child = jQuery(child);
                    // symbol
                    if ($child.hasClass('symbol')) {

                        key = constants.symbolToKey[$child.text()];
                        jQuery('<' + key + '/>').appendTo(markupContainer);

                    } else if ($child.hasClass('structure')) {
                        // structure

                        structureName = $child.attr('class').replace('structure', '').trim();

                        if (structureName.indexOf(' ') > -1) {
                            for (var structure in constants.mathTypeKeyboard) {
                                if (structureName.indexOf(structure) > -1) structureName = structure;
                            }
                        }

                        switch (structureName) {

                            case 'fraction' :

                                var fractionMarkup = jQuery('<fraction/>');
                                fractionMarkup.appendTo(markupContainer);

                                var numeratorMarkup = jQuery('<numerator/>');
                                numeratorMarkup.appendTo(fractionMarkup);
                                var numeratorDom = $child.children('.mpsContent').children('.numerator').children('.mpsContent');
                                thi$.parseMarkupValue(numeratorDom.children(), numeratorMarkup);

                                var denominatorMarkup = jQuery('<denominator/>');
                                denominatorMarkup.appendTo(fractionMarkup);
                                var denominatorDom = $child.children('.mpsContent').children('.denominator').children('.mpsContent');
                                thi$.parseMarkupValue(denominatorDom.children(), denominatorMarkup);

                                break;

                            case 'completion' :
                                var completionMarkup = jQuery('<completion/>');
                                completionMarkup.attr('completiontype', $child.attr('completiontype'));
                                completionMarkup.appendTo(markupContainer);

                                var completionDom = $child.children('.mpsContent');
                                thi$.parseMarkupValue(completionDom.children(), completionMarkup);

                                break;

                            case 'power' :

                                var powerMarkup = jQuery('<power/>');
                                powerMarkup.appendTo(markupContainer);

                                var powerDom = $child.children('.mpsContent');
                                thi$.parseMarkupValue(powerDom.children(), powerMarkup);

                                break;

                            case 'remainder' :

                                var remainderMarkup = jQuery('<remainder/>');
                                remainderMarkup.appendTo(markupContainer);

                                var remainderDom = $child.children('.mpsContent');
                                thi$.parseMarkupValue(remainderDom.children(), remainderMarkup);

                                break;

                            case 'absolute' :
                                var absoluteMarkup = jQuery('<absolute/>');
                                absoluteMarkup.appendTo(markupContainer);

                                var absoluteDom = $child.children('.mpsContent');
                                thi$.parseMarkupValue(absoluteDom.children(), absoluteMarkup);
                                break;

                            case 'longDivision' :
                                var longDivisionMarkup = jQuery('<longDivision/>');
                                longDivisionMarkup.appendTo(markupContainer);

                                var dividerMarkup = jQuery('<divider/>');
                                dividerMarkup.appendTo(longDivisionMarkup);
                                var dividerDom = $child.children('.mpsContent').children('.divider').children('.mpsContent');
                                thi$.parseMarkupValue(dividerDom.children(), dividerMarkup);

                                var dividedMarkup = jQuery('<divided/>');
                                dividedMarkup.appendTo(longDivisionMarkup);
                                var dividedDom = $child.children('.mpsContent').children('.divided').children('.mpsContent');
                                thi$.parseMarkupValue(dividedDom.children(), dividedMarkup);

                                break;

                            case 'segment' :
                            case 'rayRight':
                            case 'rayBoth' :
	                        case 'angle_geometry' :

                                var geometryMarkup = jQuery('<' + structureName + '/>');

                                geometryMarkup.appendTo(markupContainer);

                                var geometryDom = $child.children('.mpsContent');
                                thi$.parseMarkupValue(geometryDom.children(), geometryMarkup);

                                break;

                        }

                    }

                });

            },

            /**
             * charCodeToKey
             * @param charCode
             * returns key
             */
            charCodeToKey:function (charCode) {

                var deviceKeys = constants.keyboardPresets.fullMathField.deviceKeys;

                for (var node in deviceKeys) {
                    if (deviceKeys[node].charCodes.indexOf(charCode) != -1) return node;
                }

                throw('mathField ERROR - charCode ' + charCode + ' was not found.');
                return null;
            },

            /**
             * handleRemainderMarkupValue
             * @param markupValue
             */
            handleRemainderMarkupValue:function (markupValue) {
                // $
                markupValue = jQuery(markupValue);

                // search for remainder (if there is no remainder, this function is irrelevant)
                var remainderCounter = 0;
                markupValue.each(function (index, child) {
                    if (child.tagName.toLowerCase() == 'remainder') remainderCounter++;
                });

                // validate remainderCounter
                if (remainderCounter == 0) return markupValue;
                if (remainderCounter > 1)  return null;

                // 1. if (!'=') - null
                // 2. if (! only one '=') - null
                // get two sides of the eq.  eq.Left and eq. Right
                // set eqReminder  and   eqDivision
                // validate eqReminder is only Reminder
                // validate eqDivision that is only division
                // get divider mathString
                // repllace:  aRb = a +(b / divider)

                // count equal:
                var equalCounter = 0;
                markupValue.each(function (index, child) {
                    if (child.tagName.toLowerCase() == 'equal') equalCounter++;
                });

                // validate equalCounter
                if (equalCounter != 1) return null;

                var children;
                //handle completion - remove only for this function run
                markupValue.each(function (index, child) {
                    if (!!child && child.tagName.toLowerCase() == 'completion') {

                        children = jQuery(child).children();
                        markupValue.splice(index, 1);

                        children.each(function (innerIndex, innerChild) {
                            markupValue.splice((index + innerIndex), 0, innerChild);

                        });

                    }
                });

                // get two sides of the eq:
                var leftEq = [];
                var rightEq = [];
                var useLeftEq = true;
                var remainderAtLeft = true;

                // fill them
                markupValue.each(function (index, child) {
                    if (child.tagName.toLowerCase() == 'equal') {
                        useLeftEq = false;
                    } else {

                        if (child.tagName.toLowerCase() == 'remainder') remainderAtLeft = useLeftEq;

                        if (useLeftEq) leftEq.push(markupValue[index]);
                        else             rightEq.push(markupValue[index]);
                    }
                });

                // set remainderEq and divisionEq
                var remainderEq = (remainderAtLeft) ? leftEq : rightEq;
                var divisionEq = (!remainderAtLeft) ? leftEq : rightEq;

                // validate remainderEq - digits and remainder only
                var idx, validationGroup;
                for (idx in remainderEq) {
                    validationGroup = constants.validationGroup[remainderEq[idx].tagName.toLowerCase()];
                    if (validationGroup != 'digits' && validationGroup != 'remainder') return null;
                }

                // validate divisionEq and get divider
                var divider;
                // one structure
                var structureName;
                if (divisionEq.length == 1) {
                    structureName = divisionEq[0].tagName.toLowerCase();

                    switch (structureName) {

                        case 'fraction' :
                            // get denominator = divider
                            divider = jQuery(divisionEq[0]).children('denominator').children();
                            break;

                        case 'longdivision' :
                            // divider = divider
                            divider = jQuery(divisionEq[0]).children('divider').children();
                            break;

                        default:
                            return null;

                    }
                    // on structure validation end
                } else {

                    divider = [];

                    // validate for ratio or division
                    var rationDivisionFound = false, currElementTag;
                    for (idx in divisionEq) {
                        currElementTag = divisionEq[idx].tagName.toLowerCase();

                        if (currElementTag == 'ratio' || currElementTag == 'division') rationDivisionFound = true;
                    }

                    if (!rationDivisionFound) return null;

                    var divisionFound = false;
                    var expectDivision = null;
                    var parazitisCounter = 0;
                    var tagName, validationGroup;
                    var divisionIdx = -1;

                    for (idx in divisionEq) {

                        if (divisionFound) {
                            divider.push(divisionEq[idx]);
                        } else {

                            tagName = divisionEq[idx].tagName.toLowerCase();
                            validationGroup = constants.validationGroup[tagName];

                            switch (validationGroup) {

                                case 'openingParenthesis' :
                                case 'openingSquareParenthesis' :
                                    expectDivision = false;
                                    parazitisCounter++;
                                    break;

                                case 'closingParenthesiss' :
                                case 'closingSquareParenthesis' :
                                    parazitisCounter--;
                                    expectDivision = parazitisCounter == 0;
                                    break;

                                case 'digits' :
                                    expectDivision = (expectDivision == null) ? true : expectDivision;
                                    break;

                                case 'operators' :

                                    if (expectDivision && ( tagName == 'division' || tagName == 'ratio' )) {
                                        divisionFound = true;
                                        expectDivision = false;
                                        divisionIdx = eval(idx) + 1;
                                    } else {
                                        return null;
                                    }

                                    break;

                                default:
                                    if (expectDivision) break;

                            }

                        }

                    } // end else

                    if (divisionIdx == -1) return null;

                }

                var a = [], b = [], remainderReplacement = [], newMarkUpValue = [];
                // replace:  aRb = a +(b / divider)
                remainderEq.forEach(function (item) {
                    if (item.tagName.toLowerCase() != 'remainder') {
                        a.push(item);
                    } else {

                        jQuery(item).children().each(function (index, child) {
                            b.push(child);
                        });

                    }
                });

                remainderReplacement.push(jQuery('<leftparenthesis/>').get(0));
                a.forEach(function (item) {
                    remainderReplacement.push(item);
                });
                remainderReplacement.push(jQuery('<rightparenthesis/>').get(0));


                remainderReplacement.push(jQuery('<plus/>').get(0));
                remainderReplacement.push(jQuery('<leftparenthesis/>').get(0));

                b.forEach(function (item) {
                    remainderReplacement.push(item);
                });

                remainderReplacement.push(jQuery('<division/>').get(0));

                for (var item = 0; item < divider.length; item++) {
                    remainderReplacement.push(divider[item]);
                }

                remainderReplacement.push(jQuery('<rightparenthesis/>').get(0));

                divisionEq.push(jQuery('<equal/>').get(0));

                newMarkUpValue = jQuery.merge(divisionEq, remainderReplacement);

                return newMarkUpValue;

            }

        },

        // validation functions
        validation:{

            /**
             * start validation
             */
            start:function () {

                //remove prev mark of not valid elements
                this.thi$$._content.find('div').removeClass("not_valid");

                var groupType, groupTypeName, validationType, validationTypeName, validationGroupToBeChecked;

                //validation groups : digits, operators, relations etc..
                for (groupType in constants.validationConstrains) {

                    groupTypeName = constants.validationConstrains[groupType];

                    //validation types : symbols, structures, logic
                    for (validationType in groupTypeName) {

                        validationTypeName = groupTypeName[validationType];

                        //validation group to be checked
                        for (validationGroupToBeChecked in validationTypeName) {

//                          validationGroupToBeChecked = 'openingParenthesis', validationType = 'symbols',  groupType = 'digits'
                            if (this[validationType]) {
                                this[validationType](groupType, validationGroupToBeChecked);
                            }

                        }

                    }

                }

                this.checkRelativePosition();

                this.checkForEmptyParts();

                this.checkForGrouping();
            },

            /**
             * symbols
             * @param groupTypeName
             * @param validationGroupToBeChecked
             * check if after symbol with "validationGroup = groupTypeName" there is a symbol with "validationGroup = validationGroupToBeChecked"
             */
            symbols:function (groupTypeName, validationGroupToBeChecked) {
                var next_element, $child, thi$ = this;

                this.thi$$._content.find('div [validationGroup=' + groupTypeName + ']').each(function (index, child) {
                    $child = jQuery(child);
                    next_element = $child.next();

                    // validate if next exists and current symbol is inside of completion
                    if ((next_element.length == 0) && $child.parent().parent().hasClass('completion')) {
                        next_element = $child.parent().parent().next();
                    }

                    if ((next_element.length > 0) && !next_element.hasClass('not_valid')) { // if true, validate
                        if (next_element.attr('validationGroup') == validationGroupToBeChecked) {
                            thi$.markElementAsNotValid(next_element);
                        }
                    }

                });

            },

            /**
             * structures
             * @param groupTypeName
             * @param structureToBeChecked
             * check if after symbol with "validationGroup = groupTypeName" there is a structure with "class = structureToBeChecked"
             */
            structures:function (groupTypeName, structureToBeChecked) {
                var next_element, $child, thi$ = this;

                this.thi$$._content.find('div [validationGroup=' + groupTypeName + ']').each(function (index, child) {
                    $child = jQuery(child);
                    next_element = $child.next();

                    // validate if next exists and current symbol is inside of completion
                    if ((next_element.length == 0) && $child.parent().parent().hasClass('completion')) {
                        next_element = $child.parent().parent().next();
                    }

                    if ((next_element.length > 0) && !next_element.hasClass('not_valid')) { // if true, validate
                        if (next_element.hasClass(structureToBeChecked)) {
//                            console.log('groupTypeName=' + groupTypeName + ' structureToBeChecked=' + structureToBeChecked);
                            thi$.markElementAsNotValid(next_element);
                        }
                    }

                });
            },

            /**
             * logic
             * @param groupTypeName
             * @param childPlaceToBeChecked
             * check if symbol with "validationGroup = groupTypeName" first or last in the field
             * logic will validate last || first on whole MF and on each structre
             * exept completion structure (which doesn't considered as a structure)
             */
            logic:function (groupTypeName, childPlaceToBeChecked) {
                var $child, thi$ = this, next_element, prev_element;

                this.thi$$._content.find('div [validationGroup=' + groupTypeName + ']').each(function (index, child) {
                    $child = jQuery(child);
                    next_element = $child.next();
                    prev_element = $child.prev('.mpsLasso').parent('.mpsContent');

                    // validate if next exists and current symbol is inside of completion
                    if ((next_element.length == 0) && $child.parent().parent().hasClass('completion')) {
                        next_element = $child.parent().parent().next();
                        prev_element = $child.parent().parent().parent().children('.mpsContent');
                    }

                    if (!$child.hasClass('not_valid')) { // if true, validate
                        if (((childPlaceToBeChecked == 'first') && (prev_element.length > 0)) ||
                            (childPlaceToBeChecked == 'last') && (next_element.length == 0)) {
                            thi$.markElementAsNotValid($child);
                        }
                    }

                });
            },

            /**
             * markElementAsNotValid
             * @param element
             * mark current element as not valid
             */
            markElementAsNotValid:function (element) {
                element.addClass('not_valid');
                this.thi$$._frame.addClass("not_valid");
            },

            /**
             * checkRelativePosition
             1.    Thousands comma is only allowed after multiplications of 3 from the right of a whole number (relevant only in manual mode of the thousand’s separator).
             2.    A number with more than 2 digits can never start with a zero.
             3.    Zero can never be left alone in the fraction denominator
             */
            checkRelativePosition:function () {

                var digitUntilCommaCount = 0, digitsCount = 0, $child, thi$ = this, lastChild;

                this.thi$$._content.find('.mpsContent').each(function (index, mps) {

                    digitUntilCommaCount = 0;
                    digitsCount = 0;
                    jQuery(mps.children).toArray().reverse().forEach(function (child) {
                        $child = jQuery(child);

                        if ($child.attr('validationGroup') == 'digits') {
                            digitUntilCommaCount++;
                            digitsCount++;
                            lastChild = $child;
                        } else {

                            //A number with more than 2 digits can never start with a zero
                            if (digitsCount > 2) {
                                if (lastChild.text() == '0') {
                                    thi$.markElementAsNotValid(lastChild);
                                }
                            }

                            digitsCount = 0;  //start over digits counting

                            if (!thi$.thi$$.autoComma) {

                                //Thousands comma is only allowed after multiplications of 3 from the right of a whole number
                                if ($child.attr('validationGroup') == 'thousandsComma') {
                                    if (digitUntilCommaCount % 3 != 0) {
                                        thi$.markElementAsNotValid($child);
                                    }
                                }

                            }
                        }
                    });

                });


                //Zero can never be left alone in the fraction denominator
                this.thi$$._content.find('.denominator').each(function (index, denominator) {
                    if (denominator.innerText == '0') {
                        thi$.markElementAsNotValid(jQuery(denominator).children('.mpsContent'));
                    }
                });

            },

            /**
             * checkForEmptyParts
             * All structure parts and completion fields should be full
             */
            checkForEmptyParts:function () {
                var arrayOfMpsWrappers = this.thi$$.mpsWrapping.getActiveArray();

                if (arrayOfMpsWrappers.length > 0) {
                    this.thi$$._frame.addClass("not_valid");
                }

                arrayOfMpsWrappers.forEach(function (mpsWrapper) {
                    mpsWrapper.$wrapper.addClass('not_valid');
                });
            },

            /**
             * checkForGrouping
             * 1.    Opened parenthesis need to be closed by the same type.
             2.    Closed parenthesis need to be opened by the same type.
             3.    Round parenthesis can’t contain rectangular parenthesis.
             */
            checkForGrouping:function () {
                var objParenthesis, $child, thi$ = this;

                this.thi$$._content.find('.mpsContent').each(function (index, mps) {

                    objParenthesis = [];

                    jQuery(mps.children).each(function (index, child) {
                        $child = jQuery(child);

                        switch ($child.text()) {
                            case '(' :
                                objParenthesis.push({
                                    obj:$child,
                                    opened:true,
                                    type:'round'
                                });

                                break;
                            case ')' :
                                objParenthesis.push({
                                    obj:$child,
                                    opened:false,
                                    type:'round'
                                });
                                break;
                            case '[' :
                                objParenthesis.push({
                                    obj:$child,
                                    opened:true,
                                    type:'square'
                                });
                                break;
                            case ']' :
                                objParenthesis.push({
                                    obj:$child,
                                    opened:false,
                                    type:'square'
                                });
                                break;
                        }

                    });

                    var stackIndex, found, stackParenthesis = [], tmpArray = [];

                    objParenthesis.forEach(function (currObject) {

                        if (stackParenthesis.length == 0) {
                            stackParenthesis.push(currObject);
                        } else {

                            found = false;

                            for (stackIndex = 0; stackIndex < stackParenthesis.length; stackIndex++) {
                                //Check if the one on stack is a matching opening char
                                if ((currObject.type == stackParenthesis[stackIndex].type) && (currObject.opened != stackParenthesis[stackIndex].opened)) {
                                    //Round parenthesis can’t contain rectangular parenthesis
                                    if ((stackIndex > 0) && (stackParenthesis[stackIndex].type == "square")) {

                                        //check prev parenthesis for round ones
                                        tmpArray = jQuery.grep(stackParenthesis, function (element, index) {
                                            return (element.type == "round" && (index < stackIndex));
                                        });

                                        found = (tmpArray.length == 0);

                                        if (found) {
                                            stackParenthesis.splice(stackIndex, 1);   //found match parenthesis remove it's pair from stack
                                            break;
                                        }


                                    } else {
                                        found = true;
                                        stackParenthesis.splice(stackIndex, 1);   //found match parenthesis remove it's pair from stack
                                        break;
                                    }
                                }
                            }

                            if (!found) {
                                stackParenthesis.push(currObject);
                            }
                        }

                    });

                    stackParenthesis.forEach(function (object) {
                        thi$.markElementAsNotValid(object.obj);
                    });

                });
            },

            /**
             * validateCalculationCorrectness
             * (check for: =, >, <, !=, <=, >=, ~~)
             */
            validateCalculationCorrectness:function (finalMathString) {
                var res = false;

                constants.correctnessValidationMathString.forEach(function (item) {
                    if (finalMathString.indexOf(item) != -1) res = true;
                });

                return res;
            },

            /**
             * preValidate function
             * make some pre-validation markup manipulations
             */
            preValidate : function(){
                var thi$ = this;

                // merge two power structures
                //in case there is two consecutive power structures - merge them
                this.thi$$._view.find('.mpsContent').first().find('.power').each(function(index, power){
                    if (jQuery(power).next().hasClass('power')){
                        var nextPowerChildren = jQuery(power).next().children('.mpsContent').children();
                        nextPowerChildren.remove('.mpsLasso').remove('.mpsAnchor');
                        // merge
                        jQuery(power).children('.mpsContent').append(nextPowerChildren);
                        jQuery(power).next().remove();

                        thi$.thi$$.alignAnchors();
                    }
                });
            }
        },

        // selection functions
        selection:{
            /**
             * remove current selection
             * @param thi$
             */
            remove:function (thi$) {
                thi$._view.find('div.selection').removeClass('selection');
            },

            /**
             * setStartPosition
             * set start position of the selection
             * @param e
             */
            setStartPosition:function (e) {
                this.start = {'x':e.pageX, 'y':e.pageY};
            },

            /**
             * removeStartPosition
             * remove start position of the selection
             */
            removeStartPosition:function () {
                this.start = {};
            },

            /**
             * get current selection markup
             */
            get:function () {

                if (!!!this.selectionMap) {
                    return [];
                }

                var arrSelection = [];

                this.selectionMap.forEach(function (element) {
                    if (element.selectObj.hasClass('selection')) {
                        arrSelection.push(element);
                    }
                });

                return arrSelection;
            },

            /**
             * deleteSelection
             */
            deleteSelection:function () {
                var selectionMarkUp = this.get();

                if (selectionMarkUp.length == 0) return false;

                // find lefter object
                var lefterSelectedElement = selectionMarkUp[0];

                jQuery(selectionMarkUp).each(function (index, child) {
                    if (child.left < lefterSelectedElement.left) lefterSelectedElement = child;
                });

                // place caref before the most left object
                this.thi$$.placeCaret(lefterSelectedElement.obj, constants.appendType.before);  //place caret before first element in selection

                var thi$ = this;
                // delete selection
                selectionMarkUp.forEach(function (element) {
                    element.obj.first().remove();
                    element.selectObj.first().remove();

                    var index = thi$.selectionMap.indexOf(element); //remove current removed element from selection map
                    if (index != -1) thi$.selectionMap.splice(index, 1);

                });

                return true;
            },
            /**
             * mark content on mousemove
             * @param e
             */
            mark:function (e) {
                var thi$$ = (e.data.thi$$);
                var thi$ = thi$$.selection;

	            var $target = jQuery(e.target);
	            var insideMathField = !!$target.parents('#' + thi$$._view.attr('id')).length;
	            $target = null;

                if (thi$.start && thi$.start.x && thi$.oMps && insideMathField) {

                    thi$.remove(thi$$);

                    thi$.stop = {'x':e.pageX, 'y':e.pageY};

                    var selectionArea = thi$.setSelectionArea(thi$.start, thi$.stop, thi$.oMps.obj.height());
                    selectionArea.left -= constants.caret.width;   //2px of caret width

                    jQuery(thi$$.selection.selectionMap).each(function (index, child) {
                        // check child cords
                        if (((child.left > selectionArea.left) && (child.left < selectionArea.right)) ||
                            ((child.right > selectionArea.left) && (child.right < selectionArea.right)) /*||
                         ((child.top > selectionArea.top) && (child.top < selectionArea.bottom)) ||
                         ((child.bottom > selectionArea.top) && (child.bottom < selectionArea.bottom))*/

                            ) {
                            child.selectObj.addClass('selection');
                        } else {
                            child.selectObj.removeClass('selection');
                        }
                    });
                }

            },

            /**
             * setSelectionArea - set selection area object (right, left, top, bottom)
             * @param start
             * @param stop
             * @param elementHeight
             */
            setSelectionArea:function (start, stop, elementHeight) {
                var selectionArea;
                if (start.x < stop.x) {  //ltr selection
                    selectionArea = {
                        'left':start.x,
                        'right':stop.x,
                        'top':start.y - elementHeight,
                        'bottom':start.y
                    };

                } else {
                    selectionArea = {
                        'left':stop.x,
                        'right':start.x,
                        'top':start.y - elementHeight,
                        'bottom':start.y
                    };
                }
                return selectionArea;
            },

            /**
             * getOriginalMps
             * get mps where selection is started
             */
            getOriginalMps:function () {

                // oMps = original Mps
                var oMps, thi$ = this;
                if (!thi$.mpsPositions) return;

                jQuery(thi$.mpsPositions).each(function (index, child) {

                    if (thi$.start.x > child.left && thi$.start.x < child.right &&
                        thi$.start.y > child.top && thi$.start.y < child.bottom) {

                        if (oMps) {

                            if (child.top > oMps.top || child.bottom < oMps.bottom
                                || child.left > oMps.left || child.right < oMps.right) {

                                oMps = child;

                            }

                        } else {
                            oMps = child;
                        }

                    }

                });
                // override oMps
                this.oMps = oMps;

            },

            /**
             * createSelectionMap
             * map all symbols and structures inside of original mps (selected mps)
             */
            createSelectionMap:function () {
                var thi$ = this;
                this.selectionMap = [];

                if (thi$.oMps) {
                    this.selectionMap = this.createMpsSelectionMap(thi$.oMps.obj);

                    var parentSelectionMap = [];

                    jQuery(thi$.oMps.obj).parents('.mpsContent').each(function (index, mps) {
                        parentSelectionMap = thi$.createMpsSelectionMap(mps);
                        thi$.selectionMap = jQuery.merge(thi$.selectionMap, parentSelectionMap);
                    });

                }

            },

            /**
             * createMpsSelectionMap
             * map all symbols and structures of specific mps
             * @param mps
             */
            createMpsSelectionMap:function (mps) {

                var thi$ = this, $child, $mps = jQuery(mps);

                var mpsSelectionData = [];

                $mps.children().each(function (index, child) {

                    $child = jQuery(child);

                    if ($child.hasClass('symbol') || $child.hasClass('icon')) {
                        mpsSelectionData.push(thi$.createSymbolSelectionMap($child));
                    } else if ($child.hasClass('structure')) {
                        mpsSelectionData.push(thi$.createStructureSelectionMap($child));
                    }

                });

                return mpsSelectionData;

            },

            /**
             * createSymbolSelectionMap
             * get data of current symbol (right, left, bottom, top, object) and create placeholder div for selection
             * @param $symbol
             */
            createSymbolSelectionMap:function ($symbol) {

                var symbolData = this.getElementData($symbol);
                return this.createSelectionDiv(symbolData);

            },

            /**
             * createSelectionDiv
             * create placeholder div for selection
             * @param data
             */
            createSelectionDiv:function (data) {
                var selectionDiv = jQuery('<div/>').offset({'top':data.top - this.thi$$._content.offset().top,
                    'left':(data.left - this.thi$$._content.offset().left + constants.caret.width)})
                    .attr('class', 'selection_placeholder')
                    .css({'width':(data.right - data.left + constants.caret.width), height:data.bottom - data.top, 'position':'absolute', 'z-index':'10'})
                    .appendTo(this.thi$$._view);   //, 'outline': '1px solid #CCCCCC'

                data.selectObj = selectionDiv;
                return data;
            },

            /**
             * removeSelectionDiv
             * remove all selection placeholders from DOM
             */
            removeSelectionDiv:function () {
                this.thi$$._view.find('.selection_placeholder').remove();
            },

            /**
             * createStructureSelectionMap
             * get data of current structure (right, left, bottom, top, object) and create placeholder div for structure selection
             * @param $structure
             */
            createStructureSelectionMap:function ($structure) {

                var structureData = this.getStructureData($structure);
                return this.createSelectionDiv(structureData);

            },

            /**
             * getStructureData
             * get data of current structure (right, left, bottom, top)
             * @param $structure
             */
            getStructureData:function ($structure) {

                var structureData = null, childData = null, thi$ = this, $child, arrChildren = [];

                arrChildren = $structure.find('.mpsContent,.symbol,.structure');

                if (!arrChildren.length) {
                    return null;
                }

                arrChildren.each(function (index, child) {
                    $child = jQuery(child);

                    childData = thi$.getElementData($child);

                    if (!structureData) {
                        structureData = childData;
                    } else {
                        structureData.top = (structureData.top < childData.top) ? structureData.top : childData.top;
                        structureData.bottom = (structureData.bottom > childData.bottom) ? structureData.bottom : childData.bottom;
                        structureData.left = (structureData.left < childData.left) ? structureData.left : childData.left;
                        structureData.right = (structureData.right > childData.right) ? structureData.right : childData.right;
                    }


                });

                structureData.obj = $structure;

                return structureData;
            },

            /**
             * getElementData
             * get data of current element (right, left, bottom, top, object)
             * @param $element
             */
            getElementData:function ($element) {
                return {
                    'top':$element.offset().top,
                    'bottom':$element.offset().top + $element.height(),
                    'left':$element.offset().left,
                    'right':$element.offset().left + $element.width(),
                    'obj':$element
                };
            },

            /**
             * storeAllMpsPositions
             * iterate all mpsContent divs and store the data in mpsPositions array
             * @param $view
             */
            storeAllMpsPositions:function ($view, returnThisMpsCords, mpsSelector) {
                var thi$ = this, childData, mpsData, children = [], structures = [], mpsSelection = null;
                this.mpsPositions = [];

                if (!!mpsSelector) {
                    mpsSelection = $view.find(mpsSelector);
                } else {
                    mpsSelection = $view.find('.mpsContent');
                }

                // loop all MF mps and get cords
                mpsSelection.each(function (index, mps) {

                    mps = jQuery(mps);
                    mpsData = null;
                    children = [];

                    // loop all symbols, get cords
                    mps.children('.symbol').each(function (index, child) {
                        childData = thi$.getElementData(jQuery(child));
                        children.push(childData);
                    });

                    // reset structures array
                    structures = [];

                    // loop all structures, get cords
                    mps.children('.structure').each(function (index, structure) {

                        var structureData = null;

                        jQuery(structure).find('.mpsContent').each(function (index, child) {
                            childData = thi$.getElementData(jQuery(child));

                            if (!structureData) {
                                structureData = childData;
                            } else {
                                structureData.top = (structureData.top < childData.top) ? structureData.top : childData.top;
                                structureData.bottom = (structureData.bottom > childData.bottom) ? structureData.bottom : childData.bottom;
                                structureData.left = (structureData.left < childData.left) ? structureData.left : childData.left;
                                structureData.right = (structureData.right > childData.right) ? structureData.right : childData.right;
                            }
                        });

                        structures.push(structureData);
                    });

                    mpsData = thi$.getMpsCords(thi$.getElementData(mps), null);
                    mpsData = thi$.getMpsCords(children, mpsData);
                    mpsData = thi$.getMpsCords(structures, mpsData);

                    if (mpsData) {
                        mpsData.obj = mps;
                        mpsData.children = children;       //symbols children
                        mpsData.structures = structures;   //structures children
                        // on returnThisMpsCords, return the first mpsData. this return will only exit fron the current each
                        if (returnThisMpsCords) return mpsData;
                        thi$.mpsPositions.push(mpsData);
                    }

                });

                // on returnThisMpsCords, return the first mpsData.
                if (returnThisMpsCords) return mpsData;
                return this.mpsPositions;
            },

            /**
             * getMpsCords
             * get (top, bottom, left, right) coordinates of mps based on array of it's symbols or structures
             * @param dataArray
             * @param mpsData
             */
            getMpsCords:function (dataArray, mpsData) {

                if (dataArray.length == 0) {
                    if (mpsData) return mpsData;
                    else         return null;
                }

                jQuery(dataArray).each(function (index, child) {
                    if (!mpsData) {
                        mpsData = child;
                    } else {

                        if (child) {
                            mpsData.top = (mpsData.top < child.top) ? mpsData.top : child.top;
                            mpsData.bottom = (mpsData.bottom > child.bottom) ? mpsData.bottom : child.bottom;
                            mpsData.left = (mpsData.left < child.left) ? mpsData.left : child.left;
                            mpsData.right = (mpsData.right > child.right) ? mpsData.right : child.right;
                        }

                    }

                });

                return mpsData;

            }
        },

        // initMarkup functions
        initMarkup:{

            /**
             * remove
             * removes MF markUp
             */
            remove:function () {

                this.thi$$.mpsWrapping.collection = [];
                this.thi$$.selection.collection = [];

                this.thi$$._content.children('.mpsWrapper').remove();

                this.thi$$._content.children('.mpsContent').first().children('.number,.symbol,.structure').remove();
            },

            /**
             * start
             * @param markup
             * parse param markUp
             */
            start:function (markup) {

                var thi$ = this;
                this.thi$$.dontEnableKeyboard = true;

                var mpsContent = this.thi$$._content.find('.mpsContent');
                this.thi$$.placeCaret(mpsContent, constants.appendType.intoLast);
                var dataArray = jQuery(markup).children();

	            console.time('mathfield parse');
                thi$.parse(dataArray, true, thi$);
	            console.timeEnd('mathfield parse');

	            dataArray = null;

            },

            /**
             * parse
             * @param dataArray
             * @param mainRoot
             * @param thi$
             */
            parse:function (dataArray, mainRoot, thi$) {

                //if in config we got viewObject - use it don't parse data
                if (this.thi$$.cfg.viewObject) {
	                this.thi$$._view.remove();
                    this.thi$$._view = this.thi$$.cfg.viewObject;

                    this.thi$$.cfg.parent.html(this.thi$$._view);
	                this.thi$$.endEdit();
	                delete this.thi$$.cfg.viewObject;
	                this.thi$$._view.show();
                    return;
                };

                var tagName, key, completionStructure, completionChildren, completiontype, $child;

                thi$ = thi$ ? thi$ : this;

                jQuery(dataArray).each(function(index, child) {

	               tagName = child.tagName.toLowerCase();
	               key = constants.lowerCaseKeyToKey[tagName];
	               $child = jQuery(child);

	               thi$.thi$$.onKeyboardPressed(key);

                    //if last structure was removed - don't parse it's children
                    if (!!!(thi$.thi$$.lastStructureRemovedFlag)) {

                        switch (tagName) {

                            case 'completion':

                                completionStructure = thi$.thi$$.caret.parent().parent();
                                completiontype = $child.attr('completiontype');

                                if (completiontype == 'O') {
                                    completionStructure.addClass('operator');
                                }

                                completionStructure.attr('completiontype', completiontype);
                                thi$.thi$$.mpsWrapping.updateRegistration(completionStructure.children('.mpsContent').attr('id'), 'completionType', completiontype);

                                completionChildren = $child.children();
                                thi$.parse(completionChildren);

                                thi$.thi$$.placeCaret(completionStructure, constants.appendType.after);

	                            completionStructure = null; completionChildren = null;

                                break;

                            case 'fraction':

                                var fractionStructure = thi$.thi$$.caret.parent().parent().parent().parent();
                                var denominatorMps = thi$.thi$$.caret.parent().parent().next().next().children('.mpsContent');

                                var numerator = $child.children('numerator').children();
                                thi$.parse(numerator);

                                thi$.thi$$.placeCaret(denominatorMps, constants.appendType.intoLast);

                                var denominator = $child.children('denominator').children();
                                thi$.parse(denominator);

                                thi$.thi$$.placeCaret(fractionStructure, constants.appendType.after);

	                            fractionStructure = null;  denominatorMps = null; numerator = null; denominator = null;

                                break;

                            case 'longdivision':

                                // on long division in us/singapure locale
                                // the division line vertical part is straight and the dividend is placed to the left of the divisor
                                // in israel locale : the division line vertical part is straight and the dividend is placed to the right of the divisor
                                var longDivisionStructure = thi$.thi$$.caret.parent().parent().parent().parent();
                                var firstChildMps = longDivisionStructure.find('.divided').first().children('.mpsContent');
                                var lastChildMps = longDivisionStructure.find('.divider').first().children('.mpsContent');

                                thi$.thi$$.placeCaret(firstChildMps, constants.appendType.intoLast);

                                thi$.parse($child.find('divided').first().children());

                                thi$.thi$$.placeCaret(lastChildMps, constants.appendType.intoLast);

                                thi$.parse($child.find('divider').first().children());

                                thi$.thi$$.placeCaret(longDivisionStructure, constants.appendType.after);

                                break;

                            case 'remainder':

                                // on remainder - caret will placed automaticly on the remainder's mps
                                var remainderStructure = thi$.thi$$.caret.parent().parent();
                                var remainder = $child.children();
                                thi$.parse(remainder);

                                thi$.thi$$.placeCaret(remainderStructure, constants.appendType.after);

	                            remainderStructure = null; remainder = null;

                                break;

                            case 'power' :
                                // on power - caret will placed automaticly on the power's mps
                                var powerStructure = thi$.thi$$.caret.parent().parent();
                                var power = $child.children();
                                thi$.parse(power);
                                thi$.thi$$.placeCaret(powerStructure, constants.appendType.after);

	                            powerStructure = null; power = null;
                                break;

                            case 'absolute' :
                                var absoluteStructure = thi$.thi$$.caret.parent().parent();

                                thi$.parse($child.children());

                                thi$.thi$$.placeCaret(absoluteStructure, constants.appendType.after);
                                break;

                            case 'segment' :
                            case 'rayright':
                            case 'rayboth' :
	                        case 'angle_geometry' :

                                // on geometry - caret will placed automaticly on the geometry's mps
                                var geometryStructure = thi$.thi$$.caret.parent().parent();

                                var geometry = $child.children();
                                thi$.parse(geometry);

                                thi$.thi$$.placeCaret(geometryStructure, constants.appendType.after);

	                            geometryStructure = null; geometry = null;

                                break;

                        }
                    }

	                $child = null;

                });

                // on function end, on main root, remove caret.
                if (!!mainRoot) {
                    thi$.thi$$.caret.remove();
                }

                thi$.thi$$.alignAnchors();

	            dataArray = null;

            }

        },

	    setFrameWidthAndHeight:function (){
		    if (this.widthMode.fixedWidth) {
			    this._frame.width(this.widthMode.width + 'em');
			    this._view.width(this._frame.width() + constants.frameStyle.padding.left + constants.frameStyle.padding.right);
		    } else {    //in case of empty field
			    this._frame.width(constants.frameStyle.size.minWidth + 'em');
		    }

		    if (this.editMode || this.completionMode) {
			    this._frame.width(this._frame.width() + constants.frameStyle.border.width * 2);
			    this._frame.height(this._frame.height() + constants.frameStyle.padding.top + constants.frameStyle.padding.bottom);
		    }
	    }, /**
	     * initView
	     * Init view
         */
        initView:function () {
			//if in config we got viewObject - use it don't parse data
	        if (this.cfg.viewObject) {

		        this.initMarkup.start(this.cfg.data);

		        //reset jQuery objects
		        this._view = jQuery('#' + this._view.attr('id'));
		        this._content = this._view.children('.mathField_content');
		        this._frame = this._view.children('.frame');

	        } else {

		        this.setFontSize(this.fontSize);

		        // set maxHeight margins
		        this._view.css({'margin-top':constants.maxHeight[this.maxHeight.stringValue], 'margin-bottom':constants.maxHeight[this.maxHeight.stringValue]});

		        // get reduction step and set font-size
		        if (this.reductionStep > 0) { //if reductionStep > 0, calculate font-size according to it
			        var reducedFontSize = this.calcFontSizeByReduction();
			        this._view.css('font-size', reducedFontSize + 'px');
		        }

		        var pxEm = this._view.css('font-size').px2int();

		        this.maxHeight.deltaTop = (constants.maxHeight[this.maxHeight.stringValue].em2int()) * pxEm;
		        this.maxHeight.deltaBottom = (constants.maxHeight[this.maxHeight.stringValue].em2int()) * pxEm;

		        this.setFrameWidthAndHeight();

		        //parsing of init markUp should be after finishing of frame width and height settings
		        this.initMarkup.start(this.cfg.data);

		        if (this.completionMode) {
			        this._view.addClass(constants.classes.completion);
		        }

		        this.alignAnchors();

		        // align Frame on init MF.
		        // even if MathField is empty
		        this.alignFrame();

		        if (window['globalEvents']) {  //there is no global events in CGS, check for global variable existence
			        var thi$ = this;
			        // check mathfield vs. container
			        // if mathfield is too wide, reduce and blowup if necessary
			        window['globalEvents'].add({
				        fnc:function () {
					        if(!thi$._frame) {
						        return;
					        }

					        thi$.initFrameSize = {'width' : thi$._frame.width(), 'height' : thi$._frame.height() };
					        thi$.checkWidthVsContainer();
				        }
			        });
		        } else {
			        this.initFrameSize = {'width' : this._frame.width(), 'height' : this._frame.height() };
			        this.checkWidthVsContainer();
		        }

	        }

		    if (this.reductionStep > 0) {
			    this.fontSize = this.calcFontSizeByReduction();
		    }

        },

        /**
         * createSymbolDivString
         * Create a symbol div string
         * @param character {String} character to create the symbol from
         * @param key
         */
        createSymbolDivString:function (character, key) {
            var html = '';
            var character;

            if (character in constants.symbolsHash) {
                html = Mustache.to_html(templates.symbol, {
                    symbol:constants.classes.symbol,
                    type:constants.symbolsHash[character].type,
                    value:character,
                    validationGroup:constants.validationGroup[key]
                });
            }

            return html;
        },

        /**
         * initEvents
         * Init events
         */
        initEvents:function () {

            var thi$ = this;
            if (this.devMode) {

                var devLogger = this.devLogger = jQuery('<div/>').css({'width':'900px', 'height':'300px', 'border':'1px solid black', 'position':'fixed', 'top':'400px'}).appendTo(Perf.select('body'));
                this._view.next().click(function () {
                    devLogger.text(thi$.calculate.markupValue());
                });

                this._view.next().next().click(function () {
                    devLogger.text(thi$.calculate.value() == null ? 'null' : thi$.calculate.value());
                });

                this._view.next().next().next().click(function () {
                    devLogger.text(thi$.calculate.correctness() == null ? 'null' : thi$.calculate.correctness());
                });

                this._view.next().next().next().next().click(function () {
                    thi$.reduce();
                    devLogger.text('reduction');
                });

            }

            if (this.editMode || this.completionMode) {
                var thi$ = this;

                thi$.afterClick = false;

//                  TODO: check the need for this code
//                    var mpsPositions;
//                    var closestMpsPosition;
                var placeCaretInClosestMps = function (eventX) {

//                        mpsPositions = thi$.selection.getMpsPositions();
//                        closestMpsPosition = mpsPositions[0];
//                        mpsPositions.forEach(function(mpsPosition) {
//                            if (Math.abs(eventX - mpsPosition.right) < Math.abs(eventX - closestMpsPosition.right)) {
//                                closestMpsPosition = mpsPosition;
//                            }
//                        });
//
//                        thi$.placeCaret(closestMpsPosition.obj, constants.appendType.intoLast);
                };



                // Place the caret on mouse up
                jQuery('.{0}'.format(constants.classes.symbol), this._view)
                    .mouseup(thi$.onSymbolMouseUp);

	            function placeCaretByTarget(mpsContent) {
		            if(thi$.caret && thi$.caret.parent().length) {
			            return;
		            }

		            if (thi$.editMode) {
			            thi$._view.removeClass('not_selectable');

			            if(mpsContent.parent().hasClass('longDivision')) {
				            return false;
			            }

			            // The mathfield caught mouseup that is not on a symbol - so check for mps
			            thi$.placeCaret(mpsContent, constants.appendType.intoLast);

		            } else if (thi$.completionMode) {
			            //if mouseup is over completion structure
			            if ((mpsContent.hasClass('mpsContent')) && (mpsContent.parents('.completion.structure').length >= 1)
				            && (!mpsContent.parent().hasClass('mathField_content'))) {
				            thi$.placeCaret(mpsContent, constants.appendType.intoLast);
			            }
		            }
	            }

	            //content mouse events
	            var onContentClick = function (e) {
		            e.preventDefault();
		            e.stopPropagation();
	            };

	            var onContentMouseDown = function (e) {
		            e.stopImmediatePropagation();
		            e.stopPropagation();

		            if (!thi$.isEnabled()) return;

		            thi$.dontEnableKeyboard = false;

		            thi$.afterClick = true;
		            thi$.selection.remove(thi$);                      //remove prev selection
		            thi$.selection.setStartPosition(e);               //set start (x,y) of current selection
		            thi$.selection.storeAllMpsPositions(thi$._view);  //store all mps in array

		            thi$.selection.getOriginalMps();                  //get mps that in the selection

		            thi$.selection.removeSelectionDiv();              //remove all selection placeholders div
		            thi$.selection.createSelectionMap();              //fill map of symbols and structures for original mps and it's parents

		            // Remove the caret and selection if any
		            if (thi$.caret) thi$.caret.remove();

		            // Start edit if edit mode
		            if (thi$.editMode) {
			            // bind mouse move
			            thi$._view.addClass('not_selectable');
			            thi$.targetDocument.bind('mousemove', {thi$$:thi$}, thi$.selection.mark);     //do selection mark on mousemove

			            /**
			             * Stop tracking mouse when button is released.
			             */
			            var documentUnbindMousemove = function (event) {
				            thi$.targetDocument.unbind('mousemove', thi$.selection.mark);
				            event.stopImmediatePropagation();
				            event.stopPropagation();
				            event.preventDefault();
				            return false;
			            };

			            thi$.targetDocument.mouseup(documentUnbindMousemove);

			            thi$.startEdit();

			            if(ENV.behaviors.isTablet) {
				            var mpsContent = thi$.searchMpsContent(jQuery(e.target));
				            if(!mpsContent) {
					            mpsContent = jQuery(e.target).children('.mpsContent');
				            }

				            placeCaretByTarget(mpsContent);
			            }

		            }

		            //if in completion mode - check if we in completion structure now - than start edit
		            if (thi$.completionMode && !!thi$.selection.oMps) {
			            // init flag
			            var applyStartEdit = false, $child;

			            // seaech '.completion' parents
			            thi$.selection.oMps.obj.parents('.completion').each(function(index, child){
				            // apply start edit only if the found elements doesn't contains mathField class
				            // if it does, this is not a structure
				            $child = jQuery(child);
				            if (!$child.hasClass('mathField')){
					            applyStartEdit = true;
				            }
			            });

			            // exec. start edit
			            if (applyStartEdit) {
				            thi$.startEdit();
			            }
		            }

		            e.preventDefault();
		            e.stopPropagation();
	            };

	            var onContentMouseUp = function (e) {
		            if (!thi$.isEnabled()) return;

		            //remove prev selection
		            thi$.afterClick = false;
		            thi$.selection.removeStartPosition(thi$);

		            var $target = jQuery(e.target);
		            var mpsContent = thi$.searchMpsContent($target);
		            if(!mpsContent) {
			            mpsContent = $target.children('.mpsContent');
		            }
		            $target = null;

		            placeCaretByTarget(mpsContent);

		            e.preventDefault();
		            e.stopPropagation();
	            };


                this._content.mouseup(onContentMouseUp)
                             .click(onContentClick)
                             .mousedown(onContentMouseDown);


	            //frame mouse events
	            var frameMouseDown = function (e) {
		            if (!thi$.isEnabled()) return;

		            thi$.selection.storeAllMpsPositions(thi$._view);
		            if (thi$.editMode) {
			            thi$.dontEnableKeyboard = false;
			            thi$.startEdit();
			            thi$.placeCaretAtEnd();
		            }
		            e.preventDefault();
		            e.stopPropagation();
	            };

	            var frameMouseUp = function (e) {
		            if (!thi$.isEnabled()) return;
		            placeCaretInClosestMps(e.pageX);
		            e.preventDefault();
		            e.stopPropagation();
	            };

	            this._frame.mousedown(frameMouseDown)
		            .mouseup(frameMouseUp);

            }
        },

        /**
         * find jqElement sibling or closest mpsContent
         * @param jqElement
         */
        searchMpsContent:function (jqElement) {
            var mpsContent;
            if (jqElement.hasClass('mpsContent')) {
                mpsContent = jqElement;
            } else {
                //mpsContent with mpsStructureWrapper attribute equal true - is readOnly, exclude it from jQuery selector
                mpsContent = jqElement.siblings('[class="mpsContent"][mpsStructureWrapper!="true"]');
                if (mpsContent.length == 0) {
                    mpsContent = jqElement.closest('[class="mpsContent"][mpsStructureWrapper!="true"]');
                }
            }

            return (mpsContent.length > 0) ? mpsContent : null;
        },

        /**
         * placeCaret
         * Place the caret after/before the specified element
         * @param jqElement
         * @param appendType
         */
        placeCaret:function (jqElement, appendType) {

            if ((!!!jqElement) || (jqElement.length == 0)) {
                return;
            }

            //remove current selection
            this.selection.removeSelectionDiv();
            // remove current caret
            this._view.find('.caret').remove();

            var caret = jQuery(Mustache.to_html(templates.caret));
            caret.height(jqElement.height() - 3);

            switch (appendType) {

                case constants.appendType.before:
                    caret.insertBefore(jqElement);
                    break;

                case constants.appendType.after:
                    caret.insertAfter(jqElement);
                    break;

                case constants.appendType.intoFirst:
                    caret.prependTo(jqElement);
                    break;

                case constants.appendType.intoLast:
                    caret.appendTo(jqElement);
                    break;
            }

            this.caret = caret;

            if (!!this.keyboard && !this.dontEnableKeyboard)
                this.setKeyboardByCaretPosition();

        },

        /**
         * placeCaretAtEnd
         * Place the caret at the end of the math field
         */
        placeCaretAtEnd:function () {
            this.placeCaret(this._content.children('.mpsContent').last(), constants.appendType.intoLast);
        },

        /**
         * onSymbolMouseUp
         * On symbol mouse up event
         * @param e
         */
        onSymbolMouseUp:function (e) {
            this.afterClick = false;

            this.selection.removeStartPosition();
            this.targetDocument.unbind('mousemove', this.selection.mark);

            var jqElement = jQuery(e.target);

            if (((this.selection.get().length == 0) && this.editMode) || (jqElement.parents('.structure').hasClass('completion'))) {
                // Place the caret before / after 'this' element
                var appendType = constants.appendType.before;
                if (e.offsetX > (jqElement.width() / 2)) appendType = constants.appendType.after;
                this.placeCaret(jqElement, appendType);
            }

            e.preventDefault();
            e.stopPropagation();
	        return false;
        },

        /**
         * isEmpty
         * @return {Boolean}
         */
        isEmpty:function () {
            if (this.editMode) {
                return (this._content.children('.mpsContent').first().children().length <= 1);
            } else if(this.completionMode) {
                return (this._content.children('.mpsContent').children('.completion').children('.mpsContent').children().length <= 1);
            }

            return false;
        },


        /**
         * startEdit
         * Start editing of the mathfield
         */
        startEdit:function () {
		
    		if(this.cfg.useMathfieldKBHack || ENV.behaviors.useMathfieldKBHack){
            	if( window._hack_close_mf_keyboard) {
                	 for( var i=0;i<window._hack_close_mf_keyboard.length;i++ ) {
                		 var func = window._hack_close_mf_keyboard[i] ;
                		 func && func() ;
                	 }
                	 window._hack_close_mf_keyboard = [] ;
                }
            }

            // Set focus class
            this._view.addClass(constants.classes.focus).removeClass(constants.classes.blur);
            this._frame.removeClass("not_valid");

            // Start the keyboard
            this.startKeyboard();

            if (this.keyboard) {
                this.keyBoardOpen = true;
            }

	        if(!ENV.behaviors.isTablet) {
	            this._input.focus();
	        }

            //if on phonegap need to add blur event else the keyboard will flod
            //todo: need to repalce with useExternalKeyboard

            if( !! ENV.behaviors.useExternalMediaPlayer && !ENV.behaviors.overrideMathNativeKeyboard ){
                var self = this;
                this._view.find(".editMobile").on("blur",$.proxy(function(){
                    if(self._view.hasClass(constants.classes.focus)){
                       self._view.find(".editMobile").focus();
                    }
                },this));
            }

	        if (this.cfg.onStartEdit) {  //onStartEdit function from config (Text Editor)
		        this.cfg.onStartEdit();
	        }

	        //check if keyboard still didn't open (ipad bug)
	        var thi$ = this;
	        setTimeout(function(){
				if(!thi$.keyboard) {
					thi$.startKeyboard();
				}
	        }, 0);
            
        },

        /**
         * endEdit
         * End editing of the mathfield
         */
        endEdit:function () {

            if (this.cfg.onEndEdit) { //onEndEdit function from config (Text Editor)
                this.cfg.onEndEdit();
            }

            // hide the keyboard
            if (this.keyboard) {
	            this.keyboard.hide();
                this.keyBoardOpen = false;
            }

            // Remove focus class
            this._view.removeClass(constants.classes.focus).addClass(constants.classes.blur);

            // Remove caret
            !!this.caret && this.caret.removeNative();
	        delete this.caret;

            //remove selection
            this.selection.remove(this);
	        if(!!this.selection.selectionMap) {
		        delete this.selection.selectionMap;
	        }

	        if(!!this.selection.oMps) {
		        delete this.selection.oMps.obj;
		        delete this.selection.oMps;
	        }

            // preValidate
            this.validation.preValidate();

            // validate
            if (this.activeValidation) {
                this.validation.start();
            }

	        this.mpsWrapping.alignWrappers();

            if (this.isEmpty() && this.showMFEmptyIcon) { //MF is Empty
                this._view.addClass('empty');
            } else {
                this._view.removeClass('empty');
            }

            if (typeof this.cfg.setAnswer == 'function') { //check for function existance
                this.cfg.setAnswer(this.getMarkUpValue().length > 0);    //trigger progress event of the answer
            }

            if (typeof this.cfg.firstKeyDown == 'function' /*&& !this.isEmpty()*/) { //check for function existance
                this.cfg.firstKeyDown();    //trigger progress event of the task
            }

	        Mustache.clearCache();
	        
			if( ENV.behaviors.fireUIEvents ) {
				ENV.host.onUIEvent( "blur" ) ;
			}
	        
        },

        /**
         *
         * @param fnc
         */
        setFirstKeyDownFunction:function (fnc) {
            this.cfg.firstKeyDown = fnc;
        },

        /**
         * startKeyboard
         * Show the keyboard. Create its instance if necessary
         */
        startKeyboard:function () {
            if (this.keyBoardOpen) {
                return;
            }

	        //find out math field offset
            var mathFieldOffset = this._frame.offset();
            var offset = {
                top:mathFieldOffset.top + this._frame.outerHeight(false) + constants.keyboardStyle.spaceFromMathField,
                left:mathFieldOffset.left
            };

	        //find out if math field parent is IFRAME
	        var parentIframe = this.cfg.parent.get(0).ownerDocument.defaultView.frameElement,
		        targetDocument = jQuery(document),
		        iframeOffset = null;

	        if(parentIframe && parentIframe.name != 'DL_Player_Frame') { //ignore offset of the player iframe
		        iframeOffset = jQuery(parentIframe).offset();
	        }

            //in case MF parent is iframe - add iframe offset to MF offset
            if (!!iframeOffset) {
                offset.top += iframeOffset.top;
                offset.left += iframeOffset.left;
                //in case MF parent is iframe - MF target is iframe document
                targetDocument = jQuery(this.cfg.parent.get(0).ownerDocument);
            }

            if (this.keyboard) {
                // Show the keyboard
                this.keyboard.show(offset);
            } else { // !this.keyboard
                var thi$ = this;

				// Create the keyboard
				// TODO: move fontLocale to either preset or mathfield feed
				// var keyBoardParent = jQuery(thi$.cfg.parent).parents('.scroll_enabled');
				//in case keyboard parent is iframe - selector should go up more levels in order to get the wanted div from the parent element
				/*if (keyBoardParent.length == 0) {
				    keyBoardParent = jQuery(thi$.cfg.parent.get(0).ownerDocument.defaultView.frameElement).parents('.scroll_enabled');
				}*/

	            var keyBoardParent = jQuery('body');
	            var presetName = jQuery(this.cfg.data).attr("keyboardPreset") || 'fullMathField', keyboardPreset;

	            if (constants.keyboardPresets.hasOwnProperty(presetName)) {
		            keyboardPreset = constants.keyboardPresets[presetName];
	            } else {
		            keyboardPreset = constants.keyboardPresets['fullMathField'];
	            }

	            this.keyboard = new t2k.component.keyboard.Keyboard({
		            parent:keyBoardParent,
		            parent_dom_id:this._frame.attr('id'),
		            $parent:this._frame,
                    autoComma : this.autoComma,
		            preset:keyboardPreset,
		            fontLocale:this.fontLocale,
		            target:targetDocument,
		            invokerClass:constants.classes.mathField,
		            offset:offset,
		            useMathfieldKBHack:thi$.cfg.useMathfieldKBHack,
		            onRendered:function () {},
		            onKeyboardPressed:jQuery.proxy(thi$.onKeyboardPressed, thi$),
		            onKeyboardClosed:jQuery.proxy(thi$.endEdit, thi$)
	            });

	            keyBoardParent = null; keyboardPreset = null;

	            setTimeout(function () {
		            if (!(thi$.caret && thi$.caret.length && thi$.caret.parent().length)) {
			            thi$.placeCaretAtEnd();
		            }
	            }, 0);
            }
        },

        /**
         * onKeyboardPressed
         * Called when mathfield keyboard has been pressed
         * @param key
         */
        onKeyboardPressed:function (key) {

            var thi$ = this;
            var alignFrame = false, elementToRemove = null, doAutoComma = true, isOnCompletion = false;

            if (!!thi$.selection.oMps) {
                isOnCompletion = thi$.selection.oMps.obj.parents('.completion').length > 0;
            }

            if (typeof key !== 'undefined') switch (key) {
                case 'arrowLeft':
                    //if the caret placed inside of cempletion field, check if we are not getting out of the comletion
                    if (isOnCompletion && this.caret.parent().parent().hasClass('completion') && this.caret.prev().hasClass('mpsLasso')) {
                        return;
                    }

                    //long division
                    var longDivisionDivided = this.caret.parent().parent('.divider').parent().children('.divided');
                    if (longDivisionDivided && longDivisionDivided.length) {
                        this.placeCaret(longDivisionDivided.children('.mpsContent'), constants.appendType.intoFirst);
                    } else
                    //if prev div of caret is lasso and it's not the beginning of the field - skip to prev structure
                    if (this.caret.prev().hasClass('mpsLasso') && this.caret.prev().parent().parent('.mathField_content').length == 0) {
                        this.placeCaret(this.caret.parents('.structure').first(), constants.appendType.before); //insert caret before the current structure div

                    } //if prev div of caret is structure - place caret after last child of the structure content
                    else if (this.caret.prev().hasClass('structure')) {
                        if (this.caret.prev().children('.mpsContent').children('.numerator').length > 0) {  //if prev structure is fraction - move caret into numerator
                            this.placeCaret(this.caret.prev().children('.mpsContent').children('.numerator').find('.mpsContent').children().last(), constants.appendType.before);
                        } else {  //place caret after last child of the structure content
                            this.placeCaret(this.caret.prev().children('.mpsContent').children().last(), constants.appendType.after);
                        }

                    } else if (this.caret.prev().hasClass('icon')) { //long division icon or remainder icon
                        this.placeCaret(this.caret.prev().parents('.mpsContent').first().prev().children('.symbol').last(), constants.appendType.after);
                        // insert the caret before, only if this is not the MF mail lasso
                    } else if (!(this.caret.prev().hasClass('mpsLasso') && this.caret.parent().parent().hasClass('mathField_content'))) {
                        this.caret.insertBefore(this.caret.prev());
                    }

                    this.alignAnchors();

                    doAutoComma = false;

                    break;

                // TODO: olga - arrange
                case 'arrowRight':
                    //if the caret placed inside of cempletion field, check if we are not getting out of the comletion
                    if (isOnCompletion && this.caret.parent().parent().hasClass('completion') && (this.caret.next().length == 0) ) {
                        return;
                    }

                    if (this.caret.next().hasClass('structure')) { //if next div of caret is structure place caret into this structure
                        if (this.caret.next().children('.mpsContent .mpsLasso').length > 0) {
                            this.placeCaret(this.caret.next().children('.mpsContent .mpsLasso'), constants.appendType.after);
                        } else if (this.caret.next().children('.mpsContent').find('.mpsLasso').first()) {
                            this.placeCaret(this.caret.next().children('.mpsContent').find('.mpsLasso').first(), constants.appendType.after);
                        }

                    } else if (this.caret.next().length > 0) {   //if next div of caret is not structure - place caret after this div
                        this.caret.insertAfter(this.caret.next());
                        return;

                    } //if the caret is on the end of the first long division structure - move caret into the second one
                    else if (this.caret.prev().parents('.divided').first().next('.icon').length > 0) {
                        this.placeCaret(this.caret.prev().parents('.divided').first().next('.icon').next().children('.mpsContent'), constants.appendType.intoFirst);

                    } else

                        var longDivisionStructure = this.caret.prev().parent('.mpsContent').parent().parent().parent('.longDivision');

                    if (longDivisionStructure && longDivisionStructure.length) {
                        this.placeCaret(longDivisionStructure, constants.appendType.after);
                    }

                    //if the caret is on the end of the structure - place caret after it
                    else if (this.caret.prev().parents('.structure').first().length > 0) {
                        this.placeCaret(this.caret.prev().parents('.structure').first(), constants.appendType.after);
                    }

                    this.alignAnchors();

                    doAutoComma = false;

                    break;

                case 'arrowUp':
                    if (this.caret.prev().parent('.mpsContent').parent('.denominator').length > 0) { //if the caret is in denominator - move it to numerator content
                        if (this.caret.prev().parent('.mpsContent').parent('.denominator').parent().children('.numerator').length > 0) {
                            this.placeCaret(this.caret.prev().parent('.mpsContent').parent('.denominator').parent().children('.numerator').children('.mpsContent').children('.mpsLasso'), constants.appendType.after);
                        }

                    }

                    doAutoComma = false;

                    break;

                case 'arrowDown':
                    if (this.caret.prev().parents('.numerator').length > 0) { //if the caret is in numerator  - move it to denominator content
                        if (this.caret.prev().parent('.mpsContent').parent('.numerator').parent().children('.denominator').length > 0) {  //this fraction denominator
                            this.placeCaret(this.caret.prev().parent('.mpsContent').parent('.numerator').parent().children('.denominator').children('.mpsContent').children('.mpsLasso'), constants.appendType.after);
                        } else { //fraction in fraction
                            var secondLevelFraction = this.caret.prev().parents('.fraction').first().parents('.fraction').children('.mpsContent').children('.denominator').children('.mpsContent').children('.mpsLasso');
                            if (secondLevelFraction.length) {
                                this.placeCaret(secondLevelFraction, constants.appendType.after);
                            }
                        }
                    }

                    alignFrame = true;
                    this.alignAnchors();

                    doAutoComma = false;

                    break;

                case 'backspace':
                    //if the caret placed inside of cempletion field, check if we are not getting out of the comletion
                    if (isOnCompletion && this.caret.parent().parent().hasClass('completion') && this.caret.prev().hasClass('mpsLasso')) {
                        return;
                    }

                    if (!this.selection.deleteSelection()) {   //if there is current selection - delete it

                        if (this.caret.prev().hasClass('mpsLasso') || this.caret.prev().hasClass('icon')) { //remove this structure
                            // check if caret is not at the start of the MF
                            if (!this.caret.parent().parent().hasClass('mathField_content')) {
                                elementToRemove = this.caret.prev().parents('.structure').first();
                                this.placeCaret(this.caret.prev().parents('.structure').first(), constants.appendType.before);
                                elementToRemove.remove();
                            }

                        } else if (this.caret.prev().hasClass('structure')) {  //if prev div is structure remove all structure
                            this.caret.prev().remove();
                        } else {  //remove prev div element
                            this.caret.prev().remove();
                        }
                    }

                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.alignAnchors();
                    alignFrame = true;

                    break;

                case 'del':
                    //if the caret placed inside of cempletion field, check if we are not getting out of the comletion
                    if (isOnCompletion && this.caret.parent().parent().hasClass('completion') && (this.caret.next().length == 0)) {
                        return;
                    }

                    if (!this.selection.deleteSelection()) {   //if there is current selection - delete it

                        if (this.caret.next().hasClass('mpsLasso') || this.caret.next().hasClass('icon')) { //remove this structure
                            elementToRemove = this.caret.next().parents('.structure').first();
                            this.placeCaret(this.caret.next().parents('.structure').first(), constants.appendType.before);
                        } else if (this.caret.next().hasClass('fraction')) {  //if prev div is fraction remove all structure
                            elementToRemove = this.caret.next();
                        } else if (this.caret.next().hasClass('structure')) {
                            elementToRemove = this.caret.next();
                        } else {  //remove prev div element
                            elementToRemove = this.caret.next();
                        }

                        elementToRemove.remove();
                    }

                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders
                    this.alignAnchors();
                    alignFrame = true;

                    break;

                case 'end':
                    this.placeCaretAtEnd();
                    doAutoComma = false;

                    break;

                case 'small':
                case 'caps':
                    // Do nothing
                    doAutoComma = false;
                    break;

                case 'power':

	                //don't insert power structure inside other power in case of parent power is empty
	                if(this.caret.parent().parent().hasClass('power structure')) {
		                if(this.caret.parent().children().length == 2) { //this power is empty, has only lasso and caret as children
			                this.beep();
			                return false;
		                }
	                }

                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            structureClass:constants.classes.structure
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    //Consecutive exponents unification, don't insert power structure after another power - use prev one,
                    //don't insert power before another power - use next one
                    if ((!this.caret.prev().hasClass('power')) && (!this.caret.next().hasClass('power'))) {
                        this.insertStructure(structure);
	                    structure = null;
                    }

                    var powerMps = null;

                    if(this.caret.next().hasClass('power')) {
                        powerMps = this._view.find('#' + this.caret.next().children('.mpsContent').attr('id'));
                        this.placeCaret(powerMps, constants.appendType.intoFirst);
                    } else {
                        powerMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));
                        this.placeCaret(powerMps, constants.appendType.intoLast);
                    }

                    this.alignAnchors();
                    alignFrame = true;
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.mpsWrapping.register(powerMps, constants.mathTypeKeyboard.remainder.minChar);
                    doAutoComma = false;

                    break;

                case 'fraction':

                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            id1:genId(),
                            id2:genId(),
                            structureClass:constants.classes.structure
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame,
                            id:genId()
                        });


                    this.insertStructure(structure);
	                structure = null;

                    var fractionMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));

                    var numeratorMps = fractionMps.find('.numerator').children('.mpsContent');
                    var denominatorMps = fractionMps.find('.denominator').children('.mpsContent');

                    this.placeCaret(numeratorMps, constants.appendType.intoLast);

                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;

                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.mpsWrapping.register(numeratorMps, constants.mathTypeKeyboard.fraction.minChar);
                    this.mpsWrapping.register(denominatorMps, constants.mathTypeKeyboard.fraction.minChar);
                    doAutoComma = false;

                    break;

                case 'remainder' :

                    var structure = Mustache.to_html(templates[key + '_' + ( ENV.locale ).toLowerCase().split('_')[1]], {
                            id:genId(),
                            structureClass:constants.classes.structure
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
	                structure = null;

                    var remainderMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));

                    this.placeCaret(remainderMps, constants.appendType.intoLast);
                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;

                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.mpsWrapping.register(remainderMps, constants.mathTypeKeyboard.remainder.minChar);
                    doAutoComma = false;

                    break;

                case 'absolute' :
                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            structureClass:constants.classes.structure
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
	                structure = null;

                    var absoluteMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));

                    this.placeCaret(absoluteMps, constants.appendType.intoLast);
                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;

                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.mpsWrapping.register(absoluteMps, constants.mathTypeKeyboard.absolute.minChar);
                    doAutoComma = false;
                    break;

                case 'longDivision' :

	                var locale = (this.fontLocale && this.fontLocale !== "usa") ? this.fontLocale :
		                ( ENV.locale ).toLowerCase().split('_')[1];
                    var structure = Mustache.to_html(templates[key + '_' + locale], {
                            id:genId(),
                            id1:genId(),
                            id2:genId(),
                            structureClass:constants.classes.structure
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
	                structure = null;

                    var longDivisionMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));
                    var dividerMps = longDivisionMps.find('.divider').children().first();
                    var dividedMps = longDivisionMps.find('.divided').children().first();

                    this.placeCaret(longDivisionMps.children().first().children('.mpsContent'), constants.appendType.intoLast);

                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.mpsWrapping.register(dividerMps, constants.mathTypeKeyboard.longDivision.minChar);
                    this.mpsWrapping.register(dividedMps, constants.mathTypeKeyboard.longDivision.minChar);
                    doAutoComma = false;

                    break;

                case 'segment' :

                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            structureClass:constants.classes.structure,
                            icon:constants.prototypeControlsHash[key].symbol
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
	                structure = null;

                    var segmentMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));
                    this.placeCaret(segmentMps, constants.appendType.intoLast);
                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;

                    thi$.selection.removeSelectionDiv();   //remove selection placeholders
                    this.mpsWrapping.register(segmentMps, constants.mathTypeKeyboard.segment.minChar);
                    doAutoComma = false;

                    break;

                case 'rayRight' :

                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            structureClass:constants.classes.structure,
                            icon:constants.prototypeControlsHash[key].symbol
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
	                structure = null;

                    var rayRightMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));
                    this.placeCaret(rayRightMps, constants.appendType.intoLast);
                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.mpsWrapping.register(rayRightMps, constants.mathTypeKeyboard.rayRight.minChar);
                    doAutoComma = false;

                    break;

                case 'rayBoth' :

                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            structureClass:constants.classes.structure,
                            icon:constants.prototypeControlsHash[key].symbol
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
	                structure = null;

                    var rayBothMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));
                    this.placeCaret(rayBothMps, constants.appendType.intoLast);
                    this.alignAnchors();
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    alignFrame = true;
                    thi$._view.find('.selection_placeholder').remove();   //remove selection placeholders

                    this.mpsWrapping.register(rayBothMps, constants.mathTypeKeyboard.rayBoth.minChar);

                    break;

	            case 'angle_geometry' :

		            var structure = Mustache.to_html(templates[key], {
				            id:genId(),
				            structureClass:constants.classes.structure,
				            icon:constants.prototypeControlsHash[key].symbol
			            },
			            {
				            mps:templates.mps,
				            mpsWidthFrame:templates.mpsWidthFrame
			            });

		            this.insertStructure(structure);
		            structure = null;

		            var angleGeometryMps = this._view.find('#' + this.caret.prev().children('.mpsContent').attr('id'));
		            this.placeCaret(angleGeometryMps, constants.appendType.intoLast);
		            this.alignAnchors();
		            this.ancorSpacing(this._view.find('.mpsContent')[0]);
		            alignFrame = true;
		            thi$._view.find('.selection_placeholder').remove();   //remove selection placeholders

		            this.mpsWrapping.register(angleGeometryMps, constants.mathTypeKeyboard.angle_geometry.minChar);

		            break;


                case 'completion':

                    var structure = Mustache.to_html(templates[key], {
                            id:genId(),
                            structureClass:constants.classes.structure
                        },
                        {
                            mps:templates.mps,
                            mpsWidthFrame:templates.mpsWidthFrame
                        });

                    this.insertStructure(structure);
                    this.placeCaret(this.caret.prev().find('.mpsContent'), constants.appendType.intoLast);
                    this.alignAnchors();
                    alignFrame = true;
                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    var completionMps = jQuery(structure).find('.mpsContent');
                    this.mpsWrapping.register(completionMps, 1);

	                structure = null;
                    doAutoComma = false;

                    break;


                default:

                    /** First remove the selection, if any. */
                    this.selection.deleteSelection();

	                var locale_keyboard_symbol = constants.prototypeControlsHash[key]['symbol_' + this.fontLocale];
	                var keyboard_symbol = constants.prototypeControlsHash[key].symbol;

                    var symbol = jQuery(this.createSymbolDivString(locale_keyboard_symbol ? locale_keyboard_symbol : keyboard_symbol, key));

	                var onSymbolMouseUp = function (e) {
		                if (!thi$.isEnabled()) return;
		                thi$.onSymbolMouseUp(e);
	                };

                    symbol.mouseup(onSymbolMouseUp)
                          .insertBefore(this.caret);

                    this.ancorSpacing(this._view.find('.mpsContent')[0]);
                    thi$.selection.removeSelectionDiv();   //remove selection placeholders

                    this.alignAnchors();
                    alignFrame = true;

                    break;
            }

            this.mpsWrapping.alignWrappers();

            if (alignFrame) {
                this.alignFrame();
            }

            //auto comma should take place only after alignFrame function because alignFrame can remove
            // last inserted character in case there is no available space for it
            if (doAutoComma) {
                this.addAutoComma(true);
            }

            this.setKeyboardByCaretPosition();

        },

        /**
         * addAutoComma
         * @param wholeNumber
         * Adding a comma in numbers automatically
         */
        addAutoComma:function (wholeNumber) {

            var counter = 0, temp, originalPosition, currPosition;

            if (this.autoComma) {

                currPosition = originalPosition = this.caret.prev();

                // special case of auto comma, if the first digit of a number has been deleted
                // check if the remaining number starts with comma and delete it.
                if (currPosition.hasClass('mpsLasso')) {
                    try {
                        if (currPosition.next().next().attr('validationGroup') == 'thousandsComma') {
                            currPosition.next().next().remove();
                        }
                    } catch (e) {
                    }
                }


                if (wholeNumber) {

                    // search 'back' (prev) for decimal point, if decimal point was found - exit function
                    while (currPosition.attr('validationGroup') == 'digits' || currPosition.attr('validationGroup') == 'thousandsComma' || currPosition.attr('validationGroup') == 'decimalPoint') {

                        if (currPosition.attr('validationGroup') == 'decimalPoint') {

                            /** Save position of the decimalPoint. */
                            originalPosition = currPosition;

                            /** Remove thousandsCommas to the right. */
                            currPosition = currPosition.next();
                            while (currPosition.attr('validationGroup') == 'digits' ||
                                currPosition.attr('validationGroup') == 'thousandsComma' ||
                                currPosition.attr('class') == 'caret') {

                                if (currPosition.attr('validationGroup') == 'thousandsComma') {
                                    temp = currPosition;
                                    currPosition = currPosition.next();
                                    temp.remove();
                                }
                                else {
                                    currPosition = currPosition.next();
                                }
                            }

                            // TODO: more than one decimal point?
                            break;


                        } else {
                            currPosition = currPosition.prev();
                        }
                    }

                    // set currPosition to the original position
                    currPosition = originalPosition;

                    if (currPosition.attr('validationGroup') != 'digits' && currPosition.attr('validationGroup') != 'thousandsComma') {
                        currPosition = currPosition.prev();
                    }

                    // set currPosition to the end of the number
                    while (currPosition.next().attr('validationGroup') == 'digits' || currPosition.next().attr('validationGroup') == 'thousandsComma' || currPosition.next().attr('class') == 'caret') {
                        currPosition = currPosition.next();
                    }
                }

                // parse number
                while (currPosition.attr('validationGroup') == 'digits' || currPosition.attr('validationGroup') == 'thousandsComma' || currPosition.attr('class') == 'caret') {

                    if (currPosition.attr('class') == 'caret') {
                        currPosition = currPosition.prev();
                    }

                    if (currPosition.attr('validationGroup') == 'thousandsComma') {

                        temp = currPosition;
                        currPosition = currPosition.prev();
                        temp.remove();

                    } else {

                        if (counter == 2) {
                            temp = currPosition;
                            currPosition = currPosition.prev();

                            if (currPosition.attr('validationgroup') == 'digits' || currPosition.hasClass('caret')) {
                                jQuery('<div class="sign symbol" validationgroup="thousandsComma">,</div>').insertBefore(temp);
                            } else if (currPosition.attr('validationgroup') == 'thousandsComma') {
                                currPosition = currPosition.prev();
                            }

                            counter = 0;
                        }

                        if (currPosition.attr('validationGroup') == 'digits') {
                            counter++;
                            currPosition = currPosition.prev();
                        }

                    }

                }

            }

        },

        // mpsWrapping class
        mpsWrapping:{

            /**
             * register mpsWrapper for parameter mps
             * @param $mps
             * @param minChar
             * @param selector
             */
            register:function ($mps, minChar, selector) {
                var id = $mps.attr('id');
                var $wrapper = this.createWrapper();

                this.collection[id] = {
                    $mpsId:null,
                    $mps:$mps,
                    $wrapper:$wrapper,
                    selector:selector,
                    active:true,
                    minChar:minChar,
                    completionType:null
                };

                this.fit(id);

	            $wrapper = null;
            },

            /**
             * updateRegistration
             * @param id
             * @param key
             * @param value
             * update mpsWrapper
             */
            updateRegistration:function (id, key, value) {
                this.collection[id][key] = value;

                if (key == 'completionType') {
                    this.collection[id].$wrapper.addClass('completion_' + value);
                }
            },

            /**
             * removeFromCollection
             * @param id
             * removes mpsWrapper from collection by id
             */
            removeFromCollection:function (id) {
                if (id in this.collection) {
                    //remove wrapper
                    this.collection[id].$wrapper.removeNative();
                    //remove current removed element from collection hash
                    delete this.collection[id];
                }
            },

            /**
             * createWrapper
             * creates mpsWrapper div and appends it to MF content
             * returns mpsWrapper jQuery object
             */
            createWrapper:function () {
	            var wrapper = Perf.create('div');
	            wrapper.attr({'class':'mpsWrapper show'});
	            this.thi$$._content.append(wrapper);

                return wrapper;
            },

            /**
             * fit
             * @param id
             * fit mpsWrapper size and offset by it's mps
             */
            fit:function (id) {

                //reload $mps after user input
                if (!!!this.collection[id].$mpsId) {
                    this.collection[id].$mpsId = this.collection[id].$mps.attr('id');
                    this.collection[id].$mps = this.thi$$._view.find('#' + this.collection[id].$mpsId);
                }

                var mpsCords = this.thi$$.selection.storeAllMpsPositions(this.collection[id].$mps.parent(), true, this.collection[id].selector);

                if (!!mpsCords) {
                    var contentCords = this.thi$$.selection.getElementData(this.thi$$._content);
                    var wrapperProporties = this.getWrapperProporties(mpsCords, contentCords, id);
                    this.collection[id].$wrapper.css(wrapperProporties);
	                wrapperProporties = null;
                }

            },

            /**
             * getWrapperProporties
             * @param mpsCords
             * @param contentCords
             */
            getWrapperProporties:function (mpsCords, contentCords, id) {
                return {
                    left:mpsCords.left - contentCords.left - constants.mpsWrapperStyle.padding.left,
                    top:mpsCords.top - contentCords.top - constants.mpsWrapperStyle.padding.top - constants.mpsWrapperStyle.padding.bottom,
                    width:mpsCords.right - mpsCords.left + constants.mpsWrapperStyle.border.width + constants.mpsWrapperStyle.padding.left + constants.mpsWrapperStyle.padding.right,
                    height:mpsCords.bottom - mpsCords.top + constants.mpsWrapperStyle.border.width + constants.mpsWrapperStyle.padding.top + constants.mpsWrapperStyle.padding.bottom
                };
            },

            /**
             * alignWrappers
             * iterates all mpsWrappes in order to show or hide each one, acoording to min char setting of each structure
             */
            alignWrappers:function () {

                var charsInMps, thi$ = this, child;

                for (var index in this.collection) {
                    child = this.collection[index];

                    //check for element existence in DOM - if not exists - remove it from mpsWrapping collection
                    var mpsId = child.$mps.attr('id');
                    if (!!!this.thi$$._view.find('#' + mpsId).get(0)) {
                        thi$.removeFromCollection(mpsId);
                        continue;
                    }

                    charsInMps = child.$mps.text().trim().length;
                    if ((charsInMps < child.minChar)) {
                        child.active = true;
                        thi$.fit(index);
                        thi$.show(index, true);
                    } else {
                        child.active = false;

                        if (child.completionType == null) {  //don't hide wrapper in case it's completion
                            thi$.show(index, false);
                        } else {
                            thi$.fit(index);
                        }

                    }
                }
                ;

            },

            /**
             * show
             * @param id
             * @param show
             */
            show:function (id, show) {
                if (show) this.collection[id].$wrapper.show();
                else       this.collection[id].$wrapper.hide();
            },

            /**
             * getActiveArray
             * return only active mpsWrappers from collection
             * @return {Array}
             */
            getActiveArray:function () {
                var activeArray = [];

                for (var index in this.collection) {
                    if (this.collection[index].active) activeArray.push(this.collection[index]);
                };

                return activeArray;
            }

        },

        /**
         * setKeyboardByCaretPosition
         *
         */
        setKeyboardByCaretPosition:function () {

            // if !caret - return
            if (!this.caret || !!this.dontEnableKeyboard || !this.caret.length) return;

            // fint current structure name
            var currentStructureElement = this.caret;

            while (!!!jQuery(currentStructureElement).hasClass('structure')
                && !!!jQuery(currentStructureElement).hasClass('mathField_content')) {
                //if there is no parent of this element break the loop
                if (!jQuery(currentStructureElement).parent().length) {
                    break;
                }

                currentStructureElement = jQuery(currentStructureElement).parent();
            }

            var structureName = (jQuery(currentStructureElement).attr('class') || '').replace('structure', '').trim();

            // find current mps
            var currentMps = this.caret;
            while (!!!jQuery(currentMps).hasClass('mpsContent') && !!!jQuery(currentStructureElement).hasClass('mathField_content')) {
                //if there is no parent of this element break the loop
                if (!jQuery(currentMps).parent().length) {
                    break;
                }

                currentMps = jQuery(currentMps).parent();
            }

            // if className includes ' ', it's means that there is more than 1 class.
            // loop structures and find the structure string in class string
            if (structureName.indexOf(' ') > -1) {
                for (var structure in constants.mathTypeKeyboard) {
                    if (structureName.indexOf(structure) > -1) structureName = structure;
                }
            }

            // if no structure found,
            // check for mathFieldCompletionType. (keyboard limitation for the entire mathField)
            // else, enable full keyboard and return
            if (structureName == 'mathField_content') {
                if (!this.mathFieldCompletionType) {
                    this.keyboard.enableKeys('all');
                    return null;
                } else {
                    structureName = 'mathFieldCompletion';
                }
            }

            // get key string
            var keyString = '';

            if (constants.mathTypeKeyboard[structureName]) {

                var groups, enable, completiontype;

                switch (structureName) {

                    case 'mathFieldCompletion' :
                        completiontype = this.mathFieldCompletionType.toUpperCase();
                        groups = constants.mathTypeKeyboard.completion[completiontype].groups;
                        enable = constants.mathTypeKeyboard.completion[completiontype].enable;
                        break;

                    case 'completion' :
                        completiontype = currentStructureElement.attr('completiontype').toUpperCase();
                        groups = constants.mathTypeKeyboard.completion[completiontype].groups;
                        enable = constants.mathTypeKeyboard.completion[completiontype].enable;
                        break;

                    default:
                        groups = constants.mathTypeKeyboard[structureName].groups;
                        enable = constants.mathTypeKeyboard[structureName].enable;
                }

                jQuery(groups).each(function (index, child) {
                    keyString += constants.keyboardGroupControls[child] + ',';
                });

                // enable or disable key string
                if (enable) {
                    this.keyboard.enableKeys('none');
                    this.keyboard.enableKeys(keyString);
                } else {
                    this.keyboard.enableKeys('all');
                    this.keyboard.disableKeys(keyString);
                }

                this.checkCharLimit(jQuery(currentMps), structureName, completiontype);
            }

        },

        /**
         * checkCharLimit
         * @param $mps
         * @param structureName
         * @param completiontype
         */
        checkCharLimit:function ($mps, structureName, completiontype) {

            var charLimit;

            switch (structureName) {

                case 'completion':
                    charLimit = constants.mathTypeKeyboard.completion[completiontype].charLimit;
                    break;

                default:
                    charLimit = constants.mathTypeKeyboard[structureName].charLimit;

            }

            if (!charLimit) return;

            if (this.getMpsCharLength($mps) >= charLimit) {
                this.keyboard.disableKeys('all');
                this.keyboard.enableKeys(constants.keyboardGroupControls.system);
            }
        },

        getMpsCharLength:function ($mps) {
            var symbolsCounter = 0;
            $mps.find('.symbol').each(function () {
                symbolsCounter++;
            });
            return symbolsCounter;
        },

        /**
         * set frame width, check if new width is permitted by configuration
         * @param newWidth
         */
        setWidth:function (newWidth) {
            if (this.calcDeltaWidth() && !this.widthMode.fixedWidth) {
                this._frame.width(newWidth);
	            this._view.width(newWidth);
            }
        },

	    setMaxWidth: function(width) {
		    this._super(width);
		    this.checkWidthVsContainer();
	    },
        /**
         * alignFrame
         * calculates new frame width and height according to the new user input
         */
        alignFrame:function (withoutPrevStyle) {

            var thi$ = this;

	        this.prevStyle = { 'height':Compat.actualHeight(thi$._frame),
		        'width':Compat.actualWidth(thi$._frame),
		        'top':thi$._frame[0].style.top,
		        'caretHeight': thi$.caret ? thi$.caret.height() : thi$.fontSize
            };

            if (this.prevStyle.top === '') {
                this.prevStyle.top = '0px';
                thi$._frame[0].style.top = this.prevStyle.top;
            }

            if (this.editMode || this.completionMode) {
                //the width of the frame is equal to the content width
                this.setWidth(this._content.width() + constants.frameStyle.padding.left + constants.frameStyle.padding.right);
            }

            // get highest ans lowest offset
            var $child, mathEdge = {'highest':0, 'lowest':0}, childOffsetTop, childOffsetBottom, childTop, childHeight, childWidth, totalWidth = 0;

            this._content.find('.mpsContent').each(function (index, child) {  //loop through all div elements with class mpsContent

                $child = jQuery(child);
                childHeight = Compat.actualHeight($child);
                childWidth = Compat.actualWidth($child);

                childTop = $child[0].style.top;
                childTop = (childTop == '' ? 0 : childTop.px2int());

                childOffsetTop = $child.offset().top - childTop;   //calculate element real offset top

                mathEdge.highest = ((childOffsetTop < mathEdge.highest) || mathEdge.highest == 0) ? childOffsetTop : mathEdge.highest; //find highest offset top

                childOffsetBottom = childOffsetTop + childHeight;  //get child offset bottom

                //calculate minimum offset top
                mathEdge.lowest = ((childOffsetTop + childHeight) > mathEdge.lowest) ? (childOffsetTop + childHeight) : mathEdge.lowest;

                totalWidth += childWidth;

            });

            var frameProps = {'height':(mathEdge.lowest - mathEdge.highest) + constants.frameStyle.border.width};  //calculate frame new height (delta of highest and lowest offset top)

            frameProps.offsetTop = mathEdge.highest - this._frame.offset().top - constants.frameStyle.padding.bottom;   //frame real offset top is highest offset top minus frame offset top
//            console.log(' mathEdge.highest=', mathEdge.highest, ' this._frame.offset().top=', this._frame.offset().top);

            if (this.editMode || this.completionMode) {
                //frame height is equal to the new calculated height plus frame border width + padding top and bottom
                this._frame.height(frameProps.height + constants.frameStyle.border.width + constants.frameStyle.padding.top + constants.frameStyle.padding.bottom);
            } else {
                this._frame.height(frameProps.height);
            }

            //this._content.height(this._frame.height());

            childTop = (this.prevStyle.top.px2int());   //get frame current top

            if (isNaN(childTop)) childTop = 0 - this.prevStyle.height;

            var frameTop = 0;

            if (frameProps.offsetTop <= 0) { //if we got negative offset top - we need to apply it - move frame up
                frameTop = (Math.abs(childTop) + Math.abs(frameProps.offsetTop) + Math.ceil(constants.frameStyle.border.width / 2)); //set frame new top = old top + offset top
            } else {  //move frame down
                frameTop = (Math.abs(childTop) - Math.abs(frameProps.offsetTop) + Math.ceil(constants.frameStyle.border.width / 2));
            }

            this._frame.css('top', 0 - frameTop);

            if (!this.setMarkUp) {
                this.calcBottomAndTopDeltaHeight();
            }

        },

        /**
         * alignAnchors
         * @param current
         * align mps divs by mpsAnchor and mpsLasso
         */
        alignAnchors:function (current) {

            var mpsContent, mpsLasso, mpsAnchor, delta, thi$ = this;

            var parents = this.caret ? this.caret.parents('.mpsContent') : this._view.find('.mpsContent');

            parents.each(function () {
                // get domObject
                mpsContent = jQuery(this);

                mpsAnchor = mpsContent.parent().children('.mpsAnchor');

                if (mpsAnchor.length > 0) {
                    mpsLasso = jQuery(mpsContent.children('.mpsLasso')[0]);

	                // set top=0
                    mpsContent.css('top', '0px');
                    // get and set Delta
                    delta = (mpsAnchor.offset().top + (mpsAnchor.height() / 2)) -
	                        (mpsLasso.offset().top + (mpsLasso.height() / 2));


                    mpsContent.css('top', delta);
                }

	            mpsContent = null;

            });

        },

        /**
         * insertStructure
         * @param htmlStructure
         */
        insertStructure:function (htmlStructure) {
            this.addAutoComma(false);

	        delete this.lastStructure;
	        this.lastStructure = jQuery(htmlStructure).insertBefore(this.caret);

	        htmlStructure = null;

        },

        /**
         * ancorSpacing
         * @param mps
         */
        ancorSpacing:function (mps) {
            this.ancorSpacing_getPosition(mps);
        },

        /**
         * ancorSpacing_getPosition
         * @param mps
         * @param mpsType
         */
        ancorSpacing_getPosition:function (mps, mpsType) {

            // if mps is an array,
            // start rec with each part of it.
            if (mps.length > 1){
                var thi$ = this, tempPosition = new Array(mps.length);
                jQuery(mps).each(function(index, childMps){
	                tempPosition[index] = thi$.ancorSpacing_getPosition(childMps, mpsType);
                });
                // and return
                return this.sumMpsContentPosition(tempPosition);
            }

            var $mps = jQuery(mps);

            if (!mps) return null;
            if (!($mps.attr('class'))) return null;

            var mpsPowerPosition = this.ancorSpacing_getPosition($mps.children('.power').children('.mpsContent'), 'power');
            var mpsNumeratorPosition = this.ancorSpacing_getPosition($mps.children('.fraction').children('.mpsContent').children('.numerator').children('.mpsContent'), 'numerator');
            var mpsDenominatorPosition = this.ancorSpacing_getPosition($mps.children('.fraction').children('.mpsContent').children('.denominator').children('.mpsContent'), 'denominator');

            var sumMpsContentPosition = this.sumMpsContentPosition([mpsPowerPosition, mpsNumeratorPosition, mpsDenominatorPosition]);

	        var fontSize = $mps.css('font-size').px2int();
	        var mpsHeight = $mps.height() < fontSize ? fontSize : $mps.height();

	        var selfOffset = {
		        'top':$mps.offset().top,
		        'bottom':$mps.offset().top + mpsHeight
	        };

	        if (!sumMpsContentPosition || (sumMpsContentPosition == null)) {
		        // if there is no power of fraction, return mps self position
		        $mps.prev().css('top', '0px');
		        return selfOffset;
	        } else {
		        // add self offset to mps offset
		        sumMpsContentPosition = this.sumMpsContentPosition([sumMpsContentPosition, selfOffset]);
	        }

	        var mpsAnchorTop = $mps.prev().css('top').px2int();
            mpsAnchorTop = mpsAnchorTop == 'auto' ? 0 : mpsAnchorTop;

            switch (mpsType) {

                case 'numerator':
                    var lassoTop = $mps.parent().next().offset().top;
                    var delta = sumMpsContentPosition.bottom - lassoTop;
                    mpsAnchorTop -= delta;

                    mpsAnchorTop = (mpsAnchorTop > 0) ? 0 : mpsAnchorTop;

                    $mps.prev().css('top', mpsAnchorTop);

                    this.alignAnchors();

                    return {'top':lassoTop - (sumMpsContentPosition.bottom - sumMpsContentPosition.top), 'bottom':lassoTop};
                    break;

                case 'denominator':
                    var lassoTop = $mps.parent().prev().offset().top;
	                //lasso is fraction bar add it's height and margin to the offset top
	                if($mps.parent().prev().hasClass('fractionBar')) {
		                lassoTop += 3;
	                }

                    var delta = lassoTop - sumMpsContentPosition.top;
                    mpsAnchorTop += delta;

                    mpsAnchorTop = (mpsAnchorTop < 0) ? 0 : mpsAnchorTop;

                    $mps.prev().css('top', mpsAnchorTop );

                    this.alignAnchors();

                    return {'top':lassoTop, 'bottom':lassoTop + (sumMpsContentPosition.bottom - sumMpsContentPosition.top)};

                    break;

	            case 'power' :

	                var powerLessSumMpsContentPosition = this.sumMpsContentPosition([mpsNumeratorPosition, mpsDenominatorPosition]);

	                // I'm a power that contains a power. so I don't need to do nothing about my position.
		            // only my parent should !
	                if (!powerLessSumMpsContentPosition){
		                return sumMpsContentPosition;
	                }

	                // get lasso data
                    var $lasso =  $mps.children('.mpsLasso');
                    var lassoTop = $lasso.offset().top;
                    var lassoHeight = $lasso.height();

                    // get anchor data
                    var currentAnchorTop = $mps.prev().css('top').px2int();
                    currentAnchorTop = currentAnchorTop == 'auto' ? 0 : currentAnchorTop;

                    // calc delta
                    var delta = ((sumMpsContentPosition.bottom - lassoTop - lassoHeight) / 2) + currentAnchorTop;

                    // negative
                    mpsAnchorTop -= delta;

                    // min = 0
                    mpsAnchorTop = (mpsAnchorTop > 0) ? 0 : mpsAnchorTop;

                    // set top value
                    $mps.prev().css('top', mpsAnchorTop);

                    this.alignAnchors();

                    return {'top':sumMpsContentPosition.top - delta, 'bottom':sumMpsContentPosition.bottom - delta};
                    break;

            }

        },

        /**
         * sumMpsContentPosition
         * @param mpsPositionArray
         */
        sumMpsContentPosition:function (mpsPositionArray) {

            var totalPosition = {'top':null, 'bottom':null};

            for (var i = 0; i < mpsPositionArray.length; i++) {

                if (!!mpsPositionArray[i]) {

                    if (totalPosition.top) {
                        totalPosition.top = (totalPosition.top < mpsPositionArray[i].top) ? totalPosition.top : mpsPositionArray[i].top;
                        totalPosition.bottom = (totalPosition.bottom > mpsPositionArray[i].bottom) ? totalPosition.bottom : mpsPositionArray[i].bottom;
                    } else {
                        totalPosition.top = mpsPositionArray[i].top;
                        totalPosition.bottom = mpsPositionArray[i].bottom;
                    }
                }
            }

            if (totalPosition.top) {
	            totalPosition.top =  Math.ceil( totalPosition.top );
	            totalPosition.bottom =  Math.floor( totalPosition.bottom );
                return totalPosition;
            }

            else
                return null;

        },

        /**
         * setDynamicHeight
         * @param topDelta
         * @param bottomDelta
         */
        setDynamicHeight:function (topDelta, bottomDelta) {
            this._view.css({'margin-top':topDelta, 'margin-bottom':bottomDelta});
        },

        /**
         * calcBottomAndTopDeltaHeight
         * calc bottom and top delta height of the field, and prevent inserting structure that can cause field unsupported growth
         */
        calcBottomAndTopDeltaHeight:function () {
            //current height without paddings
            var frameHeight = Compat.actualHeight(this._frame),
                frameOriginalHeight = this._frame.css('min-height').px2int(),     //frame original height
                heightDelta = frameHeight - frameOriginalHeight;

            var frameTop = (heightDelta > 0) ? (0 - Math.ceil(this._frame.css('top').px2int())) : 0,
                topHeightDelta = frameTop + Math.floor(constants.frameStyle.padding.top),
                bottomHeightDelta = ((heightDelta > 0) ? (heightDelta - topHeightDelta) : 0);

	        if (this.maxHeight.stringValue == "dynamic") { // in case of dynamic max height set frame height according to deltas
		        if ((topHeightDelta > (2 * this.fontSize)) || (bottomHeightDelta > (2 * this.fontSize))) {
			        removeLastStructureAndAlignFrame.call(this);
		        } else {
			        this.setDynamicHeight(topHeightDelta, bottomHeightDelta);
		        }
	        }
	        //the field grew larger that configured, remove last insert structure
	        else if ((topHeightDelta > this.maxHeight.deltaTop) || (bottomHeightDelta > this.maxHeight.deltaBottom)) {
		        removeLastStructureAndAlignFrame.call(this);
	        }

	        function removeLastStructureAndAlignFrame() {
		        this.placeCaret(this.lastStructure, constants.appendType.before);
		        this.lastStructureRemovedFlag = false;

		        //remove actual structure div
		        if (!!this.lastStructure) {
			        this.lastStructureRemovedFlag = true;
			        this.lastStructure.remove();
		        }

		        this.setWidth(this.prevStyle.width);
		        this._frame.height(this.prevStyle.height).css('top', this.prevStyle.top); //apply prev frame style
		        this.caret && this.caret.height(this.prevStyle.caretHeight);

		        this.ancorSpacing(this._view.find('.mpsContent')[0]);
		        this.ancorSpacing(this._view.find('.mpsContent')[0]);

		        this.alignAnchors();
		        this.mpsWrapping.alignWrappers();

		        this.beep();
	        }
        },

        /**
         * calcDeltaWidth
         * calculates delta width of the frame, and removes last inserted element in case of overflow
         */
        calcDeltaWidth:function () {

            if (!this.editMode) {  //in case of readOnly math field do nothing
                return true;
            }

            var maxWidth = ((this.widthMode.fixedWidth) ? this._frame.css('width').px2int() : (this.widthMode.width * this.fontSize))
	            - (constants.frameStyle.padding.left + constants.frameStyle.padding.right);  //max width of the frame in pixels

	        var contentWidth = this._content.innerWidth();     //current width of the frame

	        if(maxWidth <= 0) {
		        return true;
	        }

            var deltaWidth = (maxWidth - contentWidth);


            if (deltaWidth <= 0) { //width is larger than max width

	            //remove actual structure div
	            if (!!this.lastStructure) {
		            this.placeCaret(this.lastStructure, constants.appendType.before);
		            this.lastStructureRemovedFlag = false;
		            this.lastStructure.remove();
		            this.lastStructureRemovedFlag = true;
	            } else {
		            var lastElement;
		            if (this.caret.prev('.mpsLasso').length > 0) {  //caret placed prev to lasso - remove all structure
			            lastElement = this.caret.prev().parents('.structure');
		            } else {
			            lastElement = this.caret.prev();       //remove last inserted character
		            }

		            this.placeCaret(lastElement, constants.appendType.before);   //place caret before last inserted element
		            lastElement.remove();
	            }

	            this.ancorSpacing(this._view.find('.mpsContent')[0]);

                this.alignAnchors();
                this.mpsWrapping.alignWrappers();

                this.beep();
                return false;
            }

            return true;

        },

        /**
         * beep
         */
        beep:function () {

            var thi$ = this;
            this._frame.addClass("not_valid").delay(800).queue(function(next){
                thi$._frame.removeClass("not_valid");
                next();
            });

            SOUND.beep();
        },

        /**
         * calcFontSizeByReduction
         * @param val
         * calc font size by reduction value, and apply abs. min when require
         * @returns {Number} reduced font size
         */
        calcFontSizeByReduction:function (val) {
            if (this.fontSize > (constants.reduction.minFontSize + 1)) {
                // calc font size by reductionStep
	            this.setFontSize((Math.floor((this.fontSize - (this.reductionStep * this.reductionStepSize)) / 2)) * 2);

                // if fontSize is less then fontSizeMinReadable
                if (this.fontSize < constants.reduction.minFontSize) {
                    // set fontSize = minimumReadable (not less)
	                this.setFontSize(constants.reduction.minFontSize);
                    // min readable flag
                    this.isMinimunReadable = true;
                }
            }

            return this.fontSize;
        },

        /**
         * reduce
         * @param val
         */
        reduce:function (val) {
            // if val == null set val = 1 in case this.cfg.reductionStep = 0
            var reductionValue = (this.cfg.reductionStep > 0) ? 0 : ((val != undefined && val > 0) ? val : 1);
            // add the val to the current reductionStep
            this.reductionStep = this.reductionStep + reductionValue;

            if (this.fontSize > (constants.reduction.minFontSize + 1)) {
                this.fontSize -= 2;

                this._view.css('font-size', this.fontSize);

	            //recalculate max deltaTop and deltaBottom
	            this.maxHeight.deltaTop = (constants.maxHeight[this.maxHeight.stringValue].em2int()) * this.fontSize;
	            this.maxHeight.deltaBottom = (constants.maxHeight[this.maxHeight.stringValue].em2int()) * this.fontSize;

                this._view.height('').css('top', '');
                this._content.height('').css('top', '');
                this._frame.height('').css('top', '');

                if (this.widthMode.fixedWidth) {
                    this._frame.width(this.widthMode.width + 'em');
                    this._view.width(this._frame.width()  + constants.frameStyle.padding.left + constants.frameStyle.padding.right);
                } else {
                    this._frame.width(this._content.width() + constants.frameStyle.padding.left + constants.frameStyle.padding.right);
//                    this._view.width(this._frame.width());
                }

                this.mpsWrapping.alignWrappers();

                this.alignFrame();

                //When MF is defined as 2nd level any reduction will cause blow up to be enabled
                if ((!this.editMode && !this.completionMode) && (this.maxHeight.stringValue == "secondLevel") && (!!this.enableBlowup)) {
                    this.createBlowup(false);
                }

            } else {
                this.dispatchEvent("cantReduce");
            }

            this.dispatchEvent('onRendered');
        },

        /**
         * setEnabled
         * @param flag
         */
        setEnabled:function (flag) {
            this._super(flag);
            if (flag) {
	            this._view.show();
                this._view.addClass(constants.classes.blur);
                this.showMasc(false);
            } else {
                this._view.removeClass(constants.classes.blur + ' ' + constants.classes.focus);
                this.showMasc(true);
            }
        }, // End of setEnabled

	    dispose : function() {
		    !!this.keyboard && this.keyboard.dispose();
		    delete this.keyboard;

		    delete constants;
		    delete this.mpsWrapping;
		    delete this.validation;
		    delete this.selection;
		    delete this.initMarkup;
		    delete this.calculate;

		    window._hack_close_mf_keyboard = [] ;

		    this._super();
	    },

	    /**
	     * adjustContentStyle
	     */
	    adjustContentStyle:function () {
		    if (this.completionMode || !this.editMode) {
			    this._view.height(this.getHeightPX());

			    //not for MF inside TV
			    if ((!this.cfg.container) || (!this.cfg.container.hasClass('mathFieldWrapper')) || //not inside TV
				    //or inside sub-answer
				    ( (!!this.cfg.container.parents('.subAnswer').length) && this.cfg.container.hasClass('mathFieldWrapper'))) {

				    var frameTop = this._frame.css('top').px2int();
				    var topAddition = !!this.cfg.viewObject ? Math.floor(this.fontSize * 0.2) : 0;

				    this._view.css({'margin-top':0 + 'px', 'margin-bottom':0 + 'px', 'top':(0 - frameTop) + topAddition + 'px'});
			    } else if (this.cfg.container && this.cfg.container.hasClass('mathFieldWrapper')) {
				    this._view.css('width', this.getWidthPX() + 'px');
				    this.cfg.container.width(this._view.outerWidth(true));
			    }

			    (!!this.fontSize) && this._view.css('font-size', this.fontSize);

			    //fix wrong view width, happens on tablets
			    if(this._view.width() < this._content.width()) {
				    this._view.width(this._content.width());
			    }
		    }
	    },

        /**
         * showMasc
         * @param flag
         * shows or hides masc over MF frame
         */
        showMasc:function (flag) {

            if (flag) {
                this._masc.show().css({'top':this._frame.position().top, 'left':this._frame.position().left,
                    'width':this._frame.width(), 'height':this._frame.height()});
            } else {
                if (!this.enableBlowup)
                    this._masc.hide();
            }

        },

        /**
         * resize
         * @param size
         * override
         */
        resize:function (size) {
            //do nothing
        }

    });

    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Private Functions.
    // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
})();
////////////////////////////////////////
// SRC End --> t2k/component/mathField/MathFieldView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/mathField/MathField.js
////////////////////////////////////////
(function() {
    /**
     * @class t2k.component.mathField.MathField
     * @desc A MathField Presenter class
     * @namespace t2k.component.mathField
     * @extends t2k.component.BaseComponent
     * @type {Object}
     */
    t2k.component.mathField.MathField = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.mathField.MathField',

        /**
         *
         * @param config
         */
        ctor: function(config) {
            this._super(config);

            this.view = this.createNewView(t2k.component.mathField.MathFieldView, config);
        },

        setFirstKeyDownFunction : function(fnc){
            this.view.setFirstKeyDownFunction(fnc);
        },

	    setMyState : function(state){
		    this.view.setMyState(state);
	    },

	    addMyState : function(){
		    var state = this._super();
		    return this.view.addMyState(state);
	    },

	    resetSize: function() {
		    this._super();
		    this.view.adjustContentStyle();
	    },

	    resetTile: function() {
		    this._super();
		    this.view.adjustContentStyle();
	    },

	    looseHeight: function(){
		    this._super();
		    this.view.adjustContentStyle();
	    },

	    looseWidth: function(){
		    this._super();
		    this.view.adjustContentStyle();
	    },

	    getWidthEM:function () {
		    return this.view.getWidthEM();
	    }

    });
})();

////////////////////////////////////////
// SRC End --> t2k/component/mathField/MathField.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/select/OptionView.js
////////////////////////////////////////
(function () {

    var TEMPLATE =
        "<div id='{{id}}' class='option disabled {{autocheck}} {{type}}'>\
            <div class='status_icon'><span id='correct'>8</span><span id='wrong'>></span></div>\
            <div class='option_body'>\
                <div class='option_icon'><span id='select'>{{#isMmc}}#{{/isMmc}}{{^isMmc}}7{{/isMmc}}</span><span id='unSelect'>{{#isMmc}}\"{{/isMmc}}{{^isMmc}}6{{/isMmc}}</span></div>\
                <div class='option_content_wrap'>\
                    <div id='{{id}}_content' class='option_content'></div>\
                </div>\
            </div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the mc's view to use.
     */
    var defaultConfig = {
        /* The state style */
        state:'',
        /* The layout */
        layout:'inline',
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

    t2k.component.select.OptionView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.component.select.OptionView',

        ctor:function (config) {
            // Delegate.
            this._super(override(config, defaultConfig));

            // reference
            var thi$ = this;

            this.enableBlowup = false;

            jQuery(this._view).click(function() {
                thi$.dispatchEvent("onSelect", thi$.cfg.index);
            });
        },

        /**
         * onViewRendered
         * override
         */
        onViewRendered:function () {
        }, // end of onViewRendered

        /**
         * getInnerSize
         * @returns inner size
         */
        getInnerSize:function () {
	        return ({'width':Compat.actualWidth(this._content), 'height':Compat.actualHeight(this._content)});
        },

        /**
         * setIndex
         * @param index
         */
        setIndex:function (index) {
            this.cfg.index = index;
        },

        /**
         * setAutocheck
         */
        setAutocheck:function () {
            this._view.addClass('autocheck');
        },

        /**
         * reset
         * reset option
         */
        reset:function () {
            this._view.removeClass('correct');
            this._view.removeClass('wrong');
            this._view.removeClass('selected');
            this._view.removeClass('system_correct');
            this.cfg.state = '';
            this.markedAsSystemCorrect = false;
        },

        /**
         * setSelected
         * add or remove selected class
         * @param flag
         */
        setSelected:function (flag) {
            if (flag) {
                this._view.addClass("selected");
            } else {
                this._view.removeClass("selected");
            }
        },

        /**
         * getType
         * get options type
         * @returns type
         */
        getType:function () {
            return this.cfg.type;
        },

        /**
         * setType
         * @param type - mc / mmc
         */
        setType:function (type) {
            this.cfg.type = type;
            this._view.addClass(type);
        },

        /**
         * markAsCorrect
         */
        markAsCorrect:function () {
            this._view.removeClass('wrong');
            this._view.addClass('correct');
            this.cfg.state = 'correct';
        },

        /**
         * markAsSystemCorrect
         */
        markAsSystemCorrect:function () {
            if (this.cfg.state != 'correct') {
                this.markAsCorrect();
                this._view.removeClass('correct').addClass('system_correct');
            }
            this.markedAsSystemCorrect = true;
        },

        /**
         * isMarkAsSystemCorrect
         * @returns {Boolean}
         */
        isMarkAsSystemCorrect:function () {
            return !!this.markedAsSystemCorrect;
        },

        /**
         * isMarkedAsCorrect
         * @returns {Boolean}
         */
        isMarkedAsCorrect:function () {
            return this._view.hasClass('correct');
        },

        /**
         * markAsWrong
         */
        markAsWrong:function () {
            this._view.removeClass('correct');
            this._view.addClass('wrong');
            this.cfg.state = 'wrong';
        },

        /**
         * isMarkedAsWrong
         * @returns {Boolean}
         */
        isMarkedAsWrong:function () {
            return this._view.hasClass('wrong');
        },

        bindScrollEvent:function () {
            if(!ENV.behaviors.isAndroid && this.blowupElement){
                domUtils.registerToScroll(this.blowupElement, this);
            }

        },

        unbindScrollEvent:function () {
            if(!ENV.behaviors.isAndroid && this.blowupElement){
                domUtils.unRegisterToScroll(this._view, this);
            }
        },

        /**
         * setBlowup
         * clone option, delete it's internal html, and init child component
         * @param flag
         */
        setBlowup:function (flag) {
            this.enableBlowup = flag;
            var thi$ = this;

            // set event for blowup initialize
            ENV.behaviors.isAndroid || this._view.bind('mouseenter', function () {

                if (thi$._view.attr('blowup') == undefined || thi$._view.attr('blowup') == 'false') {

                    thi$._view.attr('blowup', 'true');

                    jQuery('.blowupElement').each(function (index, child) {
                        jQuery(child).trigger('mouseleave');
                    });

                    // clone dom and events
                    thi$.blowupElement = thi$._view.clone(true).hide();

                    // add classes and arrange cloned behavior
                    thi$.blowupElement.addClass('blowupElement onBlowup')
                        .attr('blowup', 'true').css({
                            'width':'',
                            'height':''
                        }).appendTo(thi$._view.parent());

                    // get & empty content element
                    var option_content = thi$.blowupElement.find('.option_content');
                    option_content.css({
                        'min-width':thi$._view.find('.option_content').width(),
                        'min-height':thi$._view.find('.option_content').outerHeight()
                    }).html('');

                    //set the cloned content element a new id
                    var option_content_id = genId();
                    option_content.attr('id', option_content_id);

                    // get, parse and send to factory
                    var xml = thi$.cfg.data;
                    jQuery(xml.childNodes).each(function (index, element) {
                        componentFactory.create({
                            data:element,
                            parent:option_content_id,
                            dontEnableBlowup:true,
                            // u'll find a full explanation at imageViewerView.js initClassMembers() fnc.
                            tumbnailAppliedForSmallImage:!!thi$.children[0].tumbnailAppliedForSmallImage,
                            onRendered:function () {

                                // fadeIn blowup and check minWidth
                                thi$.blowupElement.fadeTo(100, 0.02, function () {
                                    if (thi$.blowupElement.width() < thi$._view.outerWidth()) {
                                        thi$.blowupElement.width(thi$._view.outerWidth());
                                    }
                                    thi$.blowupElement.fadeTo(100, 1, function () {
                                        // domUtils.centerBlowUp(thi$.blowupElement);
                                    });
                                });

                                // set blowup position
                                domUtils.reparentOnceAndRepositionElement(thi$.blowupElement, thi$._view.offset());
                                //todo decide when and how (because blowup  disapear when mouse leave) and the scrollable object is cannot be scrolled when on blowup , how we deal with bind and unbind scroll event
                                //use bind and unBind to scroll event
                                //thi$.bindScrollEvent();

                            }
                        });
                    });

                    /**
                     * Sync blowup's .selected with option's (don't touch other classes).
                     */
                    thi$.blowupElement.click(function () {
                        var action = thi$._view.hasClass('selected') ? 'addClass' : 'removeClass';
                        thi$.blowupElement[action]('selected');
                    });

                    // add event listener on option mouseMove - remove blowup
                    thi$.blowupElement.mouseleave(function () {
                        //thi$.unbindScrollEvent();
                        thi$.blowupElement.fadeOut(function () {
                            thi$._view.attr('blowup', 'false');
                            thi$.blowupElement.remove();
                        });
                    });
                }

            });

        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/component/select/OptionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/component/select/Option.js
////////////////////////////////////////
(function() {

    t2k.component.select.Option = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.component.select.Option',
        
        /**
         * ctor
         * @param config
         */
        ctor: function(config) {
            // Delegate
            this._super(config);
            
            // reference
            var thisOption = this;
            
            // get correctness from xml
            this.isCorrect = jQuery(this.cfg.data).attr('correct') == 'true' ? true : false ;
            
            // init view
            this.view = this.createNewView(t2k.component.select.OptionView, copy(this.cfg, {
                minHeight: 52
            }));
            
            // get and set autocheck mode
            if (this.cfg.autocheck) this.setAutocheck();

	        this.checkAnswerOnState = this.cfg.checkAnswerOnState;
            
            this.selected = false;
            
            var blow = ENV.behaviors.allowBlowup ;
            
            // start composite - create children
        	this.startComposite2({
        		parent: this.view.cfg.id + '_content',
                fixNarrationPosition: 'bottom',
		        taskmode : this.cfg.mode,
                // TODO: DEMO !!
                applyAbsoluteMinimum: blow,
                // TODO: DEMO !!
                onAbsMin : function(){
                	if( blow ) {
                		thisOption.view.setBlowup(true);
                	}
                },
        		dontEnableBlowup : !blow
        	});
        	
        	// check disabled space eating (override)
        	// in child component is imageViewer, disable spaceEating (layouter)
        	this.layout.disableSpaceEating = function(){
        		var childName = thisOption.children[0].name.split('.');
            	childName = childName[childName.length-1].toLowerCase();
            	return (childName == 'imageviewer') ? true : false;
            }
        },
        
        /**
         * loose - override
         */
        loose : function(){
        	// dont loose me ! :)
        },
        
        /**
         * looseHeight
         */
        looseHeight : function(){
        	this._super();
        },
        
        /**
         * setIndex
         * set presenter and view index
         * @param index
         */
        setIndex: function(index){
        	this.cfg.index = index;
        	this.view.setIndex(index);
        },
        
        /**
         * setType
         * set presenter and view type
         * @param type
         */
        setType: function(type){
        	this.cfg.type = type;
        	this.view.setType(type);
        },
        
        /**
         * setAutocheck
         * set view autocheck (diff. click handling) 
         */
        setAutocheck: function(){
        	this.view.setAutocheck();
        },
        
        /**
         * reset
         * reset view (correct / wrong etc..)
         */
        reset: function() {
            this.view.reset();
            this.setSelected(false);
            this.removeSpecificFeedback();
        },
        
        /**
         * setSelected
         * @param flag
         */
        setSelected: function(flag) {
            this.view.setSelected(flag);
            this.selected = flag;
        },
        
        /**
         * isSelected
         * @returns {Boolean}
         */
        isSelected: function() {
            return this.selected;
        },

        /**
         * setMyState - override
         * analyze state and set option
         * @param state
         */
        setMyState : function(state){
	        this.reset();
	        this.setSelected(state.children('select').text() === 'true');
			this.setEnabled(state.children('enabled').text() == 'true');

	        if(!this.checkAnswerOnState) { //checking is handled not by state
		        if (state.children('correct').text() === 'true') this.markAsCorrect();
		        if (state.children('wrong').text() === 'true') this.markAsWrong();
		        if (state.children('systemCorrect').text() === 'true') this.markAsSystemCorrect();
	        }

        },	
        
        //override - get state of component
        /**
         * addMyState
         * to getState
         */
        addMyState : function(){
           var state = jQuery('<state>');
           jQuery('<select/>').text((this.isSelected() ? "true" : "false")).appendTo(state);
           jQuery('<correct/>').text(this.isMarkedAsCorrect()).appendTo(state);
           jQuery('<wrong/>').text(this.isMarkedAsWrong()).appendTo(state);
           jQuery('<systemCorrect/>').text(this.isMarkAsSystemCorrect()).appendTo(state);
           jQuery('<type/>').text(this.getType()).appendTo(state);
           jQuery('<enabled/>').text(this.isEnabled() || false).appendTo(state);
           return state;
        },
        
        /**
         * resetState
         */
        resetState : function(){
        	this.reset();
        },
        
        /**
         * getType
         * @returns type
         */
        getType: function() {
            return this.view.getType();
        },
        
        /**
         * markAsCorrect
         * set view as correct
         */
        markAsCorrect: function() {
            this.view.markAsCorrect();
        },
        
        /**
         * isMarkedAsCorrect
         * @returns {Boolean}
         */
        isMarkedAsCorrect: function() {
            return this.view.isMarkedAsCorrect();
        },

        /**
         * markAsSystemCorrect
         * set view
         */
        markAsSystemCorrect: function() {
            this.view.markAsSystemCorrect();
        },
        
        /**
         * isMarkAsSystemCorrect
         * @returns {Boolean}
         */
        isMarkAsSystemCorrect: function() {
            return this.view.isMarkAsSystemCorrect();
        },
        
        /**
         * markAsWrong
         * set view
         */
        markAsWrong: function() {
            this.view.markAsWrong();
        },
        
        /**
         * isMarkedAsWrong
         * @returns {Boolean}
         */
        isMarkedAsWrong: function() {
            return this.view.isMarkedAsWrong();
        },

        /*
         * setSpecificFeedback
         * set view
         */
         setSpecificFeedback: function(message){
            this.view.setSpecificFeedback(message, 'option');
         },
        
        /**
         * reduce
         */
        reduce : function(){
        	jQuery(this.children).each(function(index, child){	 
        		if(child.reduce){
        			child.reduce();
        		}
			});
        	
        }

    });

})();
////////////////////////////////////////
// SRC End --> t2k/component/select/Option.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/BalloonButtonView.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    var TEMPLATE =
        "<div id='{{id}}' class='balloon-button {{mode}}'>\
            <div id='{{id}}_content' class='balloon-button-content{{#isReduced}} reduced{{/isReduced}}'>\
                <div id='{{id}}_content_icon' class='balloon-button-icon' {{#isReduced}}title={{label}}{{/isReduced}}><span id='feedback'>*</span><span id='hint'>.</span></div>\
                <div id='{{id}}_content_title' class='balloon-button-title'>{{label}}</div>\
            </div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.controls.BalloonButtonView
     * 2d0 - complete doc
     */
    t2k.player.task.controls.BalloonButtonView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.player.task.controls.BalloonButtonView',

        /**
         * 2d0 - complete doc
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            var thi$ = this;

            this._content.height(this._view.height() - 5);

            this._view.click(function () {
                if (thi$.isEnabled()) {
                    thi$.dispatchEvent('onClick');
                }
            });
        },

        onViewRendered:function () {
//            this.dispatchEvent('onRendered');
        } // end of onViewRendered
        
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/controls/BalloonButtonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/BalloonButton.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

var _currBalloonHandler;

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.controls.BalloonButton
     * 2d0 - complete doc
     */
    t2k.player.task.controls.BalloonButton = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.BalloonButton',

        ctor: function(config) {
            // Delegate
            this._super(config);

            var thi$ = this;

            // Create the view
            this.view = this.createNewView(t2k.player.task.controls.BalloonButtonView, {
                parent: this.cfg.parent,
                mode: this.cfg.mode,
                label: this.cfg.label,
                enabled: true,
                isReduced:this.cfg.isReduced,
                setSrcAtStart : this.cfg.setSrcAtStart,
                events: {
                    onClick: function() {
                        if (t2k.util.balloon.isOpened()) {
                            if (thi$.isBalloonOwner()) t2k.util.balloon.close();
                            else thi$.displayBalloonMessage(null);
                        } else {
                            thi$.displayBalloonMessage(null);
                        }
                    }
                }
            });

        },

        setVisible: function(flag) {
            this._super(flag);
            if (!flag && _currBalloonHandler == this) t2k.util.balloon.close();
        },

        setMessage: function(msgCfg) {
            if (msgCfg) this.msgCfg = msgCfg;
        },

        displayBalloonMessage: function(msgCfg) {
            if (msgCfg) this.msgCfg = msgCfg;
            if (this.msgCfg) {
                this.msgCfg.btn = this.view._view;
                this.msgCfg.align = 'text';
                this.msgCfg.viewport = this.cfg.viewport;
                this.msgCfg.constraint = this.cfg.constraint;
                this.msgCfg.setSrcAtStart = this.cfg.setSrcAtStart;
                t2k.util.balloon.show(this.msgCfg);
                _currBalloonHandler = this;
            }
        },

        hideBalloon: function() {
            t2k.util.balloon.close();
        },

        isBalloonOwner: function() {
            return _currBalloonHandler == this;
        },

        getState: function() {
            var state = jQuery('<' + this.cfg.mode + '/>');
            state.attr('owner', this.isBalloonOwner());
            if (this.isBalloonOwner()) {
                state.attr('balloonOpened', t2k.util.balloon.isOpened());
            }
            state.attr('enabled', this.isEnabled());
            state.attr('visible', this.isVisible());
            if (this.msgCfg) {
                if (this.msgCfg.icon) state.attr('icon', this.msgCfg.icon);
                /** Compatible cross-document append */
                if(this.msgCfg.data) state.append(Compat.importNode(this.msgCfg.data, true));
            }
            return state;
        },

        setState: function(xml) {
            this._super(xml);
            var jqXml = jQuery(xml);
//            this.setEnabled(jqXml.attr('enabled') === 'true');
            this.setVisible(jqXml.attr('visible') === 'true');
            if (jqXml.attr('owner') === 'true') {
                _currBalloonHandler = this;
            }

            if (jqXml.children().length > 0) {
                this.msgCfg = {
                    icon:jqXml.attr('icon'),
                    data:jqXml.children()[0]
                };
            }

            if (this.isBalloonOwner() && jqXml.attr('balloonOpened') === 'true') {
                this.displayBalloonMessage(null);
            }
        }


    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/player/task/controls/BalloonButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/SpecificFeedbackBalloonView.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    var TEMPLATE =
        "<div id='{{id}}' class='specificFeedbackBalloonWrapper'>\
            <div id='{{id}}_content' class='balloonContent'></div>\
            <div id='{{id}}_arrow' class='balloon_arrow'></div>\
            <div id='{{id}}_balloon_close' class='balloon_close'>\
                $\
                <span class='mobile-touch-area'></span>\
            </div>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template:TEMPLATE
    }; // End of defaultConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.controls.SpecificFeedbackBalloonView
     * 2d0 - complete doc
     */
    t2k.player.task.controls.SpecificFeedbackBalloonView = t2k.component.BaseComponentView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.player.task.controls.SpecificFeedbackBalloonView',

        /**
         * 2d0 - complete doc
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            this._view.width(this._view.css('max-width'));//set max width to let the text viewer to calculate its width


            var thi$ = this;

            //show baloon on click on the status icon
            this._view.parents('.'+ config.parentClass).mousedown(function () {
                //hide balloon when click on close
                if( thi$.isEnabled() &&
                    thi$.isOpened &&
                    $(event.target).hasClass('balloon_close') || $(event.target).parents().hasClass('balloon_close')) {
                        thi$.hideBalloon();
                        event.stopPropagation();
                }else{
                    //show ballon when click on the option/subanswer
                   if(  thi$.isEnabled() &&
                        !thi$.isOpened &&
                        ($(event.target).hasClass(config.parentClass) || $(event.target).parents('.'+config.parentClass).length && !$(event.target).parents('.specificFeedbackBalloonWrapper').length) ){
                        thi$.showBalloon();
                        event.stopPropagation();
                    }
                }
            });

            //hide balloon on click outsode of the balloon element - exept click on the status icon
            jQuery(document).on('mousedown', function(){
                if(!$(event.target).hasClass(thi$.cfg.parentClass) && !$(event.target).parents('.'+ thi$.cfg.parentClass).length){
                    thi$.hideBalloon();
                    event.stopPropagation();
                }
            });

            componentFactory.create(copy({
                data : config.data,
                setMaxWidth : parseInt(this._view.css('max-width')),
                parent: this._view.find('.balloonContent'),
                onRendered: function(){
                    thi$._arrow = thi$._view.find('.balloon_arrow');
                    thi$.setBaloonPosition();
                    thi$.isOpened= true;
                }
            }));
            this._view.width(   this._view.children().find('.textViewer').width() +
                                parseFloat(this._view.children().first().css('margin-right')) + 
                                parseFloat(this._view.children().first().css('margin-left'))+
                                2*parseFloat(this._view.css('border-left')) ); // remove width from baloon to get the actual textviewer width
        },

        //display balloon
        showBalloon : function(){
            this._view.show();
            this.isOpened = true;

        },

        //find the balloon position and its arrow
        setBaloonPosition: function(){

            var parentContainer = this._view.parents('.'+ this.cfg.parentClass),

            statusIcon = this._view.parent().find('.status_icon'),
            
            //align baloon to the left side of answer 
            horizontalDirection = ENV.contentDirection == 'ltr' ? 'left' : 'right';

            //enlarge the specific feedback balloon if the parent container is larger
            if(this._view.width() < parentContainer.width()){
                this._view.width(parentContainer.width()+ statusIcon.width());
                this._view.children().find('.textViewer').css('max-width', '');
            }

            //if balloon cant fit in top of view port, set it in the bottom
            if( parentContainer.offset().top < this._view.height() + statusIcon.height()){
                this._arrow.addClass('bottom');
                this._view.css('top', statusIcon.height());

            }else{
                this._arrow.addClass('top');
                this._view.css('top', - statusIcon.height() - this._view.height());

            }

            //place arrow right above status icon
            this._arrow.css( horizontalDirection, parentContainer.width()- statusIcon.width()/2);

        },

        //hide balloon
        hideBalloon: function(){
            this._view.hide();
            this.isOpened = false;
        },
        remove : function(){
            this._view.remove();
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/controls/SpecificFeedbackBalloonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/SpecificFeedbackBalloon.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

var _currBalloonHandler;

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.controls.SpecificFeedbackBalloon
     * 2d0 - complete doc
     */
    t2k.player.task.controls.SpecificFeedbackBalloon = t2k.component.BaseComponent.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.SpecificFeedbackBalloon',

        ctor: function(config) {
            // Delegate
            this._super(config);

            // Create the view
            this.view = this.createNewView(t2k.player.task.controls.SpecificFeedbackBalloonView, {
                parent: this.cfg.parent,
                parentClass : this.cfg.parentClass,
                data : this.cfg.data,
                enabled: true
            });

        },
        remove: function(){
            if(this.view){
                this.view.remove();
                delete this.view;
            }
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/player/task/controls/SpecificFeedbackBalloon.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/InstructionView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div id='{{id}}' class='instruction'>\
            <div id='{{id}}_content' class='task_instruction_content'>\
	            <div id='{{id}}_icon' class='task_instruction_icon'>\
	            /\
	            </div>\
            </div>\
        </div>";

//            <div id='{{id}}_separator' class='instruction_separator'></div>\
    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE,
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.player.task.controls.InstructionView = t2k.component.CompositeView.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.InstructionView',

        /**
         * 2d0 - complete doc
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            this.setReduced( this.cfg.isReduced ) ;
        },
		
        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	if( value ) {
	            	console.log( 'reduced instruction' ) ;
	        	} else {
	        		console.log( 'non-reduced instruction' ) ;
	        	}
	        	this.cfg.isReduced = value ;
        	}
        },
		
        setEmphasized: function( value ) {
        	var jView = jQuery( '#' + this.cfg.id + '_content' ) ;
            // TODO: fix display div.narratio (yellow light when playing)
            if (jView) {
                if( value) {
                   jView.addClass( 'instruction_emphasized' ) ; 
                } else {
                   jView.removeClass( 'instruction_emphasized' ) ;
                }
            }
        },
        
        addTaskHelpClass:function () {
        	this._content.addClass('has_task_help');
        },

        setSequenceMode:function() {
            Perf.select('#' + this.cfg.id + '_icon').css('display', 'none');
        }
    });

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/controls/InstructionView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/Instruction.js
////////////////////////////////////////
(function() {

    t2k.player.task.controls.Instruction = t2k.component.Composite.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.Instruction',

        ctor: function(config) {
            // Delegate
            this._super(config);
            // Create the view
            this.view = this.createNewView(t2k.player.task.controls.InstructionView, this.cfg );

            if (this.cfg.hasHelp) this.addTaskHelpClass();

            this.isFirstPlay = true;

            this.cfg.emphasized = ENV.behaviors.disableAutoNarrationOfInstraction ? false : this.cfg.emphasized;

            this.startComposite2( {parent: this.view.cfg.id + '_content'} ) ;

            this.tav = this.children[0] ;
        },

        setEnabled: function(flag) {
            this._super(flag);

            this.tav.setEnabled( flag ) ;

            if( flag && this.cfg.emphasized && this.tav && this.isFirstPlay ) {
            	var thi$ = this ;
                this.isFirstPlay = false ;
            	this.view.setEmphasized( true ) ;
            	this.tav.narrate(function() {
                    thi$.cfg.eventsManager.dispatchEvent('onInstructionNarrationDone');
                    thi$.view.setEmphasized( false ) ;
                }) ;
                this.cfg.eventsManager.dispatchEvent('onInstructionNarrationStarted');
            } else {
                this.cfg.eventsManager.dispatchEvent('onInstructionNarrationDone');
            }
        },

        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	this.cfg.isReduced = value ;
	        	this.view.setReduced( value ) ;
        	}
        },

        addTaskHelpClass:function () {
        	this.view.addTaskHelpClass();
        },
        setSequenceMode:function() {
            this.view.setSequenceMode();
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/player/task/controls/Instruction.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/DropDownButtonView.js
////////////////////////////////////////
(function() {


    t2k.player.task.controls.DropDownButtonView = t2k.core.View.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.DropDownButtonView',

        /**
         * ctor
         */
        ctor: function(config) {
        	// ref
            var thi$ = this;
            
        	// Delegate.
            this._super(config);
            
            // bind this._view click and dispatch onClick event
            jQuery(this._view).click(function (e) {
	            e.stopPropagation();

            	thi$.dispatchEvent('onClick', {
            		view:thi$,
            		el:jQuery(e.target)
            	});
	            return false;
            });
            
            // set flag
            this.dropDownOpen = false; //drop down state
        },
        
        /**
         * addDropdownItem
         * @param data
         */
        addDropdownItem:function (data) {
        	// ref
        	var thi$ = this;
        	
        	// set and append item
        	var item = jQuery('<div />')
        		.html(data.label)
        		.attr({
                    'index' : data.index,
                    'title' : data.label
                })
        		.appendTo(this._dropdown)
        		.click(function () {
        			var item = jQuery(this);
        			thi$.dispatchEvent('onSelect', item.attr('index'));
        		});
        	
        	// ? hide
        	if (data.initHide){
        		item.hide();
        	}
        	
        	// ? set type
        	if (data.type){
        		item.attr('type' , data.type);
        	}
        },
        
        /**
         * toogleDropdown
         * toggle drop down menu
         * @param el
         */
        toogleDropdown : function(el) {
        	
        	// if the clicked element is the drop down menu button

        	if (el.attr('id') == this._icon.attr('id')) {
        		// on open - hide
        		if (this.dropDownOpen) {
        			this._dropdown.addClass('hidden');
        			this._icon.removeClass('active');
        		} else {
        			// on hidden - open
        			this._dropdown.removeClass('hidden');
        			this._icon.addClass('active');
        		}
            	// set flag
            	this.dropDownOpen = !this.dropDownOpen;
            	
        	} else {
        		// if the clicked element is not the drop down button - hide it
        		this._dropdown.addClass('hidden');
        		this._icon.removeClass('active');
        		// set flag
        		this.dropDownOpen = false;
        	}
            	
        },
        
        /**
         * closeDropdown
         * set class and flag
         */
        closeDropdown:function () {
        	this._dropdown.addClass('hidden');
        	this.dropDownOpen = false;
        },
		
        /**
         * setReduced
         * @param value
         * TODO: check and remove
         */
        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	if( value ) {
	            	console.log( 'reduced instruction' ) ;
	        	} else {
	        		console.log( 'non-reduced instruction' ) ;
	        	}
	        	this.cfg.isReduced = value ;
        	}
        }
    });

})();
////////////////////////////////////////
// SRC End --> t2k/player/task/controls/DropDownButtonView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/DropDownButton.js
////////////////////////////////////////
(function() {

    t2k.player.task.controls.DropDownButton = t2k.core.Presenter.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.DropDownButton',
        
        /**
         * ctor
         * @param config
         */
        ctor: function(config) {
        	// Delegate
            this._super(config);
            
            //store items config
            this.items = {};
            
            this.createView();
            
            this.fillDropdown();
        },
        
        /**
         * createView
         * a place for inheritor's view creation
         */
        createView : function(){
        	 /* null implementation */
        },
        
        /**
         * fillDropdown
         * a place for inheritor's drop down fill
         */
        fillDropdown:function () {
        	 /* null implementation */
        },
        
        /**
         * setEnabled
         * @param flag
         */
        setEnabled: function(flag) {
            this._super(flag);
        },
        
        /**
         * setReduced
         * @param value
         * TODO: check and remove
         */
        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	this.cfg.isReduced = value ;
	        	this.view.setReduced( value ) ;
        	}
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();
////////////////////////////////////////
// SRC End --> t2k/player/task/controls/DropDownButton.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/TaskHelpView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
    	"<div id='{{id}}' class='taskHelp'>\
	        <div id='{{id}}_content' class='task_help_content'>\
	            <div id='{{id}}_icon' class='task_help_icon'/>\
	            <div id='{{id}}_dropdown' class='task_help_dropdown hidden'/></div>\
	        </div>\
	    </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE,
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.player.task.controls.TaskHelpView = t2k.player.task.controls.DropDownButtonView.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.DropDownButtonView',

        /**
         * ctor
         */
        ctor: function(config) {
        	// Delegate.
            this._super(copy(config, defaultConfig));
        },

	    toogleDropdown : function(el) {
		    this._super(el);

		    //if dropdown was closed & we did not click again on the help icon- we want to display the help item
		    if (!this.dropDownOpen && el.attr('id') != this._icon.attr('id')) {
			    //build help item modal config
			    var helpIndex = el.attr('index') && el.attr('index').px2int();
			    if (typeof helpIndex === 'undefined') {
				    return;
			    }

			    var thi$ = this;

			    ENV.Modal.show({
				    data:this.cfg.items[helpIndex],
				    dummyMode:false,
				    state: thi$.cfg.sequenceObj.helpState[helpIndex],
				    onClose:function (state) {
					    thi$.cfg.sequenceObj && (thi$.cfg.sequenceObj.helpState[helpIndex] = state);
				    }
			    });
		    }
	    }
        
    });

})();
////////////////////////////////////////
// SRC End --> t2k/player/task/controls/TaskHelpView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/TaskHelp.js
////////////////////////////////////////
(function() {

    t2k.player.task.controls.TaskHelp = t2k.player.task.controls.DropDownButton.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.TaskHelp',
        
        /**
         * ctor
         * @param config
         */
        ctor: function(config) {
        	// Delegate
            this._super(config);
        },
        
        /**
         * createView
         * bind relevant events (host fnc [popup])
         */
        createView : function(){
        	// ref
        	 var thi$ = this;
        	
        	 // Create the view
            this.view = new t2k.player.task.controls.TaskHelpView( copy(this.cfg, {
            	events:{
            		
            		onClick:function (obj) {
            			obj.view.toogleDropdown(obj.el);
            		},
            
		            onSelect:function (index) {
		            	// do somthing here...
		    		}
            	}
            }) );
        },
        
        /**
         * fillDropdown
         * xml parsing
         */
        fillDropdown:function () {
        	// Delegate
        	this._super();
        	
        	var item, caption, thi$ = this;
        	
        	this.cfg.items.each(function (index) {
        		item = jQuery(this),
        		caption = item.attr('caption');

		        thi$.view.addDropdownItem({
			        label:caption,
			        index:index
		        });

		        thi$.items[index] = {
			        winTitle:caption
		        };
        		
        	});
        }
        
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();
////////////////////////////////////////
// SRC End --> t2k/player/task/controls/TaskHelp.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/TeacherMenuView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
    	"<div id='{{id}}' class='teacherMenu'>\
	        <div id='{{id}}_content' class='teacher_menu_content'>\
	            <div id='{{id}}_icon' class='teacher_menu_icon'/>\
	            <div id='{{id}}_dropdown' class='teacher_menu_dropdown hidden'/></div>\
	        </div>\
	    </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE,
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.player.task.controls.TeacherMenuView = t2k.player.task.controls.DropDownButtonView.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.TeacherMenuView',

        /**
         * ctor
         */
        ctor: function(config) {
        	// Delegate.
            this._super(copy(config, defaultConfig));
        },
        
        /**
         * displayItem
         * hide / show item by type
         * @param type {String}
         * @param show {Boolean}
         */
        displayItem : function(type, show){
        	this._view.find('div[type=' + type + ']').css('display',  show ? '' : 'none');
        }
        
    });

})();
////////////////////////////////////////
// SRC End --> t2k/player/task/controls/TeacherMenuView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/TeacherMenu.js
////////////////////////////////////////
(function() {

    t2k.player.task.controls.TeacherMenu = t2k.player.task.controls.DropDownButton.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.TeacherMenu',
        
        /**
         * ctor
         * @param config
         */
        ctor: function(config) {
        	// Delegate
            this._super(config);
        },
        
        /**
         * createView
         * bind onSelect event - apply item's data function
         */
        createView : function(){
        	// ref
        	 var thi$ = this;
        	
        	 // Create the view
            this.view = new t2k.player.task.controls.TeacherMenuView( copy(this.cfg, {
            	events:{
            		
            		onClick:function (obj) {
            			obj.view.toogleDropdown(obj.el);
            		},
            
		            onSelect:function (index) {
		            	// call lable's fnc
		            	thi$.items[index].fnc.apply();
		    		}
            	}
            }) );
        },
        
        /**
         * fillDropdown
         * parse JSON's array
         */
        fillDropdown:function () {
        	// Delegate
        	this._super();
        	
        	var item, caption, thi$ = this;
        	
        	jQuery(this.cfg.data).each(function (index, lable) {

        		thi$.view.addDropdownItem({
        			// languageUtils (i18e)
        			label 		: _i18n('task.progress.labels.' + lable.lable),
        			type		: lable.lable,
        			index 		: index,
        			initHide 	: lable.initHide
        		});
        	
        		thi$.items[index] = {
        			label	: caption,
        			fnc		: lable.fnc
        		};
        		
        		// validate item data [type]
        		if (!thi$.items[index].fnc) throw 'drop dowm menu data error - [' + caption + '] fnc mismatch';
        		
        	});
        },
        
        /**
         * toggleDropdownContent
         * @param showType
         * @param hideType
         */
        toggleDropdownContent : function(showType, hideType){
        	this.showItem(showType);
        	this.hideItem(hideType);
        },
        
        showItem : function(showType){
        	this.view.displayItem(showType, true);
        },
        
        hideItem : function(hideType){
        	this.view.displayItem(hideType, false);
        }
        
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();
////////////////////////////////////////
// SRC End --> t2k/player/task/controls/TeacherMenu.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/AttemptsIndicatorView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div id='{{id}}' class='attempt{{#isReduced}} reduced{{/isReduced}}'>\
            <span id='{{id}}_text' class='attempt_text'>{{attemptsTxt}}:</span>\
            <span id='{{id}}_content' class='attempt_content'>\
            </span>\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE,
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.player.task.controls.AttemptsIndicatorView = t2k.core.View.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.AttemptsIndicatorView',

        /**
         * 2d0 - complete doc
         */
        ctor: function(config) {
            
        	config.attemptsTxt = _i18n('tasktoolbar.attempts');
        	// Delegate.
            this._super(copy(config, defaultConfig));

        },		
        
        setValues: function( attempts, current ) {
        	var jLabel = jQuery( this._view.selector + '_content' ) ;
        	jLabel.html( getAttemptsString( attempts, current ) ) ;
        }
    });

	function getAttemptsString( attempts, current ) {
		return '<span>' + current + '</span>/' + attempts ; 
	}

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/controls/AttemptsIndicatorView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/AttemptsIndicator.js
////////////////////////////////////////
(function() {

    t2k.player.task.controls.AttemptsIndicator = t2k.core.Presenter.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.AttemptsIndicator',

        ctor: function(config) {
            // Delegate
            this._super(config);
            // Create the view
            this.view = new t2k.player.task.controls.AttemptsIndicatorView( this.cfg );
            
        },
        
        setEnabled: function(flag) {
            this._super(flag);
            
            if( flag && this.cfg.emphasized && this.tav ) {
            	this.view.setEmphasized( true ) ;
            	this.tav.narrate() ;
            }
        },

        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	this.cfg.isReduced = value ;
	        	this.view.setReduced( value ) ;
        	}
        },
        
        setCurrentAttempt: function( current ) {
        	this.view.setValues( this.cfg.attempts, current ) ;
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/player/task/controls/AttemptsIndicator.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/PointsIndicatorView.js
////////////////////////////////////////
(function() {

    var TEMPLATE =
        "<div id='{{id}}' class='point{{#isReduced}} reduced{{/isReduced}}'>\
            <span id='{{id}}_content' class='point_content'></span>\
            <span id='{{id}}_text' class='point_text'>{{pointsTxt}}</span>&nbsp;\
        </div>";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE,
        layout: 'inline'
    }; // End of defaultConfig.

    t2k.player.task.controls.PointsIndicatorView = t2k.core.View.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.PointsIndicatorView',

        /**
         * 2d0 - complete doc
         */
        ctor: function(config) {
            
        	config.pointsTxt = _i18n('tasktoolbar.points');
        	// Delegate.
            this._super(copy(config, defaultConfig));

        },		
        
        setValues: function( points, correct ) {
        	var jLabel = jQuery( this._view.selector + '_content' ) ;

	        if(points > 0) {
        	    jLabel.html(typeof correct === 'number' ? getPointsString( points, correct ) : points) ;
	        } else {
		        this._view.hide();
	        }
        }
    });

	function getPointsString( total, correctPoints ) {
		return '<span>' + correctPoints + '</span>/' + total ;
	}

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/controls/PointsIndicatorView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/PointsIndicator.js
////////////////////////////////////////
(function() {

    t2k.player.task.controls.PointsIndicator = t2k.core.Presenter.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.task.controls.PointsIndicator',

        ctor: function(config) {
            // Delegate
            this._super(config);
            // Create the view
            this.view = new t2k.player.task.controls.PointsIndicatorView( this.cfg );

	        this.setCurrentPoint(null);
            
        },
        
        setEnabled: function(flag) {
            this._super(flag);
            
            if( flag && this.cfg.emphasized && this.tav ) {
            	this.view.setEmphasized( true ) ;
            	this.tav.narrate() ;
            }
        },

        setReduced: function( value ) {
        	if( this.cfg.isReduced != value ) {
	        	this.cfg.isReduced = value ;
	        	this.view.setReduced( value ) ;
        	}
        },
        
        setCurrentPoint: function( correct ) {
        	this.view.setValues( this.cfg.points, correct ) ;
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/player/task/controls/PointsIndicator.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/progress/Progress.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.progress.Progress
     * handles all kind of task's progression
     *
     * Properties:
     *  config - {Object} The progress's configuration.
     */
    t2k.player.task.progress.Progress = Object.subClass({
        name:"t2k.player.task.progress.Progress",

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor:function (config) {

            // set config as a member
            this.cfg = config;
            // init members
            this.started = false;
            this.finished = false;
            
            //currently autocheck should be disabled (also in McAnswer)
            this.cfg.progressData.autocheck = false;
            
            // init current mode from answer's progress configuration
            this.currentMode = this.cfg.defaultProgressConfig.buttonModes.currMode;

            var buttonMode = this.cfg.progressData.autocheck ? 'progress' : this.getButtonProgressMode();

            // if attempts = 0, the task that handles by this progress is not checkable
            if (this.cfg.progressData.attempts == 0) {
                this.attempt = null;
            } else {
                // if this task is checkable, init checkable toolbar
                this.cfg.eventsManager.dispatchEvent('initCheckableToolbar');
                // set the attempts as the first attempt
                this.attempt = 1;
                // update attempts indicator with the first attempt
                var msgAttempt = attemptNumberToName(this.attempt, this.cfg.progressData.attempts);
                this.cfg.eventsManager.dispatchEvent('updateAttemptsIndicator', [this.attempt, msgAttempt]);
            }

            // config progression button
            this.cfg.eventsManager.dispatchEvent('configButton', {
                enabled:false,
                visible:true,
                // set the button mode with the init val from answer progression configuration 
                mode:buttonMode
            });

            // register progression's events
            this.registerEvents();

        }, // End of ctor

        /**
         * registerEvents
         * register progression's events
         *
         * these events are register in the task events manager (see: task/controls/TaskEventManager.js)
         */
        registerEvents:function () {
            var thi$ = this;

            /**
             * event name: setProgressReady
             * if the task doesn't "finish", enable progress button.
             * except "auto check". in that case, simply check the answer
             */
            this.cfg.eventsManager.registerEvent('setProgressReady', function () {
                if (!thi$.finished) {
                    if (thi$.cfg.progressData.autocheck) {
                        thi$.cfg.eventsManager.dispatchEvent('onAnswerCheck');
                    } else {
                        if (thi$.started) {
                            thi$.cfg.eventsManager.dispatchEvent('configButton', {
                                enabled:true
                            });

                        }
                    }
                }
            });

            /**
             *  event name: setProgressProgress
             *  checkable progress
             *
             *  @param feedbackMessage
             */
            this.cfg.eventsManager.registerEvent('setProgressProgress', function (feedbackMessage) {
                // set answer non interactive
                thi$.cfg.eventsManager.dispatchEvent('setAnswerInteractable', false);

                if (!thi$.finished) {

                    var msgAttempt;
                    var enableButton = false;
                    var autoButtonMode = null;

                    var buttonProperties = {};

                    // switch current progression mode
                    switch (thi$.currentMode) {

                        case 'check':

                            // check for last attempt
                            var notLast = thi$.attempt < thi$.cfg.progressData.attempts;
                            // if this is the last attempt, set for showAnswer mode. else, set for tryAgain mode.
                            var mode = notLast ? 'tryagain' : 'showanswer';
                            
                            var checkData = null ;
                            
                            if( !!feedbackMessage ) {
                            	checkData = { checkedValue: feedbackMessage.data.type, currentAttempt: thi$.attempt } ;
                            }
                            
                            thi$.cfg.eventsManager.dispatchEvent( 
                            		'logProgressEvent',
                            		[
	        							t2k.util.LogEventsService.CHECK_PRESSED,
	        							checkData
        							]
                            ) ;
                            
                            msgAttempt = attemptNumberToName(thi$.attempt, thi$.cfg.progressData.attempts);
                            var showSummaryIcon = mode == 'showanswer';

	                        if(feedbackMessage) {
                                thi$.cfg.eventsManager.dispatchEvent('showFeedback', [feedbackMessage, showSummaryIcon, msgAttempt]);
	                        }

                            if (showSummaryIcon) {
                                thi$.cfg.eventsManager.dispatchEvent('setTaskCompletedFocused', true);
                            }

                            if (notLast) {
                                thi$.attempt++;
                            } else {
                            	thi$.cfg.eventsManager.dispatchEvent( 'finishedAllAttempts' ) ;
                            }
                            
                            thi$.currentMode = mode;

                            buttonProperties.enabled = true;
                            buttonProperties.mode = mode;

                            break;

                        case 'tryagain':

                            thi$.cfg.eventsManager.dispatchEvent('setAnswerInteractable', true);

                            thi$.currentMode = 'check';

                            buttonProperties.enabled = (thi$.cfg.defaultProgressConfig.progressType === 'init');
                            buttonProperties.mode = thi$.currentMode;

                            thi$.cfg.eventsManager.dispatchEvent('hideBalloon');

                            msgAttempt = attemptNumberToName(thi$.attempt, thi$.cfg.progressData.attempts);
                            thi$.cfg.eventsManager.dispatchEvent('updateAttemptsIndicator', [thi$.attempt, msgAttempt]);

                            thi$.cfg.eventsManager.dispatchEvent('showHintButton');

                            if (thi$.cfg.progressData.autocheck) {
                                buttonProperties.mode = 'progress';
                            }

                            break;

                        case 'showanswer':
                        	
                        	thi$.cfg.eventsManager.dispatchEvent('logProgressEvent', t2k.util.LogEventsService.SHOW_ANSWER ) ;
                        	
                            thi$.currentMode = 'progress';

                            buttonProperties.enabled = true;
                            buttonProperties.mode = thi$.currentMode;

                            if (thi$.cfg.progressData.autocheck) {
                                buttonProperties.enabled = true;
                                buttonProperties.mode = thi$.getButtonProgressMode();
                            } else { // close feedback
                                thi$.cfg.eventsManager.dispatchEvent('hideFeedback');
                            }

                            //thi$.cfg.eventsManager.dispatchEvent('setTaskCompletedFocused' , true);

                            break;
                    }

                    thi$.cfg.eventsManager.dispatchEvent('configButton', buttonProperties);
                }
            });

            this.cfg.eventsManager.registerEvent('setProgressUnready', function () {
                if (!thi$.finished) {
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:false
                    });
                }
            });

            this.cfg.eventsManager.registerEvent('setProgressDone', function () {
                if (!thi$.finished) {
                	
                	var fbType = t2k.util.FeedbackUtils.TYPE_ALL_CORRECT ;
                	
                    thi$.cfg.eventsManager.dispatchEvent( 
                    		'logProgressEvent',
							[
								t2k.util.LogEventsService.CHECK_PRESSED,
								{	
									checkedValue: fbType,
									currentAttempt: thi$.attempt
								}
							 ]
                    ) ;
                	
                    var msgData = FeedbackService.createMessage( fbType ) ;
                    var msgAttempt = attemptNumberToName(thi$.attempt, thi$.cfg.progressData.attempts);

                    var showSummaryIcon = true;
                    thi$.cfg.eventsManager.dispatchEvent('showFeedback', [msgData, showSummaryIcon, msgAttempt]);

                    if (showSummaryIcon) {
                        thi$.cfg.eventsManager.dispatchEvent('setTaskCompletedFocused', true);
                    }

                    thi$.currentMode = 'progress';

                    if (thi$.cfg.progressData.autocheck) {
                        thi$.cfg.eventsManager.dispatchEvent('configButton', {
                            visible:true
                        });
                    }
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:true,
                        mode:thi$.getButtonProgressMode()
                    });

                    //thi$.cfg.eventsManager.dispatchEvent('setTaskCompletedFocused' , true);
                }

            });

            this.cfg.eventsManager.registerEvent('taskFinish', function () {
                if (!thi$.finished) {
                    thi$.setEnabled(false);
                    thi$.cfg.eventsManager.dispatchEvent('hideHint');
                    thi$.cfg.eventsManager.dispatchEvent('hideFeedback');
                    thi$.cfg.eventsManager.dispatchEvent('hideBalloon');
                    thi$.cfg.eventsManager.dispatchEvent('hideAttemptsIndicator');
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        visible:thi$.cfg.enableButtonOnDone,
                        enabled:thi$.cfg.enableButtonOnDone
                    });
                    thi$.finished = true;
                }
            });

            this.cfg.eventsManager.registerEvent('onInstructionNarrationStarted', function () {
                thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    enabled:false
                });
            });

            this.cfg.eventsManager.registerEvent('onInstructionNarrationDone', function () {

                thi$.started = true;
                thi$.taskComponentEnabled = true;

                thi$.cfg.eventsManager.dispatchEvent('setTitleEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setAnswerEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('showHintButton');

                // the condition thi$.cfg.progressData.type != "input" was added for opq , when it is in  progress mode input we should not enable the progress button
                if (!thi$.cfg.progressData.autocheck && thi$.cfg.progressData.attempts == 0 && thi$.cfg.progressData.type == "init" ) {
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:true
                    });
                }


            });

        },

        /**
         * Method: setEnabled
         * De/Activates the ui-component.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled:function (flag) {
            if (this.finished) {
	            this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', flag);
	            return;
            }

            if (!this.started && flag) {
                this.cfg.eventsManager.dispatchEvent('setInstructionEnabled', flag);
                this.cfg.eventsManager.dispatchEvent('configTask', {
                    exposed:true
                });
            }

//            this.cfg.eventsManager.dispatchEvent('setInstructionEnabled', flag);

            if (!this.cfg.emphasizedInstruction) {
                this.cfg.eventsManager.dispatchEvent('showHintButton');
            }

            if (flag) {
                if (this.started && !!!this.taskComponentEnabled) {
                    this.cfg.eventsManager.dispatchEvent('setTitleEnabled', true);
                    this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                    this.cfg.eventsManager.dispatchEvent('setAnswerEnabled', true);
                }
            } else {
                this.taskComponentEnabled = false;
                this.cfg.eventsManager.dispatchEvent('setTitleEnabled', false);
                this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', false);
                this.cfg.eventsManager.dispatchEvent('setAnswerEnabled', false);
            }
        }, // End of setEnabled

        isInProgress:function () {
            return this.started && !this.finished;
        },

        getState:function () {
            var state = jQuery('<progress/>');
            jQuery(state).attr('started', !!this.started);
            jQuery(state).attr('finished', !!this.finished);
            jQuery(state).attr('currentMode', this.currentMode);
            jQuery(state).attr('attempt', this.attempt == null ? 'NA' : this.attempt);
            return state;
        },

        setState:function (xml) {
            var jqXml = jQuery(xml);
            if (jqXml.length <= 0) return;
            this.started = jqXml.attr('started') === 'true';
            this.finished = jqXml.attr('finished') === 'true';
            if (jqXml.attr('openedhint') === 'true') {

            }
            if (this.finished) {
                this.cfg.eventsManager.dispatchEvent('hideAttemptsIndicator');
                this.cfg.eventsManager.dispatchEvent('hideHint');
                this.cfg.eventsManager.dispatchEvent('hideFeedback');
            }
            this.currentMode = jqXml.attr('currentMode');
            var attemptStr = jqXml.attr('attempt');
            this.attempt = attemptStr == 'NA' ? null : parseInt(attemptStr);
            this.cfg.eventsManager.dispatchEvent('updateAttemptsIndicator', [this.attempt, attemptStr]);
        },

        getButtonProgressMode:function () {
            return this.cfg.isLastInMission && this.currentMode == 'progress' ? 'done' : this.currentMode;
        }

    }); // End of t2k.core.UiComponent

    function attemptNumberToName(attempt, attempts) {
        //if only one attempt- show feedback of last

        if (attempts === 1) return 'last';

        if (attempt == 1 ) return 'first';
        else if (attempt < attempts) return 'mid';
        else return 'last';
    }

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/progress/Progress.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/progress/AssessableProgress.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.progress.AssessableProgress
     * handles all kind of task's progression
     *
     * Properties:
     *  config - {Object} The progress's configuration.
     */
    t2k.player.task.progress.AssessableProgress = t2k.player.task.progress.Progress.subClass({
        name:"t2k.player.task.progress.AssessableProgress",

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor:function (config) {

            // set config as a member
            this.cfg = config;
            // init members
            this.started = false;
            this.finished = false;
            this.flagEventDispatched = false;
            // init current mode from answer's progress configuration
            if (config.isLastInMission) {
                this.currentMode = 'assessment_done';
            } else {
                this.currentMode = 'assessment_next';
            }

            this.cfg.eventsManager.dispatchEvent('initAssessmentControls');

            // if attempts = 0, the task that handles by this progress is not checkable
            this.attempt = null;

            // config progression button
            this.cfg.eventsManager.dispatchEvent('configButton', {
                //in assessment mode , the Next button should appear when the task is focused
                enabled:false,
                visible:false,
                // set the button mode with the init val from answer progression configuration
                mode:this.currentMode
            });

            // register progression's events
            this.registerEvents();

        }, // End of ctor

        /**
         * registerEvents
         * register progression's events
         *
         * these events are register in the task events manager (see: task/controls/TaskEventManager.js)
         */
        registerEvents: function() {
            var thi$ = this;

            /**
             * event name: setProgressReady
             * if the task doesn't "finish", enable progress button.
             */
            this.cfg.eventsManager.registerEvent('setProgressReady', function () {
                if ( !thi$.finished /* && (thi$.currentMode != "assessment_done") */ ) {
                    if (thi$.started) {
                    	
                    	var enableButton = true ;
                    	var visibleButton = true ;
                    	if( thi$.cfg.isLastInMission && !ENV.viewMode.showLastSequenceTaskButton ) {
                        	enableButton = false ;
                        	visibleButton = false ;
                        }
                    	
                        thi$.cfg.eventsManager.dispatchEvent('configButton', {
                            enabled: enableButton,
                            visible: visibleButton
                        });

                        thi$.cfg.eventsManager.dispatchEvent('onTaskAsAssessmentCompleted');
                    }

                }
            });

            /**
             *  event name: setProgressProgress
             *  checkable progress
             *
             *  @param feedbackMessage
             */
            this.cfg.eventsManager.registerEvent('setProgressProgress', function (feedbackMessage, scoreData) {
            	// set answer non interactive
                thi$.cfg.eventsManager.dispatchEvent('setAnswerInteractable', false);
                
                if( feedbackMessage ) {
                	var showSummaryIcon = true ;
                	thi$.cfg.eventsManager.dispatchEvent( 'showFeedback', [ feedbackMessage, showSummaryIcon ] );
                }

	            if( scoreData ) {
		            thi$.cfg.eventsManager.dispatchEvent( 'showScore', scoreData );
	            }

                if (!thi$.finished && (thi$.currentMode != "assessment_done")) {

                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        mode:thi$.currentMode,
                        enabled:true,
                        visible:true
                    });

                }


            });

            this.cfg.eventsManager.registerEvent('setProgressUnready', function () {
                if (!thi$.finished) {
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:false
                    });

                    thi$.cfg.eventsManager.dispatchEvent('onTaskAsAssessmentUnCompleted');
                }
            });

            this.cfg.eventsManager.registerEvent('setProgressDone', function ( feedbackMessage ) {

                if( feedbackMessage ) {
                	var showSummaryIcon = true ;
                	thi$.cfg.eventsManager.dispatchEvent('showFeedback', [ feedbackMessage, showSummaryIcon ] );
                }
                
                if (!thi$.finished) {
                	
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:true,
                        mode:thi$.currentMode
                    });
                }

            });

            this.cfg.eventsManager.registerEvent('taskFinish', function () {

                //task is basically never finishes

                if (!thi$.finished) {
                    //thi$.setEnabled(false);
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        visible: thi$.cfg.enableButtonOnDone,
                        enabled: thi$.cfg.enableButtonOnDone
                    });
                    //thi$.finished = true;
                }
            });

            this.cfg.eventsManager.registerEvent('onInstructionNarrationStarted', function () {
                thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    enabled:false
                });
            });

            this.cfg.eventsManager.registerEvent('onInstructionNarrationDone', function () {

                thi$.started = true;
                thi$.taskComponentEnabled = true;

                thi$.cfg.eventsManager.dispatchEvent('setTitleEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setAnswerEnabled', true);

                if (!thi$.cfg.progressData.autocheck && thi$.cfg.progressData.attempts == 0) {
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:true
                    });
                }


            });

        },

        /**
         * Method: setEnabled
         * De/Activates the ui-component.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled:function (flag) {
            var thi$ = this;
            if (this.finished) return;
            
            var setButton = true ;
            
            if (!this.started && flag) {
                this.cfg.eventsManager.dispatchEvent('setInstructionEnabled', flag);
                this.cfg.eventsManager.dispatchEvent('configTask', {
                    exposed:true,
                    enabled:true
                });
                
                var enableButton = true ;
            	var visibleButton = true ;
                if( thi$.cfg.isLastInMission && !ENV.viewMode.showLastSequenceTaskButton ) {
                	enableButton = false ;
                	visibleButton = false ;
                }
                setButton = false ;
                thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    mode: thi$.currentMode,
                    enabled: enableButton,
                    visible: visibleButton
                });
            }


//            this.cfg.eventsManager.dispatchEvent('setInstructionEnabled', flag);

            if (!this.cfg.emphasizedInstruction) {
                //this.cfg.eventsManager.dispatchEvent('showHintButton');
            }

            if (flag) {
            	
                if (this.started && !!!this.taskComponentEnabled) {
                    this.cfg.eventsManager.dispatchEvent('setTitleEnabled', true);
                    this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                    this.cfg.eventsManager.dispatchEvent('setAnswerEnabled', true);
                }
                
                setButton && this.cfg.eventsManager.dispatchEvent('configTask', {
                    exposed:true,
                    enabled:true
                });
                
            } else {
            	
            	setButton && thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    mode: thi$.currentMode,
                    enabled: false,
                    visible: false
                });
                
                this.cfg.eventsManager.dispatchEvent('setTitleEnabled', false);
                this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', false);
                this.cfg.eventsManager.dispatchEvent('setAnswerEnabled', false);
            }
        }, // End of setEnabled

        isInProgress: function() {
            return this.started && !this.finished;
        },

        getState:function () {
            var state = jQuery('<progress/>');
            jQuery(state).attr('started', !!this.started);
            jQuery(state).attr('finished', !!this.finished);
            jQuery(state).attr('currentMode', this.currentMode);
            jQuery(state).attr('attempt', this.attempt == null ? 'NA' : this.attempt);
            return state;
        },

        setState:function (xml) {
            var jqXml = jQuery(xml);
            if (jqXml.length <= 0) return;
            this.started = jqXml.attr('started') === 'true';
            this.finished = jqXml.attr('finished') === 'true';
            if (jqXml.attr('openedhint') === 'true') {

            }
            if (this.finished) {
                this.cfg.eventsManager.dispatchEvent('hideAttemptsIndicator');
                this.cfg.eventsManager.dispatchEvent('hideHint');
                this.cfg.eventsManager.dispatchEvent('hideFeedback');
            }
            this.currentMode = jqXml.attr('currentMode');
            var attemptStr = jqXml.attr('attempt');
            this.attempt = attemptStr == 'NA' ? null : parseInt(attemptStr);
            // this.cfg.eventsManager.dispatchEvent('updateAttemptsIndicator', [this.attempt, attemptStr]);
        }

    }); // End of t2k.core.UiComponent

    /*function attemptNumberToName(attempt, attempts) {
     if (attempt == 1) return 'first';
     else if (attempt < attempts) return 'mid';
     else return 'last';
     }*/

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/progress/AssessableProgress.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/progress/ReadOnlyProgress.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.progress.ReadOnlyProgress
     * handles all kind of task's progression
     *
     * Properties:
     *  config - {Object} The progress's configuration.
     */
    t2k.player.task.progress.ReadOnlyProgress = t2k.player.task.progress.Progress.subClass({
        name:"t2k.player.task.progress.ReadOnlyProgress",

        /**
         * Constructor: ctor
         * The constructor
         *
         * Parameters:
         *  config - {Object} Configuration details.
         */
        ctor:function (config) {

            // set config as a member
            this.cfg = config;
            // init members
            this.started = false;
            this.finished = false;
            this.flagEventDispatched = false;
            // init current mode from answer's progress configuration
            this.currentMode = 'progress';

            this.cfg.eventsManager.dispatchEvent('initAssessmentControls');

            // if attempts = 0, the task that handles by this progress is not checkable
            this.attempt = null;

            // config progression button
            this.cfg.eventsManager.dispatchEvent('configButton', {
                //in assessment mode , the Next button should appear when the task is focused
                enabled:false,
                visible:false,
                // set the button mode with the init val from answer progression configuration
                mode:this.currentMode
            });

            // register progression's events
            this.registerEvents();

        }, // End of ctor

        /**
         * registerEvents
         * register progression's events
         *
         * these events are register in the task events manager (see: task/controls/TaskEventManager.js)
         */
        registerEvents: function() {
            var thi$ = this;

            /**
             * event name: setProgressReady
             * if the task doesn't "finish", enable progress button.
             */
            this.cfg.eventsManager.registerEvent('setProgressReady', function () {
                if ( !thi$.finished ) {
                    if (thi$.started) {
                    	
                        thi$.cfg.eventsManager.dispatchEvent('configButton', {
                            enabled:true,
                            visible:true
                        });

                        thi$.cfg.eventsManager.dispatchEvent('onTaskAsAssessmentCompleted');
                    }

                }
            });

            this.cfg.eventsManager.registerEvent('taskFinish', function () {

               return;
            });

            this.cfg.eventsManager.registerEvent('onInstructionNarrationStarted', function () {
                thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    enabled:false
                });
            });

            this.cfg.eventsManager.registerEvent('onInstructionNarrationDone', function () {

                thi$.started = true;
                thi$.taskComponentEnabled = true;

                thi$.cfg.eventsManager.dispatchEvent('setTitleEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                thi$.cfg.eventsManager.dispatchEvent('setAnswerEnabled', true);

                if (!thi$.cfg.progressData.autocheck && thi$.cfg.progressData.attempts == 0) {
                    thi$.cfg.eventsManager.dispatchEvent('configButton', {
                        enabled:true
                    });
                }


            });

        },

        /**
         * Method: setEnabled
         * De/Activates the ui-component.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled:function (flag) {
            var thi$ = this;
            if (this.finished) return;
            
            var setButton = true ;
            
            if (!this.started && flag) {
                this.cfg.eventsManager.dispatchEvent('setInstructionEnabled', flag);
                this.cfg.eventsManager.dispatchEvent('configTask', {
                    exposed:true,
                    enabled:true
                });

            	var enableButton = true ;
            	var visibleButton = true ;
            	if( thi$.cfg.isLastInMission && !ENV.viewMode.showLastSequenceTaskButton ) {
                	enableButton = false ;
                	visibleButton = false ;
                }
                
                setButton = false ;
                thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    mode: thi$.currentMode,
                    enabled: enableButton,
                    visible: visibleButton
                });
            }


//            this.cfg.eventsManager.dispatchEvent('setInstructionEnabled', flag);

            if (!this.cfg.emphasizedInstruction) {
                //this.cfg.eventsManager.dispatchEvent('showHintButton');
            }

            if (flag) {
            	
                if (this.started && !!!this.taskComponentEnabled) {
                    this.cfg.eventsManager.dispatchEvent('setTitleEnabled', true);
                    this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', true);
                    this.cfg.eventsManager.dispatchEvent('setAnswerEnabled', true);
                }
                
                setButton && this.cfg.eventsManager.dispatchEvent('configTask', {
                    exposed:true,
                    enabled:true
                });
                
            } else {
            	
            	setButton && thi$.cfg.eventsManager.dispatchEvent('configButton', {
                    mode: thi$.currentMode,
                    enabled: false,
                    visible: false
                });
                
                this.cfg.eventsManager.dispatchEvent('setTitleEnabled', false);
                this.cfg.eventsManager.dispatchEvent('setQuestionEnabled', false);
                this.cfg.eventsManager.dispatchEvent('setAnswerEnabled', false);
            }
        }, // End of setEnabled

        isInProgress: function() {
            return this.started && !this.finished;
        },

        getState:function () {
            var state = jQuery('<progress/>');
            jQuery(state).attr('started', !!this.started);
            jQuery(state).attr('finished', !!this.finished);
            jQuery(state).attr('currentMode', this.currentMode);
            jQuery(state).attr('attempt', this.attempt == null ? 'NA' : this.attempt);
            return state;
        },

        setState:function (xml) {
            var jqXml = jQuery(xml);
            if (jqXml.length <= 0) return;
            this.started = jqXml.attr('started') === 'true';
            this.finished = jqXml.attr('finished') === 'true';
            if (jqXml.attr('openedhint') === 'true') {

            }
            if (this.finished) {
                this.cfg.eventsManager.dispatchEvent('hideAttemptsIndicator');
                this.cfg.eventsManager.dispatchEvent('hideHint');
                this.cfg.eventsManager.dispatchEvent('hideFeedback');
            }
            this.currentMode = jqXml.attr('currentMode');
            var attemptStr = jqXml.attr('attempt');
            this.attempt = attemptStr == 'NA' ? null : parseInt(attemptStr);
            // this.cfg.eventsManager.dispatchEvent('updateAttemptsIndicator', [this.attempt, attemptStr]);
        }

    }); // End of t2k.core.UiComponent

    /*function attemptNumberToName(attempt, attempts) {
     if (attempt == 1) return 'first';
     else if (attempt < attempts) return 'mid';
     else return 'last';
     }*/

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/progress/ReadOnlyProgress.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/util/ViewModesUtil.js
////////////////////////////////////////
(function () {

	t2k.util.ViewModesUtil = {
			
		defaultSetting: {
				studentFlagTask:false,
				disableSubmitButton:false,
				teacherIndication:false,
//				seqeunceCompletionIndication:false,
				lastTaskFocusing:false,
				showCorrectAnswerButton:false,
				progressClass:t2k.player.task.progress.Progress,
				checkAnswerOnState:false,
				isAssessment:false,
				readOnly:false,
				allExposed:false,
				allowSolveTask: false,
				allowSkipTask: false,
				showEveryTaskBar: false,
				sendTaskAnswerChanges: false,
				preventEmptyAnswer: false,
				enableTaskAnswerOnFocus: false,
				showLastSequenceTaskButton:true,
				activateTaskOnClick: true,
				showMyAnswerButton: false,
				forceUserFinalAttempt: false
		},
		
		modes:{
			
			'NORMAL': {
				student: {
					showMyAnswerButton: true
				},
				teacher: {
					showCorrectAnswerButton: true,
					activateTaskOnClick: true,
					allExposed: true
				}
			},
			
			'RTCM': {
				student: {
					showMyAnswerButton: true
				},
				teacher: {
					showCorrectAnswerButton: true,
					activateTaskOnClick: true,
					allExposed: false
				}
			},
			
			"READ_ONLY": {
				student: {
					readOnly:true,
					progressClass:t2k.player.task.progress.ReadOnlyProgress,
					activateTaskOnClick: false,
					allExposed:true,
					lastTaskFocusing: true
				},
			},
			
			"WORK_OVERVIEW": {
				teacher: {
					allExposed:true,
					forceUserFinalAttempt: true,
					readOnly:true,
					showCorrectAnswerButton:true
				}
			},
			
			'ASSESSMENT_OVERVIEW': {
				teacher: {
					showCorrectAnswerButton:true,
					activateTaskOnClick: true,
					progressClass:t2k.player.task.progress.AssessableProgress,
					isAssessment:true,
					allExposed:true,
					showTaskPoints: true,
					showTaskScore: true,
					showLastSequenceTaskButton: false,
					showEveryTaskBar: true,
					readOnly:true
				}
			},
			
			'ASSESSMENT_RUNTIME': {
				student: {
					/*studentFlagTask:true,*/
//					seqeunceCompletionIndication:true,,
					sendTaskAnswerChanges: true,
					progressClass:t2k.player.task.progress.AssessableProgress,
					isAssessment:true,
					allExposed:true,
					activateTaskOnClick: true,
					showTaskPoints: true,
					preventEmptyAnswer: true,
					enableTaskAnswerOnFocus: true
				}
			},
			
			'ASSESSMENT_REVIEW': {
				student: {
					disableSubmitButton:true,
					showCorrectAnswerButton:true,
					teacherIndication:false,
//					lastTaskFocusing:true,
					progressClass:t2k.player.task.progress.AssessableProgress,
					checkAnswerOnState:true,
					isAssessment:true,
					allExposed:true,
					readOnly:true,
					activateTaskOnClick: true,
					showTaskPoints: true,
					showTaskScore: true,
					showEveryTaskBar: true,
					showLastSequenceTaskButton: false
				}
			}
//			,
//			
//			'ASSESSMENT_TEST_MODE': {
//				student: {
//					studentFlagTask:true,
//					seqeunceCompletionIndication:true,
//					progressClass:t2k.player.task.progress.AssessableProgress,
//					isAssessment:true,
//					allExposed:true
//				}
//			},
//			
//			'ASSESSMENT_TEST_READ_ONLY': {
//				student: {
//					lastTaskFocusing:true,
//					showCorrectAnswerButton:false,
//					progressClass:t2k.player.task.progress.AssessableProgress,
//					checkAnswerOnState:false,
//					isAssessment:true,
//					readOnly:true,
//					allExposed:true
//				}
//			},
//			
//			'REVIEWED': {
//				teacher: {
//					manCheckIndication:true,
//					showCorrectAnswerButton:true,
//					teacherIndication:true,
//					lastTaskFocusing:true,
//					progressClass:t2k.player.task.progress.AssessableProgress,
//					checkAnswerOnState:true,
//					isAssessment:true,
//					allExposed:true,
//					readOnly:true
//				},
//
//				student: {
//					manCheckIndication:true,
//					showCorrectAnswerButton:true,
//					teacherIndication:false,
//					lastTaskFocusing:true,
//					progressClass:t2k.player.task.progress.AssessableProgress,
//					checkAnswerOnState:true,
//					isAssessment:true,
//					allExposed:true,
//					readOnly:true
//				}
//			},
//
//			'ANSWER_VIEW': {
//				teacher: {
//					lastTaskFocusing:true,
//					showCorrectAnswerButton:true,
//					progressClass:t2k.player.task.progress.AssessableProgress,
//					checkAnswerOnState:true,
//					isAssessment:true,
//					readOnly:true,
//					allExposed:true
//				},
//
//				student: {
//					lastTaskFocusing:true,
//					showCorrectAnswerButton:true,
//					progressClass:t2k.player.task.progress.AssessableProgress,
//					checkAnswerOnState:true,
//					isAssessment:true,
//					readOnly:true,
//					allExposed:true
//				}
//			}

		},

		setMode:function (mode, role) {

			// regular as default
			modeName = mode || 'NORMAL' ;
			roleName = role || 'student' ;

			// regular is same thing as NORMAL
			if (modeName === 'regular') modeName = 'NORMAL';
			
			var vmName = role + "_" + mode ;
			
			// merge + override selected mode with defaults
			mergedMode = override(
				this.defaultSetting,
				this.modes[ modeName ][ roleName ],
				{
					_name: vmName
				}
			);

			// set to ENV
			ENV.viewMode = mergedMode ;
		}

	};


})();

var ViewModesUtil = t2k.util.ViewModesUtil;
////////////////////////////////////////
// SRC End --> t2k/util/ViewModesUtil.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/controls/TaskEventManager.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

// add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.controls.TaskEventManager
     * 2d0
     */
    t2k.player.task.controls.TaskEventManager = Object.subClass({

		name: "t2k.player.task.controls.TaskEventManager",

        ctor: function(config) {
            this.eventsMap = {};
        }, // End of ctor

        registerEvent: function(name, callback) {
            this.eventsMap[name] = callback;
        }, // End of registerEvent

        dispatchEvent: function(name, args) {
            var argz = (args instanceof Array) ? args : [args];
            // Dispatch the event or throw an error if an  event with the given name isn't registered.
            if (this.eventsMap[name]) this.eventsMap[name].apply({}, argz);
        }, // End of dispatchEvent

	    dispose: function() {
		    for (var item in this.eventsMap) {
			    delete  this.eventsMap[item];
		    }

		    delete this.eventsMap;
	    }

    }); // End of t2k.player.task.controls.TaskEventManager

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

// add here...

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/controls/TaskEventManager.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/BaseTaskView.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: TEMPLATE
     * The Mustache template used by the tasks's view.
     * 2d0 - Implement Roman's way of managing templates.
     */
    var TEMPLATE =
    	"<div id='{{id}}' class='task {{type}} disabled unexposed_{{navMode}} {{baseClasses}}' >\
	    	<div id='{{id}}_task_numbering' class='task_numbering'/>\
	    	<div id='{{id}}_wrapper_external' class='task_wrapper_external'>\
	    		<div id='{{id}}_top_border' class='task_top_border'/>\
		    	<div id='{{id}}_icon' class='task_icon'>\
    				<div id='{{id}}_icon_content' class='task_icon_content'>\
    					<span id='correct'>8</span><span id='part'>5</span><span id='wrong'>></span>\
    				</div>\
    			</div>\
	    		<div id='{{id}}_wrapper_internal' class='task_wrapper_internal'>\
			        <div id='{{id}}_task_container' class='task_container'>\
				        <div id='{{id}}_header' class='task_header task_section'></div>\
				        <div id='{{id}}_header_separator' class='header_separator'>\
				    		<div id='{{id}}_header_separator_line' class='header_separator_line'></div>\
				    	</div>\
				        <div id='{{id}}_content' class='task_content task_section'></div>\
				        <div id='{{id}}_toolbar_container' class='task_toolbar_container task_section'>\
					        <div id='{{id}}_toolbar' class='task_toolbar'></div>\
						</div>\
				    </div>\
		    	</div>\
	    	</div>\
	    </div>";

	var taskMaskTemplate = "\
    <div id='{{id}}_taskMask' class='taskMask'>\
    </div>\
";

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the task's view to use.
     */
    var defaultConfig = {
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.BaseTaskView
     * The base task view. Contains the place holders for info, questions, content, buttons, etc.
     */
    t2k.player.task.BaseTaskView = t2k.core.View.subClass({

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's view configuration.
         */
        ctor: function(config) {
            // Delegate.
            this._super(override(config, defaultConfig, {content: config.template}));
            
            this.wasCompletedFocused = false;
            
            if( /*AssessmentENV.isNotAssessmentModeTest*/ ENV.viewMode.readOnly ) {
    			this._view.addClass( 'readonly' ) ;
            }

	        if( ENV.viewMode.showEveryTaskBar ) {
		        this._view.addClass( 'showEveryTaskBar' ) ;
	        }

	        this.createMask();
            
            var locationStyle = this.cfg.isLastInSequence ? 'last_task_in_sequence' : 'non_last_task_in_sequence';
            this._view.addClass( locationStyle ) ;

	        if(!!this.cfg.isFirstInSequence) {
		        this._view.addClass('first_task_in_sequence')
	        }
            
        }, // End of ctor

        /**
         * Method: setEnabled
         * De/Activates the view. This method adds/removes the 'disabled' CSS class to the view.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled:function (flag) {
	        this._super(flag);

	        this.toggleMaskDisplay(flag);

	        if (flag) {
		        if (this.wasCompletedFocused) {
			        this.setTaskCompletedFocused(true);
		        }
	        } else {
		        this.setTaskCompletedFocused(false);
	        }
        }, // End of setEnabled

	    toggleMaskDisplay: function(flag) {

		    if (this._taskMask) {
			    if (flag) {
				    this._taskMask.hide();
			    } else {
				    this._taskMask.outerWidth(this._task_container.outerWidth() + 10);
				    this._taskMask.outerHeight(this._task_container.outerHeight() + 10);
				    this._taskMask.css('top', -5 + 'px');
				    this._taskMask.css('left', -5 + 'px');
				    this._taskMask.show();
			    }
		    }

	    },

	    createMask: function() {
		    // Create a task mask if doesn't exist already
		    if (ENV.viewMode.activateTaskOnClick && !this._taskMask) {

			    var objTaskMask = jQuery(Mustache.to_html(taskMaskTemplate, {
				    id:this.cfg.id
			    }));

			    this._task_container.append(objTaskMask);
			    this._taskMask = jQuery('.taskMask', this._task_container);

			    var thi$ = this, pressTimer;

			    function onTaskMaskClick(event) { //on the click on task area make this task enabled
				    event.stopPropagation();

				    var srcIsProgressButton = false;

				    //find out if src element is progress button
				    if (jQuery(event.srcElement).hasClass('progress_button') ||
					    jQuery(event.srcElement).parents('.progress_button').length) {
					    srcIsProgressButton = true;
				    }
				    //if src element is progress button dont do progress
				    if (!thi$.isEnabled() && (!srcIsProgressButton)) {
					    var ignoreScrollToNext = ENV.behaviors.isTablet ;
					    thi$.cfg.sequenceObj.progressToTask( thi$.cfg.taskId, null, null, ignoreScrollToNext ) ;
				    }
			    }

			    //TODO: check for better solution for tapandhold in ipad, currently it doesn't work correctly in phonegap
			    if (ENV.behaviors.isIpad) {
				    this._taskMask.bind({
					    touchend :  function () {
					        clearTimeout(pressTimer);
				        },
					    touchstart : function (event) {
						    // Set timeout
						    pressTimer = window.setTimeout(function () {
							    onTaskMaskClick(event);
						    }, 45);
					    }
				    });

				    //listener to start scroll that removes timeout, and decrease the timeout to 250 ms
				    jQuery(document).bind("scrollstart", function () {
					    if (pressTimer) {
						    clearTimeout(pressTimer);
					    }
				    });

			    } else {
			        this._taskMask.bind('click' , onTaskMaskClick);
			    }

		    }
	    },
        
        /**
         * bindScrollRefreshEvent
         * browser bug - dom elements sometimes doesn't refresh on scroll
         * this function bind the scroll and manual refresh the task's toolbar
         * @param flag
         */
        bindScrollRefreshEvent : function(flag){
        	
        	// ref
        	var thi$ = this;
        	
        	// if flag, that means the task in on setEnabled = true && !dummyMode
        	if (flag){
        		// find the sequence dom element and bind the refresh fnc
        		this._view.parents('.sequence_content_scrollable').scroll(function(){
        			// prevent refresh duplication
        			if (!thi$.refreshDisable){
        				
        				thi$.refreshDisable = true;
        				
        				// fade to 0.99 and after 100ms fade to 1 and after 100ms, allow refreshing again
        				thi$._view.find('.task_toolbar').fadeTo(100, 0.99, function(){
        					thi$._view.find('.task_toolbar').fadeTo(100, 1, function(){
        						thi$.refreshDisable = false;
        					});
        				});
        				
        			}
        		});
        		
        	} else {
        		// on flag false, unbind the scroll event
        		this._view.parents('.sequence_content_scrollable').unbind('scroll');
        		
        	}
        },
        
        setExposed:function (flag) {
        	var unexpClass = 'unexposed_' + this.cfg.navMode ;
            var expClass = 'exposed';

        	if(flag){
        		this._view.removeClass(unexpClass);
                this._view.addClass(expClass);
             }else{
            	this._view.removeClass(expClass);
                this._view.addClass(unexpClass);
             }

        },

	    setTaskCompletedFocused:function (flag) {
		    if (flag) {
			    this._view.addClass('completed_focused');
			    this.wasCompletedFocused = true;
		    } else {
			    this._view.removeClass('completed_focused');
		    }
	    },

        setFinished:function (flag) {
        	flag && !this.cfg.isLastInSequence ? this._view.addClass('completed') : this._view.removeClass('completed');
        },
		
		setTaskNumbering:function (num) {
			var indexDiv = this._task_numbering ;

			if (num) {
				indexDiv.append(num);
			} else {
				var icon = jQuery('<div class="task_numbering_icon"><span>@</span></div>').appendTo(indexDiv);
				jQuery(icon).addClass('none_indexed');
			}
		},
		
		setToolbarReduction: function () {
			if (this._feedback) {
				var toolbarWidth = this._toolbar.width();
				if (toolbarWidth < 500) { // reduce feedback and hint labels
	            	this._feedback.find('.task_feedback_title').remove();
	            	this._hint.find('.task_hint_title').remove();
	            	// add tooltips
	            	this._feedback.find('.task_feedback_icon').attr('title', this.feedbackLabel);
	            	this._hint.find('.task_hint_icon').attr('title', this.hintLabel);
				}
				if (toolbarWidth < 440) { // reduce progress button
					this.cfg.task.button.setReduced(true);
				}
			}

		},
        
        hideHeader: function() {
        	this._header.addClass( 'hidden' ) ;
        	this._header_separator.addClass( 'hidden' ) ;
        },
        
        setIconContent: function( iconStyle, flag ) {
        	
        	if( flag ) {
        		if( this.currentIconStyle ) {
        			this._icon.removeClass( this.currentIconStyle ) ;
        		}
        		this._icon.addClass( iconStyle ) ;
        	} else {
        		this._icon.removeClass( iconStyle ) ;
        	}
        	
        	this.currentIconStyle = flag ? iconStyle : null ;
        	
        	this.updateIconContentWidth() ;
        },
        
        updateIconContentWidth: function() {
        	var iconWidth = this._icon.outerWidth() ;
        	var maxWidth = this._wrapper_internal.innerWidth() ;
        	this._top_border.width( maxWidth - iconWidth ) ;
        	/* Need to move the icon to middle of boder, not working yet
        	var margin = this._top_border.css('margin-left').px2int() + this._top_border.css('margin-right').px2int();
        	this._icon.css('left',maxWidth - margin - iconWidth);
        	*/ 
        }

    }); // End of t2k.player.task.BaseTaskView

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/BaseTaskView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/BaseTask.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

// add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.BaseTask
     * The superclass of all tasks. Contains common properties and functionality.
     */
    t2k.player.task.BaseTask = t2k.core.FlowPresenter.subClass({

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The task's configuration.
         */
        ctor:function (config) {
            // Closure refs.
            var thi$ = this;

            // Delegate
            this._super(copy(config, { task:thi$ }, parseXML(config.data)));

	        if(this.cfg.data.attributes["sha1"]) {
				this.cfg.sha1 = this.cfg.data.attributes["sha1"].value;
	        }

            this.msgAttempt = 'first';
            this.firstEnabled = true;
            this.lastFbState;
            this.lastHintState;
            
            this.isAnswered = false ;
//            this.rubricPath = config.sequenceConfigPath + '/' + config.taskId;
            //this.sequenceConfigPath = config.sequenceConfigPath;

            // Create the view
            this.view = this.createView(this.cfg);
            
            this.setTaskToolBarReductionStep();

            // Create the events manager
            this.eventsManager = new t2k.player.task.controls.TaskEventManager({});

            this.registerEvents();
            this.registerCheckableEvents();

            if (/*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment) {
                this.registerAssessmentEvents();
            }

            // Initialize th components.
            this.initTaskComponents();

            // Create the progress handler
            var progressClass;
            /*if (AssessmentENV.isAssessmentMode) {
             progressClass = t2k.player.task.progress.AssessableProgress;
             } else {
             progressClass = t2k.player.task.progress.Progress;
             }*/

            progressClass = ENV.viewMode.progressClass;

            this.progressHandler = new progressClass({
	            eventsManager:this.eventsManager,
	            emphasizedInstruction:(this.instruction) ? this.instruction.cfg.emphasized : false,
	            defaultProgressConfig:this.answer.defaultProgressConfig,
	            progressData:this.progressData,
                enableButtonOnDone:this.cfg.isLastInSequence,
	            isLastInMission:this.cfg.isLastInMission,
	            checkingType:this.getTaskCheckingType()
            });
            

            if( this.cfg.calledFromCompile ) {
            	this.calcTaskHeight();
//            	return ;
            }

            // We have a layout state.
            this.layoutState = null;
            
        }, // End of ctor

	    dispose : function() {
		    !!this.attemptIndicator && this.attemptIndicator.dispose();
		    delete this.attemptIndicator;

		    !!this.button && this.button.dispose();
		    delete this.button;

		    !!this.correctAnswerButton && this.correctAnswerButton.dispose();
		    delete this.correctAnswerButton;

		    !!this.feedbackButton && this.feedbackButton.dispose();
		    delete this.feedbackButton;

		    !!this.hintButton && this.hintButton.dispose();
		    delete this.hintButton;

		    !!this.help && this.help.dispose();
		    delete this.help;

		    !!this.tasktitle && this.tasktitle.dispose();
		    delete this.tasktitle;

		    !!this.question && this.question.dispose();
		    delete this.question;

		    !!this.answer && this.answer.dispose();
		    delete this.answer;

		    !!this.eventsManager && this.eventsManager.dispose();
			delete this.eventsManager;

		    this._super();
	    },
        
        calcTaskHeight : function(){
        	
//        	var compileTaskHeight = CompilerUtils.compileTaskHeight(this.view._content.width(), jQuery(this.cfg.data));
//        	var realTaskHeight    = this.view._content.height();
//        	
//        	console.log('compiler task height: ' + compileTaskHeight);
//        	console.log('----real task height: ' + realTaskHeight);
        	
        },
        
        registerEvents:function () {
            var thi$ = this;
            this.eventsManager.registerEvent('configTask', function (cfg) {
                if (cfg.exposed != undefined) {
                    thi$.exposed = cfg.exposed;
                    thi$.view.setExposed(cfg.exposed);
                }
            });

            this.eventsManager.registerEvent('setTaskCompletedFocused', function (flag) {
                thi$.view.setTaskCompletedFocused(flag);
            });
            
            this.eventsManager.registerEvent( 'finishedAllAttempts', function () {
            	thi$.answer.getAsyncState( function( state ) {
            		thi$.finalAttemptAnswerState = state ;
            	} ) ;
            });

            this.eventsManager.registerEvent('configButton', function (cfg) {
                if (cfg.mode != undefined) thi$.button.setMode(cfg.mode);
                if (cfg.enabled != undefined) thi$.button.setEnabled(cfg.enabled);
                if (cfg.visible != undefined) thi$.button.setVisible(cfg.visible);
                // TODO: set text
            });

            this.eventsManager.registerEvent('setInstructionEnabled', function (flag) {
                if (thi$.instruction) thi$.instruction.setEnabled(flag);
                else {
                    thi$.eventsManager.dispatchEvent('onInstructionNarrationDone');
                }
            });

            this.eventsManager.registerEvent('setButtonPrevEnabledState', function () {
                thi$.button.setPrevEnabledState();
            });

            this.eventsManager.registerEvent('hideBalloon', function () {
                t2k.util.balloon.close();
            });

            this.eventsManager.registerEvent('hideHint', function () {
                thi$.hintButton.setVisible(false);
            });

            this.eventsManager.registerEvent('showHintButton', function () {
                var message = thi$.getHintMessage();
                if (message) {
                    thi$.hintButton.setMessage({
                        data:message
                    });
                    thi$.hintButton.setVisible(true);
                }
            });

            this.eventsManager.registerEvent('showHint', function () {
                var message = thi$.getHintMessage();

                if (message) {

                    thi$.hintButton.displayBalloonMessage({
                        data:message
                    });
                }
            });

            this.eventsManager.registerEvent('logProgressEvent', function (eventType, checkData) {
            	
            	if( checkData ) {
            		
            		thi$.currentAttempt = checkData.currentAttempt ;
            		
            		if( checkData.checkedValue == t2k.util.FeedbackUtils.TYPE_ALL_CORRECT ) {
            			thi$.result = 100 ;
            		} else if( checkData.checkedValue == t2k.util.FeedbackUtils.TYPE_ALL_INCORRECT ) {
            			thi$.result = 0 ;
            		} else {
            			thi$.result = 50 ;
            		}
            		
            	}
            	
            	
//                ENV.logEventsService.sendLoggingEvent(eventType, thi$.cfg.taskId, checkData);
            });

            this.eventsManager.registerEvent('setTitleEnabled', function (flag) {
                if (thi$.tasktitle) thi$.tasktitle.setEnabled(flag);
            });

            this.eventsManager.registerEvent('setQuestionEnabled', function (flag) {
                if (thi$.question) {
                    thi$.question.setEnabled(flag);
                }
            });

            this.eventsManager.registerEvent('setAnswerEnabled', function (flag) {
                thi$.answer.setEnabled(flag);
            });

            this.eventsManager.registerEvent('setAnswerInteractable', function (flag) {
                thi$.answer.setInteractable(flag);
            });
        },

        registerCheckableEvents:function () {
            var thi$ = this;


            this.eventsManager.registerEvent('initCheckableToolbar', function () {
                thi$.attemptIndicator = new t2k.player.task.controls.AttemptsIndicator(copy({}, {
                    attempts:	thi$.progressData.attempts,
                    isReduced:	thi$.cfg.taskToolBarReductionStep==2?true:false,
                    parent:		thi$.view._toolbar
                }));
            });

            this.eventsManager.registerEvent('updateAttemptsIndicator', function (attempt, msgAttempt) {
                if (thi$.attemptIndicator) {
                    thi$.msgAttempt = msgAttempt;
                    thi$.attemptIndicator.setCurrentAttempt(attempt);
                }
            });

            this.eventsManager.registerEvent('hideAttemptsIndicator', function () {
                if (thi$.attemptIndicator) thi$.attemptIndicator.setVisible(false);
            });

	        this.eventsManager.registerEvent('showScore', function ( scoreData ) {
		        if( thi$.pointsIndicator && !thi$.lockScore ) {
		        	var correctPoints = thi$.progressData.points * scoreData.correctRatio ;
		        	thi$.setTaskPoints( correctPoints ) ;
		        }
	        });

            this.eventsManager.registerEvent('showFeedback', function (feedbackMessage, showSummaryIcon, msgAttempt) {

                thi$.feedbackData = feedbackMessage.data;
                if (showSummaryIcon) {
                    thi$.setIcon(thi$.feedbackData.icon, true);
                }


                var fbUtil = t2k.util.FeedbackUtils;
                if (/*AssessmentENV.isNotAssessmentModeTest*/ENV.viewMode.showCorrectAnswerButton && thi$.correctAnswerButton) {
                    // hide correct answer button when correct in assessment none test
                    var showCorrect = /*AssessmentENV.isNotAssessmentModeTest*/ ENV.viewMode.showCorrectAnswerButton &&
                        thi$.correctAnswerButton &&
                        thi$.feedbackData.type == fbUtil.TYPE_ALL_CORRECT;

                    thi$.correctAnswerButton.setVisible(!showCorrect);
                }

                if (thi$.progressData.fbMessages) {
                    var fbMessages = thi$.progressData.fbMessages;
                    
                    var message = null, msgError = false;

	                //generic/advanced feedback by feedback type (allCorrect/partCorrect/allIncorrect) at the specific attempt
	                if(!!fbMessages[feedbackMessage.data.type]) {
	                    message = fbMessages[feedbackMessage.data.type][msgAttempt];
	                }
	             
	                if(!message) {
		                msgError = true;
	                }

                    if (msgError) {
                        var msg =
                            'FEEDBACK MISSING [ --> ' + feedbackMessage.data.type
                                + ' --> ' + msgAttempt + ' ]';
                        console.log(msg);
                        console.log('FEEDBACK FALL BACK TO: allIncorrect');
                        var fbUtil = t2k.util.FeedbackUtils;
                        feedbackMessage.data.type = fbUtil.TYPE_ALL_INCORRECT;
                    }

                    thi$.feedbackButton.setVisible(true);
                    thi$.feedbackButton.displayBalloonMessage({
                        data:message,
                        icon:'feedbackIcon_' + feedbackMessage.data.icon,
                        autoplay:ENV.autoplayFeedbackNarration
                    });
                }
            });

            this.eventsManager.registerEvent('hideFeedback', function () {
                if (thi$.feedbackButton) thi$.feedbackButton.setVisible(false);
            });
        },

        registerAssessmentEvents:function () {
            var thi$ = this;

            this.eventsManager.registerEvent('initAssessmentControls', function () {

                if (/*AssessmentENV.isAssessmentModeReview*/ ENV.viewMode.teacherIndication && (thi$.getTaskCheckingType() == "MANUAL")) {
                    thi$.setIcon('mark', !!thi$.cfg.teacherIndication);
                }

                if (/*AssessmentENV.isAssessmentModeTest*/ENV.viewMode.studentFlagTask) {

                    thi$.studentFlagButton = new t2k.component.buttons.ToggleButton({
                        style:'student_flag',
                        states:{
                            flag:{
//							title: 'flag'
                            }
                        },
                        currMode:'flag',
                        toggle:true,
                        parent:thi$.view._icon,
                        onRendered:function () {
                        },

                        clickCallback:function (toggled) {
                            thi$.dispatchEvent('onTaskAssessmentFlag', [thi$, toggled]);
                        }
                    });

                    thi$.setIcon('flag', true);

                    thi$.studentFlagButton.setEnabled(true);
                }

	            if (ENV.viewMode.showTaskPoints) {
		            thi$.pointsIndicator = new t2k.player.task.controls.PointsIndicator(copy({}, {
			            points:	thi$.progressData.points,
			            isReduced:	thi$.cfg.taskToolBarReductionStep==2?true:false,
			            parent:		thi$.view._toolbar
		            }));
		            
		            if( thi$.setDelayedPoints ) {
		            	thi$.setTaskPoints( thi$.pointsToSetLater ) ;
		            	thi$.setDelayedPoints = false ;
		            	thi$.lockScore = thi$.setDelayedLockScore ;
		            }
	            }

            });

            if ( ENV.viewMode.sendTaskAnswerChanges /*AssessmentENV.isAssessmentModeTest*/ /*ENV.viewMode.seqeunceCompletionIndication*/) {
                this.eventsManager.registerEvent('onTaskAsAssessmentCompleted', function () {
                    if (thi$.getTaskCheckingType() != "EXPOSURE") {
                    	thi$.isAnswered = true ;
//                  	thi$.dispatchEvent('onTaskAsAssessmentCompleted', thi$);
                    }

                });

                this.eventsManager.registerEvent('onTaskAsAssessmentUnCompleted', function () {
                    if (thi$.getTaskCheckingType() != "EXPOSURE") {
                    	thi$.isAnswered = false ;
//                  	thi$.dispatchEvent('onTaskAsAssessmentUnCompleted', thi$);
                    }

                });
            }

        },

        createView:function (cfg) {
            return new t2k.player.task.BaseTaskView(cfg);
        },
        setTaskToolBarReductionStep:function () {
            var toolbarWidth = this.view._toolbar.width();
            this.cfg.taskToolBarReductionStep = 0;
            if (toolbarWidth < 500) { // reduction step1
            	this.cfg.taskToolBarReductionStep = 1;
            }
            if (toolbarWidth < 400) { // reduction step2
            	this.cfg.taskToolBarReductionStep = 2;
            }
        },

        initTaskComponents:function () {

            var thi$ = this;

            // Extract the data XML into a map (element name -> element)
            var elementsMap = this.cfg.elementsMap;

            this.answerRendered = false;
            this.questionRendered = true;

            var title = elementsMap.tasktitle;
            if (title) {
                this.tasktitle = new t2k.component.text.Title({
                    parent:this.view._header, data:title, onRendered:function () {
                    } });
            }

            var question = elementsMap.question;
            if (question) {
                this.questionRendered = false;
                this.question = new t2k.component.text.Question({
                    parent:this.view._content,
                    data:question,
                    // init question with dummyMode (Boolean)
                    dummyMode:this.cfg.calledFromCompile,

                    onRendered:function () {
                        thi$.questionRendered = true;
                        if (thi$.answerRendered) {
                            thi$.dispatchEvent('onTaskRendered', thi$);
                        }
                    }
                });
            }

            // ===================================================================
            // answer ============================================================

            var answerClass = getAnswerClass(this.cfg.type);
            var answer = elementsMap.answer;

            // duplicate elementsMap
            var elementsMapCopy = copy({}, elementsMap);

            // delete title, question and answer data from the duplicated data
            delete elementsMapCopy.tasktitle;
            delete elementsMapCopy.question;
            delete elementsMapCopy.answer;

            // init cfg
            var cfg = {
	                    parent: this.view._content,
		                data:   answer,
		                eventsManager:this.eventsManager,
		                rubric: this.cfg.rubric,
		                sha1:   this.cfg.sha1
	                   };

            // add elements map data to cfg. convention: progessData = [progress data xml obj]
            var child;
            for (child in elementsMapCopy) {
                cfg[child + 'Data'] = elementsMapCopy[child];
            }

            // init answer
            thi$.answer = new answerClass(merge(cfg, {
                // init answer with dummyMode (Boolean)
                dummyMode:this.cfg.calledFromCompile,

                onRendered:function () {
                    thi$.answerRendered = true; 
                    if (thi$.questionRendered) {
                        thi$.dispatchEvent('onTaskRendered', thi$);
                    }
                },
                autocheck:extractAutoCheck(elementsMap.progress, ENV.defaultTaskProgress, null),
                eventsManager:thi$.eventsManager
            }));

            // answer end ========================================================
            // ===================================================================

            // Progress UI elements.
            // ~~~~~~~~~~~~~~~~~~~~
            this.progressData = parseProgressData(thi$.answer.defaultProgressConfig, elementsMap.progress);
            
            this.answer.updateProgressData( this.progressData ) ;
            
            // Instruction
            var helpData = extractHelp(elementsMap.progress);
            var instructionData = extractInstruction(elementsMap.progress, this.answer.defaultProgressConfig);
            if (instructionData) {
                this.instruction = new t2k.player.task.controls.Instruction(copy(instructionData, {
                    parent:this.view._header,
                    eventsManager:this.eventsManager,
                    hasHelp:!!helpData,
                    onRendered:function () {
                    },
                    // init instructions with dummyMode (Boolean)
                    dummyMode:this.cfg.calledFromCompile
                }));
            } else if (!this.tasktitle) {
                this.view.hideHeader();
            }
            if (helpData) {
                this.help = new t2k.player.task.controls.TaskHelp(copy(helpData, {
                    parent:this.getHelpParent(),
	                sequenceObj:this.cfg.sequenceObj
                }));
            }

            // Init
            this.initToolbar(this.progressData);

            var callback = thi$.cfg.readyCallback;
            if (callback) {
                callback(thi$, this.view);
            }

            this.setTaskNumbering(this.view);
        },

        getHelpParent:function () {
            return this.view._task_numbering;
        },

        setIcon:function (icon, flag) {
            this.view.setIconContent(icon, flag);
        },

        initToolbar:function (progressData) {
            var thi$ = this;

//          this.view.hideExistingToolbarContent();

            this.initButton(progressData);

            this.initToggleAnswerButton();

            var isReduced = false;
            if(this.cfg.taskToolBarReductionStep)
            	isReduced = true;

            if (this.cfg.taskToolBarReductionStep == 2) { // reduce progress button
            	this.button.setReduced(true);
            }

	        var elem_viewport = jQuery('.sequence_content_scrollable')[0];
            
            this.feedbackButton = new t2k.player.task.controls.BalloonButton({
                mode:'feedback',
                viewport:elem_viewport,
                constraint:thi$.cfg.parent,
                label:thi$.progressData.fbLabel,
                parent:thi$.view._toolbar,
                onRendered:function () {
                },
                isReduced:isReduced
            });
            this.feedbackButton.setVisible(false);

            this.hintButton = new t2k.player.task.controls.BalloonButton({
                mode:'hint',
                setSrcAtStart : true,
                viewport:elem_viewport,
                constraint:thi$.cfg.parent,
                label:progressData.hintLabel,
                parent:thi$.view._toolbar,
                onRendered:function () {
                },
                isReduced:isReduced
            });
            this.hintButton.setVisible(false);
           
        },

	    initToggleAnswerButton: function() {
		    var isSolvableTask = this.getTaskCheckingType() == "AUTOMATIC" || this.answer.isCheckable() ;
		    
		    if( isSolvableTask ) {

		    	var thi$ = this;
		    	
		    	if ( ENV.viewMode.showCorrectAnswerButton ) {
		    		thi$.correctAnswerButton = new t2k.component.buttons.PushButton({
		    			style:'show_correct_answer',
		    			states:{
		    				normal:{
		    					title: LanguageUtil.strings.task.progress.labels.solvetask
		    				}
		    			},
		    			currMode:'normal',
		    			parent:thi$.view._toolbar,
		    			onRendered:function () {
		    			},
		    			pushCallback:function () {
		    				thi$.eventsManager.dispatchEvent('onCorrectAnswerShow');
		    			},
		    			releaseCallback:function () {
		    				thi$.eventsManager.dispatchEvent('onCorrectAnswerHide');
		    			}
		    		});
		    		
		    		thi$.correctAnswerButton.setEnabled(true);
		    		
		    	}
		    	
		    	if ( ENV.viewMode.showMyAnswerButton ) {
		    		thi$.myAnswerButton = new t2k.component.buttons.PushButton({
		    			style:'show_correct_answer',
		    			states:{
		    				normal:{
		    					title: LanguageUtil.strings.task.progress.labels.myanswer
		    				}
		    			},
		    			currMode:'normal',
		    			parent:thi$.view._toolbar,
		    			onRendered:function () {
		    			},
		    			pushCallback:function () {
		    				thi$.eventsManager.dispatchEvent('onMyAnswerShow');
		    			},
		    			releaseCallback:function () {
		    				thi$.eventsManager.dispatchEvent('onMyAnswerHide');
		    			}
		    		});
		    		
		    		thi$.myAnswerButton.setEnabled(false);
		    		thi$.myAnswerButton.setVisible(false);
		    		
		    	}
		    }
	    },

        initTeacherMenu:function () {

            var thi$ = this;

            var teacherMenuItems = [];

            if (ENV.viewMode.allowSkipTask) {

                teacherMenuItems.push({
                    lable:'skiptask',
                    fnc:function () {
                        thi$.teacherMenu.hideItem('skiptask');
                        thi$.dispatchEvent('onNextTask');
                    }
                });

            }

            var isSolvableTask = this.getTaskCheckingType() == "AUTOMATIC";

            if (ENV.viewMode.allowSolveTask && isSolvableTask) {

                teacherMenuItems.push({
                    lable:'solvetask',
                    fnc:function () {
                        thi$.teacherMenu.toggleDropdownContent('restarttask', 'solvetask');
                        thi$.answer.onShowCorrectAnswer();
                    }
                });

                teacherMenuItems.push({
                    lable:'restarttask',
                    initHide:true,
                    fnc:function () {
                        thi$.teacherMenu.toggleDropdownContent('solvetask', 'restarttask');
                        thi$.answer.onHideCorrectAnswer();
                    }
                });

            }

            if (teacherMenuItems.length > 0) {

                this.teacherMenu = new t2k.player.task.controls.TeacherMenu({
                    parent:thi$.view._toolbar,
                    data:teacherMenuItems
                });

            }
        },

        initButton:function (progressData) {
            // Extract the buttons configuration.
            this.button = new t2k.component.buttons.ProgressButton(
                copy(progressData.buttonModes, { style:'progress_button', parent:this.view._toolbar, onRendered:function () {
                } })
            );

            // Init the buttons events
            this.initButtonEvents();
        },

        initButtonEvents:function () {
            var thi$ = this;

            var endOfTaskFunc = function () {
                thi$.eventsManager.dispatchEvent('taskFinish');
                thi$.dispatchEvent('onNextTask');
            };


            this.button.setClickHandler('progress', endOfTaskFunc);
            this.button.setClickHandler('done', endOfTaskFunc);

            this.button.setClickHandler('check', function () {
                thi$.eventsManager.dispatchEvent('onAnswerCheck');
            });
            this.button.setClickHandler('tryagain', function () {
                thi$.eventsManager.dispatchEvent('onAnswerTryAgain');
            });
            this.button.setClickHandler('showanswer', function () {
                thi$.eventsManager.dispatchEvent('onAnswerShowAnswer');
            });

            this.button.setClickHandler('assessment_next', function () {
                //thi$.eventsManager.dispatchEvent('onNext');
                //alert("onNext");
                if (thi$.getTaskCheckingType() == "EXPOSURE") {
//                    thi$.dispatchEvent('onTaskAsAssessmentCompleted', thi$);

                }

	            //on last task in sequence unbind task mask events after first click on the next button
	            //to prevent multiply clicking
                if(!!thi$.cfg.isLastInSequence) {
	                thi$.view._taskMask.unbind();
                }

                thi$.eventsManager.dispatchEvent('taskFinish');
                thi$.dispatchEvent('onNextTask');
            });

            this.button.setClickHandler('assessment_done', function () {
                if (thi$.getTaskCheckingType() == "EXPOSURE") {
//                    thi$.dispatchEvent('onTaskAsAssessmentCompleted', thi$);
                }

                ENV.host.onDone();
            });
        },

        getHintMessage:function () {
	        var message;
	        if (this.progressData.hintMessages) {
		        //get hint message by attempt number
		        message = this.progressData.hintMessages[ this.currentAttempt ];

		        if (!message) { //get hint message by attempt position (first/middle/last)
			        message = this.progressData.hintMessages[ this.msgAttempt ];
		        }
	        }
	        return message;
        },

        /**
         * Method: setEnabled
         * De/Activates the view. This method adds/removes the 'disabled' CSS class to the view.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled:function (flag) {
            
            this.isInFocus = flag;

            if (this.loadingState) {
                this.view.setEnabled(flag);
                return;
            }
            this._super(flag);
//            var loadIntermediateState = flag && this.progressHandler.isInProgress() && !this.firstEnabled;
            this.progressHandler.setEnabled(flag);
            
            if( this.answer && ENV.viewMode.enableTaskAnswerOnFocus ) {
            	this.answer.setEnabled( flag ) ;
            }
            
//            if (loadIntermediateState) {
//                this.loadInterMediateState();
//            } else {
                //this code is to deal with components that needs to get their state after the screen is rendered
                if (!!this.lastFbState || !!this.lastHintState) {
                    this.setLateBloomersState();
                }
//            }

            if (flag)
                this.firstEnabled = false;

            // on enabled true and on !dummyMode, bind scroll event to refresh toolbar
            //this.view.bindScrollRefreshEvent(flag && !this.cfg.calledFromCompile);

        }, // End of setEnabled

        setSaveStateProperty: function(needToSaveState){
            this.needToSaveState = needToSaveState;
        },

        setLateBloomersState:function () {
            if (this.hintButton && this.lastHintState.length) this.hintButton.setState(this.lastHintState);
            if (this.feedbackButton && this.lastFbState.length) this.feedbackButton.setState(this.lastFbState);

	        //set state of feedback icon
	        if (this.lastTaskIconStyle) this.setIcon(this.lastTaskIconStyle, true);
        },

        setExposed:function (flag) {
            this.exposed = flag;
            this.view.setExposed(flag);
        },

        setFinished:function (flag) {
            this.finish3d = flag;
            this.view.setFinished(flag);
            this.eventsManager.dispatchEvent('taskFinish');
        },

        isFinished:function () {
            return this.finish3d;
        },


        //assessment
        isAssessable:function () {
            return this.isAnswerAssessable();
        },

        getRubricPath:function () {
            return this.cfg.rubric ? this.cfg.rubric.id : null ;
        },


        isAnswerAssessable:function () {
            if (!!this.answer) {
                return this.answer.isAssessable() ;
            } else {
                return false ;
            }
        },

        getAnswerAssessmentScore:function () {
            return this.answer.assessmentScore();
        },

        progress:function () {
            return true;
        },

        onNextTask:function (callback) {
            this.registerEvent("onNextTask", callback);
        },

        setTaskNumbering:function (view) {
            var indexLabel = this.cfg.indexLabel;

            view.setTaskNumbering(indexLabel);
        },

        getState:function () {
            if(this.isInFocus || this.needToSaveState || !this.initiaState){
                   
                var state = Perf.create('task');
                state.attr('enabled', (!!this.isEnabled() || !!this.view.isEnabled()));
                state.attr('exposed', !!this.exposed);
                state.attr('answered', !!this.isAnswered);
                var progressState = this.progressHandler.getState();
                state.append(progressState);

                if (!!this.question) {
                    var questState = this.question.getState() ;
                    if ( !!questState ) {
                        state.append( questState.clone() ) ;
                    }
                }
                
                var ansState = this.answer.getState() ;
                if (!!ansState) {
                    state.append(ansState.clone());
                }
                
                if ( this.finalAttemptAnswerState ) {
                	var answerFinalAttempt = Perf.create('answerfinalattempt');
                	answerFinalAttempt.html( this.finalAttemptAnswerState.html() ) ;
                	state.append( answerFinalAttempt );
                }

                state.append(this.button.getState());
                if (this.hintButton) state.append(this.hintButton.getState());
                if (this.feedbackButton) state.append(this.feedbackButton.getState());

                if(this.view.currentIconStyle) {
                    state.attr('iconstyle', this.view.currentIconStyle);
                }
                this.initiaState = state;
            }
            
            return this.initiaState;
                
        },

        setState:function (xml, forceEnabledTrue) {
            this.initiaState = xml;
            //when we load with regular state we want to cancel old intermediate state that were saved
            //so we are back to firstEnabled true
//            if(!!!intermediate){
                this.firstEnabled = true;
//            }
            this._super(xml);
            var jqXml = jQuery(xml);
            this.loadingState = true;

            //moved to sequen
            // Read Only - prevent more than one enabled task in assessment
            /* if (AssessmentENV.isNotAssessmentModeTest) {
             jqXml.attr('enabled', 'false');
             }*/

            this.setEnabled(jqXml.attr('enabled') === 'true' || forceEnabledTrue);
            this.loadingState = false;
            this.setExposed(jqXml.attr('exposed') === 'true');

            this.isAnswered = jqXml.attr('answered') == "true" ;

            this.progressHandler.setState(jqXml.find('progress'));

            if (this.question) {
                this.question.setState(jqXml.find('question'));
            }
            
            if( xml ) {
            	var answerKey = this.cfg.type + 'answer'
            	this.finalAttemptAnswerState = jqXml.find( "answerfinalattempt" ) ;
            	
            	var hasFinalAttemptState = ((this.finalAttemptAnswerState.length > 0) && (!!this.finalAttemptAnswerState.children().length)) ;
            	if( hasFinalAttemptState ) {
            		this.answer.storeFinalAttemptState( this.finalAttemptAnswerState ) ;
            		if( ENV.viewMode.showMyAnswerButton && this.myAnswerButton) {
	            		 this.myAnswerButton.setEnabled( true ) ;
	            		 this.myAnswerButton.setVisible( true ) ;
            		}
            	}
            	
            	if( ENV.viewMode.forceUserFinalAttempt && hasFinalAttemptState ) {
            		this.answer.setState( this.finalAttemptAnswerState ) ;
            	} else {
            		this.answer.setState( jqXml.find( answerKey ) ) ;
            	}
            }
            
            if( !( this.cfg.isLastInMission && !ENV.viewMode.showLastSequenceTaskButton ) ) {
            	this.button.setState(jqXml.find('button'));
            }
            
            if (this.hintButton) this.hintButton.setState(jqXml.find('hint'));
            if (this.feedbackButton) this.feedbackButton.setState(jqXml.find('feedback'));

            this.lastFbState = jqXml.find('feedback');
            this.lastHintState = jqXml.find('hint');
	        this.lastTaskIconStyle = jqXml.attr('iconstyle');

            //this.firstEnabled = false;
        },

//        getStaticData:function (index) {
//            var cfg = this.cfg;
//            var id = jQuery(cfg.data).attr('id');
//            var attempts = 0;
//            attempts = attempts > 0 ? attempts : 0;
//            
//            var outType = outTypeMap[ this.cfg.type ] || this.cfg.type ;
//            
//            return '<Atom>' +
//                '<atomId>' + id + '</atomId>' +
//                '<atomName>' + id + '</atomName>' +
//                '<atomIndex>' + index + '</atomIndex>' +
//                '<allowedAttempts>' + attempts + '</allowedAttempts>' +
//                '<templateName>' + cfg.outType + '</templateName>' +
//                '<checkingType>' + 'TODO' + '</checkingType>' +
//                '<rubricId>' + id + '</rubricId>' +
//                '</Atom>';
//        },	

        getTaskCheckingType:function () {

            var type = TaskCheckingType[ this.cfg.type ];

            if(type == "AUTOMATIC_MANUAL"){
                var checkble = jQuery(this.cfg.data).find('answer')[0].attributes.getNamedItem('checkable').value;
                type = checkble.toLowerCase() =="false" ?  "MANUAL" : "AUTOMATIC";                
            }


            if (!!!type) {
                type = TaskCheckingType[ 'defaultValue' ];
            }

            return type;
        },

        getIgnoreScroll:function () {
            return this.cfg.ignoreScroll;
        },
        getIgnoreSetEnabled:function () {
            return this.cfg.ignoreSetEnabled;
        },
        
        getLog: function() {
        	
	        var log = {
        			taskCid: this.cfg.taskId,
        			attempts: this.currentAttempt,
        			result: this.result
        	} ;
        	
        	return log ;
        },
        
        setTaskPoints: function( score, lockScore ) {
        	
        	var lock = !!lockScore ;
        	
        	if( this.pointsIndicator ) {
        		
        		this.pointsIndicator.setCurrentPoint( score ) ;
            	this.lockScore = lock ;
            	
        	} else {
        		
        		this.setDelayedPoints = true ;
        		this.pointsToSetLater = score ;
        		this.setDelayedLockScore = lock ;
            	this.lockScore = false ;
        		
        	}
        }

    }); // End of t2k.player.task.BaseTask


// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * TODO
     */
    function parseXML(data) {
        var $data = jQuery(data);
        var elementsMap = {};
        $data.children().each(function (index, child) {
            var tagName = child.tagName.toLowerCase();
            elementsMap[tagName] = child;
        });

        var widthLimitFactor = parseFloat($data.attr('width_limit'));
        var widthPercent = 100 * ( isNaN(widthLimitFactor) ? 1 : widthLimitFactor );

        return {
            elementsMap:elementsMap,
            widthPercent:widthPercent,
            baseClasses:$data.attr('base_classes'),
            ignoreScroll:$data.attr('ignoreScroll') == 'true',
            rubric: extractRubric( elementsMap.progress )
        };

    }
    
    function extractRubric( progressXML ) {
    	var rubric = null ;
    	var $rubric = $( progressXML ).children('rubric') ;
    	if( $rubric.length ) {
    		rubric = {
    				id: $rubric.attr('id'),
    				score: parseInt( $rubric.attr('score') )
    		} ;
    	}
    	
    	return rubric ;
    }
    
    function extractAutoCheck(xml, defaultProgressData, defaultConfig) {
        var jXml = jQuery(xml);
        var autoCheckXML = jXml.children('autoCheck');

        if (autoCheckXML.length == 0) {
            if (defaultConfig) {
                if (defaultConfig.allowDefaultAutocheck) {
                    autoCheckXML = defaultProgressData.children('autoCheck');
                }
            } else {
                autoCheckXML = defaultProgressData.children('autoCheck');
            }
        }
        return autoCheckXML.text() == 'true';
    }


    function getAnswerClass(type) {
        var answerClass = type[0].toUpperCase() + type.substring(1);
        return t2k.component.answer[answerClass + 'Answer'];
    }

    function extractFeedback(jXml, defaultProgressData, defaultConfig) {
        var result = { fbLabel:'', fbMessages:'' };

        var jFBMessages = jXml.children('feedback');
        if (jFBMessages.length == 0 && defaultConfig.allowDefaultFeedback) {
            jFBMessages = defaultProgressData.children('feedback');
        }

        if (jFBMessages.length == 0) return result;

        result.fbLabel = jFBMessages.attr('label') || _i18n('tasktoolbar.feedback');

        result.fbMessages = getFeedbackMessagesData(jFBMessages);

        return result;
    }
    function extractSpecificFeedback(xml) {
     
        if(!xml.length){
            return {};
        }

        xml = $(xml)
        var result = {};

        if(xml.length && xml.children().length){
            
            $(xml).children('checkableelement').each( function(){ //<checkableelement id=xxx / default>
                var checkbleElement = this;
                var checkbleElementId =  $(checkbleElement).attr('id');
                if(!result[checkbleElementId]){
                    result[checkbleElementId] = {};
                }
                $(checkbleElement).children().each( function(){ // <correct>/ <partially> / <wrong>
                    var checkingType = this.tagName.toLowerCase();
                    if(!result[checkbleElementId][checkingType]){
                        result[checkbleElementId][checkingType] = {};
                    }
                    $(this).children().each(function(){ // <feedbackitem>
                        var feedbackitem = $(this);

                        if($(feedbackitem).children('checkableelementvalue').html()){ //<checkableelementvalue type=id/mathfield/textviewer/default> value
                            var checkbleElementValue = $(feedbackitem).children('checkableelementvalue').html().toString().trim();
                            result[checkbleElementId][checkingType][checkbleElementValue] = $($(feedbackitem).children('feedbackdata').html()); // specific feedabck value to display 
                        }else{
                            if($(feedbackitem).children('checkableelementvalue').first().attr('type') == 'default'){
                                result[checkbleElementId][checkingType]['default'] = $($(feedbackitem).children('feedbackdata').html());
                            }
                        }
                        
                    })

                },this);

            },this);

            }
        return result;
    }

    function parseProgressData(defaultConfig, xml) {
        // Wrap with jQuery
        var jXml = jQuery(xml);

        var defaultProgressData = ENV.defaultTaskProgress;

        // Handle Button Data
        var buttonModes = copy({}, defaultConfig.buttonModes);

        // TODO: check why doesn't this work normally
        if (!LanguageUtil.strings.task) {
            LanguageUtil.strings.task = {
                progress: {
                    labels: {
                        check : "Check",
                        tryagain : "Try Again",
                        showanswer : "Show Answer",
                        progress : "Continue",
                        done : "Done",
                        skiptask : "Skip Task",
                        solvetask : "Solve Task",
                        restarttask : "Restart Task"
                    }
                }
            } ;
        }

        // get lab
        var langLabels = LanguageUtil.strings.task.progress.labels;
        for (var key in langLabels) {

            var value = langLabels[ key ];

            if (/*ENV.assessmentMode*/ ENV.viewMode.isAssessment) {
                var assessmentKey = 'assessment_' + key;
                var assessmentValue = langLabels[ assessmentKey ];
                if (assessmentValue) {
                    value = assessmentValue;
                }
            }

            if (!buttonModes.states) buttonModes.states = {};
            buttonModes.states[ key ] = { title:value };
        }
//        // override language file button strings with xml content strings
//        var buttons = jQuery.merge(defaultProgressData.children('taskButton'), jXml.children('taskButton'));
//        buttons.each(function (index, button) {
//            var jBtn = jQuery(button);
//            var btnLabel = jBtn.attr("label");
//            var btnType = jBtn.attr("type");
//
//            if (!buttonModes.states) buttonModes.states = {};
//
//            buttonModes.states[ btnType ] = { title:btnLabel };
//        });

        // Handle Hint Data
        var jHintMessages = jXml.children('hint');
        var hintLabel;
        if (jHintMessages.length > 0) {
            hintLabel = jXml.children('hint').attr('label') || _i18n('tasktoolbar.hint');
        }
        var hintMessages = getHintMessagesData(jHintMessages);

        var __ret = extractFeedback(jXml, defaultProgressData, defaultConfig);
        var fbLabel = __ret.fbLabel;
        var fbMessages = __ret.fbMessages;

        specificFeedbackMessages = extractSpecificFeedback(jXml.children('specificFeedback'));

	    //Handle attempts
        var attemptsXML = jXml.children('attempts');
        if (attemptsXML.length == 0 && defaultConfig.multipleAttempts) {
            attemptsXML = defaultProgressData.children('attempts');
        }
        var parseRes = parseInt(attemptsXML.text());
        var attempts = (!!!parseRes) ? 0 : parseRes;

	    //Handle task points
	    var pointsXML = jXml.children('points'), points = 0;
	    if(pointsXML.length) {
		    points = parseInt(pointsXML.text()) || 0;
	    }

        // Handle autocheck
        var autocheck = extractAutoCheck(xml, defaultProgressData, defaultConfig);
        //will only be set to "input" when in opq , otherwise for now will be ""
        var progressType = jQuery(xml).children('type').text();
        
        return {
            buttonModes:buttonModes,
            hintMessages:hintMessages,
            hintLabel:hintLabel,
            fbMessages:fbMessages,
            specificFeedbackMessages: specificFeedbackMessages,
            attempts:attempts,
	        points:points,
            autocheck:autocheck,
            fbLabel:fbLabel,
            type:progressType
        };
    }

    function getHintMessagesData(xml) {
        var messages, attempt;

        jQuery(xml).children('message').each(function (index, msgXML) {
            if (!messages) messages = {};
	        attempt = null;

	        if(msgXML.attributes["attempt-num"]) {
		        attempt = msgXML.attributes["attempt-num"].value;
		        !!attempt && (messages[ attempt ] = msgXML);
	        }

	        if(msgXML.attributes["attempt"]) {
		        attempt = msgXML.attributes["attempt"].value;
		        !!attempt && (messages[ attempt ] = msgXML);
	        }

        });

        return messages;
    }

    function extractInstruction(xml, defaultConfig) {
        var jnode = jQuery(xml).children("instruction");
        if (jnode.length == 0 && defaultConfig.allowDefaultInstruction) {
            var defaultProgressData = ENV.defaultTaskProgress;
            jnode = defaultProgressData.children('instruction');
        }
        if (jnode.length > 0) {
            return {
                'narrationUrl':"assets/" + jnode.attr('narration'),
                'emphasized':jnode.attr('emphasized') == 'true',
                'show':jnode.attr('show') == 'true',
                'content':jnode.text(),
                'data':jnode[0]
            };
        }
        return null;
    }

    function extractHelp(xml) {
        var jnode = jQuery(xml).children("help");

        if (jnode.length > 0) {
            return {
                'items':jnode.children('helpitem')
            };
        }

        return null;
    }

    function getFeedbackMessagesData(xml) {

        var messages = null;

        jQuery(xml).children('message').each(function (index, msgXML) {

            if (!messages) messages = {};

            var type = jQuery(msgXML).attr('type');
            var attempt = jQuery(msgXML).attr('attempt');

          
            if (!messages[type]) {
                messages[type] = {};
            }

            messages[type][attempt] = msgXML;

        });

        return messages;
    }
})();

////////////////////////////////////////
// SRC End --> t2k/player/task/BaseTask.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/StatementTaskView.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: defaultConfig
     * Hold sensible defaults for the Statement's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the Statement's view */
        layout:'inline'
    }; // End of defaultConfig.

    t2k.player.task.StatementTaskView = t2k.player.task.BaseTaskView.subClass({

        /** The class' name (for debugging purpose). */
        name:'t2k.player.task.StatementTaskView',

        /**
         * @constructor
         * @see superclass documentation
         */
        ctor:function (config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            this._view.addClass('statement');

            this.applyMode();
        },

        applyMode:function () {

            if (this.cfg.mode.length == 0) {
                throw(' statement requires mode' );
            }

            this._view.addClass(this.cfg.mode);

            if (!this.cfg.useIcon) {
                this._view.addClass('no_numbering');
                // this._task_numbering.addClass('hidden');
                var numberingWidth = this._task_numbering.outerWidth();
            }
        },

        setExposed:function (flag) {
            this._super(flag);
            if(!this.cfg.useIcon){
                if (flag) {
                    var maxWidth = this._task_container.width();
                    this._top_border.width(maxWidth);
                } else {
                    var maxWidth = this._wrapper_internal.outerWidth();
                    this._top_border.width(maxWidth);
                }
            }

        },

        setTaskNumbering:function (num) {

            if (this.cfg.useIcon) {

                var div = this._task_numbering,
					icon = jQuery('<div class="task_numbering_icon"></div>');

if((this.cfg.mode).toLowerCase() == 'self_check'){
	var span_Icon = jQuery('<span>D</span>');
	span_Icon.appendTo(icon);
}

                icon.appendTo(div);

                this._view.prepend(div);
            }

        }

    });

})();


////////////////////////////////////////
// SRC End --> t2k/player/task/StatementTaskView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/task/StatementTask.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.task.QuestionOnlyTask
     * The only-question task.
     */
	t2k.player.task.StatementTask = t2k.player.task.BaseTask.subClass({
        
        /** The class' name (for debugging purpose). */
		name: 't2k.player.task.StatementTask',

        ctor:function (config) {

            this.parseData(config);

            // Delegate.
            this._super( config ) ;
        },
        
        parseData:function (config) {
            config.mode = jQuery(config.data).find('mode').text();
            config.useIcon = config.mode == 'self_check';
        },
		
        getHelpParent: function() {
        	
        	var parent = this._super() ;
     
        	return parent ;
        },
        
        createView: function(cfg){
            return new t2k.player.task.StatementTaskView(cfg);
        },
                
        registerCheckableEvents:function () {},
        registerAssessmentEvents:function () {},

        setEnabled: function( flag ) {
        	
            this._super( flag ) ;
            
            if( this.title )
            	this.title.setEnabled( flag );
            
            if( this.question )
            	this.question.setEnabled( flag ) ;

            if( this.answer )
            	this.answer.setEnabled( flag ) ;	
        }
    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();

////////////////////////////////////////
// SRC End --> t2k/player/task/StatementTask.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/BaseSequence.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.sequence.Sequence
     * A simple sequence, the most basic container of tasks.
     */
    t2k.player.sequence.BaseSequence = t2k.core.FlowPresenter.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.sequence.BaseSequence',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's configuration.
         */
        ctor: function(config) {
        	
            // Delegate
            this._super(config);

            this.createContent();
            
        },
        

        fireState: function( success, error ) {
        	
        	var state = this.getState() ;
        	
        	var stringState =
        		state ?
        			state[0] ? state[0].outerHTML : null
        			:
        			null ;
        	
        	// send state to external host
        	this.onStateReady( stringState, null, null, success, error ) ;
        },
        
        onStateReady: function( stateString, log, scores, success, error ) {
            	// send state to external host
            	ENV.host.saveState( stateString, log, scores, success, error );
        },
        
        /**
         * Method: setEnabled
         * De/Activates the presenter. This method sets the view's active state.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
        	
            // Delegate
            this._super(flag);
            
        }, // End of setEnabled

        getState: function() {
            var state = jQuery('<sequence/>');
            
            state.attr( 'enabled', !!this.isEnabled() ) ;
            state.attr( 'cid', this.cfg.id ) ;

            return state;
        },
	    
	    getStateWithCallback: function( callback ) {
	    	callback( this.getState() ) ;
	    },

        setState: function(state) {
        	
        	if (!!state) {
            
	        	var CID = this.cfg.id ; 
	        	var stateCID = $(state).attr("cid");
	            
	        	if( CID != stateCID ) {
	        		throw new Error( "unmatching CID in state\n # cid -->\t\t"+ CID + "\n # state -->\t\t" + stateCID ) ;
	        	}
	        }
        	
            this._super(state);

            if (!!state) {                
            } else {
            }
        },

        createContent: function() {
            this.createView();
            this.createInnerElements() ;
            this.initView();

        },

        createView: function() {
            // Create the view.
            throw 'missing view instantiation, please override and set "this.view"' ;
        },

        initView: function() {

        },
        
        createInnerElements: function( calledFromCompile ) {
        },

        /**
         * Method: progress
         * Instructs the sequence to move to the next sequence.
         */
        progress: function() {
        	
            this.progressOriginal() ;
            
        },
        
        progressOriginal: function() {

            this.dispatchEvent('onNextSequence');
            
            // Mark sequence as done.
            this.finish3d = true;
            
        },

        isFinished: function() {
            return !!this.finish3d;
        },

        getStaticData: function(index) {
            var tasksStaticData = '';

            return tasksStaticData;
        },

        showGrid: function(type, show) {
            this.view.gs.drawGrid(type, show);
        },
        
        isCompilable: function() {
        	return false ;
        }
    }); // End of t2k.player.sequence.Sequence

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    
    
})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/BaseSequence.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/SequenceView.js
////////////////////////////////////////

(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton and/or Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    var TEMPLATE =
        "<div id='{{id}}' class='sequence'>\
            <div id='{{id}}_creative_footer' class='creative_footer'></div>\
			<div id='{{id}}_creative_margin' class='creative_margin'></div>\
            <div id='{{id}}_body' class='sequence_body'>\
               {{#isShared}}\
                	{{#isCollapse}}\
						<div id='{{id}}_collapse' class='sequence_shared_collapsed {{sharedPosition}}'>\
							<div class='shared_collapse_content {{sharedPosition}}'>\
								<div class='shared_collapse_fold {{sharedPosition}}'>\
									<div class='fold_btn'>\
										<div class='fold_content'></div>\
									</div>\
								</div>\
								<div id='{{id}}_shared' class='sequence_shared {{cssSharedType}} {{sharedPosition}} {{orientation}}'></div>\
							</div>\
						</div>\
                	{{/isCollapse}}\
                	{{^isCollapse}}\
                		<div id='{{id}}_shared' class='sequence_shared {{cssSharedType}} {{sharedPosition}} {{orientation}}'></div>\
                	{{/isCollapse}}\
               {{/isShared}}\
               <div id='{{id}}_content' class='sequence_content_scrollable scroll_enabled'>\
	               <div id='{{id}}_content_wrapper' class='sequence_content_wrapper'>\
						<div class='sequence_margin_left'></div>\
                        <div id='{{id}}_content_inner' class='sequence_content_inner'>\
							<div id='{{id}}_list_head' class='sequence_list_head'>\
	                            <div id='{{id}}_header' class='sequence_header'></div>\
	                            <div id='{{id}}_instruction' class='sequence_instruction_wrapper'></div>\
							</div>\
                        </div>\
						<div id='{{id}}_margin_right' class='sequence_margin_right'></div>\
				   </div>\
			   </div>\
            </div>\
        </div>";
    /**
     * Private: defaultConfig
     * Hold sensible defaults for the sequence's view to use.
     */
    var defaultConfig = {
        /** The default layout used by the player's view */
        layout: 'vertical',
        layoutScrollBase: 38,
        layoutScrollMin: 20,
        layoutScrollMax: 230,
        largeTaskCoverage: 0.85,
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.

    /**
     * Private: iconsConfig
     * Hold sensible defaults for the icons font to use.
     */
    var iconsConfig = {
        'fold_arrow': '1',
        'book': 'D'
    }; // End of iconsConfig.

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.sequence.SequenceView
     * The sequence's view.
     */
    t2k.player.sequence.SequenceView = t2k.core.View.subClass({

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's view configuration.
         */
        ctor: function(config) {
            // Delegate.
            this._super(copy(config, defaultConfig));

            this.gs = new gridService(this);

            this.measures = this.gs.define('tasksArea');

            if (this.cfg.isShared) this.measures.shared = this.gs.define('sharedArea');


            if (!this.cfg.isReadingDirection) this._body.prepend(this._content);

            var usingHeader, usingInstruction, usingSeqHead;
            // Apply the header.
            usingHeader = this.setHeader(this.cfg);
            // apply instruction
            usingInstruction = this.setInstruction();

            usingSeqHead = usingHeader || usingInstruction;

            if (!usingSeqHead) {
                this._list_head.addClass('empty');
            } else if (usingInstruction && !usingHeader) {
                this._list_head.addClass('instruction_only');
            }
        }, // End of ctor

        init:function () {
            if (this.cfg.isShared && this.cfg.isCollapse) {
                initCollapse.call(this, this.cfg, this.measures);
            }
            this.setBottomSpacer();

            var creativeSetData = jQuery(this.cfg.data).find('creativeSet')[0] ;

            if( !this.cfg.isShared && creativeSetData ) {

                this.defineCreativeLayouts();

                this.creativeManager = new t2k.util.managers.CreativeLayoutManager( {
                        tasksSizes:{width:this.gs._getTasksWidth,height:this.gs._getTasksHeight},
                        data: creativeSetData,
                        direction: this.direction || 'ltr'
                    },
                    this._creative_footer,
                    this._creative_margin,
                    null,
                    this.gs
                );

            }
        },

        defineCreativeLayouts:function() {

            var footer          = this._creative_footer,
                lastChild       = this.children[ this.children.length - 1 ],
                lastHeight      = lastChild._view.height(),
                lastTop         = lastChild._view.offset().top,
                footerTop       = lastHeight + lastTop;

            footer.css({
                'height'    : this.cfg.parent._view.height() - footerTop + 'px',
                'width'     : this._view.width() + 'px',
                'top'       : footerTop + 'px'
            });

            if (this.gs._px(this.cfg.creativeTasksWidth + 'em') < this._content.width()) {

                var marginWidth     = this._content.width() - this.gs._px(this.cfg.creativeTasksWidth + 'em'),
                    marginPosition  = this._content_wrapper.width(),
                    margin          = this._creative_margin;

                margin.css({
                    'height' : this._view.height() + 'px',
                    'width'  : marginWidth + 'px',
                    'top'    : this._view.offset().top + 'px'
                }).css( this.cfg.direction == 'ltr' ? 'left' : 'right', marginPosition + 'px');
            }
        },

        setBottomSpacer: function() {

            var viewH       = this._content.innerHeight(),
                lastChild   = this.children[ this.children.length - 1 ],
                lastHeight  = lastChild._view.height(),
                lastTop     = lastChild._view.offset().top,
                footerTop   = lastHeight + lastTop,
                top         = Math.max(this.cfg.layoutScrollMin, Math.min(this.cfg.layoutScrollMax, viewH - lastHeight)),
                bottomSpacerHeight = viewH - lastHeight - top;

            bottomSpacerHeight = bottomSpacerHeight > 0 ? bottomSpacerHeight : 0;

            if (footerTop >= this._view.height() && bottomSpacerHeight >0) {
                var spacer = jQuery('<div/>');
                spacer.css('height', bottomSpacerHeight + 'px');
                this._content_inner.append(spacer);

            }
        },

        getTaskTopScroll: function(index) {

            var top         = this.cfg.layoutScrollBase,
                taskView    = this.children[ index ],
                isLast      = ( index == this.children.length - 1 );

            if (!isLast) {
                var taskHeight      = taskView._view.height(),
                    viewH           = this._content.innerHeight(),
                    taskCoverage    = taskHeight / viewH;

                if (taskCoverage > this.cfg.largeTaskCoverage) {
                    top = this.cfg.layoutScrollMin;
                }
            } else {
                top = this.cfg.layoutScrollMin;
            }

            return top;
        },

        setInstruction:function() {

            var thi$ = this,
                used = false;

            if (thi$.cfg.instructionData) {
                thi$.instruction = new t2k.player.task.controls.Instruction(copy(thi$.cfg.instructionData, {
                    parent: this.cfg.id + '_instruction',
                    onNarrationStarted: function() {},
                    onNarrationDone: function() {},
                    onRendered : function() {}
                }));

                thi$.instruction.setSequenceMode();
                used = true;
            }
            return used;
        },

        setHeader:function(cfg) {

            var used = false;

            if (this.cfg.headerData) {
                this.header = componentFactory.create({
                    data : this.cfg.headerData,
                    parent: this.cfg.id + '_header',
                    onRendered : function() {}
                });

                used = true;
            }

            return used;
        },

        removeFromDom:function() {
            this._view.removeClass('show');
            this._view.addClass('hidden');
        },

        addToDom:function() {
            this._view.removeClass('hidden');
            this._view.addClass('show');
        },

        getLayoutStatus: function() {
            return !!this.creativeManager ? this.creativeManager.getLayoutStatus() : null ;
        }


    }); // End of t2k.player.sequence.SequenceView

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private:
     * Function: buildCollapse
     * Build collapse / expand. - by roman
     *  Parameters:
     *  cfg - {Object} Contains the data to apply.
     *  measures - {Object} measures for shared area and tasks area.
     */
    function initCollapse(cfg, measures) {

        var collapse = this._body.find('.sequence_shared_collapsed'),
            collapseBorder = this._body.find('.sequence_shared_border'),
            collapseWrapper = collapse.find('.shared_collapse_content'),
            foldWrapper = collapse.find('.shared_collapse_fold'),
            foldButton = collapse.find('div.fold_btn'),
            foldButton_verticalPadding = parseInt(foldButton.css('padding-top'),10)+parseInt(foldButton.css('padding-bottom'),10),
            foldButton_horizontalPadding = parseInt(foldButton.css('padding-right'),10)+parseInt(foldButton.css('padding-left'),10),
            foldContent = collapse.find('div.fold_content'),
            sequence_shared = collapse.find('div.sequence_shared'),
            foldShadow = collapse.find('div.fold_shadow'),
            content = jQuery(cfg.data).find('shared > label').text(),
            icon = jQuery(cfg.data).find('shared > label').attr('icon'),
            scrollOffset = cfg.isReadingDirection ? 0 : getScrollWidth(cfg),
            contentWidth, isTooltip;

//console.error('getScrollWidth:',getScrollWidth(cfg));

        foldContent.html( createIcons(icon) + content.toUpperCase() );

        foldShadow.addClass('hidden');
        contentWidth = Math.min(foldContent.outerWidth() + foldButton_verticalPadding + foldButton_horizontalPadding, 225);
        isTooltip = foldContent.outerWidth() > contentWidth;
        foldContent.width((contentWidth % 2 ? contentWidth : contentWidth + 1)-(foldButton_verticalPadding+foldButton_horizontalPadding));//Chrome bug: width have to be an odd number

        if (isTooltip) foldButton.attr('title', content);

        if (cfg.isVertical) {
            foldContent.addClass('rotate');

            // set div.sequence_shared_collapsed to relevant position and add padding to ScrollBar
            if(cfg.sharedPosition == 'right'){
                collapse.css(cfg.sharedPosition, collapseBorder.width() + scrollOffset);
                collapseBorder.css(cfg.sharedPosition, scrollOffset);
            }else{
                collapse.css(cfg.sharedPosition, 1);
                collapseBorder.css(cfg.sharedPosition, 0);
            }

            collapseWrapper.width(measures.shared.width + foldWrapper.width()); //set wrapper width to be content + fold button so they can both float next to each other

            foldButton.height(contentWidth);

            var tmpPositionVal = 0,
                fontOffset = cfg.isReadingDirection ? 13 : -10; //margin for font alignment;

            // calc position by direction and orientation
            if (ENV.contentDirection == 'rtl'){
                fontOffset = cfg.isReadingDirection ? 0 : -5;
                tmpPositionVal = -(foldButton.offset().left - foldContent.offset().left + (cfg.isReadingDirection ? 11 : foldButton.width() - foldContent.height() +fontOffset) );
            } else {
                tmpPositionVal = (foldButton.offset().left - foldContent.offset().left + (cfg.isReadingDirection ? 4 : foldButton.width() - foldContent.height() +fontOffset) );
            }
            foldContent.css(cfg.sharedPosition,tmpPositionVal + 'px');
            foldContent.css('top', (foldButton.offset().top - foldContent.offset().top+foldButton_verticalPadding) + 'px');
        }
        else {
            if (cfg.isReadingDirection) collapseWrapper.prepend(this._shared);
            var foldButton_css = {'width':contentWidth};
            // set position by direction and orientation
            if (ENV.contentDirection == 'rtl'){
                foldButton_css['float'] = 'left';
            } else {
                foldButton_css['float'] = 'right';
            }
            foldButton.css(foldButton_css);
        }

        //bind events
        foldButton
            .click(function () {
                t2k.util.balloon.close();//hide balloon
                animateCollapse(cfg, measures);
                 cfg.clickOnCollapseCallback && cfg.clickOnCollapseCallback(true);
            })
            .hover(function () {
                sequence_shared.toggleClass('border-colored');
            });
    }

    /**
     * Private:
     * Function: animateCollapse
     * animated collapse / expand. - by roman
     *  Parameters:
     *  cfg - {Object} Contains the data to apply.
     *  measures - {Object} measures for shared area and tasks area.
     */
    function animateCollapse(cfg, measures) {
        var collapse    = Perf.select('#' + cfg.id + '_collapse'),
            foldButton  = collapse.find('div.fold_btn'),
            shadowWidth = -2,
            animateObj  = {};

        if (cfg.isVertical) {
            animateObj = {
                'width': (collapse.hasClass('expanded') ? foldButton.outerWidth() : measures.shared.width + foldButton.outerWidth()) + shadowWidth
            };
        } else {
            animateObj = {
                'height':(collapse.hasClass('expanded') ? foldButton.outerHeight() : measures.shared.height + foldButton.outerHeight()) + shadowWidth
            }
        }

        collapse.animate(animateObj, function () {
            collapse.toggleClass('expanded');
        });
    }

    /**
     * Private:
     * Function: getScrollOffset
     * returns scroll width. - by roman
     *  Parameters:
     *  cfg - {Object} Contains the data to apply.
     *  measures - {Object} measures for shared area and tasks area.
     */
    function getScrollWidth(cfg) {
        var content = jQuery('#' + cfg.id + '_content'),
            div = content.prepend('<div class="scroll-tester" />').find('.scroll-tester'),
            width = cfg.width - div.width();

        div.remove();

        return width;
    }


    /**
     * Private:
     * Function: appendChild
     * A helper method for creating appending DIV elements.
     *
     * Parameters:
     *  cls - {String} A CSS class to apply to the new DIV.
     *  html - {String} HTML content to set as the DIV content.
     *  parent - {Object} A parent element to append the new DIV to.
     */
    function appendChild(cls, html, parent) {
        var div = jQuery("<div/>");
        div.addClass(cls);
        div.html(html);
        div.appendTo(parent);
    } // End of appendChild

    /**
     * Private:
     * Function: createIcons
     * returns string with icon's Html ( .fold_arrow icon will be here always )
     * Parameters:
     * icon - {String} Contains the name to icon set.
     */
    function createIcons(icon) {
        var icons_Html  = '<div class="icon fold_arrow">' + iconsConfig['fold_arrow'] + '<\/div>',
            icon_font   = iconsConfig[icon];

        if(icon && icon_font){
            icons_Html += '<div class="icon fold_icon_' + icon.toLowerCase() + '" >' + icon_font + '<\/div>';
        }

        return icons_Html;
    }

})();

////////////////////////////////////////
// SRC End --> t2k/player/sequence/SequenceView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/Sequence.js
////////////////////////////////////////

var globalEvents = {

	events : [],

	add : function(cfg){
		this.events.push(cfg);
	},

	run : function(){
		for (i=0 ; i<this.events.length ; i++){
			this.events[i] && this.events[i].fnc.apply(this.events[i].context);
		}
		this.events = [];
	}
};


(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.sequence.Sequence
     * A simple sequence, the most basic container of tasks.
     */
    t2k.player.sequence.Sequence = t2k.player.sequence.BaseSequence.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.sequence.Sequence',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's configuration.
         */
        ctor: function(config) {
            
        	CompilerUtils.enhanceConfigForLayouting( config ) ;
        	
        	copy( config, parseXML( config.data ), config.overrideOptions ) ;
        		
            // Layouter members init
            this.sequenceLayouter = {};
            this.sequenceLayouter.done = false;
            this.sequenceLayouter.lastEnabledFlag = false;
            
            this.sequenceConfigPath = config.dataLibPath + config.configPath;
            
            this.sharedArea;
            this.sharedData = jQuery(config.data).find("sharedArea")[0];
            this.sharedType = jQuery(this.sharedData).attr('type');
            this.cssSharedType = 'type_' + this.sharedType ;

            this.tasksRelations = {};
            this.sequenceConfigPath = config.dataLibPath + config.configPath;
            this.completedAssessmentTasks = [];
            this.flaggedTasks = [];
	        this.helpState = [];
            
            this.tasksConfig = jQuery(config.data).find("task");

	        this.createTasksMapCid();
	        
            // Delegate
            this._super(config) ;
            
            this.cfg.activeChild = 0 ;
            
            if( this.cfg.focusOnTask ) {
            	var taskToFocus = this.tasksMapCid.indexOf( this.cfg.focusOnTask ) ;
            	if( taskToFocus != -1 ) {
            		this.cfg.activeChild = taskToFocus ;
            	} else {
            		console.error( "using focusOnTask with invalid task cid" ) ;
            	}
            }

        },
        
        /**
         * Method: setEnabled
         * De/Activates the presenter. This method sets the view's active state.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
            //if sequence layouter still running don't enable the sequence, just update lastEnabledFlag with the current flag
            if (!this.sequenceLayouter.done) {
                this.sequenceLayouter.lastEnabledFlag = flag;
                return;
            }

            // Delegate
            this._super(flag);
            
            // set scroll control
            ScrollControl.initSequenceScrollControl(this.view._view, flag);
            
            // Enable the current task.
            var activeTask = this.children[ this.cfg.activeChild ];
            if (flag) {
//            	this.swapRubric( activeTask ) ;
            }
            activeTask.setEnabled(flag);
            if(flag && this.cfg.activeChild != 0 && !activeTask.getIgnoreScroll() ){
                this.view.scroll(this.cfg.activeChild, null, this.cfg.layoutScrollBase);
            }
            if(activeTask.getIgnoreSetEnabled()){
                activeTask.view._view.addClass('disabled');
            }    

            if (flag) {
                this.exposeTaskGroup(activeTask);
            }

	        //shared area is always enabled
	        !!this.sharedArea && this.sharedArea.setEnabled(true);

        }, // End of setEnabled

        getState: function() {
            var state = this._super() ;

            // Handle Tasks
            var tasks = jQuery("<tasks/>");
            state.append(tasks);
            jQuery(tasks).attr("active_task", this.cfg.activeChild);

            // loop over tasks and get each task's state
            for (var i = 0; i < this.children.length; i++) {
                var taskState = this.children[i].getState();
                jQuery(taskState).attr("index", i);
                jQuery(tasks).append(taskState);
            }

            var sharedState = this.getSharedState();
            if (sharedState) {
                state.append(sharedState);
            }

            return state;
        },

        getSharedState:function() {
        	var sharedState ;
            if (this.sharedArea) {
                 sharedState = this.sharedArea.getState() ;
            }
            return sharedState;

        },

        setState: function(state) {
            this._super(state);

            var i;

        	var specificFocus = this.tasksMapCid.indexOf( this.cfg.focusOnTask ) ;
        	
            if (!!state) {
                // Handle Sequences.
                var tasksWrapper = jQuery(state).find('tasks');
                
                var task, tasks = tasksWrapper.children();
                this.cfg.activeChild = specificFocus != -1
                		?
                	specificFocus
                		:
                	parseInt(tasksWrapper.attr('active_task')) ;
           

                //HACK
                if(this.cfg.activeChild < 0){
                    this.cfg.activeChild = 0;
                }
                
                var focusedTask = this.cfg.activeChild,
                    forceEnableLastTask = false;
                if (focusedTask == tasks.length-1){
                    //if the focused task is the last one, we would always want it to be focused and enabled
                    forceEnableLastTask = true;
                }

                
                for (i = 0; i < tasks.length; i++) {
                    task = jQuery(tasks[i]);
                    this.children[parseInt(task.attr('index'))].setState(task , (forceEnableLastTask && i == focusedTask));
	                task = null;
                }
                
                // no need in scrolling to 0 (1st) task on state, its already there
                // unless blocked, it will hide the sequence header when returning from state.
                if( this.cfg.activeChild != 0 ) {
                    this.view.scroll(this.cfg.activeChild, null, this.cfg.layoutScrollBase);
                }
                
                if (this.sharedArea) {
                    var sharedState = jQuery(state).find('sharedarea');
                    this.sharedArea.setState(sharedState);
                }

            } else {
                for (i = 0; i < this.children.length; i++) {
                    this.children[i].setState(null);
                }

                //focus on last task but stay on scroll at first element and set disabled css class on last task 
                //use in read only mode
                if(ENV.viewMode.lastTaskFocusing){
                    this.cfg.activeChild = this.children.length - 1;
                    this.children[this.cfg.activeChild].cfg.ignoreScroll = true;
                    this.children[this.cfg.activeChild].cfg.ignoreSetEnabled = true;
                   
                }else{

                    this.cfg.activeChild = specificFocus != -1 ? specificFocus : 0 ;
                }
                
            }

	        if( specificFocus != undefined && specificFocus != -1 ) {
		        this.progressToTask(this.cfg.focusOnTask);
	        }
        },

        /*
         this function is to reset to initial state( i.e no state applied) of all levels of hierarchy, this will be called before setState
         */
        resetState:function () {
//            next 2 lines does not work yet, need to figure out how this should work
//            this.cfg.activeChild = 0;
//            this.view.scroll(this.cfg.activeChild, null, this.cfg.layoutScrollBase);
            for (var i = 0; i < this.children.length; i++) {
                this.children[i].resetState();
            }
        },

	    createInnerElements: function( calledFromCompile ) {
        	this._super() ;
        	
        	var sharedData = jQuery(this.cfg.data).find("sharedArea");
        	if( sharedData.length > 0 ) {
	        	this.createShared( calledFromCompile );
        	}
        	
        	this.createTasks( calledFromCompile );
        },

	    createTasksMapCid: function() {
		    this.tasksMapCid = [];
		    var thi$ = this;
		    jQuery.each(this.tasksConfig, function (item, taskData) {
		    		var taskCIDattr = taskData.attributes.getNamedItem('id') ;
		    		if( taskCIDattr ) {
		    			thi$.tasksMapCid.push( taskCIDattr.value ) ;
		    		}
			    }
		    );
	    },

        initView: function() {
        	this._super() ;
        	
            var viewH = this.view._content.innerHeight();
            var lastChild = this.children[ this.children.length - 1 ];
            var lastHeight = lastChild? lastChild.view._view.height(): 0;
            var top = this.view.cfg.layoutScrollBase * 2;
            top += this.view._content_inner.css('padding-top').split('px')[0] * 1;
            var bottomSpacerHeight = viewH - lastHeight - top;

            this.view.init(bottomSpacerHeight > 0 ? bottomSpacerHeight : 0);
        },

        createView: function() {
            this.cfg.headerData = extractHeader(this.cfg);
            this.cfg.instructionData = extractInstruction(this.cfg);

//            override(this.cfg, extractCompileData(this.cfg.data)); //append compilation data to config - by roman
            
            var layoutProps = CompilerUtils.getSequenceLayoutProps( this.cfg ) ;
            override( this.cfg, layoutProps ) ;
            
            // view cleanup
            if( this.view ) {
            	this.view._view.removeNative();
            	delete this.view ;
            }
            var thi$ = this;
            // Create the view.
            var params = copy(  this.cfg , 
                                {
                                    cssSharedType:this.cssSharedType ,
                                    clickOnCollapseCallback : function(val){
                                        thi$.sharedArea.collapseClicked = val;
                                    }
                                });

            this.view = new t2k.player.sequence.SequenceView(params);
        },

        createTasks: function(calledFromCompile, createTasks) {
        	
        	 // init task counter
            this.taskCounter = 0;
        	
        	// reset dynamic Layout task counter
        	DynamicLayoutUtils.resetTaskCounter();
        	
            if (calledFromCompile == null || calledFromCompile == undefined) {
                calledFromCompile = false;
            }
            this.tasks = [];
            this.tasksRelations = {};
            this.grouppedTasks = [];
            this.exposureTasks = {};
            this.currentExposure = 0;
            var taskNumbering = 0;

            // Iterate the configurations and each create the appropriate presenter.
            // Closure ref.
            var thi$ = this;
            
            // set task counter
            this.tasksConfig.each(function(){
                thi$.taskCounter++;
            });

            this.tasksConfig.each(function(index, taskConfigXml) {

                var TaskType = extractTaskType(taskConfigXml);
                var useExposure = !ENV.viewMode.allExposed ;
                if( typeof ENV.overrideGradualExposure != "undefined" && ENV.overrideGradualExposure ) {
                	useExposure = ENV.overrideGradualExposure ;
                }
                var expId = useExposure ? extractExpId(taskConfigXml) : 1 ;
                var groupId = extractGroupId(taskConfigXml);
                
//                var comparisonTaskMax = {} ;
//                if( isComparison ) {
//                	comparisonTaskMax.width = thi$.view.measures.width / 2 ;
//                	comparisonTaskMax.height = thi$.view.measures.height ;
//                }
                
                var taskMax = thi$.view.measures ;
                var widthLimitFactor = parseFloat( jQuery( taskConfigXml ).attr( 'width_limit' ) ) ;

                var incrementTaskIndex = true;

                // set taskNumbering+1, case the task is not statement
                switch (TaskType) {
                    
                	case 'statement':
                        TaskClass = t2k.player.task.StatementTask;
                        incrementTaskIndex = false;
                        break;

                    default:
                        TaskClass = t2k.player.task.BaseTask;
                        break;

                }

                var indexLabel = t2k.util.StringUtils.formatNumber(taskNumbering + thi$.cfg.firstTaskIndex, thi$.cfg.taskIndexType);

	            var isFirstInSequence = (index == 0);
                var isLastInSequence = thi$.tasksConfig.length == index + 1;
                var isLastInMission = isLastInSequence && thi$.cfg.isLast;
                
                var task = thi$.createTask(
                    TaskClass, {
                        taskId: extractTaskId(taskConfigXml),
                        type: TaskType,
                        data: taskConfigXml,
                        exposureId: expId,
                        parent: thi$.view._content_inner,
                        maxSize: taskMax,
                        indexLabel: indexLabel,
		                isFirstInSequence : isFirstInSequence,
                        isLastInSequence: isLastInSequence,
                        isLastInMission: isLastInMission,
                        navMode: ENV.taskNavigationMode,
                        calledFromCompile:calledFromCompile,
                        sequenceConfigPath:thi$.sequenceConfigPath,
                        teacherIndication:thi$.cfg.teacherIndication,
		                sequenceObj: thi$
                    });
                
                taskMax.width *= isNaN( widthLimitFactor ) ? 1 : widthLimitFactor ;
                
                if (!thi$.exposureTasks[ expId ]) {
                	thi$.exposureTasks[ expId ] = [];
                }
                thi$.exposureTasks[ expId ].push( task ) ;
                
                if( groupId ) {
	                if (!thi$.grouppedTasks[ groupId ]) {
	                	thi$.grouppedTasks[ groupId ] = [];
	                }
	                thi$.grouppedTasks[ groupId ].push( task ) ;
                }
                
                task.onNextTask(function() {
                    thi$.progress();
                });

                thi$.add(task);

                //for assessment only , the baseTask is the assessable task and we want to add it to assessment manager
                if (ENV.viewMode.isAssessment && !calledFromCompile) {
                    thi$.dispatchEvent('onAssessmentTaskCreated', {task:task ,taskIndex:index});
                }

                var taskId = task.view.cfg.id;
                
                // use 'explore' relation as default
//                var sharedRelationAttr = jQuery(taskConfigXml).attr("shared_relation") || 'support' ;
                var sharedRelationAttr = jQuery(taskConfigXml).attr("shared_relation") ;
                thi$.tasksRelations[ taskId ] = sharedRelationAttr && sharedRelationAttr != '' ? sharedRelationAttr : 'support';

                if (incrementTaskIndex) {
                    taskNumbering++;
                }

            });

            this.lastTaskIndex = taskNumbering;

            

        }, // End of ctor

        setLayoutState: function(state) {

            var result;

            switch (state) {

                case 'compact':
                    result = 'reduce';
                    break;

                case 'loose':
                    result = 'compact';
                    break;

                case 'reduce':
                    result = 'loose';
                    break;

                default: // on first time
                    result = 'loose';
                    break;

            }

            return result;
        },
        
        getDynamicLayoutDoneEvents: function() {
            var thi$ = this;
            
        	return {
                onTaskRendered : function(thisTask) {
                    thisTask.layoutState = thi$.setLayoutState(thisTask.layoutState);
                    
                    console.log( "onTaskRendered - start" ) ;

    				console.time( "layouter" ) ;
    				var rendered = thi$.dynamicLayoutRenderCallback ;
    				var renderedWrapper = function() {
                        console.log( "onTaskRendered - done" ) ;
    					console.timeEnd( "layouter" ) ;
    					rendered.apply( this, arguments ) ;
					    globalEvents.run();
    				} ;
                    
//                    if (thi$.cfg.compileMode){
	                    DynamicLayoutUtils.dynamicLayout(thisTask, thi$.cfg.height, thisTask.layoutState, thi$, renderedWrapper);
//                    } else {
//                    	thi$.taskCounter--;
//                    	if (thi$.taskCounter == 0){
//                    		thi$.dynamicLayoutRenderCallback();
//                    	}
//                    }
                },
//                onTaskAsAssessmentCompleted:function(thisTask) {
//                    thi$.setTaskAsAssessmentCompleted(thisTask);
//                },
//                onTaskAsAssessmentUnCompleted:function(thisTask) {
//                    thi$.setTaskAsAssessmentUnCompleted(thisTask);
//                },
                onTaskAssessmentFlag:function(thisTask, toggled){
                    thi$.handleFlags(thisTask , toggled);
                }
            } ;
        },
        
        dynamicLayoutRenderCallback: function() {
            this.dispatchEvent('setPreloaderOff');
            var thi$ = this;
            thi$.sequenceLayouter.done = true;                      //sequence layouter is done now
//            thi$.setEnabled(thi$.sequenceLayouter.lastEnabledFlag); //set sequence enabled with the last enabled flag
            thi$.setEnabled( true ) ;
        },
        
        createTask: function(taskClass, cfg) {
            // increment Dynamic Layout task counter
            DynamicLayoutUtils.incrementTaskCounter();

            var task = new taskClass(merge(cfg, {events: this.getDynamicLayoutDoneEvents() }));

            return task;

        },

        //this needs to be merged with createTasks

        createShared: function (calledFromCompile) {
        	
        	if( !calledFromCompile ) {
	        	
	            this.sharedArea = new t2k.component.sharedarea.SharedArea({
	                data: this.sharedData,
	                parent: this.view.cfg.id + '_shared',
	                isCollapse: this.cfg.isCollapse,
	                type:this.sharedType,
	                orientation: this.cfg.orientation,
	                layout:this.cfg.layout,
	                onRendered: function() {
	                	
	                },
	                calledFromCompile:calledFromCompile
	            });

        	}
        },

        setTaskAsAssessmentCompleted:function(task) {
        	
//        	ENV.host.taskChanged( task.cfg.taskId, "answered");
        	
//            var taskPushedToCompletedArray = false;
//            for (var i = 0; i < this.completedAssessmentTasks.length; i++) {
//                if (this.completedAssessmentTasks[i] == task) {
//                    taskPushedToCompletedArray = true;
//                }
//            }
//            if (!taskPushedToCompletedArray) {
//                this.completedAssessmentTasks.push(task);
//            }
//            if (this.completedAssessmentTasks.length == this.children.length) {
//                this.dispatchEvent('seqAssessmentCompletedMode', true);
//            }
        },

        setTaskAsAssessmentUnCompleted:function(task) {
        	
//        	ENV.host.taskChanged( task.cfg.taskId, "cleared");
        	
//            var seqWasCompleted = false;
//            if (this.completedAssessmentTasks.length == this.children.length) {
//                seqWasCompleted = true;
//            }
//
//            //manage the array and find the task that is uncompleted now
//            for (var i = 0; i < this.completedAssessmentTasks.length; i++) {
//                if (this.completedAssessmentTasks[i] == task) {
//                    this.completedAssessmentTasks.splice(i, 1);
//                }
//            }
//            //manage the sequence/progressBar completed mark
//            if (seqWasCompleted && this.completedAssessmentTasks.length != this.children.length) {
//                this.dispatchEvent('seqAssessmentCompletedMode', false);
//            }
        },

        handleFlags:function(task , toggled){
          if(toggled){
              this.flaggedTasks.push(task);
          }else{
               for (var i = 0; i < this.flaggedTasks.length; i++) {
                if (this.flaggedTasks[i] == task) {
                    this.flaggedTasks.splice(i, 1);
                }
            }
          }
            if(this.flaggedTasks.length > 0){
                this.dispatchEvent('seqAssessmentFlagMode' , true);
            }else{
                this.dispatchEvent('seqAssessmentFlagMode' , false);
            }
        },

        setAssessmentTeacherIndication:function(flag){
            if(/*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment){
                var length = this.children.length;
                //we assume that the last task in assessment seq is the assessable and only one
                var assessableTask = this.children[length - 1];
                var taskCheckingType = getTaskCheckingType(assessableTask.cfg.type);
                if(taskCheckingType == 'MANUAL'){
                    //todo add implementation 
                    assessableTask.setIcon('mark' , flag);
                }
            }
        },
        
     /**
         * Method: progress
         * Instructs the sequence to move to the next task.
         * param: focusTaskId(optional)- indicates the task id to progress to, if not sent- increment to next task)
         */
        progress: function( focusTaskId, externalCall, success, ignoreScroll) {
        	
			if( ENV.behaviors.fireUIEvents ) {
				ENV.host.onUIEvent( "blur" ) ;
			}
        	
        	var thi$ = this;
        	
            var progresstoTask = focusTaskId !== undefined, 
                prevFocusTaskId = this.cfg.activeChild,
                currTask = this.children[this.cfg.activeChild];

            if(!progresstoTask){
                currTask.setFinished(true);                
            }

            this.lastTaskLog = currTask.getLog() ;

            currTask.setSaveStateProperty(true);
            currTask.setEnabled(false);

            //get task to progress to
            if(progresstoTask){
                //find index of focused task inside of sequence map of tasks cId's
                this.cfg.activeChild = this.tasksMapCid.indexOf(focusTaskId);

            }else{

                var isLastTask = false;
                // Deactivate the current task. (Liron: except last one on sequence)
                // Increment the counter of the current active child.
                //this.cfg.activeChild += 1;
                if (this.cfg.activeChild != this.children.length - 1) {
                    this.cfg.activeChild += 1;
                }
                else {
                    isLastTask = true;
                }
            }

            // Get reference to the next child and, if exists, activate it.
            currTask = this.children[this.cfg.activeChild];
            var callSuper = false ;
            if (!isLastTask || progresstoTask) {
                
//              this.swapRubric( currTask ) ;
                if(progresstoTask){
                    //reset some progress parameters
                    currTask.progressHandler.taskComponentEnabled = false;
                }
                currTask.progressHandler.started = false;
                
                currTask.setEnabled(true);

                if(!progresstoTask && (this.currentExposure != currTask.cfg.exposureId) ){
                    this.exposeTaskGroup(currTask);
                }
                
                if( !currTask.getIgnoreScroll() && !ignoreScroll) {
                	this.view.scroll(this.cfg.activeChild, null, this.view.getTaskTopScroll(this.cfg.activeChild));
                }
                
                this.onNewTaskFocused( currTask.cfg.taskId, externalCall ) ;
                
				////////////////////////////////////////////////////////////////////////
				// disappearing shared content hack --> re-render affected areas 
				////////////////////////////////////////////////////////////////////////
//				setTimeout( function() {
//					thi$.sharedArea && thi$.sharedArea.view.rerender() ;
//				}, 0 ) ;
				////////////////////////////////////////////////////////////////////////
				
                
             //last task- need to move to next sequence   
            } else {
                callSuper = true ;
            }
            function fireStateCallback(){
                thi$.children[prevFocusTaskId].setSaveStateProperty(false);
                progressCallbackWrapper() ;
            }
            
            function progressCallbackWrapper() {
                if( callSuper ) {
                	thi$.progressOriginal() ;
                }
                success && success() ;
            }
            
            if( externalCall ) {
            	callSuper = false ; 
            }
            
            if( ENV.saveState /*&& !externalCall*/ ) {
                this.fireState( fireStateCallback, null, true ) ;
            } else {
                progressCallbackWrapper() ;
            }

        },
      
        
        onNewTaskFocused: function( taskCid, externalCall ) {
        	if( !externalCall ) {
        		ENV.host.taskChanged( taskCid, "focused");
        	}
        },
        
	    /**
	     * Method: progress
	     * Instructs the sequence to move to the next task.
	     */
	    progressToTask: function(focusTaskId, externalCall, success, ignoreScroll) {
            this.progress(focusTaskId, externalCall, success, ignoreScroll);
	    },
	    
	    getStateWithCallback: function( callback ) {
	    	this.getAsyncState( callback ) ;
	    },
	    
        getAsyncState: function( callback ) {
        	
        	var thi$ = this ;
            
            // get state async way ( from this.getState )
            // optional, if no async needed, callback will be called immediatly
        	StateUtil.collectState( this, function( state ) {
            	
            	// get state string
            	var stateString = state[0].outerHTML ;

            	var scores = thi$.getTasksScores() ;
            	
            	callback( {
            		state: stateString,
            		scores: scores
            	} ) ;
            	
            } ) ;
        },
        
        fireState: function( success, error, sendLogs ) {
        	
            var thi$ = this ;
            
            // get state async way ( from this.getState )
            // optional, if no async needed, callback will be called immediatly
        	this.getAsyncState( function( stateData ) {
        		
            	// get last task log
            	var log = sendLogs ? thi$.lastTaskLog : null ;
            	var scores = thi$.getTasksScores() ;
            	// send state to external host
            	thi$.onStateReady( stateData.state, log, scores, success, error ) ;
            	
            } ) ;
            
            
            
        },

        getTasksScores: function() {
        	
        	var tasksScores = [] ;

            $.each( this.children, function( index, task ) {
            	
            	if( task.isAnswered ) {
            		
	            	tasksScores.push( {
	            			taskCid: task.cfg.taskId,
	            			automatedScore: task.getAnswerAssessmentScore()
	            	} ) ;
	            	
            	}
            	
            } ) ;
        	
        	return tasksScores ;
        },
        
        setTasksScores: function( tasksScores ) {
	
        	for( var i = 0 ; i < tasksScores.length ; i++ ) {
	
				var scoreObject = tasksScores[i] ;
				
				if( scoreObject ) {
					var taskCid = scoreObject.taskCid ;
					var taskScore = scoreObject.score ;
					var task = this.getTaskByCid( taskCid ) ;
					task.setTaskPoints( taskScore, true ) ;
				}
	
            }
        	
        },
        
        getTaskByCid: function( cid ) {
			var taskIndex = this.tasksMapCid.indexOf( cid ) ;
			var task = this.children[ taskIndex ] ;
			return task ;
        },
        
        getTasksCount:function () {
            return jQuery(this.cfg.data).find("task").length;
        },

        getLastTaskIndex:function () {
            return this.lastTaskIndex;
        },

        exposeTaskGroup: function(task) {
            this.currentExposure = task.cfg.exposureId;
            var group = this.exposureTasks[ task.cfg.exposureId ];
            jQuery(group).each(function(i, groupedTask) {
                groupedTask.setExposed(true);
            });
        },

        getStaticData: function(index) {
            var tasksStaticData = this._super() ;

            // loop over tasks and get each task's static data
            for (var i = 0; i < this.children.length; i++) {
                var taskIndex = index + '.' + (i + 1);
                tasksStaticData += this.children[i].getStaticData(taskIndex);
            }

            return tasksStaticData;
        },
        
        isCompilable: function() {
        	return true ;
        }
    }); // End of t2k.player.sequence.Sequence

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
    function parseXML( data ) {
    	
    	var $data = jQuery( data ) ;
    	
    	var parsed = {} ;
    	
    	var groupCounter = 0 ;
    	
    	$data.find( 'group[type=comparison]' ).each( function( index, group ) {
    		
    		var $group = jQuery( group ) ;
    		var groupTasks = $group.find( 'task' ) ;
    		var groupLength = groupTasks.length ;
    		var is3 = groupLength == 3 ;
    		var oneOfStyle = !is3 ? 'oneOfTwo' : 'oneOfThree' ; 
    		
    		groupTasks.each( function( index, task ) {
    			
    			var $task = jQuery( task ) ;
    			
        		var baseClasses = [ 'comparison', oneOfStyle ] ;
        		
    			if( index == 0 ) {
        			// first task
    				baseClasses.push( 'firstInRow' ) ;
    				
    			} else if( index < groupLength - 1 ) {
        			// middle task
    				if( is3 ) {
    					baseClasses.push( 'middleInRow' ) ;
    				} else {
	    				baseClasses.push( 	index % 2 == 0 ?
	    										'firstInRow'
					    						:
					    						'lastInRow'
					    				) ;
    				}
    				
    			} else {
        			// last task
    				baseClasses.push( 'lastInRow' ) ;
    				
    			}
        		
        		$task.attr( 'base_classes', baseClasses.join( ' ' ) ) ;
        		$task.attr( 'group', groupCounter ) ;
        		$task.attr( 'ignoreScroll', true ) ;
        		
        	} ) ;
    		
    		groupCounter++ ;
    		
    		groupTasks.insertAfter( $group ) ;
    		$group.remove() ;
    		
    	} ) ;
    	
    	return parsed ;
    }
    
    function extractGroupId(xml) {
    	return jQuery(xml).attr("group");
    }
    
    function extractTaskId(xml) {
        return jQuery(xml).attr("id");
    }

    function extractTaskType(xml) {
        return jQuery(xml).attr("type");
    }

    function extractExpId(xml) {
        return parseInt( jQuery(xml).attr("exposureId") ) ;
    }

    function extractComparison(xml) {
        return jQuery(xml).attr( 'comparison' ) == 'true' ;
    }

    /**
     * Private:
     * Function: extractHeaderData
     * Extracts header/footer values from the data XML.
     *
     * Parameters
     *  sequenceXml - {XML} The sequence configuration XML.
     *  elName - {String} "header"/"footer".
     */
    function extractHeader(config) {
       return jQuery(config.data).find('header').children()[0];
    } // End of extractHeaderData

    /**
     * Private:
     * Function: extractInstruction
     * @param config
     */
    function extractInstruction(config) {
        var jnode = jQuery(config.data).children("instruction");

        if (jnode.length > 0) {
            return {
                'narrationUrl' : "assets/" + jnode.attr('narration'),
                'emphasized' : jnode.attr('emphasized') == 'true',
                'show' : jnode.attr('show') == 'true',
                'content' : jnode.text(),
                'data': jnode[0]
            };
        }
        return null;
    }


    /**
     * Private:
     * Function: extractCompileData
     * Extracts compilation values from the data XML.
     *
     * Parameters
     *  sequenceXml - {XML} The sequence configuration XML.
     */
    function extractCompileData(sequenceXml) {
        var layout = Compat.getChildren(sequenceXml, 'layout'),
            shared = Compat.getChildren(sequenceXml, 'shared'),
            type = layout.attr('type') || 'vertical';

        return {
            layoutData:layout,
            hasMargin:layout.attr('has_margin')=='true',
            creativeTasksWidth:layout.attr('tasks_width'),
            ratio:layout.attr('tasks_ratio') ? layout.attr('tasks_ratio') : 100,
            isVertical:type == 'vertical',
            isHorizontal:type == 'horizontal',
            orientation:type,
            isReadingDirection:layout.attr('tasks_reading_direction') == 'true',
            isCollapse:layout.attr('shared_task_collapse') == 'true',
            isShared:shared.length > 0,
            sharedPosition:getSharedPosition(layout),
            sharedContentDiffWidth: parseInt( layout.attr( 'sharedContentDiffWidth' ) ) || 0,
            sharedContentDiffHeight: parseInt( layout.attr( 'sharedContentDiffHeight' ) ) || 0

        };
    }

    /**
     * Private:
     * Function: getSharedPosition
     * returns sharedPosition (top | left | right | bottom).
     *
     * Parameters
     *  layout - {XML} The layout tag XML.
     */
    function getSharedPosition(layout) {
        var isVertical = layout.attr('type') == 'vertical',
            isHorizontal = layout.attr('type') == 'horizontal',
            isReadingDirection = layout.attr('tasks_reading_direction') == 'true';

        if (isVertical && isReadingDirection) return 'left';
        if (isVertical && !isReadingDirection) return 'right';
        if (isHorizontal && isReadingDirection) return 'top';
        if (isHorizontal && !isReadingDirection) return 'bottom';
    }

    function getTaskCheckingType(taskType) {
        var type = TaskCheckingType[taskType];
        if (!!!type) {
            type = TaskCheckingType['defaultValue'];
        }
        return type;
    }

    /**
     * Private:
     * Function: getTaskPresenterClass
     * Constructs the name of a Task's presenter class based on its type. The convention of tasks naming is, assuming
     * the type is myType, to change the first latter to upper-case and add 'Task' as suffix. Also the tasks's package
     * name is:   "t2k.player.task." + taskType + ".".    So the end product we get for myType is
     * t2k.player.task.myType.MyTypeTask.
     *
     * Parameters:
     *  taskType - {String} the type.
     */
    function getTaskClass(taskType) {
        var type = taskType[0].toUpperCase() + taskType.substring(1);
        return t2k.player.task[taskType][type + 'Task'];
    } // End of getTaskClass
})();
////////////////////////////////////////
// SRC End --> t2k/player/sequence/Sequence.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/BufferSequenceView.js
////////////////////////////////////////
(function() {

	var TEMPLATE =
		"<div id='{{id}}' class='sequence buffer'>\
			<div id='{{id}}_content' class='buffer_content sequence_content_scrollable'>\
				<div id='{{id}}_creative' class='buffer_creative'/>\
				<div id='{{id}}_text' class='buffer_text'/>\
				<div id='{{id}}_navigation' class='buffer_navigation'>\
					<div id='{{id}}_navigation_content' class='buffer_navigation_content'>\
						<div id='{{id}}_separator' class='buffer_separator'/>\
						<div id='{{id}}_button' class='buffer_button'/>\
					</div>\
				</div>\
			</div>\
		</div>";

	var defaultConfig = {
		/** The default layout used by the player's view */
		layout: 'vertical',
		/** The mustache template to render. */
		template: TEMPLATE
	};

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Class Declaration.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	/**
	 * Class: t2k.player.sequence.SequenceView
	 * The sequence's view.
	 */
	t2k.player.sequence.BufferSequenceView = t2k.core.View.subClass({

		/**
		 * Constructor: ctor
		 * The constructor.
		 *
		 * Parameters:
		 *  config - {Object} The sequence's view configuration.
		 */
		ctor: function(config) {
			// Delegate.
			this._super(copy(config, defaultConfig));

			this.gs = new gridService(this);

		}, // End of ctor


		updateContentLayout: function( hasCreative, hasText ) {

			if( !hasText ) {
				this._text.css({'visibility': 'hidden'});
			}
			this.updateSeparator() ;
		},

		updateSeparator: function() {
			var btnWidth = this._button.width(),
				navWidth = ENV.behaviors.isIE ? this._navigation_content.width()-2 : this._navigation_content.width(),
				navHeight = this._navigation_content.height(),
				sepHeight = this._separator.outerHeight();

			this._separator.css({
				'padding-top': ( navHeight - sepHeight ) / 2 + 'px',
				'width': ( navWidth - btnWidth ) + 'px'
			});
		},

		init:function () {

		},

		removeFromDom:function(){
			this._view.removeClass('show');
			this._view.addClass('hidden');

		},

		addToDom:function(){
			this._view.removeClass('hidden');
			this._view.addClass('show');
		},

		getContentSize: function() {
			return {
				width: this._content.width(),
				height: 'auto'
			};
		}

	}); // End of t2k.player.sequence.SequenceView

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Private Functions.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/BufferSequenceView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/BufferSequence.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.sequence.Sequence
     * A simple sequence, the most basic container of tasks.
     */
    t2k.player.sequence.BufferSequence = t2k.player.sequence.BaseSequence.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.sequence.BufferSequence',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's configuration.
         */
        ctor: function(config) {
        	
        	this.useLayouter = true ;
        	
            // Delegate
            this._super(config);
            
            // notify done for compilation
            if (this.cfg.compileMode){
            	this.dispatchEvent( 'onCompileDone', config ) ;
            }
        },
        
        /**
         * Method: setEnabled
         * De/Activates the presenter. This method sets the view's active state.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
        	
            // Delegate
            this._super(flag);
            
        }, // End of setEnabled

        createView: function() {
        	
        	// reset view (in case it already exists)
            if ( !this.cfg.compileMode ) {
                Perf.select('#' + this.cfg.id, 1).remove();
            }
            
            // Create the view.
        	this.view = new t2k.player.sequence.BufferSequenceView( copy( {}, this.cfg ) ) ;
        },

        initView: function() {
            this.dispatchEvent('setPreloaderOff');
        	this._super() ;
        	
        },
        
        createInnerElements: function( calledFromCompile ) {
        	
        	var thi$ = this ;
        	
        	this.initButton() ;
        	
        	var creativeData = this.getGroupData( 'creative' ) ;
        	var textData = this.getGroupData( 'text' ) ;
        	
        	this.view.updateContentLayout( !!creativeData, !!textData ) ;
        	
        	if( !!creativeData ) {
        		this.creative = this.createGroup( creativeData, 'creative' ) ;
        	}
        	
        	if( !!textData ) {
        		this.text = this.createGroup( textData, 'text' ) ;
        	}
        	
        },
        
        getGroupData: function( groupName ) {

        	var groupData = null,
                groupWrapper = jQuery( this.cfg.data ).find( groupName )[0];

        	if( groupWrapper ) {
        		groupData = jQuery( groupWrapper ).find( 'group' )[0];
        	}
        	
        	return groupData;
        	
        },
        
        createGroup: function( groupData, groupName ) {
        	var groupObject ;
    	
    		CompilerUtils.groupData( groupData ) ;
    		
    		groupObject = new t2k.component.group.Group({
    			data: groupData,
    			parent: this.view[ '_'+ groupName ],
    			layout: this.cfg.layout,
    			useMax: true,
//        			maxSize: groupMaxSize,
    			useLayouter: this.useLayouter,
    			dontEnableBlowup: true,
    			onRendered: function() {
    			},
    			dummyMode : this.cfg.compileMode
    		});

        	return groupObject ;
        },
        
        initButton:function ( progressData ) {
            // Extract the buttons configuration.
            this.button = new t2k.component.buttons.Button(
                copy(	this.getButtonModes(),
                		{ 	style: 'progress_button',
                			parent: this.view._button,
                			onRendered: function() {}
                		} ));
            
            // Init the buttons events
            this.initButtonEvents();
            
            this.button.setVisible( true ) ;
            this.button.setEnabled( true ) ;
        },
        
        getButtonModes: function() {
        	
        	var mode = !this.cfg.isLast ? ( /*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment ? 'next' : 'progress' ) : 'done' ;
        	
        	if( /*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment ) {
        		mode = 'assessment_' + mode ;
        	}

        	var modes = { currMode: mode, states:{} } ;
        	modes.states[ mode ] = { title: LanguageUtil.strings.task.progress.labels[ mode ] } ;
        	
        	return modes ;
        	
        },

        initButtonEvents:function () {
        	
            var thi$ = this;

            var endOfBuffer = function () {
                thi$.progress() ;
            };

            this.button.setClickHandler( 'progress', endOfBuffer ) ;
            this.button.setClickHandler( 'done', endOfBuffer ) ;
            this.button.setClickHandler( 'assessment_next', endOfBuffer ) ;
            this.button.setClickHandler( 'assessment_done', endOfBuffer ) ;
        },

        /**
         * Method: progress
         * Instructs the sequence to move to the next sequence.
         */
        progress: function() {
        	
            this._super() ;
            
        }
        
    }); // End of t2k.player.sequence.Sequence

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    
    
})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/BufferSequence.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/HTMLSequenceView.js
////////////////////////////////////////
(function() {

	var TEMPLATE =
		"<div id='{{id}}' class='sequence html sequence_content_scrollable'>\
			<div id='{{id}}_content' class='html_content pdf_page'>\
				<img id='{{id}}_html_img' class='html_img'/>\
				<div id='{{id}}_html_layer' class='html_layer'/>\
			</div>\
			<div id='{{id}}_navigation' class='html_navigation'>\
				<div id='{{id}}_navigation_content' class='html_navigation_content'>\
					<div id='{{id}}_separator' class='html_separator'/>\
					<div id='{{id}}_button' class='html_button'/>\
				</div>\
			</div>\
		</div>";

	var defaultConfig = {
		/** The default layout used by the player's view */
		layout: 'vertical',
		/** The mustache template to render. */
		template: TEMPLATE
	};

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Class Declaration.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	/**
	 * Class: t2k.player.sequence.SequenceView
	 * The sequence's view.
	 */
	t2k.player.sequence.HTMLSequenceView = t2k.core.View.subClass({

		/**
		 * Constructor: ctor
		 * The constructor.
		 *
		 * Parameters:
		 *  config - {Object} The sequence's view configuration.
		 */
		ctor: function(config) {
			// Delegate.
			this._super(copy(config, defaultConfig));

			this.gs = new gridService(this);

		}, // End of ctor


		updateContentLayout: function( hasCreative, hasText ) {
			this.updateSeparator() ;
		},

		updateSeparator: function() {
			var btnWidth = this._button.width(),
				navWidth = ENV.behaviors.isIE ? this._navigation_content.width()-2 : this._navigation_content.width(),
				navHeight = this._navigation_content.height(),
				sepHeight = this._separator.outerHeight();

//			this._separator.css({
//				'padding-top': ( navHeight - sepHeight ) / 2 + 'px',
//				'width': ( navWidth - btnWidth ) + 'px'
//			});
		},

		init:function () {

		},

		removeFromDom:function(){
			this._view.removeClass('show');
			this._view.addClass('hidden');

		},

		addToDom:function(){
			this._view.removeClass('hidden');
			this._view.addClass('show');
		},

		getContentSize: function() {
			return {
				width: this._content.width(),
				height: 'auto'
			};
		}

	}); // End of t2k.player.sequence.SequenceView

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Private Functions.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/HTMLSequenceView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/HTMLSequence.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.sequence.Sequence
     * A simple sequence, the most basic container of tasks.
     */
    t2k.player.sequence.HTMLSequence = t2k.player.sequence.BaseSequence.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.sequence.HTMLSequence',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's configuration.
         */
        ctor: function(config) {
        	
        	this.useLayouter = false ;
        	
        	var $html = $( config.data ).find( "htmlContent" ) ;
        	this.htmlContent = $html.html() ;
        	this.htmlBG = $html.attr( "bg" ) ;
        	
            // Delegate
            this._super(config);
            
            // notify done for compilation
            if (this.cfg.compileMode){
            	this.dispatchEvent( 'onCompileDone', config ) ;
            }
        },
        
        /**
         * Method: setEnabled
         * De/Activates the presenter. This method sets the view's active state.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
        	
            // Delegate
            this._super(flag);
            
        }, // End of setEnabled

        createView: function() {
        	
        	// reset view (in case it already exists)
            if ( !this.cfg.compileMode ) {
                Perf.select('#' + this.cfg.id, 1).remove();
            }
            
            // Create the view.
        	this.view = new t2k.player.sequence.HTMLSequenceView( copy( {}, this.cfg ) ) ;
        },

        initView: function() {
            this.dispatchEvent('setPreloaderOff');
        	this._super() ;
        	
        },
        
        createInnerElements: function( calledFromCompile ) {
        	
        	var thi$ = this ;
        	
        	this.view._html_img.attr( "src", AbsPath( this.htmlBG ) ) ;
        	this.view._html_layer.html( this.htmlContent ) ;
        	
        	this.initButton() ;
        	
        	this.view.updateContentLayout() ;
        	
        },
        
        initButton:function ( progressData ) {
            // Extract the buttons configuration.
            this.button = new t2k.component.buttons.Button(
                copy(	this.getButtonModes(),
                		{ 	style: 'progress_button',
                			parent: this.view._button,
                			onRendered: function() {}
                		} ));
            
            // Init the buttons events
            this.initButtonEvents();
            
            this.button.setVisible( true ) ;
            this.button.setEnabled( true ) ;
        },
        
        getButtonModes: function() {
        	
        	var mode = !this.cfg.isLast ? ( /*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment ? 'next' : 'progress' ) : 'done' ;
        	
        	if( /*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment ) {
        		mode = 'assessment_' + mode ;
        	}

        	var modes = { currMode: mode, states:{} } ;
        	modes.states[ mode ] = { title: LanguageUtil.strings.task.progress.labels[ mode ] } ;
        	
        	return modes ;
        	
        },

        initButtonEvents:function () {
        	
            var thi$ = this;

            var endOfHTML = function () {
                thi$.progress() ;
            };

            this.button.setClickHandler( 'progress', endOfHTML ) ;
            this.button.setClickHandler( 'done', endOfHTML ) ;
            this.button.setClickHandler( 'assessment_next', endOfHTML ) ;
            this.button.setClickHandler( 'assessment_done', endOfHTML ) ;
        },

        /**
         * Method: progress
         * Instructs the sequence to move to the next sequence.
         */
        progress: function() {
        	
            this._super() ;
            
        }
        
    }); // End of t2k.player.sequence.Sequence

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    
    
})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/HTMLSequence.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/URLSequenceView.js
////////////////////////////////////////
(function() {

	var TEMPLATE =
		"<div id='{{id}}' class='sequence html sequence_content_scrollable'>\
			<div id='{{id}}_content' class='html_content pdf_page'>\
				<iframe id='{{id}}_url_sequence_iframe' class='url_sequence_iframe' src='{{src}}'/>\
			</div>\
			<div id='{{id}}_navigation' class='html_navigation'>\
				<div id='{{id}}_navigation_content' class='html_navigation_content'>\
					<div id='{{id}}_separator' class='html_separator'/>\
					<div id='{{id}}_button' class='html_button'/>\
				</div>\
			</div>\
		</div>";

	var defaultConfig = {
		/** The default layout used by the player's view */
		layout: 'vertical',
		/** The mustache template to render. */
		template: TEMPLATE
	};

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Class Declaration.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	/**
	 * Class: t2k.player.sequence.SequenceView
	 * The sequence's view.
	 */
	t2k.player.sequence.URLSequenceView = t2k.core.View.subClass({

		/**
		 * Constructor: ctor
		 * The constructor.
		 *
		 * Parameters:
		 *  config - {Object} The sequence's view configuration.
		 */
		ctor: function(config) {
			// Delegate.
			this._super(copy(config, defaultConfig));

			this.gs = new gridService(this);

		}, // End of ctor


		updateContentLayout: function( url ) {
			this.setIframeSrc(url, this.getContentSize());
		},

		setIframeSrc: function (url, size) {
			var p = this._view.find('.url_sequence_iframe').parent(),
				tmpIframe = this._view.find('.url_sequence_iframe'),
				thi$ = this;

			tmpIframe.remove();

			p.append("<iframe id='"+thi$.cfg.id
				+"_url_sequence_iframe' class='url_sequence_iframe' src='"
				+url+"' width='"+size.width+"' height='"+size.height+"' />");
		},

		getContentSize: function() {
			return {
				width: this.cfg.width,
				height: (this.cfg.height - 1.5 * this._navigation.context.clientHeight)
			};
		},

		init:function () {

		},

		removeFromDom:function(){
			this._view.removeClass('show');
			this._view.addClass('hidden');

		},

		addToDom:function(){
			this._view.removeClass('hidden');
			this._view.addClass('show');
		}

	}); // End of t2k.player.sequence.SequenceView

	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	// Private Functions.
	// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/URLSequenceView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/sequence/URLSequence.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

//    add here...

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.sequence.Sequence
     * A simple sequence, the most basic container of tasks.
     */
    t2k.player.sequence.URLSequence = t2k.player.sequence.BaseSequence.subClass({

        /** The class' name (for debugging purpose). */
        name: 't2k.player.sequence.URLSequence',

        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The sequence's configuration.
         */
        ctor: function(config) {
        	
        	this.useLayouter = false ;
        	
        	/*var $html = $( config.data ).find( "htmlContent" ) ;
        	this.htmlContent = $html.html();*/
        	
            // Delegate
            this._super(config);
            
            // notify done for compilation
            if (this.cfg.compileMode){
            	this.dispatchEvent( 'onCompileDone', config ) ;
            }
        },
        
        /**
         * Method: setEnabled
         * De/Activates the presenter. This method sets the view's active state.
         *
         * Parameters:
         *  flag - {Boolean} True for active, false otherwise.
         */
        setEnabled: function(flag) {
        	
            // Delegate
            this._super(flag);
            
        }, // End of setEnabled

        createView: function() {
        	
        	// reset view (in case it already exists)
            if ( !this.cfg.compileMode ) {
                Perf.select('#' + this.cfg.id, 1).remove();
            }
            
            // Create the view.
        	this.view = new t2k.player.sequence.URLSequenceView( copy( {}, this.cfg ) ) ;
        },

        initView: function() {
            this.dispatchEvent('setPreloaderOff');
        	this._super();        	
        },
        
        createInnerElements: function( calledFromCompile ) {
        	
        	var thi$ = this,
                tmpUrl = thi$.cfg.data.children[0].src ? thi$.cfg.data.children[0].src : "http://www.timetoknow.com/404";
        	this.initButton();        	
        	this.view.updateContentLayout(tmpUrl);
        },
        
        initButton:function ( progressData ) {
            // Extract the buttons configuration.
            this.button = new t2k.component.buttons.Button(
                copy(	this.getButtonModes(),
                		{ 	style: 'progress_button',
                			parent: this.view._button,
                			onRendered: function() {}
                		} ));
            
            // Init the buttons events
            this.initButtonEvents();
            
            this.button.setVisible( true ) ;
            this.button.setEnabled( true ) ;
        },
        
        getButtonModes: function() {
        	
        	var mode = !this.cfg.isLast ? ( /*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment ? 'next' : 'progress' ) : 'done' ;
        	
        	if( /*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment ) {
        		mode = 'assessment_' + mode ;
        	}

        	var modes = { currMode: mode, states:{} } ;
        	modes.states[ mode ] = { title: LanguageUtil.strings.task.progress.labels[ mode ] } ;
        	
        	return modes ;
        	
        },

        initButtonEvents:function () {
        	
            var thi$ = this;

            var endOfHTML = function () {
                thi$.progress() ;
            };

            this.button.setClickHandler( 'progress', endOfHTML ) ;
            this.button.setClickHandler( 'done', endOfHTML ) ;
            this.button.setClickHandler( 'assessment_next', endOfHTML ) ;
            this.button.setClickHandler( 'assessment_done', endOfHTML ) ;
        },

        /**
         * Method: progress
         * Instructs the sequence to move to the next sequence.
         */
        progress: function() {
        	
            this._super() ;
            
        }
        
    }); // End of t2k.player.sequence.Sequence

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    
    
})();



////////////////////////////////////////
// SRC End --> t2k/player/sequence/URLSequence.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/SequencePlayer.js
////////////////////////////////////////
(function () {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	/** Busy means player cannot process navigation events. */
	var isBusy = true;

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

	t2k.player.SequencePlayer = t2k.core.FlowPresenter.subClass({

		/** The class' name (for debugging purpose). */
		name:'t2k.player.SequencePlayer',

		/**
		 * Constructor: ctor
		 * The constructor. Responsible for setting the player's view and instantiating the sequences.
		 *
		 * Parameters:
		 *  config - {Object} The Player's configuration.
		 */
		ctor:function (config, callback) {
			
			var $seqData = $(config.data) ;
			
			config.sequencesConfig = [ {
				id: $seqData.attr('id') || "SEQQQ",
				type: $seqData.attr('type'),
				data: config.data
			} ] ;
			
			
			// Delegate
			this._super(config);
			
			this.cfg.activeChild = 0 ;
			
			this.config = config;
			this.ctorCallback = callback;
			this.aiPaused = false;
			this.wasPlayingBeforeSuspend = false;
			this.staticData;

			// Closure refs.
			var thi$ = this, cfg = this.cfg
			
			
//			this.initAssessmentModes();

			// set external media player by configurtion
			if (this.cfg.initData.useExternalMediaPlayer){

				// set behavior
				ENV.behaviors.useExternalMediaPlayer = true;

				// add phonegap servuce
				EXT_SERVICES.add('playMovie', function(src){
					ENV.host.playMovie( src );
				});

				EXT_SERVICES.add('playAudio', function( src, stopHandler, context ){
					ENV.host.playAudio( src, stopHandler, context );
				});

				EXT_SERVICES.add('stopAudio', function(){
					ENV.host.stopAudio();
				});

				// switch mediaPlayer to external MediaPlayer
				componentFactory.setClassNameByCompName('mediaplayer', 't2k.component.mediaPlayer.ExternalMediaPlayer');
			}

			
			// set ENV.REM
			ENV.REM = jQuery('html').css('font-size').px2int();

			//set ENV.viewMode
			ViewModesUtil.setMode(cfg.viewMode, cfg.userInfo.role);

			this.setVolume( parseFloat( config.volume ) ) ;

			if (/*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment) {
				this.assessmentManager = new t2k.util.managers.AssessmentManager();
			}

//			this.pathToDataLib = getPathToDataLib(config.rootXml.baseURI ||
//				config.rootXml.documentElement.getAttribute('baseURI'));

			this.tasksCount = [];
			this.firstChildIndexArray = [];
			extractData(this.cfg.sequencesConfig, this.tasksCount, this.firstChildIndexArray);
//			this.sequenceCount = this.cfg.sequencesConfig.length;
			this.sequenceCount = 1;
			this.compiledCfg = [];

			// Create the view.
			this.view = new t2k.player.PlayerView({ width:cfg.width, height:cfg.height, scale:cfg.scale });

			//create an array that manages the sequences
			this.createdSequences = [];
			this.sequencesstateSet = [];
			this.sequencesDetails = [];
//			for (var i = 0; i < this.sequenceCount; i++) {
//				this.sequencesDetails[i] = {
			this.sequencesDetails.push( {
				sequenceObject:null,
				stateSet:false
			} ) ;
//			}
			// this is to hold the state that was set last
			this.lastSetState;


			// Create the balloon.
			t2k.util.balloon = new t2k.component.balloon.Balloon({ parent:this.view, onRendered:function () {
			} });

			var sendStaticData = config.initData.isStaticDataNeeded;
			if (sendStaticData)
				var sequencesStaticData = getMissionStaticData(this.cfg);

			if (/*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment && this.assessmentManager) {
				this.assessmentManager.parseAssessmentData(this.cfg);
				if (sendStaticData) {
					sequencesStaticData = this.updateRubrics(sequencesStaticData);
				}

				//for testing only
				//this.assStateTest = this.assessmentManager.getAssessmentState();

			}

			// Create the sequences. For each sequence provide its configuration.
			//create only the first sequence

			var index = 0;

			// Create the progress-bar.
//			this.progressBar = new t2k.controls.ProgressBar({
//				tasksCount:thi$.tasksCount,
//				parent:this.view._navigation,
//				size:this.cfg.sequencesConfig.length,
//				events:{
//					progressTo:function (index) {
//						thi$.navigateToSequence(index);
//					}
//				}
//			});

			this.view.updateContentSize();

			this.isLoadingSequence = false;

			if (this.cfg.compileOnly) {
				this.compileOnly(index);
				return;
			}


//			if (this.cfg.playOnly) {
//				this.createAfterCompile(index, false);
//			} else {
				var compiledSeq = this.createSequence(index, true, false);
//			}

			//now waiting For finishing compilation
			//for testing only dtp call
			//this.setAssessmentStateInput(this.assStateTest);

			// If a callback was provided then call it, providing this (the player).
			// send static data to callback as well
			 this.staticData = sendStaticData ? this.getStaticData(sequencesStaticData) : null;
			//if (callback) callback(this, staticData);
			/*setTimeout(function () {
				if (callback) callback(thi$, staticData);
			}, 1000);*/

			this.disableBrowserBack();
			
			ENV.Modal = new t2k.component.modal.Modal() ;

			SOUND.create();

			var thi$ = this ;
			
			this.debugInfoClosed = true ;
			
			function toggleDebugInfo() {
				
				if( thi$.debugInfoClosed ) {
					
					var versionData = ENV.debug.version ;
					var debugString = "" ;
					
					debugString += "build info:" ;
					debugString += "</br>" ;
					debugString += "<ul>" ;
					debugString += "<li>" ;
					debugString += "version: " + versionData.number ;
					debugString += "</li>" ;
					debugString += "<li>" ;
					debugString += "time: " + versionData.time ;
					debugString += "</li>" ;
					debugString += "<li>" ;
					debugString += "revision: " + versionData.revision ;
					debugString += "</li>" ;
					debugString += "<li>" ;
					debugString += "user: " + versionData.userName ;
					debugString += "</li>" ;
					debugString += "<li>" ;
					debugString += "host: " + versionData.hostName ;
					debugString += "</li>" ;
					debugString += "</ul>" ;
					
					debugString += "</br>" ;
					
					debugString += "runtime info:" ;
					debugString += "</br>" ;
					debugString += "<ul>" ;
					debugString += "<li>" ;
					debugString += "size: " + thi$.cfg.width + "x" + thi$.cfg.height ;
					debugString += "</li>" ;
					debugString += "</ul>" ;
					
//					debugString += "</br>" ;
//					debugString += "<a href='http://jira.timetoknow.com/secure/CreateIssueDetails!init.jspa?" +
//					
//								"pid=11070" +
//								"&issuetype=2" +
//								"&summary=LIRON.Z TEST" +
//								"&description=description+goes+here" +
//								
//								"' target='_blank'>report</a>" ;
					
					$(this).addClass( "show" ) ;
					
					$(this).html( debugString ) ;
					
					$(this).pep({constrainTo:'parent', debug: false});
					
				} else {
					
					$(this).removeClass( "show" ) ;
					
					$(this).html( "" ) ;
					
		            $.pep.unbind( $(this) );
				}
				
				thi$.debugInfoClosed = !thi$.debugInfoClosed ;
			} ;
			
			if( !ENV.behaviors.touch ) {
				$( this.view._debug ).dblclick( toggleDebugInfo ) ;
			} else {
//				$( this.view._debug ).taphold( toggleDebugInfo ) ;
				$( this.view._debug ).click( toggleDebugInfo ) ;
			}
			
			// set swipe events - only on tablets
			if (ENV.behaviors.setSwipeEvents){

				$(this.view._view).swipeleft(function () {
					if (!dndManager.isInDragMode()) {
						ENV.host.onSwipe("left");
					}
				});

				$(this.view._view).swiperight(function () {
					if (!dndManager.isInDragMode()) {
						ENV.host.onSwipe("right");
					}
				});

			}

		}, // End of ctor
		
		destroy: function() {

			var body = document.getElementsByTagName('body')[0];
			var all_body_nodes = body.getElementsByTagName('*'), child, l = all_body_nodes.length;

			//iterate and delete all body nodes
			for (var i = l - 1; i >= 0; i--) {
				child = all_body_nodes[i];
				child && child.parentNode && child.parentNode.removeChild(child);
			}

			jQuery(body).unbind();
			jQuery(document).unbind();

			body = null;
			all_body_nodes = null;

			this.dispose();

		},

		// compileOnly:function (i) {

		// 	var thi$ = this;

		//	 if (i != this.sequenceCount) {
		//		 this.createSequence(i, true, false);
		//		 return

		//	 } else {
		//		 //if we have finished compiling
		//		 this.compilationResult = {};
		//		 this.compilationResult['root.xml'] = jQuery.xmlToString(this.cfg.rootXml);

		//	 }


		//	 this.compilationResult['root.xml'] = jQuery.xmlToString(this.cfg.rootXml);

		//	 this.compiledCfg.forEach(function (seq) {
		//		 thi$.compilationResult[seq.configPath] = jQuery.xmlToString(seq.data);
		//	 });

		//	 this.callCtorCallback() ;
		// },
		
		callCtorCallback: function() {
			
			var thi$ = this ;
			
			if ( this.ctorCallback ) {
				
				// setTimeout( function() {
					
					thi$.ctorCallback( thi$, thi$.staticData ) ;
					
				// }, 0 ) ;
				
			}
			
		},

		/**
		 * Query and set busy on self.
		 * Busy means progress bar should not process clicks
		 * (e.g. while sequence is being loaded / rendered).
		 */
		busy:function (arg) {
			if (typeof arg == 'boolean') {
				isBusy = arg;
//				this.progressBar.busy(isBusy);
			}
			return isBusy;
		},


		firstScreenLoadedAndViewed:function(){
			this.firstScreenLoaded = true;

			this.callCtorCallback() ;
		},


		/**
		 * disableBrowserBack function
		 */
		disableBrowserBack:function () {
			jQuery(document).keydown(function (e) {
				if (e.keyCode == '8' && e.target.tagName.toUpperCase() != "INPUT" && e.target.tagName.toUpperCase() != "TEXTAREA") {
					e.preventDefault();
				} // keyCode(8) = Backspace
			});
		},

		/* initAssessmentModes: function() {
		 AssessmentENV.setModes(this.cfg.isAssessmentMode == 'true', this.cfg.assessmentMode);
		 },*/

		createAfterCompile:function (index, fromNavigate) {
			var thi$ = this;
			var seq = this.createSequence(index, false, fromNavigate);

			thi$.add(seq);
			thi$.sequencesDetails[index].sequenceObject = seq;

			if (!fromNavigate) {

				// Sets the current state as provided as part of the configuration. If the configuration doesn't contain
				// state then the player defaults its state to the first task of the first sequence.
				//this.setState(this.cfg.state);
			} else {
				//add the new sequence
				seq.view.addToDom();
			}
			this.activateSequence(index);

			this.PlayerMute(this.cfg.initData.volume === 0);

			return seq
		},

		PlayerMute: function (mute){

			if (mute)
			{
				$('audio').attr('muted',true);
				$('video').attr('muted',true);
			}
		},

		activateSequence:function (index) {

			this.cfg.activeChild = index;
			var currSequence = this.sequencesDetails[index].sequenceObject;


			//set the new sequence state
			if (!this.sequencesDetails[index].stateSet) {
				this.setSequenceState(currSequence, index);
			}

			if (currSequence) {
				currSequence.setEnabled(true);
				// send screen swapped event
//				ENV.host.onSequenceSwapped( index ) ;
				
				if( ENV.viewMode.isAssessment && this.assessmentManager ) {
					this.assessmentManager.updateSequenceRubric( index ) ;
				}
				
			} else {
				// 2d0 ToDo Send Activity Item Done to Host
				// Note: This code should never be called. progress() should do that...
				ENV.host.onDone();
			}

			return !!currSequence;
		},

		getSequenceClass:function (seqType, compileMode) {

			var seqClass;

			switch (seqType) {

				case 'buffer' :
					seqClass = t2k.player.sequence.BufferSequence;
					break;

				case 'url_sequence' :
					seqClass = t2k.player.sequence.URLSequence;
					break;

				case 'html' :
					seqClass = t2k.player.sequence.HTMLSequence;
					break;

				default :
//					if (compileMode) {
//						seqClass = t2k.compilePlay.SequenceCompilePlay;
//					} else {
						seqClass = t2k.player.sequence.Sequence;
//					}
					break;
			}

			return seqClass;
		},
		
		fireState: function( success, error, sendLogs ) {
			var currSequence = this.sequencesDetails[ this.cfg.activeChild ].sequenceObject;
			currSequence.fireState( success, error, sendLogs ) ;
		},
		
		getState: function( callback ) {
			var currSequence = this.sequencesDetails[ this.cfg.activeChild ].sequenceObject;
			currSequence.getStateWithCallback( callback ) ;
		},

		// called by host or by constructor.
		// if called by host - performs state injection
		// sequenceNumber = active sequence override (in case of state injection)
		setState:function (xmlStr, callback) {
			this._super(xmlStr);
			var sequenceIndex = 0 ;

			this.sequencesDetails[0].stateSet = false;

			// Handle the state or set the default.
			if (!!xmlStr) {

				this.lastSetState = xmlStr;
				
				var seqState = $(xmlStr)[0] ;
				
				if (this.sequencesDetails[0].sequenceObject && !this.sequencesDetails[0].stateSet) {
					this.sequencesDetails[0].sequenceObject.setState(seqState);
					this.sequencesDetails[0].stateSet = true;
				}


			} else {
				// Handle the sequence.
				this.cfg.activeChild = 0;
				if (this.sequencesDetails[0].sequenceObject && !this.sequencesDetails[0].stateSet) {
					this.sequencesDetails[0].sequenceObject.setState(null);

				}

				if (!this.sequencesDetails[0].sequenceObject.isEnabled()) {
					this.sequencesDetails[0].sequenceObject.setEnabled(true);
				}

				this.navigateToSequence( 0 ) ;
			}


			if( callback ) {
				callback() ;
			}
		},


		setSequenceState:function (sequence, index) {
			if (this.lastSetState) {
				var player = jQuery(this.lastSetState);
				var sequencesWrapper = jQuery(player).find('sequences');
				var sequenceState, sequences = sequencesWrapper.children();
				sequenceState = jQuery(sequences[index]);
				if (!this.sequencesDetails[index].stateSet) {
					sequence.setState(sequenceState);
					this.sequencesDetails[index].stateSet = true;
				}
			} else {
				sequence.setState(null);
				this.sequencesDetails[index].stateSet = true;
			}
		},


		/*
			this function is to reset to initial state( i.e no state applied) of all levels of hierarchy, this will be called before setState
		 */
		resetState:function(){
			for (var i = 0; i < this.sequencesDetails.length; i++) {
				if (this.sequencesDetails[i].sequenceObject) {
					this.sequencesDetails[i].sequenceObject.resetState();

				}

			}
		},


		/**
		 * Method: progress
		 * Instructs the sequence to move to the next task.
		 */
		navigateToSequence:function (index) {

			// if (this.busy()) return;
			// else this.busy(true);

			var thi$ = this;
			var cfg = this.cfg;

			// dump existing sequence
			// this.sequencesDetails[this.cfg.activeChild].sequenceObject.setEnabled(false);
			// this.sequencesDetails[this.cfg.activeChild].sequenceObject.view.removeFromDom();

//			this.progressBar.selectItem(index);

			//if wanted sequence is already created
			if (this.sequencesDetails[index].sequenceObject) {

				// this.busy(false);

				this.cfg.activeChild = index;
				var currSequence = this.sequencesDetails[index].sequenceObject;

				if (currSequence) {


					if (index === this.cfg.activeChild) {
						currSequence.view.addToDom();
						currSequence.setEnabled(true);

						// send screen swapped event
//						ENV.host.onSequenceSwapped( index ) ;
						if( ENV.viewMode.isAssessment && this.assessmentManager ) {
							this.assessmentManager.updateSequenceRubric( index ) ;
						}
					}

				} else {
					// 2d0 ToDo Send Activity Item Done to Host
					// Note: This code should never be called. progress() should do that...
					ENV.host.onDone();
				}
			} else {

//				if (thi$.cfg.playOnly) {
//					var compiledSeq = thi$.createAfterCompile(index, true);
//				} else {
					var compiledSeq = thi$.createSequence(index, true, true);
//				}


			}
		},

		setPreloader:function (flag) {
			var thi$ = this;

			if (this.isLoadingSequence != flag) {
				/* Callback is used to unset isBusy on ProgressBar, so it can process clicks. */
				this.view.setPreloader(flag, flag || function () {
					thi$.busy(false);
				});
				this.isLoadingSequence = flag;
			}
		},

		createSequence:function (index, compileMode, fromNavigate) {

			var thi$ = this;
			thi$.setPreloader(true);

			var cfg = this.cfg;
			var navHeight = this.view._navigation.outerHeight();
			var seqHeight = cfg.height - navHeight;
			var sequenceCfg;

			if (!compileMode) {
				if (this.cfg.playOnly) {
					//this is when we load data that is already a result of pre compilation
					sequenceCfg = jQuery(cfg.sequencesConfig)[index];
				} else {
					//this is when complaying
					sequenceCfg = this.compiledCfg[index];
				}

				if (/*AssessmentENV.isAssessmentModeReview*/ ENV.viewMode.teacherIndication && !!this.assessmentTeacherIndicationDataArray) {
					for (var i = 0; i < this.assessmentTeacherIndicationDataArray.length; i++) {
						if (this.assessmentTeacherIndicationDataArray[i].screenId == index) {
							var assessTeacherIndication = this.assessmentTeacherIndicationDataArray[i].indicated;
						}
					}
				}
			} else {
				sequenceCfg = jQuery(cfg.sequencesConfig)[index];
			}

			var seqClass = this.getSequenceClass(sequenceCfg.type, compileMode);

			var isLast = this.cfg.isLast ; //index == ( this.sequenceCount - 1 );

			var seq = new seqClass(override(
				sequenceCfg, {
					index:index,
					isLast:isLast,
					firstTaskIndex:this.cfg.firstTaskNumber || 1,//ENV.taskIndexPerSeq ? 1 : thi$.firstChildIndexArray[index],
					focusOnTask: this.cfg.focusOnTask,
					taskIndexType:ENV.taskIndexType,
					parent:thi$.view,
					width:cfg.width * 1,
					height:seqHeight * 1,
					dataLibPath:thi$.pathToDataLib,
					compileMode:compileMode,
					teacherIndication:assessTeacherIndication,
					direction: ENV.interfaceDirection,
					overrideOptions: this.cfg.overrideOptions,
					events:{
						/*onReady:function (sequence) {

						 *//*if (thi$.cfg.playOnly) {
						 thi$.add(this);
						 thi$.sequencesDetails[ index ].sequenceObject = this;
						 thi$.activateSequence(index);
						 thi$.setPreloader(false);
						 }*//*
						 thi$.setPreloader(false)


						 },*/

						setPreloaderOff:function () {
							thi$.setPreloader(false);

							if( index == 0 ){
								thi$.firstScreenLoadedAndViewed();
							}
						},

						onAssessmentTaskCreated:function (responseObj) {
							if (/*AssessmentENV.isAssessmentMode*/ ENV.viewMode.isAssessment && thi$.assessmentManager) {
								thi$.assessmentManager.addRealTaskInstanceToArray(index, responseObj.taskIndex, responseObj.task);
							}
						},
						onNextSequence:function () {
//							thi$.progressBar.setDone(thi$.cfg.activeChild);
							thi$.progress();
//							thi$.progressBar.setCurrentSequence(thi$.cfg.activeChild);
						},
						onCompileDone:function (compiledCfg) {

							var killPreLoader = false;

							if (compileMode) {
								thi$.compiledCfg[index] = compiledCfg;

								if (thi$.cfg.compileOnly && ((index + 1) <= thi$.sequenceCount)) {
									thi$.compileOnly(index + 1);

									//in case of Compile only - if we got to the last sequence now - kill preloader and navigate to the first sequence
									if ((index + 1) == thi$.sequenceCount) {
										thi$.createAfterCompile(0, fromNavigate);
										killPreLoader = true;
									}

								} else {
									//in case of ComPlay
									thi$.createAfterCompile(index, fromNavigate);
									killPreLoader = true;
								}

								if (killPreLoader) {
									thi$.setPreloader(false);
								}
							}

						},
//						seqAssessmentCompletedMode:function (flag) {
//							if (/*AssessmentENV.isAssessmentModeTest*/ ENV.viewMode.seqeunceCompletionIndication && thi$.assessmentManager) {
//								thi$.setAssessmentNavigatorMarks('completed', index, flag);
//							}
//						},
//
//						seqAssessmentFlagMode:function (bool) {
//							if (/*AssessmentENV.isAssessmentModeTest*/ ENV.viewMode.studentFlagTask && thi$.assessmentManager) {
//								thi$.setAssessmentNavigatorMarks('flag', index, bool);
//							}
//						}
					}
				}
			));

			this.add(seq);
			this.sequencesDetails[0].sequenceObject = seq;

			return seq;
		},

		progress:function () {
			var nextSequence = this.cfg.activeChild + 1;

			if (nextSequence >= this.sequenceCount || nextSequence < 0) {
				// send 'done' event to host
				ENV.host.onDone();
			} else {
				this.navigateToSequence(nextSequence);
//				this.progressBar.progress();
			}

			/* if (this.children[ nextSequence ]) {
			 this.navigateToSequence(nextSequence);
//			 this.progressBar.progress();
			 } else if (nextSequence >= this.children.length || nextSequence < 0) {
			 // send 'done' event to host
			 ENV.host.onDone();
			 }*/
		},

		getStaticData:function (sequencesStaticData) {
			return	 '<LoData>' +
				'<loId>' + this.cfg.initData.loId + '</loId>' +
				'<atomsList>' + sequencesStaticData + '</atomsList>' +
				'</LoData>';
		},

		showGrid:function (type, show) {
			this.children[this.cfg.activeChild].showGrid(type, show);
		},

		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// External API calls
		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// management functions

		suspend:function () {

			// stop all sounds if external services exists
			EXT_SERVICES.get('stopAudio')();
			
			// just pause all running media, if relevant
			//check if it was playing before pause
			if(mediaManager.currentItem && !mediaManager.currentItem.paused){
				this.wasPlayingBeforeSuspend = true;
				mediaManager.pause();
			}else{
				this.wasPlayingBeforeSuspend = false;
			}

		},

		resume:function () {
			// resume running media
			//if suspend caused media player to pause itself make it play again
			if(this.wasPlayingBeforeSuspend){
				mediaManager.play();
			}

		},

		pauseAi:function () {
			if (this.view) {

				if(!this.aiPaused) {
					mediaManager.pause();
					this.view.pauseAi(true);
					this.aiPaused = true;
				}

			}
		},

		resumeAi:function () {
			if (this.view) {
				if (this.aiPaused) {
					mediaManager.play()
					this.view.resumeAi(false);
					this.aiPaused = false;
				}

			}
		},

		setVolume:function (volume) {
			// set volume (media manager)
			mediaManager.setVolume(volume);
		},

		getVolume:function () {
			// get volume (media manager)
			mediaManager.getVolume();
		},

		terminate:function () {
			// perform reset() to container?
		},

		goToSequence:function (index) {
			if (!!this.sequencesDetails[ index ]) {
				this.navigateToSequence(index);
			}
		},

		// container injection
		endActivity:function () {
			// this is for 'container' injection - clear resources
		},

		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// assessment functions:

		setAssessmentStateInput:function (atomsList) {
			var thi$ = this;
			var assessmentState = Perf.create("assessmentState");

			for (var i = 0; i < atomsList.length; i++) {
				var indication = false;
				var atom = atomsList[i];


				//if the task is not ped task and has valid rubric id and no score then we set indication to be true
				if (atom.rubricId != "null" && atom.rubricId && atom.rubricId != '' != null) {
					if (atom.score == "null" || atom.score == null || atom.manCheck) {
						indication = true;
					}
					var screenId = thi$.getScreenByRubric(atom.rubricId);
					var screen = Perf.create("screen");
					screen.attr('screenId', screenId);
					screen.attr('indicated', indication);
					assessmentState.append(screen);
				}

			}


			thi$.setTeacherNavigatorIndication(assessmentState);
		},


		getAnswersViewMode:function () {

		},

		setTeacherNavigatorIndication:function (indicationDataXml) {
//			if (this.progressBar) {
//				var thi$ = this;
//				var indicationData = [];
//
//				var screens = indicationDataXml.find('screen');
//				jQuery(screens).each(function (index, screen) {
//					var indicated = jQuery(screen).attr('indicated');
//					var screenId = jQuery(screen).attr('screenId');
//
//					if (indicated == 'true') {
//						indicationData.push({indicated:true, screenId:screenId });
//						if (!!thi$.sequencesDetails && thi$.sequencesDetails[parseInt(screenId)].sequenceObject) {
//							thi$.sequencesDetails[parseInt(screenId)].sequenceObject.setAssessmentTeacherIndication(true);
//						}
//						//thi$.setIndicated(screenId, true);
//					} else {
//						indicationData.push({indicated:false, screenId:screenId });
//						if (!!thi$.sequencesDetails && thi$.sequencesDetails[parseInt(screenId)].sequenceObject) {
//							thi$.sequencesDetails[parseInt(screenId)].sequenceObject.setAssessmentTeacherIndication(false);
//						}
//						//thi$.setIndicated(screenId, false);
//					}
//				});
//				this.assessmentTeacherIndicationDataArray = indicationData;
//				this.progressBar.setNavigatorIndication(indicationData);
//			}
		},

		setAssessmentNavigatorMarks:function (markType, seqId, flag) {
//			if (this.progressBar) {
//				this.progressBar.setAssessmentNavigatorMarks(markType, seqId, flag);
//			}
		},

		/*
		 * TODO change name according to api to sequence
		 * */
		getScreenByRubric:function (rubricId) {
			var screenId = this.assessmentManager.getSequenceByRubricId(rubricId);
			if (screenId != null) {
				return screenId
			} else {
				return 0; //like in Tre			}
			}
		},

		/*
		 update the static data with the rubrics id if needed
		 */
		updateRubrics:function (staticDataString) {
			var thi$ = this;
			var jdata = jQuery(staticDataString);
			var returnedString = '';
			jQuery(jdata).each(function (index, taskStaticData) {
				//get the seq index of the task
				var taskId = jQuery(taskStaticData).find('atomid').text();
				var indexText = jQuery(taskStaticData).find('atomindex').text();
				var tmpArr = indexText.split('.');
				var seqIndex = parseInt(tmpArr[0]) - 1;
				var taskIndex = parseInt(tmpArr[1]) - 1; //the -1 s to get the real index

				var rubricIdValue = thi$.assessmentManager.getRubricFromIndex(seqIndex, taskIndex, taskId);
				//TODO decide if rubricPath of pedTak is '' or a real path
				jQuery(jdata[taskIndex]).find('rubricid').text(rubricIdValue);
				/*} else {
				 jQuery(jdata[taskIndex]).find('rubricid').text('');
				 }*/
				returnedString += jQuery.xmlToString(jdata.get(taskIndex));
			});
			return returnedString;


		},


		/*
		 * this function in assessmentMode suppose to add the rubrics data to the static data after parsing the
		 * */
		/*
		 updateRubricsInStaticDate:function(){

		 },*/
		/*
		 returns an object
		 */
		fetchResult:function () {
			if (/*AssessmentENV.isAssessmentMode*/ENV.viewMode.isAssessment && !!this.assessmentManager) {
				return this.assessmentManager.fetchResult();
			} else {
				//need to have an error handler here
				return
			}
		},

		cleanView:function () {
			this.view.cleanView();
		},

		focusOnTask: function( taskCid, externalCall, success ) {
			//get active sequence object
			var activeSequence = this.children[this.cfg.activeChild];
			activeSequence.progressToTask( taskCid, externalCall, success ) ;
		},
		
		setTasksScores: function( tasksScores ) {
			var activeSequence = this.children[this.cfg.activeChild];
			activeSequence.setTasksScores( tasksScores ) ;
		}


	}); // End of t2k.player.Player

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	/**
	 * TODO
	 */
	function extractTaskCount(cfg) {

		var result = [];
		jQuery(cfg).each(function (index, sequenceCfg) {
			var tasksConfig = jQuery(sequenceCfg.data).find("task");
			var length = jQuery(tasksConfig).length;
			result[index] = length
		});

		return result;
	}

	/**
	 * TODO
	 */
	function extractData(cfg, tasksCount, firstChildIndexArray) {

		var result = [];
		jQuery(cfg).each(function (index, sequenceCfg) {
			var tasksConfig = jQuery(sequenceCfg.data).find("task");
			var length = jQuery(tasksConfig).length;
			var firstChildIndex
			if (index == 0) {
				firstChildIndex = 1;
			} else {

				firstChildIndex = firstChildIndexArray[index - 1] + tasksCount[index - 1];
			}

			firstChildIndexArray[index] = firstChildIndex;
			tasksCount[index] = length;

		});

	}

	function getAttempts(taskCfg) {
		var jXml = jQuery(taskCfg);
		var attemptsXml = jXml.children('attempts');

		if (attemptsXml.length == 0) {
			var defaultProgressData = ENV.defaultTaskProgress;
			attemptsXml = defaultProgressData.children('attempts');

		}
		var parseRes = parseInt(attemptsXml.text());
		var attempts = (!!!parseRes) ? 0 : parseRes;

		return attempts;

	}

	function getTaskCheckingType(taskType) {


		var type = TaskCheckingType[taskType];
		if (!!!type) {
			type = TaskCheckingType['defaultValue'];
		}

		return type;
	}

	function extractFirstTaskIndexes(cfg) {
		var result = [];
		jQuery(cfg).each(function (index, sequenceCfg) {

			var tasksConfig = jQuery(sequenceCfg.data).find("task");
			var length = jQuery(tasksConfig).length;
			var firstChildIndex = length
			if (index != 0) {
				firstChildIndex += result[index - 1];
			}
				
			result[index] = firstChildIndex;


		});
	}
})();
////////////////////////////////////////
// SRC End --> t2k/player/SequencePlayer.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/player/PlayerView.js
////////////////////////////////////////
(function() {

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Singleton, Private Members.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Private: TEMPLATE
     * The Mustache template used by the player's view.
     * 2d0 - Implement Roman's way of managing templates.
     */
    var TEMPLATE =
        "<div id='{{id}}' class='player {{direction}} {{locale}}' style='transform: scale({{scale}}); transform-origin: 0 0; -webkit-transform: scale({{scale}}); -webkit-transform-origin: 0 0; -ms-transform: scale({{scale}}); -ms-transform-origin: 0 0; '>\
            <div id='{{id}}_navigation' class='player_navigation'></div>\
            <div id='{{id}}_pause' class='player_pause disabled'>\
                <div id='{{id}}_pauseContent' class='pause_content'/>\
            </div>\
	    	<div id='{{id}}_loader' class='loader'>\
	    		<div id='{{id}}_loaderAnimation' class='loaderAnimation'/>\
	    	</div>\
            <div id='{{id}}_content' class='player_content'>\
            </div>\
    		<div id='{{id}}_debug' class='player_debug'></div>\
        </div>";

    /**
     * Private: defaultConfigsdf
     * Hold sensible defaults for the player's view to use.
     */
    var defaultConfig = {
        /** The player's width. */
        width: 1024,
        /** The player's height */
        height: 768,
        /** The default layout used by the player's view */
        layout: 'horizontal',
        /** The mustache template to render. */
        template: TEMPLATE
    }; // End of defaultConfig.
    
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Class Declaration.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    /**
     * Class: t2k.player.PlayerView
     * The content player's view.
     */
    t2k.player.PlayerView = t2k.core.View.subClass({
        
        /**
         * Constructor: ctor
         * The constructor.
         *
         * Parameters:
         *  config - {Object} The Player's view configuration.
         */
        ctor: function(config) {
            // Apply the direction.
            defaultConfig.direction = ENV.interfaceDirection || 'ltr';
            defaultConfig.locale = ENV.locale || 'en_US';
            // Delegate.
            this._super(copy(config, defaultConfig));
            ENV.playerContent = this._content;
            
            // Handle the player.
            //this._view.disableSelection();
        }, // End of ctor
        
        updateContentSize: function() {
//        	var navHeight = this._navigation.outerHeight() ;
        	var navHeight = 0 ;
        	var cw = this.cfg.width * 1 ;
        	var ch = this.cfg.height * 1 - navHeight ;
            var chPause = this.cfg.height * 1
        	this._content.outerWidth( cw ) ;
        	this._content.outerHeight( ch ) ;
        	
        	// loader size and location
        	this._loader.outerWidth( cw ) ;
        	this._loader.outerHeight( ch ) ;
        	this._loader.css( 'top', navHeight + 'px' ) ;

            //pause screen size

            this._pause.outerWidth( cw ) ;
            this._pause.outerHeight( chPause ) ;
            this._pause.css("left",0 + 'px');
            this._pause.css("top",0 + 'px');
            var pauseWidth = 610;
            var pauseHeight = 320;
            var pauseContentWantedTop = (chPause/2 -pauseHeight/2 ).toString();
            var PauseContentWantedLeft = (cw/2 - pauseWidth/2).toString();
            this._pauseContent.css("position","absolute");
            this._pauseContent.css("top",pauseContentWantedTop + 'px');
            this._pauseContent.css("left",PauseContentWantedLeft + 'px');


        	
        	//locate according to the width of the loader gif
        	var loaderWidth = 220;
			var wantedTop = (ch/2).toString();
			var wantedLeft = (cw/2 - loaderWidth/2).toString();
			this._loaderAnimation.css("position","absolute");
			this._loaderAnimation.css("top",wantedTop + 'px');
			this._loaderAnimation.css("left",wantedLeft + 'px');
        },

        updatePauseScreenSize:function(){

        },



        pauseAi:function(flag){
            this._pause.removeClass('disabled');
            this._pause.addClass('enabled');
        },

        resumeAi:function(flag){
            this._pause.removeClass('enabled');
            this._pause.addClass('disabled');
        },

	    setPreloader: function( flag, animation_done_callback ){
	    	
	    	var thi$ = this ;
	    	
	       if( flag ) {
	    	   
	    	   this.loaderStart = (new Date).getTime() ;
	    	   thi$._loader.show();
	    	   
	    	   if( ENV.behaviors.animate ) {
	    		   this._loader.animate( { opacity: 1 }, 0 ) ;
	    	   } else {
	    		   this._loader.css( 'opacity', 1 ) ;
	    	   }
	    	   
	       }else{
	    	   
	    	   var loaderEnd = (new Date).getTime() ;
	    	   var loaderUpTime = loaderEnd - this.loaderStart ;
	    	   var animDuration = loaderUpTime > 100 ? Math.min( 750, loaderUpTime ) : 0 ;
	    	   
	    	   if( !ENV.behaviors.animate ) {
	    		   animDuration = 0 ;
	    	   }
	    	   
	    	   this._loader.animate( { opacity: 0 }, animDuration, function() {
	    		   
	    		   thi$._loader && thi$._loader.hide();

                   /* Callback is used to unset isBusy on ProgressBar, so it can process clicks. */
                   if (jQuery.isFunction(animation_done_callback))
                       animation_done_callback();

	    	   }) ;
	    	   
	       }
	  }

    }); // End of t2k.player.PlayerView

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

})();



////////////////////////////////////////
// SRC End --> t2k/player/PlayerView.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/compilePlay/SequenceCompilePlay.js
////////////////////////////////////////
( function() {

    t2k.compilePlay.SequenceCompilePlay = t2k.player.sequence.Sequence.subClass({

        compileResults: null,

        ctor: function(config) {
            // set private reference to "this" and "config"
            // to be used in private functions below
            _this = this;

            _config = enhanceConfigForLayouting(config);
//            _originalData = config.data.childNodes[0];
            _originalData = config.data;
            _originalConfig = config;

            this._super(config);

            _compileResults = new Array();
            _currentPermutationIndex = 0;
            compile( config );
        },

        createView:function() {
            this._super();
            //this.setPreLoader(true);
        },
        
        initView:function() {
        	
        	this._super() ;
        	
            // calls on layouter done.
            onPermutationCompiled() ;
        },

        /*setPreLoader:function(flag){
         this.view.setPreLoader(flag);
         },*/

        setLayoutState: function(state) {

            var result;

            switch (state) {

                case 'compact':
                    result = 'reduce';
                    break;

                case 'loose':
                    result = 'compact';
                    break;

                case 'reduce':
                    result = 'loose';
                    break;

                default: // on first time
                    result = 'loose';
                    break;

            }

            return result;
        },
        
        dynamicLayoutRenderCallback: function() {
            var thi$ = this;
            thi$.sequenceLayouter.done = true;  
            _this.initView();
        },
        
        createInnerElements: function( calledFromCompile ) {
        	
        	if( !calledFromCompile ) {
        		
        		this._super() ;        		
        		
        	} else {
        		
        		onPermutationCompiled() ;
        		
        	}
        	
        },
        
        createTasks: function(calledFromCompile) {
        	
        	if( !calledFromCompile ) {
        	
//        		this._super( calledFromCompile );
        		
        	}
        },
        
        createTask: function(taskClass, cfg) {
        	
            cfg['readyCallback'] = onTaskReady;

            return this._super(taskClass, cfg);
        },

        createContent: function() {
            // do nothing - block sequence flow
        },

        getCompiledResults: function() {
            return compileResults;
        },

        createShared: function (calledFromCompile) {

            this._super(calledFromCompile);

            if (calledFromCompile) {
                // do somthing relevant
            }
        }

    });

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Vars.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    var _this;
    var _config;
    var _originalData;
    var _currentPermutationIndex;
    var _compilePermutations;
    var _compileResults;
    var _currentResult;
    var _originalConfig;

    var _readyTasksView = [];

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// Private Functions.
// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    function enhanceConfigForLayouting(config) {
        var jqXml = jQuery(config.data);
        var tasks = jqXml.find('task');

        var sharedArea = jqXml.find('sharedArea').get(0);
        sharedArea = (CompilerUtils.setNumOfChildren(sharedArea));

        jQuery(tasks).each(function(index, task) {
            var task = jQuery(task);
            var question = task.find('question').get(0);
            var answer = task.find('answer').get(0);
	        var help = task.find('help').get(0);

            // group xml data
            question = (CompilerUtils.groupData(question));
            answer = (CompilerUtils.setNumOfChildren(answer));
	        help = (CompilerUtils.groupData(help));
        });

        return config;
    }

    function compile( config ) {
    	_compilePermutations = CompilerUtils.getCompilePermutations(_config.type, config );
        
        if( !_compilePermutations || _compilePermutations.length == 0 ) {
        	
        	throw new Error( "missing sequence type --> "+ _config.type +" or invalid view port (width too small) --> "+ config.width ) ;
        	
        }

		console.time( "compiler" ) ;
		console.groupCollapsed( "compile permutations" ) ;
		
        // compile the first layout option
        compilePermutation();
    }

    function compilePermutation() {
        if (_currentPermutationIndex < _compilePermutations.length) {
            // reset internal members
            resetSequence();

            // set option properties
            var currentPermutation = _compilePermutations[ _currentPermutationIndex ];
            
            console.log( "\n # Compiling --> ", currentPermutation.id ) ;
            
            applyPermutation(currentPermutation);

            // call sequence flow methods
            _this.createView();
            _this.createInnerElements(true);
            
//            _this.initView();


            // premutation compile done onLayouter done

        } else {
            // when all option were compiled
            onAllPermutationsCompiled();
            
//            alert('compilation finished')
        }
    }

    function onTaskReady(task, view) {
//            		taskCompiler( task, view ) ;
        _readyTasksView.push({ task: task, view: view });
    }

    function compileTasks() {

    	_this.compiledTasksInfo = [] ;
    	
    	_this.tasksConfig.each(function(index, cfg) {
    		var taskInfo = {} ;
    		_this.compiledTasksInfo.push( taskInfo ) ;
        	taskCompiler(cfg, taskInfo);
        });
        
        
        _this.compiledGroupResults = [] ;
        
        jQuery( _this.grouppedTasks ).each( function( index, groupTasks ) {
        	_this.compiledGroupResults.push( groupCompiler( index, groupTasks ) ) ;
        } ) ;
        
        
    }

    function groupCompiler( groupName, tasks ) {
    	
        var compilationResult = new t2k.compile.results.LayoutResult('group',
        		groupName,
            '######',
            'single'
        );
        
        var groupRowWidth = 0, groupWidth = 0 ;
        var groupRowHeight = 0, groupHeight = 0 ;
        
    	tasks.forEach( function( task ) {
    		
    		var $taskView = task.view._view ;
    		var isLastInRow = $taskView.hasClass( 'lastInRow' ) ;
    		
            var taskWidth = $taskView.outerWidth() ;
            groupRowWidth += taskWidth ;
            
            var taskHeight = $taskView.outerHeight() ;
            groupRowHeight = Math.max( groupRowHeight, taskHeight ) ;
            
            if( isLastInRow ) {
            	
            	groupWidth = Math.max( groupWidth, groupRowWidth ) ;
            	groupRowWidth = 0 ;
            	
            	groupHeight += groupRowHeight ;
            	groupRowHeight = 0 ;
            }
    		
    	} ) ;

        var maxSize = { width: _this.view.measures.width, height: _this.view.measures.height };
        var overWidth = _this.view.measures.width < groupWidth ;
        var overHeight = _this.view.measures.height < groupHeight ;

        var overflow = false;

        var overReason = [];
        var overWidthReason = [];
        var overHeightReason = [];

        // in case of width overflow
        if (overWidth) {
            overflow = true;
            overWidthReason.push('width', '[', groupWidth + 'px', 'over-flowing', maxSize.width + 'px', 'constraint', ']');
            overReason.push(overWidthReason.join(' '));
        }
        // in case of height overflow
        if (overHeight) {
            overflow = true;
            overWidthReason.push('height', '[', groupHeight + 'px', 'over-flowing', maxSize.height + 'px', 'constraint', ']');
            overReason.push(overWidthReason.join(' '));
        }

        // in case of any overflow
        if (overflow) {

            // add group grade regarding an overflow
            compilationResult.addGrade(t2k.compile.GradingConfig.task.group.overflow.description,
                t2k.compile.GradingConfig.task.group.overflow.grade,
                overReason.join(' ')
            );
        }
    	
    	return compilationResult ;
    }
    
    function taskCompiler(cfg, taskInfo) {

		console.groupCollapsed( "taskCompiler" ) ;
    	
        var taskName = jQuery(cfg).attr('id');

        var compilationResult = new t2k.compile.results.LayoutResult('task',
            taskName,
            '######',
            'single'
        );
        
        taskInfo.taskName = taskName;
        taskInfo.compilationResult = compilationResult;
        
        var taskListSize = _this.view.measures ;
        
        // logic compilation POC
        var compileTaskHeight = CompilerUtils.compileTaskHeight(taskListSize.width, jQuery(cfg));
        var fuzzyRelativeToMaxHeight = ( 100 * compileTaskHeight / taskListSize.height).toFixed( 2 ) ;
        console.log( 'xxxxxxxxxxx - fuzzy height % - ',  fuzzyRelativeToMaxHeight );

        taskInfo.fuzzyPercentOfHeight = fuzzyRelativeToMaxHeight * 1 ;

		console.groupEnd( "taskCompiler" ) ;
    }

    function onPermutationCompiled() {
    	
        compileTasks();
    	
        // create and set result object
        composeResult();

        // add to results stack
        _compileResults.push(_currentResult);

        // increment layout option index and run the next permutation
        _currentPermutationIndex++;
        compilePermutation();
    }

    function composeResult() {

//        if (_this.cfg.isShared) {
//            var sharedInnerSize = _this.sharedArea.getViewSize();
//            _this.sharedContentSize = _this.sharedArea.getContentSize();
//            _this.sharedCotentDiff = {};
//            _this.sharedCotentDiff.width = sharedInnerSize.width - _this.sharedContentSize.width;
//            _this.sharedCotentDiff.height = sharedInnerSize.height - _this.sharedContentSize.height;
//        }
    	
        var compilePermutation = _compilePermutations[ _currentPermutationIndex ];

        // create result object
        var layoutResultClass = t2k.compile.results.LayoutResult;
        _currentResult = new layoutResultClass('sequence',
            _this.cfg.id,
            '##',
            compilePermutation.id
        );
        // calc shared sequence specific grades
        if (_this.cfg.isShared) {
//            composeSharedResult(compilePermutation);
        }
        // calc creative wrapper specific grades
        else {
        	var layoutStatus = _this.view.getLayoutStatus() || {} ;
            composeCreativeWrapperResult( compilePermutation, layoutStatus );
        }

        var seqInnerLog = [];
        // sum tasks grades and add it to current option result
        var t, tasksNum, taskInfo, taskResult, uxGrade = 0, pedGrade = 0;

        var fuzzySeq = 0 ;
        
        // gather tasks compilation result info
        for (t = 0,tasksNum = _this.tasksConfig.length; t < tasksNum; t++) {
        	
        	taskInfo = _this.compiledTasksInfo[t];
            taskResult = taskInfo.compilationResult;
            uxGrade += taskResult.grade.ux;
            pedGrade += taskResult.grade.pedagogy;

            seqInnerLog.push(taskResult.getLog());
            
            fuzzySeq += taskInfo.fuzzyPercentOfHeight ;
        }
        
        fuzzySeq /= tasksNum ;
        
        var g, groupsNum, groupResult ;
        // gather groups compilation result info
        for (g = 0,groupsNum = _this.compiledGroupResults.length; g < groupsNum; g++) {
        	
        	groupResult = _this.compiledGroupResults[ g ] ;
            uxGrade += groupResult.grade.ux;
            pedGrade += groupResult.grade.pedagogy;

            seqInnerLog.push(groupResult.getLog());
        }
        
        var startGrade = t2k.compile.GradingConfig.task.startGrade;
        var tasksStartGrade = startGrade * t;

        // add tasks grades to sequence
        var seqGrade = { ux: tasksStartGrade - uxGrade, pedagogy: tasksStartGrade - pedGrade };
        
        _currentResult.addGrade('all tasks and groups',
            seqGrade,
            'summary of tasks and group grades, start from ' + tasksStartGrade + ' <-- ' + t + '(tasks) * ' + startGrade + '(start)'
        );
        
        // get total grades for sequence
        var seqTotalUx = _currentResult.grade.ux;
        var seqTotalPedagogy = _currentResult.grade.pedagogy;

        var seqTotal, seqTotalReason = [ 'total ux [', seqTotalUx, '] pedagogy [', seqTotalPedagogy, ']' ];

        var calcDescription = '';
        var calcMethod = t2k.compile.GradingConfig.sequence.tasksCalcMethod;

        if (calcMethod == 'weighted') {

            // get weighting ratio
            var uxRatio = t2k.compile.GradingConfig.sequence.uxPedagogyRatio.ux;
            var pedRatio = t2k.compile.GradingConfig.sequence.uxPedagogyRatio.pedagogy;

            // Weighted mean
            seqTotal = ( seqTotalUx * uxRatio + seqTotalPedagogy * pedRatio ) / ( uxRatio + pedRatio );

            // ratio description
            calcDescription = uxRatio + ':' + pedRatio;

        } else if (calcMethod == 'summarized') {
            // summarized
            seqTotal = uxGrade + pedGrade;

        }

        // set dummy(0,0) grades in order to add description for calculation method
        var seqLog = [];
        seqLog.push(seqInnerLog.join(''));
        seqLog.push('#### --> sequence total ');
        seqLog.push(calcMethod, ' ', calcDescription);

        _currentResult.addGrade(seqLog.join(''),
            { ux: 0, pedagogy: 0 },
            'calculation method',
            1,
            true
        );

        // set final calculated grade for sequence
        _currentResult.weightedGrade = seqTotal;
        
        var factor = compilePermutation.factor ;
        if( fuzzySeq < 100 ) {
        	factor = 1/factor ;
        }
        
        _currentResult.fuzzyGrade = fuzzySeq * factor ;

        var layoutTag = _this.cfg.data.getElementsByTagName('layout')[0];

        // write additional compilation info in to layout tag
        if (_this.cfg.isShared && _this.sharedCotentDiff) {
            layoutTag.setAttribute('sharedContentDiffWidth', _this.sharedCotentDiff.width);
            layoutTag.setAttribute('sharedContentDiffHeight', _this.sharedCotentDiff.height);
        }

        // save current data xml
        _currentResult.layoutXml = _this.cfg.data;
    }

    function onAllPermutationsCompiled() {

		console.groupCollapsed( "onAllPermutationsCompiled" ) ;
		
    	// sort results --> <=100 --> asc, >100 --> desc
    	sortConpilationResults( _compileResults, 100 ) ;

        _this.compileResults = _compileResults;
        resetSequence();

        _originalConfig.data = _this.compileResults[0].layoutXml;
        //_this.dispatchEvent('onCompileDone', _originalConfig);
        //_this.setPreLoader(false);


        // LOG compilation results
        var seqLog = [
            '\n\n# Compiled Sequence[', _this.cfg.id, '][env - ',
            _this.cfg.width, 'x', _this.cfg.height, ']\n'].join(' ');

        console.log(seqLog);

        _this.compileResults.forEach(function(compiledResult) {
            console.log(compiledResult.getLog());
        });

		console.groupEnd( "onAllPermutationsCompiled" ) ;

		console.groupEnd( "compile permutations" ) ;

		console.timeEnd( "compiler" ) ;
		
        _this.dispatchEvent('onCompileDone', _originalConfig);
    }
    
    function sortConpilationResults( results, limit ) {
    	
    	// sort ascending by distance from limit
    	results.sort( function( A, B ) {
    		return Math.abs( limit - A.fuzzyGrade ) - Math.abs( limit - B.fuzzyGrade ) ;
    	} ) ;
    	
    	// concat results
    	_compileResults = results ;
        
    }

    function applyPermutation(option) {
        var xmlData = _this.cfg.data;

        var compiledTag = jQuery(xmlData).children('layout');

        if (compiledTag.length == 0) {
            compiledTag = Compat.createNodeNextTo(xmlData, 'layout', true);
            jQuery(xmlData).append(compiledTag);  // ?
        }

        // set props into layoutTag
        setLayoutProperties(option, compiledTag);
    }

    function resetSequence() {
        // remove all children - use view dispose ?
        Perf.select('#' + _this.cfg.id, 1).remove();
        // var seqParent = jQuery( '#' + _this.cfg.parent._content[0].id ) ;
        //seqParent.html( '' ) ;

        // LZ clone _originalData
        _this.cfg.data = _originalData.cloneNode(true);

        _this.children = [];
        _readyTasksView = [];
    }

    function composeCreativeWrapperResult( compilePermutation, creativeStatus ) {
    	
    	var t, task, tasksLen, taskResult;
    	var ruleKey, ruleObject;
    	
    	creativeRules = t2k.compile.GradingConfig.sequence.creative;
    	
    	for (t = 0,tasksLen = _this.children.length; t < tasksLen; t++) {
    		
    		task = _this.children[ t ] ;
    		taskResult = task.compilationResult ;
    		
    		for( ruleKey in creativeRules ) {
    			
    			var isRuleApplied = creativeStatus[ ruleKey ] ;
    			if( isRuleApplied ) {
    				
    				ruleObject = creativeRules[ ruleKey ];
    				
    				var ruleMultiplyer = compilePermutation.penaltyMultiplyer ;
    				
    				if( ruleObject ) {
    					taskResult.addGrade( ruleObject.description, ruleObject.grade, 'creative rule', ruleMultiplyer ) ;
    				}
    				
    			}
    			
    		}
    		
    	}
    	
    }
    
    function composeSharedResult(compilePermutation) {

        var t, task, tasksLen, taskResult;

        var relation, sharedRules, sharedRelationRules, ruleObject;
        sharedRules = t2k.compile.GradingConfig.sequence.shared;
        sharedRelationRules = sharedRules.taskRelation;

        var sharedArea = _this.view._shared[0];

        var applySmallSharedRule = false;
        var sharedRatio = 100 - _this.cfg.ratio;
        if (sharedRatio < sharedRelationRules.smallshared.min_shared_percent &&
            sharedArea.scrollHeight > sharedArea.clientHeight) {

            applySmallSharedRule = true;
        }

        var sharedType = _this.sharedArea.getType();
        var typeRules = sharedRelationRules.sharedType[ sharedType ];

        var sharedReductionReport = _this.sharedArea.getReductionReport();
        var sharedReducedTo = 1;
        var sharedReducedByPercent = 100;
        if (!sharedReductionReport) {
            console.warn('shared type - ' + sharedType + ' - recuction report is not ready');
        } else if (isNaN(sharedReductionReport.percent)) {
            console.warn('shared type - ' + sharedType + ' - recuction percent invalid');
        } else {
            sharedReducedTo = sharedReductionReport.percent.toFixed(2) * 1;
            sharedReducedByPercent = ( 100 * ( 1 - sharedReducedTo ) ).toFixed(2) * 1;
        }

        if (typeRules) {

            var applyPartVisibleRule = false;
            var partVisibleRuleMultiplyer = 0;
            if (typeRules.partVisible) {
            	
//                var sharedOverflow = Math.min(_this.sharedCotentDiff.width, _this.sharedCotentDiff.height) < 0;
                var sharedInnerOverflowV = sharedReductionReport ? sharedReductionReport.overflowV : false;
                var sharedInnerOverflowH = sharedReductionReport ? sharedReductionReport.overflowH : false;
                var sharedOverflowV = _this.sharedCotentDiff.height < 0 || sharedInnerOverflowV ;
                var sharedOverflowH = _this.sharedCotentDiff.width < 0 || sharedInnerOverflowV ;
                
                partVisibleRuleMultiplyer = ( sharedOverflowV ? 1 : 0 ) + ( sharedOverflowH ? 1 : 0 ) ;
                
                if( partVisibleRuleMultiplyer > 0 ) {
                    applyPartVisibleRule = true;
                }
            }

            var applyMinReadRule = false;
            if (sharedReductionReport.belowRead && typeRules.minRead) {
                applyMinReadRule = true;
            }

        }

        // get sequence base grades
        var seqBaseGrades = compilePermutation.baseGrades;
        var seqGradeDescriptions = compilePermutation.gradeDescriptions;
        var g, grade, desc, numOfGrades = seqBaseGrades ? seqBaseGrades.length : 0;

        for (t = 0,tasksLen = _this.children.length; t < tasksLen; t++) {

            task = _this.children[ t ];
            taskResult = task.compilationResult;

            relation = _this.tasksRelations[task.view.cfg.id];

            if (relation != 'none') {
            	
                if (_this.cfg.isCollapse) {
                    ruleObject = sharedRelationRules.collapsed[relation];
                    if (ruleObject) {
                        taskResult.addGrade(ruleObject.description, ruleObject.grade, 'shared relation specific grade');
                    }
                }

                if (applyPartVisibleRule) {
                    ruleObject = typeRules.partVisible[ relation ] ||
                        typeRules.partVisible[ 'generic' ];
                    taskResult.addGrade(ruleObject.description, ruleObject.grade, 'shared relation specific grade', partVisibleRuleMultiplyer);
                }

                if (applySmallSharedRule) {
                    taskResult.addGrade(sharedRelationRules.smallshared.description, sharedRelationRules.smallshared.grade, 'shared relation general grade');
                }

                if (sharedReducedTo < 1 && sharedReductionReport) {
                    ruleObject = sharedRelationRules.reduced[ relation ];
                    if (ruleObject) {
                        var reducePenalty = sharedRelationRules.reduced.percentGrade * sharedReducedByPercent;
                        taskResult.addGrade(ruleObject.description, ruleObject.grade, 'shared relation general grade [ ' + sharedReducedByPercent + '% * ' + sharedRelationRules.reduced.percentGrade + ' = ' + reducePenalty + ' ]', reducePenalty);
                    }
                }
                
                if( sharedReducedTo < 1 && _this.cfg.isCollapse ) {
                	ruleObject = sharedRules.collapsedReduced ;
                	taskResult.addGrade(ruleObject.description, ruleObject.grade, 'shared relation general grade');
                }
                
                if (applyMinReadRule) {
                    ruleObject = typeRules.minRead[ relation ] ||
                        typeRules.minRead[ 'generic' ];
                    if (ruleObject) {
                    }
                }

                if (sharedType == 'text') {
                    ruleObject = typeRules.notOptimal[ relation ] ||
                        typeRules.notOptimal[ 'generic' ];

                    var txtWidth = _this.sharedContentSize.width;
                    var min = ( ruleObject.range_min * sharedReducedTo ).toFixed(2);
                    var max = ( ruleObject.range_max * sharedReducedTo ).toFixed(2);

                    if (txtWidth < min || txtWidth > max) {
                        taskResult.addGrade(ruleObject.description, ruleObject.grade, 'range after reduce [ min: ' + min + ' max: ' + max + ' <-- ' + sharedReducedByPercent + '%  text reduction ] ');
                    }

                }

                for (g = 0; g < numOfGrades; g++) {
                    grade = seqBaseGrades[ g ];
                    desc = seqGradeDescriptions[ g ];
                    taskResult.addGrade(desc, grade, '');
                }
                
            }
        }

    }


    function setLayoutProperties(option, compiledTag) {

        // add attributes / children to layout tag
        switch (_config.type) {

            case 'simple' :

                compiledTag.attr("tasks_width", option.tasksWidth);
                compiledTag.attr("has_margin", option.hasMargin);

                break;

            case 'shared' :

                compiledTag.attr("type", option.type);
                compiledTag.attr("tasks_ratio", option.ratio);
                compiledTag.attr("shared_task_collapse", option.collapse);

                break;

        }
    }

})();
////////////////////////////////////////
// SRC End --> t2k/compilePlay/SequenceCompilePlay.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/compile/GradingConfig.js
////////////////////////////////////////
//<compilation
t2k.compile.GradingConfig = {
	task : {
		
		startGrade: 100,
		
		base: {
			overflow: {
				description: 'task overflow',
				grade: {
					ux: 15,
					pedagogy: 0
				}
			}
		},
		
		group: {
			overflow: {
				description: 'group overflow',
				grade: {
					ux: 15,
					pedagogy: 20
				}
			}
		}
		
	},
	sequence: {
		
		// "weighted" or "summarized"
		tasksCalcMethod: 'weighted',
		
		// ratio between ux and pedagogy grades, any value is possible, finally used with weighted mean function
		uxPedagogyRatio: { ux:50, pedagogy:50 },
		
		creative: {
			smallMargin: {
				description: 'creative - margin too small',
				grade: {
					ux: 5,
					pedagogy: 0
				}
			},
			noMargin: {
				description: 'creative - no margin',
				grade: {
					ux: 10,
					pedagogy: 0
				}
			},
			noCreative: {
				description: 'creative - no creative at all',
				grade: {
					ux: 10,
					pedagogy: 0
				}
			},
			overlay: {
				description: 'creative - using overlay',
				grade: {
					ux: 15,
					pedagogy: 0
				}
			}
		},
		
		shared: {
			horizontal: {
				description: 'horizontal sequence',
				grade: {
					ux: 0,
					pedagogy: 0
				}
			},
			collapsed: {
				description: 'collapsed sequence',
				grade: {
					ux: 0,
					pedagogy: 0
				}
			},
			collapsedReduced: {
				description: 'collapsed sequence, reduced shared component',
				grade: {
					ux: 5,
					pedagogy: 0
				}
			},
			taskRelation: {
				smallshared: {
					description: 'shared relation - small scrolled shared area',
					grade: {
						ux: 0,
						pedagogy: 0
					},
					min_shared_percent: 50
				},

				collapsed: {
					//////////////////////////////////////////////////////////////////////
					// Math types
					//////////////////////////////////////////////////////////////////////
					reference: {
						description: 'shared relation - collapsed - reference',
						grade: {
							ux: 25,
							pedagogy: 50
						}
					},
					explore: {
						description: 'shared relation - collapsed - explore',
						grade: {
							ux: 50,
							pedagogy: 35
						}
					},
					support: {
						description: 'shared relation - collapsed - support',
						grade: {
							ux: 10,
							pedagogy: 5
						}
					},
					//////////////////////////////////////////////////////////////////////
					// LA types
					//////////////////////////////////////////////////////////////////////
					supplementary: {
						description: 'shared relation - collapsed - supplementary',
						grade: {
							ux: 15,
							pedagogy: 5
						}
					},
					read: {
						description: 'shared relation - collapsed - read',
						grade: {
							ux: 15,
							pedagogy: 10
						}
					},
					read_specific_part: {
						description: 'shared relation - collapsed - read_specific_part',
						grade: {
							ux: 15,
							pedagogy: 15
						}
					},
					select: {
						description: 'shared relation - collapsed - select',
						grade: {
							ux: 15,
							pedagogy: 20
						}
					},
					edit: {
						description: 'shared relation - collapsed - edit',
						grade: {
							ux: 15,
							pedagogy: 50
						}
					}
				},

				reduced: {
					//////////////////////////////////////////////////////////////////
					// factor will multiply with reduction percent and grade
					//////////////////////////////////////////////////////////////////
					percentGrade: 0.5,
					//////////////////////////////////////////////////////////////////
					
					reference: {
						description: 'shared relation - reduced - reference',
						grade: {
							ux: 5,
							pedagogy: 0
						}
					},
					explore: {
						description: 'shared relation - reduced - explore',
						grade: {
							ux: 5,
							pedagogy: 0
						}
					},
					support: {
						description: 'shared relation - reduced - support',
						grade: {
							ux: 1,
							pedagogy: 0
						}
					}
				},
				
				sharedType: {
					text: {
						partVisible: {
							generic: {
								description: 'shared relation - text - partVisible',
								grade: {
									ux: 5,
									pedagogy: 0
								}
							}
						},
						notOptimal: {
							generic: {
								description: 'shared relation - text - notOptimal',
								grade: {
									ux: 5,
									pedagogy: 0
								},
								//////////////////////////////////////////////////////////////////////////////
								// range in pixels = row.length(chars) * avg.char.length(em) * font.size(pt)
								//////////////////////////////////////////////////////////////////////////////
								// min of 35 chars --> 35ch * 0.65em * 22pt = 500px
								range_min: 400,
								//////////////////////////////////////////////////////////////////////////////
								// max of 60 chars --> 60ch * 0.65em * 22pt = 860px
								range_max: 600
								//////////////////////////////////////////////////////////////////////////////
							}
						}
					},
					
					dialog: {
						partVisible: {
							generic: {
								description: 'shared relation - dialog - partVisible',
								grade: {
									ux: 5,
									pedagogy: 0
								}
							}
						},
						notOptimal: {
							generic: {
								description: 'shared relation - dialog - notOptimal',
								grade: {
									ux: 5,
									pedagogy: 0
								},
								//////////////////////////////////////////////////////////////////////////////
								// range in pixels = row.length(chars) * avg.char.length(em) * font.size(pt)
								//////////////////////////////////////////////////////////////////////////////
								// min of 35 chars --> 35ch * 0.65em * 22pt = 500px
								range_min: 400,
								//////////////////////////////////////////////////////////////////////////////
								// max of 60 chars --> 60ch * 0.65em * 22pt = 860px
								range_max: 600
								//////////////////////////////////////////////////////////////////////////////
							}
						}
					},
					
					image: {
						minRead: {
							reference: {
								description: 'shared relation - image - minRead - reference',
								grade: {
									ux: 15,
									pedagogy: 15
								}
							},
							support: {
								description: 'shared relation - image - minRead - support',
								grade: {
									ux: 20,
									pedagogy: 5
								}
							}
						}
					},
					
					media: {
						minRead: {
							reference: {
								description: 'shared relation - image - minRead - reference',
								grade: {
									ux: 15,
									pedagogy: 15
								}
							},
							support: {
								description: 'shared relation - image - minRead - support',
								grade: {
									ux: 20,
									pedagogy: 5
								}
							}
						}
					},
					
					tre_applet: {
						minRead: {
							generic: {
								description: 'shared relation - tre_applet - minRead',
								grade: {
									ux: 60,
									pedagogy: 60
								}
							}
						},
						partVisible: {
							generic: {
								description: 'shared relation - tre_applet - partVisible',
								grade: {
									ux: 100,
									pedagogy: 100
								}
							}
						}
					},
					
					interactive_swf: {
						minRead: {
							generic: {
								description: 'shared relation - interactive_swf - minRead',
								grade: {
									ux: 60,
									pedagogy: 60
								}
							}
						},
						partVisible: {
							generic: {
								description: 'shared relation - interactive_swf - partVisible',
								grade: {
									ux: 100,
									pedagogy: 100
								}
							}
						}
					}
					
				}
			}
		}
	}
} ;
//>compilation
////////////////////////////////////////
// SRC End --> t2k/compile/GradingConfig.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> t2k/compile/results/LayoutResult.js
////////////////////////////////////////
/**
 * creating a layout compilation result object
 * @param {String} entity
 * @param {String} id
 * @param {String} indentString
 * @param {String} permutation
 */
t2k.compile.results.LayoutResult = function( entity, id, indentString, permutation ) {
	this.grade = {} ;
	this.grade.ux = 0 ;
	this.grade.pedagogy = 0 ;
	this.layoutXml = null ;
	this.log = [] ;
	this.layoutOption = permutation ? permutation : 'single' ;
	this.indentString = indentString ;
	this.title = [ this.indentString, ' ', entity, '[', id, '] permutation[', permutation, ']' ] ;
	this.weightedGrade ;
	this.fuzzyGrade ;
} ;

t2k.compile.results.LayoutResult.prototype = {
	/**
	 * adding a grade with detailed description
	 * @param {String} gradeDescription
	 * @param {Object} gradeObject
	 * @param {String} gradeReason
	 * @param {Boolean} ignoreIndent
	 */
	addGrade: function( gradeDescription, gradeObject, gradeReason, multiplyer, ignoreIndent ) {
		// apply grades and get detailes from grade object
		var gradeReport = this._addGradeToResult( gradeObject, multiplyer ) ;
		
		// set break
		var midBreakLine = ignoreIndent && gradeReport != '' ? '\n' : '' ;
		
		// use breake between grades 
		if( this.log.length > 0 ) {
			this.log.push( '\n' ) ;
		}
		
		// in case single line output is needed
		if ( !ignoreIndent || gradeReport != '' ) {
			this.log.push(this.indentString, '## --> ');
		}
		
		// add detailes to log array
		this.log.push( gradeReport, midBreakLine, gradeDescription, ' ', gradeReason  ) ;
	},
	
	/**
	 * applying a grade, returning description
	 * @param {Object} gradeObject
	 * @return {String}  
	 */
	_addGradeToResult: function( gradeObject, multiplyer ) {
		var gradeReport = '' ;
		// only for values different from zero
		if( gradeObject.ux != 0 || gradeObject.pedagogy != 0 ) {
			multiplyer = multiplyer ? multiplyer : 1 ;
			var ux = gradeObject.ux * multiplyer ;
			var pedagogy = gradeObject.pedagogy * multiplyer ;
			this.grade.ux += ux ;
			this.grade.pedagogy += pedagogy ;
			var gradeLog = [] ;
			gradeLog.push( 'ux', '[', ux, '] ' ) ;
			gradeLog.push( 'pedagogy', '[', pedagogy, '] ' ) ;
			if( multiplyer != 1 ) {
				gradeLog.push( 'multiplyer', '[', multiplyer, '] ' ) ;
			}
			gradeLog.push( ' ' ) ;
			gradeReport = gradeLog.join( '' ) ;
		}
		return gradeReport ;
	},
	
	/**
	 * adding a grade with detailed description
	 * @return {String}
	 */
	getLog: function() {
		var logString = this.log.length > 0 ? this.log.join( '' ) : '' ;
		var weightedString = this.weightedGrade ? 'final' + '[' + this.weightedGrade + '] ' : '' ;
		var fuzzyString = this.fuzzyGrade ? 'fuzzy' + '[' + this.fuzzyGrade + '] ' : '' ;
		var resultSum = [	this.indentString+'## --> ', 'totals : ',
							'ux', '[', this.grade.ux, '] ',
							'pedagogy', '[', this.grade.pedagogy, '] ',
							weightedString,
							fuzzyString
						] ;
		var resultString = this.log.length > 0 ? resultSum.join( '' ) : '' ;
		var midLineBreake = this.log.length > 0 ? '\n' : '' ;
		var fullLog = [ this.title.join( '' ), midLineBreake, logString, midLineBreake, resultString, '\n' ] ;
		return fullLog.join( '' ) ;
	}
};





////////////////////////////////////////
// SRC End --> t2k/compile/results/LayoutResult.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> assets/languages/lang_en_US.js
////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
// navigation - start
//////////////////////////////////////////////////////////////////////////
LanguageUtil.strings.task = {} ;
LanguageUtil.strings.task.progress = {} ;
LanguageUtil.strings.task.progress.labels = {} ;
LanguageUtil.strings.task.progress.labels.check = "Check";
LanguageUtil.strings.task.progress.labels.tryagain = "Try Again";
LanguageUtil.strings.task.progress.labels.showanswer = "Show Answer";
LanguageUtil.strings.task.progress.labels.progress = "Continue";
LanguageUtil.strings.task.progress.labels.done = "Done";
LanguageUtil.strings.task.progress.labels.skiptask = "Skip Task";
LanguageUtil.strings.task.progress.labels.solvetask = "Solve Task";
LanguageUtil.strings.task.progress.labels.restarttask = "Restart Task";
LanguageUtil.strings.task.progress.labels.myanswer = "My Answer";
//////////////////////////////////////////////////////////////////////////
// navigation - assessment
//////////////////////////////////////////////////////////////////////////
LanguageUtil.strings.task.progress.labels.assessment_next = "Next";
LanguageUtil.strings.task.progress.labels.assessment_done = "Submit";
LanguageUtil.strings.task.progress.labels.assessment_show_correct = "Correct Answer";
//////////////////////////////////////////////////////////////////////////
// navigation bar
//////////////////////////////////////////////////////////////////////////
LanguageUtil.strings.progressbar.tasks = "Tasks: ";
LanguageUtil.strings.progressbar.of = " of ";
LanguageUtil.strings.progressbar.next = "Next";
LanguageUtil.strings.progressbar.prev = "Previous";
//////////////////////////////////////////////////////////////////////////
// navigation - end
//////////////////////////////////////////////////////////////////////////

// task buttons
LanguageUtil.strings.tasktoolbar.feedback = "Feedback";
LanguageUtil.strings.tasktoolbar.hint = "Hint";
LanguageUtil.strings.tasktoolbar.attempts="Attempts";
LanguageUtil.strings.tasktoolbar.points="Points";
// text area
LanguageUtil.strings.textarea.tooltips.bold = "Bold";
LanguageUtil.strings.textarea.tooltips.italic = "Italic";
LanguageUtil.strings.textarea.tooltips.underline = "Underline";
LanguageUtil.strings.textarea.tooltips.copy = "Copy";
LanguageUtil.strings.textarea.tooltips.cut = "Cut";
LanguageUtil.strings.textarea.tooltips.paste = "Paste";
LanguageUtil.strings.textarea.tooltips.undo = "Undo";
LanguageUtil.strings.textarea.tooltips.redo = "Redo";
LanguageUtil.strings.textarea.tooltips.lists = "Lists";
LanguageUtil.strings.textarea.tooltips.aligns = "Align Text";
LanguageUtil.strings.textarea.tooltips.indents = "Indent Text";
LanguageUtil.strings.textarea.tooltips.squareList = "Square Bullets";
LanguageUtil.strings.textarea.tooltips.discList = "Round Bullets";
LanguageUtil.strings.textarea.tooltips.numberList = "Numbered List";
LanguageUtil.strings.textarea.tooltips.justifyLeft = "Justify Left";
LanguageUtil.strings.textarea.tooltips.justifyCenter = "Justify Center";
LanguageUtil.strings.textarea.tooltips.justifyRight = "Justify Right";
LanguageUtil.strings.textarea.tooltips.indent = "Indent";
LanguageUtil.strings.textarea.tooltips.outdent = "Outdent";
LanguageUtil.strings.textarea.tooltips.dirs = "ltr/rtl";
LanguageUtil.strings.textarea.tooltips.dirRightToLeft = "Right-to-Left Text Direction";
LanguageUtil.strings.textarea.tooltips.dirLeftToRight = "Left-to-Right Text Direction";
LanguageUtil.strings.textarea.tooltips.fontSize = "Font Size";

// Media Player
LanguageUtil.strings.mediaPlayer.tooltips.play = "Play";
LanguageUtil.strings.mediaPlayer.tooltips.pause = "Pause";
LanguageUtil.strings.mediaPlayer.tooltips.stop = "Stop";
LanguageUtil.strings.mediaPlayer.tooltips.fullscreen = "Full Screen";
LanguageUtil.strings.mediaPlayer.tooltips.fullscreenExit = "Exit Full Screen";
LanguageUtil.strings.mediaPlayer.messages.fullscreenExit = "Press Esc to exit Full Screen mode.";


////////////////////////////////////////
// SRC End --> assets/languages/lang_en_US.js
////////////////////////////////////////
////////////////////////////////////////

////////////////////////////////////////
////////////////////////////////////////
// SRC Start --> index.js
////////////////////////////////////////
$(function () {
	
	window.AppcacheManager.callOnCacheReady( onAppcacheReady ) ;
	
	function onAppcacheReady() {
		
		if (parent && parent.ContentPlayerHost) {
			
			var hostPOC = parent.ContentPlayerHost ;
			ENV.externalHost = hostPOC;
			
			hostPOC.onPlayerHandshake( function ( config, callback ) {
				
				
				
				ENV.assetBasePath = config.basePaths.media;
				ENV.playerBasePath = config.basePaths.player;
				
				var cfg = {} ;
				
				cfg.width = config.width;
				cfg.height = config.height;
				cfg.scale = config.scale;
				
				cfg.volume = config.volume ;
				
				ENV.debug = {
					version: {
						time: "2013-11-10 01:02:21 IST",
						number: "7.0.17.504",
						userName: "jenkins",
						hostName: "t2kbuild.timetoknow.com",
						revision: "99978"
					},
					playerSize: {
						width: config.width,
						height: config.height
					},
					playerScale: config.scale
				} ;
				
				console.log( "[DL][VERSION]  --> " + JSON.stringify( ENV.debug, null, "\t" ) ) ;
				
				cfg.viewMode = config.viewMode;
				
				// init data object (mode, loId...)
				cfg.initData = config;
				// user info object (role...)
				cfg.userInfo = config.userInfo;
				
				var locale = config.locale ? config.locale : config.localeName ;
				
				if( locale == "he_IL" || locale == "he_il" ) {
					locale = "iw_IL" ;
				}
				
				if( locale ){
					ENV.locale = locale ;
				} else {
					console.warn( '[DL][Locale] --> MISSING locale setting, use default' );
				}
				console.info( "[DL][Locale] --> using locale: " + ENV.locale );
				
				LocaleUtil.loadFiles( function() {
					
					new t2k.model.Configuration() ;
					var sequenceFacade = new t2k.host.SequenceFacade( cfg ) ;
					ENV.sequenceFacade = sequenceFacade ;
					ENV.host = sequenceFacade ;
					
					callback( sequenceFacade ) ;
					
				} ) ;
				
				//////////////////////////////////////////////////////
				
			} ) ;
			
		} else {
			
			throw new Error("handshake function was not found at host window! onPlayerHandshake(start_function)");
			
		}
	}
	
} ) ;
////////////////////////////////////////
// SRC End --> index.js
////////////////////////////////////////
////////////////////////////////////////

